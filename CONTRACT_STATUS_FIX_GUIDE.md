# 🔧 إصلاح مشكلة حالة العقود "على وشك"

## 📋 وصف المشكلة

### المشكلة الأصلية
كانت هناك مشكلة في البحث الهرمي حيث لم تظهر العقود "على وشك الانتهاء" عند البحث عن:
```
الادارة القديمة///وشك
```

### السبب الجذري
المشكلة كانت في دالة `calculateStatus()` في ملف `script.js` في السطر 5041:

```javascript
// الكود القديم (المشكلة)
if (property['عدد الاقساط المتبقية'] && Number(property['عدد الاقساط المتبقية']) > 0 && property['تاريخ نهاية القسط']) {
    // منطق حساب الحالة...
}
```

**المشكلة:** الشرط كان يتطلب وجود `عدد الاقساط المتبقية` **و** `تاريخ نهاية القسط` معاً.

**النتيجة:** العقود التي لها `تاريخ نهاية القسط` فقط (بدون `عدد الاقساط المتبقية`) لم تدخل في هذا الشرط، وبالتالي لم تُحسب حالتها كـ "على وشك".

## ✅ الحل المطبق

### التغيير في الكود
تم تعديل دالة `calculateStatus()` لتتحقق من `تاريخ نهاية القسط` أولاً، بغض النظر عن وجود `عدد الاقساط المتبقية`:

```javascript
// الكود الجديد (الحل)
// أولاً: التحقق من تاريخ نهاية القسط (سواء كان هناك أقساط متبقية أم لا)
if (property['تاريخ نهاية القسط']) {
    const installmentEndDate = parseDate(property['تاريخ نهاية القسط']);
    if (installmentEndDate) {
        const diffDays = Math.floor((installmentEndDate - today) / (1000 * 60 * 60 * 24));
        const remainingInstallments = property['عدد الاقساط المتبقية'] ? Number(property['عدد الاقساط المتبقية']) : 0;
        
        if (diffDays < 0) {
            // منتهي
            if (remainingInstallments > 0) {
                return {
                    final: 'منتهى',
                    display: `أقساط منتهية منذ ${Math.abs(diffDays)} يوم <span class="need-more-installments">بحاجة لإضافة باقي الأقساط (${remainingInstallments})</span>`,
                    isInstallmentEnded: true
                };
            } else {
                return {
                    final: 'منتهى',
                    display: `أقساط منتهية منذ ${Math.abs(diffDays)} يوم`,
                    isInstallmentEnded: true
                };
            }
        } else if (diffDays <= 60) {
            // على وشك
            if (remainingInstallments > 0) {
                return {
                    final: 'على وشك',
                    display: `أقساط على وشك الانتهاء بعد ${diffDays} يوم (متبقي ${remainingInstallments} أقساط)`,
                    isInstallmentEnded: false,
                    isPending: true
                };
            } else {
                return {
                    final: 'على وشك',
                    display: `أقساط على وشك الانتهاء بعد ${diffDays} يوم`,
                    isInstallmentEnded: false,
                    isPending: true
                };
            }
        } else {
            // جاري
            if (remainingInstallments > 0) {
                return {
                    final: 'جاري',
                    display: `فعال (متبقي ${remainingInstallments} أقساط)`,
                    isInstallmentEnded: false
                };
            } else {
                return {
                    final: 'جاري',
                    display: 'فعال',
                    isInstallmentEnded: false
                };
            }
        }
    }
}
```

### الفوائد من الحل
1. **شمولية أكبر**: يتعامل مع جميع العقود التي لها `تاريخ نهاية القسط`
2. **مرونة**: يعمل مع أو بدون `عدد الاقساط المتبقية`
3. **دقة**: يعرض المعلومات المناسبة حسب البيانات المتوفرة
4. **توافق**: لا يؤثر على العقود الأخرى

## 🧪 الاختبار

### ملف الاختبار
تم إنشاء ملف `test-contract-status-fix.html` لاختبار الإصلاح مع الحالات التالية:

#### الحالة 1: عقد له تاريخ نهاية قسط فقط
```json
{
    "اسم العقار": "الادارة القديمة",
    "اسم المستأجر": "شركة اختبار",
    "المالك": "مالك اختبار",
    "تاريخ نهاية القسط": "31/03/2025",
    "عدد الاقساط المتبقية": null
}
```
**النتيجة المتوقعة:** `على وشك` ✅

#### الحالة 2: عقد له تاريخ نهاية قسط وعدد أقساط متبقية
```json
{
    "اسم العقار": "الادارة القديمة",
    "اسم المستأجر": "شركة اختبار 2",
    "المالك": "مالك اختبار",
    "تاريخ نهاية القسط": "31/03/2025",
    "عدد الاقساط المتبقية": "3"
}
```
**النتيجة المتوقعة:** `على وشك` ✅

#### الحالة 3: عقد له تاريخ نهاية عقد فقط
```json
{
    "اسم العقار": "الادارة القديمة",
    "اسم المستأجر": "شركة اختبار 3",
    "المالك": "مالك اختبار",
    "تاريخ النهاية": "31/03/2025"
}
```
**النتيجة المتوقعة:** `على وشك` ✅

### اختبار البحث الهرمي
```
البحث: الادارة القديمة///وشك
النتيجة المتوقعة: يجب أن يجد جميع العقود "على وشك" في "الادارة القديمة"
```

## 📊 النتائج

### قبل الإصلاح
- ❌ العقود التي لها `تاريخ نهاية القسط` فقط لم تظهر في البحث
- ❌ البحث الهرمي `الادارة القديمة///وشك` لا يجد هذه العقود
- ⚠️ عدم اتساق في عرض حالات العقود

### بعد الإصلاح
- ✅ جميع العقود "على وشك" تظهر في البحث
- ✅ البحث الهرمي `الادارة القديمة///وشك` يعمل بشكل صحيح
- ✅ اتساق كامل في عرض حالات العقود
- ✅ دعم أفضل للعقود بأنواع بيانات مختلفة

## 🔄 التوافق مع النظام الحالي

### الميزات المحفوظة
- ✅ جميع الحالات الأخرى تعمل كما هو متوقع
- ✅ العقود التي لها `عدد الاقساط المتبقية` تعمل بنفس الطريقة
- ✅ العقود التي لها `تاريخ النهاية` فقط تعمل بنفس الطريقة
- ✅ جميع الألوان والتصنيفات محفوظة

### التحسينات الإضافية
- 🔧 منطق أكثر وضوحاً ومرونة
- 🔧 رسائل أكثر دقة حسب البيانات المتوفرة
- 🔧 دعم أفضل للحالات الاستثنائية

## 📝 الملفات المحدثة

### script.js
- **السطور المحدثة:** 5040-5096
- **الدالة المحدثة:** `calculateStatus(property)`
- **نوع التغيير:** إعادة هيكلة منطق التحقق من التواريخ

### ملفات الاختبار الجديدة
- **test-contract-status-fix.html** - اختبار شامل للإصلاح
- **CONTRACT_STATUS_FIX_GUIDE.md** - هذا الدليل

## 🎯 الخلاصة

تم إصلاح المشكلة بنجاح! الآن:

1. **البحث الهرمي** `الادارة القديمة///وشك` يعمل بشكل صحيح
2. **جميع العقود "على وشك"** تظهر في النتائج بغض النظر عن نوع البيانات
3. **التوافق الكامل** مع النظام الحالي محفوظ
4. **الأداء محسن** مع منطق أكثر وضوحاً

يمكنك الآن استخدام البحث الهرمي للعثور على العقود "على وشك الانتهاء" في أي عقار بثقة كاملة! 🎉
