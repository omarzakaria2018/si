<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار مزامنة معلومات الصك عبر الوحدات</title>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .unit-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }
        .unit-card h4 {
            margin: 0 0 15px 0;
            color: #007bff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .unit-info {
            font-size: 14px;
            line-height: 1.6;
        }
        .unit-info div {
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .unit-info strong {
            color: #495057;
            display: inline-block;
            width: 120px;
        }
        .deed-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .deed-info h5 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        .deed-field {
            margin: 5px 0;
            font-size: 13px;
        }
        .deed-field strong {
            color: #856404;
        }
        .sync-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .sync-indicator.changed {
            background: #dc3545;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .steps {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .step-number {
            background: #007bff;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-weight: bold;
            font-size: 16px;
        }
        .highlight {
            background: #fff3cd;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #856404;
        }
        .feature-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .feature-box h4 {
            margin: 0 0 15px 0;
            color: #1976d2;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            margin: 8px 0;
            padding-right: 25px;
            position: relative;
        }
        .feature-list li:before {
            content: "🔗";
            position: absolute;
            right: 0;
            font-size: 16px;
        }
        .console-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔗 اختبار مزامنة معلومات الصك عبر الوحدات</h1>
        <p>هذا الاختبار يتحقق من أن تعديل معلومات الصك من أي وحدة ينطبق تلقائياً على جميع وحدات العقار</p>
        
        <div class="feature-box">
            <h4>🎯 الميزة الجديدة: ترابط معلومات الصك</h4>
            <ul class="feature-list">
                <li>معلومات الصك مشتركة بين جميع وحدات العقار الواحد</li>
                <li>تعديل معلومات الصك من أي وحدة ينطبق على الجميع</li>
                <li>مزامنة فورية مع قاعدة البيانات السحابية</li>
                <li>عدم تأثير على المعلومات الخاصة بكل وحدة</li>
                <li>رسائل تأكيد تفصيلية عن عدد الوحدات المحدثة</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>📋 الحقول المترابطة</h3>
            <div class="deed-info">
                <h5>🏢 معلومات الصك المشتركة:</h5>
                <div class="deed-field"><strong>رقم الصك:</strong> يطبق على جميع الوحدات</div>
                <div class="deed-field"><strong>مساحة الصك:</strong> يطبق على جميع الوحدات</div>
                <div class="deed-field"><strong>السجل العيني:</strong> يطبق على جميع الوحدات</div>
                <div class="deed-field"><strong>المالك:</strong> يطبق على جميع الوحدات</div>
                <div class="deed-field"><strong>موقع العقار:</strong> يطبق على جميع الوحدات</div>
            </div>
            <div style="background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 5px; padding: 15px; margin: 15px 0;">
                <h5 style="margin: 0 0 10px 0; color: #0c5460;">🔒 المعلومات التي لا تتأثر:</h5>
                <div style="font-size: 14px;">
                    <div>• رقم الوحدة (خاص بكل وحدة)</div>
                    <div>• معلومات المستأجر والعقد (خاصة بكل وحدة)</div>
                    <div>• مساحة الوحدة (قد تختلف عن مساحة الصك)</div>
                    <div>• تفاصيل الأقساط والمبالغ (خاصة بكل عقد)</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 اختبار تفاعلي</h3>
            <button onclick="createMultiUnitProperty()" style="background: #28a745; font-size: 16px; padding: 15px 30px;">
                <i class="fas fa-plus"></i> إنشاء عقار متعدد الوحدات
            </button>
            <button onclick="refreshUnitsDisplay()" style="background: #17a2b8; font-size: 16px; padding: 15px 30px;">
                <i class="fas fa-sync"></i> تحديث العرض
            </button>
            <button onclick="testPerformance()" style="background: #ffc107; color: #000; font-size: 16px; padding: 15px 30px;">
                <i class="fas fa-stopwatch"></i> اختبار الأداء
            </button>
            <button onclick="clearConsole()" style="background: #6c757d;">
                <i class="fas fa-trash"></i> مسح السجل
            </button>
        </div>

        <div class="test-section">
            <h3>🏢 وحدات العقار</h3>
            <div id="unitsDisplay" class="units-grid">
                <p>اضغط "إنشاء عقار متعدد الوحدات" لبدء الاختبار</p>
            </div>
        </div>

        <div class="test-section">
            <h3>🎯 خطوات الاختبار</h3>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div>اضغط <span class="highlight">"إنشاء عقار متعدد الوحدات"</span> لإنشاء عقار بـ 3 وحدات</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div><strong>اختبار المزامنة:</strong> اضغط <span class="highlight">"تحرير هذه الوحدة"</span> وغيّر <span class="highlight">مساحة الصك</span> من 1500 إلى 2000</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div><strong>اختبار عدم المزامنة:</strong> اضغط <span class="highlight">"تحرير هذه الوحدة"</span> وغيّر فقط <span class="highlight">اسم المستأجر</span></div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div>راقب الفرق في رسائل النجاح ووقت الحفظ</div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div>اضغط <span class="highlight">"اختبار الأداء"</span> لمقارنة أوقات الحفظ</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 أمثلة على رسائل النجاح المتوقعة</h3>

            <h4>🔄 عند تعديل معلومات الصك (مع المزامنة):</h4>
            <div class="result success">
                <strong>✅ تم حفظ التغييرات بنجاح!</strong><br>
                🔄 تم تحديث معلومات الصك في 3 وحدة<br>
                📝 معلومات الصك المحدثة:<br>
                • مساحة الصك: 2000<br>
                ☁️ تم حفظ 3 وحدة في السحابة<br>
                ✅ تم حفظ التغييرات في قاعدة البيانات السحابية
            </div>

            <h4>⚡ عند تعديل معلومات الوحدة فقط (بدون مزامنة):</h4>
            <div class="result info">
                <strong>✅ تم حفظ التغييرات بنجاح!</strong><br>
                💡 تم حفظ تعديلات الوحدة فقط (لم تتغير معلومات الصك)<br>
                ✅ تم حفظ التغييرات في قاعدة البيانات السحابية
            </div>
        </div>

        <div class="test-section">
            <h3>🖥️ سجل وحدة التحكم</h3>
            <p>راقب هذا السجل أثناء تحرير معلومات الصك:</p>
            <div id="consoleOutput" class="console-output">
                انتظار بدء الاختبار...
            </div>
        </div>

        <div id="results"></div>
    </div>

    <!-- تحميل المكتبات المطلوبة -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    
    <script>
        // تخزين console.log الأصلي
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        // إعادة توجيه console.log إلى العرض
        function interceptConsole() {
            const consoleOutput = document.getElementById('consoleOutput');
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                if (message.includes('مزامنة معلومات الصك') || 
                    message.includes('تم العثور على') || 
                    message.includes('معلومات الصك الجديدة') || 
                    message.includes('تم تحديث') ||
                    message.includes('تم حفظ') ||
                    message.includes('الوحدة')) {
                    
                    const timestamp = new Date().toLocaleTimeString();
                    consoleOutput.innerHTML += `<div style="color: #68d391;">[${timestamp}] ${message}</div>`;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                const message = args.join(' ');
                const timestamp = new Date().toLocaleTimeString();
                consoleOutput.innerHTML += `<div style="color: #fc8181;">[${timestamp}] ERROR: ${message}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            };
            
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                const message = args.join(' ');
                const timestamp = new Date().toLocaleTimeString();
                consoleOutput.innerHTML += `<div style="color: #f6e05e;">[${timestamp}] WARN: ${message}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            };
        }

        function addResult(type, title, content) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <strong>${title}</strong><br>
                ${content}
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = 'تم مسح السجل...';
        }

        function createMultiUnitProperty() {
            addResult('info', '📝 إنشاء عقار متعدد الوحدات...', 'جاري إنشاء عقار بـ 3 وحدات للاختبار');
            
            if (!window.properties) window.properties = [];
            
            const propertyName = 'برج الأندلس';
            const baseProperty = {
                'اسم العقار': propertyName,
                'المدينة': 'الرياض',
                'رقم الصك': 'DEED555666777',
                'مساحةالصك': '1500',
                'السجل العيني ': 'REG555666',
                'المالك': 'شركة الأندلس العقارية',
                'موقع العقار': 'https://maps.google.com/andalus-tower'
            };
            
            // إنشاء 3 وحدات
            const units = [
                {
                    ...baseProperty,
                    'رقم  الوحدة ': 'A101',
                    'اسم المستأجر': 'أحمد محمد علي',
                    'رقم العقد': 'CONTRACT-A101-2024',
                    'قيمة  الايجار ': 4000,
                    'المساحة': 120
                },
                {
                    ...baseProperty,
                    'رقم  الوحدة ': 'A102',
                    'اسم المستأجر': 'فاطمة أحمد',
                    'رقم العقد': 'CONTRACT-A102-2024',
                    'قيمة  الايجار ': 3800,
                    'المساحة': 110
                },
                {
                    ...baseProperty,
                    'رقم  الوحدة ': 'A103',
                    'اسم المستأجر': '',
                    'رقم العقد': '',
                    'قيمة  الايجار ': 0,
                    'المساحة': 130
                }
            ];
            
            // إضافة أو تحديث الوحدات
            units.forEach(unit => {
                const existingIndex = window.properties.findIndex(p => 
                    p['رقم  الوحدة '] === unit['رقم  الوحدة '] && 
                    p['اسم العقار'] === unit['اسم العقار']
                );
                
                if (existingIndex === -1) {
                    window.properties.push(unit);
                } else {
                    window.properties[existingIndex] = unit;
                }
            });
            
            // حفظ محلياً
            if (typeof saveDataLocally === 'function') {
                saveDataLocally();
            }
            
            // عرض الوحدات
            refreshUnitsDisplay();
            
            addResult('success', '✅ تم إنشاء العقار', `
                تم إنشاء عقار "${propertyName}" بـ ${units.length} وحدات:<br>
                • الوحدة A101: مؤجرة لأحمد محمد علي<br>
                • الوحدة A102: مؤجرة لفاطمة أحمد<br>
                • الوحدة A103: فارغة<br><br>
                <strong>معلومات الصك المشتركة:</strong><br>
                • رقم الصك: ${baseProperty['رقم الصك']}<br>
                • مساحة الصك: ${baseProperty['مساحةالصك']} م²<br>
                • المالك: ${baseProperty['المالك']}<br><br>
                جرب الآن تحرير معلومات الصك من أي وحدة!
            `);
        }

        function refreshUnitsDisplay() {
            const container = document.getElementById('unitsDisplay');
            
            if (!window.properties) {
                container.innerHTML = '<p>لا توجد بيانات. اضغط "إنشاء عقار متعدد الوحدات" أولاً</p>';
                return;
            }
            
            const andalusUnits = window.properties.filter(p => p['اسم العقار'] === 'برج الأندلس');
            
            if (andalusUnits.length === 0) {
                container.innerHTML = '<p>لم يتم العثور على وحدات برج الأندلس. اضغط "إنشاء عقار متعدد الوحدات" أولاً</p>';
                return;
            }
            
            container.innerHTML = andalusUnits.map(unit => `
                <div class="unit-card">
                    <div class="sync-indicator">متزامن</div>
                    <h4>
                        <i class="fas fa-home"></i>
                        الوحدة ${unit['رقم  الوحدة ']}
                    </h4>
                    
                    <div class="unit-info">
                        <div><strong>المستأجر:</strong> ${unit['اسم المستأجر'] || 'فارغة'}</div>
                        <div><strong>رقم العقد:</strong> ${unit['رقم العقد'] || '-'}</div>
                        <div><strong>الإيجار:</strong> ${unit['قيمة  الايجار '] || 0} ريال</div>
                        <div><strong>مساحة الوحدة:</strong> ${unit['المساحة'] || 0} م²</div>
                    </div>
                    
                    <div class="deed-info">
                        <h5>📋 معلومات الصك المشتركة</h5>
                        <div class="deed-field"><strong>رقم الصك:</strong> ${unit['رقم الصك'] || 'غير محدد'}</div>
                        <div class="deed-field"><strong>مساحة الصك:</strong> ${unit['مساحةالصك'] || 'غير محدد'} م²</div>
                        <div class="deed-field"><strong>السجل العيني:</strong> ${unit['السجل العيني '] || 'غير محدد'}</div>
                        <div class="deed-field"><strong>المالك:</strong> ${unit['المالك'] || 'غير محدد'}</div>
                        <div class="deed-field"><strong>موقع العقار:</strong> ${unit['موقع العقار'] ? 'محدد' : 'غير محدد'}</div>
                    </div>
                    
                    <button onclick="editUnit('${unit['رقم  الوحدة ']}', '${unit['اسم العقار']}')" 
                            style="width: 100%; margin-top: 15px; background: #007bff;">
                        <i class="fas fa-edit"></i> تحرير هذه الوحدة
                    </button>
                </div>
            `).join('');
        }

        function editUnit(unitNumber, propertyName) {
            addResult('info', '🔄 فتح نافذة التحرير...', `
                جاري فتح نافذة تحرير الوحدة ${unitNumber}<br>
                راقب سجل وحدة التحكم أدناه لمتابعة عملية المزامنة
            `);

            try {
                const unit = window.properties?.find(p =>
                    p['رقم  الوحدة '] === unitNumber &&
                    p['اسم العقار'] === propertyName
                );

                if (unit && typeof showCardEditModal === 'function') {
                    showCardEditModal(unit['رقم العقد'] || '', propertyName, unitNumber);

                    addResult('success', '✅ تم فتح نافذة التحرير', `
                        تحقق من النافذة المفتوحة:<br>
                        <strong>🔄 لاختبار المزامنة:</strong><br>
                        • ابحث عن قسم "معلومات العقار والصك"<br>
                        • جرب تغيير مساحة الصك من 1500 إلى 2000<br>
                        • احفظ وراقب رسالة "تم تحديث معلومات الصك في 3 وحدة"<br><br>
                        <strong>⚡ لاختبار عدم المزامنة:</strong><br>
                        • ابحث عن قسم "معلومات المستأجر"<br>
                        • جرب تغيير اسم المستأجر فقط<br>
                        • احفظ وراقب رسالة "تم حفظ تعديلات الوحدة فقط"<br><br>
                        لاحظ الفرق في سرعة الحفظ!
                    `);
                } else {
                    addResult('error', '❌ خطأ', 'لم يتم العثور على الوحدة أو دالة التحرير');
                }
            } catch (error) {
                addResult('error', '❌ خطأ في فتح نافذة التحرير', `خطأ: ${error.message}`);
            }
        }

        function testPerformance() {
            addResult('warning', '⚡ اختبار الأداء', `
                هذا الاختبار يوضح الفرق في الأداء:<br><br>
                <strong>🔄 عند تعديل معلومات الصك:</strong><br>
                • يتم فحص التغييرات في حقول الصك<br>
                • إذا وُجدت تغييرات، تحدث المزامنة<br>
                • يتم تحديث جميع الوحدات (3 وحدات)<br>
                • يتم حفظ 3 وحدات في السحابة<br>
                • وقت أطول للحفظ<br><br>
                <strong>⚡ عند تعديل معلومات الوحدة فقط:</strong><br>
                • يتم فحص التغييرات في حقول الصك<br>
                • لا توجد تغييرات في حقول الصك<br>
                • تخطي المزامنة تماماً<br>
                • يتم حفظ وحدة واحدة فقط<br>
                • وقت أسرع للحفظ<br><br>
                <strong>💡 النتيجة:</strong><br>
                النظام الآن ذكي ولا يقوم بمزامنة غير ضرورية!<br>
                جرب تحرير معلومات مختلفة وراقب الفرق في الأداء.
            `);

            // إضافة مؤشر أداء بصري
            const performanceIndicator = document.createElement('div');
            performanceIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: bold;
                animation: slideIn 0.5s ease-out;
            `;
            performanceIndicator.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 18px; margin-bottom: 5px;">⚡ مراقب الأداء</div>
                    <div style="font-size: 12px; opacity: 0.9;">راقب سرعة الحفظ</div>
                </div>
            `;

            document.body.appendChild(performanceIndicator);

            // إزالة المؤشر بعد 5 ثوان
            setTimeout(() => {
                if (performanceIndicator.parentNode) {
                    performanceIndicator.remove();
                }
            }, 5000);
        }

        // تشغيل تلقائي عند تحميل الصفحة
        window.addEventListener('load', () => {
            interceptConsole();
            
            addResult('success', '🚀 جاهز للاختبار', `
                تم تحميل جميع الملفات المطلوبة<br>
                تم تفعيل مراقبة سجل وحدة التحكم<br>
                اضغط "إنشاء عقار متعدد الوحدات" للبدء
            `);
            
            addResult('info', '💡 تعليمات', `
                هذا الاختبار يتحقق من ترابط معلومات الصك:<br>
                • تعديل معلومات الصك من أي وحدة<br>
                • تطبيق التغييرات على جميع وحدات العقار<br>
                • مزامنة فورية مع السحابة<br>
                • عدم تأثير على المعلومات الخاصة بكل وحدة<br><br>
                اضغط "إنشاء عقار متعدد الوحدات" للبدء
            `);
        });
    </script>
</body>
</html>
