<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        .property-test {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .property-test.has-attachments {
            border-color: #28a745;
            background: #f8fff9;
        }
        .property-test.no-attachments {
            border-color: #ffc107;
            background: #fffbf0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h1>
        
        <div class="section info">
            <h3>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            <div id="systemInfo"></div>
            <button onclick="checkSystemStatus()">ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>

        <div class="section">
            <h3>ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</h3>
            <button onclick="testSupabaseConnection()">Ø§Ø®ØªØ¨Ø§Ø± Supabase</button>
            <button onclick="testAttachmentsTable()">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
            <button onclick="testStorageBucket()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ®Ø²ÙŠÙ†</button>
            <div id="connectionResults"></div>
        </div>

        <div class="section">
            <h3>ğŸ“ ÙØ­Øµ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h3>
            <button onclick="checkAllAttachments()">ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
            <button onclick="checkLocalAttachments()">ÙØ­Øµ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
            <button onclick="checkCloudAttachments()">ÙØ­Øµ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
            <div id="attachmentsResults"></div>
        </div>

        <div class="section">
            <h3>ğŸ  Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h3>
            <button onclick="testPropertyAttachments()">Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</button>
            <div id="propertyResults"></div>
        </div>

        <div class="section">
            <h3>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù</h3>
            <button onclick="testFunctions()">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù</button>
            <button onclick="uploadTestFile()">Ø±ÙØ¹ Ù…Ù„Ù ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
            <input type="file" id="testFileInput" style="display: none;" onchange="handleTestUpload(event)">
            <div id="functionsResults"></div>
        </div>

        <div class="section">
            <h3>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ</h3>
            <button onclick="clearLog()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            <button onclick="exportDiagnostics()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ</button>
            <div id="diagnosticLog" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    
    <script>
        let diagnosticData = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('diagnosticLog');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            diagnosticData.push({ timestamp, type, message });
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            container.appendChild(resultDiv);
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´Ø®ÙŠØµ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');
            checkSystemStatus();
        });

        function checkSystemStatus() {
            log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...');
            
            const systemInfo = document.getElementById('systemInfo');
            let html = '<ul>';
            
            // ÙØ­Øµ Ù…ÙƒØªØ¨Ø© Supabase
            if (typeof supabase !== 'undefined') {
                html += '<li>âœ… Ù…ÙƒØªØ¨Ø© Supabase Ù…Ø­Ù…Ù„Ø©</li>';
                log('âœ… Ù…ÙƒØªØ¨Ø© Supabase Ù…Ø­Ù…Ù„Ø©', 'success');
            } else {
                html += '<li>âŒ Ù…ÙƒØªØ¨Ø© Supabase ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©</li>';
                log('âŒ Ù…ÙƒØªØ¨Ø© Supabase ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©', 'error');
            }
            
            // ÙØ­Øµ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†
            if (typeof SUPABASE_URL !== 'undefined' && typeof SUPABASE_ANON_KEY !== 'undefined') {
                html += '<li>âœ… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©</li>';
                html += `<li>ğŸŒ URL: ${SUPABASE_URL}</li>`;
                log('âœ… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©', 'success');
            } else {
                html += '<li>âŒ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† Ù…ÙÙ‚ÙˆØ¯Ø©</li>';
                log('âŒ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† Ù…ÙÙ‚ÙˆØ¯Ø©', 'error');
            }
            
            // ÙØ­Øµ Ø¹Ù…ÙŠÙ„ Supabase
            if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                html += '<li>âœ… Ø¹Ù…ÙŠÙ„ Supabase Ù…Ù‡ÙŠØ£</li>';
                log('âœ… Ø¹Ù…ÙŠÙ„ Supabase Ù…Ù‡ÙŠØ£', 'success');
            } else {
                html += '<li>âŒ Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…Ù‡ÙŠØ£</li>';
                log('âŒ Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…Ù‡ÙŠØ£', 'error');
            }
            
            // ÙØ­Øµ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const requiredFunctions = [
                'uploadFileToSupabase',
                'getPropertyAttachmentsEnhanced',
                'deleteAttachmentEnhanced',
                'showAttachmentsModal'
            ];
            
            let functionsCount = 0;
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    functionsCount++;
                    html += `<li>âœ… ${funcName}</li>`;
                } else {
                    html += `<li>âŒ ${funcName}</li>`;
                    log(`âŒ ÙˆØ¸ÙŠÙØ© ${funcName} Ù…ÙÙ‚ÙˆØ¯Ø©`, 'error');
                }
            });
            
            html += `<li>ğŸ“Š Ø§Ù„ÙˆØ¸Ø§Ø¦Ù: ${functionsCount}/${requiredFunctions.length}</li>`;
            html += '</ul>';
            
            systemInfo.innerHTML = html;
            log(`ğŸ“Š ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ÙƒØªÙ…Ù„: ${functionsCount}/${requiredFunctions.length} ÙˆØ¸ÙŠÙØ© Ù…ØªÙˆÙØ±Ø©`);
        }

        async function testSupabaseConnection() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase...');
            
            try {
                if (!supabaseClient) {
                    throw new Error('Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…Ù‡ÙŠØ£');
                }

                const { data, error } = await supabaseClient
                    .from('attachments')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    throw error;
                }

                log('âœ… Ø§ØªØµØ§Ù„ Supabase ÙŠØ¹Ù…Ù„', 'success');
                showResult('connectionResults', 'success', 'Ø§ØªØµØ§Ù„ Supabase ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ');
                return true;
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Supabase: ${error.message}`, 'error');
                showResult('connectionResults', 'error', `Ø®Ø·Ø£: ${error.message}`);
                return false;
            }
        }

        async function testAttachmentsTable() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('attachments')
                    .select('*')
                    .limit(5);

                if (error) {
                    throw error;
                }

                log(`âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙŠØ¹Ù…Ù„ - ${data.length} Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯`, 'success');
                showResult('connectionResults', 'success', `Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${data.length} Ø³Ø¬Ù„`);
                
                if (data.length > 0) {
                    log(`ğŸ“„ Ø£ÙˆÙ„ Ø³Ø¬Ù„: ${data[0].file_name} (${data[0].property_key})`, 'info');
                }
                
                return data;
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ${error.message}`, 'error');
                showResult('connectionResults', 'error', `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ${error.message}`);
                return null;
            }
        }

        async function checkAllAttachments() {
            log('ğŸ” ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');
            
            try {
                // ÙØ­Øµ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                const { data: cloudAttachments, error } = await supabaseClient
                    .from('attachments')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                // ÙØ­Øµ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const localAttachments = JSON.parse(localStorage.getItem('propertyAttachments') || '{}');
                
                let html = '<h4>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:</h4>';
                html += `<p>â˜ï¸ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: ${cloudAttachments.length}</p>`;
                
                let localCount = 0;
                Object.values(localAttachments).forEach(attachments => {
                    if (Array.isArray(attachments)) {
                        localCount += attachments.length;
                    }
                });
                html += `<p>ğŸ’¾ Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø­Ù„ÙŠØ©: ${localCount}</p>`;
                
                // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù‚Ø§Ø±
                const propertyGroups = {};
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                cloudAttachments.forEach(att => {
                    if (!propertyGroups[att.property_key]) {
                        propertyGroups[att.property_key] = { cloud: [], local: [] };
                    }
                    propertyGroups[att.property_key].cloud.push(att);
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                Object.entries(localAttachments).forEach(([propertyKey, attachments]) => {
                    if (!propertyGroups[propertyKey]) {
                        propertyGroups[propertyKey] = { cloud: [], local: [] };
                    }
                    propertyGroups[propertyKey].local = attachments || [];
                });
                
                html += '<h4>ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù‚Ø§Ø±:</h4>';
                
                if (Object.keys(propertyGroups).length === 0) {
                    html += '<p style="color: #ffc107;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª</p>';
                } else {
                    Object.entries(propertyGroups).forEach(([propertyKey, data]) => {
                        const totalFiles = data.cloud.length + data.local.length;
                        const hasFiles = totalFiles > 0;
                        
                        html += `
                            <div class="property-test ${hasFiles ? 'has-attachments' : 'no-attachments'}">
                                <strong>${propertyKey}</strong><br>
                                â˜ï¸ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: ${data.cloud.length} Ù…Ù„Ù<br>
                                ğŸ’¾ Ù…Ø­Ù„ÙŠ: ${data.local.length} Ù…Ù„Ù<br>
                                ğŸ“Š Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${totalFiles} Ù…Ù„Ù
                            </div>
                        `;
                    });
                }
                
                document.getElementById('attachmentsResults').innerHTML = html;
                
                log(`âœ… ÙØ­Øµ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…ÙƒØªÙ…Ù„: ${cloudAttachments.length} Ø³Ø­Ø§Ø¨Ø©ØŒ ${localCount} Ù…Ø­Ù„ÙŠ`, 'success');
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ${error.message}`, 'error');
                showResult('attachmentsResults', 'error', `Ø®Ø·Ø£: ${error.message}`);
            }
        }

        async function testPropertyAttachments() {
            log('ğŸ  Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');
            
            try {
                // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                let properties = [];
                
                if (typeof window.properties !== 'undefined' && Array.isArray(window.properties)) {
                    properties = window.properties;
                } else {
                    log('âš ï¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'warning');
                }
                
                let html = '<h4>ğŸ  Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:</h4>';
                
                if (properties.length === 0) {
                    html += '<p style="color: #ffc107;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>';
                } else {
                    for (let i = 0; i < Math.min(5, properties.length); i++) {
                        const property = properties[i];
                        const city = property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        const unitNumber = property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        const propertyKey = `${city}_${unitNumber}`;
                        
                        // Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                        let attachments = [];
                        try {
                            if (typeof getPropertyAttachmentsEnhanced === 'function') {
                                attachments = await getPropertyAttachmentsEnhanced(propertyKey);
                            }
                        } catch (error) {
                            log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø±ÙÙ‚Ø§Øª ${propertyKey}: ${error.message}`, 'error');
                        }
                        
                        const hasAttachments = attachments.length > 0;
                        
                        html += `
                            <div class="property-test ${hasAttachments ? 'has-attachments' : 'no-attachments'}">
                                <strong>${city} - ${unitNumber}</strong><br>
                                ğŸ”‘ Ø§Ù„Ù…ÙØªØ§Ø­: ${propertyKey}<br>
                                ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ${attachments.length} Ù…Ù„Ù<br>
                                <button onclick="testShowModal('${city}', '${unitNumber}')">Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
                            </div>
                        `;
                    }
                }
                
                document.getElementById('propertyResults').innerHTML = html;
                log(`âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± ${Math.min(5, properties.length)} Ø¹Ù‚Ø§Ø±`, 'success');
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: ${error.message}`, 'error');
                showResult('propertyResults', 'error', `Ø®Ø·Ø£: ${error.message}`);
            }
        }

        function testShowModal(city, propertyName) {
            log(`ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø±Ø¶ Ù…Ø±ÙÙ‚Ø§Øª ${city} - ${propertyName}...`);
            
            try {
                if (typeof showAttachmentsModal === 'function') {
                    showAttachmentsModal(city, propertyName);
                    log('âœ… ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª', 'success');
                } else {
                    throw new Error('ÙˆØ¸ÙŠÙØ© showAttachmentsModal ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ${error.message}`, 'error');
            }
        }

        function uploadTestFile() {
            document.getElementById('testFileInput').click();
        }

        async function handleTestUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const file = files[0];
            log(`ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù ØªØ¬Ø±ÙŠØ¨ÙŠ: ${file.name}`);
            
            try {
                if (typeof uploadFileToSupabase === 'function') {
                    const result = await uploadFileToSupabase(file, 'ØªØ´Ø®ÙŠØµ_Ø§Ø®ØªØ¨Ø§Ø±', 'Ù…Ù„Ù ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„ØªØ´Ø®ÙŠØµ');
                    
                    if (result) {
                        log(`âœ… ØªÙ… Ø±ÙØ¹ ${file.name} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                        showResult('functionsResults', 'success', `ØªÙ… Ø±ÙØ¹ ${file.name} Ø¨Ù†Ø¬Ø§Ø­`);
                    } else {
                        throw new Error('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
                    }
                } else {
                    throw new Error('ÙˆØ¸ÙŠÙØ© uploadFileToSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ${error.message}`, 'error');
                showResult('functionsResults', 'error', `Ø®Ø·Ø£: ${error.message}`);
            }
        }

        function clearLog() {
            document.getElementById('diagnosticLog').textContent = '';
            diagnosticData = [];
            log('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„');
        }

        function exportDiagnostics() {
            const diagnosticText = diagnosticData.map(entry => 
                `[${entry.timestamp}] ${entry.type.toUpperCase()}: ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([diagnosticText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attachments-diagnostic-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('ğŸ“„ ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ');
        }

        // ØªØ´ØºÙŠÙ„ ØªØ´Ø®ÙŠØµ Ø£ÙˆÙ„ÙŠ
        setTimeout(() => {
            testSupabaseConnection();
            setTimeout(() => {
                testAttachmentsTable();
                setTimeout(() => {
                    checkAllAttachments();
                }, 1000);
            }, 1000);
        }, 2000);
    </script>
</body>
</html>
