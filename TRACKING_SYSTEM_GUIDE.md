# 📊 دليل نظام سجلات التتبع المحسن

## 🎯 نظرة عامة

تم تطوير نظام سجلات التتبع المحسن ليوفر:
- ☁️ **حفظ في قاعدة البيانات السحابية** (Supabase)
- 🔄 **التحديثات الفورية** بين جميع المستخدمين
- 📅 **عرض التاريخ الميلادي** كأساسي مع الاحتفاظ بالهجري
- 🔒 **أمان متقدم** مع Row Level Security
- 💾 **نسخ احتياطية محلية** في حالة انقطاع الاتصال

---

## 🚀 الميزات الجديدة

### 1. **التاريخ الميلادي كأساسي**
- عرض التاريخ بتنسيق DD/MM/YYYY
- الوقت بتنسيق 24 ساعة (HH:MM)
- الاحتفاظ بالتاريخ الهجري للمرجعية

### 2. **المزامنة الفورية**
- تحديثات فورية عند إضافة سجلات جديدة
- إشعارات عند حذف السجلات
- مزامنة تلقائية بين جميع الأجهزة

### 3. **قاعدة البيانات السحابية**
- حفظ آمن في Supabase
- فهرسة محسنة للبحث السريع
- نسخ احتياطية تلقائية

---

## 🛠️ الإعداد والتثبيت

### 1. **إعداد قاعدة البيانات**

قم بتشغيل ملف `change-logs-setup.sql` في Supabase:

```sql
-- تشغيل جميع الأوامر في ملف change-logs-setup.sql
```

### 2. **التحقق من الإعداد**

```javascript
// في console المتصفح
testEnhancedTrackingSystem();
```

### 3. **تفعيل التحديثات الفورية**

```javascript
// يتم تفعيلها تلقائياً عند تحميل الصفحة
// للتحقق من الحالة:
console.log(window.changeLogSubscription);
```

---

## 📋 كيفية الاستخدام

### 1. **عرض سجلات التتبع**

```javascript
// عرض نافذة سجلات التتبع
showChangeTrackingModal();
```

أو من خلال الواجهة:
- انقر على زر "سجل التتبع" في الهيدر
- أو من قائمة الفلاتر والمرفقات

### 2. **إضافة سجل تتبع جديد**

```javascript
// إضافة سجل تتبع يدوياً
await addChangeLog(
    'تعديل بيانات موجودة',  // نوع العملية
    {                          // بيانات الوحدة
        'رقم  الوحدة ': '101',
        'اسم العقار': 'عمارة النخيل',
        'المدينة': 'الرياض',
        'اسم المستأجر': 'أحمد محمد'
    },
    {                          // التغييرات
        'اسم المستأجر': {
            old: 'أحمد محمد',
            new: 'محمد أحمد',
            fieldName: 'اسم المستأجر'
        }
    },
    {                          // معلومات إضافية
        reason: 'تصحيح الاسم',
        notes: 'تم التصحيح بناءً على طلب المستأجر'
    }
);
```

### 3. **البحث والفلترة**

- **فلتر بالتاريخ**: اختر تاريخ محدد
- **فلتر بالشهر**: اختر شهر وسنة
- **نوع العملية**: فلترة حسب نوع العملية
- **البحث النصي**: البحث في جميع الحقول

### 4. **التصدير والطباعة**

```javascript
// تصدير إلى Excel
exportTrackingLogs();

// طباعة السجلات
printTrackingLogs();
```

---

## 🔧 الوظائف المتاحة

### وظائف أساسية:
- `testEnhancedTrackingSystem()` - اختبار النظام الشامل
- `showChangeTrackingModal()` - عرض سجلات التتبع
- `addChangeLog(type, data, changes, info)` - إضافة سجل جديد
- `exportTrackingLogs()` - تصدير إلى Excel
- `printTrackingLogs()` - طباعة السجلات

### وظائف التنسيق:
- `formatGregorianDate(date)` - تنسيق التاريخ الميلادي
- `formatTime(date)` - تنسيق الوقت
- `getDayName(date)` - الحصول على اسم اليوم

### وظائف المزامنة:
- `setupChangeLogRealtimeSubscription()` - تفعيل التحديثات الفورية
- `loadChangeLogsFromSupabase(limit)` - تحميل من السحابة
- `saveChangeLogToSupabase(log)` - حفظ في السحابة

---

## 📊 أنواع العمليات المدعومة

- **تعديل بيانات موجودة** - تحديث معلومات الوحدة
- **عميل جديد** - إضافة مستأجر جديد
- **تجديد العقد** - تجديد عقد موجود
- **إفراغ وحدة** - إخلاء الوحدة من المستأجر
- **نقل وحدة** - نقل بين العقارات
- **حذف وحدة** - حذف وحدة من النظام
- **إنشاء عقار** - إضافة عقار جديد
- **حذف عقار** - حذف عقار من النظام

---

## 🔍 استكشاف الأخطاء

### 1. **مشاكل الاتصال بـ Supabase**

```javascript
// فحص الاتصال
if (!supabaseClient) {
    console.error('Supabase غير متصل');
}

// اختبار الجدول
const { data, error } = await supabaseClient
    .from('change_logs')
    .select('id')
    .limit(1);
```

### 2. **مشاكل التحديثات الفورية**

```javascript
// فحص الاشتراك
if (!window.changeLogSubscription) {
    console.log('إعادة تفعيل الاشتراك...');
    window.changeLogSubscription = setupChangeLogRealtimeSubscription();
}
```

### 3. **مشاكل التخزين المحلي**

```javascript
// فحص التخزين المحلي
try {
    const logs = localStorage.getItem('changeTrackingLogs');
    console.log('السجلات المحلية:', logs ? JSON.parse(logs).length : 0);
} catch (error) {
    console.error('خطأ في التخزين المحلي:', error);
}
```

---

## 📈 الإحصائيات والتقارير

### إحصائيات متاحة:
- إجمالي السجلات
- السجلات اليوم
- السجلات هذا الأسبوع
- السجلات هذا الشهر
- أكثر المستخدمين نشاطاً
- أكثر العمليات شيوعاً

### استعلامات مفيدة:

```sql
-- إحصائيات شاملة
SELECT * FROM get_change_logs_stats();

-- السجلات الحديثة
SELECT * FROM recent_change_logs LIMIT 20;

-- سجلات عقار محدد
SELECT * FROM get_property_change_logs('عمارة النخيل');
```

---

## 🔒 الأمان والصلاحيات

- **Row Level Security**: مفعل على جدول change_logs
- **سياسات الوصول**: جميع المستخدمين لديهم صلاحيات كاملة
- **التشفير**: جميع البيانات مشفرة في النقل والتخزين
- **النسخ الاحتياطية**: تلقائية في Supabase

---

## 🎯 أفضل الممارسات

1. **استخدم التاريخ الميلادي** للبحث والفلترة
2. **راجع السجلات بانتظام** لمتابعة التغييرات
3. **استخدم الفلاتر** لتضييق نطاق البحث
4. **صدّر السجلات** للأرشفة الدورية
5. **تحقق من الاتصال** عند مواجهة مشاكل

---

## 📞 الدعم والمساعدة

للحصول على المساعدة:
1. استخدم `testEnhancedTrackingSystem()` للتشخيص
2. راجع console المتصفح للأخطاء
3. تحقق من حالة الاتصال بـ Supabase
4. تواصل مع فريق التطوير عند الحاجة
