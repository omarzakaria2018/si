let properties = [];
let filteredProperties = []; // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªØµØ¯ÙŠØ±
let currentView = 'cards';
let currentCountry = null;
let currentProperty = null;
let filterStatus = null;

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
let activeFilters = {
    city: '',
    property: '',
    status: '',
    contractType: '',
    propertyType: '',
    dateFilter: '',
    startDate: '',
    endDate: '',
    nearExpiry: false,
    monthFilter: '',
    multiProperty: [],
    owner: ''
};

// ===== ACTIVE FILTERS MANAGEMENT SYSTEM =====
// Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
function updateActiveFiltersDisplay() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©...');

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø£ÙˆÙ„Ø§Ù‹
    resetClearFiltersButtonsState();

    const desktopList = document.getElementById('activeFiltersList');
    const mobileList = document.getElementById('activeFiltersListMobile');
    const desktopClearBtn = document.getElementById('clearAllFiltersBtn');
    const mobileClearBtn = document.getElementById('clearAllFiltersBtnMobile');
    const desktopContainer = document.getElementById('activeFiltersDesktop');
    const mobileFilterBtn = document.getElementById('mobileFiltersBtn');
    const mobileFilterCount = document.getElementById('mobileFilterCount');
    const noFiltersMessage = document.getElementById('noFiltersMessage');

    console.log('ğŸ“‹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', {
        desktopList: !!desktopList,
        mobileList: !!mobileList,
        desktopContainer: !!desktopContainer,
        mobileFilterBtn: !!mobileFilterBtn
    });

    // Ù…Ø³Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (desktopList) desktopList.innerHTML = '';
    if (mobileList) mobileList.innerHTML = '';

    const filters = [];

    // Ø¬Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„' && currentCountry !== null) {
        filters.push({
            type: 'city',
            label: `Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry}`,
            value: currentCountry
        });
    }

    if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„' && currentProperty !== null) {
        filters.push({
            type: 'property',
            label: `Ø§Ù„Ø¹Ù‚Ø§Ø±: ${currentProperty}`,
            value: currentProperty
        });
    }

    if (filterStatus && filterStatus !== 'Ø§Ù„ÙƒÙ„' && filterStatus !== null) {
        const statusLabels = {
            'ÙØ¹Ø§Ù„': 'ÙØ¹Ø§Ù„',
            'Ù…Ù†ØªÙ‡ÙŠ': 'Ù…Ù†ØªÙ‡ÙŠ',
            'ÙØ§Ø±Øº': 'ÙØ§Ø±Øº',
            'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡': 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'
        };
        filters.push({
            type: 'status',
            label: `Ø§Ù„Ø­Ø§Ù„Ø©: ${statusLabels[filterStatus] || filterStatus}`,
            value: filterStatus
        });
    }

    // Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ/Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ)
    if (currentPropertyTypeFilter && currentPropertyTypeFilter !== null) {
        const typeLabels = {
            'buildings': 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ',
            'lands': 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'
        };
        filters.push({
            type: 'propertyTypeFilter',
            label: `Ø§Ù„Ù†ÙˆØ¹: ${typeLabels[currentPropertyTypeFilter] || currentPropertyTypeFilter}`,
            value: currentPropertyTypeFilter
        });
    }

    // Ø¥Ø¶Ø§ÙØ© ÙÙ„Ø§ØªØ± Ø£Ø®Ø±Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
    if (activeFilters.contractType) {
        filters.push({
            type: 'contractType',
            label: `Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${activeFilters.contractType}`,
            value: activeFilters.contractType
        });
    }

    if (activeFilters.propertyType) {
        filters.push({
            type: 'propertyType',
            label: `Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${activeFilters.propertyType}`,
            value: activeFilters.propertyType
        });
    }

    if (activeFilters.dateFilter) {
        filters.push({
            type: 'dateFilter',
            label: `ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®: ${activeFilters.dateFilter}`,
            value: activeFilters.dateFilter
        });
    }

    if (activeFilters.monthFilter) {
        filters.push({
            type: 'monthFilter',
            label: `Ø§Ù„Ø´Ù‡Ø±: ${activeFilters.monthFilter}`,
            value: activeFilters.monthFilter
        });
    }

    if (activeFilters.multiProperty && activeFilters.multiProperty.length > 0) {
        filters.push({
            type: 'multiProperty',
            label: `Ø¹Ù‚Ø§Ø±Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (${activeFilters.multiProperty.length})`,
            value: activeFilters.multiProperty
        });
    }

    if (activeFilters.owner) {
        filters.push({
            type: 'owner',
            label: `Ø§Ù„Ù…Ø§Ù„Ùƒ: ${activeFilters.owner}`,
            value: activeFilters.owner
        });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ±
    const hasFilters = filters.length > 0;

    console.log('ğŸ·ï¸ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©:', filters);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ±:', filters.length);

    if (hasFilters) {
        filters.forEach(filter => {
            const desktopTag = createFilterTag(filter);
            const mobileTag = createFilterTag(filter);
            if (desktopList) desktopList.appendChild(desktopTag);
            if (mobileList) mobileList.appendChild(mobileTag);
        });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
        if (desktopClearBtn) {
            desktopClearBtn.style.display = 'inline-flex';
            desktopClearBtn.style.visibility = 'visible';
            desktopClearBtn.style.opacity = '1';
        }
        if (mobileClearBtn) {
            mobileClearBtn.style.display = 'block';
            mobileClearBtn.style.visibility = 'visible';
            mobileClearBtn.style.opacity = '1';
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
        if (desktopContainer) {
            desktopContainer.style.display = 'block';
            desktopContainer.style.visibility = 'visible';
            desktopContainer.style.opacity = '1';
        }

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        const allClearButtons = document.querySelectorAll('.clear-all-filters-btn');
        allClearButtons.forEach(btn => {
            btn.style.display = 'flex';
            btn.style.visibility = 'visible';
            btn.style.opacity = '1';
        });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù‡Ø§ØªÙ
        if (mobileFilterBtn) {
            mobileFilterBtn.classList.add('has-filters');
            if (mobileFilterCount) {
                mobileFilterCount.textContent = filters.length;
                mobileFilterCount.style.display = 'flex';
            }
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙ„Ø§ØªØ±"
        if (noFiltersMessage) noFiltersMessage.style.display = 'none';

    } else {
        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
        if (desktopClearBtn) desktopClearBtn.style.display = 'none';
        if (mobileClearBtn) mobileClearBtn.style.display = 'none';

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
        if (desktopContainer) desktopContainer.style.display = 'none';

        // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù‡Ø§ØªÙ
        if (mobileFilterBtn) {
            mobileFilterBtn.classList.remove('has-filters');
            if (mobileFilterCount) mobileFilterCount.style.display = 'none';
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙ„Ø§ØªØ±"
        if (noFiltersMessage) noFiltersMessage.style.display = 'block';
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    updateAllFilterButtonsState();

    // Ø¶Ù…Ø§Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†
    ensureClearButtonsVisibility();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†
function ensureClearButtonsVisibility() {
    console.log('ğŸ” ÙØ­Øµ ÙˆØ¶Ù…Ø§Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±...');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
    const clearButtons = document.querySelectorAll('.clear-all-filters-btn');
    const hasActiveFilters = document.querySelectorAll('.active-filter-tag').length > 0;

    console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${clearButtons.length}`);
    console.log(`ğŸ·ï¸ Ù‡Ù†Ø§Ùƒ ÙÙ„Ø§ØªØ± Ù†Ø´Ø·Ø©: ${hasActiveFilters}`);

    if (hasActiveFilters) {
        clearButtons.forEach((btn, index) => {
            btn.style.display = 'flex';
            btn.style.visibility = 'visible';
            btn.style.opacity = '1';
            console.log(`âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø±Ù‚Ù… ${index + 1}`);
        });

        // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        createMissingClearButtons();
    } else {
        clearButtons.forEach((btn, index) => {
            btn.style.display = 'none';
            console.log(`âŒ ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø±Ù‚Ù… ${index + 1} (Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙ„Ø§ØªØ± Ù†Ø´Ø·Ø©)`);
        });
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
function createMissingClearButtons() {
    console.log('ğŸ”§ ÙØ­Øµ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©...');

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹
    resetClearFiltersButtonsState();

    // ÙØ­Øµ Ø²Ø± Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    const desktopContainer = document.getElementById('activeFiltersDesktop');
    if (desktopContainer && !desktopContainer.querySelector('.clear-all-filters-btn')) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'clear-all-filters-btn';
        clearBtn.id = 'clearAllFiltersBtn';
        clearBtn.onclick = function() { clearAllFiltersWithLoading(this); };
        clearBtn.innerHTML = `
            <i class="fas fa-times-circle"></i>
            <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
        `;
        desktopContainer.appendChild(clearBtn);
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù…Ø¹ loading');
    }

    // ÙØ­Øµ Ø²Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù…Ø´ØªØ±Ùƒ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
    const statisticsContainer = document.getElementById('statisticsActiveFilters');
    if (statisticsContainer && !statisticsContainer.querySelector('.clear-all-filters-btn')) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'clear-all-filters-btn';
        clearBtn.onclick = function() { clearAllFiltersWithLoading(this); };
        clearBtn.innerHTML = `
            <i class="fas fa-times-circle"></i>
            <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
        `;
        statisticsContainer.appendChild(clearBtn);
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
    }

    // ÙØ­Øµ Ø²Ø± Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© (Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª)
    const mobileContainer = document.getElementById('activeFiltersListMobile');
    if (mobileContainer && !mobileContainer.querySelector('.clear-all-filters-btn')) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'clear-all-filters-btn mobile-clear-btn';
        clearBtn.onclick = function() { clearAllFiltersWithLoading(this); };
        clearBtn.innerHTML = `
            <i class="fas fa-times-circle"></i>
            <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
        `;
        mobileContainer.appendChild(clearBtn);
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©');
    }

    // ÙØ­Øµ Ø²Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
    const mobileFiltersModal = document.querySelector('.mobile-filters-modal .modal-body');
    if (mobileFiltersModal && !mobileFiltersModal.querySelector('.clear-all-filters-btn')) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'clear-all-filters-btn mobile-clear-btn';
        clearBtn.onclick = function() { clearAllFiltersWithLoading(this); };
        clearBtn.innerHTML = `
            <i class="fas fa-times-circle"></i>
            <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
        `;
        mobileFiltersModal.appendChild(clearBtn);
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ ØªØ§Øº ÙÙ„ØªØ±
function createFilterTag(filter) {
    const tag = document.createElement('span');
    tag.className = 'active-filter-tag';
    tag.innerHTML = `
        ${filter.label}
        <i class="fas fa-times"></i>
    `;

    tag.onclick = () => removeFilterWithLoading(filter.type, filter.value, tag);

    return tag;
}

// Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ù…Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
function removeFilterWithLoading(type, value, tagElement) {
    console.log(`ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ù…Ø¹ loading: ${type} = ${value}`);

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Øº Ø§Ù„Ù…Ø­Ø¯Ø¯
    if (tagElement) {
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ
        tagElement.dataset.originalContent = tagElement.innerHTML;

        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        tagElement.classList.add('loading');
        tagElement.innerHTML = `
            <i class="fas fa-spinner fa-spin" style="margin-left: 5px;"></i>
            Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø²Ø§Ù„Ø©...
        `;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
    showClearFiltersLoading(true);

    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    const filterContainers = document.querySelectorAll('.active-filters-list, #activeFiltersList, #activeFiltersListMobile');
    filterContainers.forEach(container => {
        container.classList.add('active-filters-loading');
    });

    // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ ØªØ§Ø¬Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
    const allFilterTags = document.querySelectorAll('.active-filter-tag');
    allFilterTags.forEach(tag => {
        if (tag !== tagElement) {
            tag.style.opacity = '0.5';
            tag.style.pointerEvents = 'none';
        }
    });

    // ØªÙ†ÙÙŠØ° Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ± Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¨ØµØ±ÙŠ
    setTimeout(() => {
        removeFilter(type, value);

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¬Ø§Ø­ ØµØºÙŠØ±
        showMiniIconNotification('ğŸ—‘ï¸', '#28a745', 1500);

        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        setTimeout(() => {
            showClearFiltersLoading(false);

            // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„ÙÙ„Ø§ØªØ±
            filterContainers.forEach(container => {
                container.classList.remove('active-filters-loading');
            });

            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ ØªØ§Ø¬Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
            const remainingFilterTags = document.querySelectorAll('.active-filter-tag');
            remainingFilterTags.forEach(tag => {
                tag.classList.remove('loading');
                tag.style.opacity = '1';
                tag.style.pointerEvents = 'auto';
                tag.style.cursor = 'pointer';
            });
        }, 300);
    }, 600); // ØªØ£Ø®ÙŠØ± 600ms Ù„Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±
function showFilterRemovalSuccess(filterType, filterValue) {
    let message = '';
    switch (filterType) {
        case 'city':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${filterValue}`;
            break;
        case 'property':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±: ${filterValue}`;
            break;
        case 'status':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${filterValue}`;
            break;
        case 'contractType':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${filterValue}`;
            break;
        case 'propertyType':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${filterValue}`;
            break;
        case 'dateFilter':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®`;
            break;
        case 'monthFilter':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±`;
            break;
        case 'multiProperty':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©`;
            break;
        case 'owner':
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ: ${filterValue}`;
            break;
        default:
            message = `ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±: ${filterValue}`;
    }

    console.log(`âœ… ${message}`);
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù…Ø±Ø¦ÙŠ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
}

// Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ù…Ø­Ø¯Ø¯ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ù‡Ø±Ù…ÙŠ
function removeFilter(type, value) {
    console.log(`ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ±: ${type} = ${value}`);

    switch (type) {
        case 'city':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ØªÙØ¹ÙŠÙ„ "Ø§Ù„ÙƒÙ„" Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹
            console.log('ğŸ™ï¸ Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØªÙØ¹ÙŠÙ„ "Ø§Ù„ÙƒÙ„"...');

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            currentCountry = null;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ± Ø¹Ù‚Ø§Ø± Ù†Ø´Ø·ØŒ Ù‚Ù… Ø¨Ø¥Ø²Ø§Ù„ØªÙ‡ Ø£ÙŠØ¶Ø§Ù‹ Ù„Ø£Ù†Ù‡ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
            if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
                currentProperty = null;
                updatePropertyButtonsState();
            }

            // ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ù„ÙƒÙ„" Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            activateAllCitiesFilter();

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙˆØ±Ø§Ù‹
            renderData();

            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ "Ø§Ù„ÙƒÙ„" Ø¨Ù†Ø¬Ø§Ø­');
            break;

        case 'property':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±: Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            console.log('ğŸ¢ Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©...');

            currentProperty = null;

            // ØªÙØ¹ÙŠÙ„ "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª" ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (ÙˆÙ„ÙŠØ³ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª)
            activateAllPropertiesInCurrentCity();

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙˆØ±Ø§Ù‹
            renderData();

            console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©');
            break;

        case 'status':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª
            filterStatus = null;
            updateStatusButtonsState();
            break;

        case 'contractType':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
            activeFilters.contractType = '';
            contractTypeFilter = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø£ØµÙ„ÙŠ Ø£ÙŠØ¶Ø§Ù‹
            updateContractTypeButtonsState();
            break;

        case 'propertyType':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
            activeFilters.propertyType = '';
            propertyTypeFilter = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø£ØµÙ„ÙŠ Ø£ÙŠØ¶Ø§Ù‹
            updatePropertyTypeButtonsState();
            break;

        case 'dateFilter':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
            activeFilters.dateFilter = '';
            activeFilters.startDate = '';
            activeFilters.endDate = '';
            updateDateFilterButtonsState();
            break;

        case 'monthFilter':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±
            activeFilters.monthFilter = '';
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹
            dateFilterType = '';
            dateFilterDay = '';
            dateFilterMonth = '';
            dateFilterYear = '';
            updateMonthFilterButtonsState();
            break;

        case 'multiProperty':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
            activeFilters.multiProperty = [];
            updateMultiPropertyButtonsState();
            break;

        case 'owner':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ
            activeFilters.owner = '';
            updateOwnerFilterButtonsState();
            break;

        case 'propertyTypeFilter':
            // Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ/Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ)
            currentPropertyTypeFilter = null;
            updatePropertyTypeFiltersState();
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
            initPropertyList(currentCountry);
            break;
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
    renderData();
    updateActiveFiltersDisplay();
    saveAppState();

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showFilterRemovalSuccess(type, value);

    console.log('âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶');
}

// Ø¯ÙˆØ§Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ù„ÙÙ„Ø§ØªØ±
function updateCityButtonsState() {
    const cityButtons = document.querySelectorAll('.country-btn, .city-btn, .city-option');
    cityButtons.forEach(btn => {
        btn.classList.remove('active');
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„ÙˆÙ† Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        btn.style.background = '';
        btn.style.color = '';
    });

    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø¯ÙŠÙ†Ø© Ù…Ø­Ø¯Ø¯Ø©ØŒ ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ù„ÙƒÙ„"
    if (!currentCountry || currentCountry === 'Ø§Ù„ÙƒÙ„') {
        const allButton = document.querySelector('.country-btn[data-country="Ø§Ù„ÙƒÙ„"], .city-option:first-child');
        if (allButton) {
            allButton.classList.add('active');
        }
    }
}

// ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ± "Ø§Ù„ÙƒÙ„" Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
function activateAllCitiesFilter() {
    console.log('ğŸ¯ ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ± "Ø§Ù„ÙƒÙ„" Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹...');

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© selectCountry Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªÙØ¹ÙŠÙ„ "Ø§Ù„ÙƒÙ„"
    if (typeof selectCountry === 'function') {
        selectCountry('Ø§Ù„ÙƒÙ„');
        console.log('âœ… ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ selectCountry("Ø§Ù„ÙƒÙ„") Ø¨Ù†Ø¬Ø§Ø­');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù† ÙÙˆØ±Ø§Ù‹
        setTimeout(() => {
            updateCityButtonsVisualState();
        }, 50);

    } else {
        console.warn('âš ï¸ Ø¯Ø§Ù„Ø© selectCountry ØºÙŠØ± Ù…ØªØ§Ø­Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©...');
        fallbackActivateAll();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
        setTimeout(() => {
            updateCityButtonsVisualState();
        }, 50);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù†
function updateCityButtonsVisualState() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ø± "Ø§Ù„ÙƒÙ„" ÙˆØªÙØ¹ÙŠÙ„Ù‡ Ù…Ø±Ø¦ÙŠØ§Ù‹
    const allButtons = [
        document.querySelector('.country-btn[onclick*="selectCountry(\'Ø§Ù„ÙƒÙ„\'"]'),
        document.querySelector('.country-btn[onclick*="selectCountry(\\\'Ø§Ù„ÙƒÙ„\\\'"]'),
        document.querySelector('.country-btn[data-country="Ø§Ù„ÙƒÙ„"]'),
        ...Array.from(document.querySelectorAll('.country-btn, .city-btn, .city-option')).filter(btn =>
            btn.textContent.trim() === 'Ø§Ù„ÙƒÙ„' ||
            btn.textContent.includes('Ø§Ù„ÙƒÙ„')
        )
    ].filter(btn => btn);

    if (allButtons.length > 0) {
        const allButton = allButtons[0];

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù†
        document.querySelectorAll('.country-btn, .city-btn, .city-option').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '';
            btn.style.color = '';
        });

        // ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ù„ÙƒÙ„" Ù…Ø±Ø¦ÙŠØ§Ù‹
        allButton.classList.add('active');
        allButton.style.background = '#007bff';
        allButton.style.color = 'white';

        console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ù„ÙƒÙ„" Ù…Ø±Ø¦ÙŠØ§Ù‹');
    }
}

// Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„ØªÙØ¹ÙŠÙ„ "Ø§Ù„ÙƒÙ„" ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ù„Ø© selectCountry
function fallbackActivateAll() {
    console.log('ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© Ù„ØªÙØ¹ÙŠÙ„ "Ø§Ù„ÙƒÙ„"...');

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    currentCountry = null;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    renderData();
    updateCityButtonsState();
}

// ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ± "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª" Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
function activateAllPropertiesFilter() {
    console.log('ğŸ¢ ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ± "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª" Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹...');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ù„Ø© selectProperty Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©
    if (typeof selectProperty === 'function') {
        selectProperty('Ø§Ù„ÙƒÙ„');
        console.log('âœ… ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ selectProperty("Ø§Ù„ÙƒÙ„") Ø¨Ù†Ø¬Ø§Ø­');
    } else {
        console.log('âš ï¸ Ø¯Ø§Ù„Ø© selectProperty ØºÙŠØ± Ù…ØªØ§Ø­Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©...');
        fallbackActivateAllProperties();
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    setTimeout(() => {
        updatePropertyButtonsVisualState();
    }, 50);
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function updatePropertyButtonsVisualState() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ø± "Ø§Ù„ÙƒÙ„" ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØªÙØ¹ÙŠÙ„Ù‡ Ù…Ø±Ø¦ÙŠØ§Ù‹
    const allPropertyButtons = [
        document.querySelector('.property-btn[onclick*="selectProperty(\'Ø§Ù„ÙƒÙ„\'"]'),
        document.querySelector('.property-btn[onclick*="selectProperty(\\\'Ø§Ù„ÙƒÙ„\\\'"]'),
        document.querySelector('.property-btn[data-property="Ø§Ù„ÙƒÙ„"]'),
        document.querySelector('.property-option:first-child'),
        ...Array.from(document.querySelectorAll('.property-btn, .property-option')).filter(btn =>
            btn.textContent.trim() === 'Ø§Ù„ÙƒÙ„' ||
            btn.textContent.includes('Ø§Ù„ÙƒÙ„') ||
            btn.textContent.includes('Ø¬Ù…ÙŠØ¹')
        )
    ].filter(btn => btn);

    if (allPropertyButtons.length > 0) {
        const allButton = allPropertyButtons[0];

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        document.querySelectorAll('.property-btn, .property-option').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '';
            btn.style.color = '';
        });

        // ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ù„ÙƒÙ„" Ù…Ø±Ø¦ÙŠØ§Ù‹
        allButton.classList.add('active');
        allButton.style.background = '#007bff';
        allButton.style.color = 'white';

        console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª" Ù…Ø±Ø¦ÙŠØ§Ù‹');
    }
}

// Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„ØªÙØ¹ÙŠÙ„ "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª"
function fallbackActivateAllProperties() {
    console.log('ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© Ù„ØªÙØ¹ÙŠÙ„ "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª"...');

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
    currentProperty = null;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    renderData();
    updatePropertyButtonsState();
}

// ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (ÙˆÙ„ÙŠØ³ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª)
function activateAllPropertiesInCurrentCity() {
    console.log('ğŸ™ï¸ ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©...');
    console.log(`ğŸ“ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${currentCountry || 'Ø§Ù„ÙƒÙ„'}`);

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±
    const savedCity = currentCountry;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø· Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ selectProperty)
    currentProperty = null;

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ù… ØªØªØºÙŠØ±
    currentCountry = savedCity;

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    if (typeof initPropertyList === 'function') {
        initPropertyList(currentCountry);
        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry || 'Ø§Ù„ÙƒÙ„'}`);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    setTimeout(() => {
        updatePropertyButtonsVisualStateInCity();
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
        updateActiveFiltersDisplay();
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
        updateAllFilterButtonsState();
    }, 50);

    console.log(`âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry || 'Ø§Ù„ÙƒÙ„'}`);
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
function updatePropertyButtonsVisualStateInCity() {
    console.log('ğŸ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©...');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ø± "Ø§Ù„ÙƒÙ„" ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØªÙØ¹ÙŠÙ„Ù‡ Ù…Ø±Ø¦ÙŠØ§Ù‹
    const allPropertyButtons = [
        document.querySelector('.property-btn[onclick*="selectProperty(\'Ø§Ù„ÙƒÙ„\'"]'),
        document.querySelector('.property-btn[onclick*="selectProperty(\\\'Ø§Ù„ÙƒÙ„\\\'"]'),
        document.querySelector('.property-btn[data-property="Ø§Ù„ÙƒÙ„"]'),
        document.querySelector('.property-option:first-child'),
        ...Array.from(document.querySelectorAll('.property-btn, .property-option')).filter(btn =>
            btn.textContent.trim() === 'Ø§Ù„ÙƒÙ„' ||
            btn.textContent.includes('Ø§Ù„ÙƒÙ„') ||
            btn.textContent.includes('Ø¬Ù…ÙŠØ¹')
        )
    ].filter(btn => btn);

    if (allPropertyButtons.length > 0) {
        const allButton = allPropertyButtons[0];

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        document.querySelectorAll('.property-btn, .property-option').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '';
            btn.style.color = '';
        });

        // ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ù„ÙƒÙ„" Ù…Ø±Ø¦ÙŠØ§Ù‹
        allButton.classList.add('active');
        allButton.style.background = '#007bff';
        allButton.style.color = 'white';

        console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª" Ù…Ø±Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©');
    }

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ø§ ÙŠØ²Ø§Ù„ Ù†Ø´Ø·Ø§Ù‹
    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„') {
        console.log(`ğŸ™ï¸ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry}`);
        updateCityButtonsState();
    }
}

// Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
function fallbackActivateAllPropertiesInCity() {
    console.log('ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©...');

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    const savedCity = currentCountry;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø· (Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
    currentProperty = null;

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ù… ØªØªØºÙŠØ±
    currentCountry = savedCity;

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    if (typeof initPropertyList === 'function') {
        initPropertyList(currentCountry);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    renderData();
    updatePropertyButtonsState();

    console.log(`ğŸ™ï¸ ØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry || 'Ø§Ù„ÙƒÙ„'}`);
    console.log(`ğŸ¢ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ù„Ù‰: ${currentProperty || 'Ø§Ù„ÙƒÙ„'}`);
}



function updatePropertyButtonsState() {
    const propertyButtons = document.querySelectorAll('.property-btn, .property-option');
    propertyButtons.forEach(btn => {
        btn.classList.remove('active');
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„ÙˆÙ† Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        btn.style.background = '';
        btn.style.color = '';
    });

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯ØŒ ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ù„ÙƒÙ„"
    if (!currentProperty || currentProperty === 'Ø§Ù„ÙƒÙ„') {
        const allButton = document.querySelector('.property-btn[data-property="Ø§Ù„ÙƒÙ„"], .property-option:first-child');
        if (allButton) {
            allButton.classList.add('active');
        }
    }
}

function updateStatusButtonsState() {
    const statusButtons = document.querySelectorAll('.status-filter button, .status-btn');
    statusButtons.forEach(btn => {
        btn.classList.remove('active');
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„ÙˆÙ† Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø£Ø²Ø±Ù‚ Ù„Ù„Ù†Ø´Ø·)
        if (filterStatus && btn.textContent.includes(filterStatus)) {
            btn.style.background = '#007bff';
            btn.style.color = 'white';
        } else {
            btn.style.background = '';
            btn.style.color = '';
        }
    });
}

function updateContractTypeButtonsState() {
    const contractButtons = document.querySelectorAll('.contract-type-btn, #contractTypeFilterBtn');
    contractButtons.forEach(btn => {
        if (activeFilters.contractType) {
            btn.style.background = '#007bff';
            btn.style.color = 'white';
        } else {
            btn.style.background = '';
            btn.style.color = '';
        }
    });
}

function updatePropertyTypeButtonsState() {
    const propertyTypeButtons = document.querySelectorAll('.property-type-btn, #propertyTypeFilterBtn');
    propertyTypeButtons.forEach(btn => {
        if (activeFilters.propertyType) {
            btn.style.background = '#28a745';
            btn.style.color = 'white';
        } else {
            btn.style.background = '';
            btn.style.color = '';
        }
    });
}

function updateDateFilterButtonsState() {
    const dateButtons = document.querySelectorAll('.date-filter-btn, #dateFilterBtn');
    dateButtons.forEach(btn => {
        if (activeFilters.dateFilter || activeFilters.startDate || activeFilters.endDate) {
            btn.style.background = '#007bff';
            btn.style.color = 'white';
        } else {
            btn.style.background = '';
            btn.style.color = '';
        }
    });
}

function updateMonthFilterButtonsState() {
    const monthButtons = document.querySelectorAll('.month-filter-btn, #monthFilterBtn');
    monthButtons.forEach(btn => {
        if (activeFilters.monthFilter) {
            btn.style.background = '#007bff';
            btn.style.color = 'white';
        } else {
            btn.style.background = '';
            btn.style.color = '';
        }
    });
}

function updateMultiPropertyButtonsState() {
    const multiButtons = document.querySelectorAll('.multi-property-btn, #multiPropertyFilterBtn');
    multiButtons.forEach(btn => {
        if (activeFilters.multiProperty && activeFilters.multiProperty.length > 0) {
            btn.style.background = '#007bff';
            btn.style.color = 'white';
        } else {
            btn.style.background = '';
            btn.style.color = '';
        }
    });
}

function updateOwnerFilterButtonsState() {
    const ownerButtons = document.querySelectorAll('.owner-filter-btn, #ownerFilterBtn, #mobile-owner-filter-btn');
    ownerButtons.forEach(btn => {
        if (activeFilters.owner) {
            btn.style.background = '#007bff';
            btn.style.color = 'white';
        } else {
            btn.style.background = '';
            btn.style.color = '';
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø´Ø§Ù…Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
function updateAllFilterButtonsState() {
    console.log('ğŸ¨ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±...');

    updateCityButtonsState();
    updatePropertyButtonsState();
    updateStatusButtonsState();
    updateContractTypeButtonsState();
    updateDateFilterButtonsState();
    updateMonthFilterButtonsState();
    updateMultiPropertyButtonsState();
    updateOwnerFilterButtonsState();

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    updateGenericFilterButtons();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ÙÙ„Ø§ØªØ±
function updateGenericFilterButtons() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const filterButtons = document.querySelectorAll(`
        .filter-btn,
        .header-main-btn,
        .export-btn,
        [id*="Filter"],
        [class*="filter"],
        [onclick*="filter"],
        [onclick*="Filter"]
    `);

    filterButtons.forEach(btn => {
        const btnText = btn.textContent.toLowerCase();
        const btnId = btn.id.toLowerCase();
        const btnClass = btn.className.toLowerCase();

        let isActive = false;

        // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± Ù…Ø±ØªØ¨Ø· Ø¨ÙÙ„ØªØ± Ù†Ø´Ø·
        if (btnText.includes('Ù…Ø¯ÙŠÙ†Ø©') || btnText.includes('city') || btnId.includes('city')) {
            isActive = currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„';
        } else if (btnText.includes('Ø¹Ù‚Ø§Ø±') || btnText.includes('property') || btnId.includes('property')) {
            isActive = currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„';
        } else if (btnText.includes('Ø­Ø§Ù„Ø©') || btnText.includes('status') || btnId.includes('status')) {
            isActive = filterStatus && filterStatus !== 'Ø§Ù„ÙƒÙ„';
        } else if (btnText.includes('Ø¹Ù‚Ø¯') || btnText.includes('contract') || btnId.includes('contract')) {
            isActive = activeFilters.contractType && activeFilters.contractType !== '';
        } else if (btnText.includes('Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±') || btnText.includes('property-type') || btnId.includes('property-type')) {
            isActive = activeFilters.propertyType && activeFilters.propertyType !== '';
        } else if (btnText.includes('ØªØ§Ø±ÙŠØ®') || btnText.includes('date') || btnId.includes('date')) {
            isActive = activeFilters.dateFilter || activeFilters.startDate || activeFilters.endDate;
        } else if (btnText.includes('Ø´Ù‡Ø±') || btnText.includes('month') || btnId.includes('month')) {
            isActive = activeFilters.monthFilter && activeFilters.monthFilter !== '';
        } else if (btnText.includes('Ù…Ø§Ù„Ùƒ') || btnText.includes('owner') || btnId.includes('owner')) {
            isActive = activeFilters.owner && activeFilters.owner !== '';
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        if (isActive) {
            btn.style.background = '#007bff';
            btn.style.color = 'white';
            btn.style.borderColor = '#007bff';
        } else {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            btn.style.background = '';
            btn.style.color = '';
            btn.style.borderColor = '';
        }
    });
}

// Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±
function clearAllFilters() {
    console.log('ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±...');

    // ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    console.log('ğŸ” ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
    console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentUser);
    console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…ØªÙˆÙØ±Ø©:', !!users);

    if (currentUser && users[currentUser]) {
        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
        console.log('ğŸ“‹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', users[currentUser].permissions);

        const hasPermission = users[currentUser].permissions.clearFilters;
        console.log(`ğŸ” ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${currentUser}: ${hasPermission ? 'Ù…Ø³Ù…ÙˆØ­' : 'Ù…Ù…Ù†ÙˆØ¹'}`);

        if (!hasPermission) {
            console.log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±');
            showNoPermissionMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±');
            return;
        }

        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± - Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©...');
    } else {
        console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        if (!currentUser) {
            console.log('âŒ currentUser is null/undefined');
        }
        if (!users[currentUser]) {
            console.log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
    showClearFiltersLoading(true);

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    currentCountry = null;
    currentProperty = null;
    filterStatus = null;
    currentPropertyTypeFilter = null; // Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø­ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ/Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    activeFilters = {
        city: '',
        property: '',
        status: '',
        contractType: '',
        propertyType: '',
        dateFilter: '',
        startDate: '',
        endDate: '',
        nearExpiry: false,
        monthFilter: '',
        multiProperty: [],
        owner: ''
    };

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© ÙÙ‚Ø· (ÙƒØ£Ù†Ù†Ø§ Ù†Ù‚Ø±Ù†Ø§ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰)
    console.log('ğŸ”„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©...');

    // Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹
    if (filterStatus && filterStatus !== 'Ø§Ù„ÙƒÙ„') {
        console.log(`ğŸ”„ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${filterStatus}`);
        if (typeof toggleStatusFilter === 'function') {
            toggleStatusFilter(filterStatus);
        }
    }

    // Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹
    if (propertyTypeFilter && propertyTypeFilter !== 'Ø§Ù„ÙƒÙ„') {
        console.log(`ğŸ”„ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyTypeFilter}`);
        if (typeof togglePropertyTypeFilter === 'function') {
            togglePropertyTypeFilter(propertyTypeFilter);
        }
    }

    // Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹
    if (contractTypeFilter && contractTypeFilter !== 'Ø§Ù„ÙƒÙ„') {
        console.log(`ğŸ”„ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${contractTypeFilter}`);
        if (typeof toggleContractTypeFilter === 'function') {
            toggleContractTypeFilter(contractTypeFilter);
        }
    }

    // Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹
    if (activeFilters.owner && activeFilters.owner !== '' && activeFilters.owner !== 'Ø§Ù„ÙƒÙ„') {
        console.log(`ğŸ”„ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ: ${activeFilters.owner}`);
        if (typeof toggleOwnerFilter === 'function') {
            toggleOwnerFilter(activeFilters.owner);
        }
    }

    // Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ/Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹
    if (currentPropertyTypeFilter && currentPropertyTypeFilter !== null) {
        console.log(`ğŸ”„ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ/Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ): ${currentPropertyTypeFilter}`);
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ/Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
        if (typeof updatePropertyTypeFiltersState === 'function') {
            updatePropertyTypeFiltersState();
        }
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        if (typeof initPropertyList === 'function') {
            initPropertyList(currentCountry);
        }
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const countryButtons = document.querySelectorAll('.country-btn, .city-btn');
    countryButtons.forEach(btn => btn.classList.remove('active'));

    const propertyButtons = document.querySelectorAll('.property-btn');
    propertyButtons.forEach(btn => btn.classList.remove('active'));

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø£Ø®Ø±Ù‰
    const filterButtons = document.querySelectorAll('.filter-btn, .status-btn');
    filterButtons.forEach(btn => btn.classList.remove('active'));

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±
    const buildingsBtn = document.querySelector('.property-filter-btn.buildings-filter');
    const landsBtn = document.querySelector('.property-filter-btn.lands-filter');
    if (buildingsBtn) {
        buildingsBtn.classList.remove('active');
        console.log('ğŸ¢ ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªÙ†Ø´ÙŠØ· Ø²Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©');
    }
    if (landsBtn) {
        landsBtn.classList.remove('active');
        console.log('ğŸ”ï¸ ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªÙ†Ø´ÙŠØ· Ø²Ø± Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©');
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    if (typeof renderData === 'function') {
        renderData();
    } else {
        displayProperties(properties);
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // Ø¶Ù…Ø§Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
    setTimeout(() => {
        ensureClearButtonsVisibility();
    }, 100);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    if (typeof updateTotalStats === 'function') {
        updateTotalStats();
    }

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    saveAppState();

    // Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ù† HTML
    const desktopList = document.getElementById('activeFiltersList');
    const mobileList = document.getElementById('activeFiltersListMobile');
    if (desktopList) desktopList.innerHTML = '';
    if (mobileList) mobileList.innerHTML = '';

    // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
    const clearBtns = document.querySelectorAll('.clear-all-filters-btn');
    clearBtns.forEach(btn => btn.style.display = 'none');

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù‡Ø§ØªÙ
    const mobileFilterBtn = document.getElementById('mobileFiltersBtn');
    if (mobileFilterBtn) {
        mobileFilterBtn.classList.remove('has-filters');
    }

    console.log('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±');

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª
    updateMobilePropertyName();

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    setTimeout(() => {
        if (typeof renderData === 'function') {
            renderData();
        }
        if (typeof updateTotals === 'function') {
            updateTotals();
        }
        updateActiveFiltersDisplay();

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ/Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø´ÙŠØ· Ø§Ù„Ø¨ØµØ±ÙŠ
        if (typeof updatePropertyTypeFiltersState === 'function') {
            updatePropertyTypeFiltersState();
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        setTimeout(() => {
            showClearFiltersLoading(false);
        }, 300);
    }, 100);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµØºÙŠØ±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†ØµÙŠ
    showMiniIconNotification('ğŸ—‘ï¸', '#28a745', 2000);
}

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
function showClearFiltersLoading(show) {
    const clearButtons = document.querySelectorAll('.clear-all-filters-btn');

    clearButtons.forEach(btn => {
        if (show) {
            // Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
            if (!btn.dataset.originalText) {
                btn.dataset.originalText = btn.innerHTML;
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            btn.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="margin-left: 8px;"></i>
                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...
            `;
            btn.disabled = true;
            btn.style.opacity = '0.7';
        } else {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
            if (btn.dataset.originalText) {
                btn.innerHTML = btn.dataset.originalText;
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø­ÙÙˆØ¸Ø§Ù‹ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                btn.innerHTML = `
                    <i class="fas fa-times-circle"></i>
                    <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
                `;
            }
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.classList.remove('loading');
            btn.style.transform = 'scale(1)';
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
function resetClearFiltersButtonsState() {
    console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±...');

    const clearButtons = document.querySelectorAll('.clear-all-filters-btn');
    clearButtons.forEach(btn => {
        // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.classList.remove('loading');
        btn.style.transform = 'scale(1)';

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        if (btn.innerHTML.includes('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­') || btn.innerHTML.includes('fa-spinner')) {
            btn.innerHTML = `
                <i class="fas fa-times-circle"></i>
                <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
            `;
        }

        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        delete btn.dataset.originalText;
    });

    console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±');
}

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
function showDownloadProgress(fileName, show) {
    const progressId = `download-progress-${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;

    if (show) {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const progressDiv = document.createElement('div');
        progressDiv.id = progressId;
        progressDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #17a2b8;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
        `;

        progressDiv.innerHTML = `
            <i class="fas fa-spinner fa-spin"></i>
            <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„: ${fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName}</span>
        `;

        document.body.appendChild(progressDiv);

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¸Ù‡ÙˆØ±
        setTimeout(() => {
            progressDiv.style.transform = 'translateX(0)';
            progressDiv.style.opacity = '1';
        }, 100);

    } else {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const progressDiv = document.getElementById(progressId);
        if (progressDiv) {
            progressDiv.style.transform = 'translateX(100%)';
            progressDiv.style.opacity = '0';
            setTimeout(() => {
                if (progressDiv.parentNode) {
                    progressDiv.parentNode.removeChild(progressDiv);
                }
            }, 300);
        }
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¤Ù‚Øª
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : '#007bff'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;

    // Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
    if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    document.body.appendChild(notification);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµØºÙŠØ±Ø© Ø¨Ø­Ø¬Ù… 5px
function showMiniIconNotification(icon, color, duration = 2000) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingIcons = document.querySelectorAll('.mini-icon-notification-5px');
    existingIcons.forEach(existingIcon => existingIcon.remove());

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµØºÙŠØ±Ø©
    const iconElement = document.createElement('div');
    iconElement.className = 'mini-icon-notification-5px';
    iconElement.textContent = icon;

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ù…Ø§Ø·
    iconElement.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        width: 5px;
        height: 5px;
        background: ${color};
        border-radius: 50%;
        z-index: 10000;
        font-size: 3px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        animation: miniIconPulse5px 0.5s ease-out;
        transition: all 0.3s ease;
        pointer-events: none;
    `;

    // Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (!document.getElementById('mini-icon-5px-styles')) {
        const style = document.createElement('style');
        style.id = 'mini-icon-5px-styles';
        style.textContent = `
            @keyframes miniIconPulse5px {
                0% {
                    transform: scale(0);
                    opacity: 0;
                }
                50% {
                    transform: scale(1.5);
                    opacity: 1;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            .mini-icon-notification-5px {
                position: fixed;
                top: 20px;
                right: 20px;
                width: 5px;
                height: 5px;
                border-radius: 50%;
                z-index: 10000;
                font-size: 3px;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                transition: all 0.3s ease;
                pointer-events: none;
            }

            /* Ù„Ù„Ø¬ÙˆØ§Ù„ - ØªÙƒØ¨ÙŠØ± Ù‚Ù„ÙŠÙ„ */
            @media (max-width: 768px) {
                .mini-icon-notification-5px {
                    width: 6px;
                    height: 6px;
                    font-size: 4px;
                    top: 15px;
                    right: 15px;
                }
            }
        `;
        document.head.appendChild(style);
    }

    document.body.appendChild(iconElement);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    setTimeout(() => {
        iconElement.style.opacity = '0';
        iconElement.style.transform = 'scale(0)';
        setTimeout(() => {
            if (iconElement.parentNode) {
                iconElement.parentNode.removeChild(iconElement);
            }
        }, 300);
    }, duration);
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù‡Ø§ØªÙ
function toggleMobileFilters() {
    const modal = document.getElementById('mobileFiltersModal');
    if (modal) {
        if (modal.classList.contains('active')) {
            closeMobileFilters();
        } else {
            openMobileFilters();
        }
    }
}

function openMobileFilters() {
    const modal = document.getElementById('mobileFiltersModal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©

        // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø©
        updateActiveFiltersDisplay();

        console.log('ğŸ“± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù‡Ø§ØªÙ');
    }
}

function closeMobileFilters() {
    const modal = document.getElementById('mobileFiltersModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ±

        console.log('ğŸ“± Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù‡Ø§ØªÙ');
    }
}



// ===== STATE MANAGEMENT SYSTEM =====
// Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„

// Ù…ÙØ§ØªÙŠØ­ ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
const STATE_STORAGE_KEY = 'alsenidi_app_state';
const SESSION_MARKER_KEY = 'alsenidi_session_active';
const LAST_VISIT_KEY = 'alsenidi_last_visit';

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ù„Ø³Ø© ÙØ±ÙŠØ¯
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø© (Ø¬Ø¯ÙŠØ¯Ø© Ø£Ù… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„)
function isPageReload() {
    const currentSessionId = sessionStorage.getItem(SESSION_MARKER_KEY);
    const lastVisit = localStorage.getItem(LAST_VISIT_KEY);
    const now = Date.now();

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø±Ù Ø¬Ù„Ø³Ø©ØŒ ÙÙ‡Ø°Ù‡ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if (!currentSessionId) {
        return false;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 30 Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if (lastVisit && (now - parseInt(lastVisit)) > 30 * 60 * 1000) {
        return false;
    }

    return true;
}

// ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©
function markSessionStart() {
    const sessionId = generateSessionId();
    sessionStorage.setItem(SESSION_MARKER_KEY, sessionId);
    localStorage.setItem(LAST_VISIT_KEY, Date.now().toString());
    console.log('ğŸ†• Ø¨Ø¯Ø§ÙŠØ© Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©:', sessionId);
}

// ===== Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙØ­ (State Persistence) =====

// Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©)
// const STATE_STORAGE_KEY = 'realEstateAppState'; // ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹
const FILTERS_STORAGE_KEY = 'realEstateFilters';
const SCROLL_STORAGE_KEY = 'realEstateScrollPosition';

// Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„Ø© ÙÙŠ localStorage
function saveAppState() {
    try {
        const state = {
            // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            currentView: currentView,
            currentCountry: currentCountry,
            currentProperty: currentProperty,
            filterStatus: filterStatus,
            currentPropertyTypeFilter: currentPropertyTypeFilter,

            // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
            activeFilters: {
                city: currentCountry,
                property: currentProperty,
                status: filterStatus,
                contractType: typeof contractTypeFilter !== 'undefined' ? contractTypeFilter : null
            },

            // Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            sidebarVisible: document.getElementById('sidebar')?.style.display !== 'none',

            // Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø­Ø«
            searchValues: {
                global: document.getElementById('globalSearch')?.value || '',
                property: document.getElementById('propertySearch')?.value || ''
            },

            // Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
            scrollPosition: {
                x: window.scrollX || window.pageXOffset || 0,
                y: window.scrollY || window.pageYOffset || 0
            },

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
            timestamp: Date.now(),
            sessionId: getSessionId(),
            version: '2.0',

            // Ø­Ø§Ù„Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
            openModal: document.querySelector('.modal.show') ? true : false,
            isManagementMode: (typeof window.isManagementMode !== 'undefined') ? window.isManagementMode : false,

            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©
            lastVisit: Date.now()
        };

        localStorage.setItem(STATE_STORAGE_KEY, JSON.stringify(state));
        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', state);

        // Ø­ÙØ¸ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙÙ„Ø§ØªØ± ÙÙ‚Ø· (Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©)
        saveFiltersState();

    } catch (error) {
        console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
    }
}

// Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙ‚Ø· (Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©)
function saveFiltersState() {
    try {
        const filtersState = {
            currentCountry: currentCountry,
            currentProperty: currentProperty,
            filterStatus: filterStatus,
            currentPropertyTypeFilter: currentPropertyTypeFilter,
            contractType: typeof contractTypeFilter !== 'undefined' ? contractTypeFilter : null,
            timestamp: Date.now()
        };

        localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(filtersState));
        console.log('ğŸ” ØªÙ… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ±:', filtersState);
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ±:', error);
    }
}

// Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
function saveScrollPosition() {
    try {
        const scrollState = {
            x: window.scrollX || window.pageXOffset || 0,
            y: window.scrollY || window.pageYOffset || 0,
            timestamp: Date.now()
        };

        localStorage.setItem(SCROLL_STORAGE_KEY, JSON.stringify(scrollState));
        console.log('ğŸ“œ ØªÙ… Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±:', scrollState);
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±:', error);
    }
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©
function getSessionId() {
    let sessionId = sessionStorage.getItem('sessionId');
    if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
        sessionStorage.setItem('sessionId', sessionId);
    }
    return sessionId;
}

// Ù…Ø³Ø­ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«
function clearSearchInput() {
    const searchInput = document.getElementById('globalSearch');
    if (searchInput) {
        searchInput.value = '';
        console.log('ğŸ” ØªÙ… Ù…Ø³Ø­ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«');
    }
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† localStorage Ù…Ø¹ Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨ÙŠÙ† Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
function restoreAppState() {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
        const isReload = isPageReload();

        console.log(`ğŸ” Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©: ${isReload ? 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„' : 'Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©'}`);

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù„Ø§ ØªØ³ØªØ¹ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ø¨Ø¯Ø£ Ø¨Ù€ "Ø§Ù„ÙƒÙ„"
        if (!isReload) {
            console.log('ğŸ†• Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© - Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¹Ø±Ø¶ "Ø§Ù„ÙƒÙ„"');
            markSessionStart();

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            currentView = 'cards';
            currentCountry = null;
            currentProperty = null;
            filterStatus = null;

            // Ù…Ø³Ø­ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«
            clearSearchInput();

            // Ù…Ø³Ø­ Ø£ÙŠ Ø­Ø§Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù‚Ø¯ÙŠÙ…Ø©
            localStorage.removeItem(STATE_STORAGE_KEY);

            return false;
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ØŒ Ù…Ø³Ø­ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ "Ø§Ù„ÙƒÙ„"
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ - Ù…Ø³Ø­ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ "Ø§Ù„ÙƒÙ„"');
        clearSearchInput();

        // Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ "Ø§Ù„ÙƒÙ„" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©
        console.log('ğŸ  Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ - Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        currentView = 'cards';
        currentCountry = null;
        currentProperty = null;
        filterStatus = null;
        currentPropertyTypeFilter = null;

        // Ù…Ø³Ø­ Ø£ÙŠ Ø­Ø§Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø©
        localStorage.removeItem(STATE_STORAGE_KEY);
        markSessionStart();

        return false;
    } catch (error) {
        console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
        localStorage.removeItem(STATE_STORAGE_KEY);
        return false;
    }
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function applyRestoredState(state) {
    console.log('ğŸ¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');

    try {
        // 1. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶
        if (state.currentView && state.currentView !== currentView) {
            toggleView(state.currentView);
            console.log('ğŸ“± ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶:', state.currentView);
        }

        // 2. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        if (state.currentCountry) {
            console.log('ğŸ™ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:', state.currentCountry);

            // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù† Ø£ÙˆÙ„Ø§Ù‹
            if (typeof initCountryButtons === 'function') {
                initCountryButtons();
            }

            // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
            setTimeout(() => {
                if (typeof selectCountry === 'function') {
                    selectCountry(state.currentCountry);
                } else {
                    // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
                    currentCountry = state.currentCountry;
                    updateCityButtonsState();
                }
            }, 50);
        }

        // 3. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
        if (state.currentProperty) {
            console.log('ğŸ¢ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±:', state.currentProperty);

            setTimeout(() => {
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                if (typeof initPropertyList === 'function') {
                    initPropertyList(state.currentCountry);
                }

                // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
                setTimeout(() => {
                    if (typeof selectProperty === 'function') {
                        selectProperty(state.currentProperty);
                    } else {
                        // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
                        currentProperty = state.currentProperty;
                        updatePropertyButtonsState();
                    }
                }, 100);
            }, 150);
        }

        // 4. Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
        if (state.filterStatus) {
            console.log('ğŸ“Š Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©:', state.filterStatus);

            setTimeout(() => {
                if (typeof setStatusFilter === 'function') {
                    setStatusFilter(state.filterStatus);
                } else {
                    // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
                    filterStatus = state.filterStatus;
                }
            }, 200);
        }

        // 5. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø­Ø« (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­ÙÙˆØ¸Ø©)
        if (state.searchValues) {
            setTimeout(() => {
                const globalSearch = document.getElementById('globalSearch');
                const propertySearch = document.getElementById('propertySearch');

                if (globalSearch && state.searchValues.global) {
                    globalSearch.value = state.searchValues.global;
                }

                if (propertySearch && state.searchValues.property) {
                    propertySearch.value = state.searchValues.property;
                }
            }, 250);
        }

        // 6. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        if (state.scrollPosition) {
            setTimeout(() => {
                restoreScrollPosition(state.scrollPosition);
            }, 500);
        }

        // 7. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        setTimeout(() => {
            if (typeof renderData === 'function') {
                renderData();
            }

            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
            if (typeof updateActiveFiltersDisplay === 'function') {
                updateActiveFiltersDisplay();
            }

            console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }, 300);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø©:', error);
    }
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
function restoreScrollPosition(scrollPosition) {
    try {
        if (scrollPosition && (scrollPosition.x || scrollPosition.y)) {
            window.scrollTo(scrollPosition.x || 0, scrollPosition.y || 0);
            console.log('ğŸ“œ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±:', scrollPosition);
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±:', error);
    }
}

// Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
function clearAppState() {
    localStorage.removeItem(STATE_STORAGE_KEY);
    localStorage.removeItem(FILTERS_STORAGE_KEY);
    localStorage.removeItem(SCROLL_STORAGE_KEY);
    console.log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
}

// Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
function autoSaveState() {
    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ ØªØºÙŠØ± Ø´ÙŠØ¡
    let lastSavedState = '';

    setInterval(() => {
        const currentState = JSON.stringify({
            currentView,
            currentCountry,
            currentProperty,
            filterStatus
        });

        if (currentState !== lastSavedState) {
            saveAppState();
            lastSavedState = currentState;
        }
    }, 2000);
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
function setupStateEventHandlers() {
    console.log('ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©...');

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    window.addEventListener('beforeunload', () => {
        console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©...');
        saveAppState();
        saveScrollPosition();
    });

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© (ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('ğŸ‘ï¸ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø©...');
            saveAppState();
            saveScrollPosition();
        }
    });

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
    window.addEventListener('resize', () => {
        setTimeout(() => {
            saveAppState();
        }, 500);
    });

    // Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
    let scrollTimeout;
    window.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            saveScrollPosition();
        }, 300);
    });

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø­Ø«
    setTimeout(() => {
        const globalSearch = document.getElementById('globalSearch');
        const propertySearch = document.getElementById('propertySearch');

        if (globalSearch) {
            globalSearch.addEventListener('input', () => {
                setTimeout(saveAppState, 1000); // ØªØ£Ø®ÙŠØ± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙØ±Ø·
            });
        }

        if (propertySearch) {
            propertySearch.addEventListener('input', () => {
                setTimeout(saveAppState, 1000);
            });
        }
    }, 1000);

    console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©');
}

// ===== ØªØ­Ø¯ÙŠØ« ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ =====

// ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© selectCountry Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
const originalSelectCountry = selectCountry;
selectCountry = function(country) {
    console.log('ğŸ™ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©:', country);

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const result = originalSelectCountry.call(this, country);

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    setTimeout(() => {
        saveAppState();
    }, 100);

    return result;
};

// ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© selectProperty Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
const originalSelectProperty = selectProperty;
selectProperty = function(propertyName) {
    console.log('ğŸ¢ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©:', propertyName);

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const result = originalSelectProperty.call(this, propertyName);

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    setTimeout(() => {
        saveAppState();
    }, 100);

    return result;
};

// ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙØ­
function initializeStatePersistence() {
    console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙØ­...');

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    setupStateEventHandlers();

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    autoSaveState();

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const restoredState = restoreAppState();

    if (restoredState) {
        console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙØ­ Ø¨Ù†Ø¬Ø§Ø­');
        return true;
    } else {
        console.log('ğŸ†• Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©');
        return false;
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
function addStateEventListeners() {
    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.addEventListener('beforeunload', function() {
        saveAppState();
        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©');
    });

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© (ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            saveAppState();
            console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø©');
        }
    });

    // Ù„Ø§ Ù†Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« - Ø³ÙŠØªÙ… Ù…Ø³Ø­Ù‡Ø§ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    // const globalSearch = document.getElementById('globalSearch');
    // const propertySearch = document.getElementById('propertySearch');
    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« Ù„Ù…Ù†Ø¹ Ø­ÙØ¸ Ù‚ÙŠÙ… Ø§Ù„Ø¨Ø­Ø«

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© (Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ)
    window.addEventListener('resize', function() {
        clearTimeout(window.resizeSaveTimeout);
        window.resizeSaveTimeout = setTimeout(() => {
            saveAppState();
        }, 500);
    });

    console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©');
}

// Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ ÙØªØ±Ø©
function autoSaveState() {
    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
    setInterval(() => {
        console.log('â° Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø­Ø§Ù„Ø©...');
        saveAppState();
    }, 30000);

    console.log('â° ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø­Ø§Ù„Ø© (ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©)');
}

// Ù…Ø±Ø§Ù‚Ø¨ Ù„Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function setupLogoutButtonObserver() {
    // Ù…Ø±Ø§Ù‚Ø¨ DOM Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ header ÙˆØ¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                const header = document.querySelector('.header-section.header-actions');
                const logoutBtn = document.getElementById('logoutBtn');

                if (header && !logoutBtn && currentUser && currentUser !== 'guest') {
                    console.log('ğŸ” Ù…Ø±Ø§Ù‚Ø¨ DOM: Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
                    setTimeout(() => {
                        addLogoutButton();
                        updateMobileUserSection();
                    }, 100);
                }
            }
        });
    });

    // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ DOM
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    console.log('ğŸ‘ï¸ ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
}

// Ù…Ø±Ø§Ù‚Ø¨ Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
function setupAdminButtonsObserver() {
    if (!currentUser || !users[currentUser] || users[currentUser].role !== 'limited') {
        return; // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    }

    console.log('ğŸ‘ï¸ ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©...');

    // Ù…Ø±Ø§Ù‚Ø¨ DOM Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                setTimeout(() => {
                    restrictAdminButtonsForLimitedUser();
                }, 100);
            }
        });
    });

    // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ DOM
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©');
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø®ÙØ§Ø¦Ù‡Ø§)
function hideAdminButtonsForLimitedUser() {
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù€ restrictAdminButtonsForLimitedUser
    // Ù„ÙƒÙ† Ù†Ø­ØªÙØ¸ Ø¨Ù‡Ø§ Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (!currentUser || !users[currentUser] || users[currentUser].role !== 'limited') {
        return;
    }

    console.log('ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø¯Ø§Ù„Ø© ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„...');
    restrictAdminButtonsForLimitedUser();
}

// Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
window.fixLimitedUserButtons = function() {
    console.log('ğŸš¨ ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ„Ø§Ø³
    document.body.classList.add('limited-user');
    console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ limited-user');

    // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡
    restrictAdminButtonsForLimitedUser();

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
    setupAdminButtonsObserver();

    console.log('ğŸ‰ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
    console.log('ğŸ’¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¢Ù† Ø¸Ø§Ù‡Ø±Ø© Ù„ÙƒÙ† Ù…Ø­Ù…ÙŠØ© - Ø³ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±');
};

// Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„ØªØ£ÙƒÙŠØ¯
function clearAppStateWithConfirmation() {
    const confirmed = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ\n\nØ³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰:\nâ€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\nâ€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±\nâ€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±\nâ€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶\nâ€¢ Ù…Ø³Ø­ Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø­Ø«');

    if (confirmed) {
        clearAppState();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        currentView = 'cards';
        currentCountry = null;
        currentProperty = null;
        filterStatus = null;

        // Ù…Ø³Ø­ Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø­Ø«
        clearAllSearchFields();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        setTimeout(() => {
            initCountryButtons();
            initPropertyList();
            renderData();

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            alert('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!');
        }, 100);

        console.log('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« (Ù…Ø­Ø³Ù†Ø©)
function clearAllSearchFields() {
    console.log('ğŸ” Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø«...');

    // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…
    const globalSearch = document.getElementById('globalSearch');
    if (globalSearch) {
        globalSearch.value = '';
        globalSearch.style.borderColor = '';
        globalSearch.classList.remove('searching', 'success', 'error');
        console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…');
    }

    // Ù…Ø³Ø­ Ø¨Ø­Ø« Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const propertySearch = document.getElementById('propertySearch');
    if (propertySearch) {
        propertySearch.value = '';
        propertySearch.style.borderColor = '';
        propertySearch.classList.remove('searching', 'success', 'error');
        console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¨Ø­Ø« Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
    }

    // Ù…Ø³Ø­ Ø¨Ø­Ø« Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
    const trackingSearch = document.getElementById('trackingSearch');
    if (trackingSearch) {
        trackingSearch.value = '';
        trackingSearch.style.borderColor = '';
        trackingSearch.classList.remove('searching', 'success', 'error');
        console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¨Ø­Ø« Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
    }

    // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    const attachmentSearches = document.querySelectorAll('#attachmentsSearch, #cardAttachmentsSearch');
    attachmentSearches.forEach(input => {
        if (input) {
            input.value = '';
            input.style.borderColor = '';
            input.classList.remove('searching', 'success', 'error');
        }
    });

    // Ù…Ø³Ø­ Ø£ÙŠ Ø­Ù‚ÙˆÙ„ Ø¨Ø­Ø« Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    const allSearchInputs = document.querySelectorAll('input[type="text"][placeholder*="Ø¨Ø­Ø«"], input[type="search"], input[id*="search"], input[id*="Search"]');
    allSearchInputs.forEach(input => {
        if (input && input.id !== 'globalSearch' && input.id !== 'propertySearch') {
            input.value = '';
            input.style.borderColor = '';
            input.classList.remove('searching', 'success', 'error');
        }
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„Ø¥Ù„ØºØ§Ø¡
    const clearButtons = document.querySelectorAll('.clear-btn, .cancel-btn, .global-cancel-btn, .property-clear-btn');
    clearButtons.forEach(btn => {
        if (btn && btn.style) {
            btn.style.display = 'none';
        }
    });

    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø«
    const searchLoadingIndicators = document.querySelectorAll('#searchLoadingIndicator, .search-loading, .search-indicator');
    searchLoadingIndicators.forEach(indicator => {
        if (indicator && indicator.style) {
            indicator.style.display = 'none';
        }
    });

    console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„ØªÙ‡Ø§');
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù…Ø©
function resetAppState() {
    try {
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù…Ø©...');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
        if (typeof currentView !== 'undefined') {
            currentView = 'properties'; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        }

        if (typeof currentSection !== 'undefined') {
            currentSection = 'main';
        }

        if (typeof isFilterActive !== 'undefined') {
            isFilterActive = false;
        }

        if (typeof lastSearchTerm !== 'undefined') {
            lastSearchTerm = '';
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØµÙØ­Ø§Øª
        if (typeof currentPage !== 'undefined') {
            currentPage = 1;
        }

        if (typeof itemsPerPage !== 'undefined') {
            itemsPerPage = 20; // Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯
        if (typeof selectedItems !== 'undefined') {
            selectedItems = [];
        }

        if (typeof selectedProperties !== 'undefined') {
            selectedProperties = [];
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        if (typeof activeModal !== 'undefined') {
            activeModal = null;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if (typeof isLoading !== 'undefined') {
            isLoading = false;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        if (typeof lastError !== 'undefined') {
            lastError = null;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† localStorage Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        try {
            localStorage.removeItem('tempSearchState');
            localStorage.removeItem('tempFilterState');
            localStorage.removeItem('lastSearchResults');
        } catch (e) {
            console.warn('ØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø³Ø­ localStorage:', e);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† sessionStorage Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        try {
            sessionStorage.removeItem('currentSearchTerm');
            sessionStorage.removeItem('activeFilters');
            sessionStorage.removeItem('searchResults');
        } catch (e) {
            console.warn('ØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø³Ø­ sessionStorage:', e);
        }

        console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù…Ø©');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
function forceShowAllData() {
    try {
        console.log('ğŸ”„ Ø¥Ø¬Ø¨Ø§Ø± Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        if (typeof searchState !== 'undefined') {
            searchState.global = '';
            searchState.property = '';
            searchState.isSearchActive = false;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±
        if (typeof currentCountry !== 'undefined') {
            currentCountry = null;
        }
        if (typeof currentProperty !== 'undefined') {
            currentProperty = null;
        }
        if (typeof filterStatus !== 'undefined') {
            filterStatus = null;
        }

        // ØªÙ†ÙÙŠØ° renderData Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙÙ„Ø§ØªØ±
        if (typeof renderData === 'function') {
            console.log('ğŸ“Š ØªÙ†ÙÙŠØ° renderData Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ÙØ§Ø±Øº Ù‚Ø¨Ù„ renderData
            const globalSearchInput = document.getElementById('globalSearch');
            if (globalSearchInput) {
                globalSearchInput.value = '';
            }

            renderData();
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        if (typeof updateTotalStats === 'function') {
            updateTotalStats();
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (typeof updateDataCounts === 'function') {
            updateDataCounts();
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (typeof initCountryButtons === 'function') {
            initCountryButtons();
        }

        if (typeof initPropertyList === 'function') {
            initPropertyList();
        }

        console.log('âœ… ØªÙ… Ø¥Ø¬Ø¨Ø§Ø± Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¬Ø¨Ø§Ø± Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function ensurePropertiesLoaded(functionName = 'unknown') {
    if (!properties || !Array.isArray(properties)) {
        console.error(`âŒ Ù…ØµÙÙˆÙØ© properties ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ${functionName}:`, properties);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        return false;
    }
    return true;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠØ©
function shouldHideField(fieldName) {
    const hiddenFields = [
        'Column1',
        'supabase_id',
        'created_at',
        'updated_at',
        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ',
        'id',
        'raw_data'
    ];
    return hiddenFields.includes(fieldName);
}

// ==================== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ© ====================

// Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ©
function showCrystalLoading() {
    console.log('ğŸ”® Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„
    const existingOverlay = document.getElementById('crystalLoadingOverlay');
    if (existingOverlay) {
        console.log('âš ï¸ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
    }

    // ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø´Ø§Ø´Ø©
    const isLimitedUser = currentUser && users[currentUser] && users[currentUser].role === 'limited';

    console.log('ğŸ” ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ showCrystalLoading:', {
        currentUser: currentUser,
        userExists: users[currentUser] ? true : false,
        userRole: users[currentUser] ? users[currentUser].role : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
        isLimitedUser: isLimitedUser
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'crystalLoadingOverlay';

    if (isLimitedUser) {
        // Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ Ø¨Ø³ÙŠØ·Ø© ÙˆÙ‡Ø§Ø¯Ø¦Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯
        loadingOverlay.className = 'limited-user-loading-overlay';
        loadingOverlay.innerHTML = `
            <div class="limited-loading-container">
                <div class="limited-loading-content">
                    <div class="limited-loading-icon">
                        <div class="limited-spinner"></div>
                    </div>
                    <h3 class="limited-loading-title">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
                    <div class="limited-progress-text" id="limitedProgressText">0%</div>
                </div>
            </div>
        `;
        console.log('ğŸ‘¤ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯');
    } else {
        // Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ÙˆØ§Ù„Ù‡Ø§Ø¯Ø¦Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
        loadingOverlay.className = 'simple-loading-overlay';
        loadingOverlay.innerHTML = `
            <div class="simple-loading-container">
                <div class="simple-loading-content">
                    <div class="simple-loading-icon">
                        <div class="simple-spinner"></div>
                    </div>
                    <h3 class="simple-loading-title">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
                    <div class="simple-progress-text" id="simpleProgressText">0%</div>
                </div>
            </div>
        `;
        console.log('ğŸ‘‘ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ÙˆØ§Ù„Ù‡Ø§Ø¯Ø¦Ø©');
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    document.body.appendChild(loadingOverlay);

    // Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
    if (isLimitedUser) {
        startLimitedUserProgressAnimation();
    } else {
        startCalmProgressAnimation();
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø§Ø¨Ø¯Ø£" Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(() => {
        if (isLimitedUser) {
            // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯: Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ø¨Ø¯Ø£ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
            const startButton = document.getElementById('limitedStartButton');
            if (startButton) {
                startButton.style.display = 'block';
                startButton.style.animation = 'limitedFadeIn 0.5s ease-out';
                console.log('ğŸ¯ ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø§Ø¨Ø¯Ø£" Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯');
            }
        } else {
            // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†: Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ø¨Ø¯Ø£ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
            const startButton = document.getElementById('startButton');
            if (startButton) {
                startButton.style.display = 'block';
                startButton.style.animation = 'fadeInUp 0.5s ease-out';
                console.log('ğŸ¯ ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø§Ø¨Ø¯Ø£" Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ');
            }
        }
    }, isLimitedUser ? 3000 : 5000);
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
function startCalmProgressAnimation() {
    const progressText = document.getElementById('simpleProgressText');

    if (!progressText) return;

    let progress = 0;
    const updateInterval = 200; // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 200ms (Ø£Ø¨Ø·Ø£ ÙˆØ£Ù‡Ø¯Ø£)
    const increment = 3; // Ø²ÙŠØ§Ø¯Ø© Ø«Ø§Ø¨ØªØ© 3% ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©

    const interval = setInterval(() => {
        progress += increment;

        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
            setTimeout(() => {
                hideCrystalLoading();
            }, 1000);
        }

        progressText.textContent = Math.round(progress) + '%';
    }, updateInterval);
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯
function startLimitedUserProgressAnimation() {
    const progressText = document.getElementById('limitedProgressText');

    if (!progressText) return;

    let progress = 0;
    const updateInterval = 150; // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 150ms (Ø£Ø¨Ø·Ø£ ÙˆØ£Ù‡Ø¯Ø£)
    const totalDuration = 5000; // 5 Ø«ÙˆØ§Ù†
    const progressIncrement = (100 / (totalDuration / updateInterval)); // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©

    console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯');

    const interval = setInterval(() => {
        progress += progressIncrement;

        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            console.log('âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯');

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
            setTimeout(() => {
                hideCrystalLoading();
            }, 1000);
        }

        progressText.textContent = Math.round(progress) + '%';
    }, updateInterval);
}

// Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ©
function hideCrystalLoading() {
    console.log('ğŸ”® Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ©');

    const loadingOverlay = document.getElementById('crystalLoadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.classList.add('fade-out');

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
        setTimeout(() => {
            if (loadingOverlay.parentNode) {
                loadingOverlay.parentNode.removeChild(loadingOverlay);
            }
        }, 800);
    }
}

// ==================== Ù†Ù‡Ø§ÙŠØ© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ© ====================
let contractTypeFilter = null;
let multiFilterSelectedCity = null;
let multiFilterSelectedProperties = [];
let isReverseOrder = true; // ØªØ±ØªÙŠØ¨ Ø¹ÙƒØ³ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ÙÙ„ØªØ±
let dateFilterType = '';
let dateFilterDay = '';
let dateFilterMonth = '';
let dateFilterYear = '';
let attachments = {}; // Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let cardAttachments = {}; // Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø©

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª
if (!window.attachments) {
    window.attachments = {};
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù…Ù† localStorage
try {
    const storedAttachments = JSON.parse(localStorage.getItem('propertyAttachments') || '{}');
    const storedLegacyAttachments = JSON.parse(localStorage.getItem('attachments') || '{}');

    // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ù…ØµØ§Ø¯Ø± Ù…Ø®ØªÙ„ÙØ©
    window.attachments = { ...storedLegacyAttachments, ...storedAttachments };
    attachments = window.attachments;

    console.log(`ğŸ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${Object.keys(window.attachments).length} Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† localStorage`);
} catch (error) {
    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† localStorage:', error);
    window.attachments = {};
    attachments = {};
}
let isManagementMode = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
let currentCalculationYear = new Date().getFullYear(); // Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø­Ø³Ø§Ø¨ (2025)
let selectedCityFilter = 'all'; // Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„ØªØµÙÙŠØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
let areHeaderButtonsVisible = true; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø±
let propertyManagement = {
    properties: [],
    units: []
};

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ =====

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ Ù…Ù† Ø£ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ†
function getOwnerValue(property) {
    return property.owner_name || property.owner || null;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ (ÙƒÙ„Ø§Ù‡Ù…Ø§)
function setOwnerValue(propertyData, ownerValue) {
    propertyData.owner = ownerValue;
    propertyData.owner_name = ownerValue;
    return propertyData;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ù…Ù† Ø£ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ†
function getRegistryValue(property) {
    return property.registry_number || property.real_estate_registry || null;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ (ÙƒÙ„Ø§Ù‡Ù…Ø§)
function setRegistryValue(propertyData, registryValue) {
    propertyData.registry_number = registryValue;
    propertyData.real_estate_registry = registryValue;
    return propertyData;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙÙ‚Ø·
function getRentValue(property) {
    return property.rent_value || null;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙÙ‚Ø·
function setRentValue(propertyData, rentValue) {
    propertyData.rent_value = rentValue;
    return propertyData;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ù…Ù† Ø£ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ†
function getRegistryValue(property) {
    return property.registry_number || property.real_estate_registry || null;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ (ÙƒÙ„Ø§Ù‡Ù…Ø§)
function setRegistryValue(propertyData, registryValue) {
    propertyData.registry_number = registryValue;
    propertyData.real_estate_registry = registryValue;
    return propertyData;
}

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
let developerMode = localStorage.getItem('developerMode') === 'true' || false;

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø¯Ù† Ø¨Ø¯ÙˆÙ† ÙˆØ­Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© =====

// Ù…ØµÙÙˆÙØ© Ù…Ù†ÙØµÙ„Ø© Ù„Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
let propertyDefinitions = JSON.parse(localStorage.getItem('propertyDefinitions') || '[]');

// Ù…ØµÙÙˆÙØ© Ù…Ù†ÙØµÙ„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø¶Ø§ÙØ©
let cityDefinitions = JSON.parse(localStorage.getItem('cityDefinitions') || '[]');

// ÙˆØ¸ÙŠÙØ© Ø°ÙƒÙŠØ© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
function smartToast(message, type = 'info', force = false) {
    // Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
    const importantTypes = ['error', 'warning'];
    const importantKeywords = ['Ø®Ø·Ø£', 'ÙØ´Ù„', 'Ù…Ø´ÙƒÙ„Ø©', 'ØªØ­Ø°ÙŠØ±', 'Ø­Ø°Ù', 'Ù†Ø¬Ø­ Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø§Ù„Ø­ÙØ¸'];

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†:
    // 1. Ù…ÙØ±ÙˆØ¶ Ø¥Ø¸Ù‡Ø§Ø±Ù‡ (force = true)
    // 2. Ù…Ù† Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù… (Ø®Ø·Ø£ Ø£Ùˆ ØªØ­Ø°ÙŠØ±)
    // 3. ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ù…Ù‡Ù…Ø©
    // 4. ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± Ù…ÙØ¹Ù„
    const shouldShow = force ||
                      importantTypes.includes(type) ||
                      importantKeywords.some(keyword => message.includes(keyword)) ||
                      developerMode;

    if (shouldShow) {
        showToast(message, type);
    } else {
        // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        console.log(`ğŸ“¢ ${type.toUpperCase()}: ${message}`);
    }
}

// ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±
function toggleDeveloperMode() {
    developerMode = !developerMode;
    localStorage.setItem('developerMode', developerMode.toString());
    updateDeveloperModeButton();

    if (developerMode) {
        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± - Ø³ØªØ¸Ù‡Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©', 'success');
        console.log('ğŸ”§ ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± - Ø³ØªØ¸Ù‡Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©');
    } else {
        showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± - Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·', 'info');
        console.log('ğŸ”§ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± - Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·');
    }
}

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±
function updateDeveloperModeButton() {
    const btn = document.getElementById('developerModeBtn');
    const text = document.getElementById('developerModeText');

    if (!btn || !text) return;

    if (developerMode) {
        btn.style.background = 'linear-gradient(to left, #28a745, #20c997)';
        text.textContent = 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± (Ù…ÙØ¹Ù„)';
    } else {
        btn.style.background = 'linear-gradient(to left, #6f42c1, #5a2d91)';
        text.textContent = 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±';
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ©
    console.log('ğŸ”® Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ©');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ Ù„ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø´Ø§Ø´Ø©
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            currentUser = userData.username;

            // ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const isLimitedUser = userData.role === 'limited' ||
                                (users[userData.username] && users[userData.username].role === 'limited');

            console.log(`ğŸ‘¤ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${isLimitedUser ? 'Ù…Ø­Ø¯ÙˆØ¯' : 'Ø¹Ø§Ø¯ÙŠ'}`);
        } catch (error) {
            console.warn('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ©
    showCrystalLoading();

    // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    setTimeout(() => {
        clearAllSearchFields();
    }, 100);

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø¬ÙˆØ§Ù„
    initMobileMenu();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±
    updateDeveloperModeButton();

    // ===== ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© =====
    console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø©...');
    setupStateEventHandlers();
    autoSaveState();

    // ===== Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
    console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    const restoredState = restoreAppState();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    setTimeout(() => {
        updateActiveFiltersDisplay();
        updateAllFilterButtonsState();
    }, 500);

    // ===== Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø¨ÙƒØ±Ø§Ù‹ =====
    setTimeout(() => {
        if (currentUser && currentUser !== 'guest') {
            console.log('ğŸ”‘ Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø¨ÙƒØ±Ø§Ù‹ Ù…Ù† DOMContentLoaded');
            addLogoutButton();
            updateMobileUserSection();
        }
    }, 100);

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
    restoreDataFromLocalStorage();

    // Initialize data loading (Supabase or JSON fallback)
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

    // ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù…
    setTimeout(() => {
        verifyDataPersistence();

        // ===== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
        if (restoredState) {
            setTimeout(() => {
                applyRestoredState(restoredState);
            }, 1000);
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setTimeout(() => {
            updateMobilePropertyName();
        }, 1200);

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        setTimeout(() => {
            console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
            updateMobilePropertyName();
        }, 2000);

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ø¶Ø§ÙÙŠ ÙƒÙ„ 3 Ø«ÙˆØ§Ù† Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        setInterval(() => {
            if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
                updateMobilePropertyName();
            }
        }, 3000);

        // Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø­Ø§Ù„Ø©
        autoSaveState();

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
        addStateEventListeners();

        // ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        setupLogoutButtonObserver();

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        setTimeout(() => {
            if (currentUser && currentUser !== 'guest' && !document.getElementById('logoutBtn')) {
                console.log('ğŸ”‘ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
                addLogoutButton();
                updateMobileUserSection();
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
            if (currentUser && users[currentUser] && users[currentUser].role === 'limited') {
                console.log('ğŸ”’ ØªØ·Ø¨ÙŠÙ‚ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©');
                restrictAdminButtonsForLimitedUser();
                setupAdminButtonsObserver();
            }
        }, 2000);
    }, 1000);

    initializeDataLoading()
        .then(() => {
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${properties ? properties.length : 0} Ø¹Ù‚Ø§Ø±`);

            // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦
            fixCorruptedDates();

            // Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            testDateHandling();

            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„ÙØ§Ø±ØºØ©
            recalculateAllTotals();

            initializeApp();

            // ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø±
            setTimeout(() => {
                initializeHeaderButtons();
            }, 100);

            // Initialize Supabase attachments system
            initializeAttachmentsSystem();

            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª
            setTimeout(() => {
                updateMobilePropertyName();
            }, 500);

            console.log('ğŸ‰ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
            console.log('ğŸ’° Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù… Ù…ÙØ¹Ù„Ø©: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ÙƒØªÙˆØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù† ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡ Ø£Ø¨Ø¯Ø§Ù‹');
            console.log('âš¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ Ù…ÙØ¹Ù„: Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† reload');
            console.log('ğŸ¨ ØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø¨ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ (Ø£ØµØºØ± ÙÙŠ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ + Ø£ÙƒØ¨Ø± ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ)');
            console.log('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ÙˆØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø²Ø¹Ø¬');
            console.log('ğŸ§ª Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙŠØ²Ø©: testPermanentTotal() Ø£Ùˆ testInstantUpdate()');
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);

            // Fallback to JSON if everything fails
            console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† JSON...');
            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.length} Ø¹Ù‚Ø§Ø± Ù…Ù† JSON`);
                    properties = data;
                    recalculateAllTotals();
                    initializeApp();
                    setTimeout(() => {
                        initializeHeaderButtons();
                    }, 100);
                })
                .catch(jsonError => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† JSON:', jsonError);

                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ ÙƒÙ„ Ø´ÙŠØ¡
                    console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©...');
                    createSampleData();
                    initializeApp();
                });
        });
});

// Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function createSampleData() {
    console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

    properties = [
        {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'SAMPLE_001',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ 1',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ 1',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'CONTRACT_001',
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': '50000',
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': '150',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '01/01/2024',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '31/12/2024',
            'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': '57500',
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø¶Ø±ÙŠØ¨ÙŠ',
            'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·': 3,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': '01/01/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': 19166.67,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': '01/05/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': 19166.67,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«': '01/09/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«': 19166.66,
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': '123456789',
            'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': '500',
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': 'REG-001-2024'
        },
        {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'SAMPLE_002',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø¬Ø¯Ø©',
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ 2',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ 2',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'CONTRACT_002',
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': '40000',
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': '120',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '01/02/2024',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '31/01/2025',
            'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': '46000',
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø¶Ø±ÙŠØ¨ÙŠ',
            'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·': 2,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': '01/02/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': 23000,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': '01/08/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': 23000,
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': '987654321',
            'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': '300',
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': 'REG-002-2024'
        },
        {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'SAMPLE_003',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø¯Ù…Ø§Ù…',
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ 3',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ 3',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'CONTRACT_003',
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': '60000',
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': '200',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '01/03/2024',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '28/02/2025',
            'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': '60000',
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ',
            'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·': 4,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': '01/03/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': 15000,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': '01/06/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': 15000,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«': '01/09/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«': 15000,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹': '01/12/2024',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹': 15000,
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': '456789123',
            'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': '800',
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': 'REG-003-2024'
        }
    ];

    console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${properties.length} Ø¹Ù‚Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ`);
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
function updateTotalStats() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');

    if (!properties || properties.length === 0) {
        console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
        return;
    }

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    renderTotals(properties);

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø©
    renderMobileTotals(properties);

    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
}

// ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù†
function initializeCityButtons() {
    console.log('ğŸ”„ ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù†...');
    initCountryButtons();
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø«
function initializeSearch() {
    console.log('ğŸ”„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø«...');
    initGlobalSearch();
    initPropertySearch();
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØµÙÙŠØ©
function initializeFilters() {
    console.log('ğŸ”„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØµÙÙŠØ©...');
    initStatusFilter();
    initDateFilter();
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø¬ÙˆØ§Ù„
function initMobileMenu() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileMenuClose = document.getElementById('mobileMenuClose');
    const menuOverlay = document.getElementById('menuOverlay');
    
    // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    mobileMenuBtn.addEventListener('click', function() {
        mobileMenu.classList.add('active');
        menuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const totalContainer = document.getElementById('totalContainer');
        if (totalContainer) {
            totalContainer.style.display = 'none';
            console.log('ğŸ“Š ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø·
        cleanMenuOnly();
    });
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    mobileMenuClose.addEventListener('click', function() {
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const totalContainer = document.getElementById('totalContainer');
        if (totalContainer) {
            totalContainer.style.display = '';
            console.log('ğŸ“Š ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
        }
    });
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
    menuOverlay.addEventListener('click', function() {
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const totalContainer = document.getElementById('totalContainer');
        if (totalContainer) {
            totalContainer.style.display = '';
            console.log('ğŸ“Š ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø®Ù„ÙÙŠØ©)');
        }
    });
    
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    document.getElementById('mobile-country-btn').addEventListener('click', function() {
        showCountrySelection();
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    document.getElementById('mobile-property-btn').addEventListener('click', function() {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ sidebar Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        toggleSidebar();
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    document.getElementById('mobile-filter-btn').addEventListener('click', function() {
        showStatusFilter();
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    document.getElementById('mobile-view-btn').addEventListener('click', function() {
        showViewToggle();
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    document.getElementById('mobile-contract-type-btn').addEventListener('click', function() {
        document.getElementById('mobileMenu').classList.remove('active');
        document.getElementById('menuOverlay').classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('contractTypeFilterBtn').click();
    });

    document.getElementById('mobile-property-type-btn').addEventListener('click', function() {
        document.getElementById('mobileMenu').classList.remove('active');
        document.getElementById('menuOverlay').classList.remove('active');
        document.body.style.overflow = '';
        showPropertyTypeFilter();
    });
    
    document.getElementById('mobile-date-filter-btn').addEventListener('click', function() {
  showMonthFilterModal();
  document.getElementById('mobileMenu').classList.remove('active');
  document.getElementById('menuOverlay').classList.remove('active');
  document.body.style.overflow = '';
});

    document.getElementById('mobile-property-manager-btn').addEventListener('click', function() {
        showPropertyManager();
        document.getElementById('mobileMenu').classList.remove('active');
        document.getElementById('menuOverlay').classList.remove('active');
        document.body.style.overflow = '';
    });

    // Ø²Ø± ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
    document.getElementById('mobile-owner-filter-btn').addEventListener('click', function() {
        showOwnerFilter();
        document.getElementById('mobileMenu').classList.remove('active');
        document.getElementById('menuOverlay').classList.remove('active');
        document.body.style.overflow = '';
    });

    // Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
    document.getElementById('mobile-property-statistics-print-btn').addEventListener('click', function() {
        showPropertyStatisticsPrintModal();
        document.getElementById('mobileMenu').classList.remove('active');
        document.getElementById('menuOverlay').classList.remove('active');
        document.body.style.overflow = '';
    });
}

// Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
function showCountrySelection() {
    const countries = getUniqueCountries();
    let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box cities-modal" style="max-width: 500px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-map-marker-alt" style="color: #28a745;"></i>
                Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                <span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${countries.length}</span>
            </h3>
            <div class="country-selection" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">`;

    countries.forEach(country => {
        const isActive = currentCountry === country;
        const activeClass = isActive ? 'active' : '';
        const activeStyle = isActive ? 'background: #28a745; color: white;' : '';

        html += `
            <button onclick="selectCountry('${country}'); closeCitiesModal();"
                    class="country-btn ${activeClass}"
                    style="width: 100%; padding: 12px; margin: 4px 0; border-radius: 8px; cursor: pointer;
                           transition: all 0.3s ease; border: 1px solid #e9ecef; ${activeStyle}
                           display: flex; align-items: center; justify-content: space-between; background: ${isActive ? '#28a745' : 'white'}; min-height: 50px;">
                <span style="font-weight: 700; font-size: 1.3rem;">${country}</span>
                ${isActive ? '<i class="fas fa-check" style="color: white;"></i>' : '<i class="fas fa-map-marker-alt" style="color: #28a745;"></i>'}
            </button>
        `;
    });

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closeCitiesModal();" class="modal-action-btn close-btn cities-close-btn" id="citiesCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù† - Ø¥ØºÙ„Ø§Ù‚');
                    closeCitiesModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù†');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù†
function closeCitiesModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù†...');
    const modal = document.querySelector('.cities-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù†');
        }
    }
    if (closeBtn) {
        closeBtn.style.padding = '15px';
        closeBtn.style.margin = '-15px';
    }
}

// Ø¹Ø±Ø¶ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
function showStatusFilter() {
    // Ø£Ø¶Ù "Ø§Ù„ÙØ§Ø±Øº" Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª
    const statuses = ['ÙØ¹Ø§Ù„', 'Ù…Ù†ØªÙ‡Ù‰', 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ', 'ÙØ§Ø±Øº'];
    let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box status-filter-modal" style="max-width: 500px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-filter" style="color: #ffc107;"></i>
                ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
                <span class="badge" style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${statuses.length + 1}</span>
            </h3>
            <div class="status-filter" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">`;

    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "Ø§Ù„ÙƒÙ„"
    const isAllActive = filterStatus === null;
    html += `
        <button onclick="if(filterStatus) { toggleStatusFilter(filterStatus); } closeStatusFilterModal();"
                class="status-btn ${isAllActive ? 'active' : ''}"
                style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                       transition: all 0.3s ease; border: 1px solid #e9ecef;
                       background: ${isAllActive ? '#ffc107' : 'white'}; color: ${isAllActive ? '#212529' : '#495057'};
                       display: flex; align-items: center; justify-content: space-between;">
            <span style="font-weight: 500;">Ø§Ù„ÙƒÙ„</span>
            ${isAllActive ? '<i class="fas fa-check" style="color: #212529;"></i>' : '<i class="fas fa-list" style="color: #ffc107;"></i>'}
        </button>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª
    statuses.forEach(status => {
        const isActive = filterStatus === status;
        const statusColors = {
            'ÙØ¹Ø§Ù„': '#28a745',
            'Ù…Ù†ØªÙ‡Ù‰': '#dc3545',
            'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ': '#fd7e14',
            'ÙØ§Ø±Øº': '#6c757d'
        };
        const statusColor = statusColors[status] || '#007bff';

        html += `
            <button onclick="toggleStatusFilter('${status}'); closeStatusFilterModal();"
                    class="status-btn ${isActive ? 'active' : ''}"
                    style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                           transition: all 0.3s ease; border: 1px solid #e9ecef;
                           background: ${isActive ? statusColor : 'white'}; color: ${isActive ? 'white' : '#495057'};
                           display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: 500;">${status}</span>
                ${isActive ? '<i class="fas fa-check" style="color: white;"></i>' : `<i class="fas fa-circle" style="color: ${statusColor};"></i>`}
            </button>
        `;
    });

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closeStatusFilterModal();" class="modal-action-btn close-btn status-filter-close-btn" id="statusFilterCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© - Ø¥ØºÙ„Ø§Ù‚');
                    closeStatusFilterModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
function closeStatusFilterModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©...');
    const modal = document.querySelector('.status-filter-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©');
        }
    }
    
    // ØªÙˆØ³ÙŠØ¹ Ù…Ù†Ø·Ù‚Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø­ÙˆÙ„ X
    const closeBtn = document.querySelector('.modal-overlay:last-child .close-modal');
    if (closeBtn) {
        closeBtn.style.padding = '15px';
        closeBtn.style.margin = '-15px';
    }
}

// Ø¹Ø±Ø¶ ØªØ¨Ø¯ÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶
function showViewToggle() {
    let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box view-toggle-modal" style="max-width: 400px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-eye" style="color: #6f42c1;"></i>
                Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶
                <span class="badge" style="background: #6f42c1; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">2</span>
            </h3>
            <div class="view-selection" style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">`;

    // Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const isTableActive = currentView === 'table';
    html += `
        <button onclick="toggleView('table'); closeViewToggleModal();"
                class="view-btn ${isTableActive ? 'active' : ''}"
                style="width: 100%; padding: 15px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                       transition: all 0.3s ease; border: 1px solid #e9ecef;
                       background: ${isTableActive ? '#6f42c1' : 'white'}; color: ${isTableActive ? 'white' : '#495057'};
                       display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-table" style="color: ${isTableActive ? 'white' : '#6f42c1'};"></i>
                <span style="font-weight: 500;">Ø¬Ø¯ÙˆÙ„</span>
            </div>
            ${isTableActive ? '<i class="fas fa-check" style="color: white;"></i>' : ''}
        </button>
    `;

    // Ø®ÙŠØ§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    const isCardsActive = currentView === 'cards';
    html += `
        <button onclick="toggleView('cards'); closeViewToggleModal();"
                class="view-btn ${isCardsActive ? 'active' : ''}"
                style="width: 100%; padding: 15px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                       transition: all 0.3s ease; border: 1px solid #e9ecef;
                       background: ${isCardsActive ? '#6f42c1' : 'white'}; color: ${isCardsActive ? 'white' : '#495057'};
                       display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-th-large" style="color: ${isCardsActive ? 'white' : '#6f42c1'};"></i>
                <span style="font-weight: 500;">Ø¨Ø·Ø§Ù‚Ø§Øª</span>
            </div>
            ${isCardsActive ? '<i class="fas fa-check" style="color: white;"></i>' : ''}
        </button>
    `;

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closeViewToggleModal();" class="modal-action-btn close-btn view-toggle-close-btn" id="viewToggleCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶ - Ø¥ØºÙ„Ø§Ù‚');
                    closeViewToggleModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶
function closeViewToggleModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶...');
    const modal = document.querySelector('.view-toggle-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶');
        }
    }
    if (closeBtn) {
        closeBtn.style.padding = '15px';
        closeBtn.style.margin = '-15px';
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function initializeApp() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');

    // ğŸ”§ Ø¥Ø¶Ø§ÙØ©: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹
    if (typeof loadSavedCities === 'function') {
        loadSavedCities();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨
    loadSortOrderSetting();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!properties || properties.length === 0) {
        console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ initializeApp');

        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
        const localData = localStorage.getItem('properties');
        if (localData) {
            try {
                properties = JSON.parse(localData);
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${properties.length} Ø¹Ù‚Ø§Ø± Ù…Ù† localStorage`);
            } catch (e) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª localStorage:', e);
                properties = [];
            }
        }

        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        if (!properties || properties.length === 0) {
            console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©...');
            createSampleData();
        }
    }

    console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${properties ? properties.length : 0}`);

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    properties.forEach(property => {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£Ùˆ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙØ§Ø±ØºØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ† ÙØ§Ø±ØºØªÙŠÙ†
        if (!property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || !property['Ø§Ù„Ù…Ø§Ù„Ùƒ']) {
            property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = '';
            property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = '';
            property['isInstallmentEnded'] = false;
            return;
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙØ§Ø±ØºØ©
        if (!property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] || !property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©']) {
            const today = new Date();
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·
            const installmentEndDateStr = property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·Ø§Ù„Ø«Ø§Ù†ÙŠ'];
            const endDateStr = property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'];
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ©ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ©
            if (!endDateStr && !installmentEndDateStr) {
                property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = '';
                property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = '';
                property['isInstallmentEnded'] = false;
                return;
            }
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (installmentEndDateStr) {
                // Ø¯Ø¹Ù… Ø§Ù„ØµÙŠØº dd/mm/yyyy Ø£Ùˆ dd-mm-yyyy
                const installmentParts = installmentEndDateStr.split(/[\/\-]/);
                if (installmentParts.length === 3) {
                    // ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† ØªØ§Ø±ÙŠØ®
                    let installmentDay, installmentMonth, installmentYear;
                    
                    // ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‚Ø¯ ÙŠÙƒÙˆÙ† yyyy-mm-dd Ø£Ùˆ dd/mm/yyyy)
                    if (installmentEndDateStr.includes('-') && !isNaN(installmentEndDateStr.split('-')[0]) && installmentEndDateStr.split('-')[0].length === 4) {
                        // ØµÙŠØºØ© yyyy-mm-dd
                        [installmentYear, installmentMonth, installmentDay] = installmentParts.map(Number);
                    } else {
                        // ØµÙŠØºØ© dd/mm/yyyy Ø£Ùˆ dd-mm-yyyy
                        [installmentDay, installmentMonth, installmentYear] = installmentParts.map(Number);
                    }
                    
                    const installmentEndDate = new Date(installmentYear, installmentMonth - 1, installmentDay);
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙˆØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·
                    const installmentDiffDays = Math.floor((installmentEndDate - today) / (1000 * 60 * 60 * 24));
                    
                    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯
                    let contractEndDate = null;
                    if (endDateStr) {
                        const contractParts = endDateStr.split(/[\/\-]/);
                        if (contractParts.length === 3) {
                            const [contractDay, contractMonth, contractYear] = contractParts.map(Number);
                            contractEndDate = new Date(contractYear, contractMonth - 1, contractDay);
                        }
                    }
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø£Ùˆ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ù„Ù„Ø¹Ù‚Ø¯
                    if (!contractEndDate || installmentEndDate < contractEndDate) {
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·
                        if (installmentDiffDays < 0) {
                            // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ù‚Ø¯ Ù„Ø§ ÙŠØ²Ø§Ù„ ÙØ¹Ø§Ù„Ø§Ù‹
                            if (!contractEndDate || contractEndDate > today) {
                                property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = 'ÙØ¹Ø§Ù„';
                                property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = 'Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù…Ù†ØªÙ‡ÙŠØ© ÙˆØ§Ù„Ø¹Ù‚Ø¯ ÙØ¹Ø§Ù„';
                                property['isInstallmentEnded'] = true;
                                return;
                            } else {
                                property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = 'Ù…Ù†ØªÙ‡Ù‰';
                                property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = `Ø§Ù„Ù‚Ø³Ø· Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° ${Math.abs(installmentDiffDays)} ÙŠÙˆÙ… ÙˆØ§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ù‚Ø¯`;
                                property['isInstallmentEnded'] = false;
                                return;
                            }
                        } else if (installmentDiffDays <= 60) {
                            property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ';
                            property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = `Ø§Ù„Ù‚Ø³Ø· Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯ ${installmentDiffDays} ÙŠÙˆÙ…`;
                            property['isInstallmentEnded'] = false;
                            return;
                        }
                    }
                }
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ù‚Ø³Ø· Ø£Ùˆ ÙƒØ§Ù† ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·
            // Ø§Ø³ØªØ®Ø¯Ù… ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯
            if (endDateStr) {
                // Ø¯Ø¹Ù… Ø§Ù„ØµÙŠØº dd/mm/yyyy Ø£Ùˆ dd-mm-yyyy
                const parts = endDateStr.split(/[\/\-]/);
                if (parts.length !== 3) {
                    property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = '';
                    property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = '';
                    property['isInstallmentEnded'] = false;
                    return;
                }
                // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙŠØºØ©
                const [day, month, year] = parts.map(Number);
                const endDate = new Date(year, month - 1, day);

                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…
                const diffDays = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
                // Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¨Ø´Ù‡Ø±ÙŠÙ† = 60 ÙŠÙˆÙ…
                if (diffDays < 0) {
                    property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = 'Ù…Ù†ØªÙ‡Ù‰';
                    property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = `Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° ${Math.abs(diffDays)} ÙŠÙˆÙ…`;
                    property['isInstallmentEnded'] = false;
                } else if (diffDays <= 60) {
                    property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ';
                    property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = `Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯ ${diffDays} ÙŠÙˆÙ…`;
                    property['isInstallmentEnded'] = false;
                } else {
                    property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] = 'ÙØ¹Ø§Ù„';
                    property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'] = 'ÙØ¹Ø§Ù„';
                    property['isInstallmentEnded'] = false;
                }
            }
        }
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©Ø§Ù†
    initCountryButtons();
    
    // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    initPropertyList();
    
    // ØªÙ‡ÙŠØ¦Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
    initStatusFilter();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…
    initGlobalSearch();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    initAutoPropertySearch();

    // ØªÙ‡ÙŠØ¦Ø© ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
    initDateFilter();

    // ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù†
    initializeEnhancedSearch();

    // Ø¶Ù…Ø§Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
    ensureSearchEnhancements();

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    updateTotalStats();

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù€ sidebar
    initializeSidebar();

    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ±
    updateExportButtonsText();

    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');

    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø±
    const sidebar = document.getElementById('sidebar');
    const hideBtn = document.querySelector('.hide-sidebar-btn');
    if (!hideBtn) {
        const btn = document.createElement('button');
        btn.className = 'hide-sidebar-btn';
        btn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
        btn.onclick = function() {
            toggleSidebar();
        };
        sidebar.appendChild(btn);
    }

    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
    setTimeout(() => {
        if (currentUser && currentUser !== 'guest') {
            console.log('ğŸ”‘ Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† initializeApp');
            addLogoutButton();
            updateMobileUserSection();
        }
    }, 100);

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    setTimeout(() => {
        if (currentUser && currentUser !== 'guest' && !document.getElementById('logoutBtn')) {
            console.log('ğŸ”‘ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
            addLogoutButton();
            updateMobileUserSection();
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        if (currentUser && users[currentUser] && users[currentUser].role === 'limited') {
            console.log('ğŸ”’ ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©');
            restrictAdminButtonsForLimitedUser();
        }
    }, 1000);

    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ© Ù…Ù† Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„ÙØ±ÙŠØ¯Ø© (Ù…Ø­Ø³Ù† Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ©)
function getUniqueCountries() {
    const countries = new Set();

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ù† Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    properties.forEach(property => {
        if (property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©) {
            countries.add(property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©);
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ© (Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ§Ù‹)
    cityDefinitions.forEach(city => {
        countries.add(city);
    });

    return ['Ø§Ù„ÙƒÙ„', ...Array.from(countries).sort()];
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© (Ù…Ø­Ø³Ù† Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙØ©)
function getUniqueProperties() {
    const uniqueProperties = new Set();

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    properties.forEach(property => {
        if (property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
            uniqueProperties.add(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙØ© (Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ§Ù‹)
    propertyDefinitions.forEach(propDef => {
        uniqueProperties.add(propDef.name);
    });

    return Array.from(uniqueProperties).sort();
}

// ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©Ø§Ù†
function initCountryButtons() {
    const countries = getUniqueCountries();
    const container = document.getElementById('countryButtons');
    if (!container) {
        console.warn('âš ï¸ Ø¹Ù†ØµØ± countryButtons ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        return;
    }
    container.innerHTML = '';
    
    countries.forEach(country => {
        const button = document.createElement('button');
        button.textContent = country;
        button.onclick = () => selectCountry(country === 'Ø§Ù„ÙƒÙ„' ? null : country);
        if ((currentCountry === null && country === 'Ø§Ù„ÙƒÙ„') || currentCountry === country) {
            button.classList.add('active');
        }
        container.appendChild(button);
    });
}

// Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨Øª
let fixedPropertyOrder = JSON.parse(localStorage.getItem('fixedPropertyOrder')) || [];

// Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
let currentPropertyTypeFilter = null; // null = Ø§Ù„ÙƒÙ„ØŒ 'buildings' = Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠØŒ 'lands' = Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ

// ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¹ ØªØ±ØªÙŠØ¨ Ø«Ø§Ø¨Øª
function initPropertyList(selectedCountry = null) {
    // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù† Ù…ØµØ¯Ø±ÙŠÙ†: properties Ùˆ propertyDefinitions
    const allPropertyNames = new Set();

    // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (properties)
    let filteredProperties = properties;
    if (selectedCountry) {
        filteredProperties = properties.filter(property => property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === selectedCountry);
    }
    filteredProperties.forEach(property => {
        if (property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] && property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].trim() !== '') {
            allPropertyNames.add(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
        }
    });

    // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª (propertyDefinitions) âœ…
    let filteredDefinitions = propertyDefinitions || [];
    if (selectedCountry) {
        filteredDefinitions = propertyDefinitions.filter(propDef => propDef.city === selectedCountry);
    }
    filteredDefinitions.forEach(propDef => {
        if (propDef.name && propDef.name.trim() !== '') {
            allPropertyNames.add(propDef.name);
        }
    });

    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
    const propertyNames = Array.from(allPropertyNames);

    console.log(`ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© "${selectedCountry || 'Ø§Ù„ÙƒÙ„'}": ${propertyNames.length} Ø¹Ù‚Ø§Ø±`);
    console.log('ğŸ“Š Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', {
        fromProperties: filteredProperties.length,
        fromDefinitions: filteredDefinitions.length,
        total: propertyNames.length
    });

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ø§Ø¨Øª Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const sortedPropertyNames = applySortedPropertyOrder(propertyNames, selectedCountry);

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù€ sidebar
    const container = document.getElementById('propertyList');
    if (!container) {
        console.warn('âš ï¸ Ø¹Ù†ØµØ± propertyList ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        return;
    }
    container.innerHTML = '';

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
    updatePropertyTypeFiltersState();

    // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹ (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©)
    let displayedPropertyNames = sortedPropertyNames;
    if (currentPropertyTypeFilter) {
        displayedPropertyNames = filterPropertiesByTypeLogic(sortedPropertyNames, currentPropertyTypeFilter, selectedCountry);
        console.log(`ğŸ—ï¸ ÙÙ„ØªØ±Ø© ${currentPropertyTypeFilter === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'} ÙÙŠ ${selectedCountry || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†'}: ${displayedPropertyNames.length} Ø¹Ù‚Ø§Ø±`);
    }

    displayedPropertyNames.forEach(propertyName => {
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙØ©
        if (!propertyName || propertyName.trim() === '') return;
        const div = document.createElement('div');
        div.textContent = propertyName;
        div.onclick = () => selectProperty(propertyName);
        if (currentProperty === propertyName) {
            div.classList.add('active');
        }
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø­Ø±ÙƒÙŠ Ù„Ù„Ø¸Ù‡ÙˆØ±
        div.style.animation = 'slideIn 0.3s ease-out forwards';
        container.appendChild(div);
    });

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ù‚Ø§Ø±Ø§Øª
    if (displayedPropertyNames.filter(name => name && name.trim() !== '').length === 0) {
        const noProperties = document.createElement('div');
        noProperties.className = 'no-properties';
        const filterText = currentPropertyTypeFilter === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' :
                          currentPropertyTypeFilter === 'lands' ? 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ' : 'Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª';
        noProperties.textContent = `Ù„Ø§ ØªÙˆØ¬Ø¯ ${filterText} ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©`;
        noProperties.style.textAlign = 'center';
        noProperties.style.padding = '1rem';
        noProperties.style.color = '#666';
        container.appendChild(noProperties);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
function getSelectedPropertyType() {
    if (!currentProperty) return null;

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const propertyData = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentProperty);
    if (propertyData) {
        return propertyData['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'];
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const propDef = propertyDefinitions?.find(def => def.name === currentProperty);
    if (propDef) {
        return propDef.type;
    }

    return null;
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø¹ ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹
function isPropertyCompatibleWithTypeFilter(propertyType, filterType) {
    if (!propertyType) return true; // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¹Ø±Ù Ø§Ù„Ù†ÙˆØ¹ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ Ù…ØªÙˆØ§ÙÙ‚

    const isLandType = propertyType === 'Ø£Ø±Ø¶';

    if (filterType === 'lands') {
        return isLandType;
    } else if (filterType === 'buildings') {
        return !isLandType;
    }

    return true;
}

// Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
function filterPropertiesByType(filterType) {
    console.log(`ğŸ—ï¸ ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${filterType}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    if (currentProperty) {
        const selectedPropertyType = getSelectedPropertyType();
        const isCompatible = isPropertyCompatibleWithTypeFilter(selectedPropertyType, filterType);

        if (!isCompatible) {
            console.log(`âš ï¸ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ "${currentProperty}" Ù…Ù† Ù†ÙˆØ¹ "${selectedPropertyType}" ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙÙ„ØªØ± ${filterType === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'}`);
            console.log(`ğŸ”„ Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...`);
            currentProperty = null;
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
    currentPropertyTypeFilter = filterType;
    console.log(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ±: ${filterType === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'}`);

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ÙØ³ Ø§Ù„ÙÙ„ØªØ±ØŒ Ø£Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚Ù‡ (Ù„Ø§ Ù†Ù„ØºÙŠÙ‡)
    if (currentPropertyTypeFilter === filterType) {
        console.log(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± ${filterType === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'}`);
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    initPropertyList(currentCountry);

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    updatePropertyTypeFiltersState();

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª (ÙÙŠ Ø­Ø§Ù„Ø© ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±)
    updateMobilePropertyName();

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
    saveAppState();
}

// Ø¯Ø§Ù„Ø© Ù…Ù†Ø·Ù‚ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
function filterPropertiesByTypeLogic(propertyNames, filterType, selectedCountry = null) {
    if (!filterType) return propertyNames;

    const filteredProperties = [];

    propertyNames.forEach(propertyName => {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ø¹Ø±ÙØ© Ù†ÙˆØ¹Ù‡ (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
        let propertyData = properties.find(p => {
            const matchesName = p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName;
            const matchesCity = selectedCountry ? p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === selectedCountry : true;
            return matchesName && matchesCity;
        });

        if (propertyData) {
            const propertyType = propertyData['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'];
            // ØªØ­Ø¯ÙŠØ«: "Ø­ÙˆØ´" Ø£ØµØ¨Ø­ ÙŠÙØ¹ØªØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆÙ„ÙŠØ³ Ù…Ù† Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
            const isLandType = propertyType === 'Ø£Ø±Ø¶';

            if (filterType === 'lands' && isLandType) {
                filteredProperties.push(propertyName);
            } else if (filterType === 'buildings' && !isLandType) {
                filteredProperties.push(propertyName);
            }
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† propertyDefinitions (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
            const propDef = propertyDefinitions?.find(def => {
                const matchesName = def.name === propertyName;
                const matchesCity = selectedCountry ? def.city === selectedCountry : true;
                return matchesName && matchesCity;
            });

            if (propDef) {
                const propertyType = propDef.type;
                // ØªØ­Ø¯ÙŠØ«: "Ø­ÙˆØ´" Ø£ØµØ¨Ø­ ÙŠÙØ¹ØªØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆÙ„ÙŠØ³ Ù…Ù† Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
                const isLandType = propertyType === 'Ø£Ø±Ø¶';

                if (filterType === 'lands' && isLandType) {
                    filteredProperties.push(propertyName);
                } else if (filterType === 'buildings' && !isLandType) {
                    filteredProperties.push(propertyName);
                }
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†ÙˆØ¹ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ Ù…Ø¨Ù†Ù‰ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©)
                if (filterType === 'buildings') {
                    filteredProperties.push(propertyName);
                }
            }
        }
    });

    console.log(`ğŸ“Š ÙÙ„ØªØ±Ø© ${filterType}: ${filteredProperties.length} Ù…Ù† Ø£ØµÙ„ ${propertyNames.length} Ø¹Ù‚Ø§Ø±`);
    return filteredProperties;
}

// Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
function filterMobilePropertiesByType(filterType) {
    console.log(`ğŸ“± ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: ${filterType}`);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
    currentPropertyTypeFilter = filterType;
    console.log(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ±: ${filterType === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'}`);

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ÙØ³ Ø§Ù„ÙÙ„ØªØ±ØŒ Ø£Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚Ù‡ (Ù„Ø§ Ù†Ù„ØºÙŠÙ‡)
    if (currentPropertyTypeFilter === filterType) {
        console.log(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± ${filterType === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'} ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„`);
    }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    showMobilePropertiesModal();

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹
    initPropertyList(currentCountry);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
function resetPropertyTypeFilter() {
    currentPropertyTypeFilter = null;
    console.log('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±');
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
function forceShowPropertyTypeFilters() {
    console.log('ğŸ”§ Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±...');

    const container = document.getElementById('propertyList');
    if (!container) {
        console.error('âŒ Ø¹Ù†ØµØ± propertyList ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    let existingFilters = container.querySelector('.property-type-filters');
    if (existingFilters) {
        console.log('ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ„Ø§ØªØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§');
        existingFilters.remove();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ù† Ø¬Ø¯ÙŠØ¯
    const filtersContainer = document.createElement('div');
    filtersContainer.className = 'property-type-filters';
    filtersContainer.style.cssText = `
        display: flex !important;
        gap: 8px !important;
        margin-bottom: 15px !important;
        padding: 0 10px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        background: #f8f9fa !important;
        border-radius: 8px !important;
        padding: 10px !important;
    `;

    // Ø²Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
    const buildingsBtn = document.createElement('button');
    buildingsBtn.innerHTML = '<i class="fas fa-building"></i> Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ';
    buildingsBtn.className = `property-filter-btn buildings-filter ${currentPropertyTypeFilter === 'buildings' ? 'active' : ''}`;
    buildingsBtn.onclick = () => filterPropertiesByType('buildings');

    // Ø²Ø± Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
    const landsBtn = document.createElement('button');
    landsBtn.innerHTML = '<i class="fas fa-mountain"></i> Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ';
    landsBtn.className = `property-filter-btn lands-filter ${currentPropertyTypeFilter === 'lands' ? 'active' : ''}`;
    landsBtn.onclick = () => filterPropertiesByType('lands');

    // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ (Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±)
    const allBtn = document.createElement('button');
    allBtn.innerHTML = '<i class="fas fa-list"></i> Ø§Ù„ÙƒÙ„';
    allBtn.className = `property-filter-btn all-filter ${!currentPropertyTypeFilter ? 'active' : ''}`;
    allBtn.onclick = () => {
        currentPropertyTypeFilter = null;
        console.log('ğŸ”„ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± - Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
        initPropertyList(currentCountry);
        updatePropertyTypeFiltersState();
        renderData();
    };

    filtersContainer.appendChild(allBtn);
    filtersContainer.appendChild(buildingsBtn);
    filtersContainer.appendChild(landsBtn);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    container.insertBefore(filtersContainer, container.firstChild);

    console.log('âœ… ØªÙ… Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±');
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
if (typeof window !== 'undefined') {
    window.forceShowPropertyTypeFilters = forceShowPropertyTypeFilters;
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
function updatePropertyTypeFiltersState() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±...');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    const buildingsBtn = document.querySelector('.property-filter-btn.buildings-filter');
    const landsBtn = document.querySelector('.property-filter-btn.lands-filter');

    if (buildingsBtn) {
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
        const isActive = currentPropertyTypeFilter === 'buildings';
        if (isActive) {
            buildingsBtn.classList.add('active');
        } else {
            buildingsBtn.classList.remove('active');
        }
        console.log('ğŸ¢ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ:', isActive ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·');
    } else {
        console.warn('âš ï¸ Ø²Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    }

    if (landsBtn) {
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
        const isActive = currentPropertyTypeFilter === 'lands';
        if (isActive) {
            landsBtn.classList.add('active');
        } else {
            landsBtn.classList.remove('active');
        }
        console.log('ğŸ”ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ:', isActive ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·');
    } else {
        console.warn('âš ï¸ Ø²Ø± Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    }

    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±');
}

// Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ø§Ø¨Øª Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function applySortedPropertyOrder(propertyNames, selectedCountry = null) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© (Ø£Ùˆ "Ø§Ù„ÙƒÙ„" Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ù…)
    const cityKey = selectedCountry || 'Ø§Ù„ÙƒÙ„';

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ±ØªÙŠØ¨ Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    if (!fixedPropertyOrder[cityKey]) {
        fixedPropertyOrder[cityKey] = [];
    }

    const savedOrder = fixedPropertyOrder[cityKey];
    const newProperties = [];
    const sortedProperties = [];

    // ÙØµÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    propertyNames.forEach(propertyName => {
        if (propertyName && propertyName.trim() !== '') {
            if (savedOrder.includes(propertyName)) {
                // Ø¹Ù‚Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸
                sortedProperties.push(propertyName);
            } else {
                // Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯
                newProperties.push(propertyName);
            }
        }
    });

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸
    sortedProperties.sort((a, b) => {
        const indexA = savedOrder.indexOf(a);
        const indexB = savedOrder.indexOf(b);
        return indexA - indexB;
    });

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹
    newProperties.sort();

    // Ø¯Ù…Ø¬ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…: Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const finalOrder = [...sortedProperties, ...newProperties];

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸
    fixedPropertyOrder[cityKey] = finalOrder;
    localStorage.setItem('fixedPropertyOrder', JSON.stringify(fixedPropertyOrder));

    console.log(`ğŸ“‹ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù…Ø¯ÙŠÙ†Ø© "${cityKey}":`, finalOrder);

    return finalOrder;
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹
function reorderProperties(cityKey, newOrder) {
    if (!fixedPropertyOrder[cityKey]) {
        fixedPropertyOrder[cityKey] = [];
    }

    fixedPropertyOrder[cityKey] = newOrder;
    localStorage.setItem('fixedPropertyOrder', JSON.stringify(fixedPropertyOrder));

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    initPropertyList(cityKey === 'Ø§Ù„ÙƒÙ„' ? null : cityKey);

    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù…Ø¯ÙŠÙ†Ø© "${cityKey}"`);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function resetPropertyOrder(cityKey = null) {
    if (cityKey) {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¯ÙŠÙ†Ø© Ù…Ø­Ø¯Ø¯Ø©
        delete fixedPropertyOrder[cityKey];
    } else {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†
        fixedPropertyOrder = {};
    }

    localStorage.setItem('fixedPropertyOrder', JSON.stringify(fixedPropertyOrder));

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    initPropertyList(currentCountry);

    console.log(`ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª${cityKey ? ` Ù„Ù…Ø¯ÙŠÙ†Ø© "${cityKey}"` : ' Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†'}`);
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function showPropertyOrderManager() {
    const cityKey = currentCountry || 'Ø§Ù„ÙƒÙ„';
    const currentOrder = fixedPropertyOrder[cityKey] || [];

    // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ù…ØµØ¯Ø±ÙŠÙ†
    const allPropertyNames = new Set();

    // 1. Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (properties)
    let filteredProperties = properties;
    if (currentCountry) {
        filteredProperties = properties.filter(property => property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === currentCountry);
    }
    filteredProperties.forEach(property => {
        if (property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] && property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].trim() !== '') {
            allPropertyNames.add(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
        }
    });

    // 2. Ù…Ù† Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª (propertyDefinitions) âœ…
    let filteredDefinitions = propertyDefinitions || [];
    if (currentCountry) {
        filteredDefinitions = propertyDefinitions.filter(propDef => propDef.city === currentCountry);
    }
    filteredDefinitions.forEach(propDef => {
        if (propDef.name && propDef.name.trim() !== '') {
            allPropertyNames.add(propDef.name);
        }
    });

    const allProperties = Array.from(allPropertyNames);

    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box" style="max-width: 600px;">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <h3><i class="fas fa-sort"></i> Ø¥Ø¯Ø§Ø±Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h3>
            <p style="color: #666; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i>
                Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨Ù‡Ø§. Ø§Ù„ØªØ±ØªÙŠØ¨ Ø³ÙŠØ¨Ù‚Ù‰ Ø«Ø§Ø¨ØªØ§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
            </p>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> ${cityKey}
                <br><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:</strong> ${allProperties.length}
            </div>

            <div id="sortablePropertyList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
    `;

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const displayOrder = currentOrder.length > 0 ? currentOrder : allProperties.sort();
    displayOrder.forEach((propertyName, index) => {
        if (propertyName && propertyName.trim() !== '') {
            html += `
                <div class="sortable-property-item" data-property="${propertyName}" style="
                    background: white;
                    border: 1px solid #e9ecef;
                    border-radius: 6px;
                    padding: 12px;
                    margin: 8px 0;
                    cursor: move;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    transition: all 0.2s ease;
                ">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-grip-vertical" style="color: #6c757d;"></i>
                        <span style="font-weight: 500;">${index + 1}.</span>
                        <span>${propertyName}</span>
                    </div>
                    <i class="fas fa-building" style="color: #007bff;"></i>
                </div>
            `;
        }
    });

    html += `
            </div>

            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="savePropertyOrder()" class="modal-action-btn print-btn" style="flex: 1;">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨
                </button>
                <button onclick="resetPropertyOrder('${cityKey}')" class="modal-action-btn" style="flex: 1; background: #ffc107;">
                    <i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                </button>
                <button onclick="closeModal()" class="modal-action-btn close-btn" style="flex: 1;">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
    enablePropertySorting();
}

// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function enablePropertySorting() {
    const container = document.getElementById('sortablePropertyList');
    const items = container.querySelectorAll('.sortable-property-item');

    let draggedElement = null;

    items.forEach(item => {
        item.draggable = true;

        item.addEventListener('dragstart', function(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', function(e) {
            this.style.opacity = '1';
            draggedElement = null;
        });

        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.style.borderColor = '#007bff';
            this.style.backgroundColor = '#f8f9ff';
        });

        item.addEventListener('dragleave', function(e) {
            this.style.borderColor = '#e9ecef';
            this.style.backgroundColor = 'white';
        });

        item.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#e9ecef';
            this.style.backgroundColor = 'white';

            if (draggedElement && draggedElement !== this) {
                // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬
                const rect = this.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;

                if (e.clientY < midpoint) {
                    // Ø¥Ø¯Ø±Ø§Ø¬ Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
                    container.insertBefore(draggedElement, this);
                } else {
                    // Ø¥Ø¯Ø±Ø§Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
                    container.insertBefore(draggedElement, this.nextSibling);
                }

                // ØªØ­Ø¯ÙŠØ« Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨
                updatePropertyOrderNumbers();
            }
        });
    });
}

// ØªØ­Ø¯ÙŠØ« Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
function updatePropertyOrderNumbers() {
    const items = document.querySelectorAll('.sortable-property-item');
    items.forEach((item, index) => {
        const numberSpan = item.querySelector('span');
        numberSpan.textContent = `${index + 1}.`;
    });
}

// Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
function savePropertyOrder() {
    const cityKey = currentCountry || 'Ø§Ù„ÙƒÙ„';
    const items = document.querySelectorAll('.sortable-property-item');
    const newOrder = Array.from(items).map(item => item.dataset.property);

    // Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    reorderProperties(cityKey, newOrder);

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    closeModal();

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    showSuccessMessage(`ØªÙ… Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù…Ø¯ÙŠÙ†Ø© "${cityKey}" Ø¨Ù†Ø¬Ø§Ø­!`);
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
        z-index: 10000;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideInRight 0.3s ease-out;
    `;

    successDiv.innerHTML = `
        <i class="fas fa-check-circle"></i>
        ${message}
    `;

    document.body.appendChild(successDiv);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        successDiv.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 300);
    }, 3000);
}

// ØªÙ‡ÙŠØ¦Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
function initStatusFilter() {
    const container = document.getElementById('headerFilters');
    container.innerHTML = '';
    
    const button = document.createElement('button');
    button.innerHTML = '<i class="fas fa-filter"></i> ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©';
    button.onclick = showStatusFilter;
    container.appendChild(button);
}

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù†
let searchState = {
    global: '',
    property: '',
    isSearchActive: false
};

// ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
function normalizeArabicText(text) {
    if (!text) return '';
    return text
        .replace(/Ø£|Ø¥|Ø¢/g, 'Ø§')
        .replace(/Ø©/g, 'Ù‡')
        .replace(/ÙŠ/g, 'Ù‰')
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
function searchInPropertyData(property, searchTerm) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
    if (typeof advancedSearchInProperty === 'function') {
        return advancedSearchInProperty(property, searchTerm);
    }

    // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙƒØ¨Ø¯ÙŠÙ„
    const normalizedSearchTerm = normalizeArabicText(searchTerm);

    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø®Ø§Øµ: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØµØ·Ù„Ø­ "Ù…ØªØ¹Ø¯Ø¯"ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
    if (normalizedSearchTerm === 'Ù…ØªØ¹Ø¯Ø¯') {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙ†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©)
        const contractNumber = property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'];
        const propertyName = property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

        if (contractNumber && propertyName && typeof properties !== 'undefined') {
            // Ø¹Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙ†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
            const relatedUnits = properties.filter(p =>
                p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
            );

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ÙÙ‡Ø°Ù‡ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
            if (relatedUnits.length > 1) {
                console.log(`ğŸ” ÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©: ${relatedUnits.length} ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}`);
                return true;
            }
        }
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
    const foundInData = Object.values(property).some(value => {
        if (!value) return false;
        const normalizedValue = normalizeArabicText(value.toString());
        return normalizedValue.includes(normalizedSearchTerm);
    });

    if (foundInData) return true;

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
    const status = calculateStatus(property);
    const statusSearchText = `${status.final} ${status.display}`;
    const normalizedStatusText = normalizeArabicText(statusSearchText);

    if (normalizedStatusText.includes(normalizedSearchTerm)) {
        console.log(`ğŸ” ÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©: "${searchTerm}" ÙÙŠ "${statusSearchText}"`);
        return true;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø±Ù† Ù„Ù„ØªÙˆØ§Ø±ÙŠØ®
    if (isDateSearchTerm(normalizedSearchTerm)) {
        return Object.values(property).some(value => {
            if (!value) return false;
            const normalizedValue = normalizeArabicText(value.toString());
            return matchesDateFlexibly(normalizedValue, normalizedSearchTerm);
        });
    }

    return false;
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ
function testRegistrySearchInScript() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ Ù…Ù† script.js...');

    if (!window.allData || window.allData.length === 0) {
        console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø±Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ
    const propertiesWithRegistry = window.allData.filter(p =>
        p['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] && p['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '].toString().trim() !== ''
    );

    console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ: ${propertiesWithRegistry.length}`);

    if (propertiesWithRegistry.length > 0) {
        const firstRegistry = propertiesWithRegistry[0]['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '].toString().trim();
        console.log(`ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ: "${firstRegistry}"`);

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨Ø­Ø«
        document.getElementById('globalSearch').value = firstRegistry;
        performGlobalSearch();

        console.log('âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
    } else {
        console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ');
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function showNewSearchExamples() {
    console.log(`
ğŸ” Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:

ğŸ“‹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‡Ø±Ù…ÙŠ (Ø§Ø³ØªØ®Ø¯Ù… //):
   Ø§Ù„Ø±ÙŠØ§Ø¶//Ø´Ù…Ø³//Ø¶Ø±ÙŠØ¨ÙŠ//ÙØ¹Ø§Ù„
   Ø¶Ø±ÙŠØ¨ÙŠ//Ø§Ù„Ø±ÙŠØ§Ø¶//Ù…Ù†ØªÙ‡ÙŠ+ÙØ§Ø±Øº

ğŸ”— Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ OR (Ø§Ø³ØªØ®Ø¯Ù… +):
   ÙØ¹Ø§Ù„+ÙˆØ´Ùƒ
   Ù…Ù†ØªÙ‡ÙŠ+ÙØ§Ø±Øº
   Ù†Ø´Ø·+Ø³Ø§Ø±ÙŠ+ÙØ¹Ø§Ù„

ğŸ’¡ Ø£Ù…Ø«Ù„Ø© Ù…Ø®ØªÙ„Ø·Ø©:
   Ø§Ù„Ø±ÙŠØ§Ø¶//Ù†Ø´Ø·+ÙØ§Ø±Øº (Ø§Ù„Ø±ÙŠØ§Ø¶ Ø«Ù… Ø§Ù„Ù†Ø´Ø·Ø© Ø£Ùˆ Ø§Ù„ÙØ§Ø±ØºØ©)
   Ø³ÙƒÙ†ÙŠ//Ø§Ù„Ø±ÙŠØ§Ø¶//Ù…Ù†ØªÙ‡ÙŠ+ÙØ§Ø±Øº (Ø³ÙƒÙ†ÙŠ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ Ø«Ù… Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø£Ùˆ Ø§Ù„ÙØ§Ø±ØºØ©)

ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…ÙˆØ²:
   - /// Ø£ØµØ¨Ø­ //
   - // Ø£ØµØ¨Ø­ +
    `);
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯
function testNewSearchSyntax() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØµÙŠØºØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...');

    if (!window.allData || window.allData.length === 0) {
        console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        return;
    }

    const testQueries = [
        'ÙØ¹Ø§Ù„+ÙˆØ´Ùƒ',
        'Ø§Ù„Ø±ÙŠØ§Ø¶//ÙØ¹Ø§Ù„',
        'Ù…Ù†ØªÙ‡ÙŠ+ÙØ§Ø±Øº'
    ];

    testQueries.forEach(query => {
        console.log(`\nğŸ” Ø§Ø®ØªØ¨Ø§Ø±: "${query}"`);
        document.getElementById('globalSearch').value = query;
        performGlobalSearch();
        console.log(`âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø«`);
    });

    console.log('\nğŸ“Š ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function testPropertyTypeSynonyms() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±Ø§Ø¯ÙØ§Øª Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    if (!window.allData || window.allData.length === 0) {
        console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        return;
    }

    const synonymTests = [
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª
        { original: 'Ù…Ø­Ù„', synonyms: ['Ø§Ù„Ù…Ø­Ù„Ø§Øª', 'Ù…Ø­Ù„Ø§Øª'] },
        { original: 'Ù…Ø³ØªÙˆØ¯Ø¹', synonyms: ['Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª', 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª'] },
        { original: 'Ø§Ø³ØªØ±Ø§Ø­Ø©', synonyms: ['Ø§Ø³ØªØ±Ø§Ø­Ø©', 'Ø§Ø³ØªØ±Ø§Ø­Ù‡'] },
        { original: 'Ø´Ù‚Ø©', synonyms: ['Ø§Ù„Ø´Ù‚Ù‚', 'Ø´Ù‚Ù‚'] },
        { original: 'Ù…ØµÙ†Ø¹', synonyms: ['Ù…ØµØ§Ù†Ø¹', 'Ø§Ù„Ù…ØµØ§Ù†Ø¹'] },
        { original: 'ÙÙ„Ø©', synonyms: ['Ø§Ù„ÙÙ„Ù„', 'ÙÙ„Ù„', 'ÙÙŠÙ„Ø§', 'ÙÙŠÙ„Ø§Øª'] },
        { original: 'Ø¹Ù…Ø§Ø±Ø©', synonyms: ['Ø§Ù„Ø¹Ù…Ø§Ø¦Ø±', 'Ø¹Ù…Ø§Ø¦Ø±'] },
        { original: 'Ù…Ø¹Ø±Ø¶', synonyms: ['Ù…Ø¹Ø§Ø±Ø¶', 'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶'] },
        { original: 'Ù…ÙƒØªØ¨', synonyms: ['Ø§Ù„Ù…ÙƒØ§ØªØ¨', 'Ù…ÙƒØ§ØªØ¨'] },
        { original: 'ÙˆØ±Ø´Ø©', synonyms: ['ÙˆØ±Ø´Ù‡', 'Ø§Ù„ÙˆØ±Ø´', 'ÙˆØ±Ø´'] },
        { original: 'Ù…Ø²Ø±Ø¹Ø©', synonyms: ['Ù…Ø²Ø±Ø¹Ù‡', 'Ø§Ù„Ù…Ø²Ø§Ø±Ø¹', 'Ù…Ø²Ø§Ø±Ø¹'] },
        { original: 'Ù…Ù†ØªÙ‡ÙŠ', synonyms: ['Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ'] }
    ];

    console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª:');

    synonymTests.forEach(test => {
        console.log(`\nğŸ“‹ Ø§Ø®ØªØ¨Ø§Ø± "${test.original}" ÙˆÙ…Ø±Ø§Ø¯ÙØ§ØªÙ‡Ø§:`);

        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        document.getElementById('globalSearch').value = test.original;
        performGlobalSearch();
        console.log(`   âœ… ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ "${test.original}"`);

        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª
        test.synonyms.forEach(synonym => {
            document.getElementById('globalSearch').value = synonym;
            performGlobalSearch();
            console.log(`   âœ… ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ "${synonym}"`);
        });
    });

    console.log('\nğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø£Ùˆ Ù…Ø±Ø§Ø¯ÙØ§ØªÙ‡Ø§');
    console.log('ğŸ“Š ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
function testSearchLoadingIndicator() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...');

    const searchInput = document.getElementById('globalSearch');
    if (!searchInput) {
        console.log('âŒ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        return;
    }

    console.log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø±...');
    showSearchLoadingIndicator();

    setTimeout(() => {
        console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø±...');
        hideSearchLoadingIndicator();
        console.log('ğŸ“ ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
    }, 2000);

    console.log('â±ï¸ Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± Ø®Ù„Ø§Ù„ Ø«Ø§Ù†ÙŠØªÙŠÙ†...');
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±
function testSearchWithLoadingIndicator() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...');

    if (!window.allData || window.allData.length === 0) {
        console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        return;
    }

    const testQueries = ['ÙØ¹Ø§Ù„', 'Ø§Ù„Ø±ÙŠØ§Ø¶//ÙØ¹Ø§Ù„', 'Ù…Ù†ØªÙ‡ÙŠ+ÙØ§Ø±Øº'];
    let currentIndex = 0;

    function runNextTest() {
        if (currentIndex >= testQueries.length) {
            console.log('âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±');
            return;
        }

        const query = testQueries[currentIndex];
        console.log(`\nğŸ” Ø§Ø®ØªØ¨Ø§Ø± ${currentIndex + 1}: "${query}"`);

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Øµ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            searchInput.value = query;

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« (Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø¤Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
            performGlobalSearch();

            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
            setTimeout(() => {
                currentIndex++;
                runNextTest();
            }, 3000);
        }
    }

    runNextTest();
    console.log('ğŸ“ Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø± Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª...');
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
function showLoadingIndicatorInfo() {
    console.log(`
ğŸ”„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„:

ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… (Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†)
ğŸ¨ Ø§Ù„ØªØµÙ…ÙŠÙ…: Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯Ø§Ø¦Ø±ÙŠØ© Ø¯ÙˆØ§Ø±Ø© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚
âš¡ Ø§Ù„ØªÙØ¹ÙŠÙ„: ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«
ğŸ¯ Ø§Ù„Ø¥Ø®ÙØ§Ø¡: ÙŠØ®ØªÙÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«

ğŸ§ª Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:
   â€¢ testSearchLoadingIndicator() - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø± ÙÙ‚Ø·
   â€¢ testSearchWithLoadingIndicator() - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±
   â€¢ showSearchLoadingIndicator() - Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹
   â€¢ hideSearchLoadingIndicator() - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹

ğŸ’¡ Ø§Ù„Ù…ÙŠØ²Ø§Øª:
   âœ… ÙŠØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙˆØ§Ù„Ù…ØªÙ‚Ø¯Ù…
   âœ… Ù…ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
   âœ… Ù„Ø§ ÙŠØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙƒØªÙˆØ¨
   âœ… ØªØ£Ø«ÙŠØ± Ø¯ÙˆØ±Ø§Ù† Ø³Ù„Ø³
   âœ… ÙŠØ¸Ù‡Ø±/ÙŠØ®ØªÙÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    `);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
function showAllSynonyms() {
    console.log(`
ğŸ” Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:

ğŸ“Š Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯:
   â€¢ ÙØ¹Ø§Ù„: Ù†Ø´Ø·ØŒ Ø³Ø§Ø±ÙŠØŒ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø¹Ù„Ù‰ ÙˆØ´ÙƒØŒ ÙˆØ´Ùƒ
   â€¢ Ù…Ù†ØªÙ‡ÙŠ: Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØŒ Ø§Ù†ØªÙ‡Ù‰ØŒ Ù…ÙƒØªÙ…Ù„
   â€¢ ÙØ§Ø±Øº: Ø´Ø§ØºØ±ØŒ Ø®Ø§Ù„ÙŠØŒ Ù…ØªØ§Ø­

ğŸ¢ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:
   â€¢ Ù…Ø­Ù„: Ø§Ù„Ù…Ø­Ù„Ø§ØªØŒ Ù…Ø­Ù„Ø§Øª
   â€¢ Ù…Ø³ØªÙˆØ¯Ø¹: Ù…Ø³ØªÙˆØ¯Ø¹Ø§ØªØŒ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
   â€¢ Ø´Ù‚Ø©: Ø§Ù„Ø´Ù‚Ù‚ØŒ Ø´Ù‚Ù‚
   â€¢ Ù…ØµÙ†Ø¹: Ù…ØµØ§Ù†Ø¹ØŒ Ø§Ù„Ù…ØµØ§Ù†Ø¹
   â€¢ ÙÙ„Ø©: Ø§Ù„ÙÙ„Ù„ØŒ ÙÙ„Ù„ØŒ ÙÙŠÙ„Ø§ØŒ ÙÙŠÙ„Ø§ØªØŒ Ø§Ù„ÙÙŠÙ„Ø§Øª
   â€¢ Ø¹Ù…Ø§Ø±Ø©: Ø§Ù„Ø¹Ù…Ø§Ø¦Ø±ØŒ Ø¹Ù…Ø§Ø¦Ø±
   â€¢ Ù…Ø¹Ø±Ø¶: Ù…Ø¹Ø§Ø±Ø¶ØŒ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶
   â€¢ Ù…ÙƒØªØ¨: Ø§Ù„Ù…ÙƒØ§ØªØ¨ØŒ Ù…ÙƒØ§ØªØ¨
   â€¢ ÙˆØ±Ø´Ø©: ÙˆØ±Ø´Ù‡ØŒ Ø§Ù„ÙˆØ±Ø´ØŒ ÙˆØ±Ø´
   â€¢ Ù…Ø²Ø±Ø¹Ø©: Ù…Ø²Ø±Ø¹Ù‡ØŒ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ØŒ Ù…Ø²Ø§Ø±Ø¹

ğŸ·ï¸ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯:
   â€¢ Ø¶Ø±ÙŠØ¨ÙŠ: Ø¶Ø±ÙŠØ¨ÙŠØ©ØŒ Ù…Ø¹ Ø¶Ø±ÙŠØ¨Ø©ØŒ Ø¨Ø¶Ø±ÙŠØ¨Ø©
   â€¢ Ø³ÙƒÙ†ÙŠ: Ø³ÙƒÙ†ÙŠØ©ØŒ Ø³ÙƒÙ†
   â€¢ Ø±Ø§ÙƒØ¶: ØºÙŠØ± Ù…Ø­Ø¯Ø¯ØŒ Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø¨Ø¹Ø¯

ğŸ’¡ Ù…Ø«Ø§Ù„: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "Ù…Ø­Ù„" Ø£Ùˆ "Ø§Ù„Ù…Ø­Ù„Ø§Øª" Ø£Ùˆ "Ù…Ø­Ù„Ø§Øª" ÙˆØ³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    `);
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø£ÙÙ‚ÙŠ
function initGlobalSearch() {
    const searchInput = document.getElementById('globalSearch');
    if (!searchInput) return;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
    updateSearchPlaceholder();

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
    window.addEventListener('resize', updateSearchPlaceholder);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    searchInput.removeEventListener('input', renderData);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performGlobalSearch();
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³Ø­ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹
    searchInput.addEventListener('input', function(e) {
        const currentValue = e.target.value.trim();

        // Ø¥Ø°Ø§ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙˆÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø« Ù†Ø´Ø·
        if (currentValue === '' && searchState.isSearchActive) {
            console.log('ğŸ”„ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø³Ø­ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹ - Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ±');
            clearGlobalSearchOnly();
        }
    });

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ HTML
    const searchBtn = document.querySelector('.global-search-btn');
    const cancelBtn = document.querySelector('.global-cancel-btn');

    if (searchBtn && !searchBtn.hasAttribute('data-initialized')) {
        searchBtn.addEventListener('click', performGlobalSearch);
        searchBtn.setAttribute('data-initialized', 'true');
    }

    if (cancelBtn && !cancelBtn.hasAttribute('data-initialized')) {
        cancelBtn.addEventListener('click', cancelGlobalSearchWithLoading);
        cancelBtn.setAttribute('data-initialized', 'true');
    }

    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø£ÙÙ‚ÙŠ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„ÙŠØ¯ÙˆÙŠ');
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
function updateSearchPlaceholder() {
    const searchInput = document.getElementById('globalSearch');
    if (!searchInput) return;

    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
        // Ù†Øµ Ù…Ø®ØªØµØ± Ù„Ù„Ù‡ÙˆØ§ØªÙ
        searchInput.placeholder = "Ø¨Ø­Ø«... (// Ù‡Ø±Ù…ÙŠØŒ + Ù…ØªØ¹Ø¯Ø¯)";
    } else {
        // Ù†Øµ Ù…Ø®ØªØµØ± Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø£ÙŠØ¶Ø§Ù‹ Ù„ÙŠØ¸Ù‡Ø± ÙƒØ§Ù…Ù„Ø§Ù‹
        searchInput.placeholder = "Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... (// Ù‡Ø±Ù…ÙŠØŒ + Ù…ØªØ¹Ø¯Ø¯)";
    }
}

// ===== ATTACHMENTS SEARCH FUNCTIONS =====

// Initialize attachments search functionality
function initAttachmentsSearch(propertyKey) {
    const searchInput = document.getElementById(`attachmentsSearch_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const clearBtn = document.querySelector(`.attachments-clear-btn[onclick*="${propertyKey}"]`);

    if (!searchInput) return;

    // Add input event listener for showing/hiding clear button
    searchInput.addEventListener('input', function(e) {
        const currentValue = e.target.value.trim();

        if (clearBtn) {
            clearBtn.style.display = currentValue ? 'flex' : 'none';
        }

        // Auto-search as user types (with debounce)
        clearTimeout(window.attachmentsSearchTimeout);
        window.attachmentsSearchTimeout = setTimeout(() => {
            performAttachmentsSearch(propertyKey);
        }, 300);
    });

    // Add Enter key support
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performAttachmentsSearch(propertyKey);
        }
    });

    console.log(`âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ${propertyKey}`);
}

// Perform attachments search
function performAttachmentsSearch(propertyKey) {
    const searchInput = document.getElementById(`attachmentsSearch_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const attachmentsList = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (!searchInput || !attachmentsList) return;

    const searchTerm = searchInput.value.trim().toLowerCase();
    const attachmentItems = attachmentsList.querySelectorAll('.attachment-item');

    console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: "${searchTerm}"`);

    let visibleCount = 0;

    attachmentItems.forEach(item => {
        const fileName = item.querySelector('.attachment-name')?.textContent?.toLowerCase() || '';
        const fileNotes = item.querySelector('.file-notes')?.title?.toLowerCase() || '';
        const isVisible = !searchTerm || fileName.includes(searchTerm) || fileNotes.includes(searchTerm);

        item.style.display = isVisible ? 'flex' : 'none';
        if (isVisible) visibleCount++;
    });

    // Show search results summary
    showAttachmentsSearchResults(attachmentsList, searchTerm, visibleCount, attachmentItems.length);
}

// Clear attachments search with loading state
function clearAttachmentsSearchWithLoading(propertyKey) {
    console.log(`ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ${propertyKey}`);

    const searchInput = document.getElementById(`attachmentsSearch_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const clearButton = document.querySelector(`.attachments-clear-btn[onclick*="${propertyKey}"]`);

    if (!searchInput || !clearButton) return;

    // Show loading state
    clearButton.disabled = true;
    const originalContent = clearButton.innerHTML;
    clearButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="btn-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...</span>';

    setTimeout(() => {
        try {
            // Clear search
            searchInput.value = '';
            clearButton.style.display = 'none';

            // Show all attachments
            performAttachmentsSearch(propertyKey);

            console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«:', error);
        } finally {
            // Restore button
            clearButton.disabled = false;
            clearButton.innerHTML = originalContent;
        }
    }, 200);
}

// Show search results summary
function showAttachmentsSearchResults(container, searchTerm, visibleCount, totalCount) {
    // Remove existing summary
    const existingSummary = container.querySelector('.search-results-summary');
    if (existingSummary) {
        existingSummary.remove();
    }

    if (searchTerm) {
        const summary = document.createElement('div');
        summary.className = 'search-results-summary';
        summary.style.cssText = `
            padding: 10px;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
            color: #1976d2;
            font-size: 14px;
        `;
        summary.innerHTML = `
            <i class="fas fa-search"></i>
            Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "<strong>${searchTerm}</strong>": ${visibleCount} Ù…Ù† ${totalCount} Ù…Ø±ÙÙ‚
        `;

        container.insertBefore(summary, container.firstChild);
    }
}

// ===== CARD ATTACHMENTS SEARCH FUNCTIONS =====

// Initialize card attachments search functionality
function initCardAttachmentsSearch(cardKey) {
    const searchInput = document.getElementById(`cardAttachmentsSearch_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const clearBtn = document.querySelector(`.attachments-clear-btn[onclick*="${cardKey}"]`);

    if (!searchInput) return;

    // Add input event listener for showing/hiding clear button
    searchInput.addEventListener('input', function(e) {
        const currentValue = e.target.value.trim();

        if (clearBtn) {
            clearBtn.style.display = currentValue ? 'flex' : 'none';
        }

        // Auto-search as user types (with debounce)
        clearTimeout(window.cardAttachmentsSearchTimeout);
        window.cardAttachmentsSearchTimeout = setTimeout(() => {
            performCardAttachmentsSearch(cardKey);
        }, 300);
    });

    // Add Enter key support
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performCardAttachmentsSearch(cardKey);
        }
    });

    console.log(`âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${cardKey}`);
}

// Perform card attachments search
function performCardAttachmentsSearch(cardKey) {
    const searchInput = document.getElementById(`cardAttachmentsSearch_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const attachmentsList = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (!searchInput || !attachmentsList) return;

    const searchTerm = searchInput.value.trim().toLowerCase();
    const attachmentItems = attachmentsList.querySelectorAll('.attachment-item');

    console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: "${searchTerm}"`);

    let visibleCount = 0;

    attachmentItems.forEach(item => {
        const fileName = item.querySelector('.attachment-name')?.textContent?.toLowerCase() || '';
        const fileNotes = item.querySelector('.file-notes')?.title?.toLowerCase() || '';
        const isVisible = !searchTerm || fileName.includes(searchTerm) || fileNotes.includes(searchTerm);

        item.style.display = isVisible ? 'flex' : 'none';
        if (isVisible) visibleCount++;
    });

    // Show search results summary
    showAttachmentsSearchResults(attachmentsList, searchTerm, visibleCount, attachmentItems.length);
}

// Clear card attachments search with loading state
function clearCardAttachmentsSearchWithLoading(cardKey) {
    console.log(`ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${cardKey}`);

    const searchInput = document.getElementById(`cardAttachmentsSearch_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const clearButton = document.querySelector(`.attachments-clear-btn[onclick*="${cardKey}"]`);

    if (!searchInput || !clearButton) return;

    // Show loading state
    clearButton.disabled = true;
    const originalContent = clearButton.innerHTML;
    clearButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="btn-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...</span>';

    setTimeout(() => {
        try {
            // Clear search
            searchInput.value = '';
            clearButton.style.display = 'none';

            // Show all attachments
            performCardAttachmentsSearch(cardKey);

            console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«:', error);
        } finally {
            // Restore button
            clearButton.disabled = false;
            clearButton.innerHTML = originalContent;
        }
    }, 200);
}

// Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ø³Ø­ (Ù…Ø­Ø¯Ø«Ø© Ù„Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯)
function addSearchButtons(inputId) {
    const searchInput = document.getElementById(inputId);
    if (!searchInput) return;

    // Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…ØŒ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ HTML
    if (inputId === 'globalSearch') {
        console.log('âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ HTML');
        return;
    }

    // Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§ØªØŒ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø£Ø²Ø±Ø§Ø± - Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠ
    if (inputId === 'propertySearch') {
        console.log('âœ… Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠ - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø£Ø²Ø±Ø§Ø±');
        return;
    }
}

// Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
function showSearchLoadingIndicator() {
    const indicator = document.getElementById('searchLoadingIndicator');
    if (indicator) {
        indicator.style.display = 'block';
    }
}

function hideSearchLoadingIndicator() {
    const indicator = document.getElementById('searchLoadingIndicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// Ù‚Ø§Ù…ÙˆØ³ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ
const STATUS_KEYWORDS = {
    'ÙØ¹Ø§Ù„': ['ÙØ¹Ø§Ù„'],
    'Ù†Ø´Ø·_Ø¹Ø§Ù…': ['Ù†Ø´Ø·', 'Ø³Ø§Ø±ÙŠ', 'Ø³Ø§Ø±Ù‰', 'Ø¬Ø§Ø±ÙŠ', 'Ø¬Ø§Ø±Ù‰', 'Ø§Ù„Ø­Ø§Ù„ÙŠ', 'Ø§Ù„Ø­Ø§Ù„Ù‰'], // Ù‡Ø°Ù‡ ØªØ¹Ø·ÙŠ ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ
    'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ': ['Ø¹Ù„Ù‰ ÙˆØ´Ùƒ', 'Ø¹Ù„ÙŠ ÙˆØ´Ùƒ', 'ÙˆØ´Ùƒ'],
    'Ù…Ù†ØªÙ‡Ù‰': ['Ù…Ù†ØªÙ‡ÙŠ', 'Ù…Ù†ØªÙ‡Ù‰', 'Ø§Ù†ØªÙ‡Ù‰', 'Ø§Ù†ØªÙ‡ÙŠ', 'Ù…ÙƒØªÙ…Ù„', 'Ù…ÙƒØªÙ…Ù„Ø©'],
    'ÙØ§Ø±Øº': ['ÙØ§Ø±Øº', 'ÙØ§Ø±ØºØ©', 'Ø´Ø§ØºØ±', 'Ø´Ø§ØºØ±Ø©', 'Ø®Ø§Ù„ÙŠ', 'Ø®Ø§Ù„ÙŠØ©', 'Ù…ØªØ§Ø­', 'Ù…ØªØ§Ø­Ø©']
};

// Ù‚Ø§Ù…ÙˆØ³ ÙƒÙ„Ù…Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
const PROPERTY_TYPE_KEYWORDS = {
    'lands': ['Ø§Ø±Ø¶', 'Ø£Ø±Ø¶', 'Ø§Ø±Ø§Ø¶ÙŠ', 'Ø£Ø±Ø§Ø¶ÙŠ', 'Ø§Ø±Ø§Ø¶Ù‰', 'Ø£Ø±Ø§Ø¶Ù‰', 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ', 'Ø§Ù„Ø§Ø±Ø§Ø¶ÙŠ'],
    'buildings': ['Ù…Ø¨Ø§Ù†ÙŠ', 'Ù…Ø¨Ø§Ù†Ù‰', 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ', 'Ø§Ù„Ù…Ø¨Ø§Ù†Ù‰', 'Ù…Ø¨Ù†Ù‰', 'Ù…Ø¨Ù†ÙŠ', 'Ø¨Ù†Ø§Ø¡', 'Ø§Ø¨Ù†ÙŠØ©', 'Ø£Ø¨Ù†ÙŠØ©']
};

// Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
let statusFilterAppliedFromSearch = false;

// Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
let propertyTypeFilterAppliedFromSearch = false;

// Ø¯Ø§Ù„Ø© Ù„Ù„ÙƒØ´Ù Ø¹Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù†Øµ
function detectStatusKeyword(searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') return null;

    const normalizedTerm = normalizeArabicTextAdvanced ? normalizeArabicTextAdvanced(searchTerm.trim()) : searchTerm.trim().toLowerCase();

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
    for (const [status, keywords] of Object.entries(STATUS_KEYWORDS)) {
        for (const keyword of keywords) {
            const normalizedKeyword = normalizeArabicTextAdvanced ? normalizeArabicTextAdvanced(keyword) : keyword.toLowerCase();
            if (normalizedTerm === normalizedKeyword) {
                return status;
            }
        }
    }

    return null;
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ÙƒØ´Ù Ø¹Ù† ÙƒÙ„Ù…Ø© Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† Ø§Ù„Ù†Øµ
function detectPropertyTypeKeyword(searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') return null;

    const normalizedTerm = normalizeArabicTextAdvanced ? normalizeArabicTextAdvanced(searchTerm.trim()) : searchTerm.trim().toLowerCase();

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ ÙƒÙ„Ù…Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
    for (const [propertyType, keywords] of Object.entries(PROPERTY_TYPE_KEYWORDS)) {
        for (const keyword of keywords) {
            const normalizedKeyword = normalizeArabicTextAdvanced ? normalizeArabicTextAdvanced(keyword) : keyword.toLowerCase();
            if (normalizedTerm === normalizedKeyword) {
                return propertyType;
            }
        }
    }

    return null;
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø­Ø« Ù†Ø´Ø· Ø¹Ø§Ù… (ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
function applyActiveGeneralSearch(originalSearchTerm) {
    console.log('ğŸ¯ ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø­Ø« Ù†Ø´Ø· Ø¹Ø§Ù… (ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…');

    // ØªØ³Ø¬ÙŠÙ„ Ø£Ù† Ø§Ù„Ø¨Ø­Ø« ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ù…Ù† ÙƒÙ„Ù…Ø© Ø­Ø§Ù„Ø©
    statusFilterAppliedFromSearch = true;

    // Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« (Ù…Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…)
    // Ù„ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
    searchState.global = originalSearchTerm || 'Ù†Ø´Ø·';
    searchState.isSearchActive = true;
    searchState.internalAdvancedSearch = 'ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ'; // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…

    // Ù…Ø³Ø­ Ø£ÙŠ ÙÙ„Ø§ØªØ± Ø­Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø«
    filterStatus = '';

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    updateAllFilterButtonsState();

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù„Ø§ Ù†Ø­Ø¯Ø¯ Ø­Ø§Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¨Ø­Ø« Ù…Ø±ÙƒØ¨)
    updateStatusButtonsState('');

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
    saveAppState();
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ÙƒØ´Ù Ø¹Ù† ÙƒÙ„Ù…Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
function detectAndApplyPropertyTypeFilter(searchTerm, clearSearchField = false) {
    const detectedPropertyType = detectPropertyTypeKeyword(searchTerm);

    if (detectedPropertyType) {
        console.log(`ğŸ—ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙƒÙ„Ù…Ø© Ù†ÙˆØ¹ Ø¹Ù‚Ø§Ø±: "${searchTerm}" â†’ ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± "${detectedPropertyType}"`);

        // ØªØ³Ø¬ÙŠÙ„ Ø£Ù† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
        propertyTypeFilterAppliedFromSearch = true;

        // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
        filterPropertiesByType(detectedPropertyType);

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
        const searchInput = document.getElementById('globalSearch');
        if (searchInput && typeof showSearchIndicator === 'function') {
            const filterName = detectedPropertyType === 'lands' ? 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ' : 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ';
            showSearchIndicator(searchInput, `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${filterName} (Ø§Ø­Ø°Ù Ø§Ù„Ù†Øµ Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±)`, 'success');
        }

        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù†Øµ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« (Ù„Ø§ Ù†Ù…Ø³Ø­Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø§Ù„Ù†Øµ Ø¨Ù†ÙØ³Ù‡ Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±
        if (searchInput) {
            searchState.global = searchTerm; // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø©
            searchState.isSearchActive = true; // Ø§Ù„Ø¨Ø­Ø« Ù†Ø´Ø·
        }

        return true; // ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
    }

    return false; // Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ù†ÙˆØ¹ Ø¹Ù‚Ø§Ø±
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ÙƒØ´Ù Ø¹Ù† ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
function detectAndApplyStatusFilter(searchTerm, clearSearchField = true) {
    const detectedStatus = detectStatusKeyword(searchTerm);

    if (detectedStatus) {
        console.log(`ğŸ¯ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙƒÙ„Ù…Ø© Ø­Ø§Ù„Ø©: "${searchTerm}" â†’ ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± "${detectedStatus}"`);

        // ØªØ³Ø¬ÙŠÙ„ Ø£Ù† ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
        statusFilterAppliedFromSearch = true;

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        if (detectedStatus === 'Ù†Ø´Ø·_Ø¹Ø§Ù…') {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø´Ø§Ù…Ù„Ø©
            // Ù„ÙƒÙ† Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
            applyActiveGeneralSearch(searchTerm);
        } else {
            setStatusFilter(detectedStatus, true);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
        const searchInput = document.getElementById('globalSearch');
        if (searchInput && typeof showSearchIndicator === 'function') {
            if (detectedStatus === 'Ù†Ø´Ø·_Ø¹Ø§Ù…') {

            } else {
                showSearchIndicator(searchInput, `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${detectedStatus} (ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„Ù†Øµ Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±)`, 'success');
            }
        }

        return true; // ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
    }

    return false; // Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø­Ø§Ù„Ø©
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…
function performGlobalSearch() {
    const searchInput = document.getElementById('globalSearch');
    if (!searchInput) return;

    const searchTerm = searchInput.value.trim();
    console.log('ğŸ” ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…:', searchTerm);

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    showSearchLoadingIndicator();

    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø« Ù†Ø´Ø·
    const cancelBtn = document.querySelector('.global-cancel-btn');
    if (cancelBtn) {
        cancelBtn.style.display = searchTerm ? 'flex' : 'none';
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø²Ø± ÙÙŠ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
        cancelBtn.disabled = false;
        cancelBtn.innerHTML = '<i class="fas fa-times"></i><span class="btn-text">Ø¥Ù„ØºØ§Ø¡</span>';
    }

    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø±
    setTimeout(() => {
        try {
            // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ÙƒØªØ´Ø§Ù ÙˆØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
            const statusFilterApplied = detectAndApplyStatusFilter(searchTerm);

            // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø­Ø§Ù„Ø©ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ÙƒØªØ´Ø§Ù ÙˆØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
            const propertyTypeFilterApplied = !statusFilterApplied ? detectAndApplyPropertyTypeFilter(searchTerm) : false;

            if (statusFilterApplied || propertyTypeFilterApplied) {
                // Ø¥Ø°Ø§ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø£ÙŠ ÙÙ„ØªØ±ØŒ ÙÙ‚Ø¯ ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙØ¹Ù„
                // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„ÙØ¹Ù„ Ø´ÙŠØ¡ Ù‡Ù†Ø§
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø£ÙŠ ÙÙ„ØªØ±ØŒ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                searchState.global = searchTerm;
                searchState.isSearchActive = searchTerm.length > 0;

                renderData();

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ø­Ø«
                if (searchTerm) {
                    const searchTerms = searchTerm.split('//').map(term => term.trim()).filter(term => term.length > 0);
                    const isMultiSearch = searchTerms.length > 1;

                    if (typeof showSearchIndicator === 'function') {
                        if (isMultiSearch) {
                            showSearchIndicator(searchInput, `ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ${searchTerms.length} Ù…ØµØ·Ù„Ø­Ø§Øª Ù…Ø®ØªÙ„ÙØ©`, 'success');
                        } else {
                            showSearchIndicator(searchInput, `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬`, 'success');
                        }
                    }
                }
            }

            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«
            hideSearchLoadingIndicator();

        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
            hideSearchLoadingIndicator();
        }
    }, 100); // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø±
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±
function clearGlobalSearch() {
    console.log('ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±...');

    const searchInput = document.getElementById('globalSearch');
    const cancelButton = document.querySelector('.global-cancel-btn');

    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    hideSearchLoadingIndicator();

    // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
    if (searchInput) {
        searchInput.value = '';
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    if (cancelButton) {
        cancelButton.style.display = 'none';
    }

    // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…
    searchState.global = '';
    searchState.isSearchActive = false;
    searchState.internalAdvancedSearch = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± ØªØªØ¨Ø¹ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
    statusFilterAppliedFromSearch = false;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ±
    currentCountry = null;
    currentProperty = null;
    filterStatus = null;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    activeFilters = {
        city: '',
        property: '',
        status: '',
        contractType: '',
        propertyType: '',
        dateFilter: '',
        startDate: '',
        endDate: '',
        nearExpiry: false,
        monthFilter: '',
        multiProperty: [],
        owner: ''
    };

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø©
    const countryButtons = document.querySelectorAll('.country-btn, .city-btn');
    countryButtons.forEach(btn => btn.classList.remove('active'));

    const propertyButtons = document.querySelectorAll('.property-btn');
    propertyButtons.forEach(btn => btn.classList.remove('active'));

    const filterButtons = document.querySelectorAll('.filter-btn, .status-btn');
    filterButtons.forEach(btn => btn.classList.remove('active'));

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateStatusButtonsState('');

    // Ù…Ø³Ø­ ÙÙ„Ø§ØªØ± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (window.tableFilterSystem) {
        const tables = ['trackingLogsTable', 'propertiesTable', 'unitsTable'];
        tables.forEach(tableId => {
            if (document.getElementById(tableId)) {
                window.tableFilterSystem.clearAllFilters(tableId);
                window.tableFilterSystem.clearSearch(tableId);
            }
        });
    }

    // Ù…Ø³Ø­ Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    const desktopList = document.getElementById('activeFiltersList');
    const mobileList = document.getElementById('activeFiltersListMobile');
    if (desktopList) desktopList.innerHTML = '';
    if (mobileList) mobileList.innerHTML = '';

    // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
    const clearBtns = document.querySelectorAll('.clear-all-filters-btn');
    clearBtns.forEach(btn => btn.style.display = 'none');

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù‡Ø§ØªÙ
    const mobileFilterBtn = document.getElementById('mobileFiltersBtn');
    if (mobileFilterBtn) {
        mobileFilterBtn.classList.remove('has-filters');
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª
    if (typeof updateMobilePropertyName === 'function') {
        updateMobilePropertyName();
    }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (typeof renderData === 'function') {
        renderData();
    } else {
        displayProperties(properties);
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    if (typeof updateActiveFiltersDisplay === 'function') {
        updateActiveFiltersDisplay();
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    if (typeof updateTotals === 'function') {
        updateTotals();
    }

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (typeof saveAppState === 'function') {
        saveAppState();
    }

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    setTimeout(() => {
        if (typeof renderData === 'function') {
            renderData();
        }
        if (typeof updateTotals === 'function') {
            updateTotals();
        }
        if (typeof updateActiveFiltersDisplay === 'function') {
            updateActiveFiltersDisplay();
        }
    }, 100);

    console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±');

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³Ø­
    if (searchInput) {
        showSearchIndicator(searchInput, 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±', 'success');
    }
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù„Ù„Ø²Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ)
function clearGlobalSearchWithLoading() {
    console.log('ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ù…Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...');

    const searchInput = document.getElementById('globalSearch');
    const cancelButton = document.querySelector('.global-cancel-btn');
    const loadingIndicator = document.getElementById('searchLoadingIndicator');

    if (!searchInput || !cancelButton) return;

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
    if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
    }

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    cancelButton.disabled = true;
    const originalContent = cancelButton.innerHTML;
    cancelButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="btn-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...</span>';

    // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(() => {
        try {
            // ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø³Ø­
            clearGlobalSearch();

            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            if (cancelButton) {
                cancelButton.style.display = 'none';
            }

            console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«:', error);
        } finally {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            cancelButton.disabled = false;
            cancelButton.innerHTML = originalContent;

            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }
    }, 300);
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø· (Ù…Ø«Ù„ Ø­Ø°Ù Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹)
function cancelGlobalSearchWithLoading() {
    console.log('ğŸš« Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø· (Ù…Ø«Ù„ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„ÙŠØ¯ÙˆÙŠ)...');

    const cancelButton = document.querySelector('.global-cancel-btn');
    const loadingIndicator = document.getElementById('searchLoadingIndicator');

    if (!cancelButton) return;

    // Show loading state
    cancelButton.disabled = true;
    const originalContent = cancelButton.innerHTML;
    cancelButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="btn-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...</span>';

    // Show loading indicator
    if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
    }

    setTimeout(() => {
        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù„Ù…Ø³Ø­ Ø§Ù„ÙŠØ¯ÙˆÙŠ
            clearGlobalSearchOnly();

            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                showSearchIndicator(searchInput, 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« - Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 'success');
            }

            // Ø¹Ø±Ø¶ toast notification
            showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø£Ø®Ø±Ù‰', 'success');

        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«:', error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«', 'error');
        } finally {
            // Restore button after delay
            setTimeout(() => {
                cancelButton.disabled = false;
                cancelButton.innerHTML = originalContent;

                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }, 400);
        }
    }, 300);
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ± (Ù„Ù„Ù…Ø³Ø­ Ø§Ù„ÙŠØ¯ÙˆÙŠ)
function clearGlobalSearchOnly() {
    console.log('ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ±...');

    const searchInput = document.getElementById('globalSearch');
    const cancelButton = document.querySelector('.global-cancel-btn');

    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    hideSearchLoadingIndicator();

    // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
    if (searchInput) {
        searchInput.value = '';
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    if (cancelButton) {
        cancelButton.style.display = 'none';
    }

    // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·
    searchState.global = '';
    searchState.isSearchActive = false;
    searchState.internalAdvancedSearch = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…

    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙ„ØªØ±/Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø·Ø¨Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«ØŒ Ù‚Ù… Ø¨Ù…Ø³Ø­Ù‡ Ø£ÙŠØ¶Ø§Ù‹
    if (statusFilterAppliedFromSearch) {
        const wasAdvancedSearch = searchState.internalAdvancedSearch === 'ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ';
        console.log('ğŸ§¹ Ù…Ø³Ø­ ÙÙ„ØªØ±/Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø£Ù†Ù‡ ÙƒØ§Ù† Ù…Ø·Ø¨Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«');

        // Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø«
        filterStatus = '';
        statusFilterAppliedFromSearch = false;

        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        updateStatusButtonsState('');

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
        if (typeof updateActiveFiltersDisplay === 'function') {
            updateActiveFiltersDisplay();
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
        if (searchInput && typeof showSearchIndicator === 'function') {
            const searchType = wasAdvancedSearch ? 'Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ)' : 'ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©';
            showSearchIndicator(searchInput, `ØªÙ… Ù…Ø³Ø­ ${searchType} Ø§Ù„Ù…Ø·Ø¨Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«`, 'success');
        }
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø·Ø¨Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«ØŒ Ù‚Ù… Ø¨Ù…Ø³Ø­Ù‡ Ø£ÙŠØ¶Ø§Ù‹
    if (propertyTypeFilterAppliedFromSearch) {
        console.log('ğŸ§¹ Ù…Ø³Ø­ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ø£Ù†Ù‡ ÙƒØ§Ù† Ù…Ø·Ø¨Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«');

        // Ù…Ø³Ø­ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
        if (typeof resetPropertyTypeFilter === 'function') {
            resetPropertyTypeFilter();
        }
        propertyTypeFilterAppliedFromSearch = false;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
        if (searchInput && typeof showSearchIndicator === 'function') {
            showSearchIndicator(searchInput, `ØªÙ… Ù…Ø³Ø­ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø·Ø¨Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«`, 'success');
        }
    }

    // ØªÙ†ÙÙŠØ° renderData Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    setTimeout(() => {
        if (typeof renderData === 'function') {
            renderData();
        }

        console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ±');
    }, 100);
}

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¨Ø³ÙŠØ·Ø© Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙ‚Ø·
function showSimpleSearchClearMessage() {
    const searchInput = document.getElementById('globalSearch');

    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨Ø­Ø«
    if (searchInput) {
        showSearchIndicator(searchInput, 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« - Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 'success');
    }

    // Ø¹Ø±Ø¶ toast notification Ø¨Ø³ÙŠØ·Ø©
    showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø£Ø®Ø±Ù‰', 'success');

    // ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø®Øµ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
    setTimeout(() => {
        console.log('ğŸ“‹ Ù…Ù„Ø®Øµ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…:', {
            'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…': 'ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ…',
            'ğŸ™ï¸ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯Ù†': 'Ù…Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© âœ…',
            'ğŸ¢ ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª': 'Ù…Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© âœ…',
            'ğŸ“Š ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©': 'Ù…Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© âœ…',
            'ğŸ“… ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®': 'Ù…Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© âœ…',
            'ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©': 'Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© âœ…'
        });

        console.log('ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø£Ø®Ø±Ù‰');
    }, 500);
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„ (Ø¨Ø¯ÙˆÙ† Ù…Ø¤Ø´Ø±Ø§Øª Ø¨ØµØ±ÙŠØ©)
function clearGlobalSearchOnNavigation() {
    const searchInput = document.getElementById('globalSearch');
    if (!searchInput) return;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨Ø­Ø« Ù†Ø´Ø·
    if (!searchState.global || searchState.global.trim() === '') {
        return; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø­Ø« Ù†Ø´Ø·ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ù…Ø³Ø­
    }

    console.log('ğŸ”„ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„');

    // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ
    searchInput.value = '';

    // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
    searchState.global = '';
    searchState.isSearchActive = false;

    // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ renderData() Ù‡Ù†Ø§ Ù„Ø£Ù† Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ Ø³ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§
    // Ù„Ø§ Ù†Ø¸Ù‡Ø± Ù…Ø¤Ø´Ø±Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ø£Ù† Ù‡Ø°Ø§ Ù…Ø³Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (ÙŠØ­Ø¯Ø« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©)
function performAutoPropertySearch() {
    const searchInput = document.getElementById('propertySearch');
    if (!searchInput) return;

    const searchTerm = searchInput.value.trim();
    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', searchTerm);

    // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ÙƒØªØ´Ø§Ù ÙˆØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
    const statusFilterApplied = detectAndApplyStatusFilter(searchTerm, false); // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª

    if (statusFilterApplied) {
        // Ø¥Ø°Ø§ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù†Øµ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        // Ù„Ø£Ù† Ø§Ù„ÙÙ„ØªØ± Ø³ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const propertyItems = document.querySelectorAll('#propertyList div:not(.no-properties)');
        propertyItems.forEach(item => {
            item.style.display = '';
        });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
        if (typeof showSearchIndicator === 'function') {
            showSearchIndicator(searchInput, `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¨Ø­Ø« (ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„Ù†Øµ Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±)`, 'success');
        }

        return;
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø­Ø§Ù„Ø©ØŒ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    const searchTermLower = searchTerm.toLowerCase();

    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
    searchState.property = searchTermLower;

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø³Ø­
    const clearBtn = document.querySelector('.property-clear-btn');
    if (clearBtn) {
        clearBtn.style.display = searchTerm ? 'flex' : 'none';
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const propertyItems = document.querySelectorAll('#propertyList div:not(.no-properties)');
    let visibleCount = 0;

    propertyItems.forEach(item => {
        const propertyName = item.textContent.toLowerCase();
        const isVisible = !searchTermLower || propertyName.includes(searchTermLower);

        item.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
    });

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬
    updatePropertySearchResults(visibleCount, searchTerm);
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function clearPropertySearch() {
    const searchInput = document.getElementById('propertySearch');
    if (!searchInput) return;

    console.log('ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');

    // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ
    searchInput.value = '';

    // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
    searchState.property = '';

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø³Ø­
    const clearBtn = document.querySelector('.property-clear-btn');
    if (clearBtn) {
        clearBtn.style.display = 'none';
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const propertyItems = document.querySelectorAll('#propertyList div:not(.no-properties)');
    propertyItems.forEach(item => {
        item.style.display = '';
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨Ø­Ø«
    const searchResults = document.querySelector('#propertyList .search-results-message');
    if (searchResults) {
        searchResults.remove();
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨Ø­Ø«)
    updatePropertySearchResults(0, '');

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³Ø­
    showSearchIndicator(searchInput, 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«', 'info');
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù„Ù„Ø²Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ)
function clearPropertySearchWithLoading() {
    console.log('ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...');

    const searchInput = document.getElementById('propertySearch');
    const clearButton = document.querySelector('.property-clear-btn');

    if (!searchInput || !clearButton) return;

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    clearButton.disabled = true;
    const originalContent = clearButton.innerHTML;
    clearButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(() => {
        try {
            // ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø³Ø­
            clearPropertySearch();

            console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', error);
        } finally {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
            clearButton.disabled = false;
            clearButton.innerHTML = originalContent;
        }
    }, 200);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨Ø­Ø«
function showSearchIndicator(inputElement, message, type = 'info') {
    if (!inputElement) return;

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
    const existingIndicator = inputElement.parentElement.querySelector('.search-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø´Ø± Ø¬Ø¯ÙŠØ¯
    const indicator = document.createElement('div');
    indicator.className = 'search-indicator';
    indicator.textContent = message;

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    let backgroundColor = '#17a2b8'; // info
    if (type === 'success') backgroundColor = '#28a745';
    if (type === 'warning') backgroundColor = '#ffc107';
    if (type === 'error') backgroundColor = '#dc3545';

    indicator.style.cssText = `
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: ${backgroundColor};
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        margin-top: 2px;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¤Ø´Ø±
    inputElement.parentElement.style.position = 'relative';
    inputElement.parentElement.appendChild(indicator);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø±
    setTimeout(() => {
        indicator.style.opacity = '1';
    }, 10);

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        indicator.style.opacity = '0';
        setTimeout(() => {
            if (indicator.parentElement) {
                indicator.remove();
            }
        }, 300);
    }, 3000);
}

// ØªØ­Ø¯ÙŠØ« Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function updatePropertySearchResults(visibleCount, searchTerm) {
    const propertyList = document.getElementById('propertyList');
    if (!propertyList) return;

    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    const existingMessage = propertyList.querySelector('.search-results-message');
    if (existingMessage) {
        existingMessage.remove();
    }

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø« Ù†Ø´Ø·
    if (searchTerm) {
        const resultsMessage = document.createElement('div');
        resultsMessage.className = 'search-results-message';
        resultsMessage.style.cssText = `
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 8px 12px;
            text-align: center;
            font-size: 13px;
            color: #495057;
        `;

        if (visibleCount === 0) {
            resultsMessage.innerHTML = `
                <i class="fas fa-search" style="color: #6c757d; margin-left: 5px;"></i>
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«: "${searchTerm}"
            `;
            resultsMessage.style.color = '#6c757d';
        } else {
            resultsMessage.innerHTML = `
                <i class="fas fa-check-circle" style="color: #28a745; margin-left: 5px;"></i>
                ${visibleCount} Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¨Ø­Ø«: "${searchTerm}"
            `;
            resultsMessage.style.color = '#28a745';
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        propertyList.insertBefore(resultsMessage, propertyList.firstChild);
    }
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function restorePropertySearchState(searchTerm) {
    const searchInput = document.getElementById('propertySearch');
    if (!searchInput || !searchTerm) return;

    console.log('ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', searchTerm);

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
    searchInput.value = searchTerm;

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
    searchState.property = searchTerm;
    performAutoPropertySearch();
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© renderData Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
function getGlobalSearchTerm() {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    if (!searchState.isSearchActive) {
        return '';
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ÙŠ Ù…ØªÙ‚Ø¯Ù…ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù„ÙŠ
    if (searchState.internalAdvancedSearch) {
        return searchState.internalAdvancedSearch;
    }

    // ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    return searchState.global;
}

// ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù†
function initializeEnhancedSearch() {
    console.log('ğŸ” ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù†...');

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…
    setTimeout(() => {
        const globalSearchInput = document.getElementById('globalSearch');
        if (globalSearchInput && !globalSearchInput.parentElement.querySelector('.search-buttons-container')) {
            addSearchButtons('globalSearch');
        }
    }, 100);

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    setTimeout(() => {
        initAutoPropertySearch();
    }, 200);

    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù†');
}

// Ø¯Ø§Ù„Ø© Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (Ù…Ø­Ø¯Ø«Ø© Ù„Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯)
function ensureSearchEnhancements() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    setTimeout(() => {
        const globalSearch = document.getElementById('globalSearch');
        const propertySearch = document.getElementById('propertySearch');

        // Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ HTML
        if (globalSearch) {
            const searchBtn = document.querySelector('.global-search-btn');
            const clearBtn = document.querySelector('.global-clear-btn');

            if (searchBtn && !searchBtn.hasAttribute('data-initialized')) {
                searchBtn.addEventListener('click', performGlobalSearch);
                searchBtn.setAttribute('data-initialized', 'true');
                console.log('ğŸ”§ ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…...');
            }

            if (clearBtn && !clearBtn.hasAttribute('data-initialized')) {
                clearBtn.addEventListener('click', clearGlobalSearch);
                clearBtn.setAttribute('data-initialized', 'true');
                console.log('ğŸ”§ ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…...');
            }

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Enter Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!globalSearch.hasAttribute('data-enter-initialized')) {
                globalSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performGlobalSearch();
                    }
                });
                globalSearch.setAttribute('data-enter-initialized', 'true');
            }

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹
            if (!globalSearch.hasAttribute('data-input-initialized')) {
                globalSearch.addEventListener('input', function(e) {
                    const currentValue = e.target.value.trim();

                    // Ø¥Ø°Ø§ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙˆÙƒØ§Ù† ÙÙ„ØªØ±/Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø·Ø¨Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
                    if (currentValue === '' && statusFilterAppliedFromSearch) {
                        const wasAdvancedSearch = searchState.internalAdvancedSearch === 'ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ';
                        console.log('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹ - Ù…Ø³Ø­ ÙÙ„ØªØ±/Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø¨Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«');

                        // Ù…Ø³Ø­ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¨Ø­Ø«
                        filterStatus = '';
                        statusFilterAppliedFromSearch = false;
                        searchState.internalAdvancedSearch = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…

                        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                        updateStatusButtonsState('');

                        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
                        if (typeof updateActiveFiltersDisplay === 'function') {
                            updateActiveFiltersDisplay();
                        }

                        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        if (typeof renderData === 'function') {
                            renderData();
                        }

                        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
                        if (typeof showSearchIndicator === 'function') {
                            const searchType = wasAdvancedSearch ? 'Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ)' : 'ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©';
                            showSearchIndicator(e.target, `ØªÙ… Ù…Ø³Ø­ ${searchType}`, 'success');
                        }
                    }
                });
                globalSearch.setAttribute('data-input-initialized', 'true');
            }
        }

        // Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§ØªØŒ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        if (propertySearch) {
            console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');
            initAutoPropertySearch();
        }

        console.log('âœ… ØªÙ… Ø¶Ù…Ø§Ù† ØªØ·Ø¨ÙŠÙ‚ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯');
    }, 1000);
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function initAutoPropertySearch() {
    const searchInput = document.getElementById('propertySearch');
    if (!searchInput) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹
    if (searchInput.hasAttribute('data-auto-search-initialized')) {
        console.log('âœ… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù‡ÙŠØ£ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
        return;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    let searchTimeout;
    searchInput.addEventListener('input', function(e) {
        const currentValue = e.target.value.trim();
        const clearBtn = document.querySelector('.property-clear-btn');

        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ù†Øµ
        if (clearBtn) {
            clearBtn.style.display = currentValue ? 'flex' : 'none';
        }

        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ø²Ø§Ù„ ÙŠÙƒØªØ¨
        clearTimeout(searchTimeout);

        // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ ÙƒÙ„ Ø­Ø±Ù
        searchTimeout = setTimeout(() => {
            performAutoPropertySearch();
        }, 300); // 300ms ØªØ£Ø®ÙŠØ±
    });

    // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø«
    searchInput.addEventListener('focus', function(e) {
        e.stopPropagation();
        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø±
        const sidebar = document.querySelector('aside');
        if (sidebar) {
            sidebar.classList.add('search-active');
        }
    });

    searchInput.addEventListener('blur', function() {
        // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±
        setTimeout(() => {
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                sidebar.classList.remove('search-active');
            }
        }, 300);
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter (Ù„Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ)
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(searchTimeout); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ£Ø®ÙŠØ±
            performAutoPropertySearch(); // Ø¨Ø­Ø« ÙÙˆØ±ÙŠ
        }
    });

    // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
    searchInput.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    searchInput.addEventListener('touchstart', function(e) {
        e.stopPropagation();
    });

    // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø£Ù† Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡
    searchInput.setAttribute('data-auto-search-initialized', 'true');

    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
}

// Ø§Ø®ØªÙŠØ§Ø± Ø¨Ù„Ø¯
function selectCountry(country) {
    console.log('ğŸ™ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¥Ù„Ù‰:', country);

    // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    clearGlobalSearchOnNavigation();

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    resetPropertyTypeFilter();

    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø§Ù„ÙƒÙ„" Ø£Ø²Ù„ ÙƒÙ„ Ø§Ù„ÙÙ„Ø§ØªØ±
    if (!country || country === 'Ø§Ù„ÙƒÙ„') {
        currentCountry = null;
        currentProperty = null;
    } else {
        // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¨Ù„Ø¯ Ø¬Ø¯ÙŠØ¯ Ø£Ø²Ù„ ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
        if (currentCountry !== country) {
            currentCountry = country;
            currentProperty = null;
        } else {
            // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ø²Ù„ ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø·
            currentProperty = null;
        }
    }
    initCountryButtons();
    initPropertyList(currentCountry);
    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª
    updateMobilePropertyName();

    // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¥Ø¶Ø§ÙÙŠ
    setTimeout(() => {
        updateMobilePropertyName();
    }, 100);

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    saveAppState();
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
function addSelectedPropertyIndicator() {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
    const existingIndicator = document.querySelector('.selected-property-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯ØŒ Ù„Ø§ Ù†Ø¶ÙŠÙ Ù…Ø¤Ø´Ø±
    if (!currentProperty) {
        return;
    }

    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    let filteredCount = 0;
    if (properties && properties.length > 0) {
        let tempFiltered = properties.filter(property => property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentProperty);
        if (currentCountry) {
            tempFiltered = tempFiltered.filter(property => property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === currentCountry);
        }
        filteredCount = tempFiltered.length;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    const indicator = document.createElement('div');
    indicator.className = 'selected-property-indicator';

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ù„ÙŠÙ„Ø©
    const helpMessage = filteredCount === 0 ?
        '<div class="filter-help">ğŸ’¡ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>' :
        filteredCount < 5 ?
        '<div class="filter-help">ğŸ’¡ ÙŠØªÙ… Ø¹Ø±Ø¶ ÙˆØ­Ø¯Ø§Øª Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·</div>' : '';

    indicator.innerHTML = `
        <div class="selected-property-content">
            <div class="selected-property-info">
                <i class="fas fa-building"></i>
                <span>Ø¹Ø±Ø¶ Ø¹Ù‚Ø§Ø±: <strong>${currentProperty}</strong></span>
                ${currentCountry ? `<span class="selected-city">ÙÙŠ ${currentCountry}</span>` : ''}
                <span class="units-count">${filteredCount} ÙˆØ­Ø¯Ø©</span>
            </div>

        </div>
        ${helpMessage}
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¤Ø´Ø± Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    const contentDiv = document.getElementById('content');
    if (contentDiv) {
        contentDiv.parentNode.insertBefore(indicator, contentDiv);
    }
}

// Ù…Ø³Ø­ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø§Ø±
function clearPropertySelection() {
    console.log('ğŸ”„ Ù…Ø³Ø­ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø§Ø±');

    currentProperty = null;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    initPropertyList(currentCountry);

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    renderData();

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
    saveAppState();
}

// Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù‚Ø§Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
function selectProperty(propertyName) {
    console.log('ğŸ¢ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù‚Ø§Ø±:', propertyName, 'Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentProperty);

    // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
    clearGlobalSearchOnNavigation();

    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const currentSearchTerm = searchState.property;

    // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£Ø²Ù„ Ø§Ù„ÙÙ„ØªØ±
    if (currentProperty === propertyName) {
        currentProperty = null;
        console.log('ğŸ”„ Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±');
    } else {
        currentProperty = propertyName;
        console.log('âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±:', currentProperty);
    }

    // ØªØ­Ø¯ÙŠØ« ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ØªØ¹ÙƒØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
    console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry || 'Ø§Ù„ÙƒÙ„'}`);
    console.log(`ğŸ“Š Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©=${currentCountry}, Ø§Ù„Ø¹Ù‚Ø§Ø±=${currentProperty}, Ø§Ù„Ù†ÙˆØ¹=${currentPropertyTypeFilter}`);
    initPropertyList(currentCountry);

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if (currentSearchTerm) {
        setTimeout(() => {
            restorePropertySearchState(currentSearchTerm);
        }, 100);
    }

    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª
    updateMobilePropertyName();

    // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¥Ø¶Ø§ÙÙŠ
    setTimeout(() => {
        updateMobilePropertyName();
    }, 100);

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù‚Ø§Ø± (ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©)
    const sidebar = document.getElementById('sidebar');
    if (window.innerWidth <= 900) {
        sidebar.classList.remove('active');
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    updateAllFilterButtonsState();

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
    saveAppState();
}

// ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
function setStatusFilter(status, fromSearch = false) {
    console.log(`ğŸ”„ ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${status}`);

    filterStatus = status;

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù†Ù‡Ø§ ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹
    if (!fromSearch) {
        statusFilterAppliedFromSearch = false;
    }

    // ØªØ­Ø¯ÙŠØ« activeFilters Ø£ÙŠØ¶Ø§Ù‹
    activeFilters.status = status || '';

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹
    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    updateAllFilterButtonsState();

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateStatusButtonsState(status);

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
    saveAppState();

    console.log(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${status || 'Ø§Ù„ÙƒÙ„'}`);
}

// Ù…ØªØºÙŠØ± Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
let statusFilterProcessing = false;

// Ø¯Ø§Ù„Ø© toggle Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„
function toggleStatusFilter(status) {
    // Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„
    if (statusFilterProcessing) {
        console.log('â³ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†Ù‚Ø±...');
        return;
    }

    statusFilterProcessing = true;
    console.log(`ğŸ”„ Toggle ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${status}`);

    try {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙ„ØªØ± Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¦Ù‡
        if (filterStatus === status) {
            console.log(`âŒ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${status}`);
            setStatusFilter(null);
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨ØªØ·Ø¨ÙŠÙ‚Ù‡
            console.log(`âœ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${status}`);
            setStatusFilter(status);
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ toggle ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©:', error);
    } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ± Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±
        setTimeout(() => {
            statusFilterProcessing = false;
        }, 300);
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function updateStatusButtonsState(activeStatus) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡Ø§
    const statusButtons = document.querySelectorAll('.status-btn, .filter-btn[data-status]');

    statusButtons.forEach(btn => {
        const btnStatus = btn.getAttribute('data-status') || btn.textContent.trim();

        if (btnStatus === activeStatus) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const statusFilterButtons = document.querySelectorAll('.status-filter-modal .status-option');
    statusFilterButtons.forEach(btn => {
        const btnStatus = btn.getAttribute('data-status') || btn.textContent.trim();

        if (btnStatus === activeStatus) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

// ØªØ¨Ø¯ÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶
function toggleView(view) {
    currentView = view;

    const tableBtn = document.getElementById('table-btn');
    const cardsBtn = document.getElementById('cards-btn');

    if (view === 'table') {
        tableBtn.classList.add('active');
        cardsBtn.classList.remove('active');
    } else {
        tableBtn.classList.remove('active');
        cardsBtn.classList.add('active');
    }

    renderData();

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶
    saveAppState();
}

// ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const searchInput = document.getElementById('propertySearch');
    const totalContainer = document.getElementById('totalContainer');

    // ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ÙÙ‚Ø·
    if (window.innerWidth <= 900) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†Ø´Ø·
        if (sidebar.classList.contains('search-active') ||
            (searchInput && document.activeElement === searchInput)) {
            // Ù„Ø§ ØªØºÙ„Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« Ù†Ø´Ø·Ø§Ù‹
            console.log('ğŸ”’ Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± - Ø§Ù„Ø¨Ø­Ø« Ù†Ø´Ø·');
            return;
        }

        sidebar.classList.toggle('active');

        // ØªØ­Ø³ÙŠÙ† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„Ø¬ÙˆØ§Ù„Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        if (sidebar.classList.contains('active') && window.innerWidth <= 480) {
            setTimeout(() => adjustSidebarHeightForMobile(), 100);
        }

        // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        if (totalContainer) {
            if (sidebar.classList.contains('active')) {
                // Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                totalContainer.style.display = 'none';
                console.log('ğŸ“Š ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
            } else {
                // Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© - Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                totalContainer.style.display = '';
                console.log('ğŸ“Š ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
            }
        }
    }
    // ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø§Ù„Ù€ sidebar Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¸Ø§Ù‡Ø±
}


// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù€ sidebar Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
function initializeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const main = document.querySelector('main');
    const footer = document.querySelector('footer');

    if (window.innerWidth > 900) {
        // ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©: Ø§Ù„Ù€ sidebar Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¸Ø§Ù‡Ø±
        sidebar.classList.add('active');

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªØ£ÙƒØ¯
        sidebar.style.position = 'fixed';
        sidebar.style.top = '70px';
        sidebar.style.right = '0';
        sidebar.style.width = '280px';
        sidebar.style.height = 'calc(100vh - 70px)';
        sidebar.style.transform = 'translateX(0)';
        sidebar.style.zIndex = '900';
        sidebar.style.backgroundColor = 'white';
        sidebar.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';
        sidebar.style.overflowY = 'auto';
        sidebar.style.padding = '1rem';

        document.body.classList.add('desktop-layout');

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„ØµØ­ÙŠØ­Ø©
        if (main) {
            main.style.marginRight = '280px';
            main.style.marginLeft = '20px';
            main.style.width = 'calc(100vw - 320px)';
            main.style.boxSizing = 'border-box';
        }
        if (footer) {
            footer.style.marginRight = '280px';
            footer.style.marginLeft = '20px';
            footer.style.width = 'calc(100vw - 320px)';
            footer.style.boxSizing = 'border-box';
        }
    } else {
        // ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©: Ø§Ù„Ù€ sidebar Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
        sidebar.classList.remove('active');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
        sidebar.style.position = 'fixed';
        sidebar.style.top = '0';
        sidebar.style.right = '0';
        sidebar.style.width = '100%';
        sidebar.style.height = '100vh';
        sidebar.style.transform = 'translateX(100%)';
        sidebar.style.zIndex = '1500';

        document.body.classList.remove('desktop-layout');

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
        if (main) {
            main.style.marginRight = '0';
            main.style.marginLeft = '0';
            main.style.width = '100%';

            // ØªØ­Ø³ÙŠÙ† padding Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¹ Ù‡ÙˆØ§Ù…Ø´ Ø¬Ø§Ù†Ø¨ÙŠØ©
            if (window.innerWidth <= 480) {
                main.style.padding = '0.5rem 0.75rem';
            } else if (window.innerWidth <= 360) {
                main.style.padding = '0.5rem 0.75rem';
            } else {
                main.style.padding = '1rem 0.75rem';
            }
        }
        if (footer) {
            footer.style.marginRight = '0';
            footer.style.marginLeft = '0';
            footer.style.width = '100%';
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„Ø¬ÙˆØ§Ù„Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
function adjustSidebarHeightForMobile() {
    const sidebar = document.getElementById('sidebar');
    if (!sidebar || !sidebar.classList.contains('active')) return;

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙØ¹Ù„ÙŠ
    const viewportHeight = window.innerHeight;
    const visualViewportHeight = window.visualViewport ? window.visualViewport.height : viewportHeight;

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ
    sidebar.style.height = `${Math.min(viewportHeight, visualViewportHeight)}px`;
    sidebar.style.maxHeight = `${Math.min(viewportHeight, visualViewportHeight)}px`;

    // ØªØ­Ø¯ÙŠØ« Ø§Ø±ØªÙØ§Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const propertyList = sidebar.querySelector('#propertyList');
    if (propertyList) {
        const headerHeight = sidebar.querySelector('.sidebar-header')?.offsetHeight || 60;
        const searchHeight = sidebar.querySelector('.property-search-container')?.offsetHeight || 60;
        const buttonHeight = sidebar.querySelector('.hide-sidebar-btn')?.offsetHeight || 48;

        const availableHeight = Math.min(viewportHeight, visualViewportHeight) - headerHeight - searchHeight - buttonHeight - 20;
        propertyList.style.maxHeight = `${Math.max(200, availableHeight)}px`;
    }

    console.log(`ğŸ“± ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø©: ${Math.min(viewportHeight, visualViewportHeight)}px`);
}

// Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
window.addEventListener('resize', function() {
    initializeSidebar();

    // ØªØ­Ø³ÙŠÙ† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„Ø¬ÙˆØ§Ù„Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
    if (window.innerWidth <= 480) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar && sidebar.classList.contains('active')) {
            setTimeout(() => adjustSidebarHeightForMobile(), 100);
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
    setTimeout(() => {
        updateMobilePropertyName();
    }, 100);
});

// Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© (Ù„Ù„Ø¬ÙˆØ§Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØ®ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)
if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', function() {
        if (window.innerWidth <= 480) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('active')) {
                setTimeout(() => adjustSidebarHeightForMobile(), 50);
            }
        }
    });
}

// Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - ÙØ­Øµ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±...');

    // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    setTimeout(() => {
        ensureClearButtonsVisibility();

        // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
        if (window.innerWidth <= 768) {
            const mobileContainer = document.getElementById('activeFiltersListMobile');
            const mobileFiltersModal = document.querySelector('.mobile-filters-modal');

            if (mobileContainer) {
                console.log('ğŸ“± ÙØ­Øµ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©...');
                const clearBtn = mobileContainer.querySelector('.clear-all-filters-btn');
                if (clearBtn) {
                    clearBtn.style.display = 'flex';
                    clearBtn.style.visibility = 'visible';
                    clearBtn.style.opacity = '1';
                    console.log('âœ… ØªÙ… Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©');
                }
            }

            if (mobileFiltersModal) {
                console.log('ğŸ“± ÙØ­Øµ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©...');
                const clearBtn = mobileFiltersModal.querySelector('.clear-all-filters-btn');
                if (clearBtn) {
                    clearBtn.style.display = 'flex';
                    clearBtn.style.visibility = 'visible';
                    clearBtn.style.opacity = '1';
                    console.log('âœ… ØªÙ… Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
                }
            }
        }
    }, 500);
});

// Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const searchInput = document.getElementById('propertySearch');

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± ÙˆÙ„ÙŠØ³ Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    if (sidebar && !sidebar.contains(e.target) &&
        !e.target.closest('.toggle-sidebar-btn') &&
        !e.target.closest('#mobile-property-btn') &&
        window.innerWidth <= 900) {

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†Ø´Ø·
        if (sidebar.classList.contains('search-active') ||
            (searchInput && document.activeElement === searchInput)) {
            // Ù„Ø§ ØªØºÙ„Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« Ù†Ø´Ø·Ø§Ù‹
            console.log('ğŸ”’ Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± - Ø§Ù„Ø¨Ø­Ø« Ù†Ø´Ø·');
            return;
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø¨Ø­Ø« Ù†Ø´Ø·Ø§Ù‹
        sidebar.classList.remove('active');
    }
});

// Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¨Ø­Ø« Ù…Ù† Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ù…Ø³
document.addEventListener('touchstart', function(e) {
    const sidebar = document.getElementById('sidebar');
    const searchInput = document.getElementById('propertySearch');

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ù…Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«ØŒ Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø±
    if (searchInput && (e.target === searchInput || searchInput.contains(e.target))) {
        e.stopPropagation();
        if (sidebar) {
            sidebar.classList.add('search-active');
        }
    }
});

// ØªÙ‡ÙŠØ¦Ø© ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
function initDateFilter() {
  // ØªÙ‡ÙŠØ¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ§Ø±ÙŠØ®
  const yearSelect = document.getElementById('filterYear');
  const monthSelect = document.getElementById('filterMonth');
  const daySelect = document.getElementById('filterDay');
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù†ÙˆØ§Øª
  for (let year = 2020; year <= 2100; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø´Ù‡Ø±
  const months = [
    'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø¥Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
    'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
  ];
  months.forEach((month, index) => {
    const option = document.createElement('option');
    option.value = index + 1;
    option.textContent = month;
    monthSelect.appendChild(option);
  });
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙŠØ§Ù…
  for (let day = 1; day <= 31; day++) {
    const option = document.createElement('option');
    option.value = day;
    option.textContent = day;
    daySelect.appendChild(option);
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  document.querySelector('.apply-filter-btn').addEventListener('click', applyDateFilter);
  document.querySelector('.clear-filter-btn').addEventListener('click', clearDateFilter);
  
  // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ§Ø±ÙŠØ®
  document.getElementById('filterType').addEventListener('change', updateDateFilterOptions);
}

// ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
function updateDateFilterOptions() {
  dateFilterType = document.getElementById('filterType').value;
  renderData();
}

// ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
function applyDateFilter() {
  dateFilterType = document.getElementById('filterType').value;
  dateFilterDay = document.getElementById('filterDay').value;
  dateFilterMonth = document.getElementById('filterMonth').value;
  dateFilterYear = document.getElementById('filterYear').value;
  
  renderData();
}

// Ù…Ø³Ø­ ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
function clearDateFilter() {
  dateFilterType = '';
  dateFilterDay = '';
  dateFilterMonth = '';
  dateFilterYear = '';
  
  document.getElementById('filterType').value = '';
  document.getElementById('filterDay').value = '';
  document.getElementById('filterMonth').value = '';
  document.getElementById('filterYear').value = '';
  
  renderData();
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function renderData() {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  if (!properties || properties.length === 0) {
    console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶');
    const container = document.getElementById('content');
    if (container) {
      container.innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #666;">
          <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: #f39c12;"></i>
          <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</h3>
          <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</p>
          <button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 1rem;">
            Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
          </button>
        </div>
      `;
    }
    return;
  }

  let filteredData = properties;

  // ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø´Ø§Ù…Ù„ Ø¬Ù…ÙŠØ¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø£Ùˆ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø·
  if (dateFilterType && (dateFilterDay || dateFilterMonth || dateFilterYear)) {
    filteredData = filteredData.filter(property => {
      let datesToCheck = [];

      if (dateFilterType === 'start') {
        // ÙŠØ´Ù…Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ¬Ù…ÙŠØ¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
        if (property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']) datesToCheck.push(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']);
        // Ø¬Ù…ÙŠØ¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (ÙŠØ¯Ø¹Ù…: ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„ØŒ Ø§Ù„Ø«Ø§Ù†ÙŠØŒ Ø§Ù„Ø«Ø§Ù„Ø« ... Ø§Ù„Ø®)
        Object.keys(property).forEach(key => {
          if (/^ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø·( |_)?(Ø§Ù„Ø§ÙˆÙ„|Ø§Ù„Ø«Ø§Ù†ÙŠ|Ø§Ù„Ø«Ø§Ù„Ø«|Ø§Ù„Ø±Ø§Ø¨Ø¹|Ø§Ù„Ø®Ø§Ù…Ø³|Ø§Ù„Ø³Ø§Ø¯Ø³|\d+)$/i.test(key) && property[key]) {
            datesToCheck.push(property[key]);
          }
        });
      } else if (dateFilterType === 'end') {
        // ÙŠØ´Ù…Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙˆØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·
        if (property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']) datesToCheck.push(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']);
        if (property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·']) datesToCheck.push(property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·']);
      }

      if (datesToCheck.length === 0) return false;

      // Ø¥Ø°Ø§ Ø£ÙŠ ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø·Ø§Ø¨Ù‚
      return datesToCheck.some(dateStr => {
        const date = parseDate(dateStr);
        if (!date) return false;
        if (dateFilterYear && date.getFullYear() !== parseInt(dateFilterYear)) return false;
        if (dateFilterMonth && (date.getMonth() + 1) !== parseInt(dateFilterMonth)) return false;
        if (dateFilterDay && date.getDate() !== parseInt(dateFilterDay)) return false;
        return true;
      });
    });
  }
  
  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
  if (currentCountry) {
    const beforeCount = filteredData.length;
    filteredData = filteredData.filter(property => property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === currentCountry);
    console.log(`ğŸ™ï¸ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© "${currentCountry}": ${beforeCount} â†’ ${filteredData.length} ÙˆØ­Ø¯Ø©`);
  }

  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø¨Ø§Ù†ÙŠ/Ø£Ø±Ø§Ø¶ÙŠ)
  if (currentPropertyTypeFilter) {
    filteredData = filteredData.filter(property => {
      const propertyType = property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'];
      // ØªØ­Ø¯ÙŠØ«: "Ø­ÙˆØ´" Ø£ØµØ¨Ø­ ÙŠÙØ¹ØªØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆÙ„ÙŠØ³ Ù…Ù† Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
      const isLandType = propertyType === 'Ø£Ø±Ø¶';

      if (currentPropertyTypeFilter === 'lands') {
        return isLandType;
      } else if (currentPropertyTypeFilter === 'buildings') {
        return !isLandType;
      }
      return true;
    });
    console.log(`ğŸ—ï¸ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± ${currentPropertyTypeFilter === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'} - Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${filteredData.length} ÙˆØ­Ø¯Ø©`);
  }

  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù‚Ø§Ø±
  if (currentProperty) {
    filteredData = filteredData.filter(property => property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentProperty);
  }
  
  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
  if (filterStatus) {
    filteredData = filteredData.filter(property => {
      const status = calculateStatus(property);
      return status.final === filterStatus;
    });
  }

  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ
  if (activeFilters.owner) {
    filteredData = filteredData.filter(property => {
      return property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === activeFilters.owner;
    });
  }
  
  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‡Ø±Ù…ÙŠ ÙˆØ§Ù„Ù…ØªØ¹Ø¯Ø¯ ÙˆØ§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª)
  const searchTerm = getGlobalSearchTerm();
  if (searchTerm && searchTerm.trim()) {
    console.log(`ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…: "${searchTerm}"`);

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    if (typeof performAdvancedSearch === 'function') {
      filteredData = performAdvancedSearch(searchTerm, filteredData);
      console.log(`ğŸ¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${filteredData.length} Ø³Ø¬Ù„`);
    } else {
      // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
      const searchTermLower = searchTerm.toLowerCase();
      const isHierarchicalSearch = searchTermLower.includes('//');
      const isMultiSearch = searchTermLower.includes('+') && !isHierarchicalSearch;

      if (isHierarchicalSearch) {
        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‡Ø±Ù…ÙŠ (ÙƒØ§Ù† ///)
        const searchTerms = searchTermLower.split('//').map(term => normalizeArabicText(term.trim())).filter(term => term.length > 0);
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‡Ø±Ù…ÙŠ (Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…): ${searchTerms.length} Ù…Ø³ØªÙˆÙŠØ§Øª:`, searchTerms);

        let currentResults = filteredData;
        for (let i = 0; i < searchTerms.length; i++) {
          const term = searchTerms[i];
          console.log(`ğŸ” Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${i + 1}: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "${term}" ÙÙŠ ${currentResults.length} Ø³Ø¬Ù„`);

          currentResults = currentResults.filter(property => {
            return searchInPropertyData(property, term);
          });

          console.log(`ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${i + 1}: ${currentResults.length} Ø³Ø¬Ù„`);

          if (currentResults.length === 0) {
            console.log(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${i + 1}ØŒ ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø­Ø«`);
            break;
          }
        }
        filteredData = currentResults;

      } else if (isMultiSearch) {
        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (ÙƒØ§Ù† //)
        const searchTerms = searchTermLower.split('+').map(term => normalizeArabicText(term.trim())).filter(term => term.length > 0);
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…): ${searchTerms.length} Ù…ØµØ·Ù„Ø­Ø§Øª:`, searchTerms);

        filteredData = filteredData.filter(property => {
          return searchTerms.some(term => {
            return searchInPropertyData(property, term);
          });
        });

        console.log(`ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ¹Ø¯Ø¯: ${filteredData.length} Ø³Ø¬Ù„`);

      } else {
        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        const normalizedSearchTerm = normalizeArabicText(searchTermLower);
        filteredData = filteredData.filter(property => {
          return searchInPropertyData(property, normalizedSearchTerm);
        });
        console.log(`ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠ: ${filteredData.length} Ø³Ø¬Ù„`);
      }
    }
  }
  
  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
  if (contractTypeFilter) {
    if (contractTypeFilter === 'Ø±Ø§ÙƒØ¶') {
      // ÙÙ„ØªØ± "Ø±Ø§ÙƒØ¶" ÙŠØ¹Ù†ÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (Ù„ÙŠØ³Øª Ø³ÙƒÙ†ÙŠ ÙˆÙ„Ø§ Ø¶Ø±ÙŠØ¨ÙŠ)
      filteredData = filteredData.filter(property => {
        const contractType = property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'];
        return !contractType || (contractType !== 'Ø³ÙƒÙ†ÙŠ' && contractType !== 'Ø¶Ø±ÙŠØ¨ÙŠ');
      });
    } else {
      // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø³ÙƒÙ†ÙŠ Ø£Ùˆ Ø¶Ø±ÙŠØ¨ÙŠ)
      filteredData = filteredData.filter(property => property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === contractTypeFilter);
    }
  }

  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
  if (propertyTypeFilter) {
    filteredData = filteredData.filter(property => property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyTypeFilter);
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ù„ØªØµØ¯ÙŠØ±
  filteredProperties = [...filteredData];

  // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ±
  updateExportButtonsText();

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  addSelectedPropertyIndicator();

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  renderTotals(filteredData);
  renderMobileTotals(filteredData);
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶
  if (currentView === 'table') {
    renderTable(filteredData);
  } else {
    renderCards(filteredData);
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ†Ù‚Ù„Ø©
  updateMobileMenuCounts(filteredData);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„Ù…ØµØ·Ù„Ø­ ØªØ§Ø±ÙŠØ®
function isDateSearchTerm(term) {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø±Ù‚Ø§Ù… ÙˆØ´Ø±Ø·Ø© Ù…Ø§Ø¦Ù„Ø©
  return /\d+\/\d+\/\d+/.test(term) || /\d+\/\d+/.test(term);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø±Ù† ÙÙŠ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
function matchesDateFlexibly(valueStr, searchTerm) {
  // ØªÙ†Ø¸ÙŠÙ Ù…ØµØ·Ù„Ø­ Ø§Ù„Ø¨Ø­Ø«
  const cleanSearchTerm = searchTerm.trim();

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® ÙƒØ§Ù…Ù„ (ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø©)
  if (/^\d+\/\d+\/\d+$/.test(cleanSearchTerm)) {
    const searchParts = cleanSearchTerm.split('/');
    const searchDay = parseInt(searchParts[0]);
    const searchMonth = parseInt(searchParts[1]);
    const searchYear = parseInt(searchParts[2]);

    // ØªÙƒÙˆÙŠÙ† ØµÙŠØº Ù…Ø®ØªÙ„ÙØ© Ù„Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    const dateFormats = [
      `${searchDay}/${searchMonth}/${searchYear}`,           // 1/5/2025
      `${searchDay.toString().padStart(2, '0')}/${searchMonth.toString().padStart(2, '0')}/${searchYear}`, // 01/05/2025
      `${searchDay}/${searchMonth.toString().padStart(2, '0')}/${searchYear}`,  // 1/05/2025
      `${searchDay.toString().padStart(2, '0')}/${searchMonth}/${searchYear}`,  // 01/5/2025
    ];

    return dateFormats.some(format => valueStr.includes(format));
  }

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø´Ù‡Ø±/Ø³Ù†Ø© ÙÙ‚Ø·
  if (/^\d+\/\d+$/.test(cleanSearchTerm)) {
    const searchParts = cleanSearchTerm.split('/');
    const searchMonth = parseInt(searchParts[0]);
    const searchYear = parseInt(searchParts[1]);

    const monthYearFormats = [
      `/${searchMonth}/${searchYear}`,                        // /5/2025
      `/${searchMonth.toString().padStart(2, '0')}/${searchYear}`, // /05/2025
    ];

    return monthYearFormats.some(format => valueStr.includes(format));
  }

  return false;
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ†Ù‚Ù„Ø©
function updateMobileMenuCounts(data) {
    // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©Ø§Ù†
    const countries = new Set();
    properties.forEach(property => {
        if (property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©) {
            countries.add(property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©);
        }
    });
    document.getElementById('countryCount').textContent = countries.size;
    
    // Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const uniqueProperties = new Set();
    data.forEach(property => {
        if (property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
            uniqueProperties.add(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
        }
    });
    document.getElementById('propertyCount').textContent = uniqueProperties.size;
    
    // Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    let filterCount = 0;
    if (currentCountry) filterCount++;
    if (currentProperty) filterCount++;
    if (filterStatus) filterCount++;
    document.getElementById('filterCount').textContent = filterCount || '';

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    updateAllFilterButtonsState();
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ¦Ø© Ù…Ø¹ÙŠÙ†Ø© (Ù…Ø¨Ø§Ù†ÙŠ Ø£Ùˆ Ø£Ø±Ø§Ø¶ÙŠ)
function calculateCategoryStats(data, isLandCategory) {
    let totalUnits = 0;
    let emptyUnits = 0;
    let tenants = 0;
    let rentedUnits = 0;
    let commercialUnits = 0; // Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠØ©
    let residentialUnits = 0; // Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©
    let pendingUnits = 0; // Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¶Ø© (ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©)

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
    const uniqueUnits = new Set();
    const uniqueContracts = {};

    data.forEach(property => {
        const propertyType = property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        // ØªØ­Ø¯ÙŠØ«: "Ø­ÙˆØ´" Ø£ØµØ¨Ø­ ÙŠÙØ¹ØªØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆÙ„ÙŠØ³ Ù…Ù† Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
        const isLandType = propertyType === 'Ø£Ø±Ø¶';

        // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if (isLandCategory !== isLandType) {
            return; // ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ù† Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        }

        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
        const unitKey = `${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;
        if (property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] && property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toString().trim() !== '') {
            uniqueUnits.add(unitKey);
        }

        // Ø­Ø³Ø§Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯ (Ø¶Ø±ÙŠØ¨ÙŠØŒ Ø³ÙƒÙ†ÙŠØŒ Ø£Ùˆ Ø±Ø§ÙƒØ¶)
        const contractType = property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'];
        if (contractType === 'Ø¶Ø±ÙŠØ¨ÙŠ') {
            commercialUnits++;
        } else if (contractType === 'Ø³ÙƒÙ†ÙŠ') {
            residentialUnits++;
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¶Ø±ÙŠØ¨ÙŠ Ø£Ùˆ Ø³ÙƒÙ†ÙŠØŒ ÙÙ‡Ùˆ Ø±Ø§ÙƒØ¶ (ØºÙŠØ± Ù…Ø­Ø¯Ø¯)
            pendingUnits++;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
        if (!property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].toString().trim() === '') {
            emptyUnits++;
            return;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (Ø¹Ù‚ÙˆØ¯ ÙØ±ÙŠØ¯Ø©)
        const contractKey = property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'];
        if (contractKey && contractKey.toString().trim() !== '' && !uniqueContracts[contractKey]) {
            uniqueContracts[contractKey] = true;
            tenants++;
        }
    });

    totalUnits = uniqueUnits.size;
    rentedUnits = totalUnits - emptyUnits;

    return {
        totalUnits,
        emptyUnits,
        tenants,
        rentedUnits,
        commercialUnits,
        residentialUnits,
        pendingUnits
    };
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø°ÙƒÙŠ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
function renderTotals(data) {
    const container = document.getElementById('totalContainer');
    container.innerHTML = '';

    const today = new Date();
    let countEmpty = 0, countExpired = 0, countPending = 0, countActive = 0;
    let totalCommercial = 0, totalResidential = 0;
    let tenantsCount = 0;

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
    const uniqueContracts = {};
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ø¹Ù‚Ø¯ ÙˆØ§Ø­Ø¯ = Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ø­Ø¯)
    const uniqueContractStatuses = {};

    data.forEach(property => {
        // Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
        if (!property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].toString().trim() === '') {
            countEmpty++;
            return;
        }

        // Ø§Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙƒÙ…ÙØªØ§Ø­ ÙØ±ÙŠØ¯
        const contractKey = property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'];

        // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… Ø¹Ù‚Ø¯ ØµØ­ÙŠØ­
        if (!contractKey || contractKey.toString().trim() === '') {
            return;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© ÙÙ‚Ø· (Ø¹Ù‚Ø¯ ÙˆØ§Ø­Ø¯ = Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ø­Ø¯)
        if (!uniqueContractStatuses[contractKey]) {
            const status = calculateStatus(property);
            uniqueContractStatuses[contractKey] = status.final;

            if (status.final === 'ÙØ¹Ø§Ù„') {
                countActive++;
            } else if (status.final === 'Ù…Ù†ØªÙ‡Ù‰') {
                countExpired++;
            } else if (status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') {
                countPending++;
            }
        }

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ù‚Ø¨Ù„
        if (!uniqueContracts[contractKey]) {
            uniqueContracts[contractKey] = true;

            // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø©)
            tenantsCount++;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙÙ‚Ø· Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·Ø© (ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ)
            const status = calculateStatus(property);
            if (status.final === 'ÙØ¹Ø§Ù„' || status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') {
                const smartTotal = calculateSmartTotal(property);
                const totalAmount = smartTotal.amount;

                if (property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ') {
                    totalCommercial += totalAmount;
                } else {
                    totalResidential += totalAmount;
                }
            }
        }
    });

    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
    const uniqueUnits = new Set();
    data.forEach(property => {
        const unitKey = `${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;
        if (property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] && property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toString().trim() !== '') {
            uniqueUnits.add(unitKey);
        }
    });

    const totalUnits = uniqueUnits.size;
    const activeCount = totalUnits - countEmpty;
    const taxableBase = totalCommercial / 1.15;
    const vat = taxableBase * 0.15;
    const afterTaxCommercial = taxableBase + vat;

    // ØªØ´Ø®ÙŠØµ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    console.log('ğŸ“Š ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:');
    console.log(`   Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†: ${tenantsCount}`);
    console.log(`   Ø§Ù„ÙØ¹Ø§Ù„: ${countActive}`);
    console.log(`   Ø¹Ù„Ù‰ ÙˆØ´Ùƒ: ${countPending}`);
    console.log(`   Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ: ${countExpired}`);
    console.log(`   Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${countActive + countPending + countExpired}`);
    console.log(`   Ø§Ù„ÙØ±Ù‚: ${tenantsCount - (countActive + countPending + countExpired)}`);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    if (window.innerWidth > 900) {
        console.log('ğŸ—ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©');
        console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:', data.length);

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø¨Ø§Ù†ÙŠ vs Ø£Ø±Ø§Ø¶ÙŠ)
        const buildingStats = calculateCategoryStats(data, false); // Ù…Ø¨Ø§Ù†ÙŠ (ØªØ´Ù…Ù„ Ø­ÙˆØ´ Ø§Ù„Ø¢Ù†)
        const landStats = calculateCategoryStats(data, true); // Ø£Ø±Ø§Ø¶ÙŠ (Ø£Ø±Ø¶ ÙÙ‚Ø·)

        console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ:', buildingStats);
        console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ:', landStats);
        console.log('ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', buildingStats.totalUnits + landStats.totalUnits);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ
        const buildingLandStatsCard = document.createElement('div');
        buildingLandStatsCard.className = 'total-card building-land-stats';
        buildingLandStatsCard.innerHTML = `
            <h3><i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ</h3>
            <div class="building-land-table-container">
                <table class="building-land-stats-table">
                    <thead>
                        <tr>
                            <th class="metric-header">Ø§Ù„Ù…Ø¤Ø´Ø±</th>
                            <th class="buildings-header">Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</th>
                            <th class="lands-header">Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ</th>
                            <th class="total-header">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="metric-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</td>
                            <td class="buildings-value">${buildingStats.totalUnits}</td>
                            <td class="lands-value">${landStats.totalUnits}</td>
                            <td class="total-value">${buildingStats.totalUnits + landStats.totalUnits}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙØ§Ø±ØºØ©</td>
                            <td class="buildings-value">${buildingStats.emptyUnits}</td>
                            <td class="lands-value">${landStats.emptyUnits}</td>
                            <td class="total-value clickable-empty-units" style="cursor: pointer;">
                                <i class="fas fa-minus-circle" style="color: #28a745; margin-left: 5px;"></i> ${buildingStats.emptyUnits + landStats.emptyUnits}
                            </td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</td>
                            <td class="buildings-value">${buildingStats.tenants}</td>
                            <td class="lands-value">${landStats.tenants}</td>
                            <td class="total-value">${buildingStats.tenants + landStats.tenants}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©</td>
                            <td class="buildings-value">${buildingStats.rentedUnits}</td>
                            <td class="lands-value">${landStats.rentedUnits}</td>
                            <td class="total-value">${buildingStats.rentedUnits + landStats.rentedUnits}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠØ©</td>
                            <td class="buildings-value">${buildingStats.commercialUnits}</td>
                            <td class="lands-value">${landStats.commercialUnits}</td>
                            <td class="total-value">${buildingStats.commercialUnits + landStats.commercialUnits}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</td>
                            <td class="buildings-value">${buildingStats.residentialUnits}</td>
                            <td class="lands-value">${landStats.residentialUnits}</td>
                            <td class="total-value">${buildingStats.residentialUnits + landStats.residentialUnits}</td>
                        </tr>
                        ${(buildingStats.pendingUnits + landStats.pendingUnits) > 0 ? `
                        <tr>
                            <td class="metric-label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¶Ø©</td>
                            <td class="buildings-value">${buildingStats.pendingUnits}</td>
                            <td class="lands-value">${landStats.pendingUnits}</td>
                            <td class="total-value">${buildingStats.pendingUnits + landStats.pendingUnits}</td>
                        </tr>` : ''}
                    </tbody>
                </table>
            </div>
        `;
        container.appendChild(buildingLandStatsCard);

        // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯
        const statusCard = document.createElement('div');
        statusCard.className = 'total-card';
        statusCard.innerHTML = `
            <h3><i class="fas fa-chart-pie"></i> Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯</h3>
            <div style="font-size: 11px; color: #6c757d; margin-bottom: 8px; text-align: center;">
                <i class="fas fa-info-circle"></i> Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØ´Ù…Ù„: Ø§Ù„ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            </div>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value" style="color: #28a745;">${countActive + countPending}</div>
                    <div class="stat-label">Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #28a745;">${countActive}</div>
                    <div class="stat-label">Ø§Ù„ÙØ¹Ø§Ù„</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #fd7e14;">${countPending}</div>
                    <div class="stat-label">Ø¹Ù„Ù‰ ÙˆØ´Ùƒ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #dc3545;">${countExpired}</div>
                    <div class="stat-label">Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ</div>
                </div>
            </div>
        `;
        container.appendChild(statusCard);

        // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        const financialCard = document.createElement('div');
        financialCard.className = 'total-card';
        financialCard.innerHTML = `
            <h3><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
            <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px; text-align: center;">
                <i class="fas fa-info-circle"></i> ÙŠØ´Ù…Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ¹Ø§Ù„Ø© ÙˆØ¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙ‚Ø·
            </div>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value" style="color: #2a4b9b;">${taxableBase.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="stat-label">ØªØ¬Ø§Ø±ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #e46e6d;">${vat.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="stat-label">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #05940e;">${afterTaxCommercial.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="stat-label">ØªØ¬Ø§Ø±ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #f59e42;">${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³ÙƒÙ†ÙŠ</div>
                </div>
            </div>
        `;
        container.appendChild(financialCard);

        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ ØªØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    } else {
        // Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…
        addTotalItem(container, 'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª', totalUnits, 'units-stat');
        addTotalItem(container, 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†', tenantsCount, 'tenants-stat');
        addTotalItem(container, 'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©', `<i class=\"fas fa-minus-circle\" style=\"color:#28a745; margin-left: .1px;\"></i> ${countEmpty}`, 'empty-stat clickable-empty-units');
        addTotalItem(container, 'Ù†Ø´Ø· (ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ)', `<i class=\"fas fa-users\" style=\"color:#28a745;\"></i> ${countActive + countPending}`, 'current-stat');
        addTotalItem(container, 'Ø§Ù„ÙØ¹Ø§Ù„', countActive, 'active-stat');
        addTotalItem(container, 'Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ', countExpired, 'expired-stat');
        addTotalItem(container, 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ', countPending, 'pending-stat');
        addTotalItem(container, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ¬Ø§Ø±ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©', `<i class=\"fas fa-cash-register\" style=\"color:#2a4b9b;\"></i> ${taxableBase.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„`, 'taxable-base-stat');
        addTotalItem(container, 'Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠ', `<i class=\"fas fa-receipt\" style=\"color:#e46e6d;\"></i> ${vat.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„`, 'vat-stat');
        addTotalItem(container, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ¬Ø§Ø±ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©', `<i class=\"fas fa-coins\" style=\"color:#05940e;\"></i> ${afterTaxCommercial.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„`, 'after-taxonly-stat');
        addTotalItem(container, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³ÙƒÙ†ÙŠ', `<i class=\"fas fa-home\" style=\"color:#f59e42;\"></i> ${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„`, 'residential-stat');
    }
    // Ø±Ù‚Ù… Ø§Ù„ØµÙƒ ÙˆÙ…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù‚Ø§Ø± (Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø· Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯)
    const uniqueContractsList = {};
    data.forEach(property => {
        // ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±Ø·: ÙŠÙƒÙÙŠ ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø·ØŒ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø±Ù‚Ù… Ø¹Ù‚Ø¯
        if (property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙƒÙ…ÙØªØ§Ø­ Ø£Ø³Ø§Ø³ÙŠØŒ Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯
            const contractKey = property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'no_contract';
            const key = `${contractKey}_${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`;
            if (!uniqueContractsList[key]) uniqueContractsList[key] = property;
        }
    });
    const uniqueList = Object.values(uniqueContractsList);
    if (currentProperty) {
        const firstDeedNumber = uniqueList.find(p => p['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] && p['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'].toString().trim() !== '');
        if (firstDeedNumber && firstDeedNumber['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ']) {
            addTotalItem(container, 'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ', `<i class=\"fas fa-file-alt\"></i> ${firstDeedNumber['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ']}`, 'deed-number-stat');
        }
        const firstDeedArea = uniqueList.find(p => p['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] && !isNaN(parseFloat(p['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'])));
        if (firstDeedArea && firstDeedArea['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']) {
            addTotalItem(container, 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ', `<i class=\"fas fa-ruler-combined\"></i> ${parseFloat(firstDeedArea['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']).toLocaleString()} Ù…Â²`, 'deed-area-stat');
        }
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ
        const firstSijil = uniqueList.find(p => p['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] && p['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '].toString().trim() !== '');
        if (firstSijil && firstSijil['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ']) {
            addTotalItem(container, 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ', `<i class=\"fas fa-book\"></i> ${firstSijil['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '].toString().trim()}`, 'deed-area-stat');
        }
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø¬ÙˆØ§Ù„Ø§Øª
function updateMobilePropertyName() {
    console.log('ğŸ¢ ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© - currentProperty:', currentProperty, 'currentCountry:', currentCountry);
    console.log('ğŸ“± Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©:', window.innerWidth);

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù†Ø§ ÙÙŠ Ø´Ø§Ø´Ø© Ø¬ÙˆØ§Ù„
    if (window.innerWidth > 900) {
        console.log('ğŸ“± Ù„ÙŠØ³ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ØµØ±');
        const propertyHeaderContainer = document.getElementById('mobilePropertyHeader');
        if (propertyHeaderContainer) {
            propertyHeaderContainer.style.display = 'none';
        }
        return;
    }

    const propertyHeaderContainer = document.getElementById('mobilePropertyHeader');
    const propertyTextElement = document.getElementById('mobilePropertyText');

    if (!propertyHeaderContainer || !propertyTextElement) {
        console.warn('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯
    if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„' && currentProperty.trim() !== '') {
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
        const cityName = currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„' ? currentCountry : 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†';

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø§Ù„Ø¹Ù‚Ø§Ø±"
        const displayText = `${cityName} - ${currentProperty}`;

        console.log('âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©:', displayText);
        propertyTextElement.textContent = displayText;
        propertyHeaderContainer.style.display = 'flex';
        propertyHeaderContainer.style.visibility = 'visible';
        propertyHeaderContainer.style.opacity = '1';

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¸Ù‡ÙˆØ±
        propertyHeaderContainer.style.animation = 'slideInFromTop 0.4s ease-out';

        // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø¸Ù‡ÙˆØ±
        setTimeout(() => {
            propertyHeaderContainer.style.display = 'flex';
        }, 50);
    } else {
        console.log('âŒ Ø¥Ø®ÙØ§Ø¡ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯');
        propertyHeaderContainer.style.display = 'none';
        propertyHeaderContainer.style.visibility = 'hidden';
        propertyHeaderContainer.style.opacity = '0';
    }
}



// Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ - Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø°ÙƒÙŠ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
function renderMobileTotals(data) {
    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹
    updateMobilePropertyName();

    const container = document.getElementById('mobileTotals');
    container.innerHTML = '';

    // Ø­Ø³Ø§Ø¨ Ù†ÙØ³ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    let countEmpty = 0, countExpired = 0, countPending = 0, countActive = 0;
    let totalCommercial = 0, totalResidential = 0;
    let tenantsCount = 0;

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø©
    const uniqueContracts = {};
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ø¹Ù‚Ø¯ ÙˆØ§Ø­Ø¯ = Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ø­Ø¯)
    const uniqueContractStatuses = {};

    data.forEach(property => {
        if (!property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].toString().trim() === '') {
            countEmpty++;
            return;
        }

        // Ø§Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙƒÙ…ÙØªØ§Ø­ ÙØ±ÙŠØ¯
        const contractKey = property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'];

        // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… Ø¹Ù‚Ø¯ ØµØ­ÙŠØ­
        if (!contractKey || contractKey.toString().trim() === '') {
            return;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© ÙÙ‚Ø· (Ø¹Ù‚Ø¯ ÙˆØ§Ø­Ø¯ = Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ø­Ø¯)
        if (!uniqueContractStatuses[contractKey]) {
            const status = calculateStatus(property);
            uniqueContractStatuses[contractKey] = status.final;

            if (status.final === 'ÙØ¹Ø§Ù„') {
                countActive++;
            } else if (status.final === 'Ù…Ù†ØªÙ‡Ù‰') {
                countExpired++;
            } else if (status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') {
                countPending++;
            }
        }

        if (!uniqueContracts[contractKey]) {
            uniqueContracts[contractKey] = true;
            tenantsCount++;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙ‚Ø· Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ¹Ø§Ù„Ø© ÙˆØ¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©)
            const status = calculateStatus(property);
            if (status.final === 'ÙØ¹Ø§Ù„' || status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') {
                const smartTotal = calculateSmartTotal(property);
                const totalAmount = smartTotal.amount;

                if (property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ') {
                    totalCommercial += totalAmount;
                } else {
                    totalResidential += totalAmount;
                }
            }
        }
    });

    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±) Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    const uniqueUnits = new Set();
    data.forEach(property => {
        const unitKey = `${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;
        if (property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] && property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toString().trim() !== '') {
            uniqueUnits.add(unitKey);
        }
    });

    const totalUnits = uniqueUnits.size;
    const activeCount = totalUnits - countEmpty;
    const taxableBase = totalCommercial / 1.15;
    const vat = taxableBase * 0.15;
    const afterTaxCommercial = taxableBase + vat;

    // 1. Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„) - Ø¬Ø¯ÙˆÙ„ Ù…Ù† 4 Ø£Ø¹Ù…Ø¯Ø©
    console.log('ğŸ—ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©');
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:', data.length);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø¨Ø§Ù†ÙŠ vs Ø£Ø±Ø§Ø¶ÙŠ)
    const buildingStats = calculateCategoryStats(data, false); // Ù…Ø¨Ø§Ù†ÙŠ (ØªØ´Ù…Ù„ Ø­ÙˆØ´ Ø§Ù„Ø¢Ù†)
    const landStats = calculateCategoryStats(data, true); // Ø£Ø±Ø§Ø¶ÙŠ (Ø£Ø±Ø¶ ÙÙ‚Ø·)

    console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ:', buildingStats);
    console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ:', landStats);
    console.log('ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', buildingStats.totalUnits + landStats.totalUnits);

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¹Ù†ÙˆØ§Ù†
    let headerText = 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ';
    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„') {
        if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
            headerText = `Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${currentProperty} - ${currentCountry}`;
        } else {
            headerText = `Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${currentCountry}`;
        }
    } else if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
        headerText = `Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${currentProperty}`;
    }

    const unitsSection = document.createElement('div');
    unitsSection.className = 'mobile-stats-section units-section';
    unitsSection.innerHTML = `
        <div class="section-header">
            <h3><i class="fas fa-chart-bar"></i> ${headerText}</h3>
        </div>
        <div class="section-content">
            <div class="building-land-table-container">
                <table class="building-land-stats-table mobile-table">
                    <thead>
                        <tr>
                            <th class="metric-header">Ø§Ù„Ù…Ø¤Ø´Ø±</th>
                            <th class="buildings-header">Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</th>
                            <th class="lands-header">Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ</th>
                            <th class="total-header">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="metric-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</td>
                            <td class="buildings-value">${buildingStats.totalUnits}</td>
                            <td class="lands-value">${landStats.totalUnits}</td>
                            <td class="total-value">${buildingStats.totalUnits + landStats.totalUnits}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙØ§Ø±ØºØ©</td>
                            <td class="buildings-value">${buildingStats.emptyUnits}</td>
                            <td class="lands-value">${landStats.emptyUnits}</td>
                            <td class="total-value clickable-empty-units" style="cursor: pointer;">
                                <i class="fas fa-minus-circle" style="color: #28a745; margin-left: 5px;"></i> ${buildingStats.emptyUnits + landStats.emptyUnits}
                            </td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</td>
                            <td class="buildings-value">${buildingStats.tenants}</td>
                            <td class="lands-value">${landStats.tenants}</td>
                            <td class="total-value">${buildingStats.tenants + landStats.tenants}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©</td>
                            <td class="buildings-value">${buildingStats.rentedUnits}</td>
                            <td class="lands-value">${landStats.rentedUnits}</td>
                            <td class="total-value">${buildingStats.rentedUnits + landStats.rentedUnits}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠØ©</td>
                            <td class="buildings-value">${buildingStats.commercialUnits}</td>
                            <td class="lands-value">${landStats.commercialUnits}</td>
                            <td class="total-value">${buildingStats.commercialUnits + landStats.commercialUnits}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</td>
                            <td class="buildings-value">${buildingStats.residentialUnits}</td>
                            <td class="lands-value">${landStats.residentialUnits}</td>
                            <td class="total-value">${buildingStats.residentialUnits + landStats.residentialUnits}</td>
                        </tr>
                        ${(buildingStats.pendingUnits + landStats.pendingUnits) > 0 ? `
                        <tr>
                            <td class="metric-label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¶Ø©</td>
                            <td class="buildings-value">${buildingStats.pendingUnits}</td>
                            <td class="lands-value">${landStats.pendingUnits}</td>
                            <td class="total-value">${buildingStats.pendingUnits + landStats.pendingUnits}</td>
                        </tr>` : ''}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    container.appendChild(unitsSection);

    // Ø¥Ø¶Ø§ÙØ© Ø®Ø· ÙØ§ØµÙ„
    const divider1 = document.createElement('div');
    divider1.className = 'mobile-stats-divider';
    container.appendChild(divider1);

    // 2. Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ) - Grid Ù…Ù† Ø¹Ù…ÙˆØ¯ÙŠÙ†
    let contractsHeaderText = 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯';
    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„') {
        if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
            contractsHeaderText = `Ø¹Ù‚ÙˆØ¯ ${currentProperty} - ${currentCountry}`;
        } else {
            contractsHeaderText = `Ø¹Ù‚ÙˆØ¯ ${currentCountry}`;
        }
    } else if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
        contractsHeaderText = `Ø¹Ù‚ÙˆØ¯ ${currentProperty}`;
    }

    const contractsSection = document.createElement('div');
    contractsSection.className = 'mobile-stats-section contracts-section';
    contractsSection.innerHTML = `
        <div class="section-header">
            <h3><i class="fas fa-file-contract"></i> ${contractsHeaderText}</h3>
        </div>
        <div class="section-content grid-two-columns">
            <div class="total-item current-stat">
                <span class="total-label">Ù†Ø´Ø· (ÙØ¹Ø§Ù„ + Ø¹Ù„Ù‰ ÙˆØ´Ùƒ)</span>
                <span class="total-value"><i class="fas fa-users" style="color:#28a745;"></i> ${countActive + countPending}</span>
            </div>
            <div class="total-item active-stat">
                <span class="total-label">Ø§Ù„ÙØ¹Ø§Ù„</span>
                <span class="total-value">${countActive}</span>
            </div>
            <div class="total-item pending-stat">
                <span class="total-label">Ø¹Ù„Ù‰ ÙˆØ´Ùƒ</span>
                <span class="total-value">${countPending}</span>
            </div>
            <div class="total-item expired-stat">
                <span class="total-label">Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ</span>
                <span class="total-value">${countExpired}</span>
            </div>
        </div>
    `;
    container.appendChild(contractsSection);

    // Ø¥Ø¶Ø§ÙØ© Ø®Ø· ÙØ§ØµÙ„
    const divider2 = document.createElement('div');
    divider2.className = 'mobile-stats-divider';
    container.appendChild(divider2);

    // 3. Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø«) - Grid Ù…Ù† Ø¹Ù…ÙˆØ¯ÙŠÙ†
    let financialHeaderText = 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©';
    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„') {
        if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
            financialHeaderText = `Ø§Ù„Ù…Ø§Ù„ÙŠØ§Øª - ${currentProperty} - ${currentCountry}`;
        } else {
            financialHeaderText = `Ø§Ù„Ù…Ø§Ù„ÙŠØ§Øª - ${currentCountry}`;
        }
    } else if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
        financialHeaderText = `Ø§Ù„Ù…Ø§Ù„ÙŠØ§Øª - ${currentProperty}`;
    }

    const financialSection = document.createElement('div');
    financialSection.className = 'mobile-stats-section financial-section';
    financialSection.innerHTML = `
        <div class="section-header">
            <h3><i class="fas fa-money-bill-wave"></i> ${financialHeaderText}</h3>
        </div>
        <div class="section-content grid-two-columns">
            <div class="total-item taxable-base-stat">
                <span class="total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ¬Ø§Ø±ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</span>
                <span class="total-value"><i class="fas fa-cash-register" style="color:#2a4b9b;"></i> ${taxableBase.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="total-item vat-stat">
                <span class="total-label">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</span>
                <span class="total-value"><i class="fas fa-receipt" style="color:#e46e6d;"></i> ${vat.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="total-item after-taxonly-stat">
                <span class="total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ¬Ø§Ø±ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</span>
                <span class="total-value"><i class="fas fa-coins" style="color:#05940e;"></i> ${afterTaxCommercial.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="total-item residential-stat">
                <span class="total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³ÙƒÙ†ÙŠ</span>
                <span class="total-value"><i class="fas fa-home" style="color:#f59e42;"></i> ${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</span>
            </div>
        </div>
    `;
    container.appendChild(financialSection);

    // Ø¥Ø¶Ø§ÙØ© Ø®Ø· ÙØ§ØµÙ„
    const divider3 = document.createElement('div');
    divider3.className = 'mobile-stats-divider';
    container.appendChild(divider3);

    // 4. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒÙˆÙƒ (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø¹)
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ ÙˆÙ„Ù„Ø¬ÙˆØ§Ù„ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯
    const shouldShowDeedInfo = !isMobileDevice() || currentProperty;

    console.log(`ğŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ - Ø§Ù„Ø¬Ù‡Ø§Ø²: ${isMobileDevice() ? 'Ø¬ÙˆØ§Ù„' : 'Ø´Ø§Ø´Ø© ÙƒØ¨ÙŠØ±Ø©'}, Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±: ${currentProperty || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}, Ø³ÙŠØªÙ… Ø§Ù„Ø¹Ø±Ø¶: ${shouldShowDeedInfo}`);

    if (shouldShowDeedInfo) {
        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù„Ù„ØµÙƒÙˆÙƒ (Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø· Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯)
        const uniqueContractsList = {};
        data.forEach(property => {
            // ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±Ø·: ÙŠÙƒÙÙŠ ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø·ØŒ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø±Ù‚Ù… Ø¹Ù‚Ø¯
            if (property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙƒÙ…ÙØªØ§Ø­ Ø£Ø³Ø§Ø³ÙŠØŒ Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯
                const contractKey = property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'no_contract';
                const key = `${contractKey}_${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`;
                if (!uniqueContractsList[key]) uniqueContractsList[key] = property;
            }
        });
        const uniqueList = Object.values(uniqueContractsList);

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ
        const firstDeedNumber = uniqueList.find(p => p['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] && p['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'].toString().trim() !== '');
        const firstDeedArea = uniqueList.find(p => p['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] && !isNaN(parseFloat(p['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'])));
        const firstSijil = uniqueList.find(p => p['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] && p['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '].toString().trim() !== '');

        // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØµÙƒÙˆÙƒ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        if (firstDeedNumber || firstDeedArea || firstSijil) {
            const deedsSection = document.createElement('div');
            deedsSection.className = 'mobile-stats-section deeds-section';

            let deedsContent = `
                <div class="section-header">
                    <h3><i class="fas fa-file-alt"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒÙˆÙƒ</h3>
                </div>
                <div class="section-content grid-two-columns">
            `;

            // Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„ØµÙƒ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯
            if (firstDeedNumber && firstDeedNumber['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ']) {
                deedsContent += `
                    <div class="total-item deed-number-stat">
                        <span class="total-label">Ø±Ù‚Ù… Ø§Ù„ØµÙƒ</span>
                        <span class="total-value"><i class="fas fa-file-contract" style="color:#dc3545;"></i> ${firstDeedNumber['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ']}</span>
                    </div>
                `;
            }

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª
            if (firstDeedArea && firstDeedArea['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']) {
                deedsContent += `
                    <div class="total-item deed-area-stat">
                        <span class="total-label">Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ</span>
                        <span class="total-value"><i class="fas fa-ruler-combined" style="color:#fd7e14;"></i> ${parseFloat(firstDeedArea['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']).toLocaleString()} Ù…Â²</span>
                    </div>
                `;
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯
            if (firstSijil && firstSijil['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ']) {
                deedsContent += `
                    <div class="total-item registry-stat">
                        <span class="total-label">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ</span>
                        <span class="total-value"><i class="fas fa-clipboard-list" style="color:#28a745;"></i> ${firstSijil['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '].toString().trim()}</span>
                    </div>
                `;
            }

            deedsContent += `
                </div>
            `;

            deedsSection.innerHTML = deedsContent;
            container.appendChild(deedsSection);
        }
    }

    // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯
}

// Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¥Ø­ØµØ§Ø¦ÙŠ
function addTotalItem(container, label, value, extraClass = '') {
    const item = document.createElement('div');
    item.className = 'total-item' + (extraClass ? ' ' + extraClass : '');
    item.innerHTML = `<span class="total-label">${label}:</span> <span class="total-value">${value}</span>`;
    container.appendChild(item);
}

// Ø­Ø³Ø§Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±
function parseDate(dateStr) {
    if (!dateStr) return null;

    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù†Øµ ÙˆØªÙ†Ø¸ÙŠÙ
    dateStr = String(dateStr).trim();

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ (Ù…Ø«Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ)
    let datePart = dateStr;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙˆÙ‚Øª (YYYY-MM-DD HH:MM:SS)ØŒ Ø£Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
    if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2}$/)) {
        datePart = dateStr.split(' ')[0];
    } else {
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ Ø¢Ø®Ø±
        datePart = dateStr.split(' ')[0];
        if (datePart.includes('(')) {
            datePart = datePart.split('(')[0].trim();
        }
    }

    let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');

    if (parts.length !== 3) return null;

    let day, month, year;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙˆÙ„ Ø¬Ø²Ø¡ 4 Ø£Ø±Ù‚Ø§Ù… ÙÙ‡Ùˆ Ø§Ù„Ø³Ù†Ø© (YYYY-MM-DD)
    if (parts[0].length === 4) {
        year = parseInt(parts[0]);
        month = parseInt(parts[1]);
        day = parseInt(parts[2]);
    } else {
        // ØªÙ†Ø³ÙŠÙ‚ DD/MM/YYYY Ø£Ùˆ DD-MM-YYYY
        day = parseInt(parts[0]);
        month = parseInt(parts[1]);
        year = parseInt(parts[2]);
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (isNaN(day) || isNaN(month) || isNaN(year) ||
        day < 1 || day > 31 ||
        month < 1 || month > 12 ||
        year < 1900 || year > 2100) {
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ parseDate: ${dateStr}`);
        return null;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ ØªØ¬Ù†Ø¨ timezone issues Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†ØªØµÙ Ø§Ù„Ù†Ù‡Ø§Ø±
    const testDate = new Date(year, month - 1, day, 12, 0, 0);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø´Ø£ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªÙˆØ§Ø±ÙŠØ® Ù…Ø«Ù„ 31 ÙØ¨Ø±Ø§ÙŠØ±)
    if (testDate.getFullYear() !== year || testDate.getMonth() !== (month - 1) || testDate.getDate() !== day) {
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­ ÙÙŠ parseDate: ${dateStr}`);
        return null;
    }

    return testDate;
}

function isSameDate(d1, d2) {
    return d1 && d2 &&
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();
}

function calculateStatus(property) {
    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    let actualInstallmentCount = 0;
    const propertyName = property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        if (property[dateKey] || property[amountKey]) {
            actualInstallmentCount = i; // Ù†Ø­ÙØ¸ Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù‚Ø³Ø· Ù…ÙˆØ¬ÙˆØ¯
            console.log(`ğŸ“Š ${propertyName}: ÙˆØ¬Ø¯ Ù‚Ø³Ø· Ø±Ù‚Ù… ${i} (${dateKey}: ${property[dateKey]}, ${amountKey}: ${property[amountKey]})`);
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ù‚Ø³Ø§Ø· ÙØ¹Ù„ÙŠØ©
    if (actualInstallmentCount > 0) {
        const oldCount = property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'];
        property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] = actualInstallmentCount;
        console.log(`âœ… ${propertyName}: ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù…Ù† ${oldCount} Ø¥Ù„Ù‰ ${actualInstallmentCount}`);
    } else {
        console.log(`âš ï¸ ${propertyName}: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø·`);
    }

    if (!property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || !property['Ø§Ù„Ù…Ø§Ù„Ùƒ']) {
        return { final: 'ÙØ§Ø±Øº', display: 'ÙØ§Ø±Øº', isInstallmentEnded: false };
    }

    const today = new Date();

    // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø· (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ¨Ù‚ÙŠØ© Ø£Ù… Ù„Ø§)
    if (property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·']) {
        const installmentEndDate = parseDate(property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·']);
        if (installmentEndDate) {
            const diffDays = Math.floor((installmentEndDate - today) / (1000 * 60 * 60 * 24));
            const remainingInstallments = property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] ? Number(property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©']) : 0;

            if (diffDays < 0) {
                // Ù…Ù†ØªÙ‡ÙŠ - Ù„ÙˆÙ† Ù…ÙˆÙ
                if (remainingInstallments > 0) {
                    return {
                        final: 'Ù…Ù†ØªÙ‡Ù‰',
                        display: `Ø£Ù‚Ø³Ø§Ø· Ù…Ù†ØªÙ‡ÙŠØ© Ù…Ù†Ø° ${Math.abs(diffDays)} ÙŠÙˆÙ… <span class="need-more-installments">Ø¨Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (${remainingInstallments})</span>`,
                        isInstallmentEnded: true
                    };
                } else {
                    return {
                        final: 'Ù…Ù†ØªÙ‡Ù‰',
                        display: `Ø£Ù‚Ø³Ø§Ø· Ù…Ù†ØªÙ‡ÙŠØ© Ù…Ù†Ø° ${Math.abs(diffDays)} ÙŠÙˆÙ…`,
                        isInstallmentEnded: true
                    };
                }
            } else if (diffDays <= 60) {
                // Ø¹Ù„Ù‰ ÙˆØ´Ùƒ - ØªØ¯Ø±Ø¬ Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ/Ø£Ø²Ø±Ù‚
                if (remainingInstallments > 0) {
                    return {
                        final: 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ',
                        display: `Ø£Ù‚Ø³Ø§Ø· Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø¹Ø¯ ${diffDays} ÙŠÙˆÙ… (Ù…ØªØ¨Ù‚ÙŠ ${remainingInstallments} Ø£Ù‚Ø³Ø§Ø·)`,
                        isInstallmentEnded: false,
                        isPending: true
                    };
                } else {
                    return {
                        final: 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ',
                        display: `Ø£Ù‚Ø³Ø§Ø· Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø¹Ø¯ ${diffDays} ÙŠÙˆÙ…`,
                        isInstallmentEnded: false,
                        isPending: true
                    };
                }
            } else {
                // ÙØ¹Ø§Ù„
                if (remainingInstallments > 0) {
                    return {
                        final: 'ÙØ¹Ø§Ù„',
                        display: `ÙØ¹Ø§Ù„ (Ù…ØªØ¨Ù‚ÙŠ ${remainingInstallments} Ø£Ù‚Ø³Ø§Ø·)`,
                        isInstallmentEnded: false
                    };
                } else {
                    return {
                        final: 'ÙØ¹Ø§Ù„',
                        display: 'ÙØ¹Ø§Ù„',
                        isInstallmentEnded: false
                    };
                }
            }
        }
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ¨Ù‚ÙŠØ© Ø£Ùˆ ÙƒØ§Ù†Øª ØµÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    if (property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']) {
        const contractDate = parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']);
        if (contractDate) {
            const diffDays = Math.floor((contractDate - today) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) {
                return { final: 'Ù…Ù†ØªÙ‡Ù‰', display: `Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° ${Math.abs(diffDays)} ÙŠÙˆÙ…`, isInstallmentEnded: false };
            } else if (diffDays <= 60) {
                return { final: 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ', display: `Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯ ${diffDays} ÙŠÙˆÙ…`, isInstallmentEnded: false };
            } else {
                return { final: 'ÙØ¹Ø§Ù„', display: 'ÙØ¹Ø§Ù„', isInstallmentEnded: false };
            }
        }
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] && property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©']) {
        let isInstallmentEnded = property['isInstallmentEnded'] || false;
        return {
            final: property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'],
            display: property['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'],
            isInstallmentEnded: isInstallmentEnded
        };
    }

    return { final: '', display: '', isInstallmentEnded: false };
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„
function renderTable(data) {
    const container = document.getElementById('content');
    if (data.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        return;
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
    const groupedData = {};
    data.forEach(property => {
        const key = `${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}_${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`;
        if (!groupedData[key]) {
            groupedData[key] = {
                ...property,
                units: [property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']],
                meters: [property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡']], // Ø¥Ø¶Ø§ÙØ© Ù…ØµÙÙˆÙØ© Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                totalUnits: 1,
                Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰: property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'],
                totalArea: parseFloat(property['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || 0
            };
        } else {
            groupedData[key].units.push(property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);
            // Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙˆÙ„Ù… ÙŠÙƒÙ† Ù…ÙƒØ±Ø±Ø§Ù‹
            if (property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] && !groupedData[key].meters.includes(property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'])) {
                groupedData[key].meters.push(property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡']);
            }
            groupedData[key].totalUnits++;
            groupedData[key].totalArea += parseFloat(property['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || 0;
        }
    });

    let html = '<div class="table-container"><table>';
    const orderedFields = [
        'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ',
        'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±',
        'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©',
        'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ',
        'Ø§Ù„Ù…Ø³Ø§Ø­Ø©',
        'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹',
        'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
        'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
        'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ',
        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·',
        'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©', // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
        'Ø§Ù„Ù…Ø§Ù„Ùƒ',
        'Ø§Ù„Ø­Ø§Ù„Ø©',
        'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'
    ];
    // Ù„Ø§Ø­Ø¸ Ø£Ù†Ù†Ø§ Ù„Ù… Ù†Ø¶Ù 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ' Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    html += '<tr>';
    orderedFields.forEach(header => {
        html += `<th>${header}</th>`;
    });
    html += '<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>';
    html += '</tr>';

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
    let groupedOrder = Object.keys(groupedData).sort((a, b) => {
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø«Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
        const [contractA, nameA] = a.split('_');
        const [contractB, nameB] = b.split('_');
        if (nameA === nameB) {
            return contractA.localeCompare(contractB, 'ar', {numeric: true});
        }
        return nameA.localeCompare(nameB, 'ar', {numeric: true});
    });

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹ÙƒØ³ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
    if (isReverseOrder) {
        groupedOrder = groupedOrder.reverse();
    }

    groupedOrder.forEach(key => {
        const property = groupedData[key];
        // Ø±ØªØ¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        property.units = property.units.filter(Boolean).sort((a, b) => a.localeCompare(b, 'ar', {numeric: true}));
        const status = calculateStatus(property);
        let statusClass = '';
        if (status.isInstallmentEnded) statusClass = 'installment-ended-status';
        else if (status.final === 'ÙØ¹Ø§Ù„') statusClass = 'active-status';
        else if (status.final === 'Ù…Ù†ØªÙ‡Ù‰') statusClass = 'expired-status';
        else if (status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') statusClass = 'pending-status';
        else if (status.final === 'ÙØ§Ø±Øº') statusClass = 'empty-status';

        html += '<tr>';
        orderedFields.forEach(field => {
            if (field === 'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ') {
                const unitsDisplay = property.units.filter(Boolean).map(unit => 
                    `<span class="unit-link" onclick="showUnitDetails('${unit}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}')">${unit}</span>`
                ).join(' , ') +
                (property.totalUnits > 1 ? `<span class="units-count"> (${property.totalUnits} ÙˆØ­Ø¯Ø§Øª)</span>` : '');
                html += `<td>${unitsDisplay}</td>`;
            } else if (field === 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡') {
                const metersDisplay = property.meters.filter(Boolean).map(meter => 
                    `<span class="meter-link" onclick="showMeterDetails('${meter}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}')">${meter}</span>`
                ).join(' , ') +
                (property.meters.length > 1 ? `<span class="meters-count">(${property.meters.length} Ø¹Ø¯Ø§Ø¯Ø§Øª)</span>` : '');
                html += `<td>${metersDisplay}</td>`;
            } else if (field === 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©') {
                html += `<td>${property.totalArea ? property.totalArea.toLocaleString() + ' Ù…Â²' : ''}</td>`;
            } else if (field === 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©') {
                html += `<td>${formatArabicDate(property[field])}</td>`;
            } else if (field === 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©') {
                html += `<td>${formatArabicDate(property[field])}</td>`;
            } else if (field === 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·') {
                html += `<td>${formatArabicDate(property[field])}</td>`;
            } else if (field === 'Ø§Ù„Ø­Ø§Ù„Ø©') {
                html += `<td class="${statusClass}">${status.display || ''}</td>`;
            } else if (field === 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰') {
                const totalData = formatTotalWithNote(property);
                if (property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ') {
                    html += `<td onclick="showTaxDetails(${totalData.amount}, '${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯']}')" style="cursor: pointer;">
                        <div class="total-display">
                            <span class="total-amount">${totalData.display}</span>
                            <small class="total-note">${totalData.note}</small>
                        </div>
                        <i class="fas fa-info-circle" style="margin-right: 5px; color: #2a4b9b;"></i>
                    </td>`;
                } else {
                    html += `<td onclick="showTaxDetails(${totalData.amount}, '${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯']}')" style="cursor: pointer;">
                        <div class="total-display">
                            <span class="total-amount">${totalData.display}</span>
                            <small class="total-note">${totalData.note}</small>
                        </div>
                    </td>`;
                }
            } else if (field === 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·') {
                if (property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·']) {
                    const status = calculateStatus(property);
                    const installmentClass = status.isInstallmentEnded ? 'installment-ended' :
                                            status.final === 'ÙØ¹Ø§Ù„' ? 'active' :
                                            status.final === 'Ù…Ù†ØªÙ‡Ù‰' ? 'expired' :
                                            status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ' ? 'pending' : 'empty';
                    html += `<td>
            <span class="installments-link installment-${installmentClass}" style="color:#2a4b9b;cursor:pointer;font-weight:bold;"
                onclick="showInstallmentsDetails('${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}')">
                ${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·']}
            </span>
        </td>`;
                } else {
                    html += `<td></td>`;
                }
            } else if (field === 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©') {
                html += `<td>${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©'] || ''}</td>`;
            } else if (field === 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') {
                const remaining = property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©'] && property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] ? 
                    (parseInt(property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©']) - parseInt(property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'])) : '';
                html += `<td>${remaining}</td>`;
            } else if (field === 'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±' && property[field]) {
                html += `<td><a href="tel:${property[field]}" class="phone-link">${property[field]} <i class="fas fa-phone-alt"></i></a></td>`;
            } else if (field === 'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ' && property[field]) {
                html += `<td><a href="tel:${property[field]}" class="phone-link">${property[field]} <i class="fas fa-phone-alt"></i></a></td>`;
            } else if (field === 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±' && property[field]) {
                html += `<td><a href="#" onclick="openLocation('${property[field]}'); return false;" class="location-link">Ø§Ù„Ø®Ø±ÙŠØ·Ø© <i class="fas fa-map-marker-alt"></i></a></td>`;
            } else {
                html += `<td>${property[field] || ''}</td>`;
            }
        });
        
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        html += `<td class="table-actions-cell">
            <div class="table-actions-group">
                <button onclick="showPropertyDetailsByKey(${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] ? `'${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}'` : `'', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}'`})" class="table-action-btn">
                    <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                </button>
                <button onclick="showPrintOptions(${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] ? `'${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}'` : `'', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}'`})" class="table-action-btn">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
                ${property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] ? `<button onclick="openLocation('${property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']}')" class="table-action-btn"><i class="fas fa-map-marker-alt"></i> Ù…ÙˆÙ‚Ø¹</button>` : ''}
            </div>
            <div class="table-actions-group">
                <button onclick="showCardAttachmentsModal('${property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}', '${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}')" class="table-action-btn attachment-btn">
                    <i class="fas fa-paperclip"></i> Ù…Ø±ÙÙ‚Ø§Øª
                </button>
                <button onclick="showCardEditModal('${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}')" class="table-action-btn edit-btn">
                    <i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ±
                </button>
            </div>
        </td>`;
        html += '</tr>';
    });

    html += '</table></div>';
    container.innerHTML = html;
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¨Ø·Ø§Ù‚Ø§Øª
function renderCards(data) {
    const container = document.getElementById('content');
    if (data.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        return;
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±: ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø¯
    const uniqueMap = new Map();
    data.forEach(property => {
        let key = '';
        if (property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] && property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
            key = `${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}_${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`;
        } else if (property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']) {
            key = property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
        }
        if (key && !uniqueMap.has(key)) {
            uniqueMap.set(key, property);
        }
    });
    const uniqueData = Array.from(uniqueMap.values());

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯
    const sortedData = isReverseOrder ? uniqueData.reverse() : uniqueData;

    let html = '<div class="cards-container">';
    sortedData.forEach(property => {
        const status = calculateStatus(property);
        let headerClass = '', badgeClass = 'badge-empty', badgeIcon = '', displayStatus = status.display;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ù…Ø³ØªØ£Ø¬Ø± Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø£Ùˆ Ù†Ù‡Ø§ÙŠØ© (Ø­Ø§Ù„Ø© Ø³Ù…Ø§ÙˆÙŠØ©)
        const hasTenantName = property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '';
        const hasNoStartDate = !property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] || property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'].trim() === '';
        const hasNoEndDate = !property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'].trim() === '';
        const isSkyBlueCase = hasTenantName && (hasNoStartDate || hasNoEndDate);

        // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù‚Ø³Ø· Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ù…Ø¹ Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø¯
        if (status.isInstallmentEnded) {
            headerClass = 'installment-ended-status';
            badgeClass = 'installment-ended-badge';
            badgeIcon = '<i class="fas fa-check-circle"></i>';
        } else if (isSkyBlueCase) {
            // Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ø³Ù… Ù…Ø³ØªØ£Ø¬Ø± Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ„ÙƒÙ† Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® - Ù„ÙˆÙ† Ø³Ù…Ø§ÙˆÙŠ
            headerClass = 'sky-blue-status';
            badgeClass = 'sky-blue-badge';
            badgeIcon = '<i class="fas fa-user"></i>';
            displayStatus = 'Ù…Ø³ØªØ£Ø¬Ø± Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®';
        } else {
            switch(status.final) {
                case 'ÙØ¹Ø§Ù„': headerClass = 'active-status'; badgeClass = 'active-badge'; badgeIcon = '<i class="fas fa-check-circle"></i>'; break;
                case 'Ù…Ù†ØªÙ‡Ù‰': headerClass = 'expired-status'; badgeClass = 'expired-badge'; badgeIcon = '<i class="fas fa-times-circle"></i>'; break;
                case 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ': headerClass = 'pending-status'; badgeClass = 'pending-badge'; badgeIcon = '<i class="fas fa-exclamation-circle"></i>'; break;
                case 'ÙØ§Ø±Øº': headerClass = 'empty-status'; badgeClass = 'empty-badge'; badgeIcon = '<i class="fas fa-minus-circle"></i>'; break;
            }
        }
        let startColor = '', endColor = '';
        if (status.isInstallmentEnded) {
            startColor = 'background:#f3e5f5;color:#9c27b0;'; // Ù„ÙˆÙ† Ù…ÙˆÙ Ù„Ù„Ù‚Ø³Ø· Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ù…Ø¹ Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚Ø¯
            endColor = 'background:#f3e5f5;color:#9c27b0;';
        } else {
            switch(status.final) {
                case 'ÙØ¹Ø§Ù„': startColor = 'background:#e8f7ef;color:#2a4b9b;'; endColor = 'background:#e8f7ef;color:#2a4b9b;'; break;
                case 'Ù…Ù†ØªÙ‡Ù‰': startColor = 'background:#fbeee6;color:#e74c3c;'; endColor = 'background:#fbeee6;color:#e74c3c;'; break;
                case 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ': startColor = 'background:#fffbe6;color:#f39c12;'; endColor = 'background:#fffbe6;color:#f39c12;'; break;
                default: startColor = 'background:#f6f6f6;color:#333;'; endColor = 'background:#f6f6f6;color:#333;';
            }
        }
        // Ø§Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙÙ‚Ø·
        let relatedUnits = [];
        let totalArea = 0;
        if (property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {
            const relatedProps = properties.filter(
                p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']
            );
            relatedUnits = relatedProps.map(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']).filter(Boolean);
            totalArea = relatedProps.reduce((sum, p) => sum + (parseFloat(p['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || 0), 0);
        } else if (property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']) {
            relatedUnits = [property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']];
            totalArea = parseFloat(property['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || 0;
        }
        relatedUnits = [...new Set(relatedUnits)].sort((a, b) => a.localeCompare(b, 'ar', {numeric: true}));

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©
        const cardId = `card_${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'no_contract'}_${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']?.replace(/\s+/g, '_') || 'no_name'}_${Date.now()}`;

        html += `
        <div class="property-card mobile-expandable" id="${cardId}" data-expanded="false" onclick="toggleCardExpansion('${cardId}', event)">
            <div class="card-header ${headerClass}">
                <span>${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}</span>
                <span>${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || ''}</span>
            </div>

            <!-- Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶ØºÙˆØ· - ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆÙŠ ÙÙ‚Ø· -->
            <div class="card-compact-view">
                <div class="compact-row">
                    <span class="compact-label"><i class="fas fa-home"></i> Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
                    <span class="compact-value">
                        ${relatedUnits.map(unit =>
                            `<span class="unit-link" onclick="event.stopPropagation(); showUnitDetails('${unit}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}')">${unit}</span>`
                        ).join(' , ')}
                        ${relatedUnits.length > 1 ? `<span class="units-count">(${relatedUnits.length} ÙˆØ­Ø¯Ø§Øª)</span>` : ''}
                    </span>
                </div>
                <div class="compact-row">
                    <span class="compact-label"><i class="fas fa-user"></i> Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</span>
                    <span class="compact-value tenant-name-compact">${property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}</span>
                </div>
                <div class="compact-row">
                    <span class="compact-label"><i class="fas fa-info-circle"></i> Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                    <span class="status-value ${badgeClass} compact-status">
                        ${badgeIcon} ${displayStatus || ''}
                    </span>
                </div>
            </div>

            <!-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© - ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ³Ø¹ ÙÙ‚Ø· -->
            <div class="card-full-view">
                <div class="card-body">
                <div class="card-row">
                    <span class="card-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
                    <span class="card-value">
                        ${relatedUnits.map(unit =>
                            `<span class="unit-link" onclick="showUnitDetails('${unit}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}')">${unit}</span>`
                        ).join(' , ')}
                        ${relatedUnits.length > 1 ? `<span class="units-count">(${relatedUnits.length} ÙˆØ­Ø¯Ø§Øª)</span>` : ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</span>
                    <span class="card-value">${totalArea ? totalArea.toLocaleString() + ' Ù…Â²' : ''}</span>
                </div>
                ${property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] ? `
                <div class="card-row electric-meter-row">
                    <span class="card-label"><i class="fas fa-bolt"></i> Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡:</span>
                    <span class="card-value">${property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡']}</span>
                </div>` : ''}
                <div class="card-row tenant-name-row">
                    <span class="card-label"><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</span>
                    <span class="card-value tenant-name-value">${property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}</span>
                </div>
                ${property['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] ? `
                <div class="card-row">
                    <span class="card-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
                    <span class="card-value">
                        <a href="tel:${property['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}" class="phone-link">
                            ${property['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']} <i class="fas fa-phone-alt"></i>
                        </a>
                    </span>
                </div>` : ''}
                ${property['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ'] ? `
                <div class="card-row">
                    <span class="card-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ:</span>
                    <span class="card-value">
                        <a href="tel:${property['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ']}" class="phone-link">
                            ${property['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ']} <i class="fas fa-phone-alt"></i>
                        </a>
                    </span>
                </div>` : ''}
                <div class="card-row">
                    <span class="card-label">Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
                    <span class="card-value">${property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || ''}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</span>
                    <span class="card-value">${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}</span>
                </div>
                ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] ? `
                <div class="card-row property-type-row">
                    <span class="card-label"><i class="fas fa-tag"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</span>
                    <span class="card-value property-type-badge property-type-${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']?.toLowerCase()?.replace('Ø£', 'Ø§')}">${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']}</span>
                </div>` : ''}
                <div class="card-row">
                    <span class="card-label"><i class="fas fa-sticky-note"></i> ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
                    <span class="card-value" style="color: #dc3545; font-weight: 500;">${property['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©'] || ''}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</span>
                    <span class="card-value" style="${startColor} padding:4px 8px; border-radius:4px;">
                        ${formatArabicDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']) || ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</span>
                    <span class="card-value" style="${endColor} padding:4px 8px; border-radius:4px;">
                        ${formatArabicDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']) || ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·:</span>
                    <span class="card-value" style="${endColor} padding:4px 8px; border-radius:4px;">
                        ${formatArabicDate(property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·']) || ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
                    <span class="status-value ${badgeClass} ${
                        status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ' && property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] && Number(property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©']) > 0
                            ? 'pending-gradient'
                            : ''
                    }">
                        ${badgeIcon} ${displayStatus || ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰:</span>
                    <span class="card-value">
                        ${(() => {
                            const totalData = formatTotalWithNote(property);
                            return `
                                <div class="total-display-card">
                                    <span class="total-amount">${totalData.display}</span>
                                    <small class="total-note">${totalData.note}</small>
                                </div>
                            `;
                        })()}
                    </span>
                </div>
                ${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] && property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] > 0 ? `
                <div class="card-row">
                    <span class="card-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·:</span>
                    <span class="card-value">
                        <span class="installments-count-badge installment-${status.isInstallmentEnded ? 'installment-ended' : status.final === 'ÙØ¹Ø§Ù„' ? 'active' : status.final === 'Ù…Ù†ØªÙ‡Ù‰' ? 'expired' : status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ' ? 'pending' : 'empty'}"
                              onclick="showInstallmentsDetails('${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}')"
                              title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·">
                            <i class="fas fa-calendar-check"></i>
                            ${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·']} ${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] === 1 ? 'Ù‚Ø³Ø·' : 'Ø£Ù‚Ø³Ø§Ø·'}
                        </span>
                    </span>
                </div>` : ''}
                ${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] ? `
                <div class="card-row">
                    <span class="card-label">Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</span>
                    <span class="card-value">
                        <span class="remaining-installments ${Number(property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©']) <= 2 ? 'warning' : ''}">
                            <i class="fas fa-clock"></i>
                            ${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©']} ${Number(property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©']) === 1 ? 'Ù‚Ø³Ø· Ù…ØªØ¨Ù‚ÙŠ' : 'Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ¨Ù‚ÙŠØ©'}
                        </span>
                    </span>
                </div>` : ''}
                </div>
                <div class="card-footer">
                    <div class="card-actions-row">
                        <button onclick="event.stopPropagation(); showPropertyDetailsByKey(${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] ? `'${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}'` : `'', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}'`})">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                        </button>
                        <button onclick="event.stopPropagation(); showPrintOptions(${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] ? `'${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}'` : `'', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}'`})">
                            <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                        ${property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] ?
                            `<button onclick="event.stopPropagation(); openLocation('${property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']}')" class="location-btn">
                                <i class="fas fa-map-marker-alt"></i> Ø§Ù„Ù…ÙˆÙ‚Ø¹
                            </button>` :
                            ''}
                    </div>
                    <div class="card-actions-row">
                        <button onclick="event.stopPropagation(); showCardAttachmentsModal('${property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}', '${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}')" class="attachment-btn">
                            <i class="fas fa-paperclip"></i> Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                        </button>
                        <button onclick="event.stopPropagation(); showCardEditModal('${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}')" class="edit-btn">
                            <i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ±
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

// ÙØªØ­ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
function openLocation(location) {
    // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· URL
    if (location.startsWith('http://') || location.startsWith('https://')) {
        window.open(location, '_blank');
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø±Ø§Ø¨Ø·Ù‹Ø§ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù†Ù‡ ÙÙŠ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
        const googleMapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(location)}`;
        window.open(googleMapsUrl, '_blank');
    }
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø© ØªØ¹Ù…Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
function showPropertyDetails(index) {
    const property = properties[index];
    if (!property) return;

    const status = calculateStatus(property);
    let statusClass = '';
    let badgeIcon = '';

    if (status.isInstallmentEnded) {
        statusClass = 'installment-ended-status';
        badgeIcon = '<i class="fas fa-money-bill-wave"></i>';
    } else if (status.final === 'ÙØ¹Ø§Ù„') {
        statusClass = 'active-status';
        badgeIcon = '<i class="fas fa-check-circle"></i>';
    } else if (status.final === 'Ù…Ù†ØªÙ‡Ù‰') {
        statusClass = 'expired-status';
        badgeIcon = '<i class="fas fa-times-circle"></i>';
    } else if (status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') {
        statusClass = 'pending-status';
        badgeIcon = '<i class="fas fa-exclamation-circle"></i>';
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ø­Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯
    const contractKey = `${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}_${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`;
    const related = properties.filter(
        p => `${p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}_${p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}` === contractKey
    );
    const allUnits = related.map(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']).filter(Boolean);
    const totalArea = related.reduce((sum, p) => sum + (parseFloat(p['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || 0), 0);

    // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø§Ø´Ø© ØµØºÙŠØ±Ø©
    const isMobile = window.innerWidth <= 768;
    console.log('ğŸ“± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©:', window.innerWidth, 'Ù‡Ø§ØªÙØŸ', isMobile);
    console.log('ğŸ¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±:', property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);

    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø©
    let html = `<div class="modal-overlay" style="
        display: flex;
        z-index: 10000;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        align-items: ${isMobile ? 'flex-start' : 'center'};
        justify-content: center;
        padding: ${isMobile ? '5px' : '20px'};
        box-sizing: border-box;
        overflow-y: auto;
    ">
        <div class="modal-box property-details-modal" style="
            background: white;
            border-radius: 10px;
            max-width: ${isMobile ? 'none' : '600px'};
            width: ${isMobile ? '95%' : '100%'};
            min-height: ${isMobile ? '90vh' : '70vh'};
            max-height: ${isMobile ? '95vh' : '90vh'};
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            margin-top: ${isMobile ? '10px' : '20px'};
            margin-bottom: ${isMobile ? '10px' : '20px'};
            display: flex;
            flex-direction: column;
        ">`;

    html += `<div style="
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: ${isMobile ? '15px' : '20px'};
        flex-shrink: 0;
    ">
        <h3 style="
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            font-size: ${isMobile ? '1.1rem' : '1.2rem'};
        ">
            <i class="fas fa-building"></i>
            ${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±'}
            <span style="
                background: rgba(255,255,255,0.2);
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.8rem;
            ">ØªÙØ§ØµÙŠÙ„</span>
        </h3>
    </div>`;

    // Ø¨Ø¯Ø§ÙŠØ© Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„
    html += `<div class="property-details" style="
        padding: ${isMobile ? '10px' : '15px'};
        min-height: ${isMobile ? '60vh' : '50vh'};
        max-height: ${isMobile ? '75vh' : '70vh'};
        overflow-y: auto;
        flex: 1;
        background: white;
        display: block !important;
        visibility: visible !important;
        position: relative;
        z-index: 1;
    ">`;

    // Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª)
    html += `
    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
        <span style="font-weight: 600; color: #333;">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
        <span style="color: #007bff; font-weight: 500;">${allUnits.join(' , ')}${allUnits.length > 1 ? ` <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem;">(${allUnits.length} ÙˆØ­Ø¯Ø§Øª)</span>` : ''}</span>
    </div>
    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
        <span style="font-weight: 600; color: #333;">Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©:</span>
        <span style="color: #28a745; font-weight: 500;">${totalArea ? totalArea.toLocaleString() : '0'} Ù…Â²</span>
    </div>
    `;

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ØªÙ… Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„)
    const excludedFields = ['Column1', 'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ', 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©', 'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ', 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ', 'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ', 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©', 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'];
    Object.entries(property).forEach(([key, value]) => {
        if (excludedFields.includes(key)) return;
        if (!value && value !== 0) return;
        let displayValue = value;
        if (key === 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰' && value) {
            displayValue = parseFloat(value).toLocaleString() + ' Ø±ÙŠØ§Ù„';
        } else if (key === 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±' && value) {
            let url = value;
            if (!url.startsWith('http')) {
                url = `https://www.google.com/maps/search/${encodeURIComponent(url)}`;
            }
            displayValue = `<a href="${url}" target="_blank" class="location-link">Ø§Ù„Ø®Ø±ÙŠØ·Ø© <i class="fas fa-map-marker-alt"></i></a>`;
        }
        html += `
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
            <span style="font-weight: 600; color: #333;">${key}:</span>
            <span style="color: #555; font-weight: 500; text-align: left; max-width: 60%;">${displayValue}</span>
        </div>
        `;
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø®ØµØµ
    let statusColor = '#6c757d';
    if (status.final === 'ÙØ¹Ø§Ù„') statusColor = '#28a745';
    else if (status.final === 'Ù…Ù†ØªÙ‡Ù‰') statusColor = '#dc3545';
    else if (status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') statusColor = '#ffc107';

    html += `
    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
        <span style="font-weight: 600; color: #333;">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
        <span style="color: ${statusColor}; font-weight: 600;">${badgeIcon} ${status.display || ''}</span>
    </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø®Ø§Ø¶Ø¹ Ù„Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
    if (property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) {
        if (property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ') {
            const baseAmount = property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] / 1.15;
            const vatAmount = property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] - baseAmount;
            html += `
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                <span style="font-weight: 600; color: #333;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø®Ø§Ø¶Ø¹ Ù„Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                <span style="color: #007bff; font-weight: 600;">${parseFloat(baseAmount).toFixed(2).toLocaleString()} Ø±ÙŠØ§Ù„</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                <span style="font-weight: 600; color: #333;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</span>
                <span style="color: #ffc107; font-weight: 600;">${parseFloat(vatAmount).toFixed(2).toLocaleString()} Ø±ÙŠØ§Ù„</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 2px solid #007bff; background: #f8f9fa; margin: 10px -15px; padding-left: 15px; padding-right: 15px;">
                <span style="font-weight: 700; color: #333; font-size: 1.1rem;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                <span style="color: #007bff; font-weight: 700; font-size: 1.1rem;">
                    ${parseFloat(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']).toLocaleString()} Ø±ÙŠØ§Ù„
                </span>
            </div>`;
        } else {
            html += `
            <div style="display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 2px solid #007bff; background: #f8f9fa; margin: 10px -15px; padding-left: 15px; padding-right: 15px;">
                <span style="font-weight: 700; color: #333; font-size: 1.1rem;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                <span style="color: #007bff; font-weight: 700; font-size: 1.1rem;">
                    ${parseFloat(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']).toLocaleString()} Ø±ÙŠØ§Ù„
                </span>
            </div>`;
        }
    }

    // Ø¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
        html += `
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
            <span style="font-weight: 600; color: #333;">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</span>
            <span style="text-align: left;">
                <a href="#" onclick="openLocation('${property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']}'); return false;"
                   style="color: #28a745; text-decoration: none; font-weight: 600; padding: 5px 10px; background: #e8f5e8; border-radius: 5px; display: inline-block;">
                   ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© <i class="fas fa-map-marker-alt"></i></a>
            </span>
        </div>`;
    }

    html += `</div>`;

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    html += `
    <div class="modal-actions" style="
        margin-top: auto;
        padding: ${isMobile ? '10px' : '15px'};
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 10px;
        flex-shrink: 0;
    ">
        <button onclick="closePropertyDetailsModal();" class="modal-action-btn close-btn property-details-close-btn" id="propertyDetailsCloseBtn"
                style="
                    flex: 1;
                    background: linear-gradient(135deg, #6c757d, #495057);
                    color: white;
                    border: none;
                    padding: ${isMobile ? '10px 15px' : '12px 20px'};
                    border-radius: 8px;
                    font-size: ${isMobile ? '0.9rem' : '1rem'};
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
        </button>
    </div>
    </div></div>`;

    console.log('ğŸ“„ Ø¥Ø¶Ø§ÙØ© HTML Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©...');
    document.body.insertAdjacentHTML('beforeend', html);
    console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© HTML Ø¨Ù†Ø¬Ø§Ø­');

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        const detailsDiv = document.querySelector('.property-details:last-child');

        console.log('ğŸ” ÙØ­Øµ Ø§Ù„Ø¹Ù†Ø§ØµØ±:');
        console.log('- Modal Overlay:', modalOverlay ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        console.log('- Details Div:', detailsDiv ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

        if (detailsDiv) {
            console.log('ğŸ“ Ø£Ø¨Ø¹Ø§Ø¯ Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„:', {
                width: detailsDiv.offsetWidth,
                height: detailsDiv.offsetHeight,
                scrollHeight: detailsDiv.scrollHeight,
                innerHTML: detailsDiv.innerHTML.length + ' Ø­Ø±Ù'
            });

            // Ø¥Ø¶Ø§ÙØ© CSS Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
            if (isMobile) {
                detailsDiv.style.display = 'block';
                detailsDiv.style.visibility = 'visible';
                detailsDiv.style.minHeight = '60vh';
                detailsDiv.style.maxHeight = '75vh';
                detailsDiv.style.overflowY = 'auto';
                console.log('ğŸ“± ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¹Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„');
            }
        } else {
            console.error('âŒ Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ - Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­...');
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            const modalBox = document.querySelector('.property-details-modal:last-child');
            if (modalBox && !modalBox.querySelector('.property-details')) {
                console.log('ğŸ”§ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„...');
                location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙƒØ­Ù„ Ø£Ø®ÙŠØ±
            }
        }

        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    closePropertyDetailsModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥ØºÙ„Ø§Ù‚');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙÙ‚Ø·
function renderOnlyEmptyUnits() {
    const emptyUnits = properties.filter(property => !property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].toString().trim() === '');
    renderTotals(emptyUnits);
    renderMobileTotals(emptyUnits);
    if (currentView === 'table') {
        renderTable(emptyUnits);
    } else {
        renderCards(emptyUnits);
    }
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ†Ù‚Ù„Ø©
    updateMobileMenuCounts(emptyUnits);
}

// Ø§Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†ÙˆØ§Øª Ù…Ù† ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
function getInstallmentMonthsAndYears() {
    const months = new Set();
    const years = new Set();
    properties.forEach(prop => {
        if (!prop['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·']) return;
        for (let i = 1; i <= Number(prop['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·']); i++) {
            let dateStr = prop[`ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${i === 1 ? 'Ø§Ù„Ø§ÙˆÙ„' : `Ø§Ù„Ø«Ø§Ù†ÙŠ`}`] || prop[`ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${i}`];
            if (!dateStr) continue;
            let datePart = dateStr.split(' ')[0];
            let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');
            if (parts.length !== 3) continue;
            let day, month, year;
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙˆÙ„ Ø¬Ø²Ø¡ 4 Ø£Ø±Ù‚Ø§Ù… ÙÙ‡Ùˆ Ø§Ù„Ø³Ù†Ø©
            if (parts[0].length === 4) {
                year = parts[0];
                month = parts[1];
                day = parts[2];
            } else {
                day = parts[0];
                month = parts[1];
                year = parts[2];
            }
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙØ± Ø§Ù„Ø²Ø§Ø¦Ø¯
            month = parseInt(month, 10);
            const months = [
                '', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ù‚Ù…ÙŠ + (Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ØµÙŠ)
            return `${datePart} (${parseInt(day,10)}/${months[month]}/${year})`;
        }
    });
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - Ù…Ø­Ø³Ù† Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
function formatArabicDate(dateStr) {
    if (!dateStr) return '';

    // Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ØµÙ„ÙŠ
    const originalDateStr = dateStr;

    // Ø¯Ø¹Ù… ØµÙŠØº: yyyy-mm-dd, dd/mm/yyyy, dd-mm-yyyy, yyyy/mm/dd, Ù…Ø¹ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† ÙˆÙ‚Øª
    let datePart = dateStr.split(' ')[0];
    let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');

    if (parts.length !== 3) return originalDateStr;

    let day, month, year;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙˆÙ„ Ø¬Ø²Ø¡ 4 Ø£Ø±Ù‚Ø§Ù… ÙÙ‡Ùˆ Ø§Ù„Ø³Ù†Ø©
    if (parts[0].length === 4) {
        year = parseInt(parts[0]);
        month = parseInt(parts[1]);
        day = parseInt(parts[2]);
    } else {
        day = parseInt(parts[0]);
        month = parseInt(parts[1]);
        year = parseInt(parts[2]);
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (isNaN(year) || isNaN(month) || isNaN(day) ||
        year < 1900 || year > 2100 ||
        month < 1 || month > 12 ||
        day < 1 || day > 31) {
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ formatArabicDate: ${originalDateStr}`);
        return originalDateStr; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­
    }

    const months = [
        '', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
        'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
    ];

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø³Ù‚ Ø¨ØµÙŠØºØ© dd/mm/yyyy
    const formattedDate = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;

    // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ù‚Ù…ÙŠ + (Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ØµÙŠ)
    return `${formattedDate} (${day}/${months[month]}/${year})`;
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
function showInstallmentsDetails(contractNumber, propertyName) {
    // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¹Ù†ØµØ± ÙŠØ·Ø§Ø¨Ù‚ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
    const prop = properties.find(p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    if (!prop || !prop['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·']) return;

    // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    let status = 'default';
    const statusObj = calculateStatus(prop);
       if (statusObj.isInstallmentEnded) {
        status = 'installment-ended';
    } else if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©']) {
        if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] === 'ÙØ¹Ø§Ù„') status = 'active';
        else if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] === 'Ù…Ù†ØªÙ‡Ù‰') status = 'expired';
        else if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') status = 'pending';
        else if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] === 'ÙØ§Ø±Øº') status = 'empty';
    }

    // Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯/Ø§Ù„Ø¹Ù‚Ø§Ø±
    const related = properties.filter(
        p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );
    const allUnits = related.map(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']).filter(Boolean);
    const totalArea = related.reduce((sum, p) => sum + (parseFloat(p['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || 0), 0);

    let html = '<div class="modal-overlay" style="display:flex;"><div class="modal-box"><button class="close-modal" onclick="closeModal()">Ã—</button>';
    html += `<h3>${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}</h3>`;
    html += '<div class="property-details">';

    // Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª)
    html += `
    <div class="detail-row">
        <span class="detail-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
        <span class="detail-value">${allUnits.join(' , ')}${allUnits.length > 1 ? ` <span class="units-count">(${allUnits.length} ÙˆØ­Ø¯Ø§Øª)</span>` : ''}</span>
    </div>
    <div class="detail-row">
        <span class="detail-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©:</span>
        <span class="detail-value">${totalArea ? totalArea.toLocaleString() : '0'} Ù…Â²</span>
    </div>
    `;

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ (ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„)
    const basicInfo = [
        { label: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', key: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯' },
        { label: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', key: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±' },
        { label: 'Ø§Ù„Ù…Ø§Ù„Ùƒ', key: 'Ø§Ù„Ù…Ø§Ù„Ùƒ' },
        { label: 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', key: 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©' },
        { label: 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯', key: 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯' },
        { label: 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡', key: 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡' },
        { label: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹', key: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹' }
        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ø¥Ø²Ø§Ù„Ø© 'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ' Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
    ];

    basicInfo.forEach(info => {
        if (property[info.key]) {
            html += `
            <div class="detail-row">
                <span class="detail-label">${info.label}:</span>
                <span class="detail-value">${property[info.key]}</span>
            </div>`;
        }
    });

    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    if (property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']) {
        html += `
        <div class="detail-row">
            <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</span>
            <span class="detail-value" style="color: #2a4b9b;">${property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']}</span>
        </div>`;
    }

    if (property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']) {
        html += `
        <div class="detail-row">
            <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</span>
            <span class="detail-value" style="color: #2a4b9b;">${property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']}</span>
        </div>`;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
    const propertyStatus = calculateStatus(property);
    let statusClass = '';
    let badgeIcon = '';

    if (propertyStatus.isInstallmentEnded) {
        statusClass = 'installment-ended-status';
        badgeIcon = '<i class="fas fa-money-bill-wave"></i>';
    } else if (propertyStatus.final === 'ÙØ¹Ø§Ù„') {
        statusClass = 'active-status';
        badgeIcon = '<i class="fas fa-check-circle"></i>';
    } else if (propertyStatus.final === 'Ù…Ù†ØªÙ‡Ù‰') {
        statusClass = 'expired-status';
        badgeIcon = '<i class="fas fa-times-circle"></i>';
    } else if (propertyStatus.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') {
        statusClass = 'pending-status';
        badgeIcon = '<i class="fas fa-exclamation-circle"></i>';
    }

    html += `
    <div class="detail-row ${statusClass}">
        <span class="detail-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
        <span class="detail-value">${badgeIcon} ${propertyStatus.display || ''}</span>
    </div>`;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø®Ø§Ø¶Ø¹ Ù„Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
    if (property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) {
        if (property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ') {
            const baseAmount = property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] / 1.15;
            const vatAmount = property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] - baseAmount;
            html += `
            <div class="detail-row">
                <span class="detail-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø®Ø§Ø¶Ø¹ Ù„Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                <span class="detail-value">${parseFloat(baseAmount).toFixed(2).toLocaleString()} Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</span>
                <span class="detail-value">${parseFloat(vatAmount).toFixed(2).toLocaleString()} Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="detail-row" style="font-weight: bold;">
                <span class="detail-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                <span class="detail-value" style="color: #2a4b9b;">
                    ${parseFloat(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']).toLocaleString()} Ø±ÙŠØ§Ù„
                </span>
            </div>`;
        } else {
            html += `
            <div class="detail-row">
                <span class="detail-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                <span class="detail-value" style="color: #2a4b9b; font-weight: bold;">
                    ${parseFloat(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']).toLocaleString()} Ø±ÙŠØ§Ù„
                </span>
            </div>`;
        }
    }

    // Ø¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
        html += `
        <div class="detail-row">
            <span class="detail-label">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</span>
            <span class="detail-value">
                <a href="#" onclick="openLocation('${property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']}'); return false;" 
                   class="location-link">ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© <i class="fas fa-map-marker-alt"></i></a>
            </span>
        </div>`;
    }

    html += `</div>`;

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    html += `
    <div class="modal-actions">
        <button onclick="showPrintOptions('${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}', '${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}')" 
                class="modal-action-btn print-btn">
            <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
        </button>`;
            
    if (property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
        html += `
            <button onclick="openLocation('${property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']}')" 
                    class="modal-action-btn location-btn">
                <i class="fas fa-map-marker-alt"></i> ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            </button>`;
    }
    
    html += `
        <button onclick="closeModal()" class="modal-action-btn close-btn">
            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
        </button>
    </div>
    </div></div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// Ù†Ø§ÙØ°Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¹ ØªØ£Ø«ÙŠØ± blur
document.addEventListener('DOMContentLoaded', function() {
    if (!sessionStorage.getItem('auth_ok')) {
        showPasswordModal();
    }
});



function checkPassword() {
    const input = document.getElementById('passwordInput');
    const errorDiv = document.getElementById('passwordError');
    if (input.value === 'sa12345') {
        sessionStorage.setItem('auth_ok', '1');
        document.getElementById('blur-overlay').remove();
        document.body.style.overflow = '';
    } else {
        errorDiv.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
        input.value = '';
        input.focus();
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚)
function closeModal() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.width = '';
    document.body.style.height = '';
    document.documentElement.style.overflow = '';

    // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†Ù…ÙˆØ°Ø¬ ØªØ­Ø±ÙŠØ± Ù†Ø´Ø·
    const activeForm = document.querySelector('.modal-overlay form');
    if (activeForm && typeof autoSaveInstallmentChanges === 'function') {
        autoSaveInstallmentChanges();
    }

    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(modal => {
        modal.remove();
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø£Ùˆ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
function toggleModal(modalCheckFunction, modalOpenFunction) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
    const existingModal = document.querySelector('.modal-overlay');

    if (existingModal) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©ØŒ Ø£ØºÙ„Ù‚Ù‡Ø§
        closeModal();
        return false; // ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©ØŒ Ø§ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        modalOpenFunction();
        return true; // ØªÙ… Ø§Ù„ÙØªØ­
    }
}

// Ø¹Ø±Ø¶ ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø± Ù…Ø¹ Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
function showMonthFilterModal() {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  const existingModal = document.querySelector('.modal-overlay');
  if (existingModal) {
    closeModal();
    return;
  }

  let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box month-filter-modal" style="max-width: 500px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-calendar-alt" style="color: #007bff;"></i>
                ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±
                <span class="badge" style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">ØªØ§Ø±ÙŠØ®</span>
            </h3>
            <div class="date-filter-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="font-weight: 600; color: #495057;">Ù†ÙˆØ¹ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <select id="filterTypeModal" class="date-filter-select" style="padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
                        <option value="start">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</option>
                        <option value="end">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</option>
                    </select>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="font-weight: 600; color: #495057;">Ø§Ù„ÙŠÙˆÙ…:</label>
                    <select id="filterDayModal" class="date-filter-select" style="padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…</option>
                        ${Array.from({length: 31}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                    </select>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="font-weight: 600; color: #495057;">Ø§Ù„Ø´Ù‡Ø±:</label>
                    <select id="filterMonthModal" class="date-filter-select" style="padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</option>
                        ${['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø¥Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±']
                          .map((m,i)=>`<option value="${i+1}">${m}</option>`).join('')}
                    </select>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="font-weight: 600; color: #495057;">Ø§Ù„Ø³Ù†Ø©:</label>
                    <select id="filterYearModal" class="date-filter-select" style="padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©</option>
                        ${Array.from({length: 81}, (_, i) => `<option value="${2020+i}">${2020+i}</option>`).join('')}
                    </select>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                    <button onclick="applyMonthFilterModal()" class="apply-filter-btn" style="flex: 1; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-check"></i> ØªØ·Ø¨ÙŠÙ‚
                    </button>
                    <button onclick="clearMonthFilterModal()" class="clear-filter-btn" style="flex: 1; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-times"></i> Ù…Ø³Ø­
                    </button>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closeMonthFilterModal();" class="modal-action-btn close-btn month-filter-close-btn" id="monthFilterCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

  document.body.insertAdjacentHTML('beforeend', html);

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  document.getElementById('filterTypeModal').value = dateFilterType;
  document.getElementById('filterDayModal').value = dateFilterDay;
  document.getElementById('filterMonthModal').value = dateFilterMonth;
  document.getElementById('filterYearModal').value = dateFilterYear;

  // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
  setTimeout(() => {
      const modalOverlay = document.querySelector('.modal-overlay:last-child');
      if (modalOverlay) {
          modalOverlay.addEventListener('click', function(e) {
              if (e.target === this) {
                  console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø± - Ø¥ØºÙ„Ø§Ù‚');
                  closeMonthFilterModal();
              }
          });
          console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±');
      }
  }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±
function closeMonthFilterModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±...');
    const modal = document.querySelector('.month-filter-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±');
        }
    }
}

function applyMonthFilterModal() {
  dateFilterType = document.getElementById('filterTypeModal').value;
  dateFilterDay = document.getElementById('filterDayModal').value;
  dateFilterMonth = document.getElementById('filterMonthModal').value;
  dateFilterYear = document.getElementById('filterYearModal').value;

  // ØªØ­Ø¯ÙŠØ« activeFilters Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
  if (dateFilterMonth && dateFilterYear) {
    activeFilters.monthFilter = `${dateFilterMonth}/${dateFilterYear}`;
  } else if (dateFilterMonth) {
    activeFilters.monthFilter = `Ø´Ù‡Ø± ${dateFilterMonth}`;
  } else if (dateFilterYear) {
    activeFilters.monthFilter = `Ø³Ù†Ø© ${dateFilterYear}`;
  } else {
    activeFilters.monthFilter = '';
  }

  closeMonthFilterModal();
  renderData();

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
  updateActiveFiltersDisplay();

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
  updateAllFilterButtonsState();
}

function clearMonthFilterModal() {
  dateFilterType = '';
  dateFilterDay = '';
  dateFilterMonth = '';
  dateFilterYear = '';

  // Ù…Ø³Ø­ ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø± Ù…Ù† activeFilters
  activeFilters.monthFilter = '';

  closeMonthFilterModal();
  renderData();

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
  updateActiveFiltersDisplay();

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
  updateAllFilterButtonsState();
}
// Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø¹ Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
function showContractTypeFilter() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        closeModal();
        return;
    }

    const contractTypes = ['Ø¶Ø±ÙŠØ¨ÙŠ', 'Ø³ÙƒÙ†ÙŠ', 'Ø±Ø§ÙƒØ¶'];
    let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box contract-type-filter-modal" style="max-width: 500px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-file-contract" style="color: #e83e8c;"></i>
                ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
                <span class="badge" style="background: #e83e8c; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${contractTypes.length + 1}</span>
            </h3>
            <div class="contract-type-filter" style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">`;

    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "Ø§Ù„ÙƒÙ„"
    const isAllActive = !contractTypeFilter;
    html += `
        <button onclick="if(contractTypeFilter) { toggleContractTypeFilter(contractTypeFilter); } closeContractTypeFilterModal();"
                class="contract-type-btn ${isAllActive ? 'active' : ''}"
                style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                       transition: all 0.3s ease; border: 1px solid #e9ecef;
                       background: ${isAllActive ? '#e83e8c' : 'white'}; color: ${isAllActive ? 'white' : '#495057'};
                       display: flex; align-items: center; justify-content: space-between;">
            <span style="font-weight: 700; font-size: 1.3rem;">Ø§Ù„ÙƒÙ„</span>
            ${isAllActive ? '<i class="fas fa-check" style="color: white;"></i>' : '<i class="fas fa-list" style="color: #e83e8c;"></i>'}
        </button>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯
    contractTypes.forEach(type => {
        const isActive = contractTypeFilter === type;
        html += `
            <button onclick="toggleContractTypeFilter('${type}'); closeContractTypeFilterModal();"
                    class="contract-type-btn ${isActive ? 'active' : ''}"
                    style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                           transition: all 0.3s ease; border: 1px solid #e9ecef;
                           background: ${isActive ? '#e83e8c' : 'white'}; color: ${isActive ? 'white' : '#495057'};
                           display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: 700; font-size: 1.3rem;">${type}</span>
                ${isActive ? '<i class="fas fa-check" style="color: white;"></i>' : '<i class="fas fa-file-contract" style="color: #e83e8c;"></i>'}
            </button>
        `;
    });

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closeContractTypeFilterModal();" class="modal-action-btn close-btn contract-type-filter-close-btn" id="contractTypeFilterCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯ - Ø¥ØºÙ„Ø§Ù‚');
                    closeContractTypeFilterModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
function closeContractTypeFilterModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯...');
    const modal = document.querySelector('.contract-type-filter-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯');
        }
    }
}

// ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
function setContractTypeFilter(type) {
    contractTypeFilter = type;

    // ØªØ­Ø¯ÙŠØ« activeFilters Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    activeFilters.contractType = type || '';

    closeContractTypeFilterModal();
    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    updateAllFilterButtonsState();
}

// Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    const contractTypeBtn = document.getElementById('contractTypeFilterBtn');
    if (contractTypeBtn) {
        contractTypeBtn.addEventListener('click', showContractTypeFilter);
    }
});
// ...existing code...

// Ø¯Ø§Ù„Ø© ÙˆØ³ÙŠØ·Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
function showPropertyDetailsByKey(contractNumber, propertyName) {
    // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¹Ù†ØµØ± ÙŠØ·Ø§Ø¨Ù‚ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
    const prop = properties.find(
        p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] == contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] == propertyName
    );
    if (!prop) return;
    // Ø§Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠØ©
    showPropertyDetails(properties.indexOf(prop));
}
// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
function showUnitDetails(unitNumber, propertyName, contractNumber = null) {
    // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± (ÙˆØ±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø¥Ù† ÙˆØ¬Ø¯)
    let unit = null;
    if (contractNumber) {
        unit = properties.find(
            p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] == unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] == propertyName && p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] == contractNumber
        );
    } else {
        unit = properties.find(
            p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] == unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] == propertyName
        );
    }
    if (!unit) return;

    // Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box unit-details-modal">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div class="modal-header">
                <h3><i class="fas fa-home"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}</h3>
                <p>${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''} - ${unit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || ''}</p>
            </div>
            <div class="property-details">

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                <div class="details-section">
                    <h4><i class="fas fa-building"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±</h4>
                    <div class="details-grid">`;

    // Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
    html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-building"></i> Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</span>
            <span class="detail-value">${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}</span>
        </div>`;

    // Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-map-marker-alt"></i> Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</span>
            <span class="detail-value">${unit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || ''}</span>
        </div>`;

    // Ø±Ù‚Ù… Ø§Ù„ØµÙƒ (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
    if (unit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-file-contract"></i> Ø±Ù‚Ù… Ø§Ù„ØµÙƒ:</span>
            <span class="detail-value">${unit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ']}</span>
        </div>`;
    }

    // Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
    if (unit['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-ruler-combined"></i> Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ:</span>
            <span class="detail-value">${parseFloat(unit['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']).toLocaleString()} Ù…Â²</span>
        </div>`;
    }

    // Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
    if (unit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-clipboard-list"></i> Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ:</span>
            <span class="detail-value">${unit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ']}</span>
        </div>`;
    }

    // Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
    if (unit['Ø§Ù„Ù…Ø§Ù„Ùƒ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-user"></i> Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
            <span class="detail-value">${unit['Ø§Ù„Ù…Ø§Ù„Ùƒ']}</span>
        </div>`;
    }

    // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
    if (unit['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-location-arrow"></i> Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</span>
            <span class="detail-value">
                <a href="https://www.google.com/maps/search/${encodeURIComponent(unit['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'])}" target="_blank" class="location-link">
                    ${unit['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']} <i class="fas fa-external-link-alt"></i>
                </a>
            </span>
        </div>`;
    }

    html += `
                    </div>
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© -->
                <div class="details-section">
                    <h4><i class="fas fa-door-open"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©</h4>
                    <div class="details-grid">`;

    // Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
    html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-hashtag"></i> Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
            <span class="detail-value">${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}</span>
        </div>`;

    // Ø§Ù„Ù…Ø³Ø§Ø­Ø©
    html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-expand-arrows-alt"></i> Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</span>
            <span class="detail-value">${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? parseFloat(unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']).toLocaleString() + ' Ù…Â²' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
        </div>`;

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
    if (unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {
        html += `
                    </div>
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ -->
                <div class="details-section">
                    <h4><i class="fas fa-user-tie"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯</h4>
                    <div class="details-grid">`;

        // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
        if (unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</span>
            <span class="detail-value">${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}</span>
        </div>`;
        }

        // Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
        if (unit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
            <span class="detail-value">
                <a href="tel:${unit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}" class="phone-link">
                    ${unit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']} <i class="fas fa-phone-alt"></i>
                </a>
            </span>
        </div>`;
        }

        // Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ
        if (unit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ:</span>
            <span class="detail-value">
                <a href="tel:${unit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ']}" class="phone-link">
                    ${unit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ']} <i class="fas fa-phone-alt"></i>
                </a>
            </span>
        </div>`;
        }

        // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
        if (unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-file-signature"></i> Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</span>
            <span class="detail-value">${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}</span>
        </div>`;
        }

        // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± - Ù…Ø®ÙÙŠ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // if (unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']) {
        //     html += `
        // <div class="detail-row">
        //     <span class="detail-label"><i class="fas fa-money-bill-wave"></i> Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</span>
        //     <span class="detail-value">${parseFloat(unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']).toLocaleString()} Ø±ÙŠØ§Ù„</span>
        // </div>`;
        // }

        // ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯
        if (unit['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-calendar-plus"></i> ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯:</span>
            <span class="detail-value">${unit['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']}</span>
        </div>`;
        }

        // ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯
        if (unit['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-calendar-minus"></i> ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯:</span>
            <span class="detail-value">${unit['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']}</span>
        </div>`;
        }

        // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
        if (unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-tag"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯:</span>
            <span class="detail-value">${unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯']}</span>
        </div>`;
        }

        html += `
                    </div>
                </div>`;
    } else {
        html += `
                    </div>
                </div>

                <!-- ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ© -->
                <div class="details-section">
                    <div class="empty-unit-notice">
                        <i class="fas fa-info-circle"></i>
                        <span>Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ© - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</span>
                    </div>
                </div>`;
    }

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
    if (unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«']) {
        html += `
                <div class="details-section">
                    <h4><i class="fas fa-clock"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«</h4>
                    <div class="details-grid">
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-calendar-check"></i> ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span>
                            <span class="detail-value">${unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«']}</span>
                        </div>`;

        if (unit['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«']) {
            html += `
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-edit"></i> Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«:</span>
                            <span class="detail-value">${unit['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«']}</span>
                        </div>`;
        }

        if (unit['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«']) {
            html += `
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-user-cog"></i> Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«:</span>
                            <span class="detail-value">${unit['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«']}</span>
                        </div>`;
        }

        html += `
                    </div>
                </div>`;
    }

    html += `
            </div>
            <div class="modal-actions">
                <button onclick="showCardEditModal('${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}', '${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}')" class="modal-action-btn edit-btn">
                    <i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø©
                </button>
                <button onclick="editProperty('${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}')" class="modal-action-btn property-btn">
                    <i class="fas fa-building"></i> ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
                </button>
                <button onclick="closeModal()" class="modal-action-btn close-btn">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}
// ...existing code...
// Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function showPrintOptions(contractNumber, propertyName, unitNumber = null) {
    let property;
    if (contractNumber) {
        property = properties.find(p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    } else if (unitNumber) {
        property = properties.find(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    } else {
        property = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    }
    if (!property) return;
    
    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <h3>Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§</h3>
            <div class="print-options">
                <div class="select-actions">
                    <button onclick="selectAllFields()" class="select-btn select-all">
                        <i class="fas fa-check-double"></i>
                        ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                    </button>
                    <button onclick="deselectAllFields()" class="select-btn deselect-all">
                        <i class="fas fa-times"></i>
                        Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                    </button>
                </div>
                <div class="fields-container">`;
    
    // Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù…ÙƒÙ†Ø© ÙƒØ®ÙŠØ§Ø±Ø§Øª (Ù…Ø¹ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡Ø§)
    Object.keys(property).forEach(key => {
        if (!shouldHideField(key)) {
            html += `
            <label class="field-option">
                <input type="checkbox" name="printFields" value="${key}" checked>
                <span>${key}</span>
            </label>`;
        }
    });
    
    html += `
                </div>
                <div class="print-actions">
                    <button onclick="executePrint('${contractNumber}', '${propertyName}'${unitNumber ? `, '${unitNumber}'` : ''})" class="modal-action-btn print-btn">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button onclick="closeModal()" class="modal-action-btn close-btn">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', html);
}

// ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function selectAllFields() {
    document.querySelectorAll('input[name="printFields"]').forEach(cb => cb.checked = true);
}

// Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function deselectAllFields() {
    document.querySelectorAll('input[name="printFields"]').forEach(cb => cb.checked = false);
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
function executePrint(contractNumber, propertyName, unitNumber = null) {
    let related;
    if (contractNumber) {
        related = properties.filter(p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    } else if (unitNumber) {
        related = properties.filter(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    } else {
        related = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    }
    if (related.length === 0) return;

    const property = related[0];
    const status = calculateStatus(property);
    const printWindow = window.open('', '_blank');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·
    const selectedFields = Array.from(document.querySelectorAll('input[name="printFields"]:checked')).map(cb => cb.value);

    if (selectedFields.length === 0) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø­Ù‚Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
        return;
    }

    let printContent = `
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± - ${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
            body {
                font-family: 'Tajawal', sans-serif;
                padding: 20px;
                direction: rtl;
            }
            .header {
                text-align: center;
                margin-bottom:  20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #2a4b9b;
                position: relative;
            }
            .print-logo {
                position: absolute;
                top: 0;
                left: 0;
                width: 110px;
                height: auto;
                margin: 10px 0 0 10px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            th, td {
                padding: 10px;
                border: 1px solid #ddd;
                text-align: right;
            }
            th {
                background-color: #333;
                color: white;
                font-weight: bold;
                width: 30%;
            }
            .footer {
                margin-top: 30px;
                text-align: center;
                font-size: 0.9rem;
                color: #777;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <img src="logo.jpeg" class="print-logo" alt="logo" />
            <h1>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±</h1>
            <h2>${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}</h2>
        </div>
        <table>`;

    // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ø§Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
    if (selectedFields.includes('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ')) {
        const allUnits = related.map(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']).filter(Boolean);
        if (allUnits.length > 0) {
            printContent += `
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</th>
                    <td>${allUnits.join(' , ')}${allUnits.length > 1 ? ` (${allUnits.length} ÙˆØ­Ø¯Ø§Øª)` : ''}</td>
                </tr>`;
        }
    }

    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø· (Ù…Ø¹ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡Ø§)
    const additionalHiddenFields = ['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ', 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©', 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'];
    selectedFields.forEach(key => {
        if (shouldHideField(key) || additionalHiddenFields.includes(key)) return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠØ©
        let value = property[key];
        if (!value && value !== 0) return;
        let displayValue = value;
        if (key === 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰' && value) {
            displayValue = parseFloat(value).toLocaleString() + ' Ø±ÙŠØ§Ù„';
        } else if (key === 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±' && value) {
            let url = value;
            if (!url.startsWith('http')) {
                url = `https://www.google.com/maps/search/${encodeURIComponent(url)}`;
            }
            displayValue = `<a href="${url}" target="_blank" class="location-link">Ø§Ù„Ø®Ø±ÙŠØ·Ø© <i class="fas fa-map-marker-alt"></i></a>`;
        }
        printContent += `
            <tr>
                <th>${key}</th>
                <td>${displayValue}</td>
            </tr>`;
    });

    printContent += `
        </table>
        <div class="footer">
            <p>ØªÙ…Øª Ø·Ø¨Ø§Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…Ù† Ù†Ø¸Ø§Ù… Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</p>
            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-SA')}</p>
        </div>
        <script>
            window.onload = function() {
                window.print();
            }
        </script>
    </body>
    </html>`;

    printWindow.document.write(printContent);
    printWindow.document.close();
    closeModal();
}
function showInstallmentsDetails(contractNumber, propertyName) {
    // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¹Ù†ØµØ± ÙŠØ·Ø§Ø¨Ù‚ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
    const prop = properties.find(p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    if (!prop) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙØ¹Ù„ÙŠ
    let actualInstallmentCount = 0;
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        if (prop[dateKey] || prop[amountKey]) {
            actualInstallmentCount = i;
        }
    }

    if (actualInstallmentCount === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    let status = 'default';
    const statusObj = calculateStatus(prop);
    if (statusObj.isInstallmentEnded) {
        status = 'installment-ended';
    } else if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©']) {
        if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] === 'ÙØ¹Ø§Ù„') status = 'active';
        else if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] === 'Ù…Ù†ØªÙ‡Ù‰') status = 'expired';
        else if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') status = 'pending';
        else if (prop['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'] === 'ÙØ§Ø±Øº') status = 'empty';
    }

    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box installments-details-modal">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div class="modal-header">
                <h3><i class="fas fa-calendar-check"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h3>
                <p>${prop['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']} - ${prop['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            </div>
            <div class="installments-summary">
                <div class="summary-item">
                    <span class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·:</span>
                    <span class="summary-value">${actualInstallmentCount}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</span>
                    <span class="summary-value">${prop['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯:</span>
                    <span class="summary-value">${prop['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                </div>
            </div>
            <div class="installments-grid">`;

    let totalAmount = 0;
    let installmentsWithAmount = 0;

    for (let i = 1; i <= actualInstallmentCount; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        const date = prop[dateKey];
        const amount = prop[amountKey];

        if (date || amount) {
            const amountValue = parseFloat(amount) || 0;
            if (amountValue > 0) {
                totalAmount += amountValue;
                installmentsWithAmount++;
            }

            const base = amountValue / 1.15;
            const vat = amountValue - base;

            html += `
            <div class="installment-card installment-${status}">
                <div class="installment-header">
                    <h4><i class="fas fa-calendar-day"></i> Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}</h4>
                    <span class="installment-number">#${i}</span>
                </div>
                <div class="installment-body">
                    ${date ? `
                    <div class="installment-field">
                        <span class="field-label"><i class="fas fa-calendar"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                        <span class="field-value">${date}</span>
                    </div>` : `
                    <div class="installment-field missing">
                        <span class="field-label"><i class="fas fa-calendar"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                        <span class="field-value">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                    </div>`}

                    ${amount ? `
                    <div class="installment-field">
                        <span class="field-label"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ:</span>
                        <span class="field-value amount">${amountValue.toLocaleString()} Ø±ÙŠØ§Ù„</span>
                    </div>
                    ${prop['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ' ? `
                    <div class="installment-field tax-details">
                        <span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø®Ø§Ø¶Ø¹ Ù„Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                        <span class="field-value">${base.toFixed(2).toLocaleString()} Ø±ÙŠØ§Ù„</span>
                    </div>
                    <div class="installment-field tax-details">
                        <span class="field-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</span>
                        <span class="field-value">${vat.toFixed(2).toLocaleString()} Ø±ÙŠØ§Ù„</span>
                    </div>` : ''}` : `
                    <div class="installment-field missing">
                        <span class="field-label"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ù„Øº:</span>
                        <span class="field-value">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                    </div>`}
                </div>
            </div>`;
        }
    }

    html += `</div>
            <div class="installments-total">
                <div class="total-item">
                    <span class="total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº:</span>
                    <span class="total-value">${totalAmount.toLocaleString()} Ø±ÙŠØ§Ù„</span>
                </div>
                <div class="total-item">
                    <span class="total-label">Ø£Ù‚Ø³Ø§Ø· Ø¨Ù…Ø¨Ø§Ù„Øº:</span>
                    <span class="total-value">${installmentsWithAmount} Ù…Ù† ${actualInstallmentCount}</span>
                </div>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);

    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}
// Ø±Ø¨Ø· Ø²Ø± ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
    const monthBtn = document.getElementById('monthFilterBtn');
    if (monthBtn) {
        monthBtn.addEventListener('click', showMonthFilterModal);
    }
});
// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ù„ÙÙ„ØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
function showMultiPropertyCityFilter() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        closeModal();
        return;
    }

    const cities = getUniqueCountries().filter(c => c !== 'Ø§Ù„ÙƒÙ„');
    let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box multi-property-filter-modal" style="max-width: 500px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-building" style="color: #20c997;"></i>
                ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© - Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                <span class="badge" style="background: #20c997; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${cities.length}</span>
            </h3>
            <div class="country-selection" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">`;

    cities.forEach(city => {
        html += `
            <button onclick="selectMultiFilterCity('${city}')"
                    class="city-btn"
                    style="width: 100%; padding: 12px; margin: 4px 0; border-radius: 8px; cursor: pointer;
                           transition: all 0.3s ease; border: 1px solid #e9ecef; background: white;
                           display: flex; align-items: center; justify-content: space-between; min-height: 50px;">
                <span style="font-weight: 700; font-size: 1.3rem;">${city}</span>
                <i class="fas fa-arrow-left" style="color: #20c997;"></i>
            </button>
        `;
    });

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closeMultiPropertyFilterModal();" class="modal-action-btn close-btn multi-property-filter-close-btn" id="multiPropertyFilterCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© - Ø¥ØºÙ„Ø§Ù‚');
                    closeMultiPropertyFilterModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
function closeMultiPropertyFilterModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©...');
    const modal = document.querySelector('.multi-property-filter-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©');
        }
    }
}

function selectMultiFilterCity(city) {
    closeMultiPropertyFilterModal();
    multiFilterSelectedCity = city;
    multiFilterSelectedProperties = [];
    const props = properties.filter(p => p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === city)
        .map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
        .filter((v, i, arr) => v && arr.indexOf(v) === i);

    let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box multi-property-selection-modal" style="max-width: 600px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-building" style="color: #20c997;"></i>
                Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª - ${city}
                <span class="badge" style="background: #20c997; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${props.length}</span>
            </h3>
            <input type="text" id="multiPropertySearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø±..."
                   style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #e9ecef; border-radius:8px; font-size: 1rem;">
            <div id="multiPropertyList" style="max-height:300px; overflow-y:auto; border:1px solid #e9ecef; border-radius: 8px; padding:15px;">`;

    props.forEach(prop => {
        html += `
            <label class="multi-property-option" style="display:block; margin:8px 0; cursor:pointer; padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; transition: all 0.3s ease; background: white;">
                <input type="checkbox" value="${prop}" onchange="toggleMultiFilterProperty(this)" style="margin-left: 10px;">
                <span style="font-weight: 700; font-size: 1.3rem;">${prop}</span>
            </label>
        `;
    });

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="applyMultiPropertyFilter()" class="modal-action-btn print-btn"
                        style="flex: 1; background: linear-gradient(135deg, #20c997, #17a2b8); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-check"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                </button>
                <button onclick="closeMultiPropertySelectionModal()" class="modal-action-btn close-btn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¨Ø­Ø« Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    document.getElementById('multiPropertySearch').addEventListener('input', function() {
        const term = this.value.trim().toLowerCase();
        document.querySelectorAll('#multiPropertyList .multi-property-option').forEach(label => {
            const text = label.textContent.trim().toLowerCase();
            label.style.display = text.includes(term) ? '' : 'none';
        });
    });

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© - Ø¥ØºÙ„Ø§Ù‚');
                    closeMultiPropertySelectionModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
function closeMultiPropertySelectionModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©...');
    const modal = document.querySelector('.multi-property-selection-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©');
        }
    }
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
function toggleMultiFilterProperty(checkbox) {
    const val = checkbox.value;
    if (checkbox.checked) {
        if (!multiFilterSelectedProperties.includes(val)) multiFilterSelectedProperties.push(val);
    } else {
        multiFilterSelectedProperties = multiFilterSelectedProperties.filter(p => p !== val);
    }
}

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"
function applyMultiPropertyFilter() {
    closeModal();
    if (!multiFilterSelectedCity || multiFilterSelectedProperties.length === 0) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯ÙŠÙ†Ø© ÙˆØ¹Ù‚Ø§Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
    }
    // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const filtered = properties.filter(p =>
        p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === multiFilterSelectedCity &&
        multiFilterSelectedProperties.includes(p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
    );
    showMultiPropertyStats(filtered);
}

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
// ...existing code...
function showMultiPropertyStats(filtered) {
    // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
    const grouped = {};
    filtered.forEach(p => {
        const name = p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        if (!name) return;
        if (!grouped[name]) grouped[name] = [];
        grouped[name].push(p);
    });

    // ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø¹Ù‚Ø§Ø±
    const stats = {};
    let totalUnits = 0, totalTenants = 0, totalBeforeTax = 0, totalVat = 0, totalAfterTax = 0, totalResidential = 0;

    Object.entries(grouped).forEach(([name, props]) => {
        const units = props.length;
        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ø¹ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø£ÙˆÙ„ Ù…Ø¨Ù„Øº ØºÙŠØ± ÙØ§Ø±Øº Ø£Ùˆ Ø§Ù„Ø£ÙƒØ¨Ø±
        const contracts = {};
        props.forEach(p => {
            if (p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {
                if (
                    !contracts[p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']] ||
                    (!contracts[p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']]['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] && p['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) ||
                    (
                        p['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] && contracts[p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']]['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] &&
                        parseFloat(p['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) > parseFloat(contracts[p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']]['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'])
                    )
                ) {
                    contracts[p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']] = p;
                }
            }
        });
        const contractsArr = Object.values(contracts);

        // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø§Ù„ÙØ±ÙŠØ¯ÙŠÙ† (Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯)
        const tenants = new Set(contractsArr.map(p => p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'])).size;

        // Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø¹Ù‚Ø¯
        let beforeTax = 0, vat = 0, afterTax = 0, residential = 0;
        contractsArr.forEach(p => {
            if (p['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ' && p['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) {
                const amount = parseFloat(p['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) || 0;
                const base = amount / 1.15;
                beforeTax += base;
                vat += base * 0.15;
                afterTax += amount;
            } else if (p['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] !== 'Ø¶Ø±ÙŠØ¨ÙŠ' && p['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) {
                residential += parseFloat(p['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) || 0;
            }
        });

        stats[name] = {
            units,
            tenants,
            beforeTax,
            vat,
            afterTax,
            residential,
            total: beforeTax + residential // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
        };

        // Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
        totalUnits += units;
        totalTenants += tenants;
        totalBeforeTax += beforeTax;
        totalVat += vat;
        totalAfterTax += afterTax;
        totalResidential += residential;
    });

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø´ÙƒÙ„ Ø£ÙÙ‚ÙŠ Ù…Ø¹ Ø²Ø± PDF
    let html = `<div class="modal-overlay" style="display:flex;">
      <div class="modal-box" style="max-width:1100px;">
        <button class="close-modal" onclick="closeModal()">Ã—</button>
        <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
        <div style="text-align:left;margin-bottom:10px;">

        </div>
        <div class="property-details" style="padding:0;">
        <div style="overflow-x:auto;">
        <div id="multiStatsTableToPrint">
        <table style="width:100%;border-collapse:collapse;text-align:center;">
            <thead>
                <tr style="background:#2a4b9b;color:#fff;">
                    <th>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©</th>
                    ${Object.keys(stats).map(name => `<th>${name}</th>`).join('')}
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="font-weight:bold;">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</td>
                    ${Object.values(stats).map(s => `<td>${s.units}</td>`).join('')}
                    <td>${totalUnits}</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</td>
                    ${Object.values(stats).map(s => `<td>${s.tenants}</td>`).join('')}
                    <td>${totalTenants}</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</td>
                    ${Object.values(stats).map(s => `<td>${s.beforeTax.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>`).join('')}
                    <td>${totalBeforeTax.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</td>
                    ${Object.values(stats).map(s => `<td>${s.vat.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>`).join('')}
                    <td>${totalVat.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</td>
                    ${Object.values(stats).map(s => `<td>${s.afterTax.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>`).join('')}
                    <td>${totalAfterTax.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Ø³ÙƒÙ†ÙŠ</td>
                    ${Object.values(stats).map(s => `<td>${s.residential.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>`).join('')}
                    <td>${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;color:#2a4b9b;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</td>
                    ${Object.values(stats).map(s => `<td style="font-weight:bold;color:#2a4b9b;">${(s.beforeTax + s.residential).toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>`).join('')}
                    <td style="font-weight:bold;color:#2a4b9b;">${(totalBeforeTax + totalResidential).toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</td>
                </tr>
            </tbody>
        </table>
        </div>
        </div>
        </div>
        <div class="modal-actions" style="flex-direction:row;gap:10px;">
  <button onclick="printMultiStatsTable()" class="modal-action-btn print-btn" style="flex:1;">
    <i class="fas fa-file-pdf"></i> Ø·Ø¨Ø§Ø¹Ø© PDF
  </button>
  <button onclick="closeModal()" class="modal-action-btn close-btn" style="flex:1;">
    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
  </button>
</div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª PDF
function printMultiStatsTable() {
    const tableHtml = document.getElementById('multiStatsTableToPrint').innerHTML;
    const win = window.open('', '', 'width=1100,height=700');
    win.document.write(`
        <html lang="ar" dir="rtl">
        <head>
            <title>Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</title>
            <style>
                body { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 30px; }
                table { width: 100%; border-collapse: collapse; text-align: center; }
                th, td { border: 1px solid #333; padding: 10px; font-size: 1.1em; }
                th { background: #2a4b9b; color: #fff; }
                td { background: #f7f9fa; }
                tr:last-child td, tr:last-child th { font-weight: bold; color: #2a4b9b; background: #e8f7ef; }
            </style>
        </head>
        <body>
            <h2 style="text-align:center;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h2>
            <div>${tableHtml}</div>
            <script>window.print();</script>
        </body>
        </html>
    `);
    win.document.close();
}
// Ø±Ø¨Ø· Ø²Ø± ÙÙ„ØªØ± Ø¹Ù‚Ø§Ø±Ø§Øª Ù…ØªØ¹Ø¯Ø¯ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¬ÙˆØ§Ù„
document.addEventListener('DOMContentLoaded', function() {
    const multiBtn = document.getElementById('multiPropertyFilterBtn');
    if (multiBtn) multiBtn.addEventListener('click', showMultiPropertyCityFilter);

    const mobileMultiBtn = document.getElementById('mobile-multi-property-filter-btn');
    if (mobileMultiBtn) mobileMultiBtn.addEventListener('click', function() {
        showMultiPropertyCityFilter();
        // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        const mobileMenu = document.getElementById('mobileMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        if (mobileMenu) mobileMenu.classList.remove('active');
        if (menuOverlay) menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
});


// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±
function closePropertyDetailsModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±...');
    const modal = document.querySelector('.property-details-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        }
    }
}

// Ø¯Ø§Ù„Ø© ØªÙˆØ³ÙŠØ¹ ÙˆØ·ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
function toggleCardExpansion(cardId, event) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© - Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ÙÙ‚Ø·
    if (window.innerWidth > 768) {
        console.log('ğŸ–¥ï¸ Ø§Ù„Ø´Ø§Ø´Ø© ÙƒØ¨ÙŠØ±Ø© - Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù†Ø´Ø·Ø©');
        return; // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    }

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙˆØ³ÙŠØ¹ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø£Ùˆ Ø±Ø§Ø¨Ø·
    if (event && event.target) {
        const clickedElement = event.target;
        const isButton = clickedElement.tagName === 'BUTTON' ||
                        clickedElement.closest('button') ||
                        clickedElement.tagName === 'A' ||
                        clickedElement.closest('a') ||
                        clickedElement.classList.contains('unit-link') ||
                        clickedElement.closest('.unit-link');

        if (isButton) {
            console.log('ğŸš« ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø±/Ø±Ø§Ø¨Ø· - Ù„Ø§ ÙŠØªÙ… Ø§Ù„ØªÙˆØ³ÙŠØ¹');
            return;
        }
    }

    const card = document.getElementById(cardId);
    if (!card) {
        console.warn('âš ï¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©:', cardId);
        return;
    }

    const isExpanded = card.getAttribute('data-expanded') === 'true';
    const compactView = card.querySelector('.card-compact-view');
    const fullView = card.querySelector('.card-full-view');

    if (!compactView || !fullView) {
        console.warn('âš ï¸ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:', cardId);
        return;
    }

    console.log('ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:', cardId, 'Ù…ÙˆØ³Ø¹Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:', isExpanded);

    if (isExpanded) {
        // Ø·ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© - Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶ØºÙˆØ· ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„
        card.setAttribute('data-expanded', 'false');
        card.classList.remove('expanded');

        // Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ù„Ø³ Ù„Ù„Ø·ÙŠ
        fullView.style.opacity = '0';
        fullView.style.transform = 'translateY(-10px)';

        setTimeout(() => {
            fullView.style.display = 'none';
            compactView.style.display = 'block';
            compactView.style.opacity = '0';
            compactView.style.transform = 'translateY(10px)';

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶ØºÙˆØ· Ø¨Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ù„Ø³
            setTimeout(() => {
                compactView.style.opacity = '1';
                compactView.style.transform = 'translateY(0)';
            }, 50);
        }, 200);

        console.log('ğŸ“± ØªÙ… Ø·ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:', cardId);
    } else {
        // ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© - Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶ØºÙˆØ·
        card.setAttribute('data-expanded', 'true');
        card.classList.add('expanded');

        // Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ù„Ø³ Ù„Ù„ØªÙˆØ³ÙŠØ¹
        compactView.style.opacity = '0';
        compactView.style.transform = 'translateY(-10px)';

        setTimeout(() => {
            compactView.style.display = 'none';
            fullView.style.display = 'block';
            fullView.style.opacity = '0';
            fullView.style.transform = 'translateY(10px)';

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ù„Ø³
            setTimeout(() => {
                fullView.style.opacity = '1';
                fullView.style.transform = 'translateY(0)';
            }, 50);
        }, 200);

        console.log('ğŸ“± ØªÙ… ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:', cardId);

        // ØªÙ…Ø±ÙŠØ± Ù„Ø·ÙŠÙ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ³Ø¹Ø©
        setTimeout(() => {
            card.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',
                inline: 'nearest'
            });
        }, 400);
    }
}

// Ø¯Ø§Ù„Ø© ÙˆØ³ÙŠØ·Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
function showPropertyDetailsByKey(contractNumber, propertyName) {
    const prop = properties.find(
        p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] == contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] == propertyName
    );
    if (!prop) return;
    showPropertyDetails(properties.indexOf(prop));
}
function exportToExcel() {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const dataToExport = filteredProperties.length > 0 ? filteredProperties : properties;

    console.log(`ğŸ“Š ØªØµØ¯ÙŠØ± Excel: ${dataToExport.length} Ø³Ø¬Ù„ Ù…Ù† Ø£ØµÙ„ ${properties.length} Ø³Ø¬Ù„`);

    // Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    const formattedData = dataToExport.map(property => {
        // Ù†Ø³Ø® ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙƒÙ…Ø§ Ù‡ÙŠ
        return { ...property };
    });

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„
    const ws = XLSX.utils.json_to_sheet(formattedData, {
        header: [
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©',
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±',
            'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±',
            'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹',
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ',
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ',
            'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ',
            'Ø§Ù„Ù…Ø§Ù„Ùƒ',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ',
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
            'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰',
            'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'
        ]
    });

    // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    const colWidths = [
        { wch: 15 },  // Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
        { wch: 15 },  // Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
        { wch: 25 },  // Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
        { wch: 40 },  // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
        { wch: 10 },  // Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
        { wch: 20 },  // Ø±Ù‚Ù… Ø§Ù„ØµÙƒ
        { wch: 20 },  // Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ
        { wch: 15 },  // Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ
        { wch: 20 },  // Ø§Ù„Ù…Ø§Ù„Ùƒ
        { wch: 35 },  // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
        { wch: 20 },  // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
        { wch: 15 },  // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙŠØ¬Ø§Ø±
        { wch: 15 },  // Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        { wch: 15 },  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        { wch: 15 },  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        { wch: 15 },  // Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰
        { wch: 20 },  // Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡
        { wch: 15 }   // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
    ];
    ws['!cols'] = colWidths;

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙ†Ù Ø¹Ù…Ù„
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    const now = new Date();
    const isFiltered = filteredProperties.length > 0 && filteredProperties.length < properties.length;
    const filterSuffix = isFiltered ? '_Ù…ÙÙ„ØªØ±' : '';
    const fileName = `Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª${filterSuffix}_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}.xlsx`;

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
    XLSX.writeFile(wb, fileName);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    const message = isFiltered
        ? `âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${dataToExport.length} Ø³Ø¬Ù„ Ù…ÙÙ„ØªØ± Ù…Ù† Ø£ØµÙ„ ${properties.length} Ø³Ø¬Ù„`
        : `âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (${dataToExport.length} Ø³Ø¬Ù„)`;

    console.log(message);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (typeof showToast === 'function') {
        showToast(message, 'success');
    }
}

// ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
function updateExportButtonsText() {
    const isFiltered = filteredProperties.length > 0 && filteredProperties.length < properties.length;
    const exportText = isFiltered
        ? `ØªØµØ¯ÙŠØ± Excel (${filteredProperties.length} Ù…ÙÙ„ØªØ±)`
        : `ØªØµØ¯ÙŠØ± Excel (${properties.length} Ø³Ø¬Ù„)`;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const exportButtons = [
        document.getElementById('exportExcel'),
        document.querySelector('[onclick*="exportToExcel"]')
    ];

    exportButtons.forEach(button => {
        if (button) {
            // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ
            const icon = button.querySelector('i');
            if (icon) {
                button.innerHTML = icon.outerHTML + ' ' + exportText;
            } else {
                button.innerHTML = '<i class="fas fa-file-excel"></i> ' + exportText;
            }
        }
    });

    console.log(`ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ±: ${exportText}`);
}

// Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† localStorage Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');

    // Enable debug mode by adding ?debug=true to URL
    const urlParams = new URLSearchParams(window.location.search);
    window.debugMode = urlParams.get('debug') === 'true';

    if (window.debugMode) {
        console.log('ğŸ› ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­ Ù…ÙØ¹Ù„');
    }

    // ØªÙ‡ÙŠØ¦Ø© Supabase Ø£ÙˆÙ„Ø§Ù‹
    if (typeof initSupabase === 'function') {
        const supabaseInitialized = initSupabase();
        console.log('Supabase ØªÙ‡ÙŠØ¦Ø©:', supabaseInitialized ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„');
    } else {
        console.warn('âš ï¸ ÙˆØ¸ÙŠÙØ© initSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
    }

    const savedAttachments = localStorage.getItem('propertyAttachments');
    if (savedAttachments) {
        attachments = JSON.parse(savedAttachments);
    }

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    const savedCardAttachments = localStorage.getItem('cardAttachments');
    if (savedCardAttachments) {
        cardAttachments = JSON.parse(savedCardAttachments);
    }

    // Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    const attachmentsBtn = document.getElementById('attachmentsManagerBtn');
    if (attachmentsBtn) {
        attachmentsBtn.addEventListener('click', showAttachmentsManager);
    }

    // Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
    const mobileAttachmentsBtn = document.getElementById('mobile-attachments-btn');
    if (mobileAttachmentsBtn) {
        mobileAttachmentsBtn.addEventListener('click', function() {
            document.getElementById('mobileMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
            document.body.style.overflow = '';
            showAttachmentsManager();
        });
    }

    // Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    const propertyManagerBtn = document.getElementById('propertyManagerBtn');
    if (propertyManagerBtn) {
        propertyManagerBtn.addEventListener('click', showPropertyManager);
    }

    // Initialize enhanced attachments system
    setTimeout(() => {
        initializeAttachmentsSystem();

        // Initialize card attachments real-time sync
        if (typeof subscribeToCardAttachmentChanges === 'function') {
            console.log('ğŸ”„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª...');
            const cardSubscription = subscribeToCardAttachmentChanges();
            if (cardSubscription) {
                console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª');

                // Test the subscription after a short delay
                setTimeout(() => {
                    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ...');
                    console.log('ğŸ“¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:', cardSubscription.state);
                }, 3000);
            } else {
                console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª');
            }
        } else {
            console.warn('âš ï¸ ÙˆØ¸ÙŠÙØ© subscribeToCardAttachmentChanges ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }

        // Setup global card attachment event listeners
        setupGlobalCardAttachmentListeners();

    }, 2000); // Wait 2 seconds for other systems to load
});

// Setup global card attachment event listeners
function setupGlobalCardAttachmentListeners() {
    // Listen for card attachment events globally
    window.addEventListener('cardAttachmentAdded', (event) => {
        console.log(`ğŸŒ Ø­Ø¯Ø« Ø¹Ø§Ù„Ù…ÙŠ: ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© ${event.detail.cardKey}`);

        // Update any open card modals
        const openCardModal = document.querySelector('.card-attachments-modal[data-card-key="' + event.detail.cardKey + '"]');
        if (openCardModal) {
            refreshCardAttachmentsList(event.detail.cardKey);
        }

        // Update card counters in any open lists
        updateCardAttachmentCounters(event.detail.cardKey);
    });

    window.addEventListener('cardAttachmentDeleted', (event) => {
        console.log(`ğŸŒ Ø­Ø¯Ø« Ø¹Ø§Ù„Ù…ÙŠ: ØªÙ… Ø­Ø°Ù Ù…Ø±ÙÙ‚ Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${event.detail.cardKey}`);

        // Update any open card modals
        const openCardModal = document.querySelector('.card-attachments-modal[data-card-key="' + event.detail.cardKey + '"]');
        if (openCardModal) {
            refreshCardAttachmentsList(event.detail.cardKey);
        }

        // Update card counters in any open lists
        updateCardAttachmentCounters(event.detail.cardKey);
    });

    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª');
}

// Update card attachment counters in UI
function updateCardAttachmentCounters(cardKey) {
    // Update attachment count badges in property cards
    const propertyCards = document.querySelectorAll('.property-card');
    propertyCards.forEach(card => {
        const cardKeyAttr = card.getAttribute('data-card-key');
        if (cardKeyAttr === cardKey) {
            // Update attachment count
            updateCardAttachmentCount(card, cardKey);
        }
    });
}

// Helper function to update card attachment count
async function updateCardAttachmentCount(cardElement, cardKey) {
    try {
        let count = 0;

        if (typeof getCardAttachmentsEnhanced === 'function') {
            const attachments = await getCardAttachmentsEnhanced(cardKey);
            count = attachments.length;
        }

        // Update count badge
        const countBadge = cardElement.querySelector('.attachment-count');
        if (countBadge) {
            countBadge.textContent = `${count} Ù…Ø±ÙÙ‚`;
        }

    } catch (error) {
        console.warn(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${cardKey}:`, error);
    }
}

// Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
function showAttachmentsManager() {
    closeModal();

    // ÙØ­Øµ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    console.log('ğŸ” ÙØ­Øµ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:');
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', properties.length);
    console.log('ğŸ™ï¸ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', properties.slice(0, 3));

    if (properties.length === 0) {
        console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù„Ø©! Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        return;
    }

    const cities = getUniqueCountries().filter(c => c !== 'Ø§Ù„ÙƒÙ„');
    console.log('ğŸ™ï¸ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©:', cities);
    let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box attachments-manager-modal" style="max-width: 500px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-paperclip" style="color: #17a2b8;"></i>
                Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª - Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                <span class="badge" style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${cities.length}</span>
            </h3>
            <div class="country-selection" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">`;

    cities.forEach(city => {
        html += `
            <button onclick="showAttachmentsProperties('${city}')"
                    class="city-btn"
                    style="width: 100%; padding: 12px; margin: 4px 0; border-radius: 8px; cursor: pointer;
                           transition: all 0.3s ease; border: 1px solid #e9ecef; background: white;
                           display: flex; align-items: center; justify-content: space-between; min-height: 50px;">
                <span style="font-weight: 700; font-size: 1.3rem;">${city}</span>
                <i class="fas fa-arrow-left" style="color: #17a2b8;"></i>
            </button>
        `;
    });

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closeAttachmentsManagerModal();" class="modal-action-btn close-btn attachments-manager-close-btn" id="attachmentsManagerCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª - Ø¥ØºÙ„Ø§Ù‚');
                    closeAttachmentsManagerModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
function closeAttachmentsManagerModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');
    const modal = document.querySelector('.attachments-manager-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        }
    }
}

// Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±
// ...existing code...

// ...existing code...

function showAttachmentsProperties(city) {
    closeModal();

    // ØªØ³Ø¬ÙŠÙ„ ØªØ´Ø®ÙŠØµÙŠ Ù„Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    console.log(`ğŸ” showAttachmentsProperties ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù„Ù„Ù…Ø¯ÙŠÙ†Ø©: ${city}`);
    console.log('ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', properties.length);

    const cityProperties = properties.filter(p => p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === city);
    console.log(`ğŸ™ï¸ Ø¹Ù‚Ø§Ø±Ø§Øª ${city}:`, cityProperties.length);

    // Ø¹Ø±Ø¶ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
    const unitTypes = cityProperties.map(p => p['Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©']).filter(t => t);
    console.log('ğŸ  Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:', [...new Set(unitTypes)]);

    const props = cityProperties
        .map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
        .filter((v, i, arr) => v && arr.indexOf(v) === i);

    console.log('ğŸ“‹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©:', props);

    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box" style="max-width:420px;">
            <button class="close-modal" onclick="closeModal()" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
            <h3>Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¯ÙŠÙ†Ø© <span style="color:#2a4b9b">${city}</span></h3>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø±Ø§Ø¶ÙŠ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="showAttachmentsBuildingsModal('${city}')" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-city" style="margin-left: 5px;"></i>Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
                </button>
                <button onclick="showAttachmentsLandsModal('${city}')" style="flex: 1; padding: 10px; background: #ffc107; color: #212529; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-map" style="margin-left: 5px;"></i>Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
                </button>
            </div>

            <input type="text" id="attachmentsPropertySearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø±..." style="width:100%;margin-bottom:12px;padding:10px 12px;border-radius:8px;border:1.5px solid #d1d5db;font-size:1.05rem;">
            <div id="attachmentsPropertyList" style="max-height:350px;overflow:auto;display:flex;flex-direction:column;gap:8px;">`;
    props.forEach(prop => {
        html += `<button onclick="showAttachmentsModal('${city}','${prop}')" class="filter-btn" style="width:100%;margin-bottom:0;text-align:right;font-weight:bold;font-size:1.1em;">
            <i class="fas fa-building" style="color:#1e88e5;margin-left:8px;"></i>${prop}
        </button>`;
    });
    html += `</div>
        <div class="modal-actions">
            <button onclick="closeModal()" class="modal-action-btn close-btn">
                <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    </div></div>`;
    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¨Ø­Ø« Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    document.getElementById('attachmentsPropertySearch').addEventListener('input', function() {
        const term = this.value.trim().toLowerCase();
        document.querySelectorAll('#attachmentsPropertyList button').forEach(btn => {
            btn.style.display = btn.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
    });

    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
function showAttachmentsBuildingsModal(city) {
    closeModal();

    console.log(`ğŸ—ï¸ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙÙŠ ${city}`);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    const cityProperties = properties.filter(p => p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === city);
    const allPropertyNames = [...new Set(cityProperties.map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']).filter(name => name))];

    console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ ${city}:`, allPropertyNames.length);

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
    const buildingProperties = filterPropertiesByTypeLogic(allPropertyNames, 'buildings', city);

    console.log(`ğŸ—ï¸ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…ÙÙ„ØªØ±Ø© ÙÙŠ ${city}:`, buildingProperties.length);
    console.log('ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ:', buildingProperties);

    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box" style="max-width:420px;">
            <button class="close-modal" onclick="closeModal()" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
            <h3 style="color: #28a745;">
                <i class="fas fa-city" style="margin-left: 8px;"></i>
                Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ - <span style="color:#2a4b9b">${city}</span>
                <span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${buildingProperties.length}</span>
            </h3>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø«Ø§Ø¨ØªØ© -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="showAttachmentsBuildingsModal('${city}')" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 1;">
                    <i class="fas fa-city" style="margin-left: 5px;"></i>Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
                </button>
                <button onclick="showAttachmentsLandsModal('${city}')" style="flex: 1; padding: 10px; background: #ffc107; color: #212529; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;">
                    <i class="fas fa-map" style="margin-left: 5px;"></i>Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
                </button>
            </div>

            <input type="text" id="attachmentsBuildingSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¨Ù†Ù‰..." style="width:100%;margin-bottom:12px;padding:10px 12px;border-radius:8px;border:1.5px solid #d1d5db;font-size:1.05rem;">
            <div id="attachmentsBuildingList" style="max-height:350px;overflow:auto;display:flex;flex-direction:column;gap:8px;">`;

    if (buildingProperties.length === 0) {
        html += `<div style="text-align: center; padding: 40px; color: #6c757d;">
            <i class="fas fa-city" style="font-size: 3rem; color: #28a745; margin-bottom: 20px;"></i>
            <p style="font-size: 1.1rem; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù†ÙŠ</p>
            <p style="font-size: 0.9rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¨Ø§Ù†ÙŠ ÙÙŠ ${city}</p>
        </div>`;
    } else {
        buildingProperties.forEach(prop => {
            html += `<button onclick="showAttachmentsModal('${city}','${prop}')" class="filter-btn" style="width:100%;margin-bottom:0;text-align:right;font-weight:bold;font-size:1.1em;">
                <i class="fas fa-city" style="color:#28a745;margin-left:8px;"></i>${prop}
            </button>`;
        });
    }

    html += `</div>
        <div class="modal-actions">
            <button onclick="closeModal()" class="modal-action-btn close-btn">
                <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    </div></div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¨Ø­Ø« Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    setTimeout(() => {
        const searchInput = document.getElementById('attachmentsBuildingSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const term = this.value.trim().toLowerCase();
                document.querySelectorAll('#attachmentsBuildingList button').forEach(btn => {
                    btn.style.display = btn.textContent.toLowerCase().includes(term) ? '' : 'none';
                });
            });
        }

        document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
function showAttachmentsLandsModal(city) {
    closeModal();

    console.log(`ğŸ—ºï¸ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ ÙÙŠ ${city}`);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    const cityProperties = properties.filter(p => p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === city);
    const allPropertyNames = [...new Set(cityProperties.map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']).filter(name => name))];

    console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ ${city}:`, allPropertyNames.length);

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
    const landProperties = filterPropertiesByTypeLogic(allPropertyNames, 'lands', city);

    console.log(`ğŸ—ºï¸ Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ø§Ù„Ù…ÙÙ„ØªØ±Ø© ÙÙŠ ${city}:`, landProperties.length);
    console.log('ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ:', landProperties);

    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box" style="max-width:420px;">
            <button class="close-modal" onclick="closeModal()" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
            <h3 style="color: #ffc107;">
                <i class="fas fa-map" style="margin-left: 8px;"></i>
                Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ - <span style="color:#2a4b9b">${city}</span>
                <span class="badge" style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${landProperties.length}</span>
            </h3>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø«Ø§Ø¨ØªØ© -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="showAttachmentsBuildingsModal('${city}')" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;">
                    <i class="fas fa-city" style="margin-left: 5px;"></i>Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
                </button>
                <button onclick="showAttachmentsLandsModal('${city}')" style="flex: 1; padding: 10px; background: #ffc107; color: #212529; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 1;">
                    <i class="fas fa-map" style="margin-left: 5px;"></i>Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
                </button>
            </div>

            <input type="text" id="attachmentsLandSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø£Ø±Ø¶ Ø£Ùˆ Ø­ÙˆØ´..." style="width:100%;margin-bottom:12px;padding:10px 12px;border-radius:8px;border:1.5px solid #d1d5db;font-size:1.05rem;">
            <div id="attachmentsLandList" style="max-height:350px;overflow:auto;display:flex;flex-direction:column;gap:8px;">`;

    if (landProperties.length === 0) {
        html += `<div style="text-align: center; padding: 40px; color: #6c757d;">
            <i class="fas fa-map" style="font-size: 3rem; color: #ffc107; margin-bottom: 20px;"></i>
            <p style="font-size: 1.1rem; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ø§Ø¶ÙŠ</p>
            <p style="font-size: 0.9rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ø§Ø¶ÙŠ Ø£Ùˆ Ø­ÙˆØ´ ÙÙŠ ${city}</p>
        </div>`;
    } else {
        landProperties.forEach(prop => {
            html += `<button onclick="showAttachmentsModal('${city}','${prop}')" class="filter-btn" style="width:100%;margin-bottom:0;text-align:right;font-weight:bold;font-size:1.1em;">
                <i class="fas fa-map" style="color:#ffc107;margin-left:8px;"></i>${prop}
            </button>`;
        });
    }

    html += `</div>
        <div class="modal-actions">
            <button onclick="closeModal()" class="modal-action-btn close-btn">
                <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    </div></div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¨Ø­Ø« Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    setTimeout(() => {
        const searchInput = document.getElementById('attachmentsLandSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const term = this.value.trim().toLowerCase();
                document.querySelectorAll('#attachmentsLandList button').forEach(btn => {
                    btn.style.display = btn.textContent.toLowerCase().includes(term) ? '' : 'none';
                });
            });
        }

        document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    }, 100);
}



// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙƒÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
function adjustModalSizeBasedOnContent(attachmentCount) {
    const modal = document.querySelector('.attachments-modal.enhanced');
    if (!modal) return;

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    modal.classList.remove('no-attachments', 'few-attachments', 'many-attachments');

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    if (attachmentCount === 0) {
        modal.classList.add('no-attachments');
    } else if (attachmentCount <= 5) {
        modal.classList.add('few-attachments');
    } else {
        modal.classList.add('many-attachments');
    }

    console.log(`ğŸ“ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${attachmentCount} Ù…Ø±ÙÙ‚`);
}

// Enhanced attachments modal with real-time cross-device synchronization (Updated to match Card Attachments)
function showAttachmentsModal(city, propertyName) {
    console.log('ğŸ¯ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±...', { city, propertyName });

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
    document.body.style.height = '100%';
    document.documentElement.style.overflow = 'hidden';

    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù†ÙˆØ§ÙØ° Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
    closeModal();

    const propertyKey = `${city}_${propertyName}`;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const canDelete = isAuthorizedUser();
    const canUpload = isAuthorizedUser();

    // Try to get attachments from Supabase first, fallback to local
    async function loadPropertyAttachments() {
        let propertyAttachments = [];
        let isFromCloud = false;

        // Try Supabase first
        if (typeof getPropertyAttachmentsEnhanced === 'function' && supabaseClient) {
            try {
                console.log(`â˜ï¸ Ø¬Ù„Ø¨ Ù…Ø±ÙÙ‚Ø§Øª ${propertyKey} Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...`);
                propertyAttachments = await getPropertyAttachmentsEnhanced(propertyKey);
                isFromCloud = true;
                console.log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${propertyAttachments.length} Ù…Ø±ÙÙ‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
            } catch (error) {
                console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:', error);
            }
        }

        // Fallback to local attachments if no cloud data
        if (!isFromCloud || propertyAttachments.length === 0) {
            propertyAttachments = window.attachments?.[propertyKey] || [];
            console.log(`ğŸ’¾ ØªÙ… Ø¬Ù„Ø¨ ${propertyAttachments.length} Ù…Ø±ÙÙ‚ Ù…Ø­Ù„ÙŠ`);
        }

        return { propertyAttachments, isFromCloud };
    }

    // ØªØµÙ…ÙŠÙ… Ù…Ø®ØªÙ„Ù Ù„Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    const isMobile = isMobileDevice();

    let html;

    if (isMobile) {
        // ØªØµÙ…ÙŠÙ… Ù…Ø¶ØºÙˆØ· Ù„Ù„Ø¬ÙˆØ§Ù„
        html = `
        <div class="modal-overlay mobile-attachments-overlay" style="display:flex;">
            <div class="modal-box mobile-attachments-modal compact">
                <!-- Ø±Ø£Ø³ Ù…Ø¶ØºÙˆØ· - ØµÙ ÙˆØ§Ø­Ø¯ -->
                <div class="mobile-compact-header">
                    <div class="header-content">
                        <span class="header-title"><i class="fas fa-paperclip"></i> Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±</span>
                        <span class="header-separator">|</span>
                        <span class="header-info"><i class="fas fa-building"></i> ${propertyName}</span>
                        <span class="header-separator">|</span>
                        <span class="header-info"><i class="fas fa-map-marker-alt"></i> ${city}</span>
                    </div>

                </div>

                <!-- Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø¯ÙˆØ¯ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© -->
                ${!canUpload && !canDelete ? `
                <div class="limited-user-notice" style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 12px; margin-bottom: 15px; text-align: center;">
                    <i class="fas fa-info-circle" style="color: #2196f3; margin-left: 8px;"></i>
                    <span style="color: #1976d2; font-size: 0.9rem;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙ‚Ø·</span>
                </div>
                ` : ''}

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ³Ø¹Ø© -->
                <div class="mobile-attachments-section expanded">
                    <div class="mobile-attachments-header-small">
                        <span><i class="fas fa-folder-open"></i> Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</span>
                        <span class="mobile-attachments-count" id="mobilePropertyAttachmentsCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>
                    <div id="propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="mobile-attachments-list">
                        <div class="mobile-loading" style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 10px;"></i>
                            <p style="font-size: 0.9rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...</p>
                        </div>
                    </div>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³ÙÙ„ - Ù…Ø«Ù„ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
                <div class="bottom-buttons-row">
                    ${canUpload ? `
                    <button class="bottom-action-btn upload drag-drop-zone"
                            onclick="document.getElementById('propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}').click()"
                            ondragover="handleDragOver(event)"
                            ondragenter="handleDragEnter(event)"
                            ondragleave="handleDragLeave(event)"
                            ondrop="handleDrop(event, 'propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}')">
                        <i class="fas fa-plus"></i> Ø¥Ø±ÙØ§Ù‚
                    </button>
                    ` : ''}
                    <button class="bottom-action-btn cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>

                <!-- Ø­Ù‚Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø®ÙÙŠ -->
                ${canUpload ? `
                <input type="file" id="propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" multiple style="display:none" onchange="handleFileUploadEnhanced(event, '${city}', '${propertyName}')">
                ` : ''}
            </div>
        </div>`;
    } else {
        // ØªØµÙ…ÙŠÙ… Ù…Ø¶ØºÙˆØ· Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
        html = `
        <div class="modal-overlay enhanced-modal-overlay" style="display:flex;">
            <div class="modal-box attachments-modal enhanced compact">
                <!-- Ø±Ø£Ø³ Ù…Ø¶ØºÙˆØ· - ØµÙ ÙˆØ§Ø­Ø¯ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ -->
                <div class="compact-header-row">
                    <div class="header-content-inline">
                        <span class="header-title"><i class="fas fa-paperclip"></i> Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±</span>
                        <span class="header-separator">|</span>
                        <span class="header-info"><i class="fas fa-building"></i> ${propertyName}</span>
                        <span class="header-separator">|</span>
                        <span class="header-info"><i class="fas fa-map-marker-alt"></i> ${city}</span>
                    </div>
                    <button class="header-close-btn" onclick="closeModal()" title="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø¯ÙˆØ¯ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© -->
                ${!canUpload && !canDelete ? `
                <div class="limited-user-notice" style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-info-circle" style="color: #2196f3; margin-left: 10px; font-size: 1.2rem;"></i>
                    <span style="color: #1976d2; font-size: 1rem; font-weight: 500;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙ‚Ø·</span>
                </div>
                ` : ''}

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ³Ø¹Ø© -->
                <div class="attachments-main-section" style="width: 100%;">
                    <div class="attachments-header">
                        <h3><i class="fas fa-folder-open"></i> Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h3>
                    </div>
                    <div id="propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="attachments-list expanded">
                        <div class="loading-attachments" style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...</p>
                        </div>
                    </div>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³ÙÙ„ -->
                <div class="bottom-buttons-row">
                    ${canUpload ? `
                    <button class="bottom-action-btn upload drag-drop-zone"
                            onclick="document.getElementById('propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}').click()"
                            ondragover="handleDragOver(event)"
                            ondragenter="handleDragEnter(event)"
                            ondragleave="handleDragLeave(event)"
                            ondrop="handleDrop(event, 'propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}')">
                        <i class="fas fa-plus"></i> Ø¥Ø±ÙØ§Ù‚
                    </button>
                    ` : ''}
                    <button class="bottom-action-btn cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>

                <!-- Ø­Ù‚Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø®ÙÙŠ -->
                ${canUpload ? `
                <input type="file" id="propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" multiple style="display:none" onchange="handleFileUploadEnhanced(event, '${city}', '${propertyName}')">
                ` : ''}
            </div>
        </div>`;
    }

    // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    document.body.insertAdjacentHTML('beforeend', html);

    // ğŸ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
    loadPropertyAttachments().then(({ propertyAttachments, isFromCloud }) => {
        console.log(`ğŸ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${propertyAttachments.length} Ù…Ø±ÙÙ‚ Ù„Ù„Ø¹Ù‚Ø§Ø± ${propertyKey} (${isFromCloud ? 'Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©' : 'Ù…Ø­Ù„ÙŠ'})`);

        const listContainer = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (listContainer) {
            // Force visibility with enhanced mobile support
            listContainer.style.display = 'block';
            listContainer.style.visibility = 'visible';
            listContainer.style.opacity = '1';

            // Add mobile-specific classes
            if (isMobileDevice()) {
                listContainer.classList.add('mobile-list', 'mobile-optimized');
                listContainer.style.minHeight = '300px';
                listContainer.style.maxHeight = '60vh';
                listContainer.style.overflowY = 'auto';
            }

            // Render attachments with layout specific to device type
            if (isMobileDevice()) {
                listContainer.innerHTML = renderMobilePropertyAttachmentsList(propertyKey, propertyAttachments);

                // Update mobile attachments count
                const mobileCountBadge = document.getElementById(`mobilePropertyAttachmentsCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (mobileCountBadge) {
                    mobileCountBadge.textContent = `${propertyAttachments.length} Ù…Ø±ÙÙ‚`;
                }
            } else {
                listContainer.innerHTML = renderPropertyAttachmentsList(propertyKey, propertyAttachments);

                // Enhanced mobile display optimization
                enhanceAttachmentDisplayForMobile();
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(() => {
                setupPropertyAttachmentsScroll(propertyKey);
            }, 100);

            // Ø¥Ø¶Ø§ÙØ© Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙ‚Ø·)
            if (!isMobileDevice()) {
                setTimeout(() => {
                    scrollToAttachments();
                }, 300);
            }

            console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„');

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙƒÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            adjustModalSizeBasedOnContent(propertyAttachments.length);

            // Initialize search functionality
            setTimeout(() => {
                initAttachmentsSearch(propertyKey);
                // ØªÙ‡ÙŠØ¦Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                updateAttachmentSelectedCount(propertyKey);
            }, 200);
        } else {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        }
    }).catch(error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);

        const listContainer = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="error-loading-attachments enhanced-error" style="text-align: center; padding: ${isMobileDevice() ? '40px 20px' : '20px'}; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="font-size: ${isMobileDevice() ? '3rem' : '2rem'}; margin-bottom: ${isMobileDevice() ? '20px' : '10px'};"></i>
                    <p style="font-size: ${isMobileDevice() ? '1.2rem' : '1rem'};">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</p>
                    <button onclick="refreshPropertyAttachmentsList('${propertyKey}')" class="btn-primary" style="margin-top: ${isMobileDevice() ? '15px' : '10px'}; padding: ${isMobileDevice() ? '12px 20px' : '8px 16px'}; font-size: ${isMobileDevice() ? '1.1rem' : '0.9rem'};">
                        <i class="fas fa-refresh"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                </div>
            `;
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
    setupPropertyDragAndDrop(propertyKey);
}

// ===== Render Property Attachments List (Desktop) =====
function renderPropertyAttachmentsList(propertyKey, attachments) {
    console.log(`ğŸ–¥ï¸ Ø¹Ø±Ø¶ ${attachments.length} Ù…Ø±ÙÙ‚ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© - Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyKey}`);

    if (!attachments || attachments.length === 0) {
        return `
            <div class="no-attachments-state" style="text-align: center; padding: 40px 20px; color: #6c757d;">
                <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                <h4 style="margin: 10px 0; font-size: 1.2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª</h4>
                <p style="margin: 0; opacity: 0.7;">Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª</p>
            </div>
        `;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const canDelete = isAuthorizedUser();
    const canUpload = isAuthorizedUser();

    // Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø®ÙˆÙ„ÙŠÙ†)
    let html = '';
    if (canDelete) {
        html += `
            <div class="attachments-bulk-controls" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label class="bulk-select-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="selectAllAttachments_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}"
                                   onchange="toggleSelectAllAttachments('${propertyKey}')"
                                   style="width: 18px; height: 18px; cursor: pointer;">
                            <span>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span>
                        </label>
                        <span id="selectedCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="selected-count"
                              style="color: #6c757d; font-size: 0.9rem; display: none;">
                            (0 Ù…Ø­Ø¯Ø¯)
                        </span>
                    </div>
                    <button id="deleteSelectedBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}"
                            onclick="deleteSelectedAttachments('${propertyKey}')"
                            class="btn-danger bulk-delete-btn"
                            style="display: none; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
                    </button>
                </div>
            </div>
        `;
    }

    html += attachments.map((file, index) => {
        // Handle both local and cloud file formats
        const fileName = file.file_name || file.name;
        const fileSize = formatFileSize(file.file_size || file.size);
        const fileType = file.file_type || file.type;
        const uploadDate = new Date(file.created_at || file.uploadDate).toLocaleDateString('ar-SA');
        const fileIcon = getFileIcon(fileName);

        // Determine file source
        const isCloudFile = file.file_url || file.url;
        const sourceIcon = isCloudFile ? 'â˜ï¸' : 'ğŸ’¾';
        const sourceText = isCloudFile ? 'Ø³Ø­Ø§Ø¨ÙŠ' : 'Ù…Ø­Ù„ÙŠ';
        const fileId = file.id || `local_${index}`;

        return `
            <div class="attachment-item desktop-enhanced-item" data-file-index="${index}" data-file-id="${fileId}">
                ${canDelete ? `
                <div class="attachment-checkbox" style="margin-left: 12px;">
                    <input type="checkbox" class="attachment-select"
                           data-file-id="${fileId}"
                           data-property-key="${propertyKey}"
                           onchange="updateAttachmentSelectedCount('${propertyKey}')"
                           style="width: 16px; height: 16px; cursor: pointer;">
                </div>
                ` : ''}
                <div class="file-icon-enhanced" style="color: ${getFileIconColor(fileName)};">
                    ${fileIcon}
                </div>
                <div class="file-details-enhanced">
                    <div class="file-name-text" title="${fileName}">
                        ${fileName}
                    </div>
                </div>
                <div class="attachment-actions-enhanced">
                    ${isCloudFile ?
                        `<button class="btn-enhanced download-btn" onclick="downloadAttachmentFromSupabase('${file.file_url || file.url}', '${fileName}')" title="ØªØ­Ù…ÙŠÙ„">
                            <i class="fas fa-download"></i>
                            <span>ØªØ­Ù…ÙŠÙ„</span>
                        </button>
                        ${canDelete ? `<button class="btn-enhanced delete-btn" onclick="deletePropertyAttachmentFromSupabase('${file.id}', '${propertyKey}')" title="Ø­Ø°Ù">
                            <i class="fas fa-trash"></i>
                            <span>Ø­Ø°Ù</span>
                        </button>` : ''}` :
                        `<button class="btn-enhanced download-btn" onclick="downloadPropertyAttachment('${propertyKey}', ${index})" title="ØªØ­Ù…ÙŠÙ„">
                            <i class="fas fa-download"></i>
                            <span>ØªØ­Ù…ÙŠÙ„</span>
                        </button>
                        ${canDelete ? `<button class="btn-enhanced delete-btn" onclick="deletePropertyAttachment('${propertyKey}', ${index})" title="Ø­Ø°Ù">
                            <i class="fas fa-trash"></i>
                            <span>Ø­Ø°Ù</span>
                        </button>` : ''}`
                    }
                </div>
                </div>
            </div>
        `;
    }).join('');

    return html;
}

// ===== Render Mobile Property Attachments List =====
function renderMobilePropertyAttachmentsList(propertyKey, attachments) {
    console.log(`ğŸ“± Ø¹Ø±Ø¶ ${attachments.length} Ù…Ø±ÙÙ‚ Ù„Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyKey}`);

    if (!attachments || attachments.length === 0) {
        return `
            <div class="mobile-no-attachments" style="text-align: center; padding: 30px 20px; color: #6c757d;">
                <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p style="margin: 0; font-size: 0.9rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª</p>
                <small style="opacity: 0.7;">Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚" Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</small>
            </div>
        `;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const canDelete = isAuthorizedUser();
    const canUpload = isAuthorizedUser();

    // Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„Ø¬ÙˆØ§Ù„ (ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø®ÙˆÙ„ÙŠÙ†)
    let html = '';
    if (canDelete) {
        html += `
            <div class="mobile-bulk-controls" style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e9ecef;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                    <label class="mobile-bulk-select-label" style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                        <input type="checkbox" id="selectAllAttachments_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}"
                               onchange="toggleSelectAllAttachments('${propertyKey}')"
                               style="width: 16px; height: 16px; cursor: pointer;">
                        <span>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span>
                    </label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="selectedCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="mobile-selected-count"
                              style="color: #6c757d; font-size: 0.8rem; display: none;">
                            (0 Ù…Ø­Ø¯Ø¯)
                        </span>
                        <button id="deleteSelectedBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}"
                                onclick="deleteSelectedAttachments('${propertyKey}')"
                                class="mobile-bulk-delete-btn"
                                style="display: none; padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    attachments.forEach((file, index) => {
        // Handle both local and cloud file formats
        const fileName = file.file_name || file.name;
        const fileSize = formatFileSize(file.file_size || file.size);
        const uploadDate = new Date(file.created_at || file.uploadDate).toLocaleDateString('ar-SA');
        const fileIcon = getFileIcon(fileName);

        // Determine file source
        const isCloudFile = file.file_url || file.url;
        const sourceIcon = isCloudFile ? 'â˜ï¸' : 'ğŸ’¾';
        const sourceText = isCloudFile ? 'Ø³Ø­Ø§Ø¨ÙŠ' : 'Ù…Ø­Ù„ÙŠ';
        const fileId = file.id || `local_${index}`;

        html += `
            <div class="mobile-attachment-item" data-file-index="${index}" data-file-id="${fileId}">
                ${canDelete ? `
                <!-- ØªØ´ÙŠÙƒ Ø¨ÙˆÙƒØ³ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ -->
                <div class="mobile-attachment-checkbox" style="margin-left: 8px;">
                    <input type="checkbox" class="attachment-select"
                           data-file-id="${fileId}"
                           data-property-key="${propertyKey}"
                           onchange="updateAttachmentSelectedCount('${propertyKey}')"
                           style="width: 14px; height: 14px; cursor: pointer;">
                </div>
                ` : ''}

                <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„Ù -->
                <div class="mobile-file-icon" style="color: ${getFileIconColor(fileName)};">
                    ${fileIcon}
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù -->
                <div class="mobile-file-info">
                    <div class="mobile-file-name" title="${fileName}">
                        ${fileName}
                    </div>
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø£Ø³ÙÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© -->
                    <div class="mobile-file-actions" style="margin-top: 8px;">
                        ${isCloudFile ?
                            `<button class="mobile-action-btn download" onclick="downloadAttachmentFromSupabase('${file.file_url || file.url}', '${fileName}')" title="ØªØ­Ù…ÙŠÙ„">
                                <i class="fas fa-download"></i>
                                <span>ØªØ­Ù…ÙŠÙ„</span>
                            </button>
                            ${canDelete ? `<button class="mobile-action-btn delete" onclick="deletePropertyAttachmentFromSupabase('${file.id}', '${propertyKey}')" title="Ø­Ø°Ù">
                                <i class="fas fa-trash"></i>
                                <span>Ø­Ø°Ù</span>
                            </button>` : ''}` :
                            `<button class="mobile-action-btn download" onclick="downloadPropertyAttachment('${propertyKey}', ${index})" title="ØªØ­Ù…ÙŠÙ„">
                                <i class="fas fa-download"></i>
                                <span>ØªØ­Ù…ÙŠÙ„</span>
                            </button>
                            ${canDelete ? `<button class="mobile-action-btn delete" onclick="deletePropertyAttachment('${propertyKey}', ${index})" title="Ø­Ø°Ù">
                                <i class="fas fa-trash"></i>
                                <span>Ø­Ø°Ù</span>
                            </button>` : ''}`
                        }
                    </div>
                </div>
            </div>
        `;
    });

    console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ - ${attachments.length} Ø¹Ù†ØµØ±`);
    return html;
}

// ===== Setup Property Attachments Scroll =====
function setupPropertyAttachmentsScroll(propertyKey) {
    console.log('ğŸ“œ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ÙƒØ±ÙˆÙ„ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰...');

    const attachmentsList = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const scrollToTopBtn = document.getElementById(`scrollToTopBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (!attachmentsList || !scrollToTopBtn) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø§Ø³ÙƒØ±ÙˆÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
    attachmentsList.addEventListener('scroll', function() {
        const scrollTop = this.scrollTop;
        const scrollThreshold = 100; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± 100px

        if (scrollTop > scrollThreshold) {
            scrollToTopBtn.classList.add('show');
        } else {
            scrollToTopBtn.classList.remove('show');
        }
    });

    // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø¬ÙˆØ§Ù„
    if (isMobileDevice()) {
        attachmentsList.style.webkitOverflowScrolling = 'touch';
        attachmentsList.style.scrollBehavior = 'smooth';
    }

    console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ÙƒØ±ÙˆÙ„ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
}

// ===== Scroll to Top Function for Property Attachments =====
function scrollToTopPropertyAttachments(propertyKey) {
    console.log('â¬†ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±...');

    const attachmentsList = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (attachmentsList) {
        // Ø§Ø³ÙƒØ±ÙˆÙ„ Ø³Ù„Ø³ Ù„Ù„Ø£Ø¹Ù„Ù‰
        attachmentsList.scrollTo({
            top: 0,
            behavior: 'smooth'
        });

        // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø²Ø±
        const scrollToTopBtn = document.getElementById(`scrollToTopBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (scrollToTopBtn) {
            scrollToTopBtn.style.transform = 'scale(0.9)';
            setTimeout(() => {
                scrollToTopBtn.style.transform = 'scale(1)';
            }, 150);
        }

        console.log('âœ… ØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±');
    } else {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±');
    }
}

// ===== Setup Property Drag and Drop =====
function setupPropertyDragAndDrop(propertyKey) {
    console.log('ğŸ¯ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±...');

    const uploadArea = document.getElementById(`propertyUploadArea_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (!uploadArea) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ÙÙ„Ø§Øª
    uploadArea.addEventListener('drop', handlePropertyDrop, false);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        uploadArea.classList.add('dragover');
        uploadArea.style.borderColor = '#007bff';
        uploadArea.style.backgroundColor = '#f8f9ff';
    }

    function unhighlight(e) {
        uploadArea.classList.remove('dragover');
        uploadArea.style.borderColor = '#007bff';
        uploadArea.style.backgroundColor = 'white';
    }

    function handlePropertyDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† propertyKey
            const [city, propertyName] = propertyKey.split('_');

            // Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„Ù
            const fileInput = document.getElementById(`propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (fileInput) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¯Ø« Ù…Ø®ØµØµ
                const event = new Event('change');
                Object.defineProperty(event, 'target', {
                    value: { files: files },
                    enumerable: true
                });

                handleFileUploadEnhanced(event, city, propertyName);
            }
        }
    }

    console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±');
}

// ===== Property Attachment Functions =====

// Ø¹Ø±Ø¶ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±
function viewPropertyAttachment(propertyKey, fileIndex) {
    const propertyFiles = attachments[propertyKey] || [];
    const file = propertyFiles[fileIndex];

    if (!file) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù');
        return;
    }

    // ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    const newWindow = window.open('', '_blank');
    newWindow.document.write(`
        <html>
            <head>
                <title>${file.name}</title>
                <style>
                    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                    img { max-width: 100%; height: auto; }
                    .file-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                </style>
            </head>
            <body>
                <div class="file-info">
                    <h2>${file.name}</h2>
                    <p>Ø§Ù„Ø­Ø¬Ù…: ${formatFileSize(file.size)}</p>
                    <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹: ${new Date(file.uploadDate).toLocaleDateString('ar-SA')}</p>
                    ${file.notes ? `<p>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${file.notes}</p>` : ''}
                </div>
                ${file.type.startsWith('image/') ?
                    `<img src="${file.data}" alt="${file.name}">` :
                    `<p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª. <a href="${file.data}" download="${file.name}">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a></p>`
                }
            </body>
        </html>
    `);
}

// ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø± - Enhanced for all file types
function downloadPropertyAttachment(propertyKey, fileIndex) {
    const propertyFiles = attachments[propertyKey] || [];
    const file = propertyFiles[fileIndex];

    if (!file) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù');
        return;
    }

    try {
        console.log(`ğŸ“¥ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${file.name}`);

        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        showDownloadProgress(file.name, true);

        // ØªØ­ÙˆÙŠÙ„ base64 Ø¥Ù„Ù‰ blob Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        let downloadUrl = file.data;
        let shouldRevoke = false;

        if (file.data.startsWith('data:')) {
            // ØªØ­ÙˆÙŠÙ„ data URL Ø¥Ù„Ù‰ blob Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­
            const response = fetch(file.data);
            response.then(res => res.blob()).then(blob => {
                downloadUrl = window.URL.createObjectURL(blob);
                shouldRevoke = true;
                performDownload();
            });
        } else {
            performDownload();
        }

        function performDownload() {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = file.name;
            link.style.display = 'none';

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„ØµÙØ­Ø© ÙˆØªÙØ¹ÙŠÙ„Ù‡
            document.body.appendChild(link);
            link.click();

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
            document.body.removeChild(link);
            if (shouldRevoke) {
                window.URL.revokeObjectURL(downloadUrl);
            }

            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            showDownloadProgress(file.name, false);
            showMiniIconNotification('ğŸ“¥', '#28a745', 2000);

            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­: ${file.name}`);
        }

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø± ${file.name}:`, error);

        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        showDownloadProgress(file.name, false);
        showMiniIconNotification('âŒ', '#dc3545', 3000);

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙƒØ¨Ø¯ÙŠÙ„
        const link = document.createElement('a');
        link.href = file.data;
        link.download = file.name;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Ø­Ø°Ù Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±
function deletePropertyAttachment(propertyKey, fileIndex) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')) return;

    attachments[propertyKey] = (attachments[propertyKey] || []).filter((_, index) => index !== fileIndex);
    localStorage.setItem('attachments', JSON.stringify(attachments));

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const listContainer = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (listContainer) {
        if (isMobileDevice()) {
            listContainer.innerHTML = renderMobilePropertyAttachmentsList(propertyKey, attachments[propertyKey] || []);
        } else {
            listContainer.innerHTML = renderPropertyAttachmentsList(propertyKey, attachments[propertyKey] || []);
        }
    }
}

// Ø­Ø°Ù Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† Supabase
async function deletePropertyAttachmentFromSupabase(attachmentId, propertyKey) {
    try {
        if (typeof deleteAttachmentEnhanced === 'function') {
            const success = await deleteAttachmentEnhanced(attachmentId);

            if (success) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                await refreshPropertyAttachmentsList(propertyKey);
                console.log('âœ… ØªÙ… Ø­Ø°Ù Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
            }
        } else {
            console.warn('âš ï¸ ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
async function refreshPropertyAttachmentsList(propertyKey) {
    console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyKey}`);
    console.log(`ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: window.attachments=${!!window.attachments}, attachments=${!!attachments}`);

    const listContainer = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (!listContainer) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        return;
    }

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        listContainer.style.opacity = '0.5';

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        let propertyAttachments = [];
        let isFromCloud = false;

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹
        if (typeof getPropertyAttachmentsEnhanced === 'function' && supabaseClient) {
            try {
                console.log(`â˜ï¸ Ø¬Ù„Ø¨ Ù…Ø±ÙÙ‚Ø§Øª ${propertyKey} Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...`);
                propertyAttachments = await getPropertyAttachmentsEnhanced(propertyKey);
                isFromCloud = true;
                console.log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${propertyAttachments.length} Ù…Ø±ÙÙ‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
            } catch (cloudError) {
                console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:', cloudError);
            }
        }

        // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        if (!isFromCloud || propertyAttachments.length === 0) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø£Ùˆ localStorage
            const localAttachments = window.attachments?.[propertyKey] ||
                                   JSON.parse(localStorage.getItem('propertyAttachments') || '{}')[propertyKey] ||
                                   [];
            propertyAttachments = localAttachments;
            console.log(`ğŸ’¾ ØªÙ… Ø¬Ù„Ø¨ ${propertyAttachments.length} Ù…Ø±ÙÙ‚ Ù…Ø­Ù„ÙŠ`);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        if (isMobileDevice()) {
            listContainer.innerHTML = renderMobilePropertyAttachmentsList(propertyKey, propertyAttachments);

            // Update mobile attachments count
            const mobileCountBadge = document.getElementById(`mobilePropertyAttachmentsCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (mobileCountBadge) {
                mobileCountBadge.textContent = `${propertyAttachments.length} Ù…Ø±ÙÙ‚`;
            }
        } else {
            listContainer.innerHTML = renderPropertyAttachmentsList(propertyKey, propertyAttachments);
        }

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´ÙØ§ÙÙŠØ©
        listContainer.style.opacity = '1';

        // ØªÙ‡ÙŠØ¦Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
        setTimeout(() => {
            updateAttachmentSelectedCount(propertyKey);
        }, 100);

        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±: ${attachments.length} Ù…Ù„Ù`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        listContainer.innerHTML = `
            <div class="error-loading-attachments" style="text-align: center; padding: 20px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</p>
                <button onclick="refreshPropertyAttachmentsList('${propertyKey}')" class="btn-primary">
                    <i class="fas fa-refresh"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
            </div>
        `;

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´ÙØ§ÙÙŠØ©
        listContainer.style.opacity = '1';
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª =====

// ØªØ¨Ø¯ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
function toggleSelectAllAttachments(propertyKey) {
    console.log(`ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø¹Ù‚Ø§Ø±: ${propertyKey}`);

    const selectAllCheckbox = document.getElementById(`selectAllAttachments_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const attachmentCheckboxes = document.querySelectorAll(`.attachment-select[data-property-key="${propertyKey}"]`);

    if (!selectAllCheckbox || !attachmentCheckboxes.length) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯');
        return;
    }

    const isChecked = selectAllCheckbox.checked;

    // ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    attachmentCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ²Ø± Ø§Ù„Ø­Ø°Ù
    updateAttachmentSelectedCount(propertyKey);

    console.log(`âœ… ØªÙ… ${isChecked ? 'ØªØ­Ø¯ÙŠØ¯' : 'Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯'} Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª`);
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
function updateAttachmentSelectedCount(propertyKey) {
    console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±: ${propertyKey}`);

    const attachmentCheckboxes = document.querySelectorAll(`.attachment-select[data-property-key="${propertyKey}"]:checked`);
    const totalCheckboxes = document.querySelectorAll(`.attachment-select[data-property-key="${propertyKey}"]`);
    const selectedCount = attachmentCheckboxes.length;
    const totalCount = totalCheckboxes.length;

    console.log(`ğŸ“Š Ø§Ù„Ø¹Ø¯Ø§Ø¯: ${selectedCount}/${totalCount} Ù…Ø±ÙÙ‚ Ù…Ø­Ø¯Ø¯`);

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯
    const countElement = document.getElementById(`selectedCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (countElement) {
        if (selectedCount > 0) {
            countElement.textContent = `(${selectedCount} Ù…Ø­Ø¯Ø¯)`;
            countElement.style.display = 'inline';
            console.log(`âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø¯Ø§Ø¯: ${selectedCount} Ù…Ø­Ø¯Ø¯`);
        } else {
            countElement.style.display = 'none';
            console.log(`ğŸ”„ ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯`);
        }
    } else {
        console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯: selectedCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    }

    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø°Ù
    const deleteBtnId = `deleteSelectedBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const deleteBtn = document.getElementById(deleteBtnId);
    console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ø± Ø§Ù„Ø­Ø°Ù: ${deleteBtnId}`, deleteBtn ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

    if (deleteBtn) {
        if (selectedCount > 0) {
            deleteBtn.style.display = 'inline-block';
            deleteBtn.style.visibility = 'visible';
            deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (${selectedCount})`;
            console.log(`âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù: ${selectedCount} Ù…Ø±ÙÙ‚ Ù…Ø­Ø¯Ø¯`);
        } else {
            deleteBtn.style.display = 'none';
            console.log(`ğŸ”„ ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø­Ø°Ù`);
        }
    } else {
        console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù: ${deleteBtnId}`);
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡Ø©
        const allDeleteBtns = document.querySelectorAll('[id*="deleteSelectedBtn"]');
        console.log(`ğŸ” Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:`, Array.from(allDeleteBtns).map(btn => btn.id));
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
    const selectAllCheckbox = document.getElementById(`selectAllAttachments_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (selectAllCheckbox) {
        if (selectedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (selectedCount === totalCount) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    console.log(`ğŸ“Š ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯: ${selectedCount}/${totalCount} Ù…Ø±ÙÙ‚ Ù…Ø­Ø¯Ø¯`);
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØ±Ø¶ Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù (Ù„Ù„ØªØ´Ø®ÙŠØµ)
function forceShowDeleteButton(propertyKey) {
    const deleteBtnId = `deleteSelectedBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const deleteBtn = document.getElementById(deleteBtnId);

    if (deleteBtn) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.style.visibility = 'visible';
        deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (ØªØ¬Ø±ÙŠØ¨ÙŠ)`;
        console.log(`ğŸ”§ ØªÙ… ÙØ±Ø¶ Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±`);
    } else {
        console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù: ${deleteBtnId}`);
    }
}

// Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
async function deleteSelectedAttachments(propertyKey) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!checkAttachmentPermission('bulk_delete')) {
        return;
    }

    const selectedCheckboxes = document.querySelectorAll(`.attachment-select[data-property-key="${propertyKey}"]:checked`);

    if (selectedCheckboxes.length === 0) {
        alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø­Ø°Ù');
        return;
    }

    // ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selectedCheckboxes.length} Ù…Ø±ÙÙ‚ Ù…Ø­Ø¯Ø¯ØŸ\n\nØ³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯ÙˆÙ† Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙÙŠ.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø¨Ø¯Ø¡ Ø­Ø°Ù ${selectedCheckboxes.length} Ù…Ø±ÙÙ‚ Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø¹Ù‚Ø§Ø±: ${propertyKey}`);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    const progressBarHtml = `
        <div id="deleteProgressBar_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="delete-progress-bar" style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #dc3545;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 300px;
            font-family: 'Cairo', sans-serif;
        ">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <i class="fas fa-trash" style="color: #dc3545;"></i>
                <span style="font-weight: 600; color: #dc3545;">Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</span>
            </div>
            <div style="background: #f8f9fa; border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                <div id="deleteProgressFill_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" style="
                    background: linear-gradient(90deg, #dc3545, #c82333);
                    height: 100%;
                    width: 0%;
                    transition: width 0.3s ease;
                "></div>
            </div>
            <div id="deleteProgressText_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" style="
                font-size: 0.9rem;
                color: #6c757d;
                text-align: center;
            ">ØªÙ… Ø­Ø°Ù 0 Ù…Ù† ${selectedCheckboxes.length} Ù…Ø±ÙÙ‚</div>
        </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„ØµÙØ­Ø©
    document.body.insertAdjacentHTML('beforeend', progressBarHtml);

    // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­Ø°Ù
    const deleteBtn = document.getElementById(`deleteSelectedBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
    }

    let successCount = 0;
    let errorCount = 0;
    const totalCount = selectedCheckboxes.length;

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    function updateProgress() {
        const progressFill = document.getElementById(`deleteProgressFill_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        const progressText = document.getElementById(`deleteProgressText_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

        if (progressFill && progressText) {
            const completedCount = successCount + errorCount;
            const percentage = (completedCount / totalCount) * 100;

            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `ØªÙ… Ø­Ø°Ù ${successCount} Ù…Ù† ${totalCount} Ù…Ø±ÙÙ‚${errorCount > 0 ? ` (${errorCount} ÙØ´Ù„)` : ''}`;
        }
    }

    // Ø­Ø°Ù ÙƒÙ„ Ù…Ø±ÙÙ‚ Ù…Ø­Ø¯Ø¯ Ø¨Ø¯ÙˆÙ† Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙÙŠ
    for (let i = 0; i < selectedCheckboxes.length; i++) {
        const checkbox = selectedCheckboxes[i];
        const fileId = checkbox.getAttribute('data-file-id');
        const attachmentItem = checkbox.closest('.attachment-item, .mobile-attachment-item');

        try {
            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø¹Ù†ØµØ± Ù‚ÙŠØ¯ Ø§Ù„Ø­Ø°Ù
            if (attachmentItem) {
                attachmentItem.style.opacity = '0.3';
                attachmentItem.style.pointerEvents = 'none';
                attachmentItem.style.transform = 'scale(0.95)';
                attachmentItem.style.transition = 'all 0.3s ease';
            }

            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø°Ù (Ø³Ø­Ø§Ø¨ÙŠ Ø£Ù… Ù…Ø­Ù„ÙŠ)
            if (fileId.startsWith('local_')) {
                // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
                const fileIndex = parseInt(fileId.replace('local_', ''));
                const localAttachments = window.attachments?.[propertyKey] || [];

                if (localAttachments[fileIndex]) {
                    localAttachments.splice(fileIndex, 1);
                    window.attachments[propertyKey] = localAttachments;
                    localStorage.setItem('attachments', JSON.stringify(window.attachments));
                    successCount++;
                }
            } else {
                // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ø¯ÙˆÙ† ØªØ£ÙƒÙŠØ¯
                if (typeof deleteAttachmentEnhanced === 'function') {
                    // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¤Ù‚Øª Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙÙŠ deleteAttachmentEnhanced
                    const originalConfirm = window.confirm;
                    window.confirm = () => true; // ØªØ¬Ø§ÙˆØ² Ø§Ù„ØªØ£ÙƒÙŠØ¯

                    const success = await deleteAttachmentEnhanced(fileId);

                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£ØµÙ„ÙŠØ©
                    window.confirm = originalConfirm;

                    if (success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } else {
                    console.warn('âš ï¸ ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                    errorCount++;
                }
            }

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚ ${fileId}:`, error);
            errorCount++;

            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            if (attachmentItem) {
                attachmentItem.style.opacity = '1';
                attachmentItem.style.pointerEvents = 'auto';
                attachmentItem.style.transform = 'scale(1)';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        updateProgress();

        // ØªÙˆÙ‚Ù Ù‚ØµÙŠØ± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
        await new Promise(resolve => setTimeout(resolve, 100));
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
    setTimeout(() => {
        const progressBar = document.getElementById(`deleteProgressBar_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (progressBar) {
            progressBar.style.opacity = '0';
            progressBar.style.transform = 'translateX(100%)';
            progressBar.style.transition = 'all 0.5s ease';
            setTimeout(() => progressBar.remove(), 500);
        }
    }, 2000);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    await refreshPropertyAttachmentsList(propertyKey);

    // Ø¥Ø¸Ù‡Ø§Ø± Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    console.log(`âœ… ØªÙ… Ø­Ø°Ù ${successCount} Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­`);
    if (errorCount > 0) {
        console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù ${errorCount} Ù…Ø±ÙÙ‚`);
    }

    // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø®ØªØµØ±Ø©
    if (successCount > 0) {
        showToast(`ØªÙ… Ø­Ø°Ù ${successCount} Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­${errorCount > 0 ? ` (ÙØ´Ù„ ${errorCount})` : ''}`, 'success');
    }

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø­Ø°Ù
    if (deleteBtn) {
        deleteBtn.disabled = false;
        deleteBtn.style.display = 'none';
    }

    console.log(`ğŸ Ø§Ù†ØªÙ‡Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªØ¹Ø¯Ø¯: ${successCount} Ù†Ø¬Ø­ØŒ ${errorCount} ÙØ´Ù„`);
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ø¦Ù„ Toast
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001;
        font-family: 'Cairo', sans-serif;
        font-size: 0.9rem;
        max-width: 300px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;

    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;

    document.body.appendChild(toast);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙˆØ³Øª
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 100);

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙˆØ³Øª Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Enhanced file upload with comprehensive cross-device synchronization
async function handleFileUploadEnhanced(event, city, propertyName) {
    console.log(`ğŸš€ Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ø¹Ù‚Ø§Ø±: ${city}_${propertyName}`);

    const files = event.target.files;
    const propertyKey = `${city}_${propertyName}`;

    console.log(`ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: ${files.length}`);
    console.log(`ğŸ”‘ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyKey}`);

    // Get notes from the correct element based on the new design
    let notes = '';
    const notesElement = document.getElementById(`propertyUploadNotes_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`) ||
                        document.getElementById('uploadNotes');
    if (notesElement) {
        notes = notesElement.value || '';
        console.log(`ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}`);
    } else {
        console.log(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª`);
    }

    if (files.length === 0) {
        console.log(`âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ù„Ø±ÙØ¹`);
        return;
    }

    // Show enhanced upload progress modal
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.innerHTML = `
        <div class="modal-box upload-progress-modal" style="text-align: center; padding: 40px; max-width: 500px;">
            <div class="upload-header">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #17a2b8; margin-bottom: 1rem;"></i>
                <h3>Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</h3>
            </div>
            <div class="upload-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progressText">0 Ù…Ù† ${files.length} Ù…Ù„Ù</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                </div>
                <div class="upload-details">
                    <p id="uploadStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...</p>
                    <p id="currentFile" style="font-size: 0.9rem; color: #666;"></p>
                </div>
            </div>
            <div class="device-sync-info" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <i class="fas fa-sync-alt" style="color: #17a2b8;"></i>
                <small>Ø³ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©</small>
            </div>
        </div>
    `;
    document.body.appendChild(progressModal);

    try {
        // Check if Supabase is available and working
        const supabaseAvailable = await checkSupabaseAvailability();

        if (supabaseAvailable) {
            document.getElementById('uploadStatus').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...';

            // Upload files with progress tracking
            await handleFilesEnhanced(files, city, propertyName, notes);

            // Remove progress modal
            progressModal.remove();

            // Update the attachments list immediately
            try {
                await refreshPropertyAttachmentsList(propertyKey);
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹');
            } catch (updateError) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', updateError);
            }

            // Show success message with cross-device info
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box success-modal" style="text-align: center; padding: 40px;">
                    <div class="success-animation">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
                    </div>
                    <h3>ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­!</h3>
                    <div class="success-details">
                        <p>ØªÙ… Ø±ÙØ¹ ${files.length} Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
                        <div class="sync-status" style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
                            <i class="fas fa-globe" style="margin-left: 8px;"></i>
                            <strong>Ù…ØªØ²Ø§Ù…Ù† Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</strong>
                            <br>
                            <small>Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ù…ØªØµÙØ­Ø§Øª</small>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-primary" onclick="closeModal(); refreshPropertyAttachmentsList('${propertyKey}')">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                        </button>
                        <button class="btn-secondary" onclick="closeModal()">
                            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);

            // Auto-close success modal after 5 seconds
            setTimeout(() => {
                if (document.body.contains(successModal)) {
                    successModal.remove();
                }
            }, 5000);

        } else {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª:', error);

        // Update status
        document.getElementById('uploadStatus').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹...';

        // Fallback to local upload
        await handleFilesLocal(files, city, propertyName, notes);

        // Remove progress modal
        progressModal.remove();

        // Update the attachments list immediately
        try {
            await refreshPropertyAttachmentsList(propertyKey);
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ');
        } catch (updateError) {
            console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', updateError);
        }

        // Show fallback message with sync options
        const fallbackModal = document.createElement('div');
        fallbackModal.className = 'modal-overlay';
        fallbackModal.innerHTML = `
            <div class="modal-box fallback-modal" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                <h3>ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹</h3>
                <div class="fallback-details">
                    <p>Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©ØŒ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠØ§Ù‹</p>
                    <div class="local-storage-info" style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
                        <i class="fas fa-laptop" style="margin-left: 8px;"></i>
                        <strong>Ù…Ø­ÙÙˆØ¸ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·</strong>
                        <br>
                        <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø§ØªØµØ§Ù„</small>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="closeModal(); refreshPropertyAttachmentsList('${propertyKey}')">
                        <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                    </button>
                    <button class="btn-warning" onclick="closeModal(); retryUploadToSupabase('${city}', '${propertyName}')">
                        <i class="fas fa-sync"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(fallbackModal);
    }
}

// Check if Supabase is available and working
async function checkSupabaseAvailability() {
    try {
        if (!supabaseClient) {
            console.warn('âš ï¸ Supabase client ØºÙŠØ± Ù…ØªÙˆÙØ±');
            return false;
        }

        // Test connection with a simple query
        const { error } = await supabaseClient
            .from('attachments')
            .select('count', { count: 'exact', head: true });

        if (error) {
            console.warn('âš ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±:', error.message);
            return false;
        }

        console.log('âœ… Supabase Ù…ØªÙˆÙØ± ÙˆÙŠØ¹Ù…Ù„');
        return true;

    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Supabase:', error.message);
        return false;
    }
}

// Retry upload to Supabase
async function retryUploadToSupabase(city, propertyName) {
    try {
        const propertyKey = `${city}_${propertyName}`;

        // Show retry modal
        const retryModal = document.createElement('div');
        retryModal.className = 'modal-overlay';
        retryModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-sync fa-spin" style="font-size: 2rem; color: #17a2b8;"></i>
                <h3>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...</h3>
                <p>ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
            </div>
        `;
        document.body.appendChild(retryModal);

        // Check if Supabase is available
        const supabaseAvailable = await checkSupabaseAvailability();

        if (supabaseAvailable && typeof syncLocalAttachmentsToSupabase === 'function') {
            await syncLocalAttachmentsToSupabase();

            // Remove retry modal
            retryModal.remove();

            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box" style="text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                    <h3>ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!</h3>
                    <p>ØªÙ… Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
                    <button class="btn-primary" onclick="closeModal(); showAttachmentsModal('${city}', '${propertyName}')">
                        Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                    </button>
                </div>
            `;
            document.body.appendChild(successModal);

        } else {
            // Remove retry modal
            retryModal.remove();

            // Show error message
            const errorModal = document.createElement('div');
            errorModal.className = 'modal-overlay';
            errorModal.innerHTML = `
                <div class="modal-box" style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                    <h3>ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h3>
                    <p>Ù„Ø§ ÙŠØ²Ø§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±</p>
                    <button class="btn-secondary" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            `;
            document.body.appendChild(errorModal);
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:', error);

        // Show error message
        const errorModal = document.createElement('div');
        errorModal.className = 'modal-overlay';
        errorModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                <h3>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h3>
                <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</p>
                <button class="btn-secondary" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        `;
        document.body.appendChild(errorModal);
    }
}

// Enhanced file handling with detailed progress tracking and cross-device sync
async function handleFilesEnhanced(files, city, propertyName, notes = '') {
    const propertyKey = `${city}_${propertyName}`;
    let filesProcessed = 0;
    const totalFiles = files.length;
    let cloudUploads = 0;
    let localUploads = 0;

    for (const file of files) {
        try {
            // Update current file being processed
            const currentFileElement = document.getElementById('currentFile');
            if (currentFileElement) {
                currentFileElement.innerHTML = `<i class="fas fa-upload"></i> Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹: ${file.name}`;
            }

            // Always try Supabase upload first for cross-device sync
            let uploadSuccess = false;

            if (typeof uploadFileToSupabase === 'function' && supabaseClient) {
                try {
                    console.log(`â˜ï¸ Ø±ÙØ¹ ${file.name} Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...`);
                    const result = await uploadFileToSupabase(file, propertyKey, notes);

                    if (result) {
                        uploadSuccess = true;
                        cloudUploads++;
                        console.log(`âœ… ØªÙ… Ø±ÙØ¹ ${file.name} Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­`);

                        // Trigger real-time update event
                        window.dispatchEvent(new CustomEvent('attachmentAdded', {
                            detail: { propertyKey, attachment: result }
                        }));
                    }
                } catch (supabaseError) {
                    console.warn(`âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ ${file.name} Ù„Ù„Ø³Ø­Ø§Ø¨Ø©:`, supabaseError);
                    // Will fallback to local storage
                }
            }

            // Fallback to local storage if Supabase fails
            if (!uploadSuccess) {
                console.log(`ğŸ’¾ Ø­ÙØ¸ ${file.name} Ù…Ø­Ù„ÙŠØ§Ù‹ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©`);
                await handleFileLocal(file, propertyKey, notes);
                localUploads++;
            }

            filesProcessed++;

            // Update progress with enhanced UI
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercentage = document.getElementById('progressPercentage');

            if (progressFill && progressText) {
                const percentage = Math.round((filesProcessed / totalFiles) * 100);
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = `${filesProcessed} Ù…Ù† ${totalFiles} Ù…Ù„Ù`;

                if (progressPercentage) {
                    progressPercentage.textContent = `${percentage}%`;
                }
            }

            // Show completion for current file
            if (currentFileElement) {
                const icon = uploadSuccess ?
                    `<i class="fas fa-cloud-upload-alt" style="color: #28a745;"></i>` :
                    `<i class="fas fa-save" style="color: #ffc107;"></i>`;
                const location = uploadSuccess ? 'Ø§Ù„Ø³Ø­Ø§Ø¨Ø©' : 'Ù…Ø­Ù„ÙŠØ§Ù‹';
                currentFileElement.innerHTML = `${icon} ØªÙ… Ø­ÙØ¸ ${file.name} ${location}`;
            }

            // Small delay to show progress
            await new Promise(resolve => setTimeout(resolve, 300));

        } catch (error) {
            console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ ${file.name}:`, error);

            // Show error for current file
            const currentFileElement = document.getElementById('currentFile');
            if (currentFileElement) {
                currentFileElement.innerHTML = `<i class="fas fa-times" style="color: #dc3545;"></i> ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹: ${file.name}`;
            }

            throw error;
        }
    }

    // Final status update with sync info
    const uploadStatus = document.getElementById('uploadStatus');
    if (uploadStatus) {
        const syncInfo = cloudUploads > 0 ?
            `<i class="fas fa-sync-alt" style="color: #17a2b8;"></i> ${cloudUploads} Ù…Ù„Ù Ù…ØªØ²Ø§Ù…Ù† Ø¹Ø¨Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©` :
            `<i class="fas fa-laptop" style="color: #ffc107;"></i> ${localUploads} Ù…Ù„Ù Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹`;

        uploadStatus.innerHTML = `
            <i class="fas fa-check-circle" style="color: #28a745;"></i> ØªÙ… Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­!
            <br><small>${syncInfo}</small>
        `;
    }

    // Trigger real-time sync notification
    if (cloudUploads > 0) {
        console.log(`ğŸ”„ ØªÙ… Ø±ÙØ¹ ${cloudUploads} Ù…Ù„Ù Ù„Ù„Ø³Ø­Ø§Ø¨Ø© - Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©`);
        showConnectionNotification(`ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${cloudUploads} Ù…Ù„Ù Ø¹Ø¨Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©`, 'success');
    }
}

// Handle single file upload to local storage
async function handleFileLocal(file, propertyKey, notes = '') {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const attachment = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result,
                    date: new Date().toISOString(),
                    notes: notes
                };

                // Get existing attachments
                const existingAttachments = JSON.parse(localStorage.getItem('propertyAttachments') || '{}');

                // Initialize property attachments if not exists
                if (!existingAttachments[propertyKey]) {
                    existingAttachments[propertyKey] = [];
                }

                // Add new attachment
                existingAttachments[propertyKey].push(attachment);

                // Save to localStorage
                localStorage.setItem('propertyAttachments', JSON.stringify(existingAttachments));

                // Update global attachments variable
                if (typeof window.attachments !== 'undefined') {
                    window.attachments = existingAttachments;
                }

                resolve(attachment);

            } catch (error) {
                reject(error);
            }
        };

        reader.onerror = function() {
            reject(new Error('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        };

        reader.readAsDataURL(file);
    });
}

// Fallback local file handling
async function handleFilesLocal(files, city, propertyName, notes = '') {
    const propertyKey = `${city}_${propertyName}`;

    // Initialize global attachments if not exists
    if (!window.attachments) {
        window.attachments = {};
    }

    if (!window.attachments[propertyKey]) {
        window.attachments[propertyKey] = [];
    }

    let filesProcessed = 0;
    const totalFiles = files.length;

    for (const file of files) {
        const reader = new FileReader();

        await new Promise((resolve) => {
            reader.onload = function(e) {
                const attachment = {
                    name: file.name,
                    type: file.type,
                    data: e.target.result,
                    date: new Date().toISOString(),
                    uploadDate: new Date().toISOString(),
                    size: file.size,
                    notes: notes
                };

                window.attachments[propertyKey].push(attachment);
                filesProcessed++;
                resolve();
            };
            reader.readAsDataURL(file);
        });
    }

    // Save to localStorage with both keys for compatibility
    localStorage.setItem('propertyAttachments', JSON.stringify(window.attachments));
    localStorage.setItem('attachments', JSON.stringify(window.attachments));

    console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ ${filesProcessed} Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø¹Ù‚Ø§Ø± ${propertyKey}`);
}

// Legacy function for backward compatibility
function handleFileUpload(event, city, propertyName) {
    handleFileUploadEnhanced(event, city, propertyName);
}

function handleFiles(files, city, propertyName) {
    handleFilesLocal(files, city, propertyName);
}

// Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
function filterAttachmentsList(event) {
    const term = event.target.value.toLowerCase();
    document.querySelectorAll('.attachment-item').forEach(item => {
        item.style.display = item.dataset.name.includes(term) ? '' : 'none';
    });
}

// Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„Ù Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
function getFileIcon(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();

    // ØµÙˆØ±
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(extension)) {
        return '<i class="fas fa-image"></i>';
    }
    // PDF
    if (extension === 'pdf') {
        return '<i class="fas fa-file-pdf"></i>';
    }
    // Word
    if (['doc', 'docx'].includes(extension)) {
        return '<i class="fas fa-file-word"></i>';
    }
    // Excel
    if (['xls', 'xlsx', 'csv'].includes(extension)) {
        return '<i class="fas fa-file-excel"></i>';
    }
    // PowerPoint
    if (['ppt', 'pptx'].includes(extension)) {
        return '<i class="fas fa-file-powerpoint"></i>';
    }
    // ÙÙŠØ¯ÙŠÙˆ
    if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(extension)) {
        return '<i class="fas fa-file-video"></i>';
    }
    // ØµÙˆØª
    if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(extension)) {
        return '<i class="fas fa-file-audio"></i>';
    }
    // Ù†Øµ
    if (['txt', 'rtf'].includes(extension)) {
        return '<i class="fas fa-file-alt"></i>';
    }
    // Ø£Ø±Ø´ÙŠÙ
    if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) {
        return '<i class="fas fa-file-archive"></i>';
    }

    return '<i class="fas fa-file"></i>';
}

// Ù„ÙˆÙ† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„Ù Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
function getFileIconColor(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();

    // ØµÙˆØ± - Ø£Ø²Ø±Ù‚
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(extension)) {
        return '#007bff';
    }
    // PDF - Ø£Ø­Ù…Ø±
    if (extension === 'pdf') {
        return '#dc3545';
    }
    // Word - Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ†
    if (['doc', 'docx'].includes(extension)) {
        return '#2b579a';
    }
    // Excel - Ø£Ø®Ø¶Ø±
    if (['xls', 'xlsx', 'csv'].includes(extension)) {
        return '#217346';
    }
    // PowerPoint - Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
    if (['ppt', 'pptx'].includes(extension)) {
        return '#d24726';
    }
    // ÙÙŠØ¯ÙŠÙˆ - Ø¨Ù†ÙØ³Ø¬ÙŠ
    if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(extension)) {
        return '#6f42c1';
    }
    // ØµÙˆØª - ÙˆØ±Ø¯ÙŠ
    if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(extension)) {
        return '#e83e8c';
    }
    // Ù†Øµ - Ø±Ù…Ø§Ø¯ÙŠ
    if (['txt', 'rtf'].includes(extension)) {
        return '#6c757d';
    }
    // Ø£Ø±Ø´ÙŠÙ - Ø¨Ù†ÙŠ
    if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) {
        return '#795548';
    }

    // Ø§ÙØªØ±Ø§Ø¶ÙŠ - Ø±Ù…Ø§Ø¯ÙŠ
    return '#6c757d';
}

// ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Ø¨Ø§ÙŠØª';

    const k = 1024;
    const sizes = ['Ø¨Ø§ÙŠØª', 'ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª', 'Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª', 'Ø¬ÙŠØ¬Ø§Ø¨Ø§ÙŠØª'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚
function viewAttachment(propertyKey, fileName) {
    const att = (attachments[propertyKey] || []).find(a => a.name === fileName);
    if (!att) return;
    if (att.type.startsWith('image/')) {
        let html = `<div class="modal-overlay" style="display:flex;">
            <div class="modal-box" style="max-width:90vw;max-height:90vh;padding:10px;">
                <button class="close-modal" onclick="closeModal()">Ã—</button>
                <img src="${att.data}" style="max-width:100%;max-height:80vh;display:block;margin:0 auto;">
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } else if (att.type === 'application/pdf') {
        let html = `<div class="modal-overlay" style="display:flex;">
            <div class="modal-box" style="max-width:90vw;max-height:90vh;padding:10px;">
                <button class="close-modal" onclick="closeModal()">Ã—</button>
                <iframe src="${att.data}" style="width:100%;height:80vh;border:none;"></iframe>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } else {
        downloadAttachment(propertyKey, fileName);
    }
}

// ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚
function downloadAttachment(propertyKey, fileName) {
    const att = (attachments[propertyKey] || []).find(a => a.name === fileName);
    if (!att) return;
    const link = document.createElement('a');
    link.href = att.data;
    link.download = att.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚
function deleteAttachment(propertyKey, fileName, city, propertyName) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')) return;
    attachments[propertyKey] = (attachments[propertyKey] || []).filter(a => a.name !== fileName);
    localStorage.setItem('propertyAttachments', JSON.stringify(attachments));
    showAttachmentsModal(city, propertyName);
}

// ===== SUPABASE ATTACHMENT FUNCTIONS =====

// View attachment from Supabase
function viewAttachmentFromSupabase(attachmentId, fileUrl, fileType) {
    if (fileType.startsWith('image/')) {
        let html = `<div class="modal-overlay" style="display:flex;">
            <div class="modal-box mobile-friendly" style="max-width:90vw;max-height:90vh;padding:10px;">
                <button class="close-modal mobile-friendly" onclick="closeModal()">Ã—</button>
                <img src="${fileUrl}" style="max-width:100%;max-height:80vh;display:block;margin:0 auto;" alt="Ù…Ø±ÙÙ‚">
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } else if (fileType === 'application/pdf') {
        let html = `<div class="modal-overlay" style="display:flex;">
            <div class="modal-box mobile-friendly" style="max-width:90vw;max-height:90vh;padding:10px;">
                <button class="close-modal mobile-friendly" onclick="closeModal()">Ã—</button>
                <iframe src="${fileUrl}" style="width:100%;height:80vh;border:none;" title="Ù…Ø±ÙÙ‚ PDF"></iframe>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } else {
        // For other file types, download directly
        downloadAttachmentFromSupabase(fileUrl, 'attachment');
    }
}

// Download attachment from Supabase - Enhanced for all file types
async function downloadAttachmentFromSupabase(fileUrl, fileName) {
    try {
        console.log(`ğŸ“¥ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${fileName}`);

        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        showDownloadProgress(fileName, true);

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        const response = await fetch(fileUrl);

        if (!response.ok) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${response.status}`);
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¥Ù„Ù‰ blob
        const blob = await response.blob();

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = fileName;
        link.style.display = 'none';

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„ØµÙØ­Ø© ÙˆØªÙØ¹ÙŠÙ„Ù‡
        document.body.appendChild(link);
        link.click();

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);

        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showDownloadProgress(fileName, false);
        showMiniIconNotification('ğŸ“¥', '#28a745', 2000);

        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­: ${fileName}`);

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ${fileName}:`, error);

        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        showDownloadProgress(fileName, false);
        showMiniIconNotification('âŒ', '#dc3545', 3000);

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙƒØ¨Ø¯ÙŠÙ„
        const link = document.createElement('a');
        link.href = fileUrl;
        link.download = fileName;
        link.target = '_blank';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Delete attachment from Supabase
async function deleteAttachmentFromSupabase(attachmentId, propertyKey) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.')) return;

    // Show loading
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #dc3545;"></i>
            <p style="margin-top: 20px;">Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚...</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        if (typeof deleteAttachmentEnhanced === 'function') {
            await deleteAttachmentEnhanced(attachmentId);

            // Remove loading modal
            loadingModal.remove();

            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box" style="text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                    <h3>ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­</h3>
                    <button class="btn-primary" onclick="closeModal(); refreshAttachmentsList('${propertyKey}')">
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    </button>
                </div>
            `;
            document.body.appendChild(successModal);

        } else {
            throw new Error('Delete function not available');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚:', error);

        // Remove loading modal
        loadingModal.remove();

        // Show error message
        const errorModal = document.createElement('div');
        errorModal.className = 'modal-overlay';
        errorModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                <h3>Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚</h3>
                <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
                <button class="btn-secondary" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        `;
        document.body.appendChild(errorModal);
    }
}

// Manual sync attachments
async function syncAttachmentsManually(propertyKey) {
    const syncModal = document.createElement('div');
    syncModal.className = 'modal-overlay';
    syncModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-sync fa-spin" style="font-size: 2rem; color: #17a2b8;"></i>
            <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</h3>
            <p>ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
        </div>
    `;
    document.body.appendChild(syncModal);

    try {
        if (typeof syncLocalAttachmentsToSupabase === 'function') {
            await syncLocalAttachmentsToSupabase();

            // Remove sync modal
            syncModal.remove();

            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box" style="text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                    <h3>ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­</h3>
                    <p>ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
                    <button class="btn-primary" onclick="closeModal(); refreshAttachmentsList('${propertyKey}')">
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    </button>
                </div>
            `;
            document.body.appendChild(successModal);

        } else {
            throw new Error('Sync function not available');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);

        // Remove sync modal
        syncModal.remove();

        // Show error message
        const errorModal = document.createElement('div');
        errorModal.className = 'modal-overlay';
        errorModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                <h3>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h3>
                <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</p>
                <button class="btn-secondary" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        `;
        document.body.appendChild(errorModal);
    }
}

// Enhanced drag and drop setup with cross-device support
function setupDragAndDropEnhanced(propertyKey) {
    const uploadZone = document.querySelector('.upload-zone');
    if (!uploadZone) return;

    // Enhanced mobile-friendly drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.backgroundColor = '#f8f9fa';
        uploadZone.style.transform = 'scale(1.02)';
    });

    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.backgroundColor = '';
        uploadZone.style.transform = 'scale(1)';
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.backgroundColor = '';
        uploadZone.style.transform = 'scale(1)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // Extract city and property name from the current modal
            const modal = uploadZone.closest('.attachments-modal');
            if (modal) {
                const propertyKeyFromModal = modal.getAttribute('data-property-key');
                if (propertyKeyFromModal) {
                    const [city, propertyName] = propertyKeyFromModal.split('_');
                    handleFileUploadEnhanced({ target: { files } }, city, propertyName);
                }
            }
        }
    });

    // Touch support for mobile devices
    uploadZone.addEventListener('touchstart', () => {
        uploadZone.style.backgroundColor = '#f8f9fa';
    });

    uploadZone.addEventListener('touchend', () => {
        uploadZone.style.backgroundColor = '';
    });
}

// Setup real-time updates for modal
function setupModalRealTimeUpdates(propertyKey) {
    // Listen for custom attachment events
    window.addEventListener('attachmentAdded', (event) => {
        if (event.detail.propertyKey === propertyKey) {
            console.log('ğŸ”„ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±');
            refreshAttachmentsList(propertyKey);
        }
    });

    window.addEventListener('attachmentDeleted', (event) => {
        if (event.detail.propertyKey === propertyKey) {
            console.log('ğŸ—‘ï¸ Ù…Ù„Ù ØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±');
            refreshAttachmentsList(propertyKey);
        }
    });
}

// Update sync status indicator
function updateSyncStatus() {
    const syncStatus = document.getElementById('syncStatus');
    if (!syncStatus) return;

    if (typeof checkSupabaseAvailability === 'function') {
        checkSupabaseAvailability().then(isAvailable => {
            if (isAvailable) {
                syncStatus.innerHTML = '<i class="fas fa-sync-alt" style="color: #28a745;"></i> Ù…ØªØ²Ø§Ù…Ù†';
                syncStatus.style.color = '#28a745';
            } else {
                syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·';
                syncStatus.style.color = '#ffc107';
            }
        });
    } else {
        syncStatus.innerHTML = '<i class="fas fa-laptop" style="color: #6c757d;"></i> Ù…Ø­Ù„ÙŠ';
        syncStatus.style.color = '#6c757d';
    }
}

// Refresh attachments list in modal
async function refreshAttachmentsList(propertyKey) {
    try {
        const modal = document.querySelector(`.attachments-modal[data-property-key="${propertyKey}"]`);
        if (!modal) return;

        const listContainer = modal.querySelector('.attachments-list');
        if (!listContainer) return;

        // Show loading state
        listContainer.style.opacity = '0.7';
        listContainer.innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #17a2b8;"></i>
                <p style="margin-top: 15px; color: #6c757d;">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...</p>
            </div>
        `;

        // Get updated attachments - prioritize Supabase
        let attachments = [];
        let isFromCloud = false;

        // Try Supabase first
        if (typeof getPropertyAttachmentsEnhanced === 'function' && supabaseClient) {
            try {
                attachments = await getPropertyAttachmentsEnhanced(propertyKey);
                isFromCloud = true;
                console.log(`â˜ï¸ ØªÙ… Ø¬Ù„Ø¨ ${attachments.length} Ù…Ø±ÙÙ‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
            } catch (error) {
                console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:', error);
            }
        }

        // Fallback to local storage
        if (!isFromCloud || attachments.length === 0) {
            attachments = window.attachments?.[propertyKey] || [];
            console.log(`ğŸ’¾ ØªÙ… Ø¬Ù„Ø¨ ${attachments.length} Ù…Ø±ÙÙ‚ Ù…Ø­Ù„ÙŠ`);
        }

        // Update the list with sync status indicator
        if (attachments.length === 0) {
            listContainer.innerHTML = `
                <div class="no-attachments-state" style="text-align:center;color:#888;padding:40px 20px;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                    <h4 style="margin: 10px 0; color: #6c757d;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯</h4>
                    <p style="color: #aaa; margin: 0;">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø±ÙØ¹ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª</p>
                    ${isFromCloud ?
                        '<p style="color: #17a2b8; margin-top: 10px;"><i class="fas fa-sync-alt"></i> Ù…ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>' :
                        '<p style="color: #ffc107; margin-top: 10px;"><i class="fas fa-laptop"></i> Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·</p>'
                    }
                </div>
            `;
        } else {
            listContainer.innerHTML = attachments.map(att => {
                const fileName = att.file_name || att.name;
                const fileType = att.file_type || att.type;
                const fileSize = att.file_size || att.size;
                const uploadDate = att.created_at || att.date;
                const notes = att.notes || '';
                const isCloudFile = !!att.id; // Has Supabase ID

                return `
                    <div class="attachment-item enhanced" data-name="${fileName.toLowerCase()}" ${att.id ? `data-id="${att.id}"` : ''}>
                        <div class="attachment-icon">
                            ${getFileIcon(fileName)}
                            ${isCloudFile ?
                                '<i class="fas fa-cloud" style="position: absolute; top: -5px; right: -5px; font-size: 0.8rem; color: #17a2b8;" title="Ù…ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©"></i>' :
                                '<i class="fas fa-laptop" style="position: absolute; top: -5px; right: -5px; font-size: 0.8rem; color: #ffc107;" title="Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·"></i>'
                            }
                        </div>
                        <div class="attachment-details">
                            <div class="attachment-name" title="${fileName}">${fileName}</div>
                            <div class="attachment-meta">
                                <span class="file-size">${formatFileSize(fileSize)}</span>
                                <span class="upload-date">${formatDate(uploadDate)}</span>
                                ${notes ? `<span class="file-notes" title="${notes}"><i class="fas fa-sticky-note"></i></span>` : ''}
                                ${isCloudFile ?
                                    '<span class="sync-status" style="color: #17a2b8;" title="Ù…ØªØ²Ø§Ù…Ù† Ø¹Ø¨Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©"><i class="fas fa-sync-alt"></i></span>' :
                                    '<span class="sync-status" style="color: #ffc107;" title="Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·"><i class="fas fa-laptop"></i></span>'
                                }
                            </div>
                        </div>
                        <div class="attachment-actions">
                            ${isCloudFile ?
                                // Supabase attachment
                                `<button class="attachment-btn view-btn" onclick="viewAttachmentFromSupabase('${att.id}', '${att.file_url}', '${fileType}')" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="attachment-btn download-btn" onclick="downloadAttachmentFromSupabase('${att.file_url}', '${fileName}')" title="ØªØ­Ù…ÙŠÙ„">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="attachment-btn delete-btn" onclick="deleteAttachmentFromSupabase('${att.id}', '${propertyKey}')" title="Ø­Ø°Ù Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©">
                                    <i class="fas fa-trash"></i>
                                </button>` :
                                // Local attachment
                                `<button class="attachment-btn view-btn" onclick="viewAttachment('${propertyKey}', '${fileName}')" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="attachment-btn download-btn" onclick="downloadAttachment('${propertyKey}', '${fileName}')" title="ØªØ­Ù…ÙŠÙ„">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="attachment-btn delete-btn" onclick="deleteAttachment('${propertyKey}', '${fileName}')" title="Ø­Ø°Ù Ù…Ø­Ù„ÙŠ">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="attachment-btn sync-btn" onclick="syncLocalAttachment('${propertyKey}', '${fileName}')" title="Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update attachment count
        const countElement = modal.querySelector('.attachment-count');
        if (countElement) {
            countElement.textContent = `(${attachments.length} Ù…Ù„Ù)`;
        }

        // Update footer summary with sync status
        const summaryElement = modal.querySelector('.attachments-summary');
        if (summaryElement) {
            const cloudFiles = attachments.filter(att => att.id).length;
            const localFiles = attachments.length - cloudFiles;

            let summaryText = `<i class="fas fa-info-circle"></i> ${attachments.length} Ù…Ù„Ù`;

            if (isFromCloud && cloudFiles > 0) {
                summaryText += ` â€¢ <i class="fas fa-sync-alt" style="color: #17a2b8;"></i> ${cloudFiles} Ù…ØªØ²Ø§Ù…Ù† Ø¹Ø¨Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©`;
                if (localFiles > 0) {
                    summaryText += ` â€¢ <i class="fas fa-laptop" style="color: #ffc107;"></i> ${localFiles} Ù…Ø­Ù„ÙŠ`;
                }
            } else if (localFiles > 0) {
                summaryText += ` â€¢ <i class="fas fa-laptop" style="color: #ffc107;"></i> Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·`;
            }

            summaryElement.innerHTML = summaryText;
        }

        // Restore opacity
        listContainer.style.opacity = '1';

        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ${attachments.length} Ù…Ù„Ù`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', error);

        const listContainer = document.querySelector('.attachments-list');
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="error-state" style="text-align: center; padding: 30px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545; margin-bottom: 15px;"></i>
                    <p style="color: #dc3545;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</p>
                    <button onclick="refreshAttachmentsList('${propertyKey}')" class="btn-secondary">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                </div>
            `;
            listContainer.style.opacity = '1';
        }
    }
}

// Sync local attachment to cloud
async function syncLocalAttachment(propertyKey, fileName) {
    try {
        console.log(`ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù„Ù Ù…Ø­Ù„ÙŠ: ${fileName}`);

        // Get local attachment
        const localAttachments = window.attachments?.[propertyKey] || [];
        const attachment = localAttachments.find(att => att.name === fileName);

        if (!attachment) {
            throw new Error('Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        }

        // Convert base64 to file
        const response = await fetch(attachment.data);
        const blob = await response.blob();
        const file = new File([blob], attachment.name, { type: attachment.type });

        // Upload to Supabase
        if (typeof uploadFileToSupabase === 'function') {
            const result = await uploadFileToSupabase(file, propertyKey, attachment.notes || '');

            if (result) {
                console.log(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${fileName} Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
                showConnectionNotification(`ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${fileName} Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`, 'success');

                // Remove from local storage
                const updatedLocal = localAttachments.filter(att => att.name !== fileName);
                window.attachments[propertyKey] = updatedLocal;
                localStorage.setItem('propertyAttachments', JSON.stringify(window.attachments));

                // Refresh the list
                refreshAttachmentsList(propertyKey);

                return true;
            }
        }

        throw new Error('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø³Ø­Ø§Ø¨Ø©');

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${fileName}:`, error);
        showConnectionNotification(`ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${fileName}`, 'error');
        return false;
    }
}

// Setup real-time sync for attachments
function setupAttachmentRealTimeSync() {
    if (typeof subscribeToAttachmentChanges === 'function') {
        try {
            const subscription = subscribeToAttachmentChanges();

            if (subscription) {
                console.log('ğŸ”” ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª');

                // Listen for attachment changes
                window.addEventListener('attachmentAdded', (event) => {
                    const { propertyKey } = event.detail;
                    console.log(`ğŸ“ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡: ${propertyKey}`);

                    // Refresh any open attachment modals for this property
                    const modal = document.querySelector(`.attachments-modal[data-property-key="${propertyKey}"]`);
                    if (modal) {
                        refreshAttachmentsList(propertyKey);
                    }

                    showConnectionNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±', 'info');
                });

                window.addEventListener('attachmentDeleted', (event) => {
                    const { propertyKey } = event.detail;
                    console.log(`ğŸ—‘ï¸ Ù…Ù„Ù ØªÙ… Ø­Ø°ÙÙ‡: ${propertyKey}`);

                    // Refresh any open attachment modals for this property
                    const modal = document.querySelector(`.attachments-modal[data-property-key="${propertyKey}"]`);
                    if (modal) {
                        refreshAttachmentsList(propertyKey);
                    }

                    showConnectionNotification('ØªÙ… Ø­Ø°Ù Ù…Ù„Ù Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±', 'info');
                });

                return subscription;
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©:', error);
        }
    }

    return null;
}

// Show local attachments modal (fallback)
function showAttachmentsModalLocal(city, propertyName) {
    const propertyKey = `${city}_${propertyName}`;
    const propertyAttachments = attachments[propertyKey] || [];

    // Use the original function logic but with local data only
    showAttachmentsModal(city, propertyName);
}

// ===== ATTACHMENTS SYSTEM INITIALIZATION =====

// Initialize the enhanced cross-device attachments system
let isSystemInitialized = false;
let initializationPromise = null;

async function initializeAttachmentsSystem() {
    // Prevent multiple initializations
    if (isSystemInitialized) {
        console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù‡ÙŠØ£ Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
    }

    if (initializationPromise) {
        return initializationPromise;
    }

    initializationPromise = performInitialization();
    return initializationPromise;
}

async function performInitialization() {
    try {
        if (window.debugMode) {
            console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†...');
        }

        // Check if Supabase is available
        if (!supabaseClient) {
            console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·');
            if (window.debugMode) {
                showConnectionNotification('Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·', 'warning');
            }
            isSystemInitialized = true;
            return;
        }

        // Test Supabase connection first
        const isSupabaseAvailable = await checkSupabaseAvailability();
        if (!isSupabaseAvailable) {
            console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase');
            if (window.debugMode) {
                showConnectionNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'warning');
            }
            isSystemInitialized = true;
            return;
        }

        // Ensure Supabase attachments table exists
        if (typeof ensureAttachmentsTableExists === 'function') {
            await ensureAttachmentsTableExists();
            if (window.debugMode) {
                console.log('âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¬Ø§Ù‡Ø²');
            }
        }

        // Ensure storage bucket exists
        if (typeof ensureStorageBucketExists === 'function') {
            await ensureStorageBucketExists();
            if (window.debugMode) {
                console.log('âœ… Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ø§Ù‡Ø²');
            }
        }

        // Subscribe to real-time attachment changes
        if (typeof subscribeToAttachmentChanges === 'function') {
            const subscription = subscribeToAttachmentChanges();
            if (subscription) {
                console.log('ğŸ”” ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©');
                showConnectionNotification('Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù†Ø´Ø·Ø©', 'success');
            }
        }

        // Setup attachment real-time sync
        setupAttachmentRealTimeSync();

        // Test attachment functions (only in debug mode)
        if (window.debugMode) {
            await testAttachmentFunctions();
        }

        // Initialize connection indicator
        updateConnectionIndicator(true);

        // Sync local attachments to Supabase (background process)
        setTimeout(async () => {
            if (typeof syncLocalAttachmentsToSupabase === 'function') {
                try {
                    if (window.debugMode) {
                        console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
                    }
                    await syncLocalAttachmentsToSupabase();
                    if (window.debugMode) {
                        console.log('âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                        showConnectionNotification('ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'success');
                    }
                } catch (error) {
                    if (window.debugMode) {
                        console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', error.message);
                    }
                }
            }
        }, 5000); // Wait 5 seconds after app load

        // Setup periodic connection check (less frequent)
        setInterval(async () => {
            const isConnected = await checkSupabaseAvailability();
            updateConnectionIndicator(isConnected);
        }, 60000); // Check every 60 seconds instead of 30

        console.log('ğŸ‰ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        isSystemInitialized = true;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', error);
        if (window.debugMode) {
            showConnectionNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', 'error');
        }
        updateConnectionIndicator(false);
        isSystemInitialized = true;
    }
}

// Test attachment functions availability
async function testAttachmentFunctions() {
    try {
        console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');

        const functions = [
            'ensureAttachmentsTableExists',
            'uploadFileToSupabase',
            'getPropertyAttachmentsEnhanced',
            'deleteAttachmentEnhanced',
            'syncLocalAttachmentsToSupabase',
            'subscribeToAttachmentChanges'
        ];

        const availableFunctions = [];
        const missingFunctions = [];

        functions.forEach(funcName => {
            if (typeof window[funcName] === 'function') {
                availableFunctions.push(funcName);
            } else {
                missingFunctions.push(funcName);
            }
        });

        console.log('âœ… ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙˆÙØ±Ø©:', availableFunctions);
        if (missingFunctions.length > 0) {
            console.warn('âš ï¸ ÙˆØ¸Ø§Ø¦Ù Ù…ÙÙ‚ÙˆØ¯Ø©:', missingFunctions);
        }

        // Test Supabase connection for attachments
        if (supabaseClient) {
            try {
                const { data, error } = await supabaseClient
                    .from('attachments')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    console.warn('âš ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­:', error.message);
                } else {
                    console.log('âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…ØªØ§Ø­');
                }
            } catch (error) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', error.message);
            }
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', error);
    }
}

// Format date for display
function formatDate(dateString) {
    if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-SA', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (error) {
        return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­';
    }
}

// Enhanced file icon function (legacy - replaced by new getFileIcon above)

// Enhanced file size formatting
function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 Ø¨Ø§ÙŠØª';

    const k = 1024;
    const sizes = ['Ø¨Ø§ÙŠØª', 'ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª', 'Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª', 'Ø¬ÙŠØ¬Ø§Ø¨Ø§ÙŠØª', 'ØªÙŠØ±Ø§Ø¨Ø§ÙŠØª'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    if (i >= sizes.length) return 'Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹';

    const size = parseFloat((bytes / Math.pow(k, i)).toFixed(2));
    return `${size} ${sizes[i]}`;
}

// Check if device is mobile
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
           window.innerWidth <= 768;
}

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
const notificationSettings = {
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
    enabled: true,
    developerMode: false,

    // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
    allowedTypes: {
        error: true,        // Ø£Ø®Ø·Ø§Ø¡ Ù…Ù‡Ù…Ø©
        success: true,      // Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
        warning: true,      // ØªØ­Ø°ÙŠØ±Ø§Øª Ù…Ù‡Ù…Ø©
        info: false,        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
        debug: false        // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ·ÙˆÙŠØ± (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
    },

    // Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    importantOperations: [
        'Ø­ÙØ¸', 'ØªØ­Ø¯ÙŠØ«', 'Ø­Ø°Ù', 'Ù…Ø²Ø§Ù…Ù†Ø©', 'Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'ØªØµØ¯ÙŠØ±',
        'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª'
    ]
};

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† localStorage
function loadNotificationSettings() {
    const saved = localStorage.getItem('notificationSettings');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            Object.assign(notificationSettings, parsed);
        } catch (error) {
            console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
        }
    }
}

// Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ localStorage
function saveNotificationSettings() {
    localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
}

// ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ù‡Ù…
function isImportantNotification(message, type) {
    // Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ù‡Ù…Ø©
    if (type === 'error') return true;

    // ÙØ­Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
    const isImportantOperation = notificationSettings.importantOperations.some(op =>
        message.includes(op)
    );

    return isImportantOperation;
}

// Show toast notification Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ØµØºØ±Ø©
function showToast(message, type = 'info', duration = 3000) {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    loadNotificationSettings();

    // ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø©
    if (!notificationSettings.enabled) {
        console.log(`[TOAST DISABLED] ${type.toUpperCase()}: ${message}`);
        return;
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØµØºÙŠØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„Ø©
    const iconNotification = convertToIconNotification(message, type);
    if (iconNotification) {
        showMiniIconNotification(iconNotification.icon, iconNotification.color, duration);
        return;
    }

    // ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    if (!notificationSettings.allowedTypes[type]) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù‡Ù…ÙŠØªÙ‡
        if (!isImportantNotification(message, type)) {
            console.log(`[TOAST FILTERED] ${type.toUpperCase()}: ${message}`);
            return;
        }
    }

    // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±ØŒ Ø§Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    if (notificationSettings.developerMode) {
        console.log(`[DEVELOPER MODE] ${type.toUpperCase()}: ${message}`);
    }

    const toast = document.createElement('div');
    toast.className = `message-toast ${type}`;
    toast.textContent = message;

    document.body.appendChild(toast);

    // Auto remove after duration
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, duration);

    return toast;
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØµØºÙŠØ±Ø©
function convertToIconNotification(message, type) {
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
    const statusMessages = {
        'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­': { icon: 'âœ“', color: '#28a745' },
        'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­': { icon: 'âœ“', color: '#28a745' },
        'Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ': { icon: 'âœ“', color: '#28a745' },
        'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­': { icon: 'â—', color: '#28a745' },
        'Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù†Ø´Ø·Ø©': { icon: 'â—', color: '#17a2b8' },
        'ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø©': { icon: 'â†»', color: '#17a2b8' },
        'ØªÙ… Ø­ÙØ¸': { icon: 'ğŸ’¾', color: '#28a745' },
        'ØªÙ… Ø±Ø¨Ø·': { icon: 'ğŸ”—', color: '#28a745' },
        'ØªÙ… ÙØµÙ„': { icon: 'ğŸ”“', color: '#ffc107' },
        'ØªÙ… Ø­Ø°Ù': { icon: 'ğŸ—‘', color: '#dc3545' },
        'ØªÙ… Ø¥Ø¶Ø§ÙØ©': { icon: '+', color: '#28a745' },
        'ØªÙ… ØªØ­Ø¯ÙŠØ«': { icon: 'â†»', color: '#17a2b8' },
        'ÙØ´Ù„ ÙÙŠ': { icon: 'âœ—', color: '#dc3545' },
        'Ø®Ø·Ø£ ÙÙŠ': { icon: '!', color: '#dc3545' },
        'ØªØ­Ø°ÙŠØ±': { icon: 'âš ', color: '#ffc107' },
        'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„': { icon: 'â—', color: '#dc3545' },
        'ØºÙŠØ± Ù…ØªÙˆÙØ±': { icon: 'â—‹', color: '#6c757d' }
    };

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    for (const [keyword, iconData] of Object.entries(statusMessages)) {
        if (message.includes(keyword)) {
            return iconData;
        }
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± success Ø£Ùˆ error Ø£Ùˆ warningØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    if (type === 'success') return { icon: 'âœ“', color: '#28a745' };
    if (type === 'error') return { icon: 'âœ—', color: '#dc3545' };
    if (type === 'warning') return { icon: 'âš ', color: '#ffc107' };
    if (type === 'info') return { icon: 'â„¹', color: '#17a2b8' };

    return null; // Ù„Ø§ ØªØ­ÙˆÙŠÙ„ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
}

// Ø¹Ø±Ø¶ Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (4px)
function showMiniIconNotification(icon, color, duration = 3000) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingIcons = document.querySelectorAll('.mini-icon-notification');
    existingIcons.forEach(icon => icon.remove());

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµØºÙŠØ±Ø©
    const iconElement = document.createElement('div');
    iconElement.className = 'mini-icon-notification';
    iconElement.textContent = icon;

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ù…Ø§Ø·
    iconElement.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        width: 4px;
        height: 4px;
        background: ${color};
        border-radius: 50%;
        z-index: 10000;
        font-size: 3px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        animation: miniIconPulse 0.5s ease-out;
        transition: all 0.3s ease;
    `;

    // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØµÙØ­Ø©
    document.body.appendChild(iconElement);

    // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    setTimeout(() => {
        if (iconElement.parentNode) {
            iconElement.style.opacity = '0';
            iconElement.style.transform = 'scale(0)';
            setTimeout(() => iconElement.remove(), 300);
        }
    }, duration);

    console.log(`ğŸ”¸ Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµØºÙŠØ±Ø©: ${icon} (${color})`);
    return iconElement;
}

// ===== DATA IMPORT SYSTEM =====

// Global variables for import system
let importedData = null;
let importPreview = null;
let importStats = {
    totalRecords: 0,
    newProperties: 0,
    newUnits: 0,
    updatedUnits: 0,
    errors: 0,
    warnings: 0
};

// Show data import modal
function showDataImportModal() {
    console.log('ğŸ”„ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="data-import-modal">
            <div class="import-modal-header">
                <h2><i class="fas fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                <p>Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ</p>
            </div>

            <div class="import-modal-content">
                <!-- Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù -->
                <div class="import-step" id="step1">
                    <div class="step-header">
                        <span class="step-number">1</span>
                        <h3>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    </div>

                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <p>Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                            <small>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: JSON, CSV, Excel (.xlsx)</small>
                        </div>
                        <input type="file" id="importFileInput" accept=".json,.csv,.xlsx" style="display: none;">
                    </div>

                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="file-details">
                            <i class="fas fa-file"></i>
                            <span id="fileName"></span>
                            <span id="fileSize"></span>
                        </div>
                        <button class="change-file-btn" onclick="changeImportFile()">
                            <i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„Ù
                        </button>
                    </div>
                </div>

                <!-- Ø®Ø·ÙˆØ© 2: Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                <div class="import-step" id="step2" style="display: none;">
                    <div class="step-header">
                        <span class="step-number">2</span>
                        <h3>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    </div>

                    <div class="preview-stats" id="previewStats"></div>
                    <div class="preview-table-container">
                        <table class="preview-table" id="previewTable"></table>
                    </div>

                    <div class="import-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="createBackup" checked>
                            <span class="checkmark"></span>
                            Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="updateExisting" checked>
                            <span class="checkmark"></span>
                            ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="addNewUnits" checked>
                            <span class="checkmark"></span>
                            Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
                        </label>
                    </div>
                </div>

                <!-- Ø®Ø·ÙˆØ© 3: ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
                <div class="import-step" id="step3" style="display: none;">
                    <div class="step-header">
                        <span class="step-number">3</span>
                        <h3>ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</h3>
                    </div>

                    <div class="import-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</div>
                    </div>

                    <div class="import-log" id="importLog"></div>
                </div>

                <!-- Ø®Ø·ÙˆØ© 4: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
                <div class="import-step" id="step4" style="display: none;">
                    <div class="step-header">
                        <span class="step-number">4</span>
                        <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</h3>
                    </div>

                    <div class="import-results" id="importResults"></div>
                </div>
            </div>

            <div class="import-modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeImportModal()">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
                <button class="modal-action-btn next-btn" id="nextBtn" onclick="nextImportStep()" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
                <button class="modal-action-btn import-btn" id="importBtn" onclick="executeImport()" style="display: none;">
                    <i class="fas fa-download"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                </button>
                <button class="modal-action-btn finish-btn" id="finishBtn" onclick="finishImport()" style="display: none;">
                    <i class="fas fa-check"></i> Ø¥Ù†Ù‡Ø§Ø¡
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setupFileUpload();
}

// Setup file upload functionality
function setupFileUpload() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('importFileInput');

    // Click to upload
    fileUploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });
}

// Handle file selection
async function handleFileSelection(file) {
    console.log('ğŸ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù:', file.name);

    // Validate file type
    const allowedTypes = ['.json', '.csv', '.xlsx'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

    if (!allowedTypes.includes(fileExtension)) {
        showImportError('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: JSON, CSV, Excel (.xlsx)');
        return;
    }

    // Show file info
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileUploadArea').style.display = 'none';
    document.getElementById('fileInfo').style.display = 'flex';
    document.getElementById('nextBtn').style.display = 'inline-flex';

    // Parse file
    try {
        importedData = await parseImportFile(file);
        console.log('âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­:', importedData.length, 'Ø³Ø¬Ù„');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù:', error);
        showImportError('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
    }
}

// Parse import file based on type
async function parseImportFile(file) {
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

    switch (fileExtension) {
        case '.json':
            return await parseJSONFile(file);
        case '.csv':
            return await parseCSVFile(file);
        case '.xlsx':
            return await parseExcelFile(file);
        default:
            throw new Error('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
    }
}

// Parse JSON file
async function parseJSONFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                    resolve(data);
                } else {
                    reject(new Error('Ù…Ù„Ù JSON ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'));
                }
            } catch (error) {
                reject(new Error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù JSON: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        reader.readAsText(file);
    });
}

// Parse CSV file
async function parseCSVFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    reject(new Error('Ù…Ù„Ù CSV ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø£Ø³ ÙˆØ¨ÙŠØ§Ù†Ø§Øª'));
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};

                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });

                    data.push(row);
                }

                resolve(data);
            } catch (error) {
                reject(new Error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù CSV: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        reader.readAsText(file);
    });
}

// Parse Excel file (requires SheetJS library)
async function parseExcelFile(file) {
    // Note: This requires the SheetJS library to be loaded
    if (typeof XLSX === 'undefined') {
        throw new Error('Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ SheetJS library');
    }

    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                resolve(jsonData);
            } catch (error) {
                reject(new Error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Excel: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        reader.readAsArrayBuffer(file);
    });
}

// Next step in import process
function nextImportStep() {
    const currentStep = document.querySelector('.import-step:not([style*="display: none"])');
    const stepNumber = parseInt(currentStep.id.replace('step', ''));

    if (stepNumber === 1) {
        // Move to preview step
        showImportStep(2);
        generateImportPreview();
    }
}

// Show specific import step
function showImportStep(stepNumber) {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (step) step.style.display = 'none';
    }

    // Show target step
    const targetStep = document.getElementById(`step${stepNumber}`);
    if (targetStep) targetStep.style.display = 'block';

    // Update buttons
    updateImportButtons(stepNumber);
}

// Update import modal buttons
function updateImportButtons(stepNumber) {
    const nextBtn = document.getElementById('nextBtn');
    const importBtn = document.getElementById('importBtn');
    const finishBtn = document.getElementById('finishBtn');

    // Hide all buttons first
    nextBtn.style.display = 'none';
    importBtn.style.display = 'none';
    finishBtn.style.display = 'none';

    switch (stepNumber) {
        case 1:
            if (importedData) nextBtn.style.display = 'inline-flex';
            break;
        case 2:
            importBtn.style.display = 'inline-flex';
            break;
        case 3:
            // No buttons during import
            break;
        case 4:
            finishBtn.style.display = 'inline-flex';
            break;
    }
}

// Generate import preview
function generateImportPreview() {
    console.log('ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

    if (!importedData || importedData.length === 0) {
        showImportError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
        return;
    }

    // Analyze data and generate preview
    analyzeImportData();
    displayPreviewStats();
    displayPreviewTable();
}

// Analyze import data
function analyzeImportData() {
    console.log('ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©...');

    importStats = {
        totalRecords: importedData.length,
        newProperties: 0,
        newUnits: 0,
        updatedUnits: 0,
        errors: 0,
        warnings: 0
    };

    importPreview = [];

    importedData.forEach((record, index) => {
        try {
            const analysis = analyzeRecord(record, index);
            importPreview.push(analysis);

            // Update stats
            if (analysis.action === 'new_property') importStats.newProperties++;
            else if (analysis.action === 'new_unit') importStats.newUnits++;
            else if (analysis.action === 'update_unit') importStats.updatedUnits++;

            if (analysis.errors.length > 0) importStats.errors++;
            if (analysis.warnings.length > 0) importStats.warnings++;

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ${index}:`, error);
            importStats.errors++;
        }
    });

    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„:', importStats);
}

// Analyze individual record
function analyzeRecord(record, index) {
    const analysis = {
        index: index,
        record: record,
        action: 'unknown',
        existingProperty: null,
        existingUnit: null,
        errors: [],
        warnings: []
    };

    // Validate required fields
    const requiredFields = ['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±', 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', 'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
    requiredFields.forEach(field => {
        if (!record[field] || record[field].toString().trim() === '') {
            analysis.errors.push(`Ø§Ù„Ø­Ù‚Ù„ "${field}" Ù…Ø·Ù„ÙˆØ¨`);
        }
    });

    if (analysis.errors.length > 0) {
        return analysis;
    }

    // Find existing property
    const propertyName = record['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].toString().trim();
    const cityName = record['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'].toString().trim();
    const unitNumber = record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toString().trim();

    analysis.existingProperty = properties.find(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === cityName
    );

    if (analysis.existingProperty) {
        // Property exists, check for unit
        analysis.existingUnit = properties.find(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
            p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === cityName &&
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );

        if (analysis.existingUnit) {
            analysis.action = 'update_unit';
        } else {
            analysis.action = 'new_unit';
        }
    } else {
        analysis.action = 'new_property';
    }

    // Validate data types
    validateRecordData(record, analysis);

    return analysis;
}

// Validate record data types
function validateRecordData(record, analysis) {
    // Validate numeric fields
    const numericFields = ['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'];
    numericFields.forEach(field => {
        if (record[field] && record[field] !== '') {
            const value = parseFloat(record[field]);
            if (isNaN(value)) {
                analysis.warnings.push(`Ø§Ù„Ø­Ù‚Ù„ "${field}" ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…`);
            }
        }
    });

    // Validate dates
    const dateFields = ['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯', 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'];
    dateFields.forEach(field => {
        if (record[field] && record[field] !== '') {
            const date = new Date(record[field]);
            if (isNaN(date.getTime())) {
                analysis.warnings.push(`Ø§Ù„Ø­Ù‚Ù„ "${field}" ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­`);
            }
        }
    });
}

// Next step in import process
function nextImportStep() {
    const currentStep = document.querySelector('.import-step:not([style*="display: none"])');
    const stepNumber = parseInt(currentStep.id.replace('step', ''));

    if (stepNumber === 1) {
        // Move to preview step
        showImportStep(2);
        generateImportPreview();
    }
}

// Show specific import step
function showImportStep(stepNumber) {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (step) step.style.display = 'none';
    }

    // Show target step
    const targetStep = document.getElementById(`step${stepNumber}`);
    if (targetStep) targetStep.style.display = 'block';

    // Update buttons
    updateImportButtons(stepNumber);
}

// Update import modal buttons
function updateImportButtons(stepNumber) {
    const nextBtn = document.getElementById('nextBtn');
    const importBtn = document.getElementById('importBtn');
    const finishBtn = document.getElementById('finishBtn');

    // Hide all buttons first
    nextBtn.style.display = 'none';
    importBtn.style.display = 'none';
    finishBtn.style.display = 'none';

    switch (stepNumber) {
        case 1:
            if (importedData) nextBtn.style.display = 'inline-flex';
            break;
        case 2:
            importBtn.style.display = 'inline-flex';
            break;
        case 3:
            // No buttons during import
            break;
        case 4:
            finishBtn.style.display = 'inline-flex';
            break;
    }
}

// Generate import preview
function generateImportPreview() {
    console.log('ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

    if (!importedData || importedData.length === 0) {
        showImportError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
        return;
    }

    // Analyze data and generate preview
    analyzeImportData();
    displayPreviewStats();
    displayPreviewTable();
}

// Analyze import data
function analyzeImportData() {
    console.log('ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©...');

    importStats = {
        totalRecords: importedData.length,
        newProperties: 0,
        newUnits: 0,
        updatedUnits: 0,
        errors: 0,
        warnings: 0
    };

    importPreview = [];

    importedData.forEach((record, index) => {
        try {
            const analysis = analyzeRecord(record, index);
            importPreview.push(analysis);

            // Update stats
            if (analysis.action === 'new_property') importStats.newProperties++;
            else if (analysis.action === 'new_unit') importStats.newUnits++;
            else if (analysis.action === 'update_unit') importStats.updatedUnits++;

            if (analysis.errors.length > 0) importStats.errors++;
            if (analysis.warnings.length > 0) importStats.warnings++;

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ${index}:`, error);
            importStats.errors++;
        }
    });

    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„:', importStats);
}

// Analyze individual record
function analyzeRecord(record, index) {
    const analysis = {
        index: index,
        record: record,
        action: 'unknown',
        existingProperty: null,
        existingUnit: null,
        errors: [],
        warnings: []
    };

    // Validate required fields
    const requiredFields = ['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±', 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', 'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
    requiredFields.forEach(field => {
        if (!record[field] || record[field].toString().trim() === '') {
            analysis.errors.push(`Ø§Ù„Ø­Ù‚Ù„ "${field}" Ù…Ø·Ù„ÙˆØ¨`);
        }
    });

    if (analysis.errors.length > 0) {
        return analysis;
    }

    // Find existing property
    const propertyName = record['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].toString().trim();
    const cityName = record['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'].toString().trim();
    const unitNumber = record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toString().trim();

    analysis.existingProperty = properties.find(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === cityName
    );

    if (analysis.existingProperty) {
        // Property exists, check for unit
        analysis.existingUnit = properties.find(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
            p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === cityName &&
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );

        if (analysis.existingUnit) {
            analysis.action = 'update_unit';
        } else {
            analysis.action = 'new_unit';
        }
    } else {
        analysis.action = 'new_property';
    }

    // Validate data types
    validateRecordData(record, analysis);

    return analysis;
}

// Validate record data types
function validateRecordData(record, analysis) {
    // Validate numeric fields
    const numericFields = [
        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©',
        'Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ', 'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'
    ];
    numericFields.forEach(field => {
        if (record[field] && record[field] !== '' && record[field] !== null) {
            const value = parseFloat(record[field]);
            if (isNaN(value)) {
                analysis.warnings.push(`Ø§Ù„Ø­Ù‚Ù„ "${field}" ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…`);
            }
        }
    });

    // Validate dates
    const dateFields = [
        'ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯', 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ', 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'
    ];
    dateFields.forEach(field => {
        if (record[field] && record[field] !== '' && record[field] !== null) {
            // Handle different date formats
            let dateStr = record[field].toString();

            // Remove time part if exists
            if (dateStr.includes(' 00:00:00')) {
                dateStr = dateStr.replace(' 00:00:00', '');
            }

            // Try to parse the date
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                // Try alternative formats
                const altFormats = [
                    dateStr.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, '$3-$2-$1'), // DD/MM/YYYY to YYYY-MM-DD
                    dateStr.replace(/(\d{1,2})-(\d{1,2})-(\d{4})/, '$3-$2-$1'),  // DD-MM-YYYY to YYYY-MM-DD
                    dateStr.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, '$3-$1-$2')  // MM/DD/YYYY to YYYY-MM-DD
                ];

                let validDate = false;
                for (const format of altFormats) {
                    const testDate = new Date(format);
                    if (!isNaN(testDate.getTime())) {
                        validDate = true;
                        break;
                    }
                }

                if (!validDate) {
                    analysis.warnings.push(`Ø§Ù„Ø­Ù‚Ù„ "${field}" ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­ (${dateStr})`);
                }
            }
        }
    });

    // Validate contract status
    const validStatuses = ['Ù†Ø´Ø·', 'Ø´Ø§ØºØ±', 'Ù…Ø¤ÙƒØ¯', 'ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'Ù…Ù†ØªÙ‡ÙŠ', 'Ù…Ø¹Ù„Ù‚'];
    if (record['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯'] && !validStatuses.includes(record['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯'])) {
        analysis.warnings.push(`Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯ "${record['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯']}" ØºÙŠØ± ØµØ­ÙŠØ­Ø©`);
    }

    // Validate contract type
    const validTypes = ['Ø¶Ø±ÙŠØ¨ÙŠ', 'ØºÙŠØ± Ø¶Ø±ÙŠØ¨ÙŠ', 'Ø­ÙƒÙˆÙ…ÙŠ', 'Ø®Ø§Øµ'];
    if (record['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] && !validTypes.includes(record['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'])) {
        analysis.warnings.push(`Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯ "${record['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯']}" ØºÙŠØ± ØµØ­ÙŠØ­`);
    }

    // Validate financial consistency
    if (record['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] && record['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹'] && record['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ']) {
        const total = parseFloat(record['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']);
        const paid = parseFloat(record['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹']);
        const remaining = parseFloat(record['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ']);

        if (!isNaN(total) && !isNaN(paid) && !isNaN(remaining)) {
            const calculatedRemaining = total - paid;
            if (Math.abs(calculatedRemaining - remaining) > 0.01) {
                analysis.warnings.push(`Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©: Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total} - Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ${paid} â‰  Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ${remaining}`);
            }
        }
    }
}

// Display preview statistics
function displayPreviewStats() {
    const statsContainer = document.getElementById('previewStats');

    statsContainer.innerHTML = `
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">${importStats.totalRecords}</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
            </div>
            <div class="stat-item new">
                <div class="stat-number">${importStats.newProperties}</div>
                <div class="stat-label">Ø¹Ù‚Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
            </div>
            <div class="stat-item new">
                <div class="stat-number">${importStats.newUnits}</div>
                <div class="stat-label">ÙˆØ­Ø¯Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
            </div>
            <div class="stat-item update">
                <div class="stat-number">${importStats.updatedUnits}</div>
                <div class="stat-label">ÙˆØ­Ø¯Ø§Øª Ù…Ø­Ø¯Ø«Ø©</div>
            </div>
            <div class="stat-item warning">
                <div class="stat-number">${importStats.warnings}</div>
                <div class="stat-label">ØªØ­Ø°ÙŠØ±Ø§Øª</div>
            </div>
            <div class="stat-item error">
                <div class="stat-number">${importStats.errors}</div>
                <div class="stat-label">Ø£Ø®Ø·Ø§Ø¡</div>
            </div>
        </div>
    `;
}

// Display preview table
function displayPreviewTable() {
    const tableContainer = document.getElementById('previewTable');

    if (!importPreview || importPreview.length === 0) {
        tableContainer.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</p>';
        return;
    }

    // Show first 10 records for preview
    const previewData = importPreview.slice(0, 10);

    let tableHTML = `
        <thead>
            <tr>
                <th>#</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±</th>
                <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody>
    `;

    previewData.forEach((item, index) => {
        const record = item.record;
        const actionText = getActionText(item.action);
        const statusClass = getStatusClass(item);
        const statusText = getStatusText(item);

        tableHTML += `
            <tr class="${statusClass}">
                <td>${index + 1}</td>
                <td>${record['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '-'}</td>
                <td>${record['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || '-'}</td>
                <td>${record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '-'}</td>
                <td>${actionText}</td>
                <td>${statusText}</td>
            </tr>
        `;
    });

    tableHTML += '</tbody>';

    if (importPreview.length > 10) {
        tableHTML += `
            <tfoot>
                <tr>
                    <td colspan="6" class="more-records">
                        ... Ùˆ ${importPreview.length - 10} Ø³Ø¬Ù„ Ø¢Ø®Ø±
                    </td>
                </tr>
            </tfoot>
        `;
    }

    tableContainer.innerHTML = tableHTML;
}

// Get action text in Arabic
function getActionText(action) {
    switch (action) {
        case 'new_property': return 'Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯';
        case 'new_unit': return 'Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©';
        case 'update_unit': return 'ØªØ­Ø¯ÙŠØ« ÙˆØ­Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©';
        default: return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    }
}

// Get status class for styling
function getStatusClass(item) {
    if (item.errors.length > 0) return 'error';
    if (item.warnings.length > 0) return 'warning';
    return 'success';
}

// Get status text
function getStatusText(item) {
    if (item.errors.length > 0) return `Ø®Ø·Ø£ (${item.errors.length})`;
    if (item.warnings.length > 0) return `ØªØ­Ø°ÙŠØ± (${item.warnings.length})`;
    return 'Ø¬Ø§Ù‡Ø²';
}

// Execute import process
async function executeImport() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...');

    // Move to execution step
    showImportStep(3);

    // Get import options
    const createBackup = document.getElementById('createBackup').checked;
    const updateExisting = document.getElementById('updateExisting').checked;
    const addNewUnits = document.getElementById('addNewUnits').checked;

    console.log('âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', { createBackup, updateExisting, addNewUnits });

    try {
        // Step 1: Create backup if requested
        if (createBackup) {
            await createDataBackup();
            updateImportProgress(10, 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');
        }

        // Step 2: Process import data
        updateImportProgress(20, 'Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

        const results = await processImportData(updateExisting, addNewUnits);

        // Step 3: Save to localStorage
        updateImportProgress(80, 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹...');
        localStorage.setItem('properties', JSON.stringify(properties));

        // Step 4: Sync with Supabase if available
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            updateImportProgress(90, 'Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            await syncImportWithSupabase(results);
        }

        // Step 5: Complete
        updateImportProgress(100, 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');

        // Show results
        setTimeout(() => {
            showImportResults(results);
        }, 1000);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', error);
        showImportError('Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + error.message);
    }
}

// Create data backup with storage management
async function createDataBackup() {
    console.log('ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');

    try {
        // Clean up storage before creating backup
        await cleanupLocalStorage();

        const backupData = {
            timestamp: new Date().toISOString(),
            properties: [...properties],
            totalCount: properties.length
        };

        // Save backup to localStorage with error handling
        const backupKey = `backup_${Date.now()}`;

        try {
            localStorage.setItem(backupKey, JSON.stringify(backupData));
            console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${backupKey}`);
            addImportLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (${properties.length} Ø¹Ù‚Ø§Ø±)`);
        } catch (storageError) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', storageError.message);

            // Try to free up more space and retry
            await forceCleanupStorage();

            try {
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø¹Ø¯ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ†: ${backupKey}`);
                addImportLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (${properties.length} Ø¹Ù‚Ø§Ø±)`);
            } catch (retryError) {
                console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:', retryError.message);
                addImportLog(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©)`);
            }
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
        addImportLog(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©`);
    }
}

// Clean up localStorage to free space
async function cleanupLocalStorage() {
    console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†...');

    try {
        // Keep only last 3 backups instead of 5
        const allKeys = Object.keys(localStorage);
        const backupKeys = allKeys.filter(key => key.startsWith('backup_')).sort();

        if (backupKeys.length > 3) {
            const keysToRemove = backupKeys.slice(0, backupKeys.length - 3);
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ${key}`);
            });
        }

        // Clean up old update logs (keep only last 50 entries)
        const updateLog = JSON.parse(localStorage.getItem('updateLog') || '[]');
        if (updateLog.length > 50) {
            const trimmedLog = updateLog.slice(-50);
            localStorage.setItem('updateLog', JSON.stringify(trimmedLog));
            console.log(`ğŸ—‘ï¸ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª: ${updateLog.length} â†’ ${trimmedLog.length}`);
        }

        // Clean up any temporary data
        const tempKeys = allKeys.filter(key =>
            key.startsWith('temp_') ||
            key.startsWith('cache_') ||
            key.includes('_temp')
        );

        tempKeys.forEach(key => {
            localStorage.removeItem(key);
            console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©: ${key}`);
        });

        console.log('âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ†:', error);
    }
}

// Force cleanup storage (more aggressive)
async function forceCleanupStorage() {
    console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ù‚Ø³Ø±ÙŠ Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†...');

    try {
        // Remove all backups except the most recent one
        const allKeys = Object.keys(localStorage);
        const backupKeys = allKeys.filter(key => key.startsWith('backup_')).sort();

        if (backupKeys.length > 1) {
            const keysToRemove = backupKeys.slice(0, backupKeys.length - 1);
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${key}`);
            });
        }

        // Clear update log completely
        localStorage.removeItem('updateLog');
        console.log('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª');

        // Clear any other non-essential data
        const nonEssentialKeys = allKeys.filter(key =>
            !key.includes('properties') &&
            !key.includes('cardAttachments') &&
            !key.startsWith('backup_')
        );

        nonEssentialKeys.forEach(key => {
            localStorage.removeItem(key);
            console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: ${key}`);
        });

        console.log('âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø³Ø±ÙŠ Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø³Ø±ÙŠ:', error);
    }
}

// Save to localStorage with retry mechanism
async function saveToLocalStorageWithRetry(key, data, maxRetries = 3) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            localStorage.setItem(key, data);
            console.log(`âœ… ØªÙ… Ø­ÙØ¸ ${key} ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${attempt}`);
            return; // Success

        } catch (error) {
            console.warn(`âš ï¸ ÙØ´Ù„Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${attempt} Ù„Ø­ÙØ¸ ${key}:`, error.message);

            if (error.message.includes('quota') || error.message.includes('Storage')) {
                console.log(`ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${attempt + 1}...`);

                if (attempt === 1) {
                    // First attempt: light cleanup
                    await cleanupLocalStorage();
                } else if (attempt === 2) {
                    // Second attempt: aggressive cleanup
                    await forceCleanupStorage();
                } else {
                    // Final attempt: show storage info and fail
                    showStorageInfo();
                    throw new Error('Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø±ÙŠØ± Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ©');
                }
            } else {
                // Non-storage related error, don't retry
                throw error;
            }
        }
    }

    throw new Error(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ${maxRetries} Ù…Ø­Ø§ÙˆÙ„Ø§Øª`);
}

// Show storage information
function showStorageInfo() {
    try {
        const storageInfo = getStorageInfo();
        console.log('ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†:', storageInfo);

        // Show user-friendly storage info
        const message = `
Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†:
- Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: ${storageInfo.usedMB} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
- Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${storageInfo.availableMB} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
- Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: ${storageInfo.usagePercentage}%

Ù„Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:
1. Ø§Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
2. Ø§Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙØ­ Ø¢Ø®Ø±
3. Ø§Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù…ØªØµÙØ­
        `;

        console.log(message);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†:', error);
    }
}

// Get storage information
function getStorageInfo() {
    try {
        let totalSize = 0;
        let itemCount = 0;

        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                const itemSize = localStorage.getItem(key).length;
                totalSize += itemSize;
                itemCount++;
            }
        }

        // Estimate available space (most browsers have ~5-10MB limit)
        const estimatedLimit = 5 * 1024 * 1024; // 5MB in characters
        const usedMB = (totalSize / (1024 * 1024)).toFixed(2);
        const availableMB = ((estimatedLimit - totalSize) / (1024 * 1024)).toFixed(2);
        const usagePercentage = ((totalSize / estimatedLimit) * 100).toFixed(1);

        return {
            totalSize,
            itemCount,
            usedMB,
            availableMB,
            usagePercentage
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†:', error);
        return {
            totalSize: 0,
            itemCount: 0,
            usedMB: '0',
            availableMB: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
            usagePercentage: '0'
        };
    }
}

// Process import data
async function processImportData(updateExisting, addNewUnits) {
    console.log('ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...');

    const results = {
        processed: 0,
        newProperties: 0,
        newUnits: 0,
        updatedUnits: 0,
        skipped: 0,
        errors: []
    };

    for (let i = 0; i < importPreview.length; i++) {
        const item = importPreview[i];
        const progress = 20 + (60 * (i + 1) / importPreview.length);

        updateImportProgress(progress, `Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø¬Ù„ ${i + 1} Ù…Ù† ${importPreview.length}...`);

        try {
            if (item.errors.length > 0) {
                results.skipped++;
                results.errors.push(`Ø§Ù„Ø³Ø¬Ù„ ${i + 1}: ${item.errors.join(', ')}`);
                addImportLog(`âš ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¬Ù„ ${i + 1}: ${item.errors[0]}`);
                continue;
            }

            await processRecord(item, updateExisting, addNewUnits, results);
            results.processed++;

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø¬Ù„ ${i + 1}:`, error);
            results.errors.push(`Ø§Ù„Ø³Ø¬Ù„ ${i + 1}: ${error.message}`);
            addImportLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ ${i + 1}: ${error.message}`);
        }

        // Small delay to allow UI updates
        await new Promise(resolve => setTimeout(resolve, 10));
    }

    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:', results);
    return results;
}

// Process individual record
async function processRecord(item, updateExisting, addNewUnits, results) {
    const record = item.record;

    switch (item.action) {
        case 'new_property':
            await createNewProperty(record, results);
            break;

        case 'new_unit':
            if (addNewUnits) {
                await createNewUnit(record, results);
            } else {
                results.skipped++;
                addImportLog(`â­ï¸ ØªÙ… ØªØ®Ø·ÙŠ ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} (Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹Ø·Ù„Ø©)`);
            }
            break;

        case 'update_unit':
            if (updateExisting) {
                await updateExistingUnit(record, item.existingUnit, results);
            } else {
                results.skipped++;
                addImportLog(`â­ï¸ ØªÙ… ØªØ®Ø·ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø©: ${record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø¹Ø·Ù„)`);
            }
            break;
    }
}

// Create new property from import
async function createNewProperty(record, results) {
    const newProperty = createPropertyFromRecord(record);
    properties.push(newProperty);
    results.newProperties++;
    addImportLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯: ${record['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']} - ${record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
}

// Create new unit from import
async function createNewUnit(record, results) {
    const newUnit = createPropertyFromRecord(record);
    properties.push(newUnit);
    results.newUnits++;
    addImportLog(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ ${record['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`);
}

// Update existing unit from import
async function updateExistingUnit(record, existingUnit, results) {
    const unitIndex = properties.findIndex(p => p === existingUnit);
    if (unitIndex !== -1) {
        // Update all fields from import
        Object.keys(record).forEach(key => {
            if (record[key] !== null && record[key] !== undefined && record[key] !== '') {
                properties[unitIndex][key] = record[key];
            }
        });

        results.updatedUnits++;
        addImportLog(`ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø©: ${record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ ${record['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`);
    }
}

// Create property object from record
function createPropertyFromRecord(record) {
    return {
        'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': record['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '',
        'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': record['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || '',
        'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '',
        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': record['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': record['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '',
        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': record['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] ? parseFloat(record['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']) : '',
        'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': record['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? parseFloat(record['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) : '',
        'ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯': record['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] || record['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] || '',
        'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯': record['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] || record['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || '',
        'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·': record['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] || record['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] ? parseInt(record['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] || record['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©']) : '',
        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': record['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || '',
        'Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ': record['Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ'] || record['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || '',
        'Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ': record['Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ'] || record['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] ? parseFloat(record['Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ'] || record['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']) : '',
        'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': record['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || '',
        'Ø§Ù„Ù…Ø§Ù„Ùƒ': record['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || '',
        'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': record['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '',
        'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡': record['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] || '',
        'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': record['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] ? parseFloat(record['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) : '',
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹': record['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹'] ? parseFloat(record['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹']) : 0,
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': record['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'] ? parseFloat(record['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ']) : 0,
        'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯': record['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ù†Ø´Ø·',
        'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': record['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] || '',
        'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«': record['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || new Date().toISOString().split('T')[0]
    };
}

// Update import progress
function updateImportProgress(percentage, message) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }

    if (progressText) {
        progressText.textContent = message;
    }

    console.log(`ğŸ“Š ${percentage}%: ${message}`);
}

// Add log message to import log
function addImportLog(message) {
    const logContainer = document.getElementById('importLog');
    if (logContainer) {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-time">${new Date().toLocaleTimeString('ar-SA')}</span>
            <span class="log-message">${message}</span>
        `;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

// Sync import with Supabase
async function syncImportWithSupabase(results) {
    console.log('â˜ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Supabase...');

    try {
        // This would sync the imported data with Supabase
        // For now, we'll just log the attempt
        addImportLog(`â˜ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© ${results.processed} Ø³Ø¬Ù„ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...`);

        // Simulate sync delay
        await new Promise(resolve => setTimeout(resolve, 1000));

        addImportLog(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­`);

    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Supabase:', error);
        addImportLog(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
    }
}

// Show import results
function showImportResults(results) {
    showImportStep(4);

    const resultsContainer = document.getElementById('importResults');

    resultsContainer.innerHTML = `
        <div class="results-summary">
            <div class="result-item success">
                <i class="fas fa-check-circle"></i>
                <div class="result-details">
                    <div class="result-number">${results.processed}</div>
                    <div class="result-label">Ø³Ø¬Ù„ ØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­</div>
                </div>
            </div>

            <div class="result-item new">
                <i class="fas fa-plus-circle"></i>
                <div class="result-details">
                    <div class="result-number">${results.newProperties}</div>
                    <div class="result-label">Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</div>
                </div>
            </div>

            <div class="result-item new">
                <i class="fas fa-home"></i>
                <div class="result-details">
                    <div class="result-number">${results.newUnits}</div>
                    <div class="result-label">ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                </div>
            </div>

            <div class="result-item update">
                <i class="fas fa-edit"></i>
                <div class="result-details">
                    <div class="result-number">${results.updatedUnits}</div>
                    <div class="result-label">ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø«Ø©</div>
                </div>
            </div>

            ${results.skipped > 0 ? `
                <div class="result-item warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="result-details">
                        <div class="result-number">${results.skipped}</div>
                        <div class="result-label">Ø³Ø¬Ù„ ØªÙ… ØªØ®Ø·ÙŠÙ‡</div>
                    </div>
                </div>
            ` : ''}

            ${results.errors.length > 0 ? `
                <div class="result-item error">
                    <i class="fas fa-times-circle"></i>
                    <div class="result-details">
                        <div class="result-number">${results.errors.length}</div>
                        <div class="result-label">Ø®Ø·Ø£</div>
                    </div>
                </div>
            ` : ''}
        </div>

        ${results.errors.length > 0 ? `
            <div class="error-details">
                <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</h4>
                <ul>
                    ${results.errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            </div>
        ` : ''}

        <div class="import-actions">
            <button class="action-btn" onclick="refreshDataDisplay()">
                <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            </button>
            <button class="action-btn" onclick="exportImportLog()">
                <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            </button>
        </div>
    `;
}

// Utility functions
function changeImportFile() {
    document.getElementById('fileUploadArea').style.display = 'block';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';
    importedData = null;
}

function closeImportModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

function finishImport() {
    // Refresh the main data display
    refreshDataDisplay();
    closeImportModal();
}

function refreshDataDisplay() {
    // Refresh the main interface
    if (typeof renderData === 'function') {
        renderData();
    }
    if (typeof updateTotalStats === 'function') {
        updateTotalStats();
    }
    if (typeof searchUnits === 'function' && isManagementMode) {
        searchUnits();
    }
}

function showImportError(message) {
    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', message);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function exportImportLog() {
    const logEntries = document.querySelectorAll('.log-entry');
    let logText = 'Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯\n';
    logText += '===================\n\n';

    logEntries.forEach(entry => {
        const time = entry.querySelector('.log-time').textContent;
        const message = entry.querySelector('.log-message').textContent;
        logText += `${time}: ${message}\n`;
    });

    const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `import_log_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// Show storage cleanup modal
function showStorageCleanupModal() {
    console.log('ğŸ§¹ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ†...');

    const storageInfo = getStorageInfo();

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="storage-cleanup-modal">
            <div class="cleanup-modal-header">
                <h2><i class="fas fa-broom"></i> ØªÙ†Ø¸ÙŠÙ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†</h2>
                <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ</p>
            </div>

            <div class="cleanup-modal-content">
                <div class="storage-info-section">
                    <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                    <div class="storage-stats">
                        <div class="storage-stat">
                            <div class="stat-icon"><i class="fas fa-database"></i></div>
                            <div class="stat-details">
                                <div class="stat-value">${storageInfo.usedMB} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</div>
                                <div class="stat-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
                            </div>
                        </div>
                        <div class="storage-stat">
                            <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                            <div class="stat-details">
                                <div class="stat-value">${storageInfo.usagePercentage}%</div>
                                <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</div>
                            </div>
                        </div>
                        <div class="storage-stat">
                            <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="stat-details">
                                <div class="stat-value">${storageInfo.itemCount}</div>
                                <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±</div>
                            </div>
                        </div>
                    </div>

                    <div class="storage-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${storageInfo.usagePercentage}%"></div>
                        </div>
                        <div class="progress-text">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ†: ${storageInfo.usagePercentage}%</div>
                    </div>
                </div>

                <div class="cleanup-options-section">
                    <h3>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ</h3>
                    <div class="cleanup-options">
                        <div class="cleanup-option">
                            <div class="option-info">
                                <h4><i class="fas fa-archive"></i> ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</h4>
                                <p>Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø­Ø¯Ø« 2 Ù†Ø³Ø®Ø© ÙÙ‚Ø·</p>
                            </div>
                            <button class="cleanup-btn" onclick="cleanupBackups()">
                                <i class="fas fa-trash-alt"></i> ØªÙ†Ø¸ÙŠÙ
                            </button>
                        </div>

                        <div class="cleanup-option">
                            <div class="option-info">
                                <h4><i class="fas fa-history"></i> Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</h4>
                                <p>Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</p>
                            </div>
                            <button class="cleanup-btn" onclick="clearUpdateLog()">
                                <i class="fas fa-eraser"></i> Ù…Ø³Ø­
                            </button>
                        </div>

                        <div class="cleanup-option">
                            <div class="option-info">
                                <h4><i class="fas fa-temp-high"></i> Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©</h4>
                                <p>Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†ÙŠØ©</p>
                            </div>
                            <button class="cleanup-btn" onclick="clearTempData()">
                                <i class="fas fa-broom"></i> Ø­Ø°Ù
                            </button>
                        </div>

                        <div class="cleanup-option danger">
                            <div class="option-info">
                                <h4><i class="fas fa-exclamation-triangle"></i> ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„</h4>
                                <p>Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙ‚Ø·)</p>
                            </div>
                            <button class="cleanup-btn danger" onclick="performFullCleanup()">
                                <i class="fas fa-fire"></i> ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„
                            </button>
                        </div>
                    </div>
                </div>

                <div class="cleanup-results" id="cleanupResults" style="display: none;">
                    <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ†Ø¸ÙŠÙ</h3>
                    <div id="cleanupResultsContent"></div>
                </div>
            </div>

            <div class="cleanup-modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeCleanupModal()">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
                <button class="modal-action-btn refresh-btn" onclick="refreshStorageInfo()">
                    <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

// Cleanup functions
async function cleanupBackups() {
    console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');

    try {
        const allKeys = Object.keys(localStorage);
        const backupKeys = allKeys.filter(key => key.startsWith('backup_')).sort();

        if (backupKeys.length > 2) {
            const keysToRemove = backupKeys.slice(0, backupKeys.length - 2);
            keysToRemove.forEach(key => localStorage.removeItem(key));

            showCleanupResult(`âœ… ØªÙ… Ø­Ø°Ù ${keysToRemove.length} Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©`);
        } else {
            showCleanupResult('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø­Ø°Ù');
        }

        refreshStorageInfo();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
        showCleanupResult('âŒ ÙØ´Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
    }
}

async function clearUpdateLog() {
    console.log('ğŸ§¹ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...');

    try {
        localStorage.removeItem('updateLog');
        showCleanupResult('âœ… ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª');
        refreshStorageInfo();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:', error);
        showCleanupResult('âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª');
    }
}

async function clearTempData() {
    console.log('ğŸ§¹ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©...');

    try {
        const allKeys = Object.keys(localStorage);
        const tempKeys = allKeys.filter(key =>
            key.startsWith('temp_') ||
            key.startsWith('cache_') ||
            key.includes('_temp') ||
            key.includes('_cache')
        );

        tempKeys.forEach(key => localStorage.removeItem(key));

        showCleanupResult(`âœ… ØªÙ… Ø­Ø°Ù ${tempKeys.length} Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª`);
        refreshStorageInfo();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©:', error);
        showCleanupResult('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
    }
}

async function performFullCleanup() {
    const confirmed = confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ');

    if (!confirmed) return;

    console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„...');

    try {
        await forceCleanupStorage();
        showCleanupResult('âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­');
        refreshStorageInfo();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„:', error);
        showCleanupResult('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„');
    }
}

function showCleanupResult(message) {
    const resultsSection = document.getElementById('cleanupResults');
    const resultsContent = document.getElementById('cleanupResultsContent');

    if (resultsSection && resultsContent) {
        resultsContent.innerHTML = `<div class="cleanup-message">${message}</div>`;
        resultsSection.style.display = 'block';

        // Auto-hide after 3 seconds
        setTimeout(() => {
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
        }, 3000);
    }
}

function refreshStorageInfo() {
    // Close and reopen the modal with updated info
    closeCleanupModal();
    setTimeout(() => {
        showStorageCleanupModal();
    }, 100);
}

function closeCleanupModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// Show date update modal
function showDateUpdateModal() {
    console.log('ğŸ“… ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®...');

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="date-update-modal">
            <div class="date-update-header">
                <h2><i class="fas fa-calendar-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ù† Ù…Ù„Ù</h2>
                <p>ØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø· Ù…Ù† Ù…Ù„Ù JSON</p>
            </div>

            <div class="date-update-content">
                <div class="upload-section">
                    <h3>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«</h3>
                    <div class="file-upload-area" id="dateFileUploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-calendar-upload"></i>
                        </div>
                        <div class="upload-text">
                            <p>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù…Ù„Ù JSON Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                            <small>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰: Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</small>
                        </div>
                    </div>
                    <input type="file" id="dateFileInput" accept=".json" style="display: none;">

                    <div class="file-info" id="dateFileInfo" style="display: none;">
                        <div class="file-details">
                            <i class="fas fa-file-code"></i>
                            <div>
                                <div class="file-name" id="dateFileName"></div>
                                <div class="file-size" id="dateFileSize"></div>
                            </div>
                        </div>
                        <button class="change-file-btn" onclick="changeDateFile()">ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„Ù</button>
                    </div>
                </div>

                <div class="preview-section" id="datePreviewSection" style="display: none;">
                    <h3>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</h3>
                    <div class="preview-stats" id="datePreviewStats"></div>
                    <div class="preview-table-container">
                        <table class="preview-table" id="datePreviewTable"></table>
                    </div>
                </div>

                <div class="update-options" id="dateUpdateOptions" style="display: none;">
                    <h3>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«</h3>
                    <div class="options-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" id="updateContractDates" checked>
                            <span class="checkmark"></span>
                            ØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ©)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="updateInstallmentDates" checked>
                            <span class="checkmark"></span>
                            ØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="createDateBackup" checked>
                            <span class="checkmark"></span>
                            Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                        </label>
                    </div>
                </div>

                <div class="update-progress" id="dateUpdateProgress" style="display: none;">
                    <h3>ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="dateProgressFill"></div>
                    </div>
                    <div class="progress-text" id="dateProgressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</div>
                    <div class="update-log" id="dateUpdateLog"></div>
                </div>

                <div class="update-results" id="dateUpdateResults" style="display: none;">
                    <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ø¯ÙŠØ«</h3>
                    <div id="dateUpdateResultsContent"></div>
                </div>
            </div>

            <div class="date-update-actions">
                <button class="modal-action-btn close-btn" onclick="closeDateUpdateModal()">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
                <button class="modal-action-btn next-btn" id="dateNextBtn" onclick="previewDateUpdates()" style="display: none;">
                    <i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©
                </button>
                <button class="modal-action-btn update-btn" id="dateUpdateBtn" onclick="executeDateUpdate()" style="display: none;">
                    <i class="fas fa-calendar-check"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
                </button>
                <button class="modal-action-btn finish-btn" id="dateFinishBtn" onclick="finishDateUpdate()" style="display: none;">
                    <i class="fas fa-check"></i> Ø¥Ù†Ù‡Ø§Ø¡
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setupDateFileUpload();
}

// Alias for mobile menu compatibility
function openDateUpdateModal() {
    showDateUpdateModal();
}

// Setup date file upload functionality
function setupDateFileUpload() {
    const fileUploadArea = document.getElementById('dateFileUploadArea');
    const fileInput = document.getElementById('dateFileInput');

    // Click to upload
    fileUploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleDateFileSelection(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleDateFileSelection(e.target.files[0]);
        }
    });
}

// Handle date file selection
async function handleDateFileSelection(file) {
    console.log('ğŸ“… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®:', file.name);

    // Validate file type
    if (!file.name.toLowerCase().endsWith('.json')) {
        showDateUpdateError('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù†ÙˆØ¹ JSON ÙÙ‚Ø·');
        return;
    }

    // Show file info
    document.getElementById('dateFileName').textContent = file.name;
    document.getElementById('dateFileSize').textContent = formatFileSize(file.size);
    document.getElementById('dateFileUploadArea').style.display = 'none';
    document.getElementById('dateFileInfo').style.display = 'flex';
    document.getElementById('dateNextBtn').style.display = 'inline-flex';

    // Parse file
    try {
        dateUpdateData = await parseDateUpdateFile(file);
        console.log('âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­:', dateUpdateData.length, 'Ø³Ø¬Ù„');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®:', error);
        showDateUpdateError('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
    }
}

// Parse date update file
async function parseDateUpdateFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                    resolve(data);
                } else {
                    reject(new Error('Ù…Ù„Ù JSON ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'));
                }
            } catch (error) {
                reject(new Error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù JSON: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        reader.readAsText(file);
    });
}

// Preview date updates
function previewDateUpdates() {
    console.log('ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®...');

    if (!dateUpdateData || dateUpdateData.length === 0) {
        showDateUpdateError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
        return;
    }

    // Analyze date updates
    const analysis = analyzeDateUpdates();
    displayDatePreviewStats(analysis);
    displayDatePreviewTable(analysis);

    // Show preview and options
    document.getElementById('datePreviewSection').style.display = 'block';
    document.getElementById('dateUpdateOptions').style.display = 'block';
    document.getElementById('dateNextBtn').style.display = 'none';
    document.getElementById('dateUpdateBtn').style.display = 'inline-flex';
}

// Analyze date updates
function analyzeDateUpdates() {
    console.log('ğŸ“Š ØªØ­Ù„ÙŠÙ„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®...');

    const analysis = {
        totalRecords: dateUpdateData.length,
        validUpdates: 0,
        contractDateUpdates: 0,
        installmentDateUpdates: 0,
        notFound: 0,
        errors: [],
        updates: []
    };

    dateUpdateData.forEach((record, index) => {
        try {
            const updateInfo = analyzeRecordDateUpdate(record, index);
            analysis.updates.push(updateInfo);

            if (updateInfo.found) {
                analysis.validUpdates++;
                if (updateInfo.hasContractDates) analysis.contractDateUpdates++;
                if (updateInfo.hasInstallmentDates) analysis.installmentDateUpdates++;
            } else {
                analysis.notFound++;
            }

            if (updateInfo.errors.length > 0) {
                analysis.errors.push(...updateInfo.errors);
            }

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ${index}:`, error);
            analysis.errors.push(`Ø§Ù„Ø³Ø¬Ù„ ${index + 1}: ${error.message}`);
        }
    });

    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®:', analysis);
    return analysis;
}

// Analyze individual record for date update
function analyzeRecordDateUpdate(record, index) {
    const updateInfo = {
        index: index,
        record: record,
        found: false,
        existingUnit: null,
        hasContractDates: false,
        hasInstallmentDates: false,
        errors: [],
        warnings: []
    };

    // Validate required field
    if (!record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']) {
        updateInfo.errors.push('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨');
        return updateInfo;
    }

    // Find existing unit
    const unitNumber = record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toString().trim();
    updateInfo.existingUnit = properties.find(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber);

    if (updateInfo.existingUnit) {
        updateInfo.found = true;

        // Check for contract dates
        if (record['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] || record['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']) {
            updateInfo.hasContractDates = true;
        }

        // Check for installment dates
        for (let i = 1; i <= 10; i++) {
            const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                           i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                           `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

            if (record[dateKey]) {
                updateInfo.hasInstallmentDates = true;
                break;
            }
        }

        // Validate date formats
        validateDateFormats(record, updateInfo);

    } else {
        updateInfo.errors.push(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù…: ${unitNumber}`);
    }

    return updateInfo;
}

// Validate date formats in record
function validateDateFormats(record, updateInfo) {
    const dateFields = [
        'ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯', 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'
    ];

    // Add more installment date fields
    for (let i = 3; i <= 10; i++) {
        dateFields.push(`ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`);
    }

    dateFields.forEach(field => {
        if (record[field]) {
            const dateStr = record[field].toString();
            const date = new Date(dateStr);

            if (isNaN(date.getTime())) {
                updateInfo.warnings.push(`ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ "${field}": ${dateStr}`);
            }
        }
    });
}

// Display date preview statistics
function displayDatePreviewStats(analysis) {
    const statsContainer = document.getElementById('datePreviewStats');

    statsContainer.innerHTML = `
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">${analysis.totalRecords}</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
            </div>
            <div class="stat-item success">
                <div class="stat-number">${analysis.validUpdates}</div>
                <div class="stat-label">ØªØ­Ø¯ÙŠØ«Ø§Øª ØµØ§Ù„Ø­Ø©</div>
            </div>
            <div class="stat-item info">
                <div class="stat-number">${analysis.contractDateUpdates}</div>
                <div class="stat-label">ØªÙˆØ§Ø±ÙŠØ® Ø¹Ù‚ÙˆØ¯</div>
            </div>
            <div class="stat-item warning">
                <div class="stat-number">${analysis.installmentDateUpdates}</div>
                <div class="stat-label">ØªÙˆØ§Ø±ÙŠØ® Ø£Ù‚Ø³Ø§Ø·</div>
            </div>
            <div class="stat-item error">
                <div class="stat-number">${analysis.notFound}</div>
                <div class="stat-label">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>
            </div>
            <div class="stat-item error">
                <div class="stat-number">${analysis.errors.length}</div>
                <div class="stat-label">Ø£Ø®Ø·Ø§Ø¡</div>
            </div>
        </div>

        ${analysis.errors.length > 0 ? `
            <div class="errors-section">
                <h4><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</h4>
                <ul class="error-list">
                    ${analysis.errors.slice(0, 5).map(error => `<li>${error}</li>`).join('')}
                    ${analysis.errors.length > 5 ? `<li>... Ùˆ ${analysis.errors.length - 5} Ø®Ø·Ø£ Ø¢Ø®Ø±</li>` : ''}
                </ul>
            </div>
        ` : ''}
    `;
}

// Display date preview table
function displayDatePreviewTable(analysis) {
    const tableContainer = document.getElementById('datePreviewTable');

    // Show only first 10 records for preview
    const previewUpdates = analysis.updates.slice(0, 10);

    let tableHTML = `
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>Ø§Ù„Ø¹Ù‚Ø§Ø±</th>
                <th>ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯</th>
                <th>ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody>
    `;

    previewUpdates.forEach(update => {
        const statusClass = update.found ? 'success' : 'error';
        const statusText = update.found ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';

        const contractDates = update.hasContractDates ?
            `<i class="fas fa-check text-success"></i> Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«` :
            `<i class="fas fa-minus text-muted"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯`;

        const installmentDates = update.hasInstallmentDates ?
            `<i class="fas fa-check text-success"></i> Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«` :
            `<i class="fas fa-minus text-muted"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯`;

        tableHTML += `
            <tr class="${statusClass}">
                <td>${update.record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                <td>${update.existingUnit ? update.existingUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}</td>
                <td>${contractDates}</td>
                <td>${installmentDates}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            </tr>
        `;
    });

    tableHTML += '</tbody>';

    if (analysis.updates.length > 10) {
        tableHTML += `
            <tfoot>
                <tr>
                    <td colspan="5" class="text-center">
                        <small>Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 10 Ø³Ø¬Ù„Ø§Øª Ù…Ù† ${analysis.updates.length} Ø³Ø¬Ù„</small>
                    </td>
                </tr>
            </tfoot>
        `;
    }

    tableContainer.innerHTML = tableHTML;
}

// Execute date update
async function executeDateUpdate() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®...');

    // Get options
    const updateContractDates = document.getElementById('updateContractDates').checked;
    const updateInstallmentDates = document.getElementById('updateInstallmentDates').checked;
    const createBackup = document.getElementById('createDateBackup').checked;

    console.log('âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«:', { updateContractDates, updateInstallmentDates, createBackup });

    // Hide options and show progress
    document.getElementById('dateUpdateOptions').style.display = 'none';
    document.getElementById('dateUpdateBtn').style.display = 'none';
    document.getElementById('dateUpdateProgress').style.display = 'block';

    try {
        // Create backup if requested
        if (createBackup) {
            updateDateProgress(10, 'Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');
            await createDateBackup();
            addDateUpdateLog('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
        }

        // Process updates
        updateDateProgress(20, 'Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...');
        const results = await processDateUpdates(updateContractDates, updateInstallmentDates);

        // Save data
        updateDateProgress(90, 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        saveDataLocally();

        // Show results
        updateDateProgress(100, 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡!');
        displayDateUpdateResults(results);

        document.getElementById('dateUpdateProgress').style.display = 'none';
        document.getElementById('dateUpdateResults').style.display = 'block';
        document.getElementById('dateFinishBtn').style.display = 'inline-flex';

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®:', error);
        showDateUpdateError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®: ' + error.message);
    }
}

// Process date updates
async function processDateUpdates(updateContractDates, updateInstallmentDates) {
    const results = {
        processed: 0,
        contractDatesUpdated: 0,
        installmentDatesUpdated: 0,
        errors: 0,
        skipped: 0
    };

    const analysis = analyzeDateUpdates();
    const validUpdates = analysis.updates.filter(u => u.found);

    for (let i = 0; i < validUpdates.length; i++) {
        const update = validUpdates[i];
        const progress = 20 + (i / validUpdates.length) * 70;

        updateDateProgress(progress, `Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙˆØ­Ø¯Ø© ${update.record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}...`);

        try {
            const unitIndex = properties.findIndex(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === update.record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);

            if (unitIndex !== -1) {
                let updated = false;

                // Update contract dates
                if (updateContractDates && update.hasContractDates) {
                    if (update.record['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']) {
                        properties[unitIndex]['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] = formatDateForStorage(update.record['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']);
                        updated = true;
                    }
                    if (update.record['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']) {
                        properties[unitIndex]['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] = formatDateForStorage(update.record['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯']);
                        updated = true;
                    }
                    if (updated) results.contractDatesUpdated++;
                }

                // Update installment dates
                if (updateInstallmentDates && update.hasInstallmentDates) {
                    let installmentUpdated = false;

                    for (let j = 1; j <= 10; j++) {
                        const dateKey = j === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                                       j === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(j)}`;

                        if (update.record[dateKey]) {
                            properties[unitIndex][dateKey] = formatDateForStorage(update.record[dateKey]);
                            installmentUpdated = true;
                        }
                    }

                    if (installmentUpdated) {
                        results.installmentDatesUpdated++;
                        updated = true;
                    }
                }

                if (updated) {
                    results.processed++;
                    addDateUpdateLog(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø©: ${update.record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
                } else {
                    results.skipped++;
                    addDateUpdateLog(`â­ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø©: ${update.record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} (Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©)`);
                }
            }

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙˆØ­Ø¯Ø© ${update.record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
            results.errors++;
            addDateUpdateLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø© ${update.record['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}: ${error.message}`);
        }
    }

    return results;
}

// Helper functions for date update
function formatDateForStorage(dateStr) {
    try {
        if (!dateStr) return dateStr;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠ DD/MM/YYYY
        if (typeof dateStr === 'string' && dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const year = parseInt(parts[2]);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØªÙ†Ø³ÙŠÙ‚ ISO ØµØ­ÙŠØ­
                    const isoDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    const testDate = new Date(isoDate);

                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­
                    if (!isNaN(testDate.getTime())) {
                        return isoDate; // YYYY-MM-DD format
                    }
                }
            }
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DDØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­ØªÙ‡ ÙˆØ£Ø±Ø¬Ø¹Ù‡
        if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
            const parts = dateStr.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);

            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                const testDate = new Date(year, month - 1, day, 12, 0, 0);
                if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                }
            }
        }

        console.warn('ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­:', dateStr);
        return dateStr; // Return original if invalid
    } catch (error) {
        console.warn('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®:', dateStr, error);
        return dateStr;
    }
}

function updateDateProgress(percentage, message) {
    const progressFill = document.getElementById('dateProgressFill');
    const progressText = document.getElementById('dateProgressText');

    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }
    if (progressText) {
        progressText.textContent = message;
    }
}

function addDateUpdateLog(message) {
    const logContainer = document.getElementById('dateUpdateLog');
    if (logContainer) {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `<span class="log-time">${new Date().toLocaleTimeString('ar-SA')}</span> ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

async function createDateBackup() {
    const backupData = {
        timestamp: new Date().toISOString(),
        type: 'date_update_backup',
        data: JSON.parse(JSON.stringify(properties))
    };

    const backupKey = `backup_dates_${Date.now()}`;
    localStorage.setItem(backupKey, JSON.stringify(backupData));

    console.log('ğŸ’¾ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', backupKey);
}

function displayDateUpdateResults(results) {
    const resultsContainer = document.getElementById('dateUpdateResultsContent');

    resultsContainer.innerHTML = `
        <div class="results-summary">
            <div class="result-stats">
                <div class="stat-item success">
                    <div class="stat-number">${results.processed}</div>
                    <div class="stat-label">ÙˆØ­Ø¯Ø§Øª Ù…Ø­Ø¯Ø«Ø©</div>
                </div>
                <div class="stat-item info">
                    <div class="stat-number">${results.contractDatesUpdated}</div>
                    <div class="stat-label">ØªÙˆØ§Ø±ÙŠØ® Ø¹Ù‚ÙˆØ¯</div>
                </div>
                <div class="stat-item warning">
                    <div class="stat-number">${results.installmentDatesUpdated}</div>
                    <div class="stat-label">ØªÙˆØ§Ø±ÙŠØ® Ø£Ù‚Ø³Ø§Ø·</div>
                </div>
                <div class="stat-item muted">
                    <div class="stat-number">${results.skipped}</div>
                    <div class="stat-label">Ù…ØªØ®Ø·Ø§Ø©</div>
                </div>
                <div class="stat-item error">
                    <div class="stat-number">${results.errors}</div>
                    <div class="stat-label">Ø£Ø®Ø·Ø§Ø¡</div>
                </div>
            </div>

            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <h3>ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p>ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${results.processed} ÙˆØ­Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø±ÙŠØ®Ù‡Ø§</p>
            </div>
        </div>
    `;
}

function changeDateFile() {
    document.getElementById('dateFileUploadArea').style.display = 'block';
    document.getElementById('dateFileInfo').style.display = 'none';
    document.getElementById('datePreviewSection').style.display = 'none';
    document.getElementById('dateUpdateOptions').style.display = 'none';
    document.getElementById('dateNextBtn').style.display = 'none';
    document.getElementById('dateUpdateBtn').style.display = 'none';

    // Reset file input
    document.getElementById('dateFileInput').value = '';
    dateUpdateData = null;
}

function showDateUpdateError(message) {
    const errorModal = document.createElement('div');
    errorModal.className = 'modal-overlay';
    errorModal.style.display = 'flex';
    errorModal.innerHTML = `
        <div class="error-modal">
            <div class="error-content">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h3>
                <p>${message}</p>
                <button class="btn-primary" onclick="this.closest('.modal-overlay').remove()">
                    Ø­Ø³Ù†Ø§Ù‹
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(errorModal);
}

function closeDateUpdateModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }

    // Reset global variables
    dateUpdateData = null;
}

function finishDateUpdate() {
    // Refresh the main interface
    renderData();
    updateTotalStats();

    // Close modal
    closeDateUpdateModal();

    // Show success notification
    showSuccessMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
}

// Global variable to store date update data
let dateUpdateData = null;

// ==================== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ====================

// ØªØ­Ø±ÙŠØ± ÙˆØ­Ø¯Ø© ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function editUnit(unitNumber, propertyName) {
    console.log(`ğŸ”§ ØªØ­Ø±ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber} ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©
    const unit = properties.find(p =>
        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );

    if (!unit) {
        alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø©
    showUnitEditModal(unit);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø©
function showUnitEditModal(unit) {
    const modalHTML = `
        <div class="modal-overlay" style="display:flex;">
            <div class="modal-box unit-edit-modal">
                <button class="close-modal" onclick="closeModal()">Ã—</button>

                <div class="edit-modal-header">
                    <h2><i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø©</h2>
                    <p>ØªØ­Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©: ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}</p>
                </div>

                <div class="edit-modal-content">
                    <form id="unitEditForm" onsubmit="saveUnitEdit(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editUnitNumber">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© <span class="required">*</span></label>
                                <input type="text" id="editUnitNumber" name="unitNumber"
                                       value="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}"
                                       required class="form-control"
                                       placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                                <small class="form-text">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹</small>
                            </div>

                            <div class="form-group">
                                <label for="editPropertyName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
                                <input type="text" id="editPropertyName" name="propertyName"
                                       value="${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}"
                                       readonly class="form-control"
                                       style="background-color: #f8f9fa;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTenantName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
                                <input type="text" id="editTenantName" name="tenantName"
                                       value="${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}"
                                       class="form-control"
                                       placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±">
                            </div>

                            <div class="form-group">
                                <label for="editContractNumber">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</label>
                                <input type="text" id="editContractNumber" name="contractNumber"
                                       value="${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}"
                                       class="form-control"
                                       placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editRentValue">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</label>
                                <input type="number" id="editRentValue" name="rentValue"
                                       value="${unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || ''}"
                                       class="form-control"
                                       placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø¨Ø§Ù„Ø±ÙŠØ§Ù„">
                            </div>

                            <div class="form-group">
                                <label for="editArea">Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label>
                                <input type="number" id="editArea" name="area"
                                       value="${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || ''}"
                                       class="form-control"
                                       placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                            </div>
                        </div>

                        <input type="hidden" id="originalUnitNumber" value="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}">
                        <input type="hidden" id="originalPropertyName" value="${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}">

                        <div class="modal-actions">
                            <button type="button" class="modal-action-btn close-btn" onclick="closeModal()">
                                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                            </button>
                            <button type="submit" class="modal-action-btn save-btn">
                                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
    setTimeout(() => {
        document.getElementById('editUnitNumber').focus();
    }, 100);
}

// Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©
async function saveUnitEdit(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const newUnitNumber = formData.get('unitNumber').trim();
    const originalUnitNumber = document.getElementById('originalUnitNumber').value;
    const originalPropertyName = document.getElementById('originalPropertyName').value;
    const tenantName = formData.get('tenantName').trim();
    const contractNumber = formData.get('contractNumber').trim();
    const rentValue = formData.get('rentValue');
    const area = formData.get('area');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!newUnitNumber) {
        alert('âŒ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¥Ø°Ø§ ØªÙ… ØªØºÙŠÙŠØ±Ù‡)
    if (newUnitNumber !== originalUnitNumber) {
        const existingUnit = properties.find(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );

        if (existingUnit) {
            alert(`âŒ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© "${newUnitNumber}" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±`);
            return;
        }
    }

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const saveBtn = form.querySelector('.save-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveBtn.disabled = true;

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§
        const unitIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === originalUnitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );

        if (unitIndex === -1) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ø¯ÙŠØ«Ù‡Ø§');
        }

        console.log(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³: ${unitIndex}`);
        console.log(`ğŸ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©:`, JSON.stringify(properties[unitIndex], null, 2));
        console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${properties.length}`);

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        const originalData = { ...properties[unitIndex] };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙƒØ§Ø¦Ù† (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©)
        console.log(`ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...`);
        properties[unitIndex]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] = newUnitNumber;
        properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = tenantName || properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
        properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = contractNumber || properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'];
        properties[unitIndex]['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] = rentValue ? parseFloat(rentValue) : properties[unitIndex]['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '];
        properties[unitIndex]['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] = area ? parseFloat(area) : properties[unitIndex]['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'];

        console.log(`âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:`, JSON.stringify(properties[unitIndex], null, 2));
        console.log(`ğŸ”„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ØªØºÙŠØ± Ù…Ù† "${originalUnitNumber}" Ø¥Ù„Ù‰ "${newUnitNumber}"`);
        console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${properties.length}`);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ… ÙØ¹Ù„Ø§Ù‹
        if (properties[unitIndex]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber) {
            console.log(`âœ… ØªØ£ÙƒÙŠØ¯: ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©`);
        } else {
            console.error(`âŒ Ø®Ø·Ø£: ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©`);
            throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
        }

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø³Ø® Ù…ÙƒØ±Ø±Ø©
        const duplicateCheck = properties.filter(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );

        if (duplicateCheck.length > 1) {
            console.warn(`âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${duplicateCheck.length} Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ${newUnitNumber}`);
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·
            const firstIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
            );

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙƒØ±Ø±Ø©
            for (let i = properties.length - 1; i >= 0; i--) {
                if (i !== firstIndex &&
                    properties[i]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
                    properties[i]['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName) {
                    properties.splice(i, 1);
                    console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ù†Ø³Ø®Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ø§Ù„ÙÙ‡Ø±Ø³ ${i}`);
                }
            }
        }

        // Ø­ÙØ¸ ÙÙŠ localStorage Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        console.log(`ğŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage...`);
        console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸: ${properties.length}`);

        try {
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON
            const dataToSave = JSON.stringify(properties);
            console.log(`ğŸ“ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­ÙØ¸Ù‡Ø§: ${dataToSave.length} Ø­Ø±Ù`);

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
            await saveToLocalStorageWithRetry('properties', dataToSave);
            console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage Ø¨Ù†Ø¬Ø§Ø­`);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­ÙØ¸
            const savedData = localStorage.getItem('properties');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: ${parsedData.length}`);

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                const savedUnit = parsedData.find(p =>
                    p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
                    p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
                );

                if (savedUnit) {
                    console.log(`âœ… ØªØ£ÙƒÙŠØ¯: ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ localStorage`);
                    console.log(`   - Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸: "${savedUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}"`);
                    console.log(`   - Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: "${savedUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}"`);
                    console.log(`   - Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: "${savedUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}"`);
                } else {
                    console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ localStorage`);
                    console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©="${newUnitNumber}", Ø§Ù„Ø¹Ù‚Ø§Ø±="${originalPropertyName}"`);

                    // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„ØªØ´Ø®ÙŠØµ
                    console.log(`ğŸ” Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:`, parsedData.map(p => ({
                        unitNumber: p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                        propertyName: p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
                    })));

                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ localStorage');
                }
            } else {
                console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage`);
                throw new Error('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
            }

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage:`, error);

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ù…Ø³Ø§Ø­Ø©ØŒ Ø£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ù…ÙÙŠØ¯Ø©
            if (error.message.includes('quota') || error.message.includes('Storage')) {
                throw new Error('Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©. ÙŠØ±Ø¬Ù‰ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Ø¢Ø®Ø±.');
            } else {
                throw new Error(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹: ${error.message}`);
            }
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            try {
                await saveUnitToSupabase(properties[unitIndex], originalUnitNumber, originalPropertyName);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                console.log(`ğŸ” ÙØ­Øµ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...`);
                const { data: duplicateCheck, error: duplicateError } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ', newUnitNumber)
                    .eq('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±', originalPropertyName);

                if (!duplicateError && duplicateCheck && duplicateCheck.length > 1) {
                    console.warn(`âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${duplicateCheck.length} Ø³Ø¬Ù„ Ù…ÙƒØ±Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);

                    // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«
                    const sortedRecords = duplicateCheck.sort((a, b) =>
                        new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at)
                    );

                    for (let i = 1; i < sortedRecords.length; i++) {
                        const { error: deleteError } = await supabaseClient
                            .from('properties')
                            .delete()
                            .eq('id', sortedRecords[i].id);

                        if (!deleteError) {
                            console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙƒØ±Ø± ID: ${sortedRecords[i].id}`);
                        }
                    }
                }

            } catch (supabaseError) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ SupabaseØŒ Ù„ÙƒÙ† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ù„ÙŠ ØªÙ… Ø¨Ù†Ø¬Ø§Ø­:', supabaseError.message);
                // Ù„Ø§ Ù†Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ù„ÙŠ Ù†Ø¬Ø­
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeModal();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© - ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: ${isManagementMode}`);

        if (isManagementMode) {
            // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª
            console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©`);
            searchUnits();
        } else {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
            console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠ`);
            renderData();
            updateTotalStats();
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
        setTimeout(() => {
            console.log(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«`);

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
            const reloadedData = localStorage.getItem('properties');
            if (reloadedData) {
                try {
                    properties = JSON.parse(reloadedData);
                    console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${properties.length} Ø¹Ù‚Ø§Ø± Ù…Ù† localStorage`);

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ… Ø¨Ù†Ø¬Ø§Ø­
                    const updatedUnit = properties.find(p =>
                        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
                        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
                    );

                    if (updatedUnit) {
                        console.log(`âœ… ØªØ£ÙƒÙŠØ¯: Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­ - Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${updatedUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
                    } else {
                        console.error(`âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©`);
                    }

                } catch (e) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
                }
            }

            if (isManagementMode) {
                searchUnits();
            } else {
                renderData();
            }
        }, 100);

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showSuccessMessage(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© "${newUnitNumber}" Ø¨Ù†Ø¬Ø§Ø­`);

        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø©: ${originalUnitNumber} â†’ ${newUnitNumber}`);

        // ÙØ­Øµ Ù†Ù‡Ø§Ø¦ÙŠ Ø´Ø§Ù…Ù„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¦Ù…
        console.log(`ğŸ” ÙØ­Øµ Ù†Ù‡Ø§Ø¦ÙŠ Ø´Ø§Ù…Ù„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¦Ù…...`);

        // ÙØ­Øµ 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const finalCheckLocal = properties.find(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );

        if (finalCheckLocal) {
            console.log(`âœ… ÙØ­Øµ 1 - Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©: Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­`);
            console.log(`   - Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${finalCheckLocal['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
            console.log(`   - Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${finalCheckLocal['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}`);
            console.log(`   - Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ${finalCheckLocal['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}`);
        } else {
            console.error(`âŒ ÙØ­Øµ 1 ÙØ´Ù„ - Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©`);
            throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
        }

        // ÙØ­Øµ 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† localStorage
        const localStorageData = JSON.parse(localStorage.getItem('properties') || '[]');
        const finalCheckStorage = localStorageData.find(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );

        if (finalCheckStorage) {
            console.log(`âœ… ÙØ­Øµ 2 - localStorage: Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­`);
            console.log(`   - Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸: ${finalCheckStorage['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
        } else {
            console.error(`âŒ ÙØ­Øµ 2 ÙØ´Ù„ - Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ localStorage`);
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage');
        }

        // ÙØ­Øµ 3: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        const oldUnitCheck = properties.find(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === originalUnitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );

        if (oldUnitCheck) {
            console.warn(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ø§ Ø²Ø§Ù„Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© - Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ ØªÙƒØ±Ø§Ø±`);
            console.log(`   - Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ${oldUnitCheck['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
        } else {
            console.log(`âœ… ÙØ­Øµ 3 - Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© Ù‚Ø¯ÙŠÙ…Ø©: ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±`);
        }

        console.log(`ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ù†Ø¬Ø­Øª - Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…ÙƒØªÙ…Ù„ ÙˆØ¯Ø§Ø¦Ù…!`);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„ØªØ­Ø¯ÙŠØ« Ù„ØªØªØ¨Ø¹Ù‡
        const updateId = `update_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
        console.log(`ğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${updateId}`);

        // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ localStorage Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        const updateLog = JSON.parse(localStorage.getItem('updateLog') || '[]');
        updateLog.push({
            id: updateId,
            timestamp: new Date().toISOString(),
            action: 'editUnit',
            originalUnitNumber: originalUnitNumber,
            newUnitNumber: newUnitNumber,
            propertyName: originalPropertyName
        });
        localStorage.setItem('updateLog', JSON.stringify(updateLog));
        console.log(`ğŸ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª`);

        // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©`);
        if (typeof renderData === 'function') {
            renderData();
        }
        if (typeof updateTotalStats === 'function') {
            updateTotalStats();
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        const saveBtn = form.querySelector('.save-btn');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
        saveBtn.disabled = false;
    }
}

// Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
async function saveUnitToSupabase(unit, originalUnitNumber, originalPropertyName) {
    try {
        console.log(`â˜ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase:`);
        console.log(`   - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©: Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©="${originalUnitNumber}", Ø§Ù„Ø¹Ù‚Ø§Ø±="${originalPropertyName}"`);
        console.log(`   - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}", Ø§Ù„Ø¹Ù‚Ø§Ø±="${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}"`);

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Supabase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙ‚Ø·
        const { data: existingRecords, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ', originalUnitNumber)
            .eq('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±', originalPropertyName);

        if (searchError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Supabase:', searchError);
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${searchError.message}`);
        }

        console.log(`ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Supabase: ${existingRecords?.length || 0} Ø³Ø¬Ù„`);

        if (existingRecords && existingRecords.length > 0) {
            const existingRecord = existingRecords[0];
            console.log(`ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:`, {
                id: existingRecord.id,
                unitNumber: existingRecord['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                propertyName: existingRecord['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ID Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµØ­ÙŠØ­
            const updateData = {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'],
                'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': unit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'],
                'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ': unit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ'],
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '],
                'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'],
                updated_at: new Date().toISOString()
            };

            console.log(`ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«:`, updateData);

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ID Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø­Ù‚ÙˆÙ„
            const { data: updatedData, error: updateError } = await supabaseClient
                .from('properties')
                .update(updateData)
                .eq('id', existingRecord.id)
                .select();

            if (updateError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Supabase:', updateError);
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${updateError.message}`);
            } else {
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');
                console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:', updatedData);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
                if (updatedData && updatedData.length > 0) {
                    const updated = updatedData[0];
                    console.log(`âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ = "${updated['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}"`);
                }
            }
        } else {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Supabase Ù„Ù„ØªØ­Ø¯ÙŠØ«');
            console.log('ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰...');

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¯ÙˆÙ† ØªØ·Ø§Ø¨Ù‚ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù…Ø³Ø§ÙØ§Øª
            const { data: alternativeSearch, error: altError } = await supabaseClient
                .from('properties')
                .select('*')
                .ilike('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ', `%${originalUnitNumber.trim()}%`)
                .ilike('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±', `%${originalPropertyName.trim()}%`);

            if (!altError && alternativeSearch && alternativeSearch.length > 0) {
                console.log(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${alternativeSearch.length} Ø³Ø¬Ù„ Ø¨Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¨Ø¯ÙŠÙ„`);
                // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            } else {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø­ØªÙ‰ Ø¨Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¨Ø¯ÙŠÙ„');
            }
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase:', error);
        throw error; // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    }
}

// ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù…
function verifyDataPersistence() {
    console.log(`ğŸ” ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...`);

    try {
        // ÙØ­Øµ localStorage
        const savedData = localStorage.getItem('properties');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${parsedData.length} Ø¹Ù‚Ø§Ø± Ù…Ù† localStorage`);

            // ÙØ­Øµ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            const updateLog = JSON.parse(localStorage.getItem('updateLog') || '[]');
            if (updateLog.length > 0) {
                console.log(`ğŸ“ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${updateLog.length} Ø¹Ù…Ù„ÙŠØ©`);

                // Ø¹Ø±Ø¶ Ø¢Ø®Ø± 3 ØªØ­Ø¯ÙŠØ«Ø§Øª
                const recentUpdates = updateLog.slice(-3);
                recentUpdates.forEach((update, index) => {
                    console.log(`ğŸ“‹ ØªØ­Ø¯ÙŠØ« ${index + 1}: ${update.originalUnitNumber} â†’ ${update.newUnitNumber} ÙÙŠ ${update.propertyName}`);
                });
            }

            // ÙØ­Øµ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (properties.length === parsedData.length) {
                console.log(`âœ… ØªØ·Ø§Ø¨Ù‚ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© = localStorage`);
            } else {
                console.warn(`âš ï¸ Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚: Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (${properties.length}) â‰  localStorage (${parsedData.length})`);
            }

        } else {
            console.warn(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ localStorage`);
        }

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:`, error);
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
function showSuccessMessage(message) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const messageDiv = document.createElement('div');
    messageDiv.className = 'success-message';
    messageDiv.innerHTML = `
        <div class="success-content">
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø·
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        z-index: 10000;
        font-size: 1rem;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
        word-wrap: break-word;
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØµÙØ­Ø©
    document.body.appendChild(messageDiv);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        messageDiv.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}

// Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function showPropertyManager() {
    if (isManagementMode) {
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        exitManagementMode();
        return;
    }

    // Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    enterManagementMode();
}

// Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
function enterManagementMode() {
    isManagementMode = true;

    // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø±
    const propertyManagerBtn = document.getElementById('propertyManagerBtn');
    if (propertyManagerBtn) {
        propertyManagerBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Ø¹Ù‚Ø§Ø±Ø§ØªÙ†Ø§';
        propertyManagerBtn.title = 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠ';
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const mainContent = document.getElementById('content');
    const totalContainer = document.getElementById('totalContainer');
    const mobileTotals = document.getElementById('mobileTotals');
    const filterContainer = document.querySelector('.filter-container');
    const viewToggle = document.querySelector('.view-toggle');
    const header = document.querySelector('header');

    if (mainContent) mainContent.style.display = 'none';
    if (totalContainer) totalContainer.style.display = 'none';
    if (mobileTotals) mobileTotals.style.display = 'none';
    if (filterContainer) filterContainer.style.display = 'none';
    if (viewToggle) viewToggle.style.display = 'none';
    if (header) header.style.display = 'none';

    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const managementPage = document.createElement('div');
    managementPage.id = 'managementPage';
    managementPage.className = 'management-page';
    managementPage.innerHTML = `
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª Ù…Ø¹ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ -->
        <div class="management-fixed-header">
            <div class="header-content">
                <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ ÙÙ‚Ø· -->
                <button class="mobile-menu-toggle" id="managementMobileMenuToggle" onclick="toggleManagementSidebar()">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="header-center">
                    <h1><i class="fas fa-building"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h1>
                    <p>Ø¥Ø¶Ø§ÙØ© ÙˆØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª</p>
                </div>

                <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø¬ÙˆØ§Ù„ -->
                <button class="mobile-exit-btn" onclick="exitManagementMode()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ù„Ù„Ø¬ÙˆØ§Ù„ -->
        <div class="management-overlay" id="managementOverlay" onclick="closeManagementSidebar()"></div>

        <!-- Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ -->
        <div class="management-sidebar" id="managementSidebar">
            <div class="sidebar-content">
                <!-- Ø±Ø£Ø³ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ø¬ÙˆØ§Ù„ -->
                <div class="sidebar-header" style="background: linear-gradient(135deg, #007bff, #0056b3) !important; padding: 25px 20px !important; margin: 0 !important; border-bottom: none !important; position: relative !important; flex-shrink: 0 !important; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;">
                    <h3 style="font-size: 1.3rem !important; color: white !important; margin: 0 !important; text-align: center !important; font-weight: 700 !important; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important; font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important; letter-spacing: 0.4px !important;"><i class="fas fa-cogs" style="margin-left: 8px; color: white; font-size: 1.2rem;"></i> Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
                    <button class="mobile-sidebar-close" onclick="closeManagementSidebar()" style="display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 1.4rem; padding: 12px; cursor: pointer; border-radius: 50%; transition: all 0.3s ease; position: absolute; left: 20px; top: 20px; width: 45px; height: 45px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);">
                        <i class="fas fa-times" style="color: white; font-size: 1.4rem;"></i>
                    </button>
                </div>
                <nav class="sidebar-nav" style="flex: 1 !important; padding: 20px !important; display: flex !important; flex-direction: column !important; gap: 15px !important; overflow-y: auto !important; background: transparent !important; justify-content: flex-start !important;">

                    <!-- Ø²Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
                    <button class="nav-btn active" onclick="showPropertyTabMobile('properties');" data-tab="properties"
                            style="
                                width: 100% !important;
                                background: linear-gradient(135deg, #007bff, #0056b3) !important;
                                color: white !important;
                                border: none !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-building" style="color: white !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: white !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</span>
                    </button>

                    <!-- Ø²Ø± Ø§Ù„ÙˆØ­Ø¯Ø§Øª -->
                    <button class="nav-btn" onclick="showPropertyTabMobile('units');" data-tab="units"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-home" style="color: #34495e !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">Ø§Ù„ÙˆØ­Ø¯Ø§Øª</span>
                    </button>

                    <!-- Ø²Ø± Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª -->
                    <button class="nav-btn" onclick="showPropertyTabMobile('merge'); hideSidebarOnMobile();" data-tab="merge"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-layer-group" style="color: #34495e !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</span>
                    </button>

                    <!-- Ø²Ø± Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª -->
                    <button class="nav-btn" onclick="showUnitTransferModal(); hideSidebarOnMobile();"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-exchange-alt" style="color: #34495e !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</span>
                    </button>

                    <!-- Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·) -->
                    <button class="nav-btn admin-only-btn" onclick="showTrackingManagementModal(); hideSidebarOnMobile();" id="trackingManagementBtn"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-clipboard-list" style="color: #6f42c1 !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.1rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹</span>
                    </button>

                    <!-- Ø²Ø± ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
                    <button class="nav-btn filter-btn" onclick="toggleCityFilter()" id="cityFilterBtn"
                            style="
                                width: 100% !important;
                                background: linear-gradient(135deg, #6f42c1, #5a32a3) !important;
                                color: white !important;
                                border: none !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-filter" style="color: white !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: white !important;
                            font-size: 1.1rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span>
                        <i class="fas fa-chevron-down filter-arrow" id="filterArrow" style="color: white !important; font-size: 1.1rem !important; flex-shrink: 0 !important;"></i>
                    </button>



                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ - ØªØµÙ…ÙŠÙ… Ù…Ø­Ø³Ù† -->
                    <div class="city-filter-list" id="cityFilterList"
                         style="
                             display: none;
                             background: #f8f9fa;
                             border-radius: 12px;
                             margin: 0 20px 15px 20px;
                             padding: 15px;
                             border: 2px solid #e9ecef;
                             box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                             max-height: none;
                             overflow: visible;
                         ">

                        <!-- Ø®ÙŠØ§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù† -->
                        <div class="city-option all-cities" onclick="filterByCity('all')"
                             style="
                                 background: #28a745;
                                 color: white;
                                 padding: 8px 12px;
                                 border-radius: 20px;
                                 margin-bottom: 8px;
                                 cursor: pointer;
                                 display: inline-flex;
                                 align-items: center;
                                 gap: 6px;
                                 transition: all 0.2s ease;
                                 font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif;
                                 font-weight: 600;
                                 font-size: 13px;
                                 box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
                                 white-space: nowrap;
                                 flex-shrink: 0;
                                 border: 1px solid #28a745;
                             ">
                            <i class="fas fa-globe" style="font-size: 12px; color: white; flex-shrink: 0;"></i>
                            <span style="color: white; font-weight: inherit;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†</span>
                            <span class="city-count" id="allCitiesCount"
                                  style="
                                      background: rgba(255, 255, 255, 0.2);
                                      color: white;
                                      padding: 2px 6px;
                                      border-radius: 10px;
                                      font-size: 11px;
                                      font-weight: 600;
                                      min-width: 18px;
                                      text-align: center;
                                      border: none;
                                      flex-shrink: 0;
                                  ">0</span>
                        </div>

                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ù†Ø¸Ù…Ø© -->
                        <ol class="cities-list" id="citiesContainer"
                            style="
                                list-style: none;
                                margin: 0;
                                padding: 0;
                                counter-reset: city-counter;
                            ">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù…Ø¯Ù† Ù‡Ù†Ø§ -->
                        </ol>
                    </div>
                </nav>
                <div class="sidebar-footer" style="padding: 25px 20px !important; border-top: 2px solid #e9ecef !important; background: #f8f9fa !important; margin-top: auto !important; flex-shrink: 0 !important;">
                    <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ -->
                    <button class="btn-exit" onclick="exitManagementMode()"
                            style="
                                width: 100% !important;
                                padding: 25px 30px !important;
                                margin: 0 !important;
                                background: linear-gradient(135deg, #dc3545, #c82333) !important;
                                color: white !important;
                                border: none !important;
                                border-radius: 15px !important;
                                font-size: 1.5rem !important;
                                font-weight: 800 !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                gap: 15px !important;
                                min-height: 65px !important;
                                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3) !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                letter-spacing: 0.5px !important;
                                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                                text-align: center !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-sign-out-alt" style="font-size: 1.3rem !important; color: white !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: white !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                        ">Ø®Ø±ÙˆØ¬</span>
                    </button>
                </div>
            </div>


        </div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="management-main-content">
            <div class="management-body">
                <div id="properties-tab" class="tab-content active">
                    ${renderPropertiesTab()}
                </div>
                <div id="units-tab" class="tab-content">
                    ${renderUnitsTab()}
                </div>
                <div id="merge-tab" class="tab-content">
                    ${renderMergeTab()}
                </div>
            </div>
        </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø­ØªÙˆÙ‰
    document.body.appendChild(managementPage);

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.body.style.overflow = 'hidden';

    // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¯Ù†
    setTimeout(() => {
        initializeCityFilter();
        initializeManagementMobile();
        setupSidebarProtection();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        const observer = new MutationObserver(() => {
            setupSidebarProtection();
            protectSearchFields();
        });

        const sidebar = document.getElementById('managementSidebar');
        if (sidebar) {
            observer.observe(sidebar, {
                childList: true,
                subtree: true
            });
        }
    }, 100);
}

// ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ù„Ù„Ø¬ÙˆØ§Ù„ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// ØªÙ‡ÙŠØ¦Ø© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function initializeManagementMobile() {
    console.log('ğŸ“± ØªÙ‡ÙŠØ¦Ø© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    if (isMobileDevice()) {
        const sidebar = document.getElementById('managementSidebar');
        const overlay = document.getElementById('managementOverlay');

        if (sidebar) {
            sidebar.classList.remove('active');
        }
        if (overlay) {
            overlay.classList.remove('active');
        }

        console.log('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„');
    }
}

// ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
function toggleManagementSidebar() {
    console.log('ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±...');

    const sidebar = document.getElementById('managementSidebar');
    const overlay = document.getElementById('managementOverlay');
    const menuToggle = document.getElementById('managementMobileMenuToggle');

    if (!sidebar || !overlay) {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±');
        return;
    }

    const isActive = sidebar.classList.contains('active');

    if (isActive) {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
        closeManagementSidebar();
    } else {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
        openManagementSidebar();
    }
}

// ÙØªØ­ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
function openManagementSidebar() {
    console.log('ğŸ“‚ ÙØªØ­ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±...');

    const sidebar = document.getElementById('managementSidebar');
    const overlay = document.getElementById('managementOverlay');
    const menuToggle = document.getElementById('managementMobileMenuToggle');

    if (sidebar) {
        sidebar.classList.add('active');
    }
    if (overlay) {
        overlay.classList.add('active');
    }
    if (menuToggle) {
        menuToggle.classList.add('active');
        // ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ù„Ù‰ X
        const icon = menuToggle.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-times';
        }
    }

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.body.style.overflow = 'hidden';

    console.log('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±');
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
function closeManagementSidebar() {
    console.log('ğŸ“ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±...');

    const sidebar = document.getElementById('managementSidebar');
    const overlay = document.getElementById('managementOverlay');
    const menuToggle = document.getElementById('managementMobileMenuToggle');

    if (sidebar) {
        sidebar.classList.remove('active');
    }
    if (overlay) {
        overlay.classList.remove('active');
    }
    if (menuToggle) {
        menuToggle.classList.remove('active');
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const icon = menuToggle.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-bars';
        }
    }

    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    document.body.style.overflow = '';

    console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±');
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© showPropertyTab Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
function showPropertyTabMobile(tabName) {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    showPropertyTab(tabName);

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    // ÙˆÙ„ÙƒÙ† Ù„ÙŠØ³ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø«
    if (isMobileDevice() || window.innerWidth <= 768) {
        // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹
        setTimeout(() => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠÙ†Ù‚Ø± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø£Ùˆ Ø¨Ø­Ø«
            const activeElement = document.activeElement;
            const isFormElement = activeElement && (
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'SELECT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.classList.contains('form-control') ||
                activeElement.type === 'search' ||
                activeElement.hasAttribute('data-prevent-sidebar-close') ||
                activeElement.placeholder?.includes('Ø¨Ø­Ø«') ||
                activeElement.placeholder?.includes('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±') ||
                activeElement.placeholder?.includes('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©')
            );

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚ÙˆÙ„ Ø¨Ø­Ø« Ù†Ø´Ø·Ø©
            const activeSearchFields = document.querySelectorAll('input[data-prevent-sidebar-close="true"]');
            const hasActiveSearch = activeSearchFields.length > 0;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
            const sidebar = document.getElementById('managementSidebar');
            const sidebarSearchActive = sidebar && sidebar.hasAttribute('data-search-active');

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØªÙØ§Ø¹Ù„ Ù…Ø¹ Ù†Ù…ÙˆØ°Ø¬ Ø£Ùˆ Ø¨Ø­Ø«
            if (!isFormElement && !hasActiveSearch && !sidebarSearchActive) {
                closeManagementSidebar();
            }
        }, 300);
    }
}

// Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯)
function hideSidebarOnMobile() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¬ÙˆØ§Ù„
    if (isMobileDevice() || window.innerWidth <= 768) {
        setTimeout(() => {
            closeManagementSidebar();
        }, 200);
    }
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ù…Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡
function setupSidebarProtection() {
    const sidebar = document.getElementById('managementSidebar');
    if (!sidebar) return;

    // Ù…Ù†Ø¹ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    const protectedElements = [
        'input', 'select', 'textarea', 'button.city-option',
        '.city-filter-list', '.form-control', '.form-group',
        '.property-form', '.section-header', '.search-container',
        '.property-search', '.unit-search', '.merge-search'
    ];

    protectedElements.forEach(selector => {
        const elements = sidebar.querySelectorAll(selector);
        elements.forEach(element => {
            element.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            element.addEventListener('focus', function(e) {
                e.stopPropagation();
            });

            element.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            });

            element.addEventListener('touchend', function(e) {
                e.stopPropagation();
            });
        });
    });

    // Ø­Ù…Ø§ÙŠØ© Ø®Ø§ØµØ© Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    const searchSelectors = [
        '#propertySearch', '#unitSearch', '#mergeSearch',
        'input[type="search"]', 'input[placeholder*="Ø¨Ø­Ø«"]',
        'input[placeholder*="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±"]', 'input[placeholder*="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©"]',
        'input[placeholder*="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯"]', '.search-input',
        '#unitSearchInput', '#propertySearchInput', '#mergeSearchInput'
    ];

    searchSelectors.forEach(selector => {
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
        const sidebarInputs = sidebar.querySelectorAll(selector);
        sidebarInputs.forEach(input => {
            addSearchProtection(input);
        });

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£ÙŠØ¶Ø§Ù‹
        const mainInputs = document.querySelectorAll(selector);
        mainInputs.forEach(input => {
            addSearchProtection(input);
        });
    });

    console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ù…Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡');
}

// Ø¥Ø¶Ø§ÙØ© Ø­Ù…Ø§ÙŠØ© Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
function addSearchProtection(input) {
    if (!input) return;

    // Ù…Ù†Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªØ¤Ø¯ÙŠ Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
    const events = ['click', 'focus', 'touchstart', 'touchend', 'input', 'keyup', 'keydown', 'mousedown', 'mouseup'];

    events.forEach(eventType => {
        input.addEventListener(eventType, function(e) {
            e.stopPropagation();
            // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø­Ù…Ø§ÙŠØ©
            this.setAttribute('data-prevent-sidebar-close', 'true');

            // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¬ÙˆØ§Ù„
            if (isMobileDevice() || window.innerWidth <= 768) {
                // Ù…Ù†Ø¹ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø«
                const sidebar = document.getElementById('managementSidebar');
                if (sidebar) {
                    sidebar.setAttribute('data-search-active', 'true');
                }
            }
        });
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²
    input.addEventListener('blur', function() {
        setTimeout(() => {
            this.removeAttribute('data-prevent-sidebar-close');

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
            const sidebar = document.getElementById('managementSidebar');
            if (sidebar) {
                sidebar.removeAttribute('data-search-active');
            }
        }, 200);
    });
}

// Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
function exitManagementMode() {
    // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ')) {
        return;
    }

    isManagementMode = false;

    // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø±
    const propertyManagerBtn = document.getElementById('propertyManagerBtn');
    if (propertyManagerBtn) {
        propertyManagerBtn.innerHTML = '<i class="fas fa-building"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª';
        propertyManagerBtn.title = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª';
    }

    // Ø¥Ø²Ø§Ù„Ø© ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    const managementPage = document.getElementById('managementPage');
    if (managementPage) {
        managementPage.remove();
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ
    const mainContent = document.getElementById('content');
    const totalContainer = document.getElementById('totalContainer');
    const mobileTotals = document.getElementById('mobileTotals');
    const filterContainer = document.querySelector('.filter-container');
    const viewToggle = document.querySelector('.view-toggle');
    const header = document.querySelector('header');

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    if (mainContent) {
        mainContent.style.display = '';
        mainContent.style.visibility = 'visible';
    }
    if (totalContainer) {
        totalContainer.style.display = '';
        totalContainer.style.visibility = 'visible';
    }
    if (mobileTotals) {
        mobileTotals.style.display = '';
        mobileTotals.style.visibility = 'visible';
    }
    if (filterContainer) {
        filterContainer.style.display = '';
        filterContainer.style.visibility = 'visible';
    }
    if (viewToggle) {
        viewToggle.style.display = '';
        viewToggle.style.visibility = 'visible';
    }
    if (header) {
        header.style.display = '';
        header.style.visibility = 'visible';
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† body Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
    document.body.style.overflow = '';
    document.body.style.position = '';

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    setTimeout(() => {
        renderData();
    }, 100);
}

// Ø¹Ø±Ø¶ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function renderPropertiesTab() {
    const cities = getUniqueCountries().filter(city => city !== 'Ø§Ù„ÙƒÙ„');
    let existingProperties = getUniqueProperties();

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    if (selectedCityFilter !== 'all') {
        existingProperties = existingProperties.filter(propertyName => {
            const property = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
            return property && property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === selectedCityFilter;
        });
    }

    return `
        <div class="property-section city-management-section">
            <div class="section-header">
                <h3><i class="fas fa-city"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ù†</h3>
            </div>
            <div class="property-form">
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="newCityName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
                                   style="flex: 1; padding: 10px; border: 2px solid #6f42c1; border-radius: 6px;"
                                   onkeypress="if(event.key==='Enter') addNewCityToSystem()">
                            <button class="btn-primary" onclick="addNewCityToSystem()"
                                    style="white-space: nowrap; background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                            </button>
                        </div>
                        <div class="existing-cities-display">
                            <strong><i class="fas fa-list"></i> Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:</strong><br>
                            ${cities.filter(city => city !== 'Ø§Ù„ÙƒÙ„').join(' â€¢ ')}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
            </div>
            <div class="property-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                        <input type="text" id="newPropertyName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                        <select id="newPropertyCity">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
                            ${cities.map(city => `<option value="${city}">${city}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„ØµÙƒ:</label>
                        <input type="text" id="newPropertyDeed" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ">
                    </div>
                    <div class="form-group">
                        <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ:</label>
                        <input type="number" id="newPropertyArea" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ:</label>
                        <input type="text" id="newPropertyRegistry" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø§Ù„Ùƒ:</label>
                        <select id="newPropertyOwner" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ --</option>
                            <option value="Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯">Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯</option>
                            <option value="Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…">Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©):</label>
                        <input type="url" id="newPropertyLocation" placeholder="https://maps.google.com/...">
                    </div>
                </div>
                <button class="btn-primary" onclick="addNewProperty()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±
                </button>
            </div>
        </div>

        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h3>
                <div class="filter-info">
                    ${selectedCityFilter === 'all' ?
                        `<span class="filter-badge all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù† (${existingProperties.length} Ø¹Ù‚Ø§Ø±)</span>` :
                        `<span class="filter-badge filtered">Ù…Ø¯ÙŠÙ†Ø© ${selectedCityFilter} (${existingProperties.length} Ø¹Ù‚Ø§Ø±)</span>`
                    }
                </div>
                <div class="section-actions">
                    <button onclick="testPropertyEditSystem()" class="test-btn" title="Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª">
                        <i class="fas fa-vial"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
                    </button>
                    <button onclick="checkAllPropertiesSync()" class="sync-check-btn" title="ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©">
                        <i class="fas fa-sync-alt"></i> ÙØ­Øµ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                    </button>
                    <button onclick="fixAllDuplicatesWithConfirmation()" class="fix-duplicates-btn" title="Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©">
                        <i class="fas fa-broom"></i> Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±
                    </button>
                </div>
            </div>

            <!-- Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
            <div class="properties-search-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               id="propertiesSearchInput"
                               placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..."
                               class="properties-search-input"
                               oninput="handlePropertiesSearch(this.value)"
                               autocomplete="off">
                        <button class="clear-search-btn" onclick="clearPropertiesSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-results-count" id="propertiesSearchCount" style="display: none;">
                        <span id="searchResultsText"></span>
                    </div>
                </div>
            </div>
            <div class="existing-properties">
                ${existingProperties.length > 0 ?
                    existingProperties.map(property => {
                        const propertyData = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === property);
                        const cityName = propertyData ? propertyData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        return `
                            <div class="property-item">
                                <div class="property-info">
                                    <h4>${property}</h4>
                                    <p><i class="fas fa-map-marker-alt"></i> ${cityName}</p>
                                    <p><i class="fas fa-building"></i> Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === property).length}</p>
                                </div>
                                <div class="property-actions">
                                    <button onclick="editPropertyData('${property}')" class="btn-edit">
                                        <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±
                                    </button>
                                    <button onclick="viewPropertyUnits('${property}')" class="btn-view">
                                        <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                                    </button>
                                    ${isMobileDevice() ? `
                                    <button onclick="showDeedInfoForProperty('${property}', '${cityName}')" class="btn-deed" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
                                        <i class="fas fa-file-contract"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ
                                    </button>
                                    ` : ''}
                                    <button onclick="showPropertyStatistics('${property}')" class="btn-secondary">
                                        <i class="fas fa-chart-bar"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                                    </button>
                                    <button onclick="deleteProperty('${property}')" class="btn-delete">
                                        <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') :
                    `<div class="no-properties">
                        <i class="fas fa-search"></i>
                        <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª</h4>
                        <p>${selectedCityFilter === 'all' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯' : `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© ${selectedCityFilter}`}</p>
                    </div>`
                }
            </div>
        </div>
    `;
}

// Ø¹Ø±Ø¶ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function renderUnitsTab() {
    const properties = getUniqueProperties();

    return `
        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            </div>
            <div class="property-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                        <select id="unitPropertyName">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±</option>
                            ${properties.map(property => `<option value="${property}">${property}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                        <input type="text" id="unitNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</label>
                        <input type="number" id="unitArea" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡:</label>
                        <input type="text" id="unitElectricity" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡">
                    </div>
                </div>
                <button class="btn-primary" onclick="addNewUnit()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©
                </button>
            </div>
        </div>

        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-search"></i> Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
            </div>
            <div class="units-search">
                <input type="text" id="unitsSearchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø©..." onkeyup="searchUnits()">
                <select id="unitsFilterProperty" onchange="filterUnitsByProperty()">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</option>
                    ${properties.map(property => `<option value="${property}">${property}</option>`).join('')}
                </select>
            </div>
            <div id="unitsResults" class="units-results">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‡Ù†Ø§ -->
            </div>
        </div>
    `;
}

// Ø¹Ø±Ø¶ ØªØ¨ÙˆÙŠØ¨ Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function renderMergeTab() {
    const properties = getUniqueProperties();

    return `
        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-layer-group"></i> Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
                <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ù…Ø¬ Ø¹Ø¯Ø© ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø±Ù‚Ù… Ø¹Ù‚Ø¯ ÙˆØ§Ø­Ø¯</p>
            </div>
            <div class="property-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                        <select id="mergePropertyName" onchange="loadUnitsForMerge()">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±</option>
                            ${properties.map(property => `<option value="${property}">${property}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                        <input type="text" id="mergeContractNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆØ­Ø¯">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¯Ù…Ø¬:</label>
                    <div id="availableUnitsForMerge" class="units-checkbox-list">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù‡Ù†Ø§ -->
                    </div>
                </div>
                <button class="btn-primary" onclick="mergeSelectedUnits()">
                    <i class="fas fa-layer-group"></i> Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                </button>
            </div>
        </div>

        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø©</h3>
            </div>
            <div id="mergedUnitsDisplay" class="merged-units-display">
                ${renderMergedUnits()}
            </div>
        </div>
    `;
}

// Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø©
function renderMergedUnits() {
    const mergedContracts = {};

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
    properties.forEach(property => {
        if (property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {
            const contractKey = `${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}_${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`;
            if (!mergedContracts[contractKey]) {
                mergedContracts[contractKey] = {
                    contractNumber: property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
                    propertyName: property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                    units: [],
                    totalArea: 0
                };
            }
            mergedContracts[contractKey].units.push(property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);
            mergedContracts[contractKey].totalArea += parseFloat(property['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || 0;
        }
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø©
    const mergedOnly = Object.values(mergedContracts).filter(contract => contract.units.length > 1);

    if (mergedOnly.length === 0) {
        return '<p class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø¯Ù…ÙˆØ¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
    }

    return mergedOnly.map(contract => `
        <div class="merged-contract-item">
            <div class="contract-header">
                <h4>Ø¹Ù‚Ø¯ Ø±Ù‚Ù…: ${contract.contractNumber}</h4>
                <span class="property-name">${contract.propertyName}</span>
            </div>
            <div class="contract-details">
                <p><strong>Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</strong> ${contract.units.join(', ')}</p>
                <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> ${contract.totalArea.toLocaleString()} Ù…Â²</p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</strong> ${contract.units.length}</p>
            </div>
            <div class="contract-actions">
                <button onclick="editMergedContract('${contract.contractNumber}', '${contract.propertyName}')" class="btn-edit">
                    <i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ±
                </button>
                <button onclick="splitMergedContract('${contract.contractNumber}', '${contract.propertyName}')" class="btn-danger">
                    <i class="fas fa-unlink"></i> ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                </button>
            </div>
        </div>
    `).join('');
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function showPropertyTab(tabName) {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    const targetTab = document.getElementById(`${tabName}-tab`);
    if (targetTab) {
        targetTab.classList.add('active');
    }

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
    const sidebarBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (sidebarBtn) {
        sidebarBtn.classList.add('active');
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    if (tabName === 'units') {
        loadUnitsResults();
    } else if (tabName === 'merge') {
        const mergedDisplay = document.getElementById('mergedUnitsDisplay');
        if (mergedDisplay) {
            mergedDisplay.innerHTML = renderMergedUnits();
        }
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø­Ù…Ø§ÙŠØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    setTimeout(() => {
        protectSearchFields();
    }, 100);
}

// Ø­Ù…Ø§ÙŠØ© Ø®Ø§ØµØ© Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø«
function protectSearchFields() {
    const searchFields = document.querySelectorAll('#propertySearch, #unitSearch, #mergeSearch, input[type="search"], input[placeholder*="Ø¨Ø­Ø«"]');

    searchFields.forEach(field => {
        if (field && !field.hasAttribute('data-protected')) {
            field.setAttribute('data-protected', 'true');
            addSearchProtection(field);

            // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¬ÙˆØ§Ù„
            if (isMobileDevice() || window.innerWidth <= 768) {
                field.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    this.setAttribute('data-prevent-sidebar-close', 'true');
                });

                field.addEventListener('touchend', function(e) {
                    e.stopPropagation();
                });
            }
        }
    });
}

// Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯
function addNewProperty() {
    const name = document.getElementById('newPropertyName').value.trim();
    const city = document.getElementById('newPropertyCity').value;
    const deed = document.getElementById('newPropertyDeed').value.trim();
    const area = document.getElementById('newPropertyArea').value;
    const registry = document.getElementById('newPropertyRegistry').value.trim();
    const location = document.getElementById('newPropertyLocation').value.trim();
    const owner = document.getElementById('newPropertyOwner').value.trim();

    if (!name || !city) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ù‚Ø§Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    const existingProperty = properties.find(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === name && p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === city
    );

    if (existingProperty) {
        alert('ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
    }

    // âœ… Ù„Ø§ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ ÙˆØ­Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø£Ùˆ Ø£Ø³Ø§Ø³ÙŠØ©
    // Ø§Ù„Ø¹Ù‚Ø§Ø± ÙŠÙØ­ÙØ¸ ÙÙŠ propertyDefinitions ÙÙ‚Ø·
    console.log(`ğŸ“‹ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯ÙˆÙ† ÙˆØ­Ø¯Ø§Øª: "${name}" ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© "${city}"`);
    console.log('âœ… Ù„Ù† ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ ÙˆØ­Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© - Ø§Ù„Ø¹Ù‚Ø§Ø± Ø³ÙŠÙØ­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª ÙÙ‚Ø·');

    // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø£ÙŠØ¶Ø§Ù‹
    const propertyDefinition = {
        name: name,
        city: city,
        deed: deed || null,
        area: area || null,
        registry: registry || null,
        location: location || null,
        owner: owner || null,
        createdAt: new Date().toISOString()
    };

    propertyDefinitions.push(propertyDefinition);
    localStorage.setItem('propertyDefinitions', JSON.stringify(propertyDefinitions));

    // âœ… Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ ÙˆØ­Ø¯Ø© ÙÙŠ Supabase Ù„Ø£Ù†Ù‡ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø©
    console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ propertyDefinitions ÙÙ‚Ø·');

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (properties ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©)
    localStorage.setItem('properties', JSON.stringify(properties));

    console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± "${name}" ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© "${city}" Ø¨Ù†Ø¬Ø§Ø­`);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (!cityDefinitions.includes(city)) {
        cityDefinitions.push(city);
        localStorage.setItem('cityDefinitions', JSON.stringify(cityDefinitions));
        console.log(`ğŸ’¾ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© "${city}" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹`);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!\n\nâœ… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¬Ø§Ù‡Ø² Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø§Øª.\n\nØ§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ÙˆØ­Ø¯Ø§Øª" Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø¹Ù‚Ø§Ø±.');

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    initializeApp();

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('newPropertyName').value = '';
    document.getElementById('newPropertyCity').value = '';
    document.getElementById('newPropertyDeed').value = '';
    document.getElementById('newPropertyArea').value = '';
    document.getElementById('newPropertyRegistry').value = '';
    document.getElementById('newPropertyLocation').value = '';
    document.getElementById('newPropertyOwner').value = '';

    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    updatePropertiesDisplay();
}

// Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
function addNewUnit() {
    const propertyName = document.getElementById('unitPropertyName').value;
    const unitNumber = document.getElementById('unitNumber').value.trim();
    const unitArea = document.getElementById('unitArea').value;
    const electricity = document.getElementById('unitElectricity').value.trim();

    if (!propertyName || !unitNumber) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø±
    const existingUnit = properties.find(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
    );

    if (existingUnit) {
        alert('ÙŠÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
    }

    // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ù† Ù…ØµØ¯Ø±ÙŠÙ†
    let baseProperty = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    let isFromDefinitions = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù…ØµØ¯Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ÙÙŠ propertiesØŒ Ø§Ø¨Ø­Ø« ÙÙŠ propertyDefinitions
    if (!baseProperty) {
        const propertyDefinition = propertyDefinitions.find(p => p.name === propertyName);
        if (propertyDefinition) {
            isFromDefinitions = true; // Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª

            // ØªØ­ÙˆÙŠÙ„ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ properties
            baseProperty = {
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': propertyDefinition.name,
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': propertyDefinition.city,
                'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': propertyDefinition.deed,
                'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': propertyDefinition.area,
                'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': propertyDefinition.registry,
                'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': propertyDefinition.location,
                'Ø§Ù„Ù…Ø§Ù„Ùƒ': propertyDefinition.owner,
                // Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹': null,
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': null,
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': null,
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': null,
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': null,
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': null,
                'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': 0.0,
                'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡': null,
                'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©': null,
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': null,
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': null,
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': null,
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': null,
                'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·': null,
                'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
            };
            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" ÙÙŠ propertyDefinitions ÙˆØªØ­ÙˆÙŠÙ„Ù‡`);
        }
    } else {
        console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" ÙÙŠ properties`);
    }

    if (!baseProperty) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const newUnit = {
        ...baseProperty,
        'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': unitNumber,
        'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': parseFloat(unitArea) || null,
        'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡': electricity || null,
        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': null,
        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': null,
        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': null,
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': null,
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': null,
        'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': 0.0,
        'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©': null,
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': null,
        'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': null,
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': null,
        'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': null,
        'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·': null
    };

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ©
    properties.push(newUnit);

    // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† propertyDefinitionsØŒ Ø§Ø­Ø°ÙÙ‡ Ù…Ù† Ù‡Ù†Ø§Ùƒ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    if (isFromDefinitions) {
        const definitionIndex = propertyDefinitions.findIndex(p => p.name === propertyName);
        if (definitionIndex !== -1) {
            propertyDefinitions.splice(definitionIndex, 1);
            localStorage.setItem('propertyDefinitions', JSON.stringify(propertyDefinitions));
            console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" Ù…Ù† propertyDefinitions Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±`);
        }
    }

    // Ø­ÙØ¸ ÙÙŠ Supabase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (typeof savePropertyToSupabase === 'function') {
        savePropertyToSupabase(newUnit);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
    saveDataLocally();

    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    initializeApp();

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('unitPropertyName').value = '';
    document.getElementById('unitNumber').value = '';
    document.getElementById('unitArea').value = '';
    document.getElementById('unitElectricity').value = '';

    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    document.getElementById('units-tab').innerHTML = renderUnitsTab();
}

// ===== ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© =====
async function deleteUnit(unitNumber, propertyName) {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©:', { unitNumber, propertyName });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!ensurePropertiesLoaded('deleteUnit')) {
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø©
    const unitIndex = properties.findIndex(p =>
        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );

    console.log('ğŸ” ÙÙ‡Ø±Ø³ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©:', unitIndex);
    console.log('ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', properties.length);

    if (unitIndex === -1) {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©');
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©');
        return;
    }

    const unit = properties[unitIndex];

    // Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay';
    confirmModal.style.display = 'flex';
    confirmModal.innerHTML = `
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #dc3545; margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i> ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©
                </h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404;">
                        <i class="fas fa-info-circle"></i>
                        <strong>ØªØ­Ø°ÙŠØ±:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!
                    </p>
                </div>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§:</h4>
                    <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</strong> ${unitNumber}</p>
                    <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</strong> ${propertyName}</p>
                    <p><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${unit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']}</p>
                    <p><strong>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</strong> ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}</p>
                    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                </div>
                <p style="color: #dc3545; font-weight: 600; text-align: center;">
                    Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø±ÙÙ‚Ø§ØªÙ‡Ø§ØŸ
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeDeleteConfirmModal()">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
                <button class="modal-action-btn print-btn" onclick="confirmDeleteUnit('${unitNumber}', '${propertyName}', ${unitIndex})"
                        style="background: #dc3545; border-color: #dc3545;">
                    <i class="fas fa-trash"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(confirmModal);
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
function closeDeleteConfirmModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©
async function confirmDeleteUnit(unitNumber, propertyName, unitIndex) {
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
    closeDeleteConfirmModal();

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.style.display = 'flex';
    loadingModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #dc3545; margin-bottom: 20px;"></i>
            <h3>Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©...</h3>
            <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø±ÙÙ‚Ø§ØªÙ‡Ø§</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        const unit = properties[unitIndex];
        console.log('ğŸ—‘ï¸ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©:', unitNumber, 'Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±:', propertyName);

        // 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù‚ÙˆÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹
        console.log('ğŸ’ª Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù‚ÙˆÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Supabase...');

        let forceDeleteResult = { success: false };
        if (typeof forceDeleteUnitFromSupabase === 'function') {
            try {
                forceDeleteResult = await forceDeleteUnitFromSupabase(unit);
                console.log('ğŸ’ª Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù‚ÙˆÙŠ:', forceDeleteResult);
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù‚ÙˆÙŠ:', error);
            }
        }

        // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙƒØ¨Ø¯ÙŠÙ„
        console.log('ğŸ”§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...');

        const enhancedResult = await enhancedDeleteUnit(unit);

        // ØªØ­Ø¯ÙŠØ¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        const isSuccessful = forceDeleteResult.success || enhancedResult.success;
        const deletedFromSupabase = forceDeleteResult.deletedCount || enhancedResult.cloudDeleted || 0;

        if (isSuccessful) {
            console.log('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');

            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            loadingModal.remove();

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…ÙØµÙ„Ø©
            const successMessage = deletedFromSupabase > 0
                ? `ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (${deletedFromSupabase} Ø³Ø¬Ù„) ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`
                : 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ù„Ù… ØªÙˆØ¬Ø¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)';

            showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', successMessage);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            if (document.getElementById('units-tab')) {
                document.getElementById('units-tab').innerHTML = renderUnitsTab();
            }

            const searchResults = document.getElementById('unitSearchResults');
            if (searchResults) {
                const searchInput = document.getElementById('unitSearchInput');
                if (searchInput && searchInput.value.trim()) {
                    searchUnits();
                }
            }

            return; // Ø§Ù†ØªÙ‡Ù‰ Ø¨Ù†Ø¬Ø§Ø­
        } else {
            console.warn('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ù‚ÙˆÙŠØŒ Ø³ÙŠØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©');
        }

        // 2. Delete from Supabase with advanced foreign key handling
        console.log('ğŸ  Starting advanced Supabase deletion process...');
        console.log('ğŸ“‹ Property data for deletion:', {
            unitNumber: unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            propertyName: unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
            city: unit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'],
            tenant: unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'],
            contract: unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']
        });

        let deletionResult = { success: false, reason: 'UNKNOWN' };

        if (typeof deletePropertyFromSupabase === 'function') {
            try {
                // Show deletion progress to user
                showToast('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©...', 'info');

                // Advanced deletion with foreign key handling
                deletionResult = await deletePropertyFromSupabase(unit);
                console.log('ğŸ  Advanced deletion result:', deletionResult);

                // Handle results and provide detailed user feedback
                if (deletionResult.success) {
                    console.log('âœ… Property and all related data successfully deleted from Supabase');

                    // Show detailed success message
                    const successMessage = deletionResult.deletedCount > 0
                        ? `ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (${deletionResult.deletedCount} Ø³Ø¬Ù„)`
                        : 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';

                    showToast(successMessage, 'success');

                    // Log deletion details
                    if (deletionResult.deletionResults) {
                        const successfulDeletions = deletionResult.deletionResults.filter(r => r.success);
                        console.log(`ğŸ“Š Deletion summary: ${successfulDeletions.length}/${deletionResult.deletionResults.length} records deleted successfully`);
                    }

                    // Trigger UI refresh after successful deletion
                    setTimeout(() => {
                        console.log('ğŸ”„ Triggering data refresh after successful advanced deletion');
                        renderData();
                    }, 1000);

                } else {
                    // Handle different failure scenarios with more context
                    let userMessage = '';
                    let logLevel = 'warn';

                    switch (deletionResult.reason) {
                        case 'NO_CLIENT':
                            userMessage = 'ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· - Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©';
                            break;
                        case 'NOT_FOUND':
                            userMessage = 'ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ - Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                            break;
                        case 'LOCAL_ONLY':
                            userMessage = 'ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                            break;
                        case 'SCHEMA_ERROR':
                            userMessage = 'Ø®Ø·Ø£ ÙÙŠ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·';
                            logLevel = 'error';
                            break;
                        case 'CRITICAL_ERROR':
                            userMessage = 'Ø®Ø·Ø£ Ø®Ø·ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·';
                            logLevel = 'error';
                            break;
                        default:
                            // Check if partial deletion occurred
                            if (deletionResult.deletionResults) {
                                const partialSuccess = deletionResult.deletionResults.some(r => r.success);
                                if (partialSuccess) {
                                    userMessage = 'ØªÙ… Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… "Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"';
                                    logLevel = 'warning';
                                } else {
                                    userMessage = 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·';
                                }
                            } else {
                                userMessage = 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·';
                            }
                    }

                    console[logLevel]('âš ï¸ Advanced Supabase deletion failed:', deletionResult);
                    showToast(userMessage, logLevel === 'error' ? 'error' : 'warning');

                    // Provide specific guidance based on failure type
                    if (deletionResult.reason === 'NOT_FOUND') {
                        setTimeout(() => {
                            showToast('Ø§Ø³ØªØ®Ø¯Ù… "ØªØ´Ø®ÙŠØµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ù†', 'info');
                        }, 3000);
                    } else if (deletionResult.deletionResults && deletionResult.deletionResults.some(r => r.error && r.error.includes('foreign key'))) {
                        setTimeout(() => {
                            showToast('Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø­Ø°Ù Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·" Ù„Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©', 'info');
                        }, 3000);
                    }
                }

            } catch (error) {
                console.error('âŒ Critical error during advanced Supabase deletion:', error);
                showToast('Ø®Ø·Ø£ Ø®Ø·ÙŠØ± ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');

                // Log comprehensive error information
                console.error('Advanced deletion error details:', {
                    message: error.message,
                    stack: error.stack,
                    propertyData: unit,
                    timestamp: new Date().toISOString()
                });
            }
        } else {
            console.warn('âš ï¸ deletePropertyFromSupabase function not available');
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· - ÙˆØ¸ÙŠÙØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'warning');
        }

        // 3. Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        console.log('ğŸ’¾ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
        properties.splice(unitIndex, 1);
        console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©');

        // 4. Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        console.log('ğŸ“ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
        const propertyKey = `${propertyName}_${unitNumber}`;
        if (attachments[propertyKey]) {
            delete attachments[propertyKey];
            localStorage.setItem('propertyAttachments', JSON.stringify(attachments));
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
        } else {
            console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø­Ø°Ù');
        }

        // 5. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹...');
        saveDataLocally();
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹');

        // 6. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
        initializeApp();
        console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingModal.remove();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø±ÙÙ‚Ø§ØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…');

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        if (document.getElementById('units-tab')) {
            document.getElementById('units-tab').innerHTML = renderUnitsTab();
        }

        // ØªØ­Ø¯ÙŠØ« Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        const searchResults = document.getElementById('unitSearchResults');
        if (searchResults) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ
            const searchInput = document.getElementById('unitSearchInput');
            if (searchInput && searchInput.value.trim()) {
                searchUnits();
            }
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©:', error);

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingModal.remove();

        // Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ÙŠ
        try {
            console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·...');

            // Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            const localUnitIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
            );

            if (localUnitIndex !== -1) {
                properties.splice(localUnitIndex, 1);
                console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹');

                // Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const propertyKey = `${propertyName}_${unitNumber}`;
                if (attachments[propertyKey]) {
                    delete attachments[propertyKey];
                    localStorage.setItem('propertyAttachments', JSON.stringify(attachments));
                    console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹');
                }

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
                saveDataLocally();

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                initializeApp();

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªØ­Ø°ÙŠØ±
                showSuccessMessage(
                    'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹',
                    'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø­Ø°ÙÙ‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©.'
                );

                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                if (document.getElementById('units-tab')) {
                    document.getElementById('units-tab').innerHTML = renderUnitsTab();
                }

                // ØªØ­Ø¯ÙŠØ« Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                const searchResults = document.getElementById('unitSearchResults');
                if (searchResults) {
                    const searchInput = document.getElementById('unitSearchInput');
                    if (searchInput && searchInput.value.trim()) {
                        searchUnits();
                    }
                }

                return; // Ù†Ø¬Ø­ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ÙŠ
            }
        } catch (localError) {
            console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£ÙŠØ¶Ø§Ù‹:', localError);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        showErrorMessage(
            'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©',
            'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.'
        );
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
function showSuccessMessage(title, message) {
    const successModal = document.createElement('div');
    successModal.className = 'modal-overlay';
    successModal.style.display = 'flex';
    successModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 450px;">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 20px;"></i>
            <h3 style="color: #28a745; margin-bottom: 15px;">${title}</h3>
            <p style="color: #6c757d; margin-bottom: 25px;">${message}</p>
            <button class="modal-action-btn print-btn" onclick="closeModal()"
                    style="background: #28a745; border-color: #28a745;">
                <i class="fas fa-check"></i> Ù…ÙˆØ§ÙÙ‚
            </button>
        </div>
    `;
    document.body.appendChild(successModal);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¹ callback (Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚)
function showSuccessMessageWithCallback(title, message, callback) {
    console.log('ğŸ‰ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ callback:', title);

    const successModal = document.createElement('div');
    successModal.className = 'modal-overlay';
    successModal.style.display = 'flex';
    successModal.style.zIndex = '10000';

    // Ø¥Ù†Ø´Ø§Ø¡ ID ÙØ±ÙŠØ¯ Ù„Ù„Ø²Ø±
    const uniqueId = 'successOkBtn_' + Date.now();

    successModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 500px;">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 20px;"></i>
            <h3 style="color: #28a745; margin-bottom: 15px;">${title}</h3>
            <div style="color: #6c757d; margin-bottom: 25px; white-space: pre-line; text-align: right;">${message}</div>
            <button class="modal-action-btn print-btn" id="${uniqueId}"
                    style="background: #28a745; border-color: #28a745; font-size: 16px; padding: 12px 30px;">
                <i class="fas fa-check"></i> Ù…ÙˆØ§ÙÙ‚
            </button>
        </div>
    `;

    document.body.appendChild(successModal);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù„Ø²Ø±
    const okBtn = document.getElementById(uniqueId);
    if (okBtn) {
        okBtn.addEventListener('click', function() {
            console.log('âœ… ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚ØŒ ØªÙ†ÙÙŠØ° callback...');

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            successModal.remove();

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ù€ callback Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 100); // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            }
        });
    } else {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ù…ÙˆØ§ÙÙ‚');
    }

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©)
    successModal.addEventListener('click', function(e) {
        if (e.target === successModal) {
            console.log('âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§ØŒ ØªÙ†ÙÙŠØ° callback...');
            successModal.remove();
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 100);
            }
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù…ÙØªØ§Ø­ Enter
    const handleEnterKey = function(e) {
        if (e.key === 'Enter' && document.body.contains(successModal)) {
            console.log('âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ù…ÙØªØ§Ø­ EnterØŒ ØªÙ†ÙÙŠØ° callback...');
            e.preventDefault();
            successModal.remove();
            document.removeEventListener('keydown', handleEnterKey);
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 100);
            }
        }
    };

    document.addEventListener('keydown', handleEnterKey);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ callback
function showProgressModal(title, progressFunction, onComplete) {
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.style.zIndex = '10000';

    progressModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 450px;">
            <i class="fas fa-save" style="font-size: 3rem; color: #007bff; margin-bottom: 20px;"></i>
            <h3 style="color: #007bff; margin-bottom: 15px;">${title}</h3>
            <div style="margin-bottom: 20px;">
                <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 10px;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="color: #6c757d; font-size: 14px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</div>
                <div id="progressPercent" style="color: #007bff; font-weight: bold; margin-top: 5px;">0%</div>
            </div>
        </div>
    `;

    document.body.appendChild(progressModal);

    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…
    const updateProgress = (percent, text) => {
        progressBar.style.width = percent + '%';
        progressText.textContent = text;
        progressPercent.textContent = percent + '%';

        // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        if (percent >= 100) {
            progressBar.style.background = 'linear-gradient(90deg, #28a745, #1e7e34)';
            progressPercent.style.color = '#28a745';
        }
    };

    // ØªÙ†ÙÙŠØ° Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
    progressFunction(updateProgress).then((result) => {
        // Ø¥ØºÙ„Ø§Ù‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
        setTimeout(() => {
            progressModal.remove();
            if (onComplete && typeof onComplete === 'function') {
                onComplete(result);
            }
        }, 1000);
    }).catch((error) => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…:', error);
        progressModal.remove();
        if (onComplete && typeof onComplete === 'function') {
            onComplete(false);
        }
    });
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
function showErrorMessage(title, message) {
    const errorModal = document.createElement('div');
    errorModal.className = 'modal-overlay';
    errorModal.style.display = 'flex';
    errorModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 450px;">
            <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 20px;"></i>
            <h3 style="color: #dc3545; margin-bottom: 15px;">${title}</h3>
            <p style="color: #6c757d; margin-bottom: 25px;">${message}</p>
            <button class="modal-action-btn close-btn" onclick="closeModal()">
                <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    `;
    document.body.appendChild(errorModal);
}

// ===== ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯) =====
async function deleteProperty(propertyName) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
    const propertyUnits = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø£ÙŠØ¶Ø§Ù‹
    const propertyDefinition = propertyDefinitions.find(p => p.name === propertyName);

    if (propertyUnits.length === 0 && !propertyDefinition) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯');
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}": ${propertyUnits.length} ÙˆØ­Ø¯Ø©ØŒ ØªØ¹Ø±ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯: ${!!propertyDefinition}`);

    // Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay';
    confirmModal.style.display = 'flex';
    confirmModal.innerHTML = `
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3 style="color: #dc3545; margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i> ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±
                </h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404;">
                        <i class="fas fa-info-circle"></i>
                        <strong>ØªØ­Ø°ÙŠØ±:</strong> Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§ØªÙ‡ ÙˆÙ…Ø±ÙÙ‚Ø§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!
                    </p>
                </div>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡:</h4>
                    <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</strong> ${propertyName}</p>
                    <p><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${propertyUnits.length > 0 ? propertyUnits[0]['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                    <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</strong> ${propertyUnits.length} ÙˆØ­Ø¯Ø©</p>
                    <p><strong>Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</strong> ${propertyUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']).join(', ')}</p>
                </div>
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #721c24; font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±
                    </p>
                </div>
                <p style="color: #dc3545; font-weight: 600; text-align: center;">
                    Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeDeleteConfirmModal()">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
                <button class="modal-action-btn print-btn" onclick="confirmDeleteProperty('${propertyName}')"
                        style="background: #dc3545; border-color: #dc3545;">
                    <i class="fas fa-trash"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(confirmModal);
}

// ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø­Ø³Ù† Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
async function confirmDeleteProperty(propertyName) {
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
    closeDeleteConfirmModal();

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.style.display = 'flex';
    loadingModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #dc3545; margin-bottom: 20px;"></i>
            <h3>Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±...</h3>
            <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§ØªÙ‡ ÙˆÙ…Ø±ÙÙ‚Ø§ØªÙ‡</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
        const propertyUnits = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        const propertyDefinition = propertyDefinitions.find(p => p.name === propertyName);

        console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}": ${propertyUnits.length} ÙˆØ­Ø¯Ø©ØŒ ØªØ¹Ø±ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯: ${!!propertyDefinition}`);

        // Ø­Ø°Ù ÙƒÙ„ ÙˆØ­Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
        for (const unit of propertyUnits) {
            console.log(`ğŸ”§ Ø­Ø°Ù Ù…ØªÙ‚Ø¯Ù… Ù„Ù„ÙˆØ­Ø¯Ø©: ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
            const result = await enhancedDeleteUnit(unit);

            if (result.success) {
                console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ø¨Ù†Ø¬Ø§Ø­`);

                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©
                try {
                    await addChangeLog(
                        OPERATION_TYPES.DELETE_UNIT,
                        unit,
                        {},
                        {
                            reason: 'Ø­Ø°Ù ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±',
                            previousTenant: unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']
                        }
                    );
                } catch (trackingError) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©:', trackingError);
                }
            } else {
                console.warn(`âš ï¸ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);

                // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙƒØ¨Ø¯ÙŠÙ„
                const propertyKey = `${propertyName}_${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;
                if (attachments[propertyKey]) {
                    delete attachments[propertyKey];
                }
            }
        }

        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        for (let i = properties.length - 1; i >= 0; i--) {
            if (properties[i]['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName) {
                properties.splice(i, 1);
            }
        }

        // Ø­Ø°Ù ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† propertyDefinitions
        if (propertyDefinition) {
            const definitionIndex = propertyDefinitions.findIndex(p => p.name === propertyName);
            if (definitionIndex !== -1) {
                propertyDefinitions.splice(definitionIndex, 1);
                localStorage.setItem('propertyDefinitions', JSON.stringify(propertyDefinitions));
                console.log(`âœ… ØªÙ… Ø­Ø°Ù ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" Ù…Ù† propertyDefinitions`);
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        localStorage.setItem('propertyAttachments', JSON.stringify(attachments));
        saveDataLocally();

        // ğŸ”§ Ø¥Ø¶Ø§ÙØ©: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±
        if (typeof saveCitiesLocally === 'function') {
            saveCitiesLocally();
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        initializeApp();

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingModal.remove();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', `ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" ÙˆØ¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§ØªÙ‡ ÙˆÙ…Ø±ÙÙ‚Ø§ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…`);

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        if (document.getElementById('properties-tab')) {
            document.getElementById('properties-tab').innerHTML = renderPropertiesTab();
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingModal.remove();

        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±:', error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±');
    }
}

// ===== ÙˆØ¸ÙŠÙØ© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====
async function testPropertyManagementFunctions() {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    const testResults = {
        addProperty: false,
        editProperty: false,
        deleteProperty: false,
        addUnit: false,
        editUnit: false,
        deleteUnit: false,
        attachments: false,
        search: false,
        supabaseSync: false
    };

    try {
        // Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯
        console.log('ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯...');
        const testProperty = {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'TEST_001',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø±',
            'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ù…ÙˆÙ‚Ø¹ Ø§Ø®ØªØ¨Ø§Ø±',
            'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹': null,
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': '12345',
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': '67890',
            'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': '500',
            'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'Ù…Ø§Ù„Ùƒ Ø§Ø®ØªØ¨Ø§Ø±',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': null,
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': null,
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': null,
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': null,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': null,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': null,
            'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': 0.0,
            'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡': null,
            'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©': null,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': null,
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': null,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': null,
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': null,
            'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·': null,
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
        };

        properties.push(testProperty);
        if (typeof savePropertyToSupabase === 'function') {
            await savePropertyToSupabase(testProperty);
        }
        testResults.addProperty = true;
        console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±');

        // Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±
        console.log('âœï¸ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±...');
        const propertyIndex = properties.findIndex(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === 'TEST_001');
        if (propertyIndex !== -1) {
            properties[propertyIndex]['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = 'Ù…Ø§Ù„Ùƒ Ù…Ø­Ø¯Ø«';
            if (typeof savePropertyToSupabase === 'function') {
                await savePropertyToSupabase(properties[propertyIndex]);
            }
            testResults.editProperty = true;
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø«
        console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø«...');
        const searchResults = properties.filter(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].includes('Ø§Ø®ØªØ¨Ø§Ø±') ||
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].includes('TEST')
        );
        if (searchResults.length > 0) {
            testResults.search = true;
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø«');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
        console.log('â˜ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...');
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('count', { count: 'exact', head: true });

                if (!error) {
                    testResults.supabaseSync = true;
                    console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase');
                }
            } catch (supabaseError) {
                console.log('âš ï¸ Supabase ØºÙŠØ± Ù…ØªÙˆÙØ± Ø£Ùˆ ØºÙŠØ± Ù…ÙƒÙˆÙ†');
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (ØªÙ†Ø¸ÙŠÙ)
        console.log('ğŸ—‘ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±...');
        const deleteIndex = properties.findIndex(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === 'TEST_001');
        if (deleteIndex !== -1) {
            const unitToDelete = properties[deleteIndex];
            if (typeof deletePropertyFromSupabase === 'function') {
                await deletePropertyFromSupabase(unitToDelete);
            }
            properties.splice(deleteIndex, 1);
            testResults.deleteProperty = true;
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±');
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        saveDataLocally();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
    }

    // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    const passedTests = Object.values(testResults).filter(result => result).length;
    const totalTests = Object.keys(testResults).length;

    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:');
    console.log(`âœ… Ù†Ø¬Ø­: ${passedTests}/${totalTests} Ø§Ø®ØªØ¨Ø§Ø±`);
    console.log('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', testResults);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const testModal = document.createElement('div');
    testModal.className = 'modal-overlay';
    testModal.style.display = 'flex';
    testModal.innerHTML = `
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #28a745; margin: 0;">
                    <i class="fas fa-check-circle"></i> Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
                </h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #155724; font-weight: 600; text-align: center;">
                        Ù†Ø¬Ø­ ${passedTests} Ù…Ù† ${totalTests} Ø§Ø®ØªØ¨Ø§Ø±
                    </p>
                </div>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <h4 style="margin: 0 0 10px 0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:</h4>
                    <ul style="margin: 0; padding-right: 20px;">
                        <li style="color: ${testResults.addProperty ? '#28a745' : '#dc3545'}">
                            ${testResults.addProperty ? 'âœ…' : 'âŒ'} Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                        </li>
                        <li style="color: ${testResults.editProperty ? '#28a745' : '#dc3545'}">
                            ${testResults.editProperty ? 'âœ…' : 'âŒ'} ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                        </li>
                        <li style="color: ${testResults.deleteProperty ? '#28a745' : '#dc3545'}">
                            ${testResults.deleteProperty ? 'âœ…' : 'âŒ'} Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                        </li>
                        <li style="color: ${testResults.search ? '#28a745' : '#dc3545'}">
                            ${testResults.search ? 'âœ…' : 'âŒ'} Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
                        </li>
                        <li style="color: ${testResults.supabaseSync ? '#28a745' : '#dc3545'}">
                            ${testResults.supabaseSync ? 'âœ…' : 'âŒ'} Ø§Ù„ØªØ²Ø§Ù…Ù† Ù…Ø¹ Supabase
                        </li>
                    </ul>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-action-btn print-btn" onclick="closeModal()"
                        style="background: #28a745; border-color: #28a745;">
                    <i class="fas fa-check"></i> Ù…ÙˆØ§ÙÙ‚
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(testModal);

    return testResults;
}

// ===== ÙˆØ¸ÙŠÙØ© ØªØ¨Ø¯ÙŠÙ„ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶ =====
function toggleSortOrder() {
    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
    isReverseOrder = !isReverseOrder;

    // ØªØ­Ø¯ÙŠØ« Ù†Øµ ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²Ø±
    const sortBtn = document.getElementById('sort-order-btn');
    if (sortBtn) {
        if (isReverseOrder) {
            sortBtn.innerHTML = '<i class="fas fa-sort-amount-down"></i> Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹';
            sortBtn.title = 'ØªØ±ØªÙŠØ¨ Ø¹ÙƒØ³ÙŠ - Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹';
        } else {
            sortBtn.innerHTML = '<i class="fas fa-sort-amount-up"></i> Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹';
            sortBtn.title = 'ØªØ±ØªÙŠØ¨ Ø·Ø¨ÙŠØ¹ÙŠ - Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹';
        }
    }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    renderData();

    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    localStorage.setItem('sortOrder', isReverseOrder ? 'reverse' : 'normal');

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    const message = isReverseOrder ? 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¥Ù„Ù‰: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹' : 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¥Ù„Ù‰: Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹';
    showToast(message, 'success');
}

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
function loadSortOrderSetting() {
    const savedOrder = localStorage.getItem('sortOrder');
    if (savedOrder) {
        isReverseOrder = savedOrder === 'reverse';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸
        const sortBtn = document.getElementById('sort-order-btn');
        if (sortBtn) {
            if (isReverseOrder) {
                sortBtn.innerHTML = '<i class="fas fa-sort-amount-down"></i> Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹';
                sortBtn.title = 'ØªØ±ØªÙŠØ¨ Ø¹ÙƒØ³ÙŠ - Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹';
            } else {
                sortBtn.innerHTML = '<i class="fas fa-sort-amount-up"></i> Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹';
                sortBtn.title = 'ØªØ±ØªÙŠØ¨ Ø·Ø¨ÙŠØ¹ÙŠ - Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹';
            }
        }
    }
}

// ===== Advanced Database Diagnostics Tool =====
async function debugDatabaseSync() {
    console.log('ğŸ” Starting comprehensive database diagnostics...');

    if (!supabaseClient) {
        console.error('âŒ Supabase client not available');
        showToast('Supabase ØºÙŠØ± Ù…ØªØµÙ„ - Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´Ø®ÙŠØµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        return;
    }

    try {
        // Show loading indicator
        const diagnosticsModal = document.createElement('div');
        diagnosticsModal.className = 'modal-overlay';
        diagnosticsModal.style.display = 'flex';
        diagnosticsModal.innerHTML = `
            <div class="modal-box" style="max-width: 90vw; max-height: 90vh; overflow-y: auto;">
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-cog fa-spin" style="font-size: 2rem; color: #3b82f6; margin-bottom: 20px;"></i>
                    <h3>Running Database Diagnostics...</h3>
                    <div id="diagnostics-content">
                        <p>Analyzing database structure and content...</p>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
            </div>
        `;
        document.body.appendChild(diagnosticsModal);

        const contentDiv = diagnosticsModal.querySelector('#diagnostics-content');

        // Step 1: Test connection
        contentDiv.innerHTML += '<p>âœ… Testing Supabase connection...</p>';
        const { data: connectionTest, error: connectionError } = await supabaseClient
            .from('properties')
            .select('count', { count: 'exact', head: true });

        if (connectionError) {
            throw new Error(`Connection failed: ${connectionError.message}`);
        }

        // Step 2: Get database schema
        contentDiv.innerHTML += '<p>âœ… Fetching database schema...</p>';
        const { data: schemaData, error: schemaError } = await supabaseClient
            .from('properties')
            .select('*')
            .limit(1);

        if (schemaError) {
            throw new Error(`Schema fetch failed: ${schemaError.message}`);
        }

        const dbFields = schemaData.length > 0 ? Object.keys(schemaData[0]) : [];
        console.log('ğŸ“Š Database schema fields:', dbFields);

        // Step 3: Get all properties from database
        contentDiv.innerHTML += '<p>âœ… Fetching all database records...</p>';
        const { data: allDbProperties, error: fetchError } = await supabaseClient
            .from('properties')
            .select('*')
            .order('id', { ascending: false });

        if (fetchError) {
            throw new Error(`Data fetch failed: ${fetchError.message}`);
        }

        // Step 4: Analyze local vs database data
        contentDiv.innerHTML += '<p>âœ… Analyzing data synchronization...</p>';

        const localCount = properties.length;
        const dbCount = allDbProperties.length;

        // Find potential matches and mismatches
        const localUnits = new Set(properties.map(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']));
        const dbUnits = new Set(allDbProperties.map(p => p.unit_number));

        const onlyLocal = [...localUnits].filter(unit => !dbUnits.has(unit));
        const onlyDb = [...dbUnits].filter(unit => !localUnits.has(unit));
        const inBoth = [...localUnits].filter(unit => dbUnits.has(unit));

        // Generate comprehensive report
        const report = `
            <div style="text-align: left; font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 10px 0;">
                <h4>ğŸ” Database Diagnostics Report</h4>

                <h5>ğŸ“Š Data Counts:</h5>
                <ul>
                    <li>Local properties: ${localCount}</li>
                    <li>Database properties: ${dbCount}</li>
                    <li>Difference: ${Math.abs(localCount - dbCount)}</li>
                </ul>

                <h5>ğŸ—ï¸ Database Schema:</h5>
                <ul>
                    ${dbFields.map(field => `<li>${field}</li>`).join('')}
                </ul>

                <h5>ğŸ”„ Synchronization Analysis:</h5>
                <ul>
                    <li>Units in both local and database: ${inBoth.length}</li>
                    <li>Units only in local: ${onlyLocal.length}</li>
                    <li>Units only in database: ${onlyDb.length}</li>
                </ul>

                ${onlyLocal.length > 0 ? `
                <h5>âš ï¸ Units only in local storage:</h5>
                <ul>
                    ${onlyLocal.slice(0, 10).map(unit => `<li>${unit}</li>`).join('')}
                    ${onlyLocal.length > 10 ? `<li>... and ${onlyLocal.length - 10} more</li>` : ''}
                </ul>
                ` : ''}

                ${onlyDb.length > 0 ? `
                <h5>âš ï¸ Units only in database:</h5>
                <ul>
                    ${onlyDb.slice(0, 10).map(unit => `<li>${unit}</li>`).join('')}
                    ${onlyDb.length > 10 ? `<li>... and ${onlyDb.length - 10} more</li>` : ''}
                </ul>
                ` : ''}

                <h5>ğŸ“‹ Sample Database Records:</h5>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <tr style="background: #ddd;">
                        <th style="border: 1px solid #ccc; padding: 5px;">ID</th>
                        <th style="border: 1px solid #ccc; padding: 5px;">Unit Number</th>
                        <th style="border: 1px solid #ccc; padding: 5px;">Property Name</th>
                        <th style="border: 1px solid #ccc; padding: 5px;">City</th>
                    </tr>
                    ${allDbProperties.slice(0, 10).map(prop => `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 5px;">${prop.id}</td>
                            <td style="border: 1px solid #ccc; padding: 5px;">${prop.unit_number || 'N/A'}</td>
                            <td style="border: 1px solid #ccc; padding: 5px;">${prop.property_name || 'N/A'}</td>
                            <td style="border: 1px solid #ccc; padding: 5px;">${prop.city || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </table>

                <h5>ğŸ’¡ Recommendations:</h5>
                <ul>
                    ${localCount !== dbCount ? '<li>Consider using "Reload from Cloud" to sync data</li>' : ''}
                    ${onlyLocal.length > 0 ? '<li>Some local data may need to be uploaded to database</li>' : ''}
                    ${onlyDb.length > 0 ? '<li>Some database records are not in local storage</li>' : ''}
                    <li>Use "Cleanup Database" to remove duplicates</li>
                </ul>
            </div>
        `;

        contentDiv.innerHTML = report;

        // Log detailed information to console
        console.log('ğŸ“Š Diagnostics Summary:', {
            localCount,
            dbCount,
            dbFields,
            synchronization: {
                inBoth: inBoth.length,
                onlyLocal: onlyLocal.length,
                onlyDb: onlyDb.length
            }
        });

        console.log('ğŸ“‹ Sample database records:');
        console.table(allDbProperties.slice(0, 10));

        console.log('ğŸ“‹ Sample local records:');
        console.table(properties.slice(0, 10).map(p => ({
            unit_number: p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            property_name: p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
            city: p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'],
            tenant_name: p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']
        })));

        console.log('ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ØªØ´Ø®ÙŠØµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬');

    } catch (error) {
        console.error('âŒ Error during database diagnostics:', error);

        const errorModal = document.querySelector('.modal-overlay');
        if (errorModal) {
            errorModal.querySelector('#diagnostics-content').innerHTML = `
                <div style="color: red; text-align: center;">
                    <h4>âŒ Diagnostics Failed</h4>
                    <p>Error: ${error.message}</p>
                    <p>Check console for detailed error information</p>
                </div>
            `;
        }

        showToast('ÙØ´Ù„ ÙÙŠ ØªØ´Ø®ÙŠØµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø±Ø§Ø¬Ø¹ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…', 'error');
    }
}

// ===== Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase =====
async function reloadFromSupabase() {
    console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase...');

    if (!supabaseClient) {
        alert('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        return;
    }

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loadingModal = document.createElement('div');
        loadingModal.className = 'modal-overlay';
        loadingModal.style.display = 'flex';
        loadingModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3b82f6; margin-bottom: 20px;"></i>
                <h3>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3>
                <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            </div>
        `;
        document.body.appendChild(loadingModal);

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
        const { data: supabaseProperties, error } = await supabaseClient
            .from('properties')
            .select('*')
            .order('id', { ascending: false });

        if (error) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ
        properties = supabaseProperties.map(convertSupabaseToLocal);

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        initializeApp();

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingModal.remove();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showSuccessMessage(
            'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­',
            `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${supabaseProperties.length} ÙˆØ­Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`
        );

        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${supabaseProperties.length} ÙˆØ­Ø¯Ø© Ù…Ù† Supabase`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loadingModal = document.querySelector('.modal-overlay');
        if (loadingModal) {
            loadingModal.remove();
        }

        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹');
    }
}

// ===== ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
async function cleanupDatabase() {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ§Ù„ÙØ§Ø±ØºØ©.')) {
        return;
    }

    console.log('ğŸ§¹ Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

    if (!supabaseClient) {
        alert('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        return;
    }

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loadingModal = document.createElement('div');
        loadingModal.className = 'modal-overlay';
        loadingModal.style.display = 'flex';
        loadingModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-broom fa-spin" style="font-size: 2rem; color: #e67e22; margin-bottom: 20px;"></i>
                <h3>Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3>
                <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ§Ù„ÙØ§Ø±ØºØ©</p>
            </div>
        `;
        document.body.appendChild(loadingModal);

        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data: allProperties, error } = await supabaseClient
            .from('properties')
            .select('*')
            .order('id', { ascending: true });

        if (error) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
        }

        console.log(`ğŸ“Š ØªÙ… Ø¬Ù„Ø¨ ${allProperties.length} ÙˆØ­Ø¯Ø© Ù„Ù„ØªÙ†Ø¸ÙŠÙ`);

        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        const duplicates = [];
        const seen = new Set();

        allProperties.forEach(property => {
            const key = `${property.unit_number}_${property.property_name}_${property.city}`;
            if (seen.has(key)) {
                duplicates.push(property.id);
            } else {
                seen.add(key);
            }
        });

        console.log(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${duplicates.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©`);

        // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        let deletedCount = 0;
        for (const id of duplicates) {
            try {
                const { error: deleteError } = await supabaseClient
                    .from('properties')
                    .delete()
                    .eq('id', id);

                if (!deleteError) {
                    deletedCount++;
                    console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© ID: ${id}`);
                }
            } catch (deleteError) {
                console.error(`âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${id}:`, deleteError);
            }
        }

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingModal.remove();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        showSuccessMessage(
            'ØªÙ… ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­',
            `ØªÙ… Ø­Ø°Ù ${deletedCount} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ø£ØµÙ„ ${duplicates.length}`
        );

        console.log(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø­Ø°Ù ${deletedCount} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©`);

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await reloadFromSupabase();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loadingModal = document.querySelector('.modal-overlay');
        if (loadingModal) {
            loadingModal.remove();
        }

        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ:', error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹');
    }
}

// ===== Database Sync Verification =====
async function verifyDatabaseSync() {
    console.log('ğŸ” Verifying database synchronization...');

    if (!supabaseClient) {
        showToast('Supabase ØºÙŠØ± Ù…ØªØµÙ„', 'error');
        return false;
    }

    try {
        // Get current database state
        const { data: dbProperties, error } = await supabaseClient
            .from('properties')
            .select('id, unit_number, property_name, city')
            .order('id', { ascending: false });

        if (error) {
            console.error('âŒ Failed to fetch database properties:', error);
            return false;
        }

        // Compare with local data
        const localUnits = new Set(properties.map(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']));
        const dbUnits = new Set(dbProperties.map(p => p.unit_number));

        const syncStatus = {
            localCount: properties.length,
            dbCount: dbProperties.length,
            inSync: localUnits.size === dbUnits.size,
            onlyLocal: [...localUnits].filter(unit => !dbUnits.has(unit)),
            onlyDb: [...dbUnits].filter(unit => !localUnits.has(unit))
        };

        console.log('ğŸ“Š Sync verification result:', syncStatus);

        if (syncStatus.inSync && syncStatus.onlyLocal.length === 0 && syncStatus.onlyDb.length === 0) {
            showToast('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ²Ø§Ù…Ù†Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
            return true;
        } else {
            showToast(`Ø¹Ø¯Ù… ØªØ²Ø§Ù…Ù† ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù…Ø­Ù„ÙŠ: ${syncStatus.localCount}, Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${syncStatus.dbCount}`, 'warning');
            return false;
        }

    } catch (error) {
        console.error('âŒ Error verifying database sync:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ²Ø§Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        return false;
    }
}

// ===== Enhanced Property Deletion with Verification =====
async function deletePropertyWithVerification(unitNumber, propertyName, city) {
    console.log('ğŸ—‘ï¸ Starting verified property deletion...');

    // Step 1: Verify the property exists locally
    const localProperty = properties.find(p =>
        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );

    if (!localProperty) {
        console.error('âŒ Property not found in local data');
        showToast('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'error');
        return false;
    }

    // Step 2: Delete from Supabase first
    let dbDeletionSuccess = false;
    if (typeof deletePropertyFromSupabase === 'function') {
        const result = await deletePropertyFromSupabase(localProperty);
        dbDeletionSuccess = result.success;

        if (dbDeletionSuccess) {
            console.log('âœ… Property deleted from database successfully');
        } else {
            console.warn('âš ï¸ Database deletion failed:', result.reason);
        }
    }

    // Step 3: Delete from local data
    const originalLength = properties.length;
    properties = properties.filter(p =>
        !(p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName)
    );

    const localDeletionSuccess = properties.length < originalLength;

    // Step 4: Save updated local data
    if (localDeletionSuccess) {
        saveDataLocally();
        renderData();
    }

    // Step 5: Verify deletion
    setTimeout(async () => {
        const isInSync = await verifyDatabaseSync();
        if (!isInSync && dbDeletionSuccess) {
            console.log('âš ï¸ Sync verification failed after deletion');
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù ÙˆÙ„ÙƒÙ† Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'warning');
        }
    }, 2000);

    return {
        localSuccess: localDeletionSuccess,
        dbSuccess: dbDeletionSuccess,
        overall: localDeletionSuccess && dbDeletionSuccess
    };
}

// ===== Force Delete Specific Units =====
async function forceDeleteSpecificUnits() {
    const targetUnits = ['TEST_001', 'TEST_UNIT_003', 'TEST_UNIT_001'];

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\n${targetUnits.join('\n')}\n\nØ³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.`)) {
        return;
    }

    console.log('ğŸ—‘ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ø±ÙŠ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:', targetUnits);

    // Show progress modal
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 600px;">
            <i class="fas fa-trash-alt fa-spin" style="font-size: 2rem; color: #e74c3c; margin-bottom: 20px;"></i>
            <h3>Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©...</h3>
            <div id="deletion-progress" style="text-align: left; background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; font-family: monospace;">
                <p>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
        </div>
    `;
    document.body.appendChild(progressModal);

    const progressDiv = progressModal.querySelector('#deletion-progress');
    let deletionResults = [];

    try {
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Step 1: Search for all target units in database
        progressDiv.innerHTML += '<p>ğŸ“‹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';

        const { data: allDbProperties, error: searchError } = await supabaseClient
            .from('properties')
            .select('*');

        if (searchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        progressDiv.innerHTML += `<p>âœ… ØªÙ… Ø¬Ù„Ø¨ ${allDbProperties.length} Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>`;

        // Step 2: Find matching records for each target unit
        for (const targetUnit of targetUnits) {
            progressDiv.innerHTML += `<p>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©: ${targetUnit}</p>`;

            // Search with multiple strategies
            const matchingRecords = allDbProperties.filter(record => {
                return (
                    record.unit_number === targetUnit ||
                    record.property_name === targetUnit ||
                    record.tenant_name === targetUnit ||
                    record.contract_number === targetUnit ||
                    JSON.stringify(record).includes(targetUnit)
                );
            });

            if (matchingRecords.length > 0) {
                progressDiv.innerHTML += `<p style="color: orange;">ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${matchingRecords.length} Ø³Ø¬Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${targetUnit}</p>`;

                // Delete each matching record
                for (const record of matchingRecords) {
                    try {
                        const { error: deleteError } = await supabaseClient
                            .from('properties')
                            .delete()
                            .eq('id', record.id);

                        if (deleteError) {
                            progressDiv.innerHTML += `<p style="color: red;">âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ${record.id}: ${deleteError.message}</p>`;
                            deletionResults.push({ unit: targetUnit, id: record.id, success: false, error: deleteError.message });
                        } else {
                            progressDiv.innerHTML += `<p style="color: green;">âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ${record.id} Ù„Ù„ÙˆØ­Ø¯Ø© ${targetUnit}</p>`;
                            deletionResults.push({ unit: targetUnit, id: record.id, success: true });
                        }
                    } catch (deleteError) {
                        progressDiv.innerHTML += `<p style="color: red;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ${record.id}: ${deleteError.message}</p>`;
                        deletionResults.push({ unit: targetUnit, id: record.id, success: false, error: deleteError.message });
                    }
                }
            } else {
                progressDiv.innerHTML += `<p style="color: gray;">â„¹ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${targetUnit} ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
                deletionResults.push({ unit: targetUnit, id: null, success: false, error: 'Not found in database' });
            }
        }

        // Step 3: Delete from local data
        progressDiv.innerHTML += '<p>ğŸ  Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...</p>';

        const originalLength = properties.length;
        properties = properties.filter(property => {
            const unitNumber = property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
            const propertyName = property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
            const tenantName = property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];

            // Check if this property matches any target unit
            const shouldDelete = targetUnits.some(target =>
                unitNumber === target ||
                propertyName === target ||
                tenantName === target ||
                JSON.stringify(property).includes(target)
            );

            if (shouldDelete) {
                progressDiv.innerHTML += `<p style="color: green;">âœ… ØªÙ… Ø­Ø°Ù ${unitNumber || propertyName} Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</p>`;
            }

            return !shouldDelete;
        });

        const localDeletedCount = originalLength - properties.length;
        progressDiv.innerHTML += `<p style="color: blue;">ğŸ“Š ØªÙ… Ø­Ø°Ù ${localDeletedCount} ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</p>`;

        // Step 4: Save and refresh
        saveDataLocally();
        renderData();

        // Step 5: Show final results
        const successfulDeletions = deletionResults.filter(r => r.success).length;
        const totalAttempts = deletionResults.length;

        progressDiv.innerHTML += `
            <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                <h4 style="color: #27ae60;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</h4>
                <ul style="text-align: right;">
                    <li>Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø°Ù Ù†Ø§Ø¬Ø­Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${successfulDeletions}</li>
                    <li>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${totalAttempts}</li>
                    <li>Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ${localDeletedCount} ÙˆØ­Ø¯Ø©</li>
                </ul>
                <p style="color: #27ae60; font-weight: bold;">âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ø±ÙŠ</p>
            </div>
        `;

        // Auto-close modal after 10 seconds
        setTimeout(() => {
            if (progressModal.parentElement) {
                progressModal.remove();
            }
        }, 10000);

        showToast(`ØªÙ… Ø­Ø°Ù ${successfulDeletions} Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ùˆ ${localDeletedCount} Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ø±ÙŠ:', error);
        progressDiv.innerHTML += `<p style="color: red;">âŒ Ø®Ø·Ø£ Ø®Ø·ÙŠØ±: ${error.message}</p>`;
        showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ø±ÙŠ - Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
    }
}

// ===== Nuclear Delete - Complete Cleanup =====
async function nuclearDeleteAllTestUnits() {
    if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "TEST" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
        return;
    }

    if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "TEST" Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.\n\nØ§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.')) {
        return;
    }

    console.log('ğŸ’¥ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª TEST...');

    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 700px;">
            <i class="fas fa-bomb fa-spin" style="font-size: 2rem; color: #e74c3c; margin-bottom: 20px;"></i>
            <h3 style="color: #e74c3c;">Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ÙˆØ­Ø¯Ø§Øª TEST</h3>
            <div id="nuclear-progress" style="text-align: left; background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; font-family: monospace; max-height: 400px; overflow-y: auto;">
                <p>ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„...</p>
            </div>
        </div>
    `;
    document.body.appendChild(progressModal);

    const progressDiv = progressModal.querySelector('#nuclear-progress');

    try {
        // Step 1: Delete from Supabase
        if (supabaseClient) {
            progressDiv.innerHTML += '<p>â˜ï¸ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';

            // Get all records
            const { data: allRecords, error: fetchError } = await supabaseClient
                .from('properties')
                .select('*');

            if (fetchError) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${fetchError.message}`);
            }

            progressDiv.innerHTML += `<p>ğŸ“‹ ØªÙ… Ø¬Ù„Ø¨ ${allRecords.length} Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>`;

            // Find all TEST-related records
            const testRecords = allRecords.filter(record => {
                const recordString = JSON.stringify(record).toLowerCase();
                return recordString.includes('test');
            });

            progressDiv.innerHTML += `<p style="color: orange;">ğŸ¯ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${testRecords.length} Ø³Ø¬Ù„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "TEST"</p>`;

            // Delete each TEST record
            let deletedFromDb = 0;
            for (const record of testRecords) {
                try {
                    const { error: deleteError } = await supabaseClient
                        .from('properties')
                        .delete()
                        .eq('id', record.id);

                    if (!deleteError) {
                        deletedFromDb++;
                        progressDiv.innerHTML += `<p style="color: green;">âœ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ${record.id}: ${record.unit_number || record.property_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>`;
                    } else {
                        progressDiv.innerHTML += `<p style="color: red;">âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ${record.id}: ${deleteError.message}</p>`;
                    }
                } catch (error) {
                    progressDiv.innerHTML += `<p style="color: red;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ${record.id}: ${error.message}</p>`;
                }
            }

            progressDiv.innerHTML += `<p style="color: blue;">ğŸ“Š ØªÙ… Ø­Ø°Ù ${deletedFromDb} Ù…Ù† Ø£ØµÙ„ ${testRecords.length} Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
        }

        // Step 2: Delete from local data
        progressDiv.innerHTML += '<p>ğŸ  ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...</p>';

        const originalLength = properties.length;
        properties = properties.filter(property => {
            const propertyString = JSON.stringify(property).toLowerCase();
            const containsTest = propertyString.includes('test');

            if (containsTest) {
                progressDiv.innerHTML += `<p style="color: green;">âœ… Ø­Ø°Ù Ù…Ø­Ù„ÙŠ: ${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>`;
            }

            return !containsTest;
        });

        const localDeleted = originalLength - properties.length;
        progressDiv.innerHTML += `<p style="color: blue;">ğŸ“Š ØªÙ… Ø­Ø°Ù ${localDeleted} ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</p>`;

        // Step 3: Clean localStorage
        progressDiv.innerHTML += '<p>ğŸ’¾ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ...</p>';
        saveDataLocally();

        // Step 4: Refresh interface
        progressDiv.innerHTML += '<p>ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...</p>';
        renderData();

        // Step 5: Final verification
        progressDiv.innerHTML += '<p>ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...</p>';

        setTimeout(async () => {
            if (supabaseClient) {
                const { data: remainingRecords } = await supabaseClient
                    .from('properties')
                    .select('*');

                const remainingTestRecords = remainingRecords?.filter(record =>
                    JSON.stringify(record).toLowerCase().includes('test')
                ) || [];

                progressDiv.innerHTML += `<p style="color: ${remainingTestRecords.length === 0 ? 'green' : 'orange'};">ğŸ” Ø³Ø¬Ù„Ø§Øª TEST Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${remainingTestRecords.length}</p>`;
            }

            const localTestRecords = properties.filter(property =>
                JSON.stringify(property).toLowerCase().includes('test')
            );

            progressDiv.innerHTML += `<p style="color: ${localTestRecords.length === 0 ? 'green' : 'orange'};">ğŸ” Ø³Ø¬Ù„Ø§Øª TEST Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹: ${localTestRecords.length}</p>`;

            progressDiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <h4 style="color: #27ae60;">ğŸ’¥ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„!</h4>
                    <p style="color: #27ae60; font-weight: bold;">ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª TEST Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                    <button onclick="location.reload()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                        Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„ØªØ£ÙƒØ¯
                    </button>
                </div>
            `;

            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª TEST Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }, 2000);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„:', error);
        progressDiv.innerHTML += `<p style="color: red;">âŒ Ø®Ø·Ø£ Ø®Ø·ÙŠØ±: ${error.message}</p>`;
        showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„', 'error');
    }
}

// ===== Advanced Delete with Foreign Key Handling =====
async function advancedDeleteWithForeignKeys() {
    if (!confirm('âš ï¸ Ø­Ø°Ù Ù…ØªÙ‚Ø¯Ù…: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©!\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ properties\n- Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ activity_log\n- Ø£ÙŠ Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø±ØªØ¨Ø·Ø©\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
        return;
    }

    console.log('ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Foreign Keys...');

    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 800px;">
            <i class="fas fa-cogs fa-spin" style="font-size: 2rem; color: #3498db; margin-bottom: 20px;"></i>
            <h3 style="color: #3498db;">Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</h3>
            <div id="advanced-progress" style="text-align: left; background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; font-family: monospace; max-height: 500px; overflow-y: auto;">
                <p>ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...</p>
            </div>
        </div>
    `;
    document.body.appendChild(progressModal);

    const progressDiv = progressModal.querySelector('#advanced-progress');

    try {
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Step 1: Find all TEST records
        progressDiv.innerHTML += '<p>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª TEST...</p>';

        const { data: allRecords, error: fetchError } = await supabaseClient
            .from('properties')
            .select('*');

        if (fetchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${fetchError.message}`);
        }

        const testRecords = allRecords.filter(record => {
            const recordString = JSON.stringify(record).toLowerCase();
            return recordString.includes('test');
        });

        progressDiv.innerHTML += `<p style="color: orange;">ğŸ¯ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${testRecords.length} Ø³Ø¬Ù„ TEST</p>`;

        // Step 2: Delete related activity_log records first
        progressDiv.innerHTML += '<p>ğŸ—‚ï¸ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ù…Ù† activity_log...</p>';

        let deletedActivityLogs = 0;
        for (const record of testRecords) {
            try {
                const { data: activityLogs, error: activityError } = await supabaseClient
                    .from('activity_log')
                    .select('id')
                    .eq('property_id', record.id);

                if (!activityError && activityLogs && activityLogs.length > 0) {
                    progressDiv.innerHTML += `<p>ğŸ“‹ ÙˆØ¬Ø¯ ${activityLogs.length} Ø³Ø¬Ù„ Ù†Ø´Ø§Ø· Ù„Ù„ÙˆØ­Ø¯Ø© ${record.id}</p>`;

                    const { error: deleteActivityError } = await supabaseClient
                        .from('activity_log')
                        .delete()
                        .eq('property_id', record.id);

                    if (!deleteActivityError) {
                        deletedActivityLogs += activityLogs.length;
                        progressDiv.innerHTML += `<p style="color: green;">âœ… ØªÙ… Ø­Ø°Ù ${activityLogs.length} Ø³Ø¬Ù„ Ù†Ø´Ø§Ø· Ù„Ù„ÙˆØ­Ø¯Ø© ${record.id}</p>`;
                    } else {
                        progressDiv.innerHTML += `<p style="color: red;">âŒ ÙØ´Ù„ Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„ÙˆØ­Ø¯Ø© ${record.id}: ${deleteActivityError.message}</p>`;
                    }
                }
            } catch (error) {
                progressDiv.innerHTML += `<p style="color: red;">âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„ÙˆØ­Ø¯Ø© ${record.id}: ${error.message}</p>`;
            }
        }

        progressDiv.innerHTML += `<p style="color: blue;">ğŸ“Š ØªÙ… Ø­Ø°Ù ${deletedActivityLogs} Ø³Ø¬Ù„ Ù†Ø´Ø§Ø· Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>`;

        // Step 3: Delete related attachments
        progressDiv.innerHTML += '<p>ğŸ“ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©...</p>';

        let deletedAttachments = 0;
        for (const record of testRecords) {
            try {
                const { data: attachments, error: attachmentError } = await supabaseClient
                    .from('attachments')
                    .select('id')
                    .eq('property_id', record.id);

                if (!attachmentError && attachments && attachments.length > 0) {
                    progressDiv.innerHTML += `<p>ğŸ“ ÙˆØ¬Ø¯ ${attachments.length} Ù…Ø±ÙÙ‚ Ù„Ù„ÙˆØ­Ø¯Ø© ${record.id}</p>`;

                    const { error: deleteAttachmentError } = await supabaseClient
                        .from('attachments')
                        .delete()
                        .eq('property_id', record.id);

                    if (!deleteAttachmentError) {
                        deletedAttachments += attachments.length;
                        progressDiv.innerHTML += `<p style="color: green;">âœ… ØªÙ… Ø­Ø°Ù ${attachments.length} Ù…Ø±ÙÙ‚ Ù„Ù„ÙˆØ­Ø¯Ø© ${record.id}</p>`;
                    } else {
                        progressDiv.innerHTML += `<p style="color: red;">âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„ÙˆØ­Ø¯Ø© ${record.id}: ${deleteAttachmentError.message}</p>`;
                    }
                }
            } catch (error) {
                progressDiv.innerHTML += `<p style="color: orange;">âš ï¸ ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„ÙˆØ­Ø¯Ø© ${record.id}: ${error.message}</p>`;
            }
        }

        progressDiv.innerHTML += `<p style="color: blue;">ğŸ“Š ØªÙ… Ø­Ø°Ù ${deletedAttachments} Ù…Ø±ÙÙ‚ Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>`;

        // Step 4: Now delete the main property records
        progressDiv.innerHTML += '<p>ğŸ  Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...</p>';

        let deletedProperties = 0;
        for (const record of testRecords) {
            try {
                const { error: deleteError } = await supabaseClient
                    .from('properties')
                    .delete()
                    .eq('id', record.id);

                if (!deleteError) {
                    deletedProperties++;
                    progressDiv.innerHTML += `<p style="color: green;">âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${record.unit_number || record.property_name || record.id}</p>`;
                } else {
                    progressDiv.innerHTML += `<p style="color: red;">âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${record.id}: ${deleteError.message}</p>`;
                }
            } catch (error) {
                progressDiv.innerHTML += `<p style="color: red;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${record.id}: ${error.message}</p>`;
            }
        }

        progressDiv.innerHTML += `<p style="color: blue;">ğŸ“Š ØªÙ… Ø­Ø°Ù ${deletedProperties} Ù…Ù† Ø£ØµÙ„ ${testRecords.length} ÙˆØ­Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>`;

        // Step 5: Clean local data
        progressDiv.innerHTML += '<p>ğŸ  ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...</p>';

        const originalLength = properties.length;
        properties = properties.filter(property => {
            const propertyString = JSON.stringify(property).toLowerCase();
            const containsTest = propertyString.includes('test');

            if (containsTest) {
                progressDiv.innerHTML += `<p style="color: green;">âœ… Ø­Ø°Ù Ù…Ø­Ù„ÙŠ: ${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>`;
            }

            return !containsTest;
        });

        const localDeleted = originalLength - properties.length;
        progressDiv.innerHTML += `<p style="color: blue;">ğŸ“Š ØªÙ… Ø­Ø°Ù ${localDeleted} ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</p>`;

        // Step 6: Save and refresh
        saveDataLocally();
        renderData();

        // Step 7: Final verification
        progressDiv.innerHTML += '<p>ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...</p>';

        setTimeout(async () => {
            const { data: remainingRecords } = await supabaseClient
                .from('properties')
                .select('*');

            const remainingTestRecords = remainingRecords?.filter(record =>
                JSON.stringify(record).toLowerCase().includes('test')
            ) || [];

            progressDiv.innerHTML += `<p style="color: ${remainingTestRecords.length === 0 ? 'green' : 'orange'};">ğŸ” Ø³Ø¬Ù„Ø§Øª TEST Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${remainingTestRecords.length}</p>`;

            const localTestRecords = properties.filter(property =>
                JSON.stringify(property).toLowerCase().includes('test')
            );

            progressDiv.innerHTML += `<p style="color: ${localTestRecords.length === 0 ? 'green' : 'orange'};">ğŸ” Ø³Ø¬Ù„Ø§Øª TEST Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹: ${localTestRecords.length}</p>`;

            progressDiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <h4 style="color: #27ae60;">ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…!</h4>
                    <ul style="text-align: right; color: #27ae60;">
                        <li>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: ${deletedActivityLogs}</li>
                        <li>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: ${deletedAttachments}</li>
                        <li>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${deletedProperties}</li>
                        <li>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹: ${localDeleted}</li>
                    </ul>
                    <button onclick="location.reload()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                        Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                    </button>
                </div>
            `;

            if (remainingTestRecords.length === 0) {
                showToast('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª TEST Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!', 'success');
            } else {
                showToast(`ØªÙ… Ø­Ø°Ù Ù…Ø¹Ø¸Ù… Ø§Ù„ÙˆØ­Ø¯Ø§Øª - ${remainingTestRecords.length} ÙˆØ­Ø¯Ø© Ù…ØªØ¨Ù‚ÙŠØ©`, 'warning');
            }
        }, 2000);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:', error);
        progressDiv.innerHTML += `<p style="color: red;">âŒ Ø®Ø·Ø£ Ø®Ø·ÙŠØ±: ${error.message}</p>`;
        showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…', 'error');
    }
}

// ===== Universal Advanced Delete Function =====
async function universalAdvancedDelete(propertyData, showProgress = false) {
    console.log('ğŸ”§ Starting universal advanced delete...');

    if (!supabaseClient) {
        console.warn('âš ï¸ Supabase not available for advanced delete');
        return { success: false, reason: 'NO_CLIENT' };
    }

    try {
        let progressCallback = null;

        if (showProgress) {
            progressCallback = (message, type = 'info') => {
                console.log(`ğŸ“‹ ${message}`);
                showToast(message, type);
            };
        }

        // Step 1: Find the property in database
        if (progressCallback) progressCallback('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

        const unitNumber = propertyData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
        const propertyName = propertyData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†:', { unitNumber, propertyName });

        const { data: foundProperties, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName);

        if (searchError) {
            console.error('âŒ Search error:', searchError);
            return { success: false, reason: 'SEARCH_ERROR', error: searchError.message };
        }

        if (!foundProperties || foundProperties.length === 0) {
            console.log('â„¹ï¸ Property not found in database - trying alternative search...');

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø­Ø« Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… LIKE
            const { data: altFoundProperties, error: altSearchError } = await supabaseClient
                .from('properties')
                .select('*')
                .or(`unit_number.ilike.%${unitNumber}%,property_name.ilike.%${propertyName}%`);

            if (altSearchError || !altFoundProperties || altFoundProperties.length === 0) {
                console.log('â„¹ï¸ Property not found in database with alternative search');
                return { success: false, reason: 'NOT_FOUND' };
            }

            foundProperties = altFoundProperties;
            console.log(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${foundProperties.length} Ù†ØªÙŠØ¬Ø© Ø¨Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¨Ø¯ÙŠÙ„`);
        }

        const property = foundProperties[0];
        if (progressCallback) progressCallback(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©: ${property.id}`);

        // Step 2: Delete related activity logs
        if (progressCallback) progressCallback('Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©...');

        const { data: activityLogs, error: activityError } = await supabaseClient
            .from('activity_log')
            .select('id')
            .eq('property_id', property.id);

        if (!activityError && activityLogs && activityLogs.length > 0) {
            const { error: deleteActivityError } = await supabaseClient
                .from('activity_log')
                .delete()
                .eq('property_id', property.id);

            if (!deleteActivityError) {
                if (progressCallback) progressCallback(`ØªÙ… Ø­Ø°Ù ${activityLogs.length} Ø³Ø¬Ù„ Ù†Ø´Ø§Ø·`);
            } else {
                console.warn('âš ï¸ Failed to delete activity logs:', deleteActivityError);
            }
        }

        // Step 3: Delete related attachments
        if (progressCallback) progressCallback('Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©...');

        try {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©
            let attachments = [];

            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ property_id
            const { data: attachmentsByPropertyId, error: attachmentError1 } = await supabaseClient
                .from('attachments')
                .select('id, storage_path')
                .eq('property_id', property.id);

            if (!attachmentError1 && attachmentsByPropertyId) {
                attachments = [...attachments, ...attachmentsByPropertyId];
            }

            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ property_key
            const propertyKey = `${propertyName}_${unitNumber}`;
            const { data: attachmentsByKey, error: attachmentError2 } = await supabaseClient
                .from('attachments')
                .select('id, storage_path')
                .eq('property_key', propertyKey);

            if (!attachmentError2 && attachmentsByKey) {
                attachments = [...attachments, ...attachmentsByKey];
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª
            const uniqueAttachments = attachments.filter((attachment, index, self) =>
                index === self.findIndex(a => a.id === attachment.id)
            );

            if (uniqueAttachments.length > 0) {
                // Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹
                for (const attachment of uniqueAttachments) {
                    if (attachment.storage_path) {
                        try {
                            await supabaseClient.storage
                                .from('attachments')
                                .remove([attachment.storage_path]);
                        } catch (storageError) {
                            console.warn('âš ï¸ Failed to delete file from storage:', storageError);
                        }
                    }
                }

                // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const attachmentIds = uniqueAttachments.map(a => a.id);
                const { error: deleteAttachmentError } = await supabaseClient
                    .from('attachments')
                    .delete()
                    .in('id', attachmentIds);

                if (!deleteAttachmentError) {
                    if (progressCallback) progressCallback(`ØªÙ… Ø­Ø°Ù ${uniqueAttachments.length} Ù…Ø±ÙÙ‚`);
                } else {
                    console.warn('âš ï¸ Failed to delete attachments:', deleteAttachmentError);
                }
            }
        } catch (attachmentError) {
            console.warn('âš ï¸ Error handling attachments:', attachmentError);
        }

        // Step 4: Delete the main property record
        if (progressCallback) progressCallback('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...');

        const { error: deleteError } = await supabaseClient
            .from('properties')
            .delete()
            .eq('id', property.id);

        if (deleteError) {
            console.error('âŒ Failed to delete property:', deleteError);
            return {
                success: false,
                reason: 'DELETE_ERROR',
                error: deleteError.message,
                propertyId: property.id
            };
        }

        if (progressCallback) progressCallback('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');

        return {
            success: true,
            deletedCount: 1,
            propertyId: property.id,
            message: 'Property and all related data deleted successfully'
        };

    } catch (error) {
        console.error('âŒ Critical error in universal advanced delete:', error);
        return {
            success: false,
            reason: 'CRITICAL_ERROR',
            error: error.message
        };
    }
}

// ===== Enhanced Delete Unit Function =====
async function enhancedDeleteUnit(unitData) {
    console.log('ğŸ—‘ï¸ Starting enhanced unit deletion...');

    // Show progress to user
    showToast('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©...', 'info');

    try {
        // Use universal advanced delete
        const result = await universalAdvancedDelete(unitData, true);

        if (result.success) {
            // Remove from local data
            const originalLength = properties.length;
            properties = properties.filter(p =>
                !(p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] &&
                  p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
            );

            const localDeleted = originalLength - properties.length;

            if (localDeleted > 0) {
                // Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹
                const propertyKey = `${unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;

                // Ø­Ø°Ù Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                const propertyAttachments = JSON.parse(localStorage.getItem('propertyAttachments') || '{}');
                if (propertyAttachments[propertyKey]) {
                    delete propertyAttachments[propertyKey];
                    localStorage.setItem('propertyAttachments', JSON.stringify(propertyAttachments));
                    console.log('âœ… ØªÙ… Ø­Ø°Ù Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                }

                // Ø­Ø°Ù Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                const cardAttachments = JSON.parse(localStorage.getItem('cardAttachments') || '{}');
                if (cardAttachments[propertyKey]) {
                    delete cardAttachments[propertyKey];
                    localStorage.setItem('cardAttachments', JSON.stringify(cardAttachments));
                    console.log('âœ… ØªÙ… Ø­Ø°Ù Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                }

                saveDataLocally();
                renderData();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…', 'success');
            }

            return { success: true, localDeleted, cloudDeleted: 1 };
        } else {
            // Handle failure
            let message = 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';

            if (result.reason === 'NOT_FOUND') {
                message = 'Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·';

                // Still delete locally
                const originalLength = properties.length;
                properties = properties.filter(p =>
                    !(p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] &&
                      p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
                );

                const localDeleted = originalLength - properties.length;

                if (localDeleted > 0) {
                    saveDataLocally();
                    renderData();
                }

                showToast(message, 'warning');
                return { success: true, localDeleted, cloudDeleted: 0 };
            }

            showToast(message, 'error');
            return { success: false, error: result.error };
        }

    } catch (error) {
        console.error('âŒ Error in enhanced delete unit:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©', 'error');
        return { success: false, error: error.message };
    }
}

// ===== Show Deed Information for Selected Property in Mobile =====
function showDeedInfoForProperty(propertyName, city) {
    console.log(`ğŸ“‹ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù„Ù„Ø¹Ù‚Ø§Ø±: ${propertyName} ÙÙŠ ${city}`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    const relatedProperties = properties.filter(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === city
    );

    if (relatedProperties.length === 0) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯');
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù…Ù† Ø£ÙˆÙ„ ÙˆØ­Ø¯Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const propertyWithDeed = relatedProperties.find(p =>
        p['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || p['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || p['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ']
    );

    if (!propertyWithDeed) {
        console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµÙƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ
    const deedModal = document.createElement('div');
    deedModal.className = 'modal-overlay';
    deedModal.style.display = 'flex';
    deedModal.innerHTML = `
        <div class="modal-box deed-info-modal" style="max-width: ${isMobileDevice() ? '95vw' : '600px'}; padding: 30px;">
            <div class="deed-header" style="text-align: center; margin-bottom: 25px;">
                <i class="fas fa-file-contract" style="font-size: 3rem; color: #007bff; margin-bottom: 15px;"></i>
                <h2 style="color: #2c3e50; margin: 0;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ</h2>
                <p style="color: #6c757d; margin: 10px 0 0 0;">${propertyName} - ${city}</p>
            </div>

            <div class="deed-details" style="background: #f8f9fa; border-radius: 12px; padding: 20px;">
                ${propertyWithDeed['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] ? `
                <div class="deed-item" style="display: flex; align-items: center; margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="deed-icon" style="margin-left: 15px;">
                        <i class="fas fa-file-alt" style="font-size: 1.5rem; color: #dc3545;"></i>
                    </div>
                    <div class="deed-content" style="flex: 1;">
                        <div class="deed-label" style="font-weight: 600; color: #495057; margin-bottom: 5px;">Ø±Ù‚Ù… Ø§Ù„ØµÙƒ</div>
                        <div class="deed-value" style="font-size: 1.1rem; color: #2c3e50;">${propertyWithDeed['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ']}</div>
                    </div>
                </div>
                ` : ''}

                ${propertyWithDeed['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] ? `
                <div class="deed-item" style="display: flex; align-items: center; margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="deed-icon" style="margin-left: 15px;">
                        <i class="fas fa-clipboard-list" style="font-size: 1.5rem; color: #28a745;"></i>
                    </div>
                    <div class="deed-content" style="flex: 1;">
                        <div class="deed-label" style="font-weight: 600; color: #495057; margin-bottom: 5px;">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</div>
                        <div class="deed-value" style="font-size: 1.1rem; color: #2c3e50;">${propertyWithDeed['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ']}</div>
                    </div>
                </div>
                ` : ''}

                ${propertyWithDeed['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] ? `
                <div class="deed-item" style="display: flex; align-items: center; margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="deed-icon" style="margin-left: 15px;">
                        <i class="fas fa-ruler-combined" style="font-size: 1.5rem; color: #fd7e14;"></i>
                    </div>
                    <div class="deed-content" style="flex: 1;">
                        <div class="deed-label" style="font-weight: 600; color: #495057; margin-bottom: 5px;">Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ</div>
                        <div class="deed-value" style="font-size: 1.1rem; color: #2c3e50;">${parseFloat(propertyWithDeed['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']).toLocaleString()} Ù…Â²</div>
                    </div>
                </div>
                ` : ''}
            </div>

            <div class="deed-actions" style="text-align: center; margin-top: 25px;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()"
                        class="btn-primary"
                        style="padding: 12px 30px; font-size: 1.1rem; border-radius: 8px; background: linear-gradient(135deg, #007bff, #0056b3); border: none; color: white; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(deedModal);

    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©
    deedModal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.remove();
        }
    });

    console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ');
}

// ===== Mobile Device Detection =====
function isMobileDevice() {
    // Check multiple indicators for mobile devices
    const userAgent = navigator.userAgent || (navigator.vendor || '') || (window.opera || '');

    // Check for mobile user agents
    const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;
    const isMobileUA = mobileRegex.test(userAgent.toLowerCase());

    // Check screen size
    const isSmallScreen = window.innerWidth <= 768;

    // Check touch capability
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // Return true if any mobile indicator is present
    return isMobileUA || (isSmallScreen && isTouchDevice);
}

// ===== Enhanced Attachment Display for Mobile =====
function enhanceAttachmentDisplayForMobile() {
    console.log('ğŸ“± Ø¨Ø¯Ø¡ ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„...');

    // Force show all attachment elements with enhanced selectors
    const attachmentElements = document.querySelectorAll(`
        .attachments-list,
        .attachments-list-container,
        .card-attachments-list,
        .attachment-item,
        .mobile-enhanced-item,
        .desktop-enhanced-item,
        [id*="cardAttachmentsList"],
        [id*="attachmentsList"],
        [class*="attachment"],
        [class*="card-modal"]
    `);

    let enhancedCount = 0;

    attachmentElements.forEach(element => {
        // Force visibility
        element.style.display = element.classList.contains('attachment-item') ||
                                element.classList.contains('mobile-enhanced-item') ||
                                element.classList.contains('desktop-enhanced-item') ? 'flex' : 'block';
        element.style.visibility = 'visible';
        element.style.opacity = '1';
        element.style.position = 'relative';
        element.style.zIndex = 'auto';

        // Add mobile-specific classes and styles
        if (isMobileDevice()) {
            element.classList.add('mobile-optimized');

            // Enhanced mobile styles for attachment items
            if (element.classList.contains('attachment-item') ||
                element.classList.contains('mobile-enhanced-item')) {
                element.style.padding = '15px 10px';
                element.style.marginBottom = '10px';
                element.style.borderRadius = '8px';
                element.style.background = '#f8f9fa';
                element.style.border = '1px solid #e9ecef';
                element.style.transition = 'all 0.3s ease';
            }

            // Enhanced mobile styles for containers
            if (element.classList.contains('attachments-list-container')) {
                element.style.minHeight = '200px';
                element.style.maxHeight = '60vh';
                element.style.overflowY = 'auto';
                element.style.padding = '10px';
            }
        }

        enhancedCount++;
    });

    // Ensure attachment items use proper flex layout
    const attachmentItems = document.querySelectorAll('.attachment-item, .mobile-enhanced-item, .desktop-enhanced-item');
    attachmentItems.forEach(item => {
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.visibility = 'visible';
        item.style.opacity = '1';
        item.style.position = 'relative';

        // Enhanced mobile layout
        if (isMobileDevice()) {
            item.style.flexDirection = 'row';
            item.style.gap = '10px';
            item.style.padding = '15px 10px';
        }
    });

    // Force show loading and error states
    const loadingElements = document.querySelectorAll('.loading-attachments, .loading-state, .error-loading-attachments');
    loadingElements.forEach(element => {
        element.style.display = 'flex';
        element.style.visibility = 'visible';
        element.style.opacity = '1';
    });

    // Enhanced mobile modal adjustments
    if (isMobileDevice()) {
        const cardModal = document.querySelector('.card-attachments-modal');
        if (cardModal) {
            cardModal.style.width = '95vw';
            cardModal.style.height = '90vh';
            cardModal.style.maxWidth = '95vw';
            cardModal.style.maxHeight = '90vh';
        }

        const modalContent = document.querySelector('.card-modal-content');
        if (modalContent) {
            modalContent.style.flexDirection = 'column';
            modalContent.style.gap = '15px';
            modalContent.style.padding = '15px';
        }
    }

    // Add enhanced CSS for mobile compatibility
    const enhancedStyle = document.createElement('style');
    enhancedStyle.id = 'mobile-attachment-enhancement';
    enhancedStyle.textContent = `
        /* Force visibility for all attachment elements */
        .attachments-list,
        .attachments-list-container,
        .card-attachments-list,
        .attachment-item,
        .mobile-enhanced-item,
        .desktop-enhanced-item,
        [id*="cardAttachmentsList"],
        [id*="attachmentsList"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
        }

        .attachment-item,
        .mobile-enhanced-item,
        .desktop-enhanced-item {
            display: flex !important;
            align-items: center !important;
        }

        /* Mobile-specific enhancements */
        @media (max-width: 768px) {
            .mobile-enhanced-item {
                padding: 15px 10px !important;
                margin-bottom: 10px !important;
                background: #f8f9fa !important;
                border: 1px solid #e9ecef !important;
                border-radius: 8px !important;
                transition: all 0.3s ease !important;
            }

            .mobile-enhanced-item:hover {
                background: #e3f2fd !important;
                border-color: #007bff !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15) !important;
            }

            .attachments-list-container {
                min-height: 200px !important;
                max-height: 60vh !important;
                overflow-y: auto !important;
                padding: 10px !important;
            }

            .card-attachments-modal {
                width: 95vw !important;
                height: 90vh !important;
                max-width: 95vw !important;
                max-height: 90vh !important;
            }

            .card-modal-content {
                flex-direction: column !important;
                gap: 15px !important;
                padding: 15px !important;
            }
        }
    `;

    // Remove existing style if present
    const existingStyle = document.getElementById('mobile-attachment-enhancement');
    if (existingStyle) {
        existingStyle.remove();
    }

    document.head.appendChild(enhancedStyle);

    console.log(`ğŸ“± ØªÙ… ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ ${enhancedCount} Ø¹Ù†ØµØ± Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„`);
    console.log(`ğŸ“± ØªÙ… ØªØ­Ø³ÙŠÙ† ${attachmentItems.length} Ø¹Ù†ØµØ± Ù…Ø±ÙÙ‚ ÙØ±Ø¯ÙŠ`);

    // Force a repaint to ensure changes are applied
    setTimeout(() => {
        const allElements = document.querySelectorAll('[id*="cardAttachmentsList"], .attachment-item');
        allElements.forEach(el => {
            el.style.transform = 'translateZ(0)';
            setTimeout(() => {
                el.style.transform = '';
            }, 10);
        });
    }, 100);
}

// ===== Setup Attachments Scroll with Back to Top Button =====
function setupAttachmentsScroll(cardKey) {
    console.log('ğŸ“œ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰...');

    const attachmentsList = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const scrollToTopBtn = document.getElementById(`scrollToTopBtn_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (!attachmentsList || !scrollToTopBtn) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ø³ÙƒØ±ÙˆÙ„');
        return;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø§Ø³ÙƒØ±ÙˆÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
    attachmentsList.addEventListener('scroll', function() {
        const scrollTop = this.scrollTop;
        const scrollThreshold = 100; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± 100px

        if (scrollTop > scrollThreshold) {
            scrollToTopBtn.classList.add('show');
        } else {
            scrollToTopBtn.classList.remove('show');
        }
    });

    // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø¬ÙˆØ§Ù„
    if (isMobileDevice()) {
        attachmentsList.style.webkitOverflowScrolling = 'touch';
        attachmentsList.style.scrollBehavior = 'smooth';
    }

    console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
}

// ===== Scroll to Top Function for Attachments =====
function scrollToTopAttachments(cardKey) {
    console.log('â¬†ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');

    const attachmentsList = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (attachmentsList) {
        // Ø§Ø³ÙƒØ±ÙˆÙ„ Ø³Ù„Ø³ Ù„Ù„Ø£Ø¹Ù„Ù‰
        attachmentsList.scrollTo({
            top: 0,
            behavior: 'smooth'
        });

        // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø²Ø±
        const scrollToTopBtn = document.getElementById(`scrollToTopBtn_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (scrollToTopBtn) {
            scrollToTopBtn.style.transform = 'scale(0.9)';
            setTimeout(() => {
                scrollToTopBtn.style.transform = 'scale(1)';
            }, 150);
        }

        console.log('âœ… ØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
    } else {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
    }
}

// ===== Enhanced Scroll to Attachments (for large screens) =====
function scrollToAttachments() {
    console.log('ğŸ“œ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const attachmentsSection = document.querySelector('.attachments-main-section');
    const attachmentsList = document.querySelector('.scrollable-attachments');

    if (attachmentsSection) {
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
        attachmentsSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        console.log('âœ… ØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
    } else if (attachmentsList) {
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙƒØ¨Ø¯ÙŠÙ„
        attachmentsList.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        console.log('âœ… ØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
    } else {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø¯Ù…Ø¬
function loadUnitsForMerge() {
    const propertyName = document.getElementById('mergePropertyName').value;
    const container = document.getElementById('availableUnitsForMerge');

    if (!propertyName) {
        container.innerHTML = '<p>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹</p>';
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù‚Ø¯
    const availableUnits = properties.filter(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
        (!p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || !p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'])
    );

    if (availableUnits.length === 0) {
        container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¯Ù…Ø¬ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±</p>';
        return;
    }

    container.innerHTML = availableUnits.map(unit => `
        <label class="unit-checkbox">
            <input type="checkbox" value="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}" name="mergeUnits">
            <span>${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] + ' Ù…Â²' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
        </label>
    `).join('');
}

// Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
function mergeSelectedUnits() {
    const propertyName = document.getElementById('mergePropertyName').value;
    const contractNumber = document.getElementById('mergeContractNumber').value.trim();
    const selectedUnits = Array.from(document.querySelectorAll('input[name="mergeUnits"]:checked'))
        .map(checkbox => checkbox.value);

    if (!propertyName || !contractNumber) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯');
        return;
    }

    if (selectedUnits.length < 2) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯ØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¯Ù…Ø¬');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ù‚Ø¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù…
    const existingContract = properties.find(p => p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber);
    if (existingContract) {
        alert('ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
    }

    console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');
    console.log(`ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø¯Ù…Ø¬: ${selectedUnits.join(', ')}`);
    console.log(`ğŸ“„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${contractNumber}`);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    let mergedCount = 0;
    selectedUnits.forEach(unitNumber => {
        const unit = properties.find(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );
        if (unit) {
            console.log(`ğŸ”— Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ØªØ­Øª Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}`);
            unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = contractNumber;
            mergedCount++;
        } else {
            console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        }
    });

    if (mergedCount === 0) {
        alert('ÙØ´Ù„ ÙÙŠ Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª - Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ÙˆØ­Ø¯Ø©');
        return;
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage
    console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬...');
    try {
        localStorage.setItem('properties', JSON.stringify(properties));
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
        alert('ØªÙ… Ø§Ù„Ø¯Ù…Ø¬ ÙˆÙ„ÙƒÙ† ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ');
    }

    // Ø­ÙØ¸ ÙÙŠ Supabase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
        console.log('â˜ï¸ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase...');
        try {
            selectedUnits.forEach(async (unitNumber) => {
                const unit = properties.find(p =>
                    p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
                );
                if (unit && typeof savePropertyToSupabase === 'function') {
                    await savePropertyToSupabase(unit);
                }
            });
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase:', error);
        }
    }

    alert(`ØªÙ… Ø¯Ù…Ø¬ ${mergedCount} ÙˆØ­Ø¯Ø§Øª ØªØ­Øª Ø§Ù„Ø¹Ù‚Ø¯ Ø±Ù‚Ù… ${contractNumber} Ø¨Ù†Ø¬Ø§Ø­!`);

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('mergePropertyName').value = '';
    document.getElementById('mergeContractNumber').value = '';
    document.getElementById('availableUnitsForMerge').innerHTML = '';

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    const mergedDisplay = document.getElementById('mergedUnitsDisplay');
    if (mergedDisplay) {
        mergedDisplay.innerHTML = renderMergedUnits();
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
    setTimeout(() => {
        renderData();
        initializeApp();
    }, 500);

    console.log('ğŸ‰ ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
}

// ===== ÙˆØ¸Ø§Ø¦Ù ÙØµÙ„ ÙˆØªØ­Ø±ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø© =====

// ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø©
async function splitMergedContract(contractNumber, propertyName) {
    console.log(`ğŸ”“ Ø¨Ø¯Ø¡ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø¹Ù‚Ø¯ ${contractNumber} ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± ${propertyName}`);

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙØµÙ„
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯ Ø±Ù‚Ù… ${contractNumber}ØŸ\nØ³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.`)) {
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯
    const contractUnits = properties.filter(p =>
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );

    if (contractUnits.length === 0) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯');
        return;
    }

    console.log(`ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${contractUnits.length} ÙˆØ­Ø¯Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯`);

    // Ø¥Ø²Ø§Ù„Ø© Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
    let splitCount = 0;
    contractUnits.forEach(unit => {
        console.log(`ğŸ”“ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}`);
        unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = ''; // Ø¥Ø²Ø§Ù„Ø© Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
        splitCount++;
    });

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage
    console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ÙØµÙ„...');
    try {
        localStorage.setItem('properties', JSON.stringify(properties));
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
        alert('ØªÙ… Ø§Ù„ÙØµÙ„ ÙˆÙ„ÙƒÙ† ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ');
    }

    // Ø­ÙØ¸ ÙÙŠ Supabase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof savePropertyToSupabase === 'function') {
        console.log('â˜ï¸ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase...');
        let supabaseErrors = 0;

        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†
            const savePromises = contractUnits.map(async (unit) => {
                try {
                    const result = await savePropertyToSupabase(unit);
                    if (result) {
                        console.log(`âœ… ØªÙ… Ø­ÙØ¸ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                        return true;
                    } else {
                        console.error(`âŒ ÙØ´Ù„ Ø­ÙØ¸ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                        supabaseErrors++;
                        return false;
                    }
                } catch (error) {
                    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
                    supabaseErrors++;
                    return false;
                }
            });

            await Promise.all(savePromises);

            if (supabaseErrors === 0) {
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                console.warn(`âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ ${supabaseErrors} ÙˆØ­Ø¯Ø© ÙÙŠ Supabase`);
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase:', error);
            supabaseErrors = contractUnits.length;
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸
    let message = `ØªÙ… ÙØµÙ„ ${splitCount} ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ø±Ù‚Ù… ${contractNumber} Ø¨Ù†Ø¬Ø§Ø­!`;
    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
        if (supabaseErrors === 0) {
            message += `\nâœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©`;
        } else if (supabaseErrors > 0) {
            message += `\nâš ï¸ ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ Ø­ÙØ¸ ${supabaseErrors} ÙˆØ­Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©`;
        }
    }
    alert(message);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    const mergedDisplay = document.getElementById('mergedUnitsDisplay');
    if (mergedDisplay) {
        mergedDisplay.innerHTML = renderMergedUnits();
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
    setTimeout(() => {
        renderData();
        initializeApp();
    }, 500);

    console.log('ğŸ‰ ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­');
}

// ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬
function editMergedContract(contractNumber, propertyName) {
    console.log(`âœï¸ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber} ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± ${propertyName}`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯
    const contractUnits = properties.filter(p =>
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );

    if (contractUnits.length === 0) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯');
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±
    const editModal = document.createElement('div');
    editModal.className = 'modal-overlay';
    editModal.innerHTML = `
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬</h3>
                <button class="close-modal" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong></label>
                    <input type="text" id="editContractNumber" value="${contractNumber}"
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                </div>

                <div class="form-group">
                    <label><strong>Ø§Ù„Ø¹Ù‚Ø§Ø±:</strong></label>
                    <input type="text" value="${propertyName}" readonly
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 15px; background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label><strong>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (${contractUnits.length} ÙˆØ­Ø¯Ø©):</strong></label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f9f9f9;">
                        ${contractUnits.map(unit => `
                            <div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="editUnits" value="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}" checked
                                           style="margin-left: 10px;">
                                    <span>ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}</span>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        <i class="fas fa-info-circle"></i> ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ÙØµÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="saveEditedContract('${contractNumber}', '${propertyName}')">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                </button>
                <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(editModal);
}

// Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
async function saveEditedContract(oldContractNumber, propertyName) {
    const newContractNumber = document.getElementById('editContractNumber').value.trim();
    const selectedUnits = Array.from(document.querySelectorAll('input[name="editUnits"]:checked'))
        .map(checkbox => checkbox.value);

    if (!newContractNumber) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯');
        return;
    }

    console.log(`ğŸ’¾ Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ ${oldContractNumber} -> ${newContractNumber}`);
    console.log(`ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: ${selectedUnits.join(', ')}`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const allContractUnits = properties.filter(p =>
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === oldContractNumber &&
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );

    let updatedCount = 0;
    let removedCount = 0;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª
    allContractUnits.forEach(unit => {
        const unitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];

        if (selectedUnits.includes(unitNumber)) {
            // Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø© - ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
            unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = newContractNumber;
            updatedCount++;
            console.log(`âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù„Ù„Ø¹Ù‚Ø¯ ${newContractNumber}`);
        } else {
            // Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© - Ø¥Ø²Ø§Ù„Ø© Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
            unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = '';
            removedCount++;
            console.log(`ğŸ”“ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯`);
        }
    });

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    try {
        localStorage.setItem('properties', JSON.stringify(properties));
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
        alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹');
        return;
    }

    // Ø­ÙØ¸ ÙÙŠ Supabase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof savePropertyToSupabase === 'function') {
        console.log('â˜ï¸ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase...');
        let supabaseErrors = 0;

        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†
            const savePromises = allContractUnits.map(async (unit) => {
                try {
                    const result = await savePropertyToSupabase(unit);
                    if (result) {
                        console.log(`âœ… ØªÙ… Ø­ÙØ¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                        return true;
                    } else {
                        console.error(`âŒ ÙØ´Ù„ Ø­ÙØ¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                        supabaseErrors++;
                        return false;
                    }
                } catch (error) {
                    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
                    supabaseErrors++;
                    return false;
                }
            });

            await Promise.all(savePromises);

            if (supabaseErrors === 0) {
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                console.warn(`âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ ${supabaseErrors} ÙˆØ­Ø¯Ø© ÙÙŠ Supabase`);
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase:', error);
            supabaseErrors = allContractUnits.length;
        }
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.querySelector('.modal-overlay').remove();

    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸
    let message = `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!\n`;
    if (updatedCount > 0) {
        message += `- ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} ÙˆØ­Ø¯Ø© Ù„Ù„Ø¹Ù‚Ø¯ Ø±Ù‚Ù… ${newContractNumber}\n`;
    }
    if (removedCount > 0) {
        message += `- ØªÙ… ÙØµÙ„ ${removedCount} ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯\n`;
    }

    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
        if (supabaseErrors === 0) {
            message += `âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©`;
        } else if (supabaseErrors > 0) {
            message += `âš ï¸ ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ Ø­ÙØ¸ ${supabaseErrors} ÙˆØ­Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©`;
        }
    }

    alert(message);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    const mergedDisplay = document.getElementById('mergedUnitsDisplay');
    if (mergedDisplay) {
        mergedDisplay.innerHTML = renderMergedUnits();
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
    setTimeout(() => {
        renderData();
        initializeApp();
    }, 500);

    console.log('ğŸ‰ ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function searchUnits() {
    const searchTerm = document.getElementById('unitsSearchInput').value.toLowerCase();
    const propertyFilter = document.getElementById('unitsFilterProperty').value;

    let filteredUnits = properties;

    // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
    if (propertyFilter) {
        filteredUnits = filteredUnits.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyFilter);
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    if (searchTerm) {
        filteredUnits = filteredUnits.filter(p =>
            (p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] && p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toLowerCase().includes(searchTerm)) ||
            (p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].toLowerCase().includes(searchTerm)) ||
            (p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] && p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'].toLowerCase().includes(searchTerm))
        );
    }

    displayUnitsResults(filteredUnits);
}

// ÙÙ„ØªØ±Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù‚Ø§Ø±
function filterUnitsByProperty() {
    searchUnits(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø«
}

// Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function displayUnitsResults(units) {
    const container = document.getElementById('unitsResults');

    if (units.length === 0) {
        container.innerHTML = '<p class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</p>';
        return;
    }

    container.innerHTML = units.map(unit => `
        <div class="unit-result-item">
            <div class="unit-info">
                <h4>${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}</h4>
                <p><strong>Ø§Ù„Ø¹Ù‚Ø§Ø±:</strong> ${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}</p>
                <p><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${unit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']}</p>
                <p><strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> ${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] + ' Ù…Â²' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                <p><strong>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</strong> ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}</p>
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            </div>
            <div class="unit-actions">
                <button onclick="editUnit('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}', '${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}')" class="btn-edit">
                    <i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ±
                </button>
                <button onclick="showUnitDetails('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}', '${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}', '${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}')" class="btn-view">
                    <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                </button>
                <button onclick="deleteUnit('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}', '${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}')" class="btn-delete">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
            </div>
        </div>
    `).join('');
}

// ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
function loadUnitsResults() {
    displayUnitsResults(properties);
}

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„ØªØ­Ø±ÙŠØ± Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ====================

// Enhanced card attachments modal with real-time cross-device synchronization
function showCardAttachmentsModal(city, propertyName, contractNumber, unitNumber) {
    console.log('ğŸ¯ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...', { city, propertyName, contractNumber, unitNumber });

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
    document.body.style.height = '100%';
    document.documentElement.style.overflow = 'hidden';

    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù†ÙˆØ§ÙØ° Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
    closeModal();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const canDelete = isAuthorizedUser();
    const canUpload = isAuthorizedUser();

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©
    let cardKey;
    if (contractNumber) {
        cardKey = `${city}_${propertyName}_contract_${contractNumber}`;
    } else if (unitNumber) {
        cardKey = `${city}_${propertyName}_unit_${unitNumber}`;
    } else {
        cardKey = `${city}_${propertyName}_general`;
    }

    // Try to get attachments from Supabase first, fallback to local
    async function loadCardAttachments() {
        let cardAttachments = [];
        let isFromCloud = false;

        // Try Supabase first
        if (typeof getCardAttachmentsEnhanced === 'function' && supabaseClient) {
            try {
                console.log(`â˜ï¸ Ø¬Ù„Ø¨ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${cardKey} Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...`);
                cardAttachments = await getCardAttachmentsEnhanced(cardKey);
                isFromCloud = true;
                console.log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${cardAttachments.length} Ù…Ø±ÙÙ‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
            } catch (error) {
                console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:', error);
            }
        }

        // Fallback to local attachments if no cloud data
        if (!isFromCloud || cardAttachments.length === 0) {
            cardAttachments = (window.cardAttachments && window.cardAttachments[cardKey]) || [];
            console.log(`ğŸ’¾ ØªÙ… Ø¬Ù„Ø¨ ${cardAttachments.length} Ù…Ø±ÙÙ‚ Ù…Ø­Ù„ÙŠ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©`);
        }

        return { cardAttachments, isFromCloud };
    }

    // ØªØµÙ…ÙŠÙ… Ù…Ø®ØªÙ„Ù Ù„Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    const isMobile = isMobileDevice();

    let html;

    if (isMobile) {
        // ØªØµÙ…ÙŠÙ… Ù…Ø¶ØºÙˆØ· Ù„Ù„Ø¬ÙˆØ§Ù„
        html = `
        <div class="modal-overlay mobile-attachments-overlay" style="display:flex;">
            <div class="modal-box mobile-attachments-modal compact">
                <!-- Ø±Ø£Ø³ Ù…Ø¶ØºÙˆØ· - ØµÙ ÙˆØ§Ø­Ø¯ -->
                <div class="mobile-compact-header">
                    <div class="header-content">
                        <span class="header-title"><i class="fas fa-paperclip"></i> Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</span>
                        <span class="header-separator">|</span>
                        <span class="header-info"><i class="fas fa-building"></i> ${propertyName}</span>
                        <span class="header-separator">|</span>
                        <span class="header-info"><i class="fas fa-map-marker-alt"></i> ${city}</span>
                        ${contractNumber ? `<span class="header-separator">|</span><span class="header-info"><i class="fas fa-file-contract"></i> ${contractNumber}</span>` : ''}
                        ${unitNumber ? `<span class="header-separator">|</span><span class="header-info"><i class="fas fa-home"></i> ${unitNumber}</span>` : ''}
                    </div>

                </div>

                <!-- Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø¯ÙˆØ¯ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© -->
                ${!canUpload && !canDelete ? `
                <div class="limited-user-notice" style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 12px; margin-bottom: 15px; text-align: center;">
                    <i class="fas fa-info-circle" style="color: #2196f3; margin-left: 8px;"></i>
                    <span style="color: #1976d2; font-size: 0.9rem;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙ‚Ø·</span>
                </div>
                ` : ''}

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ³Ø¹Ø© -->
                <div class="mobile-attachments-section expanded">
                    <div class="mobile-attachments-header-small">
                        <span><i class="fas fa-folder-open"></i> Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</span>
                        <span class="mobile-attachments-count" id="mobileAttachmentsCount_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>
                    <div id="cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="mobile-attachments-list">
                        <div class="mobile-loading" style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 10px;"></i>
                            <p style="font-size: 0.9rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...</p>
                        </div>
                    </div>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³ÙÙ„ - Ù…Ø«Ù„ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
                <div class="bottom-buttons-row">
                    ${canUpload ? `
                    <button class="bottom-action-btn upload drag-drop-zone"
                            onclick="document.getElementById('cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}').click()"
                            ondragover="handleDragOver(event)"
                            ondragenter="handleDragEnter(event)"
                            ondragleave="handleDragLeave(event)"
                            ondrop="handleDrop(event, 'cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}')">
                        <i class="fas fa-plus"></i> Ø¥Ø±ÙØ§Ù‚
                    </button>
                    ` : ''}
                    <button class="bottom-action-btn cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>

                <!-- Ø­Ù‚Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø®ÙÙŠ -->
                ${canUpload ? `
                <input type="file" id="cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" multiple style="display:none" onchange="handleCardFileUploadEnhanced(event, '${cardKey}')">
                ` : ''}
            </div>
        </div>`;
    } else {
        // ØªØµÙ…ÙŠÙ… Ù…Ø¶ØºÙˆØ· Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
        html = `
        <div class="modal-overlay enhanced-modal-overlay" style="display:flex;">
            <div class="modal-box attachments-modal enhanced compact">
                <!-- Ø±Ø£Ø³ Ù…Ø¶ØºÙˆØ· - ØµÙ ÙˆØ§Ø­Ø¯ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ -->
                <div class="compact-header-row">
                    <div class="header-content-inline">
                        <span class="header-title"><i class="fas fa-paperclip"></i> Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</span>
                        <span class="header-separator">|</span>
                        <span class="header-info"><i class="fas fa-building"></i> ${propertyName}</span>
                        <span class="header-separator">|</span>
                        <span class="header-info"><i class="fas fa-map-marker-alt"></i> ${city}</span>
                        ${contractNumber ? `<span class="header-separator">|</span><span class="header-info"><i class="fas fa-file-contract"></i> Ø¹Ù‚Ø¯: ${contractNumber}</span>` : ''}
                        ${unitNumber ? `<span class="header-separator">|</span><span class="header-info"><i class="fas fa-home"></i> ÙˆØ­Ø¯Ø©: ${unitNumber}</span>` : ''}
                    </div>
                    <button class="header-close-btn" onclick="closeModal()" title="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø¯ÙˆØ¯ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© -->
                ${!canUpload && !canDelete ? `
                <div class="limited-user-notice" style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-info-circle" style="color: #2196f3; margin-left: 10px; font-size: 1.2rem;"></i>
                    <span style="color: #1976d2; font-size: 1rem; font-weight: 500;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙ‚Ø·</span>
                </div>
                ` : ''}

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ³Ø¹Ø© -->
                <div class="attachments-main-section" style="width: 100%;">
                    <div class="attachments-header">
                        <h3><i class="fas fa-folder-open"></i> Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h3>
                    </div>
                    <div id="cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="attachments-list expanded">
                        <div class="loading-attachments" style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...</p>
                        </div>
                    </div>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³ÙÙ„ -->
                <div class="bottom-buttons-row">
                    ${canUpload ? `
                    <button class="bottom-action-btn upload drag-drop-zone"
                            onclick="document.getElementById('cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}').click()"
                            ondragover="handleDragOver(event)"
                            ondragenter="handleDragEnter(event)"
                            ondragleave="handleDragLeave(event)"
                            ondrop="handleDrop(event, 'cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}')">
                        <i class="fas fa-plus"></i> Ø¥Ø±ÙØ§Ù‚
                    </button>
                    ` : ''}
                    <button class="bottom-action-btn cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>

                <!-- Ø­Ù‚Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø®ÙÙŠ -->
                ${canUpload ? `
                <input type="file" id="cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" multiple style="display:none" onchange="handleCardFileUploadEnhanced(event, '${cardKey}')">
                ` : ''}
            </div>
        </div>`;
    }

    // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    document.body.insertAdjacentHTML('beforeend', html);

    // ğŸ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© (Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚)
    loadCardAttachments().then(({ cardAttachments, isFromCloud }) => {
        console.log(`ğŸ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${cardAttachments.length} Ù…Ø±ÙÙ‚ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© ${cardKey} (${isFromCloud ? 'Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©' : 'Ù…Ø­Ù„ÙŠ'})`);

        const listContainer = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (listContainer) {
            // Force visibility with enhanced mobile support
            listContainer.style.display = 'block';
            listContainer.style.visibility = 'visible';
            listContainer.style.opacity = '1';

            // Add mobile-specific classes
            if (isMobileDevice()) {
                listContainer.classList.add('mobile-list', 'mobile-optimized');
                listContainer.style.minHeight = '300px';
                listContainer.style.maxHeight = '60vh';
                listContainer.style.overflowY = 'auto';
            }

            // Render attachments with layout specific to device type
            if (isMobileDevice()) {
                listContainer.innerHTML = renderMobileCardAttachmentsList(cardKey, cardAttachments);

                // Update mobile attachments count
                const mobileCountBadge = document.getElementById(`mobileAttachmentsCount_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (mobileCountBadge) {
                    mobileCountBadge.textContent = `${cardAttachments.length} Ù…Ø±ÙÙ‚`;
                }
            } else {
                listContainer.innerHTML = renderCardAttachmentsList(cardKey, cardAttachments);

                // Enhanced mobile display optimization
                enhanceAttachmentDisplayForMobile();
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(() => {
                setupAttachmentsScroll(cardKey);
            }, 100);

            // Ø¥Ø¶Ø§ÙØ© Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙ‚Ø·)
            if (!isMobileDevice()) {
                setTimeout(() => {
                    scrollToAttachments();
                }, 300);
            }

            console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„');

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙƒÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            adjustModalSizeBasedOnContent(cardAttachments.length);

            // Initialize search functionality
            setTimeout(() => {
                initCardAttachmentsSearch(cardKey);
            }, 200);
        } else {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        }
    }).catch(error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:', error);

        const listContainer = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="error-loading-attachments enhanced-error" style="text-align: center; padding: ${isMobileDevice() ? '40px 20px' : '20px'}; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="font-size: ${isMobileDevice() ? '3rem' : '2rem'}; margin-bottom: ${isMobileDevice() ? '20px' : '10px'};"></i>
                    <p style="font-size: ${isMobileDevice() ? '1.2rem' : '1rem'};">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</p>
                    <button onclick="refreshCardAttachmentsList('${cardKey}')" class="btn-primary" style="margin-top: ${isMobileDevice() ? '15px' : '10px'}; padding: ${isMobileDevice() ? '12px 20px' : '8px 16px'}; font-size: ${isMobileDevice() ? '1.1rem' : '0.9rem'};">
                        <i class="fas fa-refresh"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                </div>
            `;
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
    setupCardDragAndDrop(cardKey);

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
    setupAttachmentsScroll(cardKey);

    // ğŸ”§ Ø¥Ø¶Ø§ÙØ© CSS Ø¥ØµÙ„Ø§Ø­ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    const fixStyle = document.createElement('style');
    fixStyle.textContent = `
        .attachments-list,
        .card-attachments-list,
        .attachment-item,
        [id*="cardAttachmentsList"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .attachment-item {
            display: flex !important;
        }

        .loading-attachments,
        .error-loading-attachments {
            display: block !important;
            visibility: visible !important;
        }
    `;
    document.head.appendChild(fixStyle);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚)
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
function scrollToAttachments() {
    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
        const attachmentsSection = document.querySelector('.attachments-main-section');
        const attachmentsList = document.querySelector('.compact-list');

        if (attachmentsSection) {
            // Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
            attachmentsSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });

            // Ø³ÙƒØ±ÙˆÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø£Ø¹Ù„Ù‰
            if (attachmentsList) {
                attachmentsList.scrollTop = 0;
            }

            console.log('ğŸ“œ ØªÙ… Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„:', error);
    }
}

// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
function renderCardAttachmentsList(cardKey, attachments = null) {
    // Use provided attachments or fallback to local storage
    const cardFiles = attachments || cardAttachments[cardKey] || [];

    if (cardFiles.length === 0) {
        return '<p class="no-attachments">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</p>';
    }

    // Check if mobile device for responsive design
    const isMobile = isMobileDevice();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const canDelete = isAuthorizedUser();

    return cardFiles.map(file => {
        // Handle both local and cloud file formats
        const fileName = file.file_name || file.name;
        const fileSize = formatFileSize(file.file_size || file.size);
        const fileType = file.file_type || file.type;
        const uploadDate = new Date(file.created_at || file.uploadDate).toLocaleDateString('ar-SA');
        const fileIcon = getFileIcon(fileName);

        // Determine if file is local or cloud-based
        const isLocal = file.isLocal || !file.id || file.id.toString().startsWith('local_');
        const storageIcon = isLocal ? 'ğŸ’¾' : 'â˜ï¸';
        const storageTitle = isLocal ? 'Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹' : 'Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©';

        // Use enhanced layout for mobile and desktop
        return `
        <div class="attachment-item ${isMobile ? 'mobile-enhanced-item' : 'desktop-enhanced-item'}" data-name="${fileName}">
            <div class="file-icon-enhanced">${fileIcon}</div>
            <div class="file-info-enhanced">
                <div class="file-name-enhanced" title="${fileName}">
                    <span class="file-name-text">${fileName}</span>
                </div>
            </div>
            <div class="attachment-actions-enhanced">
                ${isLocal ?
                    `<button onclick="downloadCardAttachment('${cardKey}', '${fileName}')" class="btn-enhanced btn-download" title="ØªØ­Ù…ÙŠÙ„">
                        <i class="fas fa-download"></i>
                        <span>ØªØ­Ù…ÙŠÙ„</span>
                    </button>
                    ${canDelete ? `<button onclick="deleteCardAttachment('${cardKey}', '${fileName}')" class="btn-enhanced btn-delete" title="Ø­Ø°Ù">
                        <i class="fas fa-trash"></i>
                        <span>Ø­Ø°Ù</span>
                    </button>` : ''}` :
                    `<button onclick="downloadAttachmentFromSupabase('${file.file_url}', '${fileName}')" class="btn-enhanced btn-download" title="ØªØ­Ù…ÙŠÙ„">
                        <i class="fas fa-download"></i>
                        <span>ØªØ­Ù…ÙŠÙ„</span>
                    </button>
                    ${canDelete ? `<button onclick="deleteCardAttachmentFromSupabase('${file.id}', '${cardKey}')" class="btn-enhanced btn-delete" title="Ø­Ø°Ù">
                        <i class="fas fa-trash"></i>
                        <span>Ø­Ø°Ù</span>
                    </button>` : ''}`
                }
            </div>
        </div>
        `;
    }).join('');
}

// ===== Render Mobile Card Attachments List =====
function renderMobileCardAttachmentsList(cardKey, attachments) {
    console.log(`ğŸ“± Ø¹Ø±Ø¶ ${attachments.length} Ù…Ø±ÙÙ‚ Ù„Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${cardKey}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const canDelete = isAuthorizedUser();

    if (!attachments || attachments.length === 0) {
        return `
            <div class="mobile-no-attachments" style="text-align: center; padding: 30px 20px; color: #6c757d;">
                <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p style="margin: 0; font-size: 0.9rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª</p>
                <small style="opacity: 0.7;">${canDelete ? 'Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚" Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø¹Ø±Ø¶'}</small>
            </div>
        `;
    }

    let html = '';

    attachments.forEach((file, index) => {
        // Handle both local and cloud file formats
        const fileName = file.file_name || file.name;
        const fileSize = formatFileSize(file.file_size || file.size);
        const uploadDate = new Date(file.created_at || file.uploadDate).toLocaleDateString('ar-SA');
        const fileIcon = getFileIcon(fileName);

        // Determine file source
        const isCloudFile = file.file_url || file.url;
        const sourceIcon = isCloudFile ? 'â˜ï¸' : 'ğŸ’¾';
        const sourceText = isCloudFile ? 'Ø³Ø­Ø§Ø¨ÙŠ' : 'Ù…Ø­Ù„ÙŠ';

        html += `
            <div class="mobile-attachment-item" data-file-index="${index}">
                <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„Ù -->
                <div class="mobile-file-icon" style="color: ${getFileIconColor(fileName)};">
                    ${fileIcon}
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù -->
                <div class="mobile-file-info">
                    <div class="mobile-file-name" title="${fileName}">
                        ${fileName}
                    </div>
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø£Ø³ÙÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© -->
                    <div class="mobile-file-actions" style="margin-top: 8px;">
                        ${isCloudFile ?
                            `<button class="mobile-action-btn download" onclick="downloadAttachmentFromSupabase('${file.file_url || file.url}', '${fileName}')" title="ØªØ­Ù…ÙŠÙ„">
                                <i class="fas fa-download"></i>
                                <span>ØªØ­Ù…ÙŠÙ„</span>
                            </button>
                            ${canDelete ? `<button class="mobile-action-btn delete" onclick="deleteCardAttachmentFromSupabase('${file.id}', '${cardKey}')" title="Ø­Ø°Ù">
                                <i class="fas fa-trash"></i>
                                <span>Ø­Ø°Ù</span>
                            </button>` : ''}` :
                            `<button class="mobile-action-btn download" onclick="downloadCardAttachment('${cardKey}', ${index})" title="ØªØ­Ù…ÙŠÙ„">
                                <i class="fas fa-download"></i>
                                <span>ØªØ­Ù…ÙŠÙ„</span>
                            </button>
                            ${canDelete ? `<button class="mobile-action-btn delete" onclick="deleteCardAttachment('${cardKey}', ${index})" title="Ø­Ø°Ù">
                                <i class="fas fa-trash"></i>
                                <span>Ø­Ø°Ù</span>
                            </button>` : ''}`
                        }
                    </div>
                </div>
            </div>
        `;
    });

    console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ - ${attachments.length} Ø¹Ù†ØµØ±`);
    return html;
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Legacy - redirects to enhanced version)
function handleCardFileUpload(event, cardKey) {
    console.log('ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø³Ù†Ø©...');

    // Redirect to enhanced version for consistency and real-time sync
    handleCardFileUploadEnhanced(event, cardKey);
}

// Enhanced card file upload with Supabase integration
async function handleCardFileUploadEnhanced(event, cardKey) {
    const files = event.target.files;

    // Get notes from the correct element ID
    const notesElement = document.getElementById(`cardUploadNotes_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`) ||
                        document.getElementById('cardUploadNotes');
    const notes = notesElement?.value || '';

    if (files.length === 0) return;

    // Show enhanced upload progress modal
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.innerHTML = `
        <div class="modal-box upload-progress-modal" style="text-align: center; padding: 40px; max-width: 500px;">
            <div class="upload-header">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #17a2b8; margin-bottom: 1rem;"></i>
                <h3>Ø±ÙØ¹ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
            </div>
            <div class="upload-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="cardProgressFill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-text">
                        <span id="cardProgressText">0 Ù…Ù† ${files.length} Ù…Ù„Ù</span>
                        <span id="cardProgressPercentage">0%</span>
                    </div>
                </div>
                <div class="upload-details">
                    <p id="cardUploadStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...</p>
                    <p id="cardCurrentFile" style="font-size: 0.9rem; color: #666;"></p>
                </div>
            </div>
            <div class="device-sync-info" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <i class="fas fa-sync-alt" style="color: #17a2b8;"></i>
                <small>Ø³ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</small>
            </div>
        </div>
    `;
    document.body.appendChild(progressModal);

    try {
        // Check if Supabase is available and working
        const supabaseAvailable = await checkSupabaseAvailability();

        if (supabaseAvailable) {
            document.getElementById('cardUploadStatus').textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...';

            // Upload files with progress tracking
            await handleCardFilesEnhancedWithProgress(files, cardKey, notes);

            // Remove progress modal
            progressModal.remove();

            // ğŸ¯ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù†Ø§Ø¬Ø­
            setTimeout(() => {
                refreshCardAttachmentsList(cardKey);

                // Force show any hidden elements
                const allAttachmentElements = document.querySelectorAll('[id*="cardAttachments"], [class*="attachment"]');
                allAttachmentElements.forEach(el => {
                    if (el.style.display === 'none') {
                        el.style.display = 'block';
                        console.log('ğŸ”§ ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ:', el);
                    }
                    if (el.style.visibility === 'hidden') {
                        el.style.visibility = 'visible';
                        console.log('ğŸ”§ ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ:', el);
                    }
                });
            }, 500);

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            event.target.value = '';
            const notesElement = document.getElementById(`cardUploadNotes_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (notesElement) {
                notesElement.value = '';
            }

            // Show success message with cross-device info
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box success-modal" style="text-align: center; padding: 40px;">
                    <div class="success-animation">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
                    </div>
                    <h3>ØªÙ… Ø±ÙØ¹ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!</h3>
                    <div class="success-details">
                        <p>ØªÙ… Ø±ÙØ¹ ${files.length} Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
                        <div class="sync-status" style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
                            <i class="fas fa-globe" style="margin-left: 8px;"></i>
                            <strong>Ù…ØªØ²Ø§Ù…Ù† Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</strong>
                            <br>
                            <small>Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ù…ØªØµÙØ­Ø§Øª</small>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-primary" onclick="closeModal(); refreshCardAttachmentsList('${cardKey}')">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                        </button>
                        <button class="btn-secondary" onclick="closeModal()">
                            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);

            // Auto-close success modal after 5 seconds
            setTimeout(() => {
                if (document.body.contains(successModal)) {
                    successModal.remove();
                }
            }, 5000);

        } else {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:', error);

        // Update status
        document.getElementById('cardUploadStatus').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹...';

        // Fallback to local upload
        await handleCardFilesLocal(files, cardKey, notes);

        // Remove progress modal
        progressModal.remove();

        // ğŸ¯ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ
        setTimeout(() => {
            refreshCardAttachmentsList(cardKey);
        }, 500);

        // Show fallback message with sync options
        const fallbackModal = document.createElement('div');
        fallbackModal.className = 'modal-overlay';
        fallbackModal.innerHTML = `
            <div class="modal-box fallback-modal" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                <h3>ØªÙ… Ø­ÙØ¸ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø­Ù„ÙŠØ§Ù‹</h3>
                <div class="fallback-details">
                    <p>Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©ØŒ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠØ§Ù‹</p>
                    <div class="local-storage-info" style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
                        <i class="fas fa-laptop" style="margin-left: 8px;"></i>
                        <strong>Ù…Ø­ÙÙˆØ¸ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·</strong>
                        <br>
                        <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø§ØªØµØ§Ù„</small>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="closeModal(); refreshCardAttachmentsList('${cardKey}')">
                        <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                    </button>
                    <button class="btn-warning" onclick="closeModal(); retryCardUploadToSupabase('${cardKey}')">
                        <i class="fas fa-sync"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(fallbackModal);
    }
}

// Handle card files upload with progress
async function handleCardFilesEnhancedWithProgress(files, cardKey, notes) {
    let uploadedCount = 0;
    const totalFiles = files.length;

    for (let i = 0; i < files.length; i++) {
        const file = files[i];

        // Update progress
        const progressFill = document.getElementById('cardProgressFill');
        const progressText = document.getElementById('cardProgressText');
        const progressPercentage = document.getElementById('cardProgressPercentage');
        const currentFileElement = document.getElementById('cardCurrentFile');

        if (currentFileElement) {
            currentFileElement.textContent = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹: ${file.name}`;
        }

        try {
            if (typeof uploadCardFileToSupabase === 'function') {
                const result = await uploadCardFileToSupabase(file, cardKey, notes);

                if (result) {
                    uploadedCount++;

                    // Update progress
                    const progress = Math.round((uploadedCount / totalFiles) * 100);
                    if (progressFill) progressFill.style.width = progress + '%';
                    if (progressText) progressText.textContent = `${uploadedCount} Ù…Ù† ${totalFiles} Ù…Ù„Ù`;
                    if (progressPercentage) progressPercentage.textContent = progress + '%';

                    console.log(`âœ… ØªÙ… Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${file.name}`);

                    // ğŸ¯ Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« real-time Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
                    window.dispatchEvent(new CustomEvent('cardAttachmentAdded', {
                        detail: { cardKey, attachment: result }
                    }));

                    // Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ø¹Ø§Ù… Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª
                    window.dispatchEvent(new CustomEvent('attachmentAdded', {
                        detail: {
                            type: 'card',
                            cardKey,
                            attachment: result,
                            propertyKey: cardKey // Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
                        }
                    }));
                } else {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù');
                }
            } else {
                throw new Error('ÙˆØ¸ÙŠÙØ© uploadCardFileToSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
            }
        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${file.name}:`, error);
            throw error;
        }
    }
}

// Handle card files local storage fallback
async function handleCardFilesLocal(files, cardKey, notes) {
    const cardFiles = [];

    for (const file of files) {
        const reader = new FileReader();

        await new Promise((resolve) => {
            reader.onload = function(e) {
                const fileData = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    data: e.target.result,
                    uploadDate: new Date().toISOString(),
                    notes: notes
                };

                cardFiles.push(fileData);
                resolve();
            };
            reader.readAsDataURL(file);
        });
    }

    // Save to localStorage
    if (!window.cardAttachments) {
        window.cardAttachments = {};
    }

    if (!window.cardAttachments[cardKey]) {
        window.cardAttachments[cardKey] = [];
    }

    window.cardAttachments[cardKey].push(...cardFiles);
    localStorage.setItem('cardAttachments', JSON.stringify(window.cardAttachments));

    console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ ${cardFiles.length} Ù…Ù„Ù Ø¨Ø·Ø§Ù‚Ø© Ù…Ø­Ù„ÙŠØ§Ù‹`);
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
function setupCardDragAndDrop(cardKey) {
    const uploadArea = document.getElementById(`cardUploadArea_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (!uploadArea) return;

    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        const files = Array.from(e.dataTransfer.files);
        const fileInput = document.getElementById(`cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

        if (fileInput && files.length > 0) {
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;

            // ØªØ´ØºÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„ØªØºÙŠÙŠØ±
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    });
}

// ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© - Enhanced for all file types
function downloadCardAttachment(cardKey, fileName) {
    const cardFiles = cardAttachments[cardKey] || [];
    const file = cardFiles.find(f => f.name === fileName);

    if (!file) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù');
        return;
    }

    try {
        console.log(`ğŸ“¥ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${file.name}`);

        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        showDownloadProgress(file.name, true);

        // ØªØ­ÙˆÙŠÙ„ base64 Ø¥Ù„Ù‰ blob Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        let downloadUrl = file.data;
        let shouldRevoke = false;

        if (file.data.startsWith('data:')) {
            // ØªØ­ÙˆÙŠÙ„ data URL Ø¥Ù„Ù‰ blob Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­
            const response = fetch(file.data);
            response.then(res => res.blob()).then(blob => {
                downloadUrl = window.URL.createObjectURL(blob);
                shouldRevoke = true;
                performDownload();
            });
        } else {
            performDownload();
        }

        function performDownload() {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = file.name;
            link.style.display = 'none';

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„ØµÙØ­Ø© ÙˆØªÙØ¹ÙŠÙ„Ù‡
            document.body.appendChild(link);
            link.click();

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
            document.body.removeChild(link);
            if (shouldRevoke) {
                window.URL.revokeObjectURL(downloadUrl);
            }

            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            showDownloadProgress(file.name, false);
            showMiniIconNotification('ğŸ“¥', '#28a745', 2000);

            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­: ${file.name}`);
        }

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${file.name}:`, error);

        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        showDownloadProgress(file.name, false);
        showMiniIconNotification('âŒ', '#dc3545', 3000);

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙƒØ¨Ø¯ÙŠÙ„
        const link = document.createElement('a');
        link.href = file.data;
        link.download = file.name;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Ø¹Ø±Ø¶ Ù…Ø±ÙÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
function viewCardAttachment(cardKey, fileIndex) {
    const cardFiles = cardAttachments[cardKey] || [];
    const file = cardFiles[fileIndex];

    if (!file) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù');
        return;
    }

    // ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    const newWindow = window.open('', '_blank');
    newWindow.document.write(`
        <html>
            <head>
                <title>${file.name}</title>
                <style>
                    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                    img { max-width: 100%; height: auto; }
                    .file-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                </style>
            </head>
            <body>
                <div class="file-info">
                    <h2>${file.name}</h2>
                    <p>Ø§Ù„Ø­Ø¬Ù…: ${formatFileSize(file.size)}</p>
                    <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹: ${new Date(file.uploadDate).toLocaleDateString('ar-SA')}</p>
                    ${file.notes ? `<p>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${file.notes}</p>` : ''}
                </div>
                ${file.type.startsWith('image/') ?
                    `<img src="${file.data}" alt="${file.name}">` :
                    `<p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª. <a href="${file.data}" download="${file.name}">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a></p>`
                }
            </body>
        </html>
    `);
}

// Ø­Ø°Ù Ù…Ø±ÙÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
function deleteCardAttachment(cardKey, fileName) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')) return;

    cardAttachments[cardKey] = (cardAttachments[cardKey] || []).filter(f => f.name !== fileName);
    localStorage.setItem('cardAttachments', JSON.stringify(cardAttachments));

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const listContainer = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (listContainer) {
        if (isMobileDevice()) {
            listContainer.innerHTML = renderMobileCardAttachmentsList(cardKey, cardAttachments[cardKey] || []);
        } else {
            listContainer.innerHTML = renderCardAttachmentsList(cardKey);
        }
    }
}

// Enhanced delete card attachment from Supabase
async function deleteCardAttachmentFromSupabase(attachmentId, cardKey) {
    try {
        if (typeof deleteCardAttachmentEnhanced === 'function') {
            const success = await deleteCardAttachmentEnhanced(attachmentId);

            if (success) {
                // Refresh the attachments list
                await refreshCardAttachmentsList(cardKey);

                // Show success notification
                showConnectionNotification('ØªÙ… Ø­Ø°Ù Ù…Ø±ÙÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        } else {
            throw new Error('ÙˆØ¸ÙŠÙØ© deleteCardAttachmentEnhanced ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ù…Ø±ÙÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

// Setup enhanced drag and drop for card attachments
function setupCardDragAndDropEnhanced(cardKey) {
    const uploadZone = document.querySelector('.upload-zone.enhanced');
    if (!uploadZone) return;

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#007bff';
        uploadZone.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
    });

    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const fileInput = document.getElementById('cardFileInput');
            if (fileInput) {
                fileInput.files = files;
                handleCardFileUploadEnhanced({ target: { files } }, cardKey);
            }
        }
    });
}

// Setup real-time updates for card modal
function setupCardModalRealTimeUpdates(cardKey) {
    // Listen for card attachment changes
    window.addEventListener('cardAttachmentAdded', (event) => {
        if (event.detail.cardKey === cardKey) {
            console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${cardKey} - Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯`);
            refreshCardAttachmentsList(cardKey);

            // Show notification if not from current user
            if (!isCurrentUserAction(event.detail.attachment)) {
                showConnectionNotification(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©: ${event.detail.attachment.file_name}`, 'info');
            }
        }
    });

    window.addEventListener('cardAttachmentDeleted', (event) => {
        if (event.detail.cardKey === cardKey) {
            console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${cardKey} - Ø­Ø°Ù Ù…Ù„Ù`);
            refreshCardAttachmentsList(cardKey);

            // Show notification if not from current user
            if (!isCurrentUserAction(event.detail.attachment)) {
                showConnectionNotification(`ØªÙ… Ø­Ø°Ù Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${event.detail.attachment.file_name}`, 'warning');
            }
        }
    });

    // Listen for general attachment events (for compatibility)
    window.addEventListener('attachmentAdded', (event) => {
        if (event.detail.type === 'card' && event.detail.cardKey === cardKey) {
            console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¹Ø§Ù… Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${cardKey}`);
            refreshCardAttachmentsList(cardKey);
        }
    });
}

// Update card sync status
function updateCardSyncStatus() {
    const syncStatus = document.getElementById('cardSyncStatus');
    if (!syncStatus) return;

    if (supabaseClient && typeof getCardAttachmentsEnhanced === 'function') {
        syncStatus.innerHTML = '<i class="fas fa-sync-alt" style="color: #28a745;"></i> Ù…ØªØ²Ø§Ù…Ù†';
        syncStatus.title = 'Ù…ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©';
    } else {
        syncStatus.innerHTML = '<i class="fas fa-wifi-slash" style="color: #ffc107;"></i> Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·';
        syncStatus.title = 'ØºÙŠØ± Ù…ØªØµÙ„ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·';
    }
}

// Filter card attachments list
function filterCardAttachmentsList(event) {
    const searchTerm = event.target.value.toLowerCase();
    const attachmentItems = document.querySelectorAll('.card-attachments-list .attachment-item');

    attachmentItems.forEach(item => {
        const fileName = item.getAttribute('data-name') || '';
        const isVisible = fileName.includes(searchTerm);
        item.style.display = isVisible ? 'flex' : 'none';
    });
}

// Refresh card attachments list in modal
async function refreshCardAttachmentsList(cardKey) {
    try {
        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${cardKey}`);

        // Try multiple selectors to find the list container
        const possibleSelectors = [
            `cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`,
            'cardAttachmentsList',
            'attachmentsList'
        ];

        let listContainer = null;
        for (const selector of possibleSelectors) {
            listContainer = document.getElementById(selector);
            if (listContainer) {
                console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ©: #${selector}`);
                break;
            }
        }

        if (!listContainer) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
            console.log('ğŸ” Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ§Ø­Ø©:');
            possibleSelectors.forEach(selector => {
                console.log(`- #${selector}:`, document.getElementById(selector));
            });
            return;
        }

        // Get updated attachments
        let attachments = [];

        // Try to get from Supabase first
        if (typeof getCardAttachmentsEnhanced === 'function') {
            try {
                attachments = await getCardAttachmentsEnhanced(cardKey);
                console.log(`â˜ï¸ ØªÙ… Ø¬Ù„Ø¨ ${attachments.length} Ù…Ø±ÙÙ‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
            } catch (error) {
                console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:', error);
            }
        }

        // Fallback to local storage if no cloud attachments
        if (attachments.length === 0) {
            const localAttachments = window.cardAttachments?.[cardKey] || [];
            attachments = localAttachments.map(att => ({
                id: 'local_' + Date.now(),
                file_name: att.name,
                file_size: att.size,
                file_type: att.type,
                created_at: att.uploadDate,
                notes: att.notes,
                isLocal: true
            }));
            console.log(`ğŸ’¾ ØªÙ… Ø¬Ù„Ø¨ ${attachments.length} Ù…Ø±ÙÙ‚ Ù…Ø­Ù„ÙŠ`);
        }

        // Force visibility before updating
        listContainer.style.display = 'block';
        listContainer.style.visibility = 'visible';
        listContainer.style.opacity = '1';

        // Update the list
        listContainer.innerHTML = renderCardAttachmentsList(cardKey, attachments);

        // Force visibility of all attachment items
        setTimeout(() => {
            const attachmentItems = listContainer.querySelectorAll('.attachment-item');
            attachmentItems.forEach(item => {
                item.style.display = 'flex';
                item.style.visibility = 'visible';
                item.style.opacity = '1';
            });

            // Force visibility of the entire container again
            listContainer.style.display = 'block';
            listContainer.style.visibility = 'visible';
            listContainer.style.opacity = '1';

            console.log(`ğŸ”§ ØªÙ… Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± ${attachmentItems.length} Ø¹Ù†ØµØ± Ù…Ø±ÙÙ‚`);
        }, 100);

        // Update attachment count badge if exists
        const countBadge = document.querySelector(`[data-card-key="${cardKey}"] .attachment-count`);
        if (countBadge) {
            countBadge.textContent = `${attachments.length} Ù…Ø±ÙÙ‚`;
        }

        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${attachments.length} Ù…Ø±ÙÙ‚`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:', error);
    }
}

// Check Supabase availability for card attachments
async function checkSupabaseAvailability() {
    try {
        if (!supabaseClient || typeof getCardAttachmentsEnhanced !== 'function') {
            return false;
        }

        // Test connection with a simple query
        const { error } = await supabaseClient
            .from('card_attachments')
            .select('count', { count: 'exact', head: true });

        return !error;
    } catch (error) {
        console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªÙˆÙØ± Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª:', error);
        return false;
    }
}

// Retry card upload to Supabase
async function retryCardUploadToSupabase(cardKey) {
    try {
        const localAttachments = window.cardAttachments?.[cardKey] || [];

        if (localAttachments.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
            return;
        }

        // Show progress modal
        const progressModal = document.createElement('div');
        progressModal.className = 'modal-overlay';
        progressModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-sync-alt fa-spin" style="font-size: 3rem; color: #17a2b8; margin-bottom: 1rem;"></i>
                <h3>Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
                <p>Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</p>
                <div class="progress-info">
                    <span id="syncProgress">0 Ù…Ù† ${localAttachments.length}</span>
                </div>
            </div>
        `;
        document.body.appendChild(progressModal);

        let syncedCount = 0;
        const progressElement = document.getElementById('syncProgress');

        for (const attachment of localAttachments) {
            try {
                // Convert data URL back to file
                const response = await fetch(attachment.data);
                const blob = await response.blob();
                const file = new File([blob], attachment.name, { type: attachment.type });

                // Upload to Supabase
                if (typeof uploadCardFileToSupabase === 'function') {
                    await uploadCardFileToSupabase(file, cardKey, attachment.notes);
                    syncedCount++;

                    if (progressElement) {
                        progressElement.textContent = `${syncedCount} Ù…Ù† ${localAttachments.length}`;
                    }
                }
            } catch (error) {
                console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${attachment.name}:`, error);
            }
        }

        // Remove progress modal
        progressModal.remove();

        if (syncedCount > 0) {
            // Clear local attachments after successful sync
            delete window.cardAttachments[cardKey];
            localStorage.setItem('cardAttachments', JSON.stringify(window.cardAttachments));

            // Refresh the list
            await refreshCardAttachmentsList(cardKey);

            alert(`ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${syncedCount} Ù…Ù† ${localAttachments.length} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­`);
        } else {
            alert('ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
function showCardEditModal(contractNumber, propertyName, unitNumber) {
    console.log('ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:', { contractNumber, propertyName, unitNumber });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!properties || !Array.isArray(properties)) {
        console.error('âŒ Ù…ØµÙÙˆÙØ© properties ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ showCardEditModal:', properties);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        return;
    }

    console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø© ÙÙŠ showCardEditModalØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', properties.length);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ø±ÙŠØ±Ù‡Ø§ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ù…ÙØµÙ„
    let property;
    let searchMethod = '';

    if (contractNumber && propertyName) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
        searchMethod = 'contract_and_property';
        property = properties.find(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ø¹Ù‚Ø§Ø±: Ø§Ù„Ø¹Ù‚Ø¯="${contractNumber}", Ø§Ù„Ø¹Ù‚Ø§Ø±="${propertyName}" â†’ ${property ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`);
    }

    if (!property && unitNumber && propertyName) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
        searchMethod = 'unit_and_property';
        property = properties.find(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ù„Ø¹Ù‚Ø§Ø±: Ø§Ù„ÙˆØ­Ø¯Ø©="${unitNumber}", Ø§Ù„Ø¹Ù‚Ø§Ø±="${propertyName}" â†’ ${property ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`);
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ø¬Ø±Ø¨ Ø¨Ø­Ø« Ø£ÙˆØ³Ø¹
    if (!property && unitNumber) {
        searchMethod = 'unit_only';
        property = properties.find(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber);
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙ‚Ø·: Ø§Ù„ÙˆØ­Ø¯Ø©="${unitNumber}" â†’ ${property ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`);

        if (property) {
            console.log(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ø±Ù‚Ù… ÙÙ‚Ø·ØŒ Ù„ÙƒÙ† Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø®ØªÙ„Ù: "${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† "${propertyName}"`);
        }
    }

    if (!property) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø¨Ø­Ø«');
        console.log('ğŸ“Š Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:');
        properties.forEach((p, index) => {
            console.log(`   ${index}: ÙˆØ­Ø¯Ø©="${p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}", Ø¹Ù‚Ø§Ø±="${p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}", Ø¹Ù‚Ø¯="${p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}"`);
        });

        alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\n\nØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«:\n' +
              `- Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ${contractNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n` +
              `- Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n` +
              `- Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n\n` +
              'ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
        return;
    }

    console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø·Ø±ÙŠÙ‚Ø©: ${searchMethod}`);
    console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', {
        unitNumber: property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
        propertyName: property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
        contractNumber: property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
        tenant: property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']
    });

    // âœ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯ Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±) Ù…Ø¹ ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    let relatedUnits = [];

    if (contractNumber && contractNumber.trim() !== '') {
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø¹ ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        const uniqueUnits = new Map();
        const candidateUnits = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
        candidateUnits.forEach(unit => {
            const unitKey = `${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;
            if (!uniqueUnits.has(unitKey)) {
                uniqueUnits.set(unitKey, unit);
            }
        });

        relatedUnits = Array.from(uniqueUnits.values());
        console.log(`ğŸ”— ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${relatedUnits.length} ÙˆØ­Ø¯Ø© ÙØ±ÙŠØ¯Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ "${contractNumber}" (Ù…Ù† Ø£ØµÙ„ ${candidateUnits.length})`);
    } else if (property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '') {
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø¹ ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        const uniqueUnits = new Map();
        const candidateUnits = properties.filter(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] === property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
        candidateUnits.forEach(unit => {
            const unitKey = `${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;
            if (!uniqueUnits.has(unitKey)) {
                uniqueUnits.set(unitKey, unit);
            }
        });

        relatedUnits = Array.from(uniqueUnits.values());
        console.log(`ğŸ”— ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${relatedUnits.length} ÙˆØ­Ø¯Ø© ÙØ±ÙŠØ¯Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± "${property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}" (Ù…Ù† Ø£ØµÙ„ ${candidateUnits.length})`);
    } else {
        // ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        relatedUnits = [property];
        console.log(`ğŸ“‹ ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø¯ Ø£Ùˆ Ù…Ø³ØªØ£Ø¬Ø±)`);
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ­Ø¯Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
    if (relatedUnits.length > 1) {
        console.log(`ğŸ¯ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù€ ${relatedUnits.length} ÙˆØ­Ø¯Ø©`);
        showMultiUnitEditModal(relatedUnits, property);
        return;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    console.log(`ğŸ“ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø©`);
    showSingleUnitEditModal(property, contractNumber, propertyName, unitNumber);
}

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± Ù…Ø­Ø³Ù†Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© - Ù†Ø³Ø®Ø© Ø·Ø¨Ù‚ Ø§Ù„Ø£ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¯ÙŠØ©
function showMultiUnitEditModal(relatedUnits, primaryUnit) {
    console.log(`ğŸ¯ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± Ù…Ø­Ø³Ù†Ø© Ù„Ù€ ${relatedUnits.length} ÙˆØ­Ø¯Ø©`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!ensurePropertiesLoaded('showMultiUnitEditModal')) {
        return;
    }

    const contractNumber = primaryUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '';
    const propertyName = primaryUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '';
    const tenantName = primaryUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '';
    const unitNumber = primaryUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '';

    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box property-edit-modal">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div class="edit-modal-header">
                <h2><i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ± Ø¹Ø¯Ø© ÙˆØ­Ø¯Ø§Øª</h2>
                <p>${propertyName} - ${contractNumber ? 'Ø¹Ù‚Ø¯ Ø±Ù‚Ù…: ' + contractNumber : 'Ù…Ø³ØªØ£Ø¬Ø±: ' + tenantName}</p>
                <div class="units-summary">
                    <span class="units-count"><i class="fas fa-home"></i> ${relatedUnits.length} ÙˆØ­Ø¯Ø©</span>
                    <span class="units-list">${relatedUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').join(', ')}</span>
                </div>
            </div>
            <div class="edit-modal-content">
                <form id="multiUnitEditForm" onsubmit="saveMultiUnitEdit(event)">
                    <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© - Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
                    <div class="operation-type-section">
                        <h3><i class="fas fa-cogs"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</h3>
                        <div class="form-group">
                            <label for="operationType">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                            <select id="operationType" name="operationType" required class="operation-type-select">
                                <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© --</option>
                                <option value="${OPERATION_TYPES.EDIT_DATA}">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©</option>
                                <option value="${OPERATION_TYPES.NEW_CLIENT}">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</option>
                                <option value="${OPERATION_TYPES.RENEW_CONTRACT}">ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
                                <option value="${OPERATION_TYPES.EMPTY_UNIT}">Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©</option>
                            </select>
                            <small class="field-note">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸</small>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
                    <input type="hidden" name="originalContractNumber" value="${contractNumber}">
                    <input type="hidden" name="originalPropertyName" value="${propertyName}">
                    <input type="hidden" name="originalUnitNumber" value="${unitNumber}">
                    <input type="hidden" name="unitsCount" value="${relatedUnits.length}">

                    <div class="edit-form-sections">
                        <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                        <div class="edit-section">
                            <h3><i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
                                    <input type="text" name="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" value="${primaryUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±">
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
                                    <input type="tel" name="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" value="${primaryUnit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}" placeholder="05xxxxxxxx" pattern="[0-9]{10}" maxlength="10">
                                    <small class="field-note">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª (10 Ø£Ø±Ù‚Ø§Ù…)</small>
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ:</label>
                                    <input type="tel" name="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ" value="${primaryUnit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ'] || ''}" placeholder="05xxxxxxxx" pattern="[0-9]{10}" maxlength="10">
                                    <small class="field-note">Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø«Ø§Ù†ÙŠ Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ù„Ù…Ø§Ù„Ùƒ:</label>
                                    <select name="Ø§Ù„Ù…Ø§Ù„Ùƒ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ --</option>
                                        <option value="Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯" ${(primaryUnit['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === 'Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯') ? 'selected' : ''}>Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯</option>
                                        <option value="Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…" ${(primaryUnit['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === 'Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…') ? 'selected' : ''}>Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</label>
                                    <input type="text" name="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯" value="${primaryUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯:</label>
                                    <select name="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯">
                                        <option value="Ø³ÙƒÙ†ÙŠ" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø³ÙƒÙ†ÙŠ' ? 'selected' : ''}>Ø³ÙƒÙ†ÙŠ</option>
                                        <option value="Ø¶Ø±ÙŠØ¨ÙŠ" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ' ? 'selected' : ''}>Ø¶Ø±ÙŠØ¨ÙŠ</option>
                                        <option value="Ø±Ø§ÙƒØ¶" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø±Ø§ÙƒØ¶' ? 'selected' : ''}>Ø±Ø§ÙƒØ¶</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                                    <select name="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± --</option>
                                        <option value="Ù…Ø³ØªÙˆØ¯Ø¹" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…Ø³ØªÙˆØ¯Ø¹' ? 'selected' : ''}>Ù…Ø³ØªÙˆØ¯Ø¹</option>
                                        <option value="Ø¨ÙŠØª" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø¨ÙŠØª' ? 'selected' : ''}>Ø¨ÙŠØª</option>
                                        <option value="Ø§Ø³ØªØ±Ø§Ø­Ø©" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø§Ø³ØªØ±Ø§Ø­Ø©' ? 'selected' : ''}>Ø§Ø³ØªØ±Ø§Ø­Ø©</option>
                                        <option value="Ù…ØµÙ†Ø¹" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…ØµÙ†Ø¹' ? 'selected' : ''}>Ù…ØµÙ†Ø¹</option>
                                        <option value="Ø´Ù‚Ø©" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø´Ù‚Ø©' ? 'selected' : ''}>Ø´Ù‚Ø©</option>
                                        <option value="ØºØ±ÙØ©" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'ØºØ±ÙØ©' ? 'selected' : ''}>ØºØ±ÙØ©</option>
                                        <option value="Ù…Ø¹Ø±Ø¶" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…Ø¹Ø±Ø¶' ? 'selected' : ''}>Ù…Ø¹Ø±Ø¶</option>
                                        <option value="Ù…Ø­Ù„" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…Ø­Ù„' ? 'selected' : ''}>Ù…Ø­Ù„</option>
                                        <option value="Ø­ÙˆØ´" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø­ÙˆØ´' ? 'selected' : ''}>Ø­ÙˆØ´</option>
                                        <option value="Ù…Ø²Ø±Ø¹Ø©" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…Ø²Ø±Ø¹Ø©' ? 'selected' : ''}>Ù…Ø²Ø±Ø¹Ø©</option>
                                        <option value="ÙÙ„Ø©" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'ÙÙ„Ø©' ? 'selected' : ''}>ÙÙ„Ø©</option>
                                        <option value="ÙˆØ±Ø´Ø©" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'ÙˆØ±Ø´Ø©' ? 'selected' : ''}>ÙˆØ±Ø´Ø©</option>
                                        <option value="Ø£Ø±Ø¶" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø£Ø±Ø¶' ? 'selected' : ''}>Ø£Ø±Ø¶</option>
                                        <option value="Ø¹Ù…Ø§Ø±Ø©" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø¹Ù…Ø§Ø±Ø©' ? 'selected' : ''}>Ø¹Ù…Ø§Ø±Ø©</option>
                                        <option value="Ù…ÙƒØªØ¨" ${primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…ÙƒØªØ¨' ? 'selected' : ''}>Ù…ÙƒØªØ¨</option>
                                    </select>
                                    <small class="field-note">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„ØªØµÙ†ÙŠÙ Ø£ÙØ¶Ù„</small>
                                </div>
                            </div>
                        </div>

                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„ØµÙƒ -->
                        <div class="edit-section">
                            <h3><i class="fas fa-building"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„ØµÙƒ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                                    <input type="text" name="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±" value="${primaryUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±" readonly style="background-color: #f8f9fa;">
                                    <small class="field-note">Ù„ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±ØŒ Ø§Ø³ØªØ®Ø¯Ù… "ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±" Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</small>
                                </div>
                                <div class="form-group">
                                    <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                                    <input type="text" name="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" value="${primaryUnit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || ''}" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" readonly style="background-color: #f8f9fa;">
                                    <small class="field-note">Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… "ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±" Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                                    <input type="text" name="Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© " value="${primaryUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©">
                                    <small class="field-note">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹</small>
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„ØµÙƒ:</label>
                                    <input type="text" name="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ" value="${primaryUnit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ (Ù…Â²):</label>
                                    <input type="number" name="Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ" value="${primaryUnit['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || ''}" step="0.01" placeholder="Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                                </div>
                                <div class="form-group">
                                    <label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ:</label>
                                    <input type="text" name="Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ " value="${primaryUnit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                                    <input type="url" name="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±" value="${primaryUnit['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}" placeholder="Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©">
                                    <small class="field-note">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„ Ø£Ùˆ Ø£ÙŠ Ø±Ø§Ø¨Ø· Ø¢Ø®Ø± Ù„Ù„Ù…ÙˆÙ‚Ø¹</small>
                                </div>
                            </div>
                        </div>

                        <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
                        <div class="edit-section">
                            <h3><i class="fas fa-calendar-alt"></i> Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</label>
                                    <input type="date" name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" value="${formatDateForInput(primaryUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'])}">
                                </div>
                                <div class="form-group">
                                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</label>
                                    <input type="date" name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©" value="${formatDateForInput(primaryUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'])}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·:</label>
                                    <input type="date" name="ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·" value="${formatDateForInput(primaryUnit['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'])}">
                                </div>
                                <div class="form-group">
                                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</label>
                                    <input type="number" name="Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" value="${primaryUnit['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] || ''}" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
                        <div class="edit-section">
                            <h3><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</label>
                                    <input type="number" name="Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± " value="${primaryUnit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || ''}" step="0.01" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±">
                                </div>
                                <div class="form-group">
                                    <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</label>
                                    <input type="number" name="Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰" value="${primaryUnit['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || ''}" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">
                                </div>
                            </div>
                        </div>

                        <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø· -->
                        <div class="edit-section">
                            <h3><i class="fas fa-calendar-check"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h3>
                            <div class="installments-management">
                                <div class="installments-header">
                                    <p class="section-description">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø¹ ØªÙˆØ§Ø±ÙŠØ®Ù‡Ø§ ÙˆÙ…Ø¨Ø§Ù„ØºÙ‡Ø§</p>
                                    <div class="total-display" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 10px; border-radius: 6px; margin: 10px 0; text-align: center; font-weight: bold; color: #1976d2;">
                                        ${(() => {
                                            const yearlyData = calculateYearlyTotal(primaryUnit);
                                            return `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${yearlyData.total.toLocaleString()} Ø±ÙŠØ§Ù„ (${yearlyData.count} Ø£Ù‚Ø³Ø§Ø·)`;
                                        })()}
                                    </div>
                                    <button type="button" onclick="addNewInstallment()" class="btn-add-installment">
                                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· Ø¬Ø¯ÙŠØ¯
                                    </button>
                                </div>
                                <div id="installmentsContainer" class="installments-container">
                                    ${renderInstallmentsForEdit(primaryUnit)}
                                </div>
                            </div>
                        </div>

                        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© -->
                        <div class="edit-section">
                            <h3><i class="fas fa-home"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Â²):</label>
                                    <input type="number" name="Ø§Ù„Ù…Ø³Ø§Ø­Ø©" value="${primaryUnit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || ''}" step="0.01" placeholder="Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                                    <small class="field-note">Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø¹Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ)</small>
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡:</label>
                                    <input type="text" name="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡" value="${primaryUnit['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] || ''}" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ù„Ø§Ø±ØªÙØ§Ø¹:</label>
                                    <input type="text" name="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" value="${primaryUnit['Ø§Ù„Ø§Ø±ØªÙØ§Ø¹'] || ''}" placeholder="Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø©">
                                </div>
                                <div class="form-group">
                                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                                    <input type="text" name="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©" value="${primaryUnit['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©'] || ''}" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©">
                                </div>
                            </div>
                        </div>

                        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª -->
                        <div class="edit-section">
                            <h3><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:</label>
                                    <textarea name="notes" rows="4" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ø§Ù…Ø© Ø­ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...">${primaryUnit['notes'] || ''}</textarea>
                                    <small class="field-note">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ù‡Ù…Ø© Ø­ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</small>
                                </div>
                            </div>
                        </div>

                        <!-- Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª -->
                        <div class="edit-section">
                            <h3><i class="fas fa-link"></i> Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
                            <div class="units-linking-section">
                                <p class="section-description">ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø· ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„ØªØ¬Ù…ÙŠØ¹Ù‡Ø§ ØªØ­Øª Ø¹Ù‚Ø¯ ÙˆØ§Ø­Ø¯</p>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø·:</label>
                                        <div id="availableUnitsForLinking" class="units-linking-list">
                                            ${renderAvailableUnitsForLinking(propertyName, contractNumber, unitNumber)}
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:</label>
                                        <div id="linkedUnitsDisplay" class="linked-units-display">
                                            ${renderLinkedUnits(propertyName, contractNumber)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© -->
                    <input type="hidden" name="originalContractNumber" value="${contractNumber || ''}">
                    <input type="hidden" name="originalPropertyName" value="${propertyName}">
                    <input type="hidden" name="originalUnitNumber" value="${unitNumber || ''}">

                    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ù„ØºØ§Ø¡ -->
                    <div class="edit-modal-actions">
                        <div class="action-group primary-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                            </button>
                            <button type="button" onclick="emptyUnit('${contractNumber || ''}', '${propertyName}', '${unitNumber || ''}')" class="btn-danger">
                                <i class="fas fa-broom"></i> Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø©
                            </button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">
                                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰
    window.currentEditingUnits = relatedUnits;
    window.currentPrimaryUnit = primaryUnit;
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø· - Ù…Ø­Ø³Ù† Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø±
function updateAvailableUnitsForLinking() {
    const availableUnitsDiv = document.getElementById('availableUnitsForLinking');
    if (!availableUnitsDiv) return;

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø±
    const currentPropertyName = window.currentPrimaryUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
    const currentLinkedUnits = window.currentEditingUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);

    const allUnitsInProperty = window.allData.filter(unit =>
        unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentPropertyName &&
        !currentLinkedUnits.includes(unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '])
    );

    if (allUnitsInProperty.length === 0) {
        availableUnitsDiv.innerHTML = `
            <div class="no-units-message">
                <i class="fas fa-info-circle"></i>
                Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø· ÙÙŠ Ø¹Ù‚Ø§Ø± "${currentPropertyName}"
            </div>`;
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø³Ù†Ø© + Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
    availableUnitsDiv.innerHTML = `
        <div class="unit-linking-section">
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹ -->
            <div class="quick-selection-section">
                <h4><i class="fas fa-mouse-pointer"></i> Ø§Ø®ØªÙŠØ§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª:</h4>
                <div class="selection-controls">
                    <div class="dropdown-selection">
                        <label for="unitSelector">Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø© Ù„Ù„Ø±Ø¨Ø·:</label>
                        <select id="unitSelector" class="unit-selector">
                            <option value="">-- Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø© --</option>
                            ${allUnitsInProperty.map(unit => `
                                <option value="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}"
                                        data-tenant="${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}"
                                        data-status="${calculateStatus(unit).final || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}">
                                    ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] ? '- ' + unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] : '- ÙØ§Ø±Øº'}
                                </option>
                            `).join('')}
                        </select>
                        <button type="button" onclick="linkSelectedUnit()" class="btn-link-selected" title="Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
                            <i class="fas fa-link"></i> Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                        </button>
                    </div>

                    <div class="bulk-actions">
                        <button type="button" onclick="showBulkLinkingOptions()" class="btn-bulk-link" title="Ø±Ø¨Ø· Ù…ØªØ¹Ø¯Ø¯">
                            <i class="fas fa-layer-group"></i> Ø±Ø¨Ø· Ù…ØªØ¹Ø¯Ø¯
                        </button>
                        <button type="button" onclick="linkAllEmptyUnits()" class="btn-link-all-empty" title="Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©">
                            <i class="fas fa-link"></i> Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ§Ø±ØºØ©
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ -->
            <div class="detailed-units-section">
                <h4><i class="fas fa-list"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (${allUnitsInProperty.length} ÙˆØ­Ø¯Ø©):</h4>
                <div class="units-grid">
                    ${allUnitsInProperty.map(unit => `
                        <div class="available-unit-item" data-unit-number="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}">
                            <div class="unit-info">
                                <div class="unit-header">
                                    <i class="fas fa-home"></i>
                                    <span class="unit-number">ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                    <span class="unit-status ${getUnitStatusClass(unit)}">${calculateStatus(unit).final || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                </div>
                                <div class="unit-details">
                                    <span class="unit-tenant">
                                        <i class="fas fa-user"></i>
                                        ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] ? unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] : 'ÙØ§Ø±Øº'}
                                    </span>
                                    ${unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] ? `
                                        <span class="unit-rent">
                                            <i class="fas fa-money-bill-wave"></i>
                                            ${parseFloat(unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']).toLocaleString()} Ø±ÙŠØ§Ù„
                                        </span>
                                    ` : ''}
                                    ${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? `
                                        <span class="unit-area">
                                            <i class="fas fa-expand-arrows-alt"></i>
                                            ${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']} Ù…Â²
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="unit-actions">
                                <button type="button" onclick="linkUnitToGroup('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}')"
                                        class="btn-link-unit ${!unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] ? 'empty-unit' : 'occupied-unit'}"
                                        title="Ø±Ø¨Ø· Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©">
                                    <i class="fas fa-link"></i> Ø±Ø¨Ø·
                                </button>
                                <button type="button" onclick="previewUnitLinking('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}')"
                                        class="btn-preview-unit" title="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¨Ø·">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    const unitSelector = document.getElementById('unitSelector');
    if (unitSelector) {
        unitSelector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const linkButton = document.querySelector('.btn-link-selected');

            if (this.value) {
                linkButton.disabled = false;
                linkButton.innerHTML = `<i class="fas fa-link"></i> Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© ${this.value}`;

                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                const tenant = selectedOption.getAttribute('data-tenant');
                const status = selectedOption.getAttribute('data-status');

                linkButton.title = `Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© ${this.value} - ${tenant || 'ÙØ§Ø±Øº'} - ${status}`;
            } else {
                linkButton.disabled = true;
                linkButton.innerHTML = '<i class="fas fa-link"></i> Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©';
                linkButton.title = 'Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹';
            }
        });
    }
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
function refreshAvailableUnits() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©');
    updateAvailableUnitsForLinking();
}

// Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
function linkSelectedUnit() {
    const unitSelector = document.getElementById('unitSelector');
    if (!unitSelector || !unitSelector.value) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }

    const selectedUnitNumber = unitSelector.value;
    console.log(`ğŸ”— Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: ${selectedUnitNumber}`);

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·
    linkUnitToGroup(selectedUnitNumber);

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¨Ø·
    setTimeout(() => {
        unitSelector.value = '';
        const linkButton = document.querySelector('.btn-link-selected');
        if (linkButton) {
            linkButton.disabled = true;
            linkButton.innerHTML = '<i class="fas fa-link"></i> Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©';
        }
    }, 1000);
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°
function previewUnitLinking(unitNumber) {
    const unitToPreview = window.allData.find(unit =>
        unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
        unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === window.currentPrimaryUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
    );

    if (!unitToPreview) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    const primaryUnit = window.currentPrimaryUnit;

    const previewMessage = `ğŸ” Ù…Ø¹Ø§ÙŠÙ†Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©

ğŸ  Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡Ø§: ${unitNumber}
ğŸ“ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${unitToPreview['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${unitToPreview['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${unitToPreview['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ÙØ§Ø±Øº'}

â¬‡ï¸ Ø³ØªØµØ¨Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¨Ø·:
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${primaryUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${primaryUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ÙØ§Ø±Øº'}
ğŸ’° Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${primaryUnit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] ? parseFloat(primaryUnit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']).toLocaleString() + ' Ø±ÙŠØ§Ù„' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø±Ø¨Ø·ØŸ`;

    if (confirm(previewMessage)) {
        linkUnitToGroup(unitNumber);
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
function showBulkLinkingOptions() {
    const currentPropertyName = window.currentPrimaryUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
    const currentLinkedUnits = window.currentEditingUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);

    const availableUnits = window.allData.filter(unit =>
        unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentPropertyName &&
        !currentLinkedUnits.includes(unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '])
    );

    if (availableUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø·');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2><i class="fas fa-layer-group"></i> Ø±Ø¨Ø· Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„ÙˆØ­Ø¯Ø§Øª</h2>
                <p>Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø±Ø¨Ø·Ù‡Ø§ Ù…Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</p>
            </div>
            <div class="modal-body">
                <div class="bulk-selection-info">
                    <p><strong>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</strong> ${window.currentPrimaryUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}</p>
                    <p><strong>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</strong> ${window.currentPrimaryUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}</p>
                    <p><strong>Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${window.currentPrimaryUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ÙØ§Ø±Øº'}</p>
                </div>

                <div class="units-selection">
                    <h4>Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø±Ø¨Ø·:</h4>
                    <div class="selection-controls">
                        <button type="button" onclick="selectAllUnits()" class="btn-select-all">
                            <i class="fas fa-check-square"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                        </button>
                        <button type="button" onclick="selectEmptyUnits()" class="btn-select-empty">
                            <i class="fas fa-square"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§Ø±ØºØ© ÙÙ‚Ø·
                        </button>
                        <button type="button" onclick="clearAllSelections()" class="btn-clear-all">
                            <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                        </button>
                    </div>

                    <div class="units-checklist">
                        ${availableUnits.map(unit => `
                            <div class="unit-checkbox-item">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}" class="unit-checkbox">
                                    <span class="checkmark"></span>
                                    <div class="unit-info">
                                        <span class="unit-number">ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}</span>
                                        <span class="unit-details">
                                            ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] ? unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] : 'ÙØ§Ø±Øº'} -
                                            ${calculateStatus(unit).final || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                                        </span>
                                    </div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="executeBulkLinking()">
                    <i class="fas fa-link"></i> Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                </button>
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
async function linkAllEmptyUnits() {
    const currentPropertyName = window.currentPrimaryUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
    const currentLinkedUnits = window.currentEditingUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);

    const emptyUnits = window.allData.filter(unit =>
        unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentPropertyName &&
        !currentLinkedUnits.includes(unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']) &&
        (!unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === '')
    );

    if (emptyUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø·');
        return;
    }

    const confirmMessage = `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©ØŸ

Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${emptyUnits.length} ÙˆØ­Ø¯Ø©
Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${emptyUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']).join(', ')}

Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    console.log(`ğŸ”— Ø¨Ø¯Ø¡ Ø±Ø¨Ø· ${emptyUnits.length} ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ©...`);

    let successCount = 0;
    let failCount = 0;
    const results = [];

    for (const unit of emptyUnits) {
        try {
            console.log(`ğŸ”— Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}...`);
            await linkUnitToGroup(unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);
            successCount++;
            results.push({ unit: unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '], success: true });
        } catch (error) {
            console.error(`âŒ ÙØ´Ù„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
            failCount++;
            results.push({ unit: unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '], success: false, error: error.message });
        }

        // ØªÙˆÙ‚Ù Ù‚ØµÙŠØ± Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ø¨Ø·
        await new Promise(resolve => setTimeout(resolve, 500));
    }

    const resultMessage = `ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©!

âœ… Ù†Ø¬Ø­: ${successCount} ÙˆØ­Ø¯Ø©
âŒ ÙØ´Ù„: ${failCount} ÙˆØ­Ø¯Ø©

${results.map(r => `${r.success ? 'âœ…' : 'âŒ'} ${r.unit}`).join('\n')}

${successCount > 0 ? 'ğŸ”— ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø© ÙÙŠ Supabase' : ''}`;

    alert(resultMessage);
    showToast(`ØªÙ… Ø±Ø¨Ø· ${successCount} ÙˆØ­Ø¯Ø© Ù…Ù† Ø£ØµÙ„ ${emptyUnits.length}`, successCount > 0 ? 'success' : 'error');
}

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
function selectAllUnits() {
    const checkboxes = document.querySelectorAll('.unit-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function selectEmptyUnits() {
    const checkboxes = document.querySelectorAll('.unit-checkbox');
    checkboxes.forEach(checkbox => {
        const unitNumber = checkbox.value;
        const unit = window.allData.find(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber);
        checkbox.checked = !unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === '';
    });
}

function clearAllSelections() {
    const checkboxes = document.querySelectorAll('.unit-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
async function executeBulkLinking() {
    const selectedCheckboxes = document.querySelectorAll('.unit-checkbox:checked');

    if (selectedCheckboxes.length === 0) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
    }

    const selectedUnits = Array.from(selectedCheckboxes).map(cb => cb.value);

    const confirmMessage = `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŸ

Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${selectedUnits.length} ÙˆØ­Ø¯Ø©
Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${selectedUnits.join(', ')}

Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    closeModal();

    console.log(`ğŸ”— Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ù„Ù€ ${selectedUnits.length} ÙˆØ­Ø¯Ø©...`);

    let successCount = 0;
    let failCount = 0;
    const results = [];

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    const loadingMessage = document.createElement('div');
    loadingMessage.className = 'loading-overlay';
    loadingMessage.innerHTML = `
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>Ø¬Ø§Ø±ÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª...</h3>
            <p>ØªÙ… Ø±Ø¨Ø· <span id="progressCount">0</span> Ù…Ù† ${selectedUnits.length} ÙˆØ­Ø¯Ø©</p>
        </div>
    `;
    document.body.appendChild(loadingMessage);

    for (let i = 0; i < selectedUnits.length; i++) {
        const unitNumber = selectedUnits[i];
        try {
            console.log(`ğŸ”— Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} (${i + 1}/${selectedUnits.length})...`);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            const progressCount = document.getElementById('progressCount');
            if (progressCount) {
                progressCount.textContent = i;
            }

            await linkUnitToGroup(unitNumber);
            successCount++;
            results.push({ unit: unitNumber, success: true });

            console.log(`âœ… Ù†Ø¬Ø­ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        } catch (error) {
            console.error(`âŒ ÙØ´Ù„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
            failCount++;
            results.push({ unit: unitNumber, success: false, error: error.message });
        }

        // ØªÙˆÙ‚Ù Ù‚ØµÙŠØ± Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ø¨Ø·
        await new Promise(resolve => setTimeout(resolve, 800));
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.body.removeChild(loadingMessage);

    const resultMessage = `ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯!

âœ… Ù†Ø¬Ø­: ${successCount} ÙˆØ­Ø¯Ø©
âŒ ÙØ´Ù„: ${failCount} ÙˆØ­Ø¯Ø©

Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©:
${results.map(r => `${r.success ? 'âœ…' : 'âŒ'} ÙˆØ­Ø¯Ø© ${r.unit}${r.error ? ' - ' + r.error : ''}`).join('\n')}

${successCount > 0 ? 'ğŸ”— ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø© ÙÙŠ Supabase' : ''}`;

    alert(resultMessage);
    showToast(`ØªÙ… Ø±Ø¨Ø· ${successCount} ÙˆØ­Ø¯Ø© Ù…Ù† Ø£ØµÙ„ ${selectedUnits.length}`, successCount > 0 ? 'success' : 'error');
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.linkSelectedUnit = linkSelectedUnit;
window.previewUnitLinking = previewUnitLinking;
window.showBulkLinkingOptions = showBulkLinkingOptions;
window.linkAllEmptyUnits = linkAllEmptyUnits;
window.selectAllUnits = selectAllUnits;
window.selectEmptyUnits = selectEmptyUnits;
window.clearAllSelections = clearAllSelections;
window.executeBulkLinking = executeBulkLinking;

// Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© - Ù…Ø­Ø³Ù† Ù…Ø¹ Ø­ÙØ¸ ÙÙŠ Supabase
async function linkUnitToGroup(unitNumber) {
    if (!unitNumber) {
        alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
    }

    console.log(`ğŸ”— Ø¨Ø¯Ø¡ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©...`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const unitToLink = window.allData.find(unit =>
        unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
        unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === window.currentPrimaryUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
    );

    if (!unitToLink) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
    const alreadyLinked = window.currentEditingUnits.some(unit =>
        unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
    );

    if (alreadyLinked) {
        alert('Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
    }

    try {
        // ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¬Ø¯ÙŠØ¯: Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©
        const primaryUnit = window.currentPrimaryUnit;
        if (primaryUnit) {
            console.log(`ğŸ“ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ${primaryUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© ${unitNumber}`);

            // Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const fieldsToSync = [
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
                'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
                'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰',
                'Ø§Ù„Ù…Ø§Ù„Ùƒ',
                'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ',
                'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ',
                'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ',
                'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'
            ];

            fieldsToSync.forEach(field => {
                if (primaryUnit[field] !== undefined && primaryUnit[field] !== null) {
                    unitToLink[field] = primaryUnit[field];
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹
            updateLocalDataForUnit(unitToLink);
            console.log(`âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
        window.currentEditingUnits.push(unitToLink);

        console.log(`ğŸ”— ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù„ÙŠØ§Ù‹`);

        // ğŸš€ Ù…Ø­Ø³Ù†: Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø· ÙÙŠ Supabase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        console.log(`â˜ï¸ Ø¨Ø¯Ø¡ Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase...`);

        let supabaseSuccess = false;
        let supabaseError = null;

        if (!supabaseClient) {
            supabaseError = 'Supabase ØºÙŠØ± Ù…ØªØµÙ„';
            console.error(`âŒ ${supabaseError}`);
        } else {
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ linkRealUnitsInSupabase Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                console.log(`ğŸ“‹ ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù„Ù„Ø­ÙØ¸...`);

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
                const { data: existingUnit, error: searchError } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('unit_number', unitNumber)
                    .eq('property_name', unitToLink['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
                    .single();

                if (searchError) {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©: ${searchError.message}`);
                }

                if (!existingUnit) {
                    throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase`);
                }

                // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                const updatedData = {
                    tenant_name: unitToLink['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
                    contract_number: unitToLink['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '',
                    rent_value: parseFloat(unitToLink['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']) || null,
                    contract_type: unitToLink['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø³ÙƒÙ†ÙŠ',
                    start_date: unitToLink['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] || null,
                    end_date: unitToLink['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || null,
                    total_amount: parseFloat(unitToLink['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) || null,
                    owner: unitToLink['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || '',
                    deed_number: unitToLink['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || '',
                    real_estate_registry: unitToLink['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || '',
                    electricity_account: unitToLink['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] || '',
                    remaining_installments: parseInt(unitToLink['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©']) || null,
                    first_installment_date: unitToLink['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] || null,
                    first_installment_amount: parseFloat(unitToLink['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„']) || null,
                    second_installment_date: unitToLink['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] || null,
                    second_installment_amount: parseFloat(unitToLink['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ']) || null,
                    installment_end_date: unitToLink['ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] || null,
                    updated_at: new Date().toISOString()
                };

                console.log(`ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¶Ø±Ø© Ù„Ù„Ø­ÙØ¸:`, {
                    unit_number: unitNumber,
                    tenant_name: updatedData.tenant_name,
                    contract_number: updatedData.contract_number,
                    rent_value: updatedData.rent_value
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
                const { data: updatedUnit, error: updateError } = await supabaseClient
                    .from('properties')
                    .update(updatedData)
                    .eq('id', existingUnit.id)
                    .select();

                if (updateError) {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø©: ${updateError.message}`);
                }

                if (!updatedUnit || updatedUnit.length === 0) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«');
                }

                console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­ - ID: ${updatedUnit[0].id}`);
                supabaseSuccess = true;

            } catch (error) {
                supabaseError = error.message;
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase:`, error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        updateLinkedUnitsDisplay();
        updateAvailableUnitsForLinking();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸
        const message = supabaseSuccess
            ? `âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!\n\nâ˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©\nğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©\n\nğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase Dashboard`
            : `âš ï¸ ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·\n\nâŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ: ${supabaseError}\nğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©\n\nğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹`;

        alert(message);

        // Ø¥Ø¸Ù‡Ø§Ø± toast Ù„Ù„ØªØ£ÙƒÙŠØ¯
        const toastMessage = supabaseSuccess
            ? `ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­`
            : `ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· - ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ`;

        showToast(toastMessage, supabaseSuccess ? 'success' : 'warning');

        console.log(`ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} - Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ: ${supabaseSuccess ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„'}`);

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:\n\n${error.message}`);
        showToast(`ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`, 'error');
    }
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
function getCurrentFormData() {
    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø´Ø· (Ø³ÙˆØ§Ø¡ ÙØ±Ø¯ÙŠ Ø£Ùˆ Ù…ØªØ¹Ø¯Ø¯)
        const multiForm = document.getElementById('multiUnitEditForm');
        const singleForm = document.getElementById('propertyEditForm');

        const activeForm = multiForm || singleForm;

        if (!activeForm) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ù†Ø´Ø·');
            return null;
        }

        const formData = new FormData(activeForm);
        console.log('ğŸ“‹ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø´Ø·');
        return formData;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
        return null;
    }
}

// ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© Ù…Ø¹ÙŠÙ†Ø©
function applyFormDataToUnit(unit, formData) {
    try {
        console.log(`ğŸ“ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„Ø¹Ù‚Ø¯)
        const fieldsToApply = [
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
            'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
            'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ',
            'Ø§Ù„Ù…Ø§Ù„Ùƒ',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
            'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·',
            'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©',
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ',
            'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰',
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ',
            'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ',
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ',
            'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±',
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©',
            'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
            'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹',
            'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©'
        ];

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        fieldsToApply.forEach(field => {
            const value = formData.get(field);
            if (value !== null && value !== undefined) {
                unit[field] = value;
                console.log(`   âœ… ${field}: "${value}"`);
            }
        });

        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!)
        const originalUnitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
        unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
        unit['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = 'Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        unit['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();

        console.log(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${originalUnitNumber} Ø¨Ù†Ø¬Ø§Ø­`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©:', error);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©
function updateLocalDataForUnit(unit) {
    try {
        const unitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
        const propertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

        // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù…ØµÙÙˆÙØ© properties Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const propertiesIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        if (propertiesIndex !== -1) {
            properties[propertiesIndex] = { ...unit };
            console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ properties`);
        }

        // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù…ØµÙÙˆÙØ© allData Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (window.allData && Array.isArray(window.allData)) {
            const allDataIndex = window.allData.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
            );

            if (allDataIndex !== -1) {
                window.allData[allDataIndex] = { ...unit };
                console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ allData`);
            }
        }

        // Ø­ÙØ¸ ÙÙŠ localStorage
        localStorage.setItem('propertyData', JSON.stringify(properties));
        console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ localStorage`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
    }
}

// ÙØµÙ„ ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
async function unlinkUnitFromGroup(unitNumber) {
    if (!unitNumber) {
        console.error('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
    }

    if (window.currentEditingUnits.length <= 1) {
        console.error('Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ­ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©');
        return;
    }

    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ

âš ï¸ Ø³ÙŠØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©:
â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
â€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±
â€¢ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯
â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰

â˜ï¸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥ÙØ±Ø§Øº ÙÙˆØ±Ø§Ù‹ ÙÙŠ Supabase
ğŸ“± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;
    if (!confirm(confirmMessage)) {
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ÙØµÙ„Ù‡Ø§
    const unitToUnlink = window.currentEditingUnits.find(unit =>
        unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
    );

    if (!unitToUnlink) {
        console.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©');
        return;
    }

    console.log(`ğŸ”“ Ø¨Ø¯Ø¡ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©...`);

    try {
        // 1. Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase Ù…Ø¨Ø§Ø´Ø±Ø©
        console.log('â˜ï¸ Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase...');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Supabase
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
        const { data: unitInSupabase, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', unitToUnlink['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
            .single();

        if (searchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©: ${searchError.message}`);
        }

        if (!unitInSupabase) {
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase`);
        }

        // Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
        const emptyData = {
            tenant_name: '',
            contract_number: '',
            rent_value: null,
            contract_type: null,
            start_date: null,
            end_date: null,
            total_amount: null,
            owner: '',
            deed_number: '',
            real_estate_registry: '',
            electricity_account: '',
            remaining_installments: null,
            first_installment_date: null,
            first_installment_amount: null,
            second_installment_date: null,
            second_installment_amount: null,
            installment_end_date: null,
            updated_at: new Date().toISOString()
        };

        console.log(`ğŸ“‹ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}...`);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
        const { data: updatedUnit, error: updateError } = await supabaseClient
            .from('properties')
            .update(emptyData)
            .eq('id', unitInSupabase.id)
            .select();

        if (updateError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©: ${updateError.message}`);
        }

        if (!updatedUnit || updatedUnit.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙØ±Ø§Øº');
        }

        console.log(`âœ… ØªÙ… Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­`);

        // 2. Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
        if (typeof protectUnlinkedUnit === 'function') {
            protectUnlinkedUnit(unitNumber, unitToUnlink['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
            console.log(`ğŸ”’ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©`);
        }

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ±ØºØ©
        const localUnitIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === unitToUnlink['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
        );

        if (localUnitIndex !== -1) {
            // Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            properties[localUnitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = '';
            properties[localUnitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = '';
            properties[localUnitIndex]['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] = '';
            properties[localUnitIndex]['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] = '';
            properties[localUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] = '';
            properties[localUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] = '';
            properties[localUnitIndex]['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = '';
            properties[localUnitIndex]['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = '';
            properties[localUnitIndex]['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] = '';
            properties[localUnitIndex]['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] = '';
            properties[localUnitIndex]['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] = '';
            properties[localUnitIndex]['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] = '';
            properties[localUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] = '';
            properties[localUnitIndex]['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] = '';
            properties[localUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] = '';
            properties[localUnitIndex]['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] = '';
            properties[localUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] = '';

            saveDataLocally();
            console.log('âœ… ØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©');
        }

        // 4. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
        window.currentEditingUnits = window.currentEditingUnits.filter(unit =>
            unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] !== unitNumber
        );

        console.log(`âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ©`);

        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        updateLinkedUnitsDisplay();
        updateAvailableUnitsForLinking();

        // 5. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…ÙØµÙ„Ø©
        const successMessage = `ğŸ‰ ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!

âœ… ØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº
â€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº
â€¢ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯: ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº
â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·: ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº

â˜ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥ÙØ±Ø§Øº ÙÙŠ Supabase
ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
ğŸ”“ Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ØµØ¨Ø­Øª ÙØ§Ø±ØºØ© ÙˆÙ…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø·

ğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Supabase Dashboard`;

        alert(successMessage);
        showToast(`ØªÙ… ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©:', error.message);
    }
}

// ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function unlinkAllUnits() {
    if (window.currentEditingUnits.length <= 1) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„ÙØµÙ„');
        return;
    }

    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§ØªØŸ\n\nØ³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·.`;
    if (!confirm(confirmMessage)) {
        return;
    }

    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
    const primaryUnit = window.currentPrimaryUnit;
    window.currentEditingUnits = [primaryUnit];

    console.log('ğŸ”“ ØªÙ… ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª');

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    updateLinkedUnitsDisplay();
    updateAvailableUnitsForLinking();

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showSuccessMessage('ØªÙ… Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·');
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
function updateLinkedUnitsDisplay() {
    const linkedUnitsDiv = document.getElementById('linkedUnitsDisplay');
    if (!linkedUnitsDiv) return;

    const relatedUnits = window.currentEditingUnits;

    linkedUnitsDiv.innerHTML = relatedUnits.map((unit, index) => `
        <div class="linked-unit-item" data-unit-number="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}" data-unit-index="${index}">
            <div class="unit-info">
                <i class="fas fa-home"></i>
                <span class="unit-number">ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                <span class="unit-tenant">${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] ? ` - ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}` : ' - ÙØ§Ø±Øº'}</span>
                <span class="unit-status ${getUnitStatusClass(unit)}">${calculateStatus(unit).final || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
            </div>
            <div class="unit-actions">
                <button type="button" onclick="clearUnitData('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}')" class="btn-clear-unit" title="Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©">
                    <i class="fas fa-trash-alt"></i> Ø¥ÙØ±Ø§Øº
                </button>
                ${relatedUnits.length > 1 ? `
                    <button type="button" onclick="unlinkUnitFromGroup('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}')" class="btn-unlink-unit" title="ÙØµÙ„ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©">
                        <i class="fas fa-unlink"></i> ÙØµÙ„
                    </button>
                ` : `
                    <span class="primary-unit-badge">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</span>
                `}
            </div>
        </div>
    `).join('');

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    const label = linkedUnitsDiv.previousElementSibling;
    if (label && label.tagName === 'LABEL') {
        label.textContent = `Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ (${relatedUnits.length} ÙˆØ­Ø¯Ø©):`;
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function showUnitLinkingModal() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹
    updateAvailableUnitsForLinking();

    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
    const availableUnitsDiv = document.getElementById('availableUnitsForLinking');
    if (availableUnitsDiv) {
        availableUnitsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
        availableUnitsDiv.style.border = '2px solid #007bff';
        availableUnitsDiv.style.borderRadius = '8px';
        availableUnitsDiv.style.padding = '10px';

        setTimeout(() => {
            availableUnitsDiv.style.border = '';
            availableUnitsDiv.style.borderRadius = '';
            availableUnitsDiv.style.padding = '';
        }, 3000);
    }
}

// Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© - Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
async function saveMultiUnitEdit(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const operationType = formData.get('operationType');

    if (!operationType) {
        alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!ensurePropertiesLoaded('saveMultiUnitEdit')) {
        return;
    }

    console.log(`ğŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©`);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const newUnitNumber = formData.get('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ');
    const primaryUnit = window.currentPrimaryUnit;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… (Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
    showProgressModal(`Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©...`, async function(updateProgress) {
        try {
            let successCount = 0;
            let errorCount = 0;

            console.log(`ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­ÙØ¸Ù‡Ø§: ${window.currentEditingUnits.length}`);
            console.log('ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', window.currentEditingUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']));

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¹Ù„Ù‰ ÙƒÙ„ ÙˆØ­Ø¯Ø©
            for (let i = 0; i < window.currentEditingUnits.length; i++) {
                const unit = window.currentEditingUnits[i];
                const isPrimaryUnit = (unit === primaryUnit);
                const progress = Math.round(((i + 1) / window.currentEditingUnits.length) * 100);

                updateProgress(progress, `Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || (i + 1)}...`);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØµÙˆÙ„Ø©
                const unitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
                const propertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

                if (typeof isUnitProtected === 'function' && isUnitProtected(unitNumber, propertyName)) {
                    console.log(`ğŸ”’ ØªØ®Ø·ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ù…ÙŠØ©: ${unitNumber} (ØªÙ… ÙØµÙ„Ù‡Ø§ Ù…Ø¤Ø®Ø±Ø§Ù‹)`);
                    successCount++;
                    continue; // ØªØ®Ø·ÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©
                }

                try {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ù† formData Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    const unitFormData = new FormData();

                    // Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ØµÙ„ÙŠ
                    for (let [key, value] of formData.entries()) {
                        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
                        if (key === 'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ') {
                            if (isPrimaryUnit) {
                                // Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                                unitFormData.append(key, newUnitNumber);
                                console.log(`ğŸ“ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø¥Ù„Ù‰ "${newUnitNumber}"`);
                            } else {
                                // Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰: Ø§Ø­ØªÙØ¸ Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠ
                                unitFormData.append(key, unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '');
                                console.log(`ğŸ“ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}: Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠ`);
                            }
                        } else {
                            // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„: Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                            unitFormData.append(key, value);
                        }
                    }

                    // ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
                    if (!isPrimaryUnit) {
                        console.log(`ğŸ”„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
                        applyFormDataToUnit(unit, unitFormData);
                    }

                    // Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡Ø§
                    await savePropertyEditForUnit(unit, unitFormData, operationType, isPrimaryUnit);
                    successCount++;
                } catch (error) {
                    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
                    errorCount++;
                }

                // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø­ÙØ¸Ø§Øª
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ©
            const protectedCount = window.currentEditingUnits.filter(unit => {
                const unitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
                const propertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
                return typeof isUnitProtected === 'function' && isUnitProtected(unitNumber, propertyName);
            }).length;

            let message = `ØªÙ… Ø­ÙØ¸ ${successCount} ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­`;

            if (protectedCount > 0) {
                message += `\nğŸ”’ ØªÙ… ØªØ®Ø·ÙŠ ${protectedCount} ÙˆØ­Ø¯Ø© Ù…ÙØµÙˆÙ„Ø© (Ù…Ø­Ù…ÙŠØ© Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©)`;
            }

            if (errorCount > 0) {
                message += `\nÙØ´Ù„ Ø­ÙØ¸ ${errorCount} ÙˆØ­Ø¯Ø©`;
            }

            return {
                success: errorCount === 0,
                message: message
            };
        } catch (error) {
            return {
                success: false,
                message: `Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${error.message}`
            };
        }
    }, function(result) {
        if (result.success) {
            showSuccessMessage('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª!', result.message);
            closeModal();
            if (typeof displayProperties === 'function') {
                displayProperties();
            }
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¯ÙˆÙ† Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            renderData();
            updateTotalStats();
        } else {
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', result.message);
        }
    });
}

// Ø­ÙØ¸ ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©
async function savePropertyEditForUnit(unit, formData, operationType) {
    const originalContractNumber = unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '';
    const originalPropertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '';
    const originalUnitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '';

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!ensurePropertiesLoaded('savePropertyEditForUnit')) {
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
    const propertyIndex = properties.findIndex(p =>
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === originalContractNumber &&
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName &&
        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === originalUnitNumber
    );

    if (propertyIndex === -1) {
        throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${originalUnitNumber}`);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    const originalData = { ...properties[propertyIndex] };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const updatedProperty = { ...properties[propertyIndex] };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©)
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('original') || key === 'operationType' || key === 'unitsCount') continue;

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
        if (key.includes('ØªØ§Ø±ÙŠØ®') && value && !key.includes('Ø§Ù„Ù‚Ø³Ø·')) {
            const dateParts = value.split('-');
            if (dateParts.length === 3 && dateParts[0].length === 4) {
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);

                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const testDate = new Date(year, month - 1, day, 12, 0, 0);
                    if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                        value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                    } else {
                        value = null;
                    }
                } else {
                    value = null;
                }
            }
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        if (['Ø§Ù„Ù…Ø³Ø§Ø­Ø©', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'].includes(key) && value) {
            value = parseFloat(value) || 0;
        }

        if (key === 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©') {
            value = parseInt(value) || 0;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø©
        updatedProperty[key] = value || '';
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
    updatedProperty['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
    updatedProperty['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = operationType || 'ØªØ­Ø±ÙŠØ± Ù…ØªØ¹Ø¯Ø¯';
    updatedProperty['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
    properties[propertyIndex] = updatedProperty;

    // ğŸ”§ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù‚Ø¯
    if (updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] && updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'].trim() !== '') {
        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}...`);
        try {
            await updateLinkedUnitsOnEdit(updatedProperty);
        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©:`, error);
        }
    }

    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    localStorage.setItem('propertyData', JSON.stringify(properties));

    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
    if (window.supabaseEnabled && typeof saveToSupabase === 'function') {
        await saveToSupabase(updatedProperty);
    }

    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    try {
        const changes = compareDataAndCreateChanges(originalData, updatedProperty);

        let additionalInfo = {
            originalData: originalData,
            newData: updatedProperty,
            editMethod: 'single_unit_edit'
        };

        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        if (operationType === OPERATION_TYPES.NEW_CLIENT) {
            additionalInfo.previousTenant = originalData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
            additionalInfo.newTenant = updatedProperty['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
        } else if (operationType === OPERATION_TYPES.EMPTY_UNIT) {
            additionalInfo.previousTenant = originalData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
            additionalInfo.reason = 'Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©';
        } else if (operationType === OPERATION_TYPES.RENEW_CONTRACT) {
            additionalInfo.previousTenant = originalData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
            additionalInfo.newTenant = updatedProperty['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
        }

        await addChangeLog(operationType, updatedProperty, changes, additionalInfo);
        console.log('ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ±Ø¯Ø©:', operationType);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ± ÙÙŠ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª
        if (updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] && updatedProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
            const hasAnyChanges = Object.keys(changes).length > 0 ||
                                 JSON.stringify(originalData) !== JSON.stringify(updatedProperty);

            console.log('ğŸ” ÙØ­Øµ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (ÙˆØ­Ø¯Ø© Ù…ÙØ±Ø¯Ø©):', {
                hasChanges: hasAnyChanges,
                changesCount: Object.keys(changes).length,
                contractNumber: updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
                propertyName: updatedProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                unitNumber: updatedProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']
            });

            if (hasAnyChanges) {
                try {
                    console.log('ğŸ“ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ù…Ù† ÙˆØ­Ø¯Ø© Ù…ÙØ±Ø¯Ø©)...');
                    const result = await createTrackingLogsForLinkedUnits(
                        updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
                        updatedProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                        updatedProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                        `ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© - ${operationType}`
                    );

                    if (result && result.success) {
                        console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${result.createdCount} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ù…Ù† ÙˆØ­Ø¯Ø© Ù…ÙØ±Ø¯Ø©)`);
                        if (result.failedCount > 0) {
                            console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ${result.failedCount} Ø³Ø¬Ù„ ØªØªØ¨Ø¹`);
                        }
                    } else {
                        console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª');
                    }
                } catch (linkedError) {
                    console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ù…Ù† ÙˆØ­Ø¯Ø© Ù…ÙØ±Ø¯Ø©):', linkedError);
                }
            } else {
                console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§ØªØŒ ØªØ®Ø·ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ù…Ù† ÙˆØ­Ø¯Ø© Ù…ÙØ±Ø¯Ø©)');
            }
        }

    } catch (trackingError) {
        console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ±Ø¯Ø©:', trackingError);
    }

    console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${originalUnitNumber} Ø¨Ù†Ø¬Ø§Ø­`);
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø©
async function applyOperationToUnit(unit, operationType, formData) {
    const contractNumber = unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '';
    const propertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '';
    const unitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '';

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!ensurePropertiesLoaded('applyOperationToUnit')) {
        return;
    }

    switch (operationType) {
        case OPERATION_TYPES.EDIT_DATA:
            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            console.log(`ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
            await updateUnitWithFormData(unit, formData);
            break;

        case OPERATION_TYPES.NEW_CLIENT:
            // Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ - Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
            await setNewClient(contractNumber, propertyName, unitNumber);
            break;

        case OPERATION_TYPES.RENEW_CONTRACT:
            // ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯
            await renewContract(contractNumber, propertyName, unitNumber);
            break;

        case OPERATION_TYPES.EMPTY_UNIT:
            // Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø©
            await emptyUnit(contractNumber, propertyName, unitNumber);
            break;

        default:
            throw new Error(`Ù†ÙˆØ¹ Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ${operationType}`);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
async function updateUnitWithFormData(unit, formData) {
    const originalContractNumber = unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '';
    const originalPropertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '';
    const originalUnitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '';

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!properties || !Array.isArray(properties)) {
        console.error('âŒ Ù…ØµÙÙˆÙØ© properties ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ updateUnitWithFormData:', properties);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        return false;
    }

    console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø© ÙÙŠ updateUnitWithFormDataØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', properties.length);

    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    const updatedData = {
        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': formData.get('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±') || '',
        'Ø§Ù„Ù…Ø§Ù„Ùƒ': formData.get('Ø§Ù„Ù…Ø§Ù„Ùƒ') || '',
        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': formData.get('Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯') || '',
        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': formData.get('Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯') || '',
        'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': formData.get('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±') || '',
        'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': formData.get('Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©') || '',
        'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': formData.get('Ø±Ù‚Ù… Ø§Ù„ØµÙƒ') || '',
        'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': formData.get('Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ') || '',
        'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': formData.get('Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ') || '',
        'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': formData.get('Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±') || '',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': formData.get('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©') || '',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': formData.get('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©') || '',
        'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·': formData.get('ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·') || '',
        'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©': formData.get('Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©') || '',
        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': formData.get('Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ') || '',
        'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': formData.get('Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰') || '',
        'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': formData.get('Ø§Ù„Ù…Ø³Ø§Ø­Ø©') || '',
        'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡': formData.get('Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡') || '',
        'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹': formData.get('Ø§Ù„Ø§Ø±ØªÙØ§Ø¹') || '',
        'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©': formData.get('Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©') || ''
    };

    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠ
    updatedData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] = originalUnitNumber;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
    const unitIndex = window.allData.findIndex(u =>
        u['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === originalContractNumber &&
        u['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName &&
        u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === originalUnitNumber
    );

    if (unitIndex !== -1) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        Object.assign(window.allData[unitIndex], updatedData);

        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        localStorage.setItem('propertyData', JSON.stringify(window.allData));

        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
        if (window.supabaseEnabled) {
            try {
                await saveToSupabase(window.allData[unitIndex]);
                console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${originalUnitNumber} ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${originalUnitNumber} ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:`, error);
                throw error;
            }
        }
    }
}

// Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
async function emptyAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø¥ÙØ±Ø§Øº');
        return;
    }

    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª (${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©)ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯!`;

    if (!confirm(confirmMessage)) {
        return;
    }

    console.log(`ğŸ§¹ Ø¨Ø¯Ø¡ Ø¥ÙØ±Ø§Øº ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©`);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    showProgressModal(`Ø¬Ø§Ø±ÙŠ Ø¥ÙØ±Ø§Øº ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©...`, async function(updateProgress) {
        try {
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < window.currentEditingUnits.length; i++) {
                const unit = window.currentEditingUnits[i];
                const progress = Math.round(((i + 1) / window.currentEditingUnits.length) * 100);

                updateProgress(progress, `Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || (i + 1)}...`);

                try {
                    const contractNumber = unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '';
                    const propertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '';
                    const unitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '';

                    await emptyUnit(contractNumber, propertyName, unitNumber);
                    successCount++;
                } catch (error) {
                    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
                    errorCount++;
                }

                // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            return {
                success: errorCount === 0,
                message: `ØªÙ… Ø¥ÙØ±Ø§Øº ${successCount} ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­` +
                        (errorCount > 0 ? `\nÙØ´Ù„ Ø¥ÙØ±Ø§Øº ${errorCount} ÙˆØ­Ø¯Ø©` : '')
            };
        } catch (error) {
            return {
                success: false,
                message: `Ø®Ø·Ø£ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${error.message}`
            };
        }
    }, function(result) {
        if (result.success) {
            showSuccessMessage('ØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª!', result.message);
            closeModal();
            renderData();
            updateTotalStats();
        } else {
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ÙØ±Ø§Øº:', result.message);
        }
    });
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„ØªØ¨ÙˆÙŠØ¨
function getUnitStatusClass(unit) {
    const status = calculateStatus(unit);
    if (status.final === 'ÙØ¹Ø§Ù„') return 'status-active';
    if (status.final === 'Ù…Ù†ØªÙ‡Ù‰') return 'status-expired';
    if (status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') return 'status-pending';
    if (status.final === 'ÙØ§Ø±Øº') return 'status-empty';
    return 'status-unknown';
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
function switchUnitTab(tabIndex) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    document.querySelector(`[data-tab="${tabIndex}"]`).classList.add('active');
    document.querySelector(`[data-tab-content="${tabIndex}"]`).classList.add('active');

    console.log(`ğŸ”„ ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙˆØ­Ø¯Ø© ${tabIndex}`);
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ ØªØ­Ø±ÙŠØ± ÙƒØ§Ù…Ù„ Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© (Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©)
function generateFullUnitEditForm(unit, unitIndex) {
    const contractNumber = unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '';
    const propertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '';
    const unitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '';

    return `
        <form id="unitEditForm_${unitIndex}" class="unit-edit-form" data-unit-index="${unitIndex}">
            <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© - Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
            <div class="operation-type-section">
                <h3><i class="fas fa-cogs"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</h3>
                <div class="form-group">
                    <label for="operationType_${unitIndex}">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                    <select id="operationType_${unitIndex}" name="operationType" required class="operation-type-select">
                        <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© --</option>
                        <option value="${OPERATION_TYPES.EDIT_DATA}">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©</option>
                        <option value="${OPERATION_TYPES.NEW_CLIENT}">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</option>
                        <option value="${OPERATION_TYPES.RENEW_CONTRACT}">ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
                        <option value="${OPERATION_TYPES.EMPTY_UNIT}">Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©</option>
                    </select>
                    <small class="field-note">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸</small>
                </div>
            </div>

            <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
            <input type="hidden" name="originalContractNumber" value="${contractNumber}">
            <input type="hidden" name="originalPropertyName" value="${propertyName}">
            <input type="hidden" name="originalUnitNumber" value="${unitNumber}">

            <div class="edit-form-sections">
                <div class="edit-section">
                    <h3><i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
                            <input type="text" name="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" value="${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø§Ù„Ùƒ:</label>
                            <select name="Ø§Ù„Ù…Ø§Ù„Ùƒ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ --</option>
                                <option value="Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯" ${(unit['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === 'Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯') ? 'selected' : ''}>Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯</option>
                                <option value="Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…" ${(unit['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === 'Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…') ? 'selected' : ''}>Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</label>
                            <input type="text" name="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯" value="${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
                        </div>
                        <div class="form-group">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯:</label>
                            <select name="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯">
                                <option value="Ø³ÙƒÙ†ÙŠ" ${unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø³ÙƒÙ†ÙŠ' ? 'selected' : ''}>Ø³ÙƒÙ†ÙŠ</option>
                                <option value="Ø¶Ø±ÙŠØ¨ÙŠ" ${unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ' ? 'selected' : ''}>Ø¶Ø±ÙŠØ¨ÙŠ</option>
                                <option value="Ø±Ø§ÙƒØ¶" ${unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø±Ø§ÙƒØ¶' ? 'selected' : ''}>Ø±Ø§ÙƒØ¶</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3><i class="fas fa-building"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„ØµÙƒ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                            <input type="text" name="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±" value="${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±" readonly style="background-color: #f8f9fa;">
                            <small class="field-note">Ù„ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±ØŒ Ø§Ø³ØªØ®Ø¯Ù… "ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±" Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</small>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                            <input type="text" name="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" value="${unit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || ''}" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" readonly style="background-color: #f8f9fa;">
                            <small class="field-note">Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… "ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±" Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                            <input type="text" name="Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© " value="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©">
                            <small class="field-note">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹</small>
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„ØµÙƒ:</label>
                            <input type="text" name="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ" value="${unit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ (Ù…Â²):</label>
                            <input type="number" name="Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ" value="${unit['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || ''}" step="0.01" placeholder="Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ:</label>
                            <input type="text" name="Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ " value="${unit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                            <input type="url" name="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±" value="${unit['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}" placeholder="Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©">
                            <small class="field-note">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„ Ø£Ùˆ Ø£ÙŠ Ø±Ø§Ø¨Ø· Ø¢Ø®Ø± Ù„Ù„Ù…ÙˆÙ‚Ø¹</small>
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3><i class="fas fa-calendar-alt"></i> Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</label>
                            <input type="date" name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" value="${formatDateForInput(unit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'])}">
                        </div>
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</label>
                            <input type="date" name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©" value="${formatDateForInput(unit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'])}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·:</label>
                            <input type="date" name="ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·" value="${formatDateForInput(unit['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'])}">
                        </div>
                        <div class="form-group">
                            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</label>
                            <input type="number" name="Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" value="${unit['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] || ''}" min="0">
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</label>
                            <input type="number" name="Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± " value="${unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || ''}" step="0.01" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</label>
                            <input type="number" name="Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰" value="${unit['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || ''}" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3><i class="fas fa-home"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Â²):</label>
                            <input type="number" name="Ø§Ù„Ù…Ø³Ø§Ø­Ø©" value="${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || ''}" step="0.01" placeholder="Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                            <small class="field-note">Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø¹Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ)</small>
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡:</label>
                            <input type="text" name="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡" value="${unit['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] || ''}" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ø§Ø±ØªÙØ§Ø¹:</label>
                            <input type="text" name="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" value="${unit['Ø§Ù„Ø§Ø±ØªÙØ§Ø¹'] || ''}" placeholder="Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø©">
                        </div>
                        <div class="form-group">
                            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                            <input type="text" name="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©" value="${unit['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©'] || ''}" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    `;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ ØªØ­Ø±ÙŠØ± Ù…Ø¨Ø³Ø· Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
function generateSingleUnitEditForm(unit, unitIndex) {
    const contractNumber = unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '';
    const propertyName = unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '';
    const unitNumber = unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '';

    return `
        <form id="unitEditForm_${unitIndex}" class="unit-edit-form" data-unit-index="${unitIndex}">
            <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
            <div class="operation-type-section">
                <h4><i class="fas fa-cogs"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</h4>
                <div class="form-group">
                    <select name="operationType" required class="operation-type-select">
                        <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© --</option>
                        <option value="${OPERATION_TYPES.EDIT_DATA}">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©</option>
                        <option value="${OPERATION_TYPES.NEW_CLIENT}">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</option>
                        <option value="${OPERATION_TYPES.RENEW_CONTRACT}">ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
                        <option value="${OPERATION_TYPES.EMPTY_UNIT}">Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©</option>
                    </select>
                </div>
            </div>

            <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠØ© -->
            <input type="hidden" name="originalContractNumber" value="${contractNumber}">
            <input type="hidden" name="originalPropertyName" value="${propertyName}">
            <input type="hidden" name="originalUnitNumber" value="${unitNumber}">

            <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div class="edit-section">
                <h4><i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
                        <input type="text" name="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" value="${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</label>
                        <input type="text" name="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯" value="${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                        <input type="text" name="Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© " value="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©">
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯:</label>
                        <select name="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯">
                            <option value="Ø³ÙƒÙ†ÙŠ" ${unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø³ÙƒÙ†ÙŠ' ? 'selected' : ''}>Ø³ÙƒÙ†ÙŠ</option>
                            <option value="Ø¶Ø±ÙŠØ¨ÙŠ" ${unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ' ? 'selected' : ''}>Ø¶Ø±ÙŠØ¨ÙŠ</option>
                            <option value="Ø±Ø§ÙƒØ¶" ${unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø±Ø§ÙƒØ¶' ? 'selected' : ''}>Ø±Ø§ÙƒØ¶</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
            <div class="edit-section">
                <h4><i class="fas fa-calendar-alt"></i> Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</label>
                        <input type="date" name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" value="${formatDateForInput(unit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'])}">
                    </div>
                    <div class="form-group">
                        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</label>
                        <input type="date" name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©" value="${formatDateForInput(unit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'])}">
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
            <div class="edit-section">
                <h4><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</label>
                        <input type="number" name="Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± " value="${unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || ''}" step="0.01" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</label>
                        <input type="number" name="Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰" value="${unit['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || ''}" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">
                    </div>
                </div>
            </div>

            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© -->
            <div class="edit-section">
                <h4><i class="fas fa-home"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Â²):</label>
                        <input type="number" name="Ø§Ù„Ù…Ø³Ø§Ø­Ø©" value="${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || ''}" step="0.01" placeholder="Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø©">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡:</label>
                        <input type="text" name="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡" value="${unit['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] || ''}" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡">
                    </div>
                </div>
            </div>


        </form>
    `;
}

// Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
async function saveAllUnitsChanges() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø­ÙØ¸');
        return;
    }

    console.log(`ğŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©`);

    let successCount = 0;
    let errorCount = 0;
    const errors = [];

    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    showProgressModal(`Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©...`, async function(updateProgress) {
        try {
            for (let i = 0; i < window.currentEditingUnits.length; i++) {
                const unit = window.currentEditingUnits[i];
                const progress = Math.round(((i + 1) / window.currentEditingUnits.length) * 100);

                updateProgress(progress, `Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || (i + 1)}...`);

                try {
                    const form = document.getElementById(`unitEditForm_${i}`);
                    if (form) {
                        const formData = new FormData(form);
                        await saveIndividualUnitChanges(formData, i);
                        successCount++;
                    }
                } catch (error) {
                    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
                    errorCount++;
                    errors.push(`Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}: ${error.message}`);
                }

                // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø­ÙØ¸Ø§Øª
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            return {
                success: errorCount === 0,
                message: `ØªÙ… Ø­ÙØ¸ ${successCount} ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­` +
                        (errorCount > 0 ? `\nÙØ´Ù„ Ø­ÙØ¸ ${errorCount} ÙˆØ­Ø¯Ø©` : '')
            };
        } catch (error) {
            return {
                success: false,
                message: `Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${error.message}`
            };
        }
    }, function(result) {
        if (result.success) {
            showSuccessMessage('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª!', result.message);
            closeModal();
            renderData();
            updateTotalStats();
        } else {
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', result.message);
        }
    });
}

// Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
async function saveCurrentUnitChanges() {
    const activeTab = document.querySelector('.tab-btn.active');
    if (!activeTab) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© Ù†Ø´Ø·Ø© Ù„Ù„Ø­ÙØ¸');
        return;
    }

    const tabIndex = parseInt(activeTab.getAttribute('data-tab'));
    const form = document.getElementById(`unitEditForm_${tabIndex}`);

    if (!form) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    const unit = window.currentEditingUnits[tabIndex];
    console.log(`ğŸ’¾ Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);

    try {
        const formData = new FormData(form);
        await saveIndividualUnitChanges(formData, tabIndex);

        showSuccessMessage('ØªÙ… Ø§Ù„Ø­ÙØ¸!', `ØªÙ… Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ø¨Ù†Ø¬Ø§Ø­`);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        const updatedUnit = window.currentEditingUnits[tabIndex];
        const tabBtn = document.querySelector(`[data-tab="${tabIndex}"]`);
        if (tabBtn) {
            const statusSpan = tabBtn.querySelector('.tab-status');
            if (statusSpan) {
                const newStatus = calculateStatus(updatedUnit);
                statusSpan.textContent = newStatus.final || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                statusSpan.className = `tab-status ${getUnitStatusClass(updatedUnit)}`;
            }
        }

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø©:`, error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

// Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ­Ø¯Ø© ÙØ±Ø¯ÙŠØ©
async function saveIndividualUnitChanges(formData, unitIndex) {
    const unit = window.currentEditingUnits[unitIndex];
    const originalContractNumber = formData.get('originalContractNumber');
    const originalPropertyName = formData.get('originalPropertyName');
    const originalUnitNumber = formData.get('originalUnitNumber');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!properties || !Array.isArray(properties)) {
        console.error('âŒ Ù…ØµÙÙˆÙØ© properties ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ saveIndividualUnitChanges:', properties);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        return false;
    }

    console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø© ÙÙŠ saveIndividualUnitChangesØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', properties.length);

    // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const propertyIndex = properties.findIndex(p =>
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === originalContractNumber &&
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName &&
        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === originalUnitNumber
    );

    if (propertyIndex === -1) {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«:', {
            contractNumber: originalContractNumber,
            propertyName: originalPropertyName,
            unitNumber: originalUnitNumber
        });
        throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${originalUnitNumber} ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
    }

    console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³: ${propertyIndex}`);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©)
    const updatedProperty = { ...properties[propertyIndex] };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('original')) continue;

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
        if (key.includes('ØªØ§Ø±ÙŠØ®') && value) {
            const dateParts = value.split('-');
            if (dateParts.length === 3 && dateParts[0].length === 4) {
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);

                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                }
            }
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        if (['Ø§Ù„Ù…Ø³Ø§Ø­Ø©', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'].includes(key) && value) {
            value = parseFloat(value) || 0;
        }

        updatedProperty[key] = value || '';
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
    updatedProperty['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
    updatedProperty['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = formData.get('operationType') || 'ØªØ­Ø±ÙŠØ±';
    updatedProperty['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();

    // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    properties[propertyIndex] = updatedProperty;
    window.currentEditingUnits[unitIndex] = updatedProperty;

    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
    saveDataLocally();

    // Ø­ÙØ¸ ÙÙŠ Supabase
    if (typeof savePropertyToSupabase === 'function') {
        try {
            await savePropertyToSupabase(updatedProperty);
        } catch (error) {
            console.warn('ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase:', error);
        }
    }

    console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${updatedProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ø¨Ù†Ø¬Ø§Ø­`);
}

// Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
async function setNewClientForAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
        return;
    }

    const newTenantName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
    if (!newTenantName || newTenantName.trim() === '') {
        return;
    }

    const newContractNumber = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
    if (!newContractNumber || newContractNumber.trim() === '') {
        return;
    }

    console.log(`ğŸ‘¥ ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©`);

    try {
        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        for (let i = 0; i < window.currentEditingUnits.length; i++) {
            const form = document.getElementById(`unitEditForm_${i}`);
            if (form) {
                form.querySelector('[name="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±"]').value = newTenantName;
                form.querySelector('[name="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯"]').value = newContractNumber;
                form.querySelector('[name="operationType"]').value = OPERATION_TYPES.NEW_CLIENT;
            }
        }

        showSuccessMessage('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!', `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ "${newTenantName}" Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª`);
    } catch (error) {
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('ÙØ´Ù„ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', error.message);
    }
}

async function renewContractForAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
        return;
    }

    const startDate = prompt('Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (dd/mm/yyyy):');
    if (!startDate) return;

    const endDate = prompt('Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (dd/mm/yyyy):');
    if (!endDate) return;

    console.log(`ğŸ”„ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù€ ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©`);

    try {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„ØµÙŠØºØ© input
        const startDateForInput = convertDateToInputFormat(startDate);
        const endDateForInput = convertDateToInputFormat(endDate);

        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        for (let i = 0; i < window.currentEditingUnits.length; i++) {
            const form = document.getElementById(`unitEditForm_${i}`);
            if (form) {
                form.querySelector('[name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"]').value = startDateForInput;
                form.querySelector('[name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"]').value = endDateForInput;
                form.querySelector('[name="operationType"]').value = OPERATION_TYPES.RENEW_CONTRACT;
            }
        }

        showSuccessMessage('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!', `ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ù† ${startDate} Ø¥Ù„Ù‰ ${endDate}`);
    } catch (error) {
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('ÙØ´Ù„ ÙÙŠ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯:', error.message);
    }
}

async function emptyAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
        return;
    }

    const confirm = window.confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª (${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©)ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª.`);
    if (!confirm) return;

    console.log(`ğŸ§¹ Ø¥ÙØ±Ø§Øº ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©`);

    try {
        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        for (let i = 0; i < window.currentEditingUnits.length; i++) {
            const form = document.getElementById(`unitEditForm_${i}`);
            if (form) {
                form.querySelector('[name="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±"]').value = '';
                form.querySelector('[name="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯"]').value = '';
                form.querySelector('[name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"]').value = '';
                form.querySelector('[name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"]').value = '';
                form.querySelector('[name="Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± "]').value = '';
                form.querySelector('[name="Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰"]').value = '';
                form.querySelector('[name="operationType"]').value = OPERATION_TYPES.EMPTY_UNIT;
            }
        }

        showSuccessMessage('ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº!', 'ØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯');
    } catch (error) {
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', error.message);
    }
}

async function syncDeedInfoForAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    const primaryUnit = window.currentEditingUnits[0];
    const form0 = document.getElementById('unitEditForm_0');

    if (!form0) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰');
        return;
    }

    const deedInfo = {
        'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': form0.querySelector('[name="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ"]')?.value || primaryUnit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || '',
        'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': form0.querySelector('[name="Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ"]')?.value || primaryUnit['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || '',
        'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': form0.querySelector('[name="Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ "]')?.value || primaryUnit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || '',
        'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': form0.querySelector('[name="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±"]')?.value || primaryUnit['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '',
        'Ø§Ù„Ù…Ø§Ù„Ùƒ': form0.querySelector('[name="Ø§Ù„Ù…Ø§Ù„Ùƒ"]')?.value || primaryUnit['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || ''
    };

    console.log(`ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù„Ù€ ${window.currentEditingUnits.length} ÙˆØ­Ø¯Ø©`);

    try {
        // ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        for (let i = 1; i < window.currentEditingUnits.length; i++) {
            const form = document.getElementById(`unitEditForm_${i}`);
            if (form) {
                Object.keys(deedInfo).forEach(field => {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        input.value = deedInfo[field];
                    }
                });
            }
        }

        showSuccessMessage('ØªÙ… Ø§Ù„ØªØ²Ø§Ù…Ù†!', 'ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª');
    } catch (error) {
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ:', error.message);
    }
}

// Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø§Øª
async function setNewClientForUnit(unitIndex) {
    const unit = window.currentEditingUnits[unitIndex];
    const newTenantName = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`);
    if (!newTenantName || newTenantName.trim() === '') return;

    const newContractNumber = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
    if (!newContractNumber || newContractNumber.trim() === '') return;

    try {
        const form = document.getElementById(`unitEditForm_${unitIndex}`);
        if (form) {
            form.querySelector('[name="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±"]').value = newTenantName;
            form.querySelector('[name="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯"]').value = newContractNumber;
            form.querySelector('[name="operationType"]').value = OPERATION_TYPES.NEW_CLIENT;
        }

        showSuccessMessage('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!', `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
    } catch (error) {
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('ÙØ´Ù„ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', error.message);
    }
}

async function renewContractForUnit(unitIndex) {
    const unit = window.currentEditingUnits[unitIndex];
    const startDate = prompt(`Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} (dd/mm/yyyy):`);
    if (!startDate) return;

    const endDate = prompt('Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (dd/mm/yyyy):');
    if (!endDate) return;

    try {
        const startDateForInput = convertDateToInputFormat(startDate);
        const endDateForInput = convertDateToInputFormat(endDate);

        const form = document.getElementById(`unitEditForm_${unitIndex}`);
        if (form) {
            form.querySelector('[name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"]').value = startDateForInput;
            form.querySelector('[name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"]').value = endDateForInput;
            form.querySelector('[name="operationType"]').value = OPERATION_TYPES.RENEW_CONTRACT;
        }

        showSuccessMessage('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!', `ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
    } catch (error) {
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.error('ÙØ´Ù„ ÙÙŠ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯:', error.message);
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
function convertDateToInputFormat(dateStr) {
    if (!dateStr) return '';

    const parts = dateStr.split('/');
    if (parts.length !== 3) return '';

    const day = parseInt(parts[0]);
    const month = parseInt(parts[1]);
    const year = parseInt(parts[2]);

    if (isNaN(day) || isNaN(month) || isNaN(year)) return '';

    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
}

// ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
async function cleanDuplicateUnits() {
    console.log('ğŸ§¹ Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©...');

    try {
        // 1. ØªÙ†Ø¸ÙŠÙ localStorage
        const cleanedLocalData = removeDuplicateUnitsFromArray(properties);
        const removedLocalCount = properties.length - cleanedLocalData.length;

        if (removedLocalCount > 0) {
            properties.length = 0; // Ù…Ø³Ø­ Ø§Ù„Ù…ØµÙÙˆÙØ©
            properties.push(...cleanedLocalData); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©
            saveDataLocally();
            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${removedLocalCount} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† localStorage`);
        }

        // 2. ØªÙ†Ø¸ÙŠÙ Supabase
        if (typeof cleanDuplicateUnitsFromSupabase === 'function') {
            await cleanDuplicateUnitsFromSupabase();
        }

        // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await loadDataFromSupabase();

        showSuccessMessage('ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ!', `ØªÙ… Ø­Ø°Ù ${removedLocalCount} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ù…ØµÙÙˆÙØ© (Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø© ÙˆØ¢Ù…Ù†Ø©)
function removeDuplicateUnitsFromArray(unitsArray) {
    if (!unitsArray || unitsArray.length === 0) {
        console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø¸ÙŠÙ');
        return [];
    }

    const uniqueUnits = new Map();
    const duplicates = [];

    unitsArray.forEach((unit) => {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (!unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || !unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']) {
            console.warn('âš ï¸ ÙˆØ­Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ø¹Ù‚Ø§Ø± Ø£Ùˆ Ø±Ù‚Ù… ÙˆØ­Ø¯Ø©:', unit);
            return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©
        }

        const unitKey = `${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;

        if (uniqueUnits.has(unitKey)) {
            // ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© - Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„Ø£ÙƒØ«Ø± Ø§ÙƒØªÙ…Ø§Ù„Ø§Ù‹
            const existingUnit = uniqueUnits.get(unitKey);

            // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            const existingDate = new Date(existingUnit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || existingUnit.created_at || '1900-01-01');
            const currentDate = new Date(unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || unit.created_at || '1900-01-01');

            // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const existingCompleteness = Object.values(existingUnit).filter(v => v && v !== '').length;
            const currentCompleteness = Object.values(unit).filter(v => v && v !== '').length;

            let shouldReplace = false;

            if (currentDate > existingDate) {
                shouldReplace = true;
            } else if (currentDate.getTime() === existingDate.getTime() && currentCompleteness > existingCompleteness) {
                shouldReplace = true;
            }

            if (shouldReplace) {
                duplicates.push(existingUnit);
                uniqueUnits.set(unitKey, unit);
                console.log(`ğŸ”„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©: ${unitKey} (Ø£Ø­Ø¯Ø« Ø£Ùˆ Ø£ÙƒØ«Ø± Ø§ÙƒØªÙ…Ø§Ù„Ø§Ù‹)`);
            } else {
                duplicates.push(unit);
                console.log(`ğŸ—‘ï¸ Ø­Ø°Ù ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù‚Ø¯ÙŠÙ…Ø©: ${unitKey}`);
            }
        } else {
            uniqueUnits.set(unitKey, unit);
        }
    });

    console.log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¢Ù…Ù†: ${uniqueUnits.size} ÙˆØ­Ø¯Ø© ÙØ±ÙŠØ¯Ø©ØŒ ${duplicates.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©`);

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
    if (duplicates.length > 0) {
        console.group('ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©:');
        duplicates.forEach(dup => {
            console.log(`- ${dup['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']} - ${dup['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} (${dup['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'})`);
        });
        console.groupEnd();
    }

    return Array.from(uniqueUnits.values());
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù…Ù† Supabase
async function cleanDuplicateUnitsFromSupabase() {
    if (!supabaseClient) {
        console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„ØªÙ†Ø¸ÙŠÙ');
        return;
    }

    try {
        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Supabase...');

        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
        const { data: allUnits, error } = await supabaseClient
            .from('properties')
            .select('*');

        if (error) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
        }

        if (!allUnits || allUnits.length === 0) {
            console.log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Ù„Ù„ØªÙ†Ø¸ÙŠÙ');
            return;
        }

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        const uniqueUnits = new Map();
        const duplicatesToDelete = [];

        allUnits.forEach(unit => {
            const unitKey = `${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;

            if (uniqueUnits.has(unitKey)) {
                // ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© - Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«
                const existingUnit = uniqueUnits.get(unitKey);
                const existingDate = new Date(existingUnit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || existingUnit.created_at || '1900-01-01');
                const currentDate = new Date(unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || unit.created_at || '1900-01-01');

                if (currentDate > existingDate) {
                    duplicatesToDelete.push(existingUnit.id);
                    uniqueUnits.set(unitKey, unit);
                } else {
                    duplicatesToDelete.push(unit.id);
                }
            } else {
                uniqueUnits.set(unitKey, unit);
            }
        });

        // Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        if (duplicatesToDelete.length > 0) {
            console.log(`ğŸ—‘ï¸ Ø­Ø°Ù ${duplicatesToDelete.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Supabase...`);

            const { error: deleteError } = await supabaseClient
                .from('properties')
                .delete()
                .in('id', duplicatesToDelete);

            if (deleteError) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©: ${deleteError.message}`);
            }

            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${duplicatesToDelete.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Supabase`);
        } else {
            console.log('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø© ÙÙŠ Supabase');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Supabase:', error);
        throw error;
    }
}

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
function showSingleUnitEditModal(property, contractNumber, propertyName, unitNumber) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±
    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box property-edit-modal">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div class="edit-modal-header">
                <h2><i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±</h2>
                <p>${propertyName} - ${contractNumber ? 'Ø¹Ù‚Ø¯ Ø±Ù‚Ù…: ' + contractNumber : 'ÙˆØ­Ø¯Ø© Ø±Ù‚Ù…: ' + unitNumber}</p>
            </div>
            <div class="edit-modal-content">
                <form id="propertyEditForm" onsubmit="savePropertyEdit(event)">
                    <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© - Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
                    <div class="operation-type-section">
                        <h3><i class="fas fa-cogs"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</h3>
                        <div class="form-group">
                            <label for="operationType">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                            <select id="operationType" name="operationType" required class="operation-type-select">
                                <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© --</option>
                                <option value="${OPERATION_TYPES.EDIT_DATA}">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©</option>
                                <option value="${OPERATION_TYPES.NEW_CLIENT}">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</option>
                                <option value="${OPERATION_TYPES.RENEW_CONTRACT}">ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
                                <option value="${OPERATION_TYPES.EMPTY_UNIT}">Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©</option>
                            </select>
                            <small class="field-note">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸</small>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
                    <input type="hidden" name="originalContractNumber" value="${contractNumber || ''}">
                    <input type="hidden" name="originalPropertyName" value="${propertyName || ''}">
                    <input type="hidden" name="originalUnitNumber" value="${unitNumber || ''}">

                    <div class="edit-form-sections">
                        <div class="edit-section">
                            <h3><i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
                                    <input type="text" name="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" value="${property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±">
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
                                    <input type="tel" name="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" value="${property['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''}" placeholder="05xxxxxxxx" pattern="[0-9]{10}" maxlength="10">
                                    <small class="field-note">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª (10 Ø£Ø±Ù‚Ø§Ù…)</small>
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ:</label>
                                    <input type="tel" name="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ" value="${property['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ'] || ''}" placeholder="05xxxxxxxx" pattern="[0-9]{10}" maxlength="10">
                                    <small class="field-note">Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø«Ø§Ù†ÙŠ Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ù„Ù…Ø§Ù„Ùƒ:</label>
                                    <select name="Ø§Ù„Ù…Ø§Ù„Ùƒ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ --</option>
                                        <option value="Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯" ${(property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === 'Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯') ? 'selected' : ''}>Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯</option>
                                        <option value="Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…" ${(property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === 'Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…') ? 'selected' : ''}>Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</label>
                                    <input type="text" name="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯" value="${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯:</label>
                                    <select name="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯">
                                        <option value="Ø³ÙƒÙ†ÙŠ" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø³ÙƒÙ†ÙŠ' ? 'selected' : ''}>Ø³ÙƒÙ†ÙŠ</option>
                                        <option value="Ø¶Ø±ÙŠØ¨ÙŠ" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ' ? 'selected' : ''}>Ø¶Ø±ÙŠØ¨ÙŠ</option>
                                        <option value="Ø±Ø§ÙƒØ¶" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø±Ø§ÙƒØ¶' ? 'selected' : ''}>Ø±Ø§ÙƒØ¶</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                                    <select name="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± --</option>
                                        <option value="Ù…Ø³ØªÙˆØ¯Ø¹" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…Ø³ØªÙˆØ¯Ø¹' ? 'selected' : ''}>Ù…Ø³ØªÙˆØ¯Ø¹</option>
                                        <option value="Ø¨ÙŠØª" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø¨ÙŠØª' ? 'selected' : ''}>Ø¨ÙŠØª</option>
                                        <option value="Ø§Ø³ØªØ±Ø§Ø­Ø©" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø§Ø³ØªØ±Ø§Ø­Ø©' ? 'selected' : ''}>Ø§Ø³ØªØ±Ø§Ø­Ø©</option>
                                        <option value="Ù…ØµÙ†Ø¹" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…ØµÙ†Ø¹' ? 'selected' : ''}>Ù…ØµÙ†Ø¹</option>
                                        <option value="Ø´Ù‚Ø©" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø´Ù‚Ø©' ? 'selected' : ''}>Ø´Ù‚Ø©</option>
                                        <option value="ØºØ±ÙØ©" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'ØºØ±ÙØ©' ? 'selected' : ''}>ØºØ±ÙØ©</option>
                                        <option value="Ù…Ø¹Ø±Ø¶" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…Ø¹Ø±Ø¶' ? 'selected' : ''}>Ù…Ø¹Ø±Ø¶</option>
                                        <option value="Ù…Ø­Ù„" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…Ø­Ù„' ? 'selected' : ''}>Ù…Ø­Ù„</option>
                                        <option value="Ø­ÙˆØ´" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø­ÙˆØ´' ? 'selected' : ''}>Ø­ÙˆØ´</option>
                                        <option value="ÙˆØ±Ø´Ø©" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'ÙˆØ±Ø´Ø©' ? 'selected' : ''}>ÙˆØ±Ø´Ø©</option>
                                        <option value="ÙÙ„Ø©" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'ÙÙ„Ø©' ? 'selected' : ''}>ÙÙ„Ø©</option>
                                        <option value="Ù…Ø²Ø±Ø¹Ø©" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…Ø²Ø±Ø¹Ø©' ? 'selected' : ''}>Ù…Ø²Ø±Ø¹Ø©</option>
                                        <option value="Ø£Ø±Ø¶" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø£Ø±Ø¶' ? 'selected' : ''}>Ø£Ø±Ø¶</option>
                                        <option value="Ø¹Ù…Ø§Ø±Ø©" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ø¹Ù…Ø§Ø±Ø©' ? 'selected' : ''}>Ø¹Ù…Ø§Ø±Ø©</option>
                                        <option value="Ù…ÙƒØªØ¨" ${property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] === 'Ù…ÙƒØªØ¨' ? 'selected' : ''}>Ù…ÙƒØªØ¨</option>
                                    </select>
                                    <small class="field-note">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„ØªØµÙ†ÙŠÙ Ø£ÙØ¶Ù„</small>
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-building"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„ØµÙƒ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                                    <input type="text" name="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±" value="${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±" readonly style="background-color: #f8f9fa;">
                                    <small class="field-note">Ù„ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±ØŒ Ø§Ø³ØªØ®Ø¯Ù… "ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±" Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</small>
                                </div>
                                <div class="form-group">
                                    <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                                    <input type="text" name="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" value="${property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || ''}" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" readonly style="background-color: #f8f9fa;">
                                    <small class="field-note">Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… "ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±" Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                                    <input type="text" name="Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© " value="${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©">
                                    <small class="field-note">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹</small>
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„ØµÙƒ:</label>
                                    <input type="text" name="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ" value="${property['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ (Ù…Â²):</label>
                                    <input type="number" name="Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ" value="${property['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || ''}" step="0.01" placeholder="Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                                </div>
                                <div class="form-group">
                                    <label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ:</label>
                                    <input type="text" name="Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ " value="${property['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                                    <input type="url" name="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±" value="${property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}" placeholder="Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©">
                                    <small class="field-note">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„ Ø£Ùˆ Ø£ÙŠ Ø±Ø§Ø¨Ø· Ø¢Ø®Ø± Ù„Ù„Ù…ÙˆÙ‚Ø¹</small>
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-calendar-alt"></i> Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</label>
                                    <input type="date" name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" value="${formatDateForInput(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'])}">
                                </div>
                                <div class="form-group">
                                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</label>
                                    <input type="date" name="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©" value="${formatDateForInput(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'])}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·:</label>
                                    <input type="date" name="ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·" value="${formatDateForInput(property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'])}">
                                </div>
                                <div class="form-group">
                                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</label>
                                    <input type="number" name="Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" value="${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] || ''}" min="0">
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</label>
                                    <input type="number" name="Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± " value="${property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || ''}" step="0.01" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±">
                                </div>
                                <div class="form-group">
                                    <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</label>
                                    <input type="number" name="Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰" value="${property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || ''}" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">
                                    <small style="color: #28a745; font-size: 0.8em; margin-top: 4px; display: block;">
                                        ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ÙƒØªÙˆØ¨ Ù‡Ù†Ø§ Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙˆÙ„Ù† ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-calendar-check"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h3>
                            <div class="installments-management">
                                <div class="installments-header">
                                    <p class="section-description">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø¹ ØªÙˆØ§Ø±ÙŠØ®Ù‡Ø§ ÙˆÙ…Ø¨Ø§Ù„ØºÙ‡Ø§</p>
                                    <div class="total-display" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 10px; border-radius: 6px; margin: 10px 0; text-align: center; font-weight: bold; color: #1976d2;">
                                        ${(() => {
                                            const yearlyData = calculateYearlyTotal(property);
                                            return `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${yearlyData.total.toLocaleString()} Ø±ÙŠØ§Ù„ (${yearlyData.count} Ø£Ù‚Ø³Ø§Ø·)`;
                                        })()}
                                    </div>
                                    <button type="button" onclick="addNewInstallment()" class="btn-add-installment">
                                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· Ø¬Ø¯ÙŠØ¯
                                    </button>
                                </div>
                                <div id="installmentsContainer" class="installments-container">
                                    ${renderInstallmentsForEdit(property)}
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-home"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Â²):</label>
                                    <input type="number" name="Ø§Ù„Ù…Ø³Ø§Ø­Ø©" value="${property['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || ''}" step="0.01" placeholder="Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                                    <small class="field-note">Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø¹Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ)</small>
                                </div>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡:</label>
                                    <input type="text" name="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡" value="${property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] || ''}" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ù„Ø§Ø±ØªÙØ§Ø¹:</label>
                                    <input type="text" name="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" value="${property['Ø§Ù„Ø§Ø±ØªÙØ§Ø¹'] || ''}" placeholder="Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø©">
                                </div>
                                <div class="form-group">
                                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                                    <input type="text" name="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©" value="${property['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©'] || ''}" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©">
                                </div>
                            </div>
                        </div>

                        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª -->
                        <div class="edit-section">
                            <h3><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:</label>
                                    <textarea name="notes" rows="4" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ø§Ù…Ø© Ø­ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...">${property['notes'] || ''}</textarea>
                                    <small class="field-note">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ù‡Ù…Ø© Ø­ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</small>
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-link"></i> Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
                            <div class="units-linking-section">
                                <p class="section-description">ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø· ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„ØªØ¬Ù…ÙŠØ¹Ù‡Ø§ ØªØ­Øª Ø¹Ù‚Ø¯ ÙˆØ§Ø­Ø¯</p>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø·:</label>
                                        <div id="availableUnitsForLinking" class="units-linking-list">
                                            ${renderAvailableUnitsForLinking(propertyName, contractNumber, unitNumber)}
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:</label>
                                        <div id="linkedUnitsDisplay" class="linked-units-display">
                                            ${renderLinkedUnits(propertyName, contractNumber)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="originalContractNumber" value="${contractNumber || ''}">
                    <input type="hidden" name="originalPropertyName" value="${propertyName}">
                    <input type="hidden" name="originalUnitNumber" value="${unitNumber || ''}">

                    <div class="edit-modal-actions">
                        <div class="action-group primary-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                            </button>

                            <button type="button" onclick="emptyUnit('${contractNumber || ''}', '${propertyName}', '${unitNumber || ''}')" class="btn-danger">
                                <i class="fas fa-broom"></i> Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø©
                            </button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">
                                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® - Ù…Ø­Ø³Ù† Ù„Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
function formatDateForInput(dateStr) {
    if (!dateStr) return '';

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ (Ù…Ø«Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ)
    let datePart = dateStr.split(' ')[0];
    if (datePart.includes('(')) {
        datePart = datePart.split('(')[0].trim();
    }

    let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');

    if (parts.length !== 3) return '';

    let day, month, year;

    // ØªØ­Ø¯ÙŠØ¯ ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (parts[0].length === 4) {
        // ØµÙŠØºØ© yyyy-mm-dd (already in correct format for input)
        year = parseInt(parts[0]);
        month = parseInt(parts[1]);
        day = parseInt(parts[2]);
    } else {
        // ØµÙŠØºØ© dd/mm/yyyy Ø£Ùˆ dd-mm-yyyy
        day = parseInt(parts[0]);
        month = parseInt(parts[1]);
        year = parseInt(parts[2]);
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (isNaN(year) || isNaN(month) || isNaN(day) ||
        year < 1900 || year > 2100 ||
        month < 1 || month > 12 ||
        day < 1 || day > 31) {
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ formatDateForInput: ${dateStr}`);
        return '';
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Date object (ØªØ¬Ù†Ø¨ timezone issues)
    const testDate = new Date(year, month - 1, day, 12, 0, 0); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†ØªØµÙ Ø§Ù„Ù†Ù‡Ø§Ø± Ù„ØªØ¬Ù†Ø¨ timezone issues
    if (testDate.getFullYear() !== year || testDate.getMonth() !== (month - 1) || testDate.getDate() !== day) {
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­ ÙÙŠ formatDateForInput: ${dateStr}`);
        return '';
    }

    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© yyyy-mm-dd Ù„Ù„Ù€ HTML input
    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
}



// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø­Ù‚ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ
function checkDeedFieldChanges(originalProperty, updatedProperty, deedFields) {
    console.log(`ğŸ” ÙØ­Øµ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø­Ù‚ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ...`);

    const changedFields = [];
    let hasChanges = false;

    deedFields.forEach(field => {
        const originalValue = originalProperty[field] || '';
        const updatedValue = updatedProperty[field] || '';

        // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù‚ÙŠÙ… (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©)
        const originalTrimmed = String(originalValue).trim();
        const updatedTrimmed = String(updatedValue).trim();

        if (originalTrimmed !== updatedTrimmed) {
            hasChanges = true;
            changedFields.push({
                field: field,
                oldValue: originalTrimmed || 'ÙØ§Ø±Øº',
                newValue: updatedTrimmed || 'ÙØ§Ø±Øº'
            });

            console.log(`   âœï¸ ${field}: "${originalTrimmed}" â†’ "${updatedTrimmed}"`);
        } else {
            console.log(`   âœ… ${field}: Ù„Ù… ÙŠØªØºÙŠØ± ("${originalTrimmed}")`);
        }
    });

    if (hasChanges) {
        console.log(`ğŸ“ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${changedFields.length} ØªØºÙŠÙŠØ± ÙÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ`);
    } else {
        console.log(`â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ`);
    }

    return {
        hasChanges: hasChanges,
        changedFields: changedFields,
        totalChanges: changedFields.length
    };
}

// Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
async function syncDeedInfoAcrossUnits(propertyName, updatedProperty, deedFields) {
    console.log(`ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù„Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª...`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø±
    const relatedUnits = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);

    if (relatedUnits.length <= 1) {
        console.log(`â„¹ï¸ Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©`);
        return { updatedCount: 0, message: 'ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·' };
    }

    console.log(`ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${relatedUnits.length} ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}"`);

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØºÙŠØ±Øª
    const changedFields = [];
    deedFields.forEach(field => {
        const newValue = updatedProperty[field];
        changedFields.push({
            field: field,
            newValue: newValue || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
        });
    });

    console.log(`ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:`, changedFields);

    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø­Ù„ÙŠØ§Ù‹
    let updatedCount = 0;
    const errors = [];

    relatedUnits.forEach((unit) => {
        try {
            const unitIndex = properties.findIndex(p =>
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] &&
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']
            );

            if (unitIndex !== -1) {
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ ÙÙ‚Ø· (Ø¹Ø¯Ù… ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø§ØµØ©)
                deedFields.forEach(field => {
                    const oldValue = properties[unitIndex][field];
                    const newValue = updatedProperty[field];

                    if (oldValue !== newValue) {
                        properties[unitIndex][field] = newValue;
                        console.log(`   âœ… Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}: ${field} = "${newValue}"`);
                    }
                });

                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
                properties[unitIndex]['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
                properties[unitIndex]['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = 'Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ';
                properties[unitIndex]['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();

                updatedCount++;
            }
        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
            errors.push({
                unitNumber: unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                error: error.message
            });
        }
    });

    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} ÙˆØ­Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹`);

    // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase
    let supabaseSuccess = 0;
    let supabaseErrors = [];

    if (typeof savePropertyToSupabase === 'function') {
        console.log(`â˜ï¸ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© ${updatedCount} ÙˆØ­Ø¯Ø© Ù…Ø¹ Supabase...`);

        try {
            // Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ ÙˆØ­Ø¯Ø© Ø¨Ø´ÙƒÙ„ ÙØ±Ø¯ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù†Ø¬Ø§Ø­
            for (const unit of relatedUnits) {
                const unitIndex = properties.findIndex(p =>
                    p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] &&
                    p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']
                );

                if (unitIndex !== -1) {
                    const result = await savePropertyToSupabase(properties[unitIndex]);

                    if (result) {
                        supabaseSuccess++;
                        console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                    } else {
                        console.error(`âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                        supabaseErrors.push(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
                    }

                    // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø­ÙØ¸Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø¥Ø±Ù‡Ø§Ù‚ Ø§Ù„Ø®Ø§Ø¯Ù…
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }

            console.log(`âœ… ØªÙ… Ø­ÙØ¸ ${supabaseSuccess} Ù…Ù† ${relatedUnits.length} ÙˆØ­Ø¯Ø© ÙÙŠ Supabase`);

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ø¹ Supabase:`, error);
            supabaseErrors.push(error.message);
        }
    } else {
        console.warn(`âš ï¸ Ø¯Ø§Ù„Ø© savePropertyToSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©`);
    }

    return {
        updatedCount: updatedCount,
        supabaseSuccess: supabaseSuccess,
        errors: errors,
        supabaseErrors: supabaseErrors,
        changedFields: changedFields,
        propertyName: propertyName
    };
}

// Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
async function savePropertyEdit(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);

    // ğŸ”„ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    const savedFilters = {
        currentCountry: currentCountry,
        currentProperty: currentProperty,
        currentPropertyTypeFilter: currentPropertyTypeFilter,
        filterStatus: filterStatus
    };
    console.log('ğŸ’¾ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', savedFilters);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    const operationType = formData.get('operationType');
    if (!operationType) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸');
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const originalContractNumber = formData.get('originalContractNumber');
    const originalPropertyName = formData.get('originalPropertyName');
    const originalUnitNumber = formData.get('originalUnitNumber');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!properties || !Array.isArray(properties)) {
        console.error('âŒ Ù…ØµÙÙˆÙØ© properties ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©:', properties);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        return;
    }

    console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø©ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', properties.length);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ù…ÙØµÙ„
    let propertyIndex = -1;
    let searchMethod = '';

    console.log('ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ savePropertyEdit:', {
        originalContractNumber,
        originalPropertyName,
        originalUnitNumber
    });

    if (originalContractNumber && originalPropertyName) {
        searchMethod = 'contract_and_property';
        propertyIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === originalContractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ø¹Ù‚Ø§Ø±: ÙÙ‡Ø±Ø³=${propertyIndex}`);
    }

    if (propertyIndex === -1 && originalUnitNumber && originalPropertyName) {
        searchMethod = 'unit_and_property';
        propertyIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === originalUnitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ù„Ø¹Ù‚Ø§Ø±: ÙÙ‡Ø±Ø³=${propertyIndex}`);
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ø¬Ø±Ø¨ Ø¨Ø­Ø« Ø£ÙˆØ³Ø¹
    if (propertyIndex === -1 && originalUnitNumber) {
        searchMethod = 'unit_only';
        propertyIndex = properties.findIndex(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === originalUnitNumber);
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙ‚Ø·: ÙÙ‡Ø±Ø³=${propertyIndex}`);

        if (propertyIndex !== -1) {
            const foundProperty = properties[propertyIndex];
            console.log(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ø±Ù‚Ù… ÙÙ‚Ø·ØŒ Ù„ÙƒÙ† Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø®ØªÙ„Ù: "${foundProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† "${originalPropertyName}"`);
        }
    }

    if (propertyIndex === -1) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¬Ù…ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø¨Ø­Ø«');
        console.log('ğŸ“Š Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:');
        properties.forEach((p, index) => {
            console.log(`   ${index}: ÙˆØ­Ø¯Ø©="${p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}", Ø¹Ù‚Ø§Ø±="${p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}", Ø¹Ù‚Ø¯="${p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}"`);
        });

        alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ø¯ÙŠØ«Ù‡\n\n' +
              'Ù‡Ø°Ø§ Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©!\n\n' +
              'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«:\n' +
              `- Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø£ØµÙ„ÙŠ: ${originalContractNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n` +
              `- Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: ${originalPropertyName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n` +
              `- Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠ: ${originalUnitNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n\n` +
              'ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        return;
    }

    console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø±ÙŠÙ‚Ø©: ${searchMethod}, ÙÙ‡Ø±Ø³: ${propertyIndex}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªÙƒØ±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    const preUpdateDuplicateCheck = checkForDuplicateUnits(originalUnitNumber, originalPropertyName);
    if (preUpdateDuplicateCheck.hasDuplicates) {
        console.warn(`âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${preUpdateDuplicateCheck.count} Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«`);
        // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
        fixDuplicateUnits(originalUnitNumber, originalPropertyName);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    const originalData = { ...properties[propertyIndex] };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const updatedProperty = { ...properties[propertyIndex] };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    console.log(`ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...`);

    // ØªØ¹Ø±ÙŠÙ Ø­Ù‚ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ
    const deedFields = ['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ', 'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ', 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ', 'Ø§Ù„Ù…Ø§Ù„Ùƒ', 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'];

    for (let [key, value] of formData.entries()) {
        if (key.startsWith('original')) continue; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠØ©

        // ØªØ³Ø¬ÙŠÙ„ Ø®Ø§Øµ Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ
        if (deedFields.includes(key)) {
            console.log(`ğŸ“ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ù‚Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ: ${key}`);
            console.log(`   Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©: "${originalData[key]}"`);
            console.log(`   Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: "${value}"`);
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© - Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        if (key.includes('ØªØ§Ø±ÙŠØ®') && value && !key.includes('Ø§Ù„Ù‚Ø³Ø·')) {
            // ØªØ­ÙˆÙŠÙ„ Ù…Ù† yyyy-mm-dd Ø¥Ù„Ù‰ dd/mm/yyyy Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙÙ‚Ø·
            const dateParts = value.split('-');
            if (dateParts.length === 3 && dateParts[0].length === 4) {
                // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Date object Ù„ØªØ¬Ù†Ø¨ ØªÙˆØ§Ø±ÙŠØ® Ù…Ø«Ù„ 31 ÙØ¨Ø±Ø§ÙŠØ±
                    const testDate = new Date(year, month - 1, day, 12, 0, 0);
                    if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                        value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                        console.log(`âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­: ${key} = ${value}`);
                    } else {
                        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­ ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡: ${value} Ù„Ù„Ø­Ù‚Ù„: ${key}`);
                        value = null;
                    }
                } else {
                    console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡: ${value} Ù„Ù„Ø­Ù‚Ù„: ${key}`);
                    value = null; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ø§Ù„ØµØ­ÙŠØ­
                }
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        if (key.includes('Ø§Ù„Ù‚Ø³Ø·') && key.includes('ØªØ§Ø±ÙŠØ®') && value) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¨ØµÙŠØºØ© yyyy-mm-ddØŒ Ø­ÙˆÙ„Ù‡Ø§ Ø¥Ù„Ù‰ dd/mm/yyyy
            const dateParts = value.split('-');
            if (dateParts.length === 3 && dateParts[0].length === 4) {
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Date object
                    const testDate = new Date(year, month - 1, day, 12, 0, 0);
                    if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                        value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                        console.log(`âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø¨Ù†Ø¬Ø§Ø­: ${key} = ${value}`);
                    } else {
                        console.warn(`ØªØ§Ø±ÙŠØ® Ù‚Ø³Ø· ØºÙŠØ± ØµØ§Ù„Ø­ ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡: ${value} Ù„Ù„Ø­Ù‚Ù„: ${key}`);
                        value = null;
                    }
                } else {
                    console.warn(`ØªØ§Ø±ÙŠØ® Ù‚Ø³Ø· ØºÙŠØ± ØµØ­ÙŠØ­ ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡: ${value} Ù„Ù„Ø­Ù‚Ù„: ${key}`);
                    value = null;
                }
            }
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        if (['Ø§Ù„Ù…Ø³Ø§Ø­Ø©', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'].includes(key) && value) {
            value = parseFloat(value) || 0;
        }

        // ØªØ­Ø¯ÙŠØ« Ø®Ø§Øµ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        if (key === 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©') {
            value = parseInt(value) || 0;
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
        if (key === 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©') {
            console.log(`ğŸ“ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©:`);
            console.log(`   Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©: "${originalData[key]}"`);
            console.log(`   Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: "${value}"`);

            // Ø­ÙØ¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©)
            updatedProperty[key] = value || '';
            console.log(`   âœ… ØªÙ… Ø­ÙØ¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©: "${updatedProperty[key]}"`);
        }
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø­Ù‚ÙˆÙ„ - Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯
        else if (value === '' || value === null || value === undefined) {
            // Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ØµÙŠØ©ØŒ Ø§Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§Ø±ØºØ© (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨ÙØ§Ø±Øº)
            if (typeof updatedProperty[key] === 'string' || key.includes('Ø±Ù‚Ù…') || key.includes('Ø§Ø³Ù…') || key.includes('Ù…ÙˆÙ‚Ø¹') || key.includes('Ø§Ù„Ù…Ø§Ù„Ùƒ') || key.includes('Ø§Ù„Ø³Ø¬Ù„')) {
                updatedProperty[key] = value || '';
                if (deedFields.includes(key)) {
                    console.log(`   ğŸ”„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© "${originalData[key]}" Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© "${value || ''}"`);
                }
            } else {
                // Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… null
                updatedProperty[key] = null;
            }
        } else {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙ…Ø©ØŒ Ø§Ø­ÙØ¸Ù‡Ø§ (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯)
            updatedProperty[key] = value;
            if (deedFields.includes(key)) {
                console.log(`   âœ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© "${originalData[key]}" Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© "${value}"`);
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ
        if (deedFields.includes(key)) {
            console.log(`   Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: "${updatedProperty[key]}"`);
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠØ§Ù‹
    let actualInstallmentCount = 0;
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        if (updatedProperty[dateKey] || updatedProperty[amountKey]) {
            actualInstallmentCount = i;
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    updatedProperty['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] = actualInstallmentCount;

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
    updatedProperty['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
    updatedProperty['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = operationType || 'ØªØ­Ø±ÙŠØ±';
    updatedProperty['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();

    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¥Ù„Ù‰: ${actualInstallmentCount}`);

    // Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ØŒ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
    const newContractNumber = formData.get('Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯');
    if (originalContractNumber && newContractNumber && originalContractNumber !== newContractNumber) {
        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ ØªØ­Ù…Ù„ Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        properties.forEach((property, index) => {
            if (property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === originalContractNumber && property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName) {
                properties[index] = { ...properties[index], 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': newContractNumber };
            }
        });
    }

    // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© - Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©
    const newUnitNumber = formData.get('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ');
    if (originalUnitNumber && newUnitNumber && originalUnitNumber !== newUnitNumber) {
        console.log(`ğŸ”„ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† "${originalUnitNumber}" Ø¥Ù„Ù‰ "${newUnitNumber}"`);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø© Ø£Ø®Ø±Ù‰ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const existingUnitWithNewNumber = properties.find(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName &&
            properties.indexOf(p) !== propertyIndex
        );

        if (existingUnitWithNewNumber) {
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            console.error(`Ø®Ø·Ø£: ÙŠÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø±Ù‚Ù… "${newUnitNumber}" ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø±!`);
            return;
        }

        // Ù†Ù‡Ø¬ Ø¬Ø¯ÙŠØ¯: Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Supabase Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        console.log(`ğŸ”„ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: "${originalUnitNumber}" â†’ "${newUnitNumber}"`);

        // 1. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø­Ø°Ù Ù…Ù† Supabase
        const oldUnitDataForSupabase = { ...properties[propertyIndex] };

        // 2. Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Supabase Ø£ÙˆÙ„Ø§Ù‹
        if (typeof deletePropertyFromSupabase === 'function') {
            try {
                console.log(`â˜ï¸ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø±Ù‚Ù… "${originalUnitNumber}" Ù…Ù† Supabase...`);
                const deleteResult = await deletePropertyFromSupabase(oldUnitDataForSupabase);
                if (deleteResult && deleteResult.success) {
                    console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Supabase Ø¨Ù†Ø¬Ø§Ø­`);
                } else {
                    console.warn(`âš ï¸ ØªØ­Ø°ÙŠØ±: ${deleteResult ? deleteResult.message : 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Supabase'}`);
                }
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Supabase:`, error);
            }
        }

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const newUnitData = { ...updatedProperty, 'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': newUnitNumber };
        properties[propertyIndex] = newUnitData;

        console.log(`âœ… ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© "${originalUnitNumber}" Ø¨Ù€ "${newUnitNumber}" Ø¨Ù†Ø¬Ø§Ø­`);

        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­: "${originalUnitNumber}" â†’ "${newUnitNumber}"`);

        // ØªØ­Ø¯ÙŠØ« updatedProperty Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§ØªØ³Ø§Ù‚
        updatedProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] = newUnitNumber;
    } else {
        // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©)
        properties[propertyIndex] = updatedProperty;
    }

    // ØªØ³Ø¬ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
    console.log(`ğŸ“Š Ø­Ø§Ù„Ø© Ø­Ù‚ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸:`);
    deedFields.forEach(field => {
        console.log(`   ${field}: "${properties[propertyIndex][field]}"`);
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    const deedChanges = checkDeedFieldChanges(originalData, updatedProperty, deedFields);

    if (deedChanges.hasChanges) {
        console.log(`ğŸ”„ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒØŒ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...`);
        console.log(`ğŸ“ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø©:`, deedChanges.changedFields);

        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
        const syncResult = await syncDeedInfoAcrossUnits(originalPropertyName, updatedProperty, deedFields);

        // Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        window.lastSyncResult = syncResult;
    } else {
        console.log(`â„¹ï¸ Ù„Ù… ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒØŒ ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©`);
        // Ù…Ø³Ø­ Ø£ÙŠ Ù†ØªÙŠØ¬Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø§Ø¨Ù‚Ø©
        window.lastSyncResult = null;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    console.log('ğŸ’° Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©...');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯Ø®Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const manualTotal = formData.get('Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰');

    if (manualTotal && manualTotal !== '' && parseFloat(manualTotal) > 0) {
        // Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ ÙˆØ§Ø­ÙØ¸Ù‡ Ø¯Ø§Ø¦Ù…Ø§Ù‹
        updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = parseFloat(manualTotal);
        console.log(`ğŸ’° ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹: ${manualTotal} (Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡ Ø¯Ø§Ø¦Ù…Ø§Ù‹)`);
    } else if (manualTotal === '' || manualTotal === '0') {
        // Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù‚ÙŠÙ…Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ ØµÙØ±)
        updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = null;
        console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬`);
    } else if (property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] && property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] !== null && property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] !== 0) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ù‡ ÙˆÙ„Ø§ ØªØºÙŠØ±Ù‡
        updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'];
        console.log(`ğŸ’° ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯: ${property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']} (Ù„Ù† ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡)`);
    } else {
        // ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ø­Ø³Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
        const yearlyData = calculateYearlyTotal(updatedProperty);
        if (yearlyData.count > 0) {
            updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = yearlyData.total;
            console.log(`ğŸ’° ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: ${yearlyData.total} (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ${yearlyData.count} Ù‚Ø³Ø·)`);
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø·ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = null;
            console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ù‚Ø³Ø§Ø·`);
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
    properties[propertyIndex] = updatedProperty;

    // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ø±Ø¶ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ø±Ø¶...');
    renderData();
    updateTotalStats();

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£ÙˆÙ„Ø§Ù‹
    closeModal();

    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ (Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
    showProgressModal('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª...', async function(updateProgress) {
        try {
            console.log('âœ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¯Ø£ Ø¨Ù†Ø¬Ø§Ø­');

            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø¨Ø¯Ø¡ Ø§Ù„Ø­ÙØ¸
            updateProgress(10, 'Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­ÙØ¸...');
            await new Promise(resolve => setTimeout(resolve, 300));

            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
            updateProgress(25, 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹...');
            saveDataLocally();
            await new Promise(resolve => setTimeout(resolve, 400));

            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª
            updateProgress(40, 'Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª...');
            initializeApp();
            await new Promise(resolve => setTimeout(resolve, 300));

            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ
            updateProgress(55, 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©...');
            await new Promise(resolve => setTimeout(resolve, 500));

            let supabaseResult = null;
            if (typeof savePropertyToSupabase === 'function') {
                try {
                    updateProgress(70, 'Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©...');
                    supabaseResult = await savePropertyToSupabase(updatedProperty);
                    console.log('ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø­ÙØ¸ Supabase:', supabaseResult);
                    await new Promise(resolve => setTimeout(resolve, 600));
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Supabase:', error);
                    supabaseResult = {
                        success: false,
                        message: `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`
                    };
                }
            }

            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ù…Ø²Ø§Ù…Ù†Ø© (Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
            if (window.lastSyncResult && window.lastSyncResult.updatedCount > 0) {
                updateProgress(85, `Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ ÙÙŠ ${window.lastSyncResult.updatedCount} ÙˆØ­Ø¯Ø©...`);
                await new Promise(resolve => setTimeout(resolve, 700));

                updateProgress(95, 'Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...');
                await new Promise(resolve => setTimeout(resolve, 400));
            } else {
                updateProgress(90, 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            updateProgress(100, 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!');
            await new Promise(resolve => setTimeout(resolve, 400));

            // Ø¨Ù†Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            let message = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!';

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ
            if (window.lastSyncResult && window.lastSyncResult.updatedCount > 0) {
                message += `\nğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ ÙÙŠ ${window.lastSyncResult.updatedCount} ÙˆØ­Ø¯Ø©`;

                if (window.lastSyncResult.changedFields && window.lastSyncResult.changedFields.length > 0) {
                    message += '\nğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:';
                    window.lastSyncResult.changedFields.forEach(change => {
                        message += `\nâ€¢ ${change.field}: ${change.newValue}`;
                    });
                }

                if (window.lastSyncResult.supabaseSuccess > 0) {
                    message += `\nâ˜ï¸ ØªÙ… Ø­ÙØ¸ ${window.lastSyncResult.supabaseSuccess} ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`;
                }

                if (window.lastSyncResult.errors && window.lastSyncResult.errors.length > 0) {
                    message += `\nâš ï¸ ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ${window.lastSyncResult.errors.length} ÙˆØ­Ø¯Ø©`;
                }
            } else if (window.lastSyncResult === null) {
                message += '\nğŸ’¡ ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙ‚Ø· (Ù„Ù… ØªØªØºÙŠØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒ)';
            }

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙØ¸ Supabase
            if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                if (supabaseResult && supabaseResult.success) {
                    message += '\nâœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©';
                } else {
                    const errorMsg = supabaseResult ? supabaseResult.message : 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸';
                    message += `\nâš ï¸ ØªØ­Ø°ÙŠØ±: ${errorMsg}`;
                }
            }

            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ (Ø¯Ø§Ø®Ù„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…)
            try {
                const changes = compareDataAndCreateChanges(originalData, updatedProperty);

                let additionalInfo = {
                    originalData: originalData,
                    newData: updatedProperty
                };

                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                if (operationType === OPERATION_TYPES.NEW_CLIENT) {
                    additionalInfo.previousTenant = originalData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
                    additionalInfo.newTenant = updatedProperty['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
                } else if (operationType === OPERATION_TYPES.EMPTY_UNIT) {
                    additionalInfo.previousTenant = originalData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
                    additionalInfo.reason = 'Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©';
                } else if (operationType === OPERATION_TYPES.RENEW_CONTRACT) {
                    additionalInfo.previousTenant = originalData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
                    additionalInfo.newTenant = updatedProperty['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
                }

                await addChangeLog(operationType, updatedProperty, changes, additionalInfo);
                console.log('ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø¹Ù…Ù„ÙŠØ©:', operationType);

                // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ± ÙÙŠ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª
                if (updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] && updatedProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„ÙŠØ³ ÙÙ‚Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©)
                    const hasAnyChanges = Object.keys(changes).length > 0 ||
                                         JSON.stringify(originalData) !== JSON.stringify(updatedProperty);

                    console.log('ğŸ” ÙØ­Øµ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:', {
                        hasChanges: hasAnyChanges,
                        changesCount: Object.keys(changes).length,
                        contractNumber: updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
                        propertyName: updatedProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                        unitNumber: updatedProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']
                    });

                    if (hasAnyChanges) {
                        try {
                            console.log('ğŸ“ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©...');
                            const result = await createTrackingLogsForLinkedUnits(
                                updatedProperty['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
                                updatedProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                                updatedProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                                `ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© - ${operationType}`
                            );

                            if (result && result.success) {
                                console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${result.createdCount} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©`);
                                if (result.failedCount > 0) {
                                    console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ${result.failedCount} Ø³Ø¬Ù„ ØªØªØ¨Ø¹`);
                                }
                            } else {
                                console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª');
                            }
                        } catch (linkedError) {
                            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:', linkedError);
                        }
                    } else {
                        console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§ØªØŒ ØªØ®Ø·ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©');
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ (Ù„Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙØ¸):', error);
            }

            return { success: true, message: message };
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
            return { success: false, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª' };
        }
    }, function(result) {
        // Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…ØŒ Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
        console.log('ğŸ¯ callback Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ØŒ Ø§Ù„Ù†ØªÙŠØ¬Ø©:', result);

        if (result && result.success) {
            if (typeof showSuccessMessageWithCallback === 'function') {
                showSuccessMessageWithCallback('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', result.message, function() {
                    // ØªØ­Ø¯ÙŠØ« Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
                    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
                    renderData();
                    updateTotalStats();

                    // Ù…Ø³Ø­ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                    window.lastSyncResult = null;
                });
            } else {
                // fallback Ø¥Ù„Ù‰ alert Ø¹Ø§Ø¯ÙŠ
                alert(result.message);

                // ØªØ­Ø¯ÙŠØ« Ø¥Ø¶Ø§ÙÙŠ (Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
                console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¥Ø¶Ø§ÙÙŠ Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ±...');

                // ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                if (savedFilters) {
                    console.log('ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', savedFilters);

                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                    if (savedFilters.currentCountry) {
                        currentCountry = savedFilters.currentCountry;
                    }

                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø¨Ø§Ù†ÙŠ/Ø£Ø±Ø§Ø¶ÙŠ)
                    if (savedFilters.currentPropertyTypeFilter) {
                        currentPropertyTypeFilter = savedFilters.currentPropertyTypeFilter;
                        console.log(`ğŸ—ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${currentPropertyTypeFilter}`);
                    }

                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
                    if (savedFilters.filterStatus) {
                        filterStatus = savedFilters.filterStatus;
                    }

                    // ğŸ¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
                    if (savedFilters.currentPropertyTypeFilter && !savedFilters.currentProperty) {
                        // Ø§Ù„Ø­Ø§Ù„Ø© 1: Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù†ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø«Ù„: Ø£Ø±Ø§Ø¶ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶)
                        currentProperty = null; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯
                        // âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                        console.log(`ğŸ”„ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª ${currentPropertyTypeFilter === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'} ÙÙŠ ${currentCountry} ÙÙ‚Ø·`);
                        console.log(`ğŸ™ï¸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù†Ø´Ø·Ø©: ${currentCountry}`);
                        console.log(`ğŸ—ï¸ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù†Ø´Ø·: ${currentPropertyTypeFilter}`);
                    } else if (savedFilters.currentProperty) {
                        // Ø§Ù„Ø­Ø§Ù„Ø© 2: Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯ Ù…ÙØªÙˆØ­ (Ù…Ø«Ù„: Ø¹Ù‚Ø§Ø± Ø§Ù„ØµØ­Ø±Ø§Ø¡)
                        currentProperty = savedFilters.currentProperty;
                        console.log(`ğŸ¯ Ø§Ù„Ø¹Ù‚Ø§Ø± ${currentProperty} ÙŠØ¨Ù‚Ù‰ Ù…ÙØªÙˆØ­ Ù…Ø¹ ÙˆØ­Ø¯Ø§ØªÙ‡ ÙÙŠ ${currentCountry}`);
                    }

                    // ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙŠØ¨Ù‚Ù‰ Ù†Ø´Ø· ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ†
                    if (savedFilters.currentPropertyTypeFilter) {
                        console.log(`âœ… ÙÙ„ØªØ± ${currentPropertyTypeFilter === 'buildings' ? 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' : 'Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ'} ÙŠØ¨Ù‚Ù‰ Ù†Ø´Ø· Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© ${currentCountry}`);
                    }

                    console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ù†Ø¬Ø§Ø­');
                }

                // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ¸Ù‡Ø± Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù†Ø´Ø·Ø© ÙÙ‚Ø·
                console.log(`ğŸ™ï¸ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${currentCountry || 'Ø§Ù„ÙƒÙ„'}`);
                initPropertyList(currentCountry);

                // ØªØ£Ø®ÙŠØ± ØµØºÙŠØ± Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                setTimeout(() => {
                    renderData();
                    updateTotalStats();

                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
                    updatePropertyTypeFiltersState();
                    updateActiveFiltersDisplay();

                    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                    saveAppState();
                }, 50);

                window.lastSyncResult = null;
            }
        } else {
            const errorMessage = result ? result.message : 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', errorMessage);
        }
    });
}

// ==================== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© ====================

// ØªØ­Ø±ÙŠØ± Ø¹Ù‚Ø§Ø± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function editProperty(propertyName) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¹Ù‚Ø§Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…
    const property = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    if (!property) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    showCardEditModal(property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '', propertyName, property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '');
}

// Ø¹Ø±Ø¶ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
function viewPropertyUnits(propertyName) {
    const propertyUnits = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);

    if (propertyUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box property-units-modal">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div class="units-modal-header">
                <h2><i class="fas fa-home"></i> ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}</h2>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${propertyUnits.length}</p>
            </div>
            <div class="units-modal-content">
                <div class="units-grid">
                    ${propertyUnits.map(unit => {
                        const status = calculateStatus(unit);
                        let statusClass = '';
                        if (status.final === 'ÙØ¹Ø§Ù„') statusClass = 'unit-active';
                        else if (status.final === 'Ù…Ù†ØªÙ‡Ù‰') statusClass = 'unit-expired';
                        else if (status.final === 'Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') statusClass = 'unit-pending';
                        else if (status.final === 'ÙØ§Ø±Øº') statusClass = 'unit-empty';

                        return `
                        <div class="unit-card ${statusClass}">
                            <div class="unit-header">
                                <h4>${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</h4>
                                <span class="unit-status">${status.final || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                            </div>
                            <div class="unit-details">
                                <p><strong>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</strong> ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}</p>
                                <p><strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> ${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] + ' Ù…Â²' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                <p><strong>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</strong> ${unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] ? parseFloat(unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']).toLocaleString() + ' Ø±ÙŠØ§Ù„' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            </div>
                            <div class="unit-actions">
                                <button onclick="showCardEditModal('${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}', '${propertyName}', '${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''}')" class="btn-edit">
                                    <i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ±
                                </button>
                                <button onclick="showUnitDetails('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}', '${propertyName}', '${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}')" class="btn-view">
                                    <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                                </button>
                                <button onclick="deleteUnit('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}', '${propertyName}')" class="btn-delete">
                                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================

// Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
async function createTrackingLogsForLinkedUnits(contractNumber, propertyName, excludeUnitNumber, operationType) {
    try {
        console.log(`ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}...`);

        if (!contractNumber || contractNumber.trim() === '') {
            console.warn('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙØ§Ø±ØºØŒ ØªØ®Ø·ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
            return { success: false, reason: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙØ§Ø±Øº' };
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯ (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ«Ù†Ø§Ø©)
        const linkedUnits = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] !== excludeUnitNumber
        );

        if (linkedUnits.length === 0) {
            console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø£Ø®Ø±Ù‰ Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
            return { success: true, createdCount: 0, reason: 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø£Ø®Ø±Ù‰' };
        }

        console.log(`ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${linkedUnits.length} ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹`);

        let createdCount = 0;
        let failedCount = 0;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø© Ù…Ø±ØªØ¨Ø·Ø©
        for (const unit of linkedUnits) {
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                const additionalInfo = {
                    contractNumber: contractNumber,
                    propertyName: propertyName,
                    newLinkedUnit: excludeUnitNumber,
                    reason: `ØªÙ… Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© (${excludeUnitNumber}) Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯`,
                    relatedOperation: 'unit_linking_notification',
                    affectedUnits: linkedUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']),
                    totalLinkedUnits: linkedUnits.length + 1
                };

                await addChangeLog(operationType, unit, {}, additionalInfo);
                createdCount++;
                console.log(`ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);

                // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„ØªØ¬Ù†Ø¨ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await new Promise(resolve => setTimeout(resolve, 100));

            } catch (logError) {
                console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, logError);
                failedCount++;
            }
        }

        // Ù…Ø³Ø­ ÙƒØ§Ø´ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if (typeof clearTrackingLogsCache === 'function') {
            clearTrackingLogsCache();
        }

        console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${createdCount} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©`);
        if (failedCount > 0) {
            console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ${failedCount} Ø³Ø¬Ù„ ØªØªØ¨Ø¹`);
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (createdCount > 0) {
            showToast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${createdCount} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©`, 'success');
        }

        return {
            success: true,
            createdCount,
            failedCount,
            totalUnits: linkedUnits.length
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©', 'error');
        return { success: false, reason: error.message };
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
async function createTrackingLogsForLinkedUnits(contractNumber, propertyName, excludeUnitNumber, operationType) {
    try {
        console.log(`ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}...`);

        if (!contractNumber || contractNumber.trim() === '') {
            console.warn('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙØ§Ø±ØºØŒ ØªØ®Ø·ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
            return { success: false, reason: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙØ§Ø±Øº' };
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯ (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ«Ù†Ø§Ø©)
        const linkedUnits = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] !== excludeUnitNumber
        );

        if (linkedUnits.length === 0) {
            console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø£Ø®Ø±Ù‰ Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
            return { success: true, createdCount: 0, reason: 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø£Ø®Ø±Ù‰' };
        }

        console.log(`ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${linkedUnits.length} ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹`);

        let createdCount = 0;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø© Ù…Ø±ØªØ¨Ø·Ø©
        for (const unit of linkedUnits) {
            try {
                await addChangeLog(
                    operationType,
                    unit,
                    {}, // Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ÙØ¹Ù„ÙŠØ©ØŒ ÙÙ‚Ø· Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ø±Ø¨Ø·
                    {
                        contractNumber: contractNumber,
                        propertyName: propertyName,
                        newLinkedUnit: excludeUnitNumber,
                        reason: `ØªÙ… Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© (${excludeUnitNumber}) Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯`,
                        relatedOperation: 'unit_linking_notification'
                    }
                );
                createdCount++;
                console.log(`ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);

                // Ù…Ø³Ø­ ÙƒØ§Ø´ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                if (typeof clearTrackingLogsCache === 'function') {
                    clearTrackingLogsCache();
                }
            } catch (logError) {
                console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, logError);
            }
        }

        console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${createdCount} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©`);

        return {
            success: true,
            createdCount,
            totalUnits: linkedUnits.length
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:', error);
        return { success: false, reason: error.message };
    }
}

// ğŸ”§ Ø¯Ø§Ù„Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©
async function syncLinkedUnitsData(contractNumber, propertyName, sourceUnitData, operationType = 'link') {
    try {
        console.log(`ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø¹Ù‚Ø¯ ${contractNumber}...`);

        if (!contractNumber || contractNumber.trim() === '') {
            console.warn('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙØ§Ø±ØºØŒ ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
            return { success: false, reason: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙØ§Ø±Øº' };
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯
        const linkedUnits = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        if (linkedUnits.length <= 1) {
            console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø£Ø®Ø±Ù‰ Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
            return { success: true, updatedCount: 0, reason: 'ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·' };
        }

        console.log(`ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${linkedUnits.length} ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©`);

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§
        const sharedData = {
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': sourceUnitData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
            'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': sourceUnitData['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'] || '',
            'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ': sourceUnitData['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ'] || '',

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': sourceUnitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || '',
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': sourceUnitData['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || '',
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': sourceUnitData['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø³ÙƒÙ†ÙŠ',

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ù…Ù† Ø§Ù„Ø£ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø§Ø´Ø±)
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹'] || '',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±': sourceUnitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±'] || '',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±': sourceUnitData['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±'] || '',
            'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·': sourceUnitData['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'] || '',

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
            'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«': new Date().toLocaleDateString('ar-SA'),
            'Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«': `Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ - ${operationType}`,
            'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«': getCurrentUser()
        };

        let updatedCount = 0;
        let supabaseUpdates = [];

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©
        for (const unit of linkedUnits) {
            const unitIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
            );

            if (unitIndex !== -1) {
                // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ„ ÙˆØ­Ø¯Ø©
                const preservedData = {
                    'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': properties[unitIndex]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                    'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': properties[unitIndex]['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'],
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©': properties[unitIndex]['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©'],
                    'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': properties[unitIndex]['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'],
                    'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'],
                    'Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ': properties[unitIndex]['Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ'],
                    'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': properties[unitIndex]['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '],
                    'Ø§Ù„Ù…Ø§Ù„Ùƒ': properties[unitIndex]['Ø§Ù„Ù…Ø§Ù„Ùƒ'],
                    'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': properties[unitIndex]['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±']
                };

                // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                properties[unitIndex] = {
                    ...properties[unitIndex],
                    ...sharedData,
                    ...preservedData // Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªØºÙŠÙŠØ±Ù‡Ø§
                };

                updatedCount++;
                console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©`);

                // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø© Ù…Ø±ØªØ¨Ø·Ø©
                try {
                    const changes = {};
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
                    if (sharedData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] !== unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']) {
                        changes['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = {
                            old: unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº',
                            new: sharedData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº',
                            fieldName: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'
                        };
                    }
                    if (sharedData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] !== unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {
                        changes['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = {
                            old: unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ÙØ§Ø±Øº',
                            new: sharedData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ÙØ§Ø±Øº',
                            fieldName: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'
                        };
                    }
                    if (sharedData['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] !== unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']) {
                        changes['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] = {
                            old: unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || '0',
                            new: sharedData['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || '0',
                            fieldName: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±'
                        };
                    }

                    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                    if (typeof addChangeLog === 'function') {
                        await addChangeLog(
                            operationType === 'link' ? 'Ø±Ø¨Ø· ÙˆØ­Ø¯Ø©' : 'Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©',
                            properties[unitIndex],
                            changes,
                            {
                                contractNumber: contractNumber,
                                propertyName: propertyName,
                                operationType: operationType,
                                syncedFields: Object.keys(sharedData).length,
                                reason: `Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}`
                            }
                        );
                        console.log(`ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
                    }
                } catch (logError) {
                    console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, logError);
                }

                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø­ÙØ¸ ÙÙŠ Supabase
                supabaseUpdates.push(properties[unitIndex]);
            }
        }

        // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Supabase
        let supabaseSuccessCount = 0;
        if (typeof savePropertyToSupabase === 'function') {
            for (const updatedUnit of supabaseUpdates) {
                try {
                    const result = await savePropertyToSupabase(updatedUnit);
                    if (result && result.success) {
                        supabaseSuccessCount++;
                        console.log(`â˜ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${updatedUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                    }
                } catch (error) {
                    console.error(`âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${updatedUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase:`, error);
                }
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        console.log(`ğŸ‰ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${updatedCount} ÙˆØ­Ø¯Ø©ØŒ ØªÙ… Ø­ÙØ¸ ${supabaseSuccessCount} ÙÙŠ Supabase`);

        return {
            success: true,
            updatedCount,
            supabaseSuccessCount,
            totalUnits: linkedUnits.length,
            sharedFields: Object.keys(sharedData).length
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©:', error);
        return { success: false, reason: error.message };
    }
}

// ğŸ”§ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function updateLinkedUnitsOnEdit(editedUnitData) {
    try {
        const contractNumber = editedUnitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'];
        const propertyName = editedUnitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

        if (!contractNumber || contractNumber.trim() === '') {
            console.log('â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¹Ù‚Ø¯ØŒ ØªØ®Ø·ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©');
            return { success: true, reason: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø¯' };
        }

        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}...`);

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯
        const linkedUnits = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        if (linkedUnits.length <= 1) {
            console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø£Ø®Ø±Ù‰ Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«');
            return { success: true, updatedCount: 0, reason: 'ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·' };
        }

        console.log(`ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${linkedUnits.length} ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«`);

        // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ«Ù‡Ø§
        const sharedFields = [
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±',
            'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'
        ];

        let updatedCount = 0;
        let supabaseUpdates = [];

        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©
        for (const unit of linkedUnits) {
            const unitIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
            );

            if (unitIndex !== -1) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ÙÙ‚Ø·
                let hasChanges = false;
                for (const field of sharedFields) {
                    if (editedUnitData[field] !== undefined &&
                        properties[unitIndex][field] !== editedUnitData[field]) {
                        properties[unitIndex][field] = editedUnitData[field];
                        hasChanges = true;
                    }
                }

                if (hasChanges) {
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
                    properties[unitIndex]['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
                    properties[unitIndex]['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = 'ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©';
                    properties[unitIndex]['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();

                    updatedCount++;
                    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©`);

                    // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                    try {
                        const changes = {};
                        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·
                        for (const field of sharedFields) {
                            if (editedUnitData[field] !== undefined &&
                                unit[field] !== editedUnitData[field]) {
                                changes[field] = {
                                    old: unit[field] || 'ÙØ§Ø±Øº',
                                    new: editedUnitData[field] || 'ÙØ§Ø±Øº',
                                    fieldName: field
                                };
                            }
                        }

                        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                        if (typeof addChangeLog === 'function' && Object.keys(changes).length > 0) {
                            await addChangeLog(
                                'ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©',
                                properties[unitIndex],
                                changes,
                                {
                                    contractNumber: contractNumber,
                                    propertyName: propertyName,
                                    updatedFields: Object.keys(changes),
                                    reason: `ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}`
                                }
                            );
                            console.log(`ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
                        }
                    } catch (logError) {
                        console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, logError);
                    }

                    // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø­ÙØ¸ ÙÙŠ Supabase
                    supabaseUpdates.push(properties[unitIndex]);
                }
            }
        }

        // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Supabase
        let supabaseSuccessCount = 0;
        if (typeof savePropertyToSupabase === 'function') {
            for (const updatedUnit of supabaseUpdates) {
                try {
                    const result = await savePropertyToSupabase(updatedUnit);
                    if (result && result.success) {
                        supabaseSuccessCount++;
                        console.log(`â˜ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${updatedUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                    }
                } catch (error) {
                    console.error(`âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${updatedUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase:`, error);
                }
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        if (updatedCount > 0) {
            console.log(`ğŸ‰ ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø©ØŒ ØªÙ… Ø­ÙØ¸ ${supabaseSuccessCount} ÙÙŠ Supabase`);

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`, 'success');
        }

        return {
            success: true,
            updatedCount,
            supabaseSuccessCount,
            totalUnits: linkedUnits.length
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©:', error);
        return { success: false, reason: error.message };
    }
}

// Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø· - Ù…Ø­Ø³Ù† Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø±
function renderAvailableUnitsForLinking(propertyName, currentContractNumber, currentUnitNumber) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!ensurePropertiesLoaded('renderAvailableUnitsForLinking')) {
        return '<p class="no-units">Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</p>';
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙÙ‚Ø· ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø±
    const allUnitsInProperty = properties.filter(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] !== currentUnitNumber &&
        (!p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] !== currentContractNumber) &&
        (!p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === '')
    );

    if (allUnitsInProperty.length === 0) {
        return `<div class="no-units-message">
            <i class="fas fa-info-circle"></i>
            Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø· ÙÙŠ Ø¹Ù‚Ø§Ø± "${propertyName}"
        </div>`;
    }

    // ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙÙ‚Ø· Ù…Ø¹ Ø²Ø± Ø±Ø¨Ø· ÙØ¹Ø§Ù„
    return `
        <div class="simple-unit-linking">
            ${allUnitsInProperty.map(unit => `
                <div class="empty-unit-item" data-unit-number="${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}">
                    <div class="unit-info">
                        <i class="fas fa-home"></i>
                        <span class="unit-number">ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}</span>
                        ${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? `<span class="unit-area">${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']} Ù…Â²</span>` : ''}
                    </div>
                    <button type="button" onclick="performRealUnitLinking('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}')"
                            class="btn-link-empty-unit"
                            title="Ø±Ø¨Ø· Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ§Ø±ØºØ©">
                        <i class="fas fa-link"></i> Ø±Ø¨Ø·
                    </button>
                </div>
            `).join('')}
        </div>
    `;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©
function getUnitStatusText(unit) {
    if (unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '') {
        return 'Ù…Ø´ØºÙˆÙ„Ø©';
    } else {
        return 'ÙØ§Ø±ØºØ©';
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
async function performRealUnitLinking(unitNumber) {
    if (!unitNumber) {
        alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
    }

    console.log(`ğŸ”— Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}...`);

    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const form = document.getElementById('propertyEditForm') || document.getElementById('multiUnitEditForm');
        if (!form) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        }

        const formData = new FormData(form);
        const currentPropertyName = formData.get('propertyName') || formData.get('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
        const currentTenant = formData.get('tenantName') || formData.get('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±');
        const currentContract = formData.get('contractNumber') || formData.get('Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯');
        const currentRent = formData.get('rentValue') || formData.get('Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ');
        const currentOwner = formData.get('owner') || formData.get('Ø§Ù„Ù…Ø§Ù„Ùƒ');
        const currentDeed = formData.get('deedNumber') || formData.get('Ø±Ù‚Ù… Ø§Ù„ØµÙƒ');

        if (!currentPropertyName) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Supabase
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
        console.log(`ğŸ“‹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase...`);
        const { data: unitData, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', currentPropertyName)
            .single();

        if (searchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©: ${searchError.message}`);
        }

        if (!unitData) {
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase`);
        }

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ©
        if (unitData.tenant_name && unitData.tenant_name.trim() !== '') {
            throw new Error(`Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ø´ØºÙˆÙ„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${unitData.tenant_name}`);
        }

        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        const confirmMessage = `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ§Ø±ØºØ© ${unitNumber}ØŸ

ğŸ  Ø§Ù„Ø¹Ù‚Ø§Ø±: ${currentPropertyName}
ğŸ‘¤ Ø³ÙŠØªÙ… Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${currentTenant || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
ğŸ“„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ${currentContract || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
ğŸ’° Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${currentRent ? parseFloat(currentRent).toLocaleString() + ' Ø±ÙŠØ§Ù„' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Supabase ÙÙˆØ±Ø§Ù‹.`;

        if (!confirm(confirmMessage)) {
            return;
        }

        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        const linkButton = document.querySelector(`[onclick="performRealUnitLinking('${unitNumber}')"]`);
        if (linkButton) {
            linkButton.disabled = true;
            linkButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø·...';
        }

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ø¯ÙŠØ«
        const updateData = {
            tenant_name: currentTenant || '',
            contract_number: currentContract || '',
            rent_value: currentRent ? parseFloat(currentRent) : null,
            owner: currentOwner || '',
            deed_number: currentDeed || '',
            updated_at: new Date().toISOString()
        };

        console.log(`â˜ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase...`);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
        const { data: updatedData, error: updateError } = await supabaseClient
            .from('properties')
            .update(updateData)
            .eq('id', unitData.id)
            .select();

        if (updateError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø©: ${updateError.message}`);
        }

        if (!updatedData || updatedData.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        }

        console.log(`âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase`);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        if (properties && Array.isArray(properties)) {
            const localUnitIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentPropertyName
            );

            if (localUnitIndex !== -1) {
                properties[localUnitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = currentTenant || '';
                properties[localUnitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = currentContract || '';
                properties[localUnitIndex]['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] = currentRent || '';
                properties[localUnitIndex]['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = currentOwner || '';
                properties[localUnitIndex]['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] = currentDeed || '';

                // Ø­ÙØ¸ ÙÙŠ localStorage
                localStorage.setItem('propertyData', JSON.stringify(properties));
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        const availableUnitsDiv = document.getElementById('availableUnitsForLinking');
        if (availableUnitsDiv) {
            availableUnitsDiv.innerHTML = renderAvailableUnitsForLinking(
                currentPropertyName,
                currentContract,
                formData.get('unitNumber') || formData.get('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ')
            );
        }

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const successMessage = `ğŸ‰ ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!

âœ… Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}
ğŸ  Ø§Ù„Ø¹Ù‚Ø§Ø±: ${currentPropertyName}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${currentTenant || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯: ${currentContract || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©

ğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Supabase Dashboard`;

        alert(successMessage);
        showToast(`ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);

        const errorMessage = `âŒ ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Supabase
â€¢ Ø£Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ© ÙØ¹Ù„Ø§Ù‹`;

        alert(errorMessage);
        showToast(`ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`, 'error');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        const linkButton = document.querySelector(`[onclick="performRealUnitLinking('${unitNumber}')"]`);
        if (linkButton) {
            linkButton.disabled = false;
            linkButton.innerHTML = '<i class="fas fa-link"></i> Ø±Ø¨Ø·';
        }
    }
}

function linkUnitFromModal(unitNumber) {
    if (!unitNumber) {
        alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
    }

    console.log(`ğŸ”— Ø¨Ø¯Ø¡ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©...`);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const form = document.getElementById('propertyEditForm') || document.getElementById('multiUnitEditForm');
    if (!form) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        return;
    }

    const formData = new FormData(form);
    const currentPropertyName = formData.get('propertyName') || formData.get('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
    const currentContractNumber = formData.get('contractNumber') || formData.get('Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯');

    if (!currentPropertyName) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const unitToLink = properties.find(unit =>
        unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
        unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentPropertyName
    );

    if (!unitToLink) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    const confirmMessage = `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}ØŸ

ğŸ  Ø§Ù„Ø¹Ù‚Ø§Ø±: ${currentPropertyName}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${unitToLink['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${unitToLink['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ÙØ§Ø±Øº'}

Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… toggleUnitLinking
    toggleUnitLinking(unitNumber, currentPropertyName, currentContractNumber);
}

function previewUnitLinkingFromModal(unitNumber) {
    const form = document.getElementById('propertyEditForm') || document.getElementById('multiUnitEditForm');
    if (!form) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        return;
    }

    const formData = new FormData(form);
    const currentPropertyName = formData.get('propertyName') || formData.get('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
    const currentTenant = formData.get('tenantName') || formData.get('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±');
    const currentContract = formData.get('contractNumber') || formData.get('Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯');
    const currentRent = formData.get('rentValue') || formData.get('Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ');

    const unitToPreview = properties.find(unit =>
        unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
        unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentPropertyName
    );

    if (!unitToPreview) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    const previewMessage = `ğŸ” Ù…Ø¹Ø§ÙŠÙ†Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©

ğŸ  Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡Ø§: ${unitNumber}
ğŸ“ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${unitToPreview['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${unitToPreview['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${unitToPreview['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ÙØ§Ø±Øº'}

â¬‡ï¸ Ø³ØªØµØ¨Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¨Ø·:
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${currentTenant || 'ÙØ§Ø±Øº'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${currentContract || 'ÙØ§Ø±Øº'}
ğŸ’° Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${currentRent ? parseFloat(currentRent).toLocaleString() + ' Ø±ÙŠØ§Ù„' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø±Ø¨Ø·ØŸ`;

    if (confirm(previewMessage)) {
        linkUnitFromModal(unitNumber);
    }
}

function showBulkLinkingFromModal() {
    alert('Ù…ÙŠØ²Ø© Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø³ØªÙƒÙˆÙ† Ù…ØªÙˆÙØ±Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹!\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰.');
}

function linkAllEmptyUnitsFromModal() {
    const form = document.getElementById('propertyEditForm') || document.getElementById('multiUnitEditForm');
    if (!form) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        return;
    }

    const formData = new FormData(form);
    const currentPropertyName = formData.get('propertyName') || formData.get('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
    const currentContractNumber = formData.get('contractNumber') || formData.get('Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯');
    const currentUnitNumber = formData.get('unitNumber') || formData.get('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
    const emptyUnits = properties.filter(unit =>
        unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentPropertyName &&
        unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] !== currentUnitNumber &&
        (!unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] !== currentContractNumber) &&
        (!unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === '')
    );

    if (emptyUnits.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø·');
        return;
    }

    const confirmMessage = `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©ØŸ

Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${emptyUnits.length} ÙˆØ­Ø¯Ø©
Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${emptyUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']).join(', ')}

Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    // Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
    let successCount = 0;
    emptyUnits.forEach((unit, index) => {
        setTimeout(() => {
            try {
                toggleUnitLinking(unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '], currentPropertyName, currentContractNumber);
                successCount++;

                if (index === emptyUnits.length - 1) {
                    // Ø¢Ø®Ø± ÙˆØ­Ø¯Ø©
                    setTimeout(() => {
                        alert(`ØªÙ… Ø±Ø¨Ø· ${successCount} ÙˆØ­Ø¯Ø© Ù…Ù† Ø£ØµÙ„ ${emptyUnits.length} ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
                    }, 500);
                }
            } catch (error) {
                console.error(`Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, error);
            }
        }, index * 500); // ØªÙˆÙ‚Ù Ù†ØµÙ Ø«Ø§Ù†ÙŠØ© Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ø¨Ø·
    });
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.performRealUnitLinking = performRealUnitLinking;

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function testNewLinkingInterface() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!properties || properties.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚Ø§Ø±Ø§Øª');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ©
        const propertyNames = [...new Set(properties.map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']))];
        let testProperty = null;
        let emptyUnits = [];

        for (const propertyName of propertyNames) {
            const unitsInProperty = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
            const emptyUnitsInProperty = unitsInProperty.filter(p =>
                !p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === ''
            );

            if (emptyUnitsInProperty.length > 0) {
                testProperty = propertyName;
                emptyUnits = emptyUnitsInProperty;
                break;
            }
        }

        if (!testProperty || emptyUnits.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© renderAvailableUnitsForLinking
        console.log(`ğŸ“‹ Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙÙŠ Ø¹Ù‚Ø§Ø±: ${testProperty}`);
        const renderedHTML = renderAvailableUnitsForLinking(testProperty, '', emptyUnits[0]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);

        if (!renderedHTML || renderedHTML.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ©')) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ HTML
        const requiredElements = [
            'unitSelector',
            'btn-link-selected',
            'linkSelectedUnitFromModal',
            'Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø·'
        ];

        let missingElements = [];
        requiredElements.forEach(element => {
            if (!renderedHTML.includes(element)) {
                missingElements.push(element);
            }
        });

        if (missingElements.length > 0) {
            throw new Error(`Ø¹Ù†Ø§ØµØ± Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ HTML: ${missingElements.join(', ')}`);
        }

        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const successMessage = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!

âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${testProperty}
âœ… Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©: ${emptyUnits.length} ÙˆØ­Ø¯Ø©
âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ HTML Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø¬Ø§Ø­
âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©

ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© Ø§Ù„Ù…ØªØ§Ø­Ø©:
${emptyUnits.map(u => `â€¢ ÙˆØ­Ø¯Ø© ${u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${u['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? u['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] + ' Ù…Â²' : 'Ù…Ø³Ø§Ø­Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}`).join('\n')}

ğŸ¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!
ğŸ’¡ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± Ù„Ø£ÙŠ Ø¨Ø·Ø§Ù‚Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©`;

        alert(successMessage);
        showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!', 'success');
        console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª');

        return {
            success: true,
            testProperty,
            emptyUnitsCount: emptyUnits.length,
            emptyUnits: emptyUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '])
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', error);

        const errorMessage = `âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
â€¢ ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
â€¢ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', 'error');

        return { success: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.testNewLinkingInterface = testNewLinkingInterface;

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©
function testSimpleLinkingInterface() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!properties || properties.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚Ø§Ø±Ø§Øª');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ©
        const emptyUnits = properties.filter(p =>
            !p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === ''
        );

        if (emptyUnits.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© renderAvailableUnitsForLinking
        const testProperty = emptyUnits[0]['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        const testUnit = emptyUnits[0]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];

        console.log(`ğŸ“‹ Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙÙŠ Ø¹Ù‚Ø§Ø±: ${testProperty}`);
        const renderedHTML = renderAvailableUnitsForLinking(testProperty, '', testUnit);

        if (!renderedHTML || renderedHTML.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ©')) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const requiredElements = [
            'simple-unit-linking',
            'empty-unit-item',
            'performRealUnitLinking',
            'btn-link-empty-unit'
        ];

        let missingElements = [];
        requiredElements.forEach(element => {
            if (!renderedHTML.includes(element)) {
                missingElements.push(element);
            }
        });

        if (missingElements.length > 0) {
            throw new Error(`Ø¹Ù†Ø§ØµØ± Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ HTML: ${missingElements.join(', ')}`);
        }

        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const successMessage = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©!

âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${emptyUnits.length} ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ©
âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ HTML Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­
âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
âœ… Ø¯Ø§Ù„Ø© performRealUnitLinking Ø¬Ø§Ù‡Ø²Ø©

ğŸ“‹ Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©:
${emptyUnits.slice(0, 5).map(u => `â€¢ ÙˆØ­Ø¯Ø© ${u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ ${u['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`).join('\n')}

ğŸ¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!
ğŸ’¡ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± Ù„Ø£ÙŠ Ø¨Ø·Ø§Ù‚Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙÙ‚Ø· Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¨Ø·`;

        alert(successMessage);
        showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©!', 'success');
        console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©');

        return {
            success: true,
            emptyUnitsCount: emptyUnits.length,
            testProperty,
            sampleUnits: emptyUnits.slice(0, 5).map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '])
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©:', error);

        const errorMessage = `âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
â€¢ ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
â€¢ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©', 'error');

        return { success: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.testSimpleLinkingInterface = testSimpleLinkingInterface;

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª
async function testUnitUnlinkingAndClearing() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        if (!properties || properties.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚Ø§Ø±Ø§Øª');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const linkedUnits = properties.filter(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '' &&
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] && p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'].trim() !== ''
        );

        if (linkedUnits.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        const testUnit = linkedUnits[0];
        const unitNumber = testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
        const propertyName = testUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

        console.log(`ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber} ÙÙŠ Ø¹Ù‚Ø§Ø±: ${propertyName}`);

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙØµÙ„
        console.log('ğŸ“‹ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙØµÙ„...');
        const { data: beforeData, error: beforeError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName)
            .single();

        if (beforeError || !beforeData) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ÙØµÙ„');
        }

        if (!beforeData.tenant_name || beforeData.tenant_name.trim() === '') {
            throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ© Ø¨Ø§Ù„ÙØ¹Ù„ - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„');
        }

        console.log('âœ… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:', {
            tenant: beforeData.tenant_name,
            contract: beforeData.contract_number,
            rent: beforeData.rent_value
        });

        // 2. Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØµÙ„ (Ø¨Ø¯ÙˆÙ† ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        console.log('ğŸ”“ ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø¥ÙØ±Ø§Øº...');

        // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Supabase
        const emptyData = {
            tenant_name: '',
            contract_number: '',
            rent_value: null,
            contract_type: null,
            start_date: null,
            end_date: null,
            total_amount: null,
            owner: '',
            deed_number: '',
            real_estate_registry: '',
            electricity_account: '',
            remaining_installments: null,
            first_installment_date: null,
            first_installment_amount: null,
            second_installment_date: null,
            second_installment_amount: null,
            installment_end_date: null,
            updated_at: new Date().toISOString()
        };

        const { data: afterData, error: updateError } = await supabaseClient
            .from('properties')
            .update(emptyData)
            .eq('id', beforeData.id)
            .select();

        if (updateError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${updateError.message}`);
        }

        if (!afterData || afterData.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙØ±Ø§Øº');
        }

        console.log('âœ… ØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙØ±Ø§Øº
        console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        const clearedData = afterData[0];

        const fieldsToCheck = [
            'tenant_name', 'contract_number', 'rent_value', 'contract_type',
            'start_date', 'end_date', 'total_amount', 'owner', 'deed_number',
            'real_estate_registry', 'electricity_account', 'remaining_installments',
            'first_installment_date', 'first_installment_amount',
            'second_installment_date', 'second_installment_amount', 'installment_end_date'
        ];

        let notClearedFields = [];
        fieldsToCheck.forEach(field => {
            const value = clearedData[field];
            if (value !== null && value !== '' && value !== undefined) {
                notClearedFields.push(`${field}: ${value}`);
            }
        });

        if (notClearedFields.length > 0) {
            throw new Error(`Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù… ÙŠØªÙ… Ø¥ÙØ±Ø§ØºÙ‡Ø§: ${notClearedFields.join(', ')}`);
        }

        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');

        // 4. Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©...');
        const restoreData = {
            tenant_name: beforeData.tenant_name,
            contract_number: beforeData.contract_number,
            rent_value: beforeData.rent_value,
            contract_type: beforeData.contract_type,
            start_date: beforeData.start_date,
            end_date: beforeData.end_date,
            total_amount: beforeData.total_amount,
            owner: beforeData.owner,
            deed_number: beforeData.deed_number,
            real_estate_registry: beforeData.real_estate_registry,
            electricity_account: beforeData.electricity_account,
            remaining_installments: beforeData.remaining_installments,
            first_installment_date: beforeData.first_installment_date,
            first_installment_amount: beforeData.first_installment_amount,
            second_installment_date: beforeData.second_installment_date,
            second_installment_amount: beforeData.second_installment_amount,
            installment_end_date: beforeData.installment_end_date,
            updated_at: new Date().toISOString()
        };

        const { error: restoreError } = await supabaseClient
            .from('properties')
            .update(restoreData)
            .eq('id', beforeData.id);

        if (restoreError) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©:', restoreError.message);
        } else {
            console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        }

        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const successMessage = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª!

âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù†Ø¬Ø­Øª:
ğŸ”— Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø©: ${unitNumber}
ğŸ  Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: ${beforeData.tenant_name}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø£ØµÙ„ÙŠ: ${beforeData.contract_number}

ğŸ”“ ØªÙ… Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø¥ÙØ±Ø§Øº Ø¨Ù†Ø¬Ø§Ø­:
â€¢ ØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase
â€¢ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„
â€¢ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©

ğŸ¯ Ù†Ø¸Ø§Ù… Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø¥ÙØ±Ø§Øº ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!`;

        alert(successMessage);
        showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª!', 'success');
        console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª');

        return {
            success: true,
            testedUnit: unitNumber,
            originalData: beforeData,
            clearedSuccessfully: true,
            restoredSuccessfully: !restoreError
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', error);

        const errorMessage = `âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ Ø§ØªØµØ§Ù„ Supabase
â€¢ ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø§Øª', 'error');

        return { success: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.testUnitUnlinkingAndClearing = testUnitUnlinkingAndClearing;

// Ø¯Ø§Ù„Ø© Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© (ØªØ¹Ù…Ù„ Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±)
async function clearUnitData(unitNumber) {
    if (!unitNumber) {
        alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø¨Ø¯Ø¡ Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±...`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let unitToClear = null;
    let propertyName = null;

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ (Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±)
    if (window.currentEditingUnits && window.currentEditingUnits.length > 0) {
        unitToClear = window.currentEditingUnits.find(unit =>
            unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );
        if (unitToClear) {
            propertyName = unitToClear['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        }
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯
    if (!unitToClear && properties && Array.isArray(properties)) {
        unitToClear = properties.find(unit =>
            unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );
        if (unitToClear) {
            propertyName = unitToClear['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        }
    }

    if (!unitToClear || !propertyName) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    console.log(`ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber} ÙÙŠ Ø¹Ù‚Ø§Ø±: ${propertyName}`);

    // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…ÙØµÙ„Ø©
    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}ØŸ

ğŸ—‘ï¸ Ø³ÙŠØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
â€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±
â€¢ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
â€¢ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯ (Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©)
â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
â€¢ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡
â€¢ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº)

âœ… Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
â€¢ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
â€¢ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
â€¢ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
â€¢ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
â€¢ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙƒ
â€¢ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ

â˜ï¸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥ÙØ±Ø§Øº ÙÙˆØ±Ø§Ù‹ ÙÙŠ Supabase
ğŸ“± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;

    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Supabase
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
        console.log(`ğŸ“‹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Ø¹Ù‚Ø§Ø± ${propertyName} ÙÙŠ Supabase...`);
        const { data: unitInSupabase, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName)
            .single();

        if (searchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©: ${searchError.message}`);
        }

        if (!unitInSupabase) {
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase`);
        }

        console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase - ID: ${unitInSupabase.id}`);

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ØªØ§Ù… - Ù†Ù‡Ø¬ Ø´Ø§Ù…Ù„
        const emptyData = {};

        // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø¥ÙØ±Ø§ØºÙ‡Ø§
        const fieldsToEmpty = [
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
            'tenant_name', 'contract_number', 'rent_value', 'contract_type',
            'start_date', 'end_date', 'total_amount', 'electricity_account',
            'remaining_installments', 'installment_count', 'installment_end_date',

            // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (1-10)
            'first_installment_date', 'first_installment_amount',
            'second_installment_date', 'second_installment_amount',
            'third_installment_date', 'third_installment_amount',
            'fourth_installment_date', 'fourth_installment_amount',
            'fifth_installment_date', 'fifth_installment_amount',
            'sixth_installment_date', 'sixth_installment_amount',
            'seventh_installment_date', 'seventh_installment_amount',
            'eighth_installment_date', 'eighth_installment_amount',
            'ninth_installment_date', 'ninth_installment_amount',
            'tenth_installment_date', 'tenth_installment_amount',

            // Ø£Ù‚Ø³Ø§Ø· Ø¨ØµÙŠØºØ© Ø£Ø®Ø±Ù‰
            'installment_1_date', 'installment_1_amount',
            'installment_2_date', 'installment_2_amount',
            'installment_3_date', 'installment_3_amount',
            'installment_4_date', 'installment_4_amount',
            'installment_5_date', 'installment_5_amount',
            'installment_6_date', 'installment_6_amount',
            'installment_7_date', 'installment_7_amount',
            'installment_8_date', 'installment_8_amount',
            'installment_9_date', 'installment_9_amount',
            'installment_10_date', 'installment_10_amount',

            // Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ©
            'notes', 'status', 'payment_method', 'bank_account'
        ];

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        fieldsToEmpty.forEach(field => {
            if (unitInSupabase.hasOwnProperty(field)) {
                // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§Ø±ØºØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚Ù„
                if (field.includes('date') || field.includes('amount') || field.includes('value') || field.includes('count')) {
                    emptyData[field] = null;
                } else {
                    emptyData[field] = '';
                }
            }
        });

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ©
        Object.keys(unitInSupabase).forEach(key => {
            const lowerKey = key.toLowerCase();
            if ((lowerKey.includes('installment') || lowerKey.includes('total') ||
                 lowerKey.includes('amount') || lowerKey.includes('rent') ||
                 lowerKey.includes('contract') || lowerKey.includes('tenant')) &&
                !lowerKey.includes('unit_number') && !lowerKey.includes('property_name') &&
                !lowerKey.includes('city') && !lowerKey.includes('area') &&
                !lowerKey.includes('owner') && !lowerKey.includes('deed') &&
                !lowerKey.includes('registry') && !emptyData.hasOwnProperty(key)) {

                emptyData[key] = typeof unitInSupabase[key] === 'number' ? null : '';
            }
        });

        emptyData.updated_at = new Date().toISOString();

        console.log(`ğŸ—‘ï¸ Ø³ÙŠØªÙ… Ø¥ÙØ±Ø§Øº ${Object.keys(emptyData).length} Ø­Ù‚Ù„:`, Object.keys(emptyData));

        console.log(`â˜ï¸ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ØªØ§Ù… ÙÙŠ Supabase...`);

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥ÙØ±Ø§Øº ÙÙŠ Supabase
        const { data: updatedUnit, error: updateError } = await supabaseClient
            .from('properties')
            .update(emptyData)
            .eq('id', unitInSupabase.id)
            .select();

        if (updateError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${updateError.message}`);
        }

        if (!updatedUnit || updatedUnit.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙØ±Ø§Øº');
        }

        console.log(`âœ… ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ØªØ§Ù… ÙÙŠ Supabase - ØªÙ… Ø¥ÙØ±Ø§Øº ${Object.keys(emptyData).length} Ø­Ù‚Ù„`);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙØ±Ø§Øº
        const clearedUnit = updatedUnit[0];
        let notClearedFields = [];
        Object.keys(emptyData).forEach(field => {
            if (field !== 'updated_at' && clearedUnit[field] !== null && clearedUnit[field] !== '') {
                notClearedFields.push(field);
            }
        });

        if (notClearedFields.length > 0) {
            console.warn(`âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù… ÙŠØªÙ… Ø¥ÙØ±Ø§ØºÙ‡Ø§: ${notClearedFields.join(', ')}`);
        } else {
            console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ØªØ§Ù… - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ©');
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        if (properties && Array.isArray(properties)) {
            const localUnitIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === unitToClear['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
            );

            if (localUnitIndex !== -1) {
                // Ø¥ÙØ±Ø§Øº ØªØ§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const fieldsToEmpty = [
                    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰', 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©',

                    // Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·',

                    // Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ©
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ'
                ];

                // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                fieldsToEmpty.forEach(field => {
                    if (properties[localUnitIndex].hasOwnProperty(field)) {
                        properties[localUnitIndex][field] = '';
                    }
                });

                // Ø¥ÙØ±Ø§Øº Ø£Ù‚Ø³Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© (3-10) Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
                for (let i = 3; i <= 10; i++) {
                    const arabicNumber = getArabicNumber(i);
                    const dateField = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${arabicNumber}`;
                    const amountField = `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${arabicNumber}`;

                    if (properties[localUnitIndex].hasOwnProperty(dateField)) {
                        properties[localUnitIndex][dateField] = '';
                    }
                    if (properties[localUnitIndex].hasOwnProperty(amountField)) {
                        properties[localUnitIndex][amountField] = '';
                    }
                }

                // Ø¥ÙØ±Ø§Øº Ø£Ù‚Ø³Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
                for (let i = 1; i <= 10; i++) {
                    const dateField = `installment_${i}_date`;
                    const amountField = `installment_${i}_amount`;

                    if (properties[localUnitIndex].hasOwnProperty(dateField)) {
                        properties[localUnitIndex][dateField] = '';
                    }
                    if (properties[localUnitIndex].hasOwnProperty(amountField)) {
                        properties[localUnitIndex][amountField] = '';
                    }
                }

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø­Ù‚ÙˆÙ„ Ø£Ø®Ø±Ù‰ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "Ù‚Ø³Ø·" Ø£Ùˆ "installment"
                Object.keys(properties[localUnitIndex]).forEach(key => {
                    if ((key.includes('Ù‚Ø³Ø·') || key.includes('installment') ||
                         key.includes('Ø§Ø¬Ù…Ø§Ù„Ù‰') || key.includes('total')) &&
                        !key.includes('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ') && !key.includes('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±')) {
                        properties[localUnitIndex][key] = '';
                    }
                });

                saveDataLocally();
                console.log('âœ… ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ØªØ§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø´Ø§Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„)');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© - Ø¥ÙØ±Ø§Øº ØªØ§Ù…
        if (window.currentEditingUnits) {
            const currentUnitIndex = window.currentEditingUnits.findIndex(unit =>
                unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
            );

            if (currentUnitIndex !== -1) {
                const currentUnit = window.currentEditingUnits[currentUnitIndex];

                // Ø¥ÙØ±Ø§Øº ØªØ§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const fieldsToEmpty = [
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰', 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ', 'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·',
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ'
                ];

                fieldsToEmpty.forEach(field => {
                    if (currentUnit.hasOwnProperty(field)) {
                        currentUnit[field] = '';
                    }
                });

                // Ø¥ÙØ±Ø§Øº Ø£Ù‚Ø³Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© (3-10)
                for (let i = 3; i <= 10; i++) {
                    const arabicNumber = getArabicNumber(i);
                    const dateField = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${arabicNumber}`;
                    const amountField = `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${arabicNumber}`;

                    if (currentUnit.hasOwnProperty(dateField)) {
                        currentUnit[dateField] = '';
                    }
                    if (currentUnit.hasOwnProperty(amountField)) {
                        currentUnit[amountField] = '';
                    }
                }

                // Ø¥ÙØ±Ø§Øº Ø£ÙŠ Ø­Ù‚ÙˆÙ„ Ø£Ø®Ø±Ù‰ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
                Object.keys(currentUnit).forEach(key => {
                    if ((key.includes('Ù‚Ø³Ø·') || key.includes('installment') ||
                         key.includes('Ø§Ø¬Ù…Ø§Ù„Ù‰') || key.includes('total')) &&
                        !key.includes('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ') && !key.includes('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±')) {
                        currentUnit[key] = '';
                    }
                });

                console.log('âœ… ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ØªØ§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙˆØ±Ø§Ù‹
        if (typeof updateLinkedUnitsDisplay === 'function') {
            updateLinkedUnitsDisplay();
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…ÙØªÙˆØ­Ø©
        if (typeof refreshEditingInterface === 'function') {
            refreshEditingInterface();
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (typeof initializeApp === 'function') {
            initializeApp();
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
        if (typeof displayProperties === 'function') {
            displayProperties();
        }

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const successMessage = `ğŸ‰ ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ØªØ§Ù… Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}!

ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ${Object.keys(emptyData).length} Ø­Ù‚Ù„ Ù…Ù† Supabase:
â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: Ù…Ø­Ø°ÙˆÙ âœ“
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: Ù…Ø­Ø°ÙˆÙ âœ“
â€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: Ù…Ø­Ø°ÙˆÙ âœ“
â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: Ù…Ø­Ø°ÙˆÙ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ âœ“
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (1-10): Ù…Ø­Ø°ÙˆÙØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ âœ“
â€¢ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡: Ù…Ø­Ø°ÙˆÙ âœ“
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©: Ù…Ø­Ø°ÙˆÙØ© âœ“

âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:
â€¢ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}
â€¢ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}
â€¢ Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙƒ

â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase ÙÙˆØ±Ø§Ù‹
ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±
ğŸ  Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹ Ø§Ù„Ø¢Ù†

ğŸ’¡ Ø£ØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØ£Ø¹Ø¯ ÙØªØ­Ù‡Ø§ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù†ØªÙŠØ¬Ø©`;

        alert(successMessage);
        showToast(`ØªÙ… Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);

        const errorMessage = `âŒ ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Supabase
â€¢ ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`;

        alert(errorMessage);
        showToast(`ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`, 'error');
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
function getArabicNumber(num) {
    const arabicNumbers = {
        1: 'Ø§Ù„Ø§ÙˆÙ„', 2: 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 3: 'Ø§Ù„Ø«Ø§Ù„Ø«', 4: 'Ø§Ù„Ø±Ø§Ø¨Ø¹', 5: 'Ø§Ù„Ø®Ø§Ù…Ø³',
        6: 'Ø§Ù„Ø³Ø§Ø¯Ø³', 7: 'Ø§Ù„Ø³Ø§Ø¨Ø¹', 8: 'Ø§Ù„Ø«Ø§Ù…Ù†', 9: 'Ø§Ù„ØªØ§Ø³Ø¹', 10: 'Ø§Ù„Ø¹Ø§Ø´Ø±'
    };
    return arabicNumbers[num] || num.toString();
}

// Ø¯Ø§Ù„Ø© Ø¥ÙØ±Ø§Øº Ù…Ø­Ø³Ù†Ø© ØªØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
async function clearUnitDataFromCard(unitNumber, propertyName) {
    console.log(`ğŸ—‘ï¸ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${unitNumber} ÙÙŠ ${propertyName}...`);

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Supabase
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
        const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}ØŸ

ğŸ—‘ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:
â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
â€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±
â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº)
â€¢ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯

âœ… Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€:
â€¢ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
â€¢ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
â€¢ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
â€¢ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙƒ

â˜ï¸ Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù ÙÙˆØ±Ø§Ù‹ Ù…Ù† Supabase

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;

        if (!confirm(confirmMessage)) {
            return;
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase...`);
        const { data: unitData, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName)
            .single();

        if (searchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        if (!unitData) {
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        }

        console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase');

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ØªØ§Ù…
        const clearData = {};

        // Ù‚Ø§Ø¦Ù…Ø© Ø´Ø§Ù…Ù„Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø¥ÙØ±Ø§ØºÙ‡Ø§
        const fieldsToClear = [
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
            'tenant_name', 'contract_number', 'rent_value', 'contract_type',
            'start_date', 'end_date', 'total_amount', 'electricity_account',
            'remaining_installments', 'installment_count', 'installment_end_date',

            // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (1-10)
            'first_installment_date', 'first_installment_amount',
            'second_installment_date', 'second_installment_amount',
            'third_installment_date', 'third_installment_amount',
            'fourth_installment_date', 'fourth_installment_amount',
            'fifth_installment_date', 'fifth_installment_amount',
            'sixth_installment_date', 'sixth_installment_amount',
            'seventh_installment_date', 'seventh_installment_amount',
            'eighth_installment_date', 'eighth_installment_amount',
            'ninth_installment_date', 'ninth_installment_amount',
            'tenth_installment_date', 'tenth_installment_amount',

            // Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ©
            'notes', 'status', 'payment_method', 'bank_account'
        ];

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø¥ÙØ±Ø§Øº
        fieldsToClear.forEach(field => {
            if (unitData.hasOwnProperty(field)) {
                clearData[field] = field.includes('date') || field.includes('amount') || field.includes('value') || field.includes('count') ? null : '';
            }
        });

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ©
        Object.keys(unitData).forEach(key => {
            if ((key.includes('installment') || key.includes('total') || key.includes('amount') ||
                 key.includes('rent') || key.includes('contract') || key.includes('tenant')) &&
                !key.includes('unit_number') && !key.includes('property_name') &&
                !key.includes('city') && !key.includes('area') &&
                !key.includes('owner') && !key.includes('deed') && !key.includes('registry')) {
                clearData[key] = typeof unitData[key] === 'number' ? null : '';
            }
        });

        clearData.updated_at = new Date().toISOString();

        console.log(`ğŸ—‘ï¸ Ø¥ÙØ±Ø§Øº ${Object.keys(clearData).length} Ø­Ù‚Ù„ ÙÙŠ Supabase...`);

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥ÙØ±Ø§Øº ÙÙŠ Supabase
        const { data: clearedData, error: updateError } = await supabaseClient
            .from('properties')
            .update(clearData)
            .eq('id', unitData.id)
            .select();

        if (updateError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥ÙØ±Ø§Øº: ${updateError.message}`);
        }

        console.log('âœ… ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        if (properties && Array.isArray(properties)) {
            const localIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
            );

            if (localIndex !== -1) {
                // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const localFieldsToEmpty = [
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰', 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'
                ];

                localFieldsToEmpty.forEach(field => {
                    if (properties[localIndex].hasOwnProperty(field)) {
                        properties[localIndex][field] = '';
                    }
                });

                // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                for (let i = 1; i <= 10; i++) {
                    const arabicNum = getArabicNumber(i);
                    const dateField = i <= 2 ?
                        (i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' : 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ') :
                        `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${arabicNum}`;
                    const amountField = i <= 2 ?
                        (i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' : 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ') :
                        `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${arabicNum}`;

                    if (properties[localIndex].hasOwnProperty(dateField)) {
                        properties[localIndex][dateField] = '';
                    }
                    if (properties[localIndex].hasOwnProperty(amountField)) {
                        properties[localIndex][amountField] = '';
                    }
                }

                saveDataLocally();
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
        if (typeof displayProperties === 'function') {
            displayProperties();
        }
        if (typeof initializeApp === 'function') {
            initializeApp();
        }

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const successMessage = `ğŸ‰ ØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ø§Ù„ÙƒØ§Ù…Ù„!

ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:
â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
â€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ØªÙ… Ø§Ù„Ø­Ø°Ù
â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ØªÙ… Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·: ØªÙ… Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
â€¢ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©

âœ… ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
â€¢ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}
â€¢ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}
â€¢ Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙƒ

â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
ğŸ  Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£ØµØ¨Ø­Øª ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹`;

        alert(successMessage);
        showToast(`ØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ø§Ù„ÙƒØ§Ù…Ù„!`, 'success');

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:\n\n${error.message}`);
        showToast(`ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`, 'error');
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¨Ø³Ø·Ø© (Ù„Ù„Ø²Ø± Ø§Ù„Ù…Ù†ÙØµÙ„)
async function completeClearUnit(unitNumber) {
    if (!unitNumber) {
        alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}...`);

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Supabase
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¨Ø³Ø·Ø©
        const confirmMessage = `âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¥ÙØ±Ø§Øº ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}

ğŸ—‘ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:
â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (total_amount)
â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (installment_count)
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ®
â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯

âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!

Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;

        if (!confirm(confirmMessage)) {
            console.log('âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            return;
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase...`);
        const { data: supabaseUnit, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .single();

        if (searchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        if (!supabaseUnit) {
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase`);
        }

        console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase - ID: ${supabaseUnit.id}`);

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥ÙØ±Ø§Øº - Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø³Ø·Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©
        const clearData = {
            // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© - ØªØ¹ÙŠÙŠÙ† null
            total_amount: null,
            installment_count: null,
            rent_value: null,
            remaining_installments: null,

            // Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - Ø§Ù„Ù…Ø¨Ø§Ù„Øº
            first_installment_amount: null,
            second_installment_amount: null,
            third_installment_amount: null,
            fourth_installment_amount: null,
            fifth_installment_amount: null,
            sixth_installment_amount: null,
            seventh_installment_amount: null,
            eighth_installment_amount: null,
            ninth_installment_amount: null,
            tenth_installment_amount: null,

            // Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            first_installment_date: null,
            second_installment_date: null,
            third_installment_date: null,
            fourth_installment_date: null,
            fifth_installment_date: null,
            sixth_installment_date: null,
            seventh_installment_date: null,
            eighth_installment_date: null,
            ninth_installment_date: null,
            tenth_installment_date: null,

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ - ØªØ¹ÙŠÙŠÙ† Ù†Øµ ÙØ§Ø±Øº
            tenant_name: '',
            contract_number: '',
            contract_type: '',
            start_date: null,
            end_date: null,
            installment_end_date: null,
            electricity_account: '',
            tenant_phone: '',
            tenant_phone_2: '',

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
            updated_at: new Date().toISOString()
        };

        console.log(`ğŸ—‘ï¸ Ø³ÙŠØªÙ… Ø¥ÙØ±Ø§Øº ${Object.keys(clearData).length} Ø­Ù‚Ù„`);
        console.log('ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªÙØ±Ø³Ù„:', clearData);

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Supabase
        console.log(`â˜ï¸ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Supabase...`);
        const { data: clearedUnit, error: updateError } = await supabaseClient
            .from('properties')
            .update(clearData)
            .eq('id', supabaseUnit.id)
            .select();

        if (updateError) {
            console.error('âŒ ØªÙØ§ØµÙŠÙ„ Ø®Ø·Ø£ Supabase:', updateError);
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„: ${updateError.message}`);
        }

        if (!clearedUnit || clearedUnit.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙØ±Ø§Øº');
        }

        console.log(`âœ… ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­!`);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙØ±Ø§Øº
        const finalUnit = clearedUnit[0];
        let notClearedFields = [];
        Object.keys(clearData).forEach(field => {
            if (field !== 'updated_at' && finalUnit[field] !== null && finalUnit[field] !== '') {
                notClearedFields.push(field);
            }
        });

        if (notClearedFields.length > 0) {
            console.warn(`âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù… ÙŠØªÙ… Ø¥ÙØ±Ø§ØºÙ‡Ø§: ${notClearedFields.join(', ')}`);
        } else {
            console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ©');
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        if (properties && Array.isArray(properties)) {
            const localIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
            );

            if (localIndex !== -1) {
                // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø©
                const localFieldsToEmpty = [
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰', 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·',
                    'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ'
                ];

                localFieldsToEmpty.forEach(field => {
                    if (properties[localIndex].hasOwnProperty(field)) {
                        properties[localIndex][field] = '';
                    }
                });

                // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø­Ù„ÙŠØ© (1-10)
                for (let i = 1; i <= 10; i++) {
                    const arabicNum = getArabicNumber(i);
                    const dateField = i <= 2 ?
                        (i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' : 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ') :
                        `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${arabicNum}`;
                    const amountField = i <= 2 ?
                        (i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' : 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ') :
                        `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${arabicNum}`;

                    if (properties[localIndex].hasOwnProperty(dateField)) {
                        properties[localIndex][dateField] = '';
                    }
                    if (properties[localIndex].hasOwnProperty(amountField)) {
                        properties[localIndex][amountField] = '';
                    }
                }

                saveDataLocally();
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (window.currentEditingUnits) {
            const currentIndex = window.currentEditingUnits.findIndex(unit =>
                unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
            );

            if (currentIndex !== -1) {
                const currentUnit = window.currentEditingUnits[currentIndex];

                // Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯
                Object.keys(currentUnit).forEach(key => {
                    if ((key.includes('Ù…Ø³ØªØ£Ø¬Ø±') || key.includes('Ø¹Ù‚Ø¯') || key.includes('Ø§ÙŠØ¬Ø§Ø±') ||
                         key.includes('Ù‚Ø³Ø·') || key.includes('Ø§Ø¬Ù…Ø§Ù„Ù‰') || key.includes('ÙƒÙ‡Ø±Ø¨Ø§Ø¡') ||
                         key.includes('Ø¬ÙˆØ§Ù„')) &&
                        !key.includes('Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ') && !key.includes('Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±')) {
                        currentUnit[key] = '';
                    }
                });

                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
        if (typeof displayProperties === 'function') {
            displayProperties();
        }
        if (typeof initializeApp === 'function') {
            initializeApp();
        }

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¨Ø³Ø·Ø© ÙˆÙˆØ§Ø¶Ø­Ø©
        const successMessage = `ğŸ‰ ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!

ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:
${notClearedFields.length === 0 ? 'âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ… Ø­Ø°ÙÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­' : `âš ï¸ ${notClearedFields.length} Ø­Ù‚Ù„ Ù„Ù… ÙŠØªÙ… Ø­Ø°ÙÙ‡`}

ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:
â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (total_amount): Ù…Ø­Ø°ÙˆÙ âœ“
â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (installment_count): Ù…Ø­Ø°ÙˆÙ âœ“
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (1-10): Ù…Ø­Ø°ÙˆÙØ© âœ“
â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯: Ù…Ø­Ø°ÙˆÙØ© âœ“

â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase ÙÙˆØ±Ø§Ù‹
ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
ğŸ  Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ØµØ¨Ø­Øª ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹

ğŸ’¡ Ø£ØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØ£Ø¹Ø¯ ÙØªØ­Ù‡Ø§ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©`;

        alert(successMessage);
        showToast(`ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}!`, 'success');

        console.log(`ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­`);

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);

        const errorMessage = `âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Supabase
â€¢ ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

ğŸ”„ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰`;

        alert(errorMessage);
        showToast(`ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`, 'error');
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
async function quickCheckUnit(unitNumber) {
    if (!unitNumber) {
        console.log('âŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    try {
        if (!supabaseClient) {
            console.log('âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„');
            return;
        }

        console.log(`ğŸ” ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}...`);

        const { data, error } = await supabaseClient
            .from('properties')
            .select('unit_number, property_name, total_amount, installment_count, first_installment_amount, second_installment_amount, rent_value, tenant_name, contract_number')
            .eq('unit_number', unitNumber)
            .single();

        if (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            return;
        }

        if (!data) {
            console.log(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
            return;
        }

        console.log(`ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`);
        console.log('ğŸ  Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:', data.property_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
        console.log('ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:', data.tenant_name || 'ÙØ§Ø±Øº');
        console.log('ğŸ“„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:', data.contract_number || 'ÙØ§Ø±Øº');
        console.log('ğŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:', data.rent_value || 'ÙØ§Ø±Øº');
        console.log('ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:', data.total_amount || 'ÙØ§Ø±Øº');
        console.log('ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·:', data.installment_count || 'ÙØ§Ø±Øº');
        console.log('ğŸ’³ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø£ÙˆÙ„:', data.first_installment_amount || 'ÙØ§Ø±Øº');
        console.log('ğŸ’³ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ:', data.second_installment_amount || 'ÙØ§Ø±Øº');

        // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©
        const isEmpty = !data.tenant_name && !data.total_amount && !data.installment_count;
        console.log(`ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©: ${isEmpty ? 'ğŸŸ¢ ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹' : 'ğŸ”´ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª'}`);

        return data;

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¹Ù…Ø± ÙˆÙ…Ø­Ù…Ø¯ ÙÙ‚Ø·)
function showUnitDataClearModal() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    if (!canDeleteUnitData()) {
        alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª');
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¸Ù„Ù…Ø©
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop show';
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        cursor: pointer;
    `;
    backdrop.onclick = closeUnitDataClearModal;
    document.body.appendChild(backdrop);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.cssText = `
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1050;
        overflow-x: hidden;
        overflow-y: auto;
    `;
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content unit-data-clear-modal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-trash-alt"></i>
                        Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø¯Ø©
                    </h5>
                    <button type="button" class="close" onclick="closeUnitDataClearModal()">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>ØªØ­Ø°ÙŠØ±:</strong> Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØµÙƒÙˆÙƒ ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ
                    </div>

                    <div class="form-group">
                        <label for="unitNumberToClear">
                            <i class="fas fa-home"></i>
                            Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:
                        </label>
                        <input type="text"
                               id="unitNumberToClear"
                               class="form-control"
                               placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Ø«Ø§Ù„: STDM080120)"
                               autocomplete="off">
                        <small class="form-text text-muted">
                            Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙƒÙ…Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
                        </small>
                    </div>

                    <div class="clear-preview" id="clearPreview" style="display: none;">
                        <h6><i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªÙØ­Ø°Ù:</h6>
                        <div id="clearPreviewContent"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUnitDataClearModal()">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="button" class="btn btn-info" onclick="previewUnitDataClear()">
                        <i class="fas fa-search"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©
                    </button>
                    <button type="button" class="btn btn-danger" onclick="executeUnitDataClear()" disabled id="clearExecuteBtn">
                        <i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
    setTimeout(() => {
        document.getElementById('unitNumberToClear').focus();
    }, 100);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    document.getElementById('unitNumberToClear').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            previewUnitDataClear();
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Escape Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const escapeHandler = function(e) {
        if (e.key === 'Escape') {
            closeUnitDataClearModal();
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function canDeleteUnitData() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    if (typeof currentUser !== 'undefined' && currentUser) {
        return currentUser === 'Ø¹Ù…Ø±' || currentUser === 'Ù…Ø­Ù…Ø¯';
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ù…Ù† localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            return userData.username === 'Ø¹Ù…Ø±' || userData.username === 'Ù…Ø­Ù…Ø¯';
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        }
    }

    return false;
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
function closeUnitDataClearModal() {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø©
    const modal = document.querySelector('.unit-data-clear-modal');
    if (modal && modal.closest('.modal')) {
        modal.closest('.modal').remove();
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¸Ù„Ù…Ø©
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.clearUnitData = clearUnitData;
window.clearUnitDataFromCard = clearUnitDataFromCard;
window.completeClearUnit = completeClearUnit;
window.quickCheckUnit = quickCheckUnit;
window.showUnitDataClearModal = showUnitDataClearModal;
window.closeUnitDataClearModal = closeUnitDataClearModal;
// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªÙØ­Ø°Ù
async function previewUnitDataClear() {
    const unitNumber = document.getElementById('unitNumberToClear').value.trim();

    if (!unitNumber) {
        alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    try {
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...`);

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Supabase
        const { data: unit, error } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .single();

        if (error) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${error.message}`);
        }

        if (!unit) {
            alert(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
            return;
        }

        // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        displayClearPreview(unit);

        // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­Ø°Ù
        document.getElementById('clearExecuteBtn').disabled = false;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
    }
}

// Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªÙØ­Ø°Ù
function displayClearPreview(unit) {
    const previewDiv = document.getElementById('clearPreview');
    const contentDiv = document.getElementById('clearPreviewContent');

    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªÙØ­Ø°Ù
    const dataToDelete = [];
    const dataToKeep = [];

    // ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
    if (unit.total_amount) dataToDelete.push(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${parseFloat(unit.total_amount).toLocaleString()} Ø±ÙŠØ§Ù„`);
    if (unit.installment_count) dataToDelete.push(`Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·: ${unit.installment_count}`);
    if (unit.rent_value) dataToDelete.push(`Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${parseFloat(unit.rent_value).toLocaleString()} Ø±ÙŠØ§Ù„`);

    // ÙØ­Øµ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
    for (let i = 1; i <= 10; i++) {
        const amountField = i === 1 ? 'first_installment_amount' :
                           i === 2 ? 'second_installment_amount' :
                           `${getEnglishOrdinal(i)}_installment_amount`;
        const dateField = i === 1 ? 'first_installment_date' :
                         i === 2 ? 'second_installment_date' :
                         `${getEnglishOrdinal(i)}_installment_date`;

        if (unit[amountField]) {
            dataToDelete.push(`Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}: ${parseFloat(unit[amountField]).toLocaleString()} Ø±ÙŠØ§Ù„`);
        }
        if (unit[dateField]) {
            dataToDelete.push(`ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}: ${unit[dateField]}`);
        }
    }

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
    if (unit.tenant_name) dataToDelete.push(`Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${unit.tenant_name}`);
    if (unit.contract_number) dataToDelete.push(`Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ${unit.contract_number}`);
    if (unit.contract_type) dataToDelete.push(`Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${unit.contract_type}`);
    if (unit.start_date) dataToDelete.push(`ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${unit.start_date}`);
    if (unit.end_date) dataToDelete.push(`ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${unit.end_date}`);

    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªØ¨Ù‚Ù‰
    if (unit.unit_number) dataToKeep.push(`Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${unit.unit_number}`);
    if (unit.property_name) dataToKeep.push(`Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ${unit.property_name}`);
    if (unit.city) dataToKeep.push(`Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${unit.city}`);
    if (unit.owner) dataToKeep.push(`Ø§Ù„Ù…Ø§Ù„Ùƒ: ${unit.owner}`);
    if (unit.deed_number) dataToKeep.push(`Ø±Ù‚Ù… Ø§Ù„ØµÙƒ: ${unit.deed_number}`);
    if (unit.area) dataToKeep.push(`Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${unit.area}`);

    let html = `
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-danger">
                    <h6><i class="fas fa-trash"></i> Ø³ÙŠØªÙ… Ø­Ø°Ù:</h6>
                    ${dataToDelete.length > 0 ?
                        '<ul>' + dataToDelete.map(item => `<li>${item}</li>`).join('') + '</ul>' :
                        '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø­Ø°Ù</p>'
                    }
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-success">
                    <h6><i class="fas fa-shield-alt"></i> Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€:</h6>
                    <ul>
                        ${dataToKeep.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            </div>
        </div>
    `;

    contentDiv.innerHTML = html;
    previewDiv.style.display = 'block';
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
function getEnglishOrdinal(num) {
    const ordinals = {
        3: 'third', 4: 'fourth', 5: 'fifth', 6: 'sixth',
        7: 'seventh', 8: 'eighth', 9: 'ninth', 10: 'tenth'
    };
    return ordinals[num] || `${num}th`;
}

// ØªÙ†ÙÙŠØ° Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
async function executeUnitDataClear() {
    const unitNumber = document.getElementById('unitNumberToClear').value.trim();

    if (!unitNumber) {
        alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©');
        return;
    }

    // ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ
    const confirmMessage = `âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}

ğŸ—‘ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø·)
â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
â€¢ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº

âœ… Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€:
â€¢ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
â€¢ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙƒ
â€¢ Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹

âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!

Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;

    if (!confirm(confirmMessage)) {
        console.log('âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        return;
    }

    try {
        console.log(`ğŸ—‘ï¸ Ø¨Ø¯Ø¡ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}...`);

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹
        const { data: unit, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .single();

        if (searchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        if (!unit) {
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­Ø°Ù (Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØµÙƒÙˆÙƒ ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ)
        const clearData = {
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            total_amount: null,
            installment_count: null,
            rent_value: null,
            remaining_installments: null,

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
            tenant_name: '',
            contract_number: '',
            contract_type: '',
            start_date: null,
            end_date: null,
            installment_end_date: null,
            electricity_account: '',
            tenant_phone: '',
            tenant_phone_2: '',

            // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (1-10)
            first_installment_date: null,
            first_installment_amount: null,
            second_installment_date: null,
            second_installment_amount: null,
            third_installment_date: null,
            third_installment_amount: null,
            fourth_installment_date: null,
            fourth_installment_amount: null,
            fifth_installment_date: null,
            fifth_installment_amount: null,
            sixth_installment_date: null,
            sixth_installment_amount: null,
            seventh_installment_date: null,
            seventh_installment_amount: null,
            eighth_installment_date: null,
            eighth_installment_amount: null,
            ninth_installment_date: null,
            ninth_installment_amount: null,
            tenth_installment_date: null,
            tenth_installment_amount: null,

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
            updated_at: new Date().toISOString()
        };

        console.log(`â˜ï¸ ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù ÙÙŠ Supabase...`);

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù ÙÙŠ Supabase
        const { data: clearedUnit, error: updateError } = await supabaseClient
            .from('properties')
            .update(clearData)
            .eq('id', unit.id)
            .select();

        if (updateError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${updateError.message}`);
        }

        if (!clearedUnit || clearedUnit.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù');
        }

        console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­`);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (properties && Array.isArray(properties)) {
            const localIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
            );

            if (localIndex !== -1) {
                // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©
                const localFieldsToEmpty = [
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰', 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·',
                    'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ'
                ];

                localFieldsToEmpty.forEach(field => {
                    if (properties[localIndex].hasOwnProperty(field)) {
                        properties[localIndex][field] = '';
                    }
                });

                // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                for (let i = 1; i <= 10; i++) {
                    const arabicNum = getArabicNumber(i);
                    const dateField = i <= 2 ?
                        (i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' : 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ') :
                        `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${arabicNum}`;
                    const amountField = i <= 2 ?
                        (i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' : 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ') :
                        `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${arabicNum}`;

                    if (properties[localIndex].hasOwnProperty(dateField)) {
                        properties[localIndex][dateField] = '';
                    }
                    if (properties[localIndex].hasOwnProperty(amountField)) {
                        properties[localIndex][amountField] = '';
                    }
                }

                saveDataLocally();
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (typeof displayProperties === 'function') {
            displayProperties();
        }
        if (typeof initializeApp === 'function') {
            initializeApp();
        }

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const successMessage = `ğŸ‰ ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!

âœ… ØªÙ… Ø­Ø°Ù:
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ®

ğŸ›¡ï¸ ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€:
â€¢ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${unit.unit_number}
â€¢ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ${unit.property_name}
â€¢ Ø§Ù„Ù…Ø§Ù„Ùƒ: ${unit.owner || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
â€¢ Ø±Ù‚Ù… Ø§Ù„ØµÙƒ: ${unit.deed_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase ÙÙˆØ±Ø§Ù‹
ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`;

        alert(successMessage);
        showToast(`ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}!`, 'success');

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeUnitDataClearModal();

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);

        const errorMessage = `âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Supabase
â€¢ ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

ğŸ”„ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰`;

        alert(errorMessage);
        showToast(`ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`, 'error');
    }
}

window.executeUnitDataClear = executeUnitDataClear;
window.previewUnitDataClear = previewUnitDataClear;
window.getArabicNumber = getArabicNumber;

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function testUnitDataClearing() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        if (!properties || properties.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚Ø§Ø±Ø§Øª');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const linkedUnits = properties.filter(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '' &&
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] && p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'].trim() !== ''
        );

        if (linkedUnits.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        const testUnit = linkedUnits[0];
        const unitNumber = testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
        const propertyName = testUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

        console.log(`ğŸ—‘ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber} ÙÙŠ Ø¹Ù‚Ø§Ø±: ${propertyName}`);

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ±Ø§Øº
        console.log('ğŸ“‹ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ±Ø§Øº...');
        const { data: beforeData, error: beforeError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName)
            .single();

        if (beforeError || !beforeData) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ±Ø§Øº');
        }

        if (!beforeData.tenant_name || beforeData.tenant_name.trim() === '') {
            throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ© Ø¨Ø§Ù„ÙØ¹Ù„ - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥ÙØ±Ø§Øº');
        }

        console.log('âœ… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:', {
            tenant: beforeData.tenant_name,
            contract: beforeData.contract_number,
            rent: beforeData.rent_value,
            unit: beforeData.unit_number,
            property: beforeData.property_name
        });

        // 2. ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙØ±Ø§Øº (Ø¨Ø¯ÙˆÙ† ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        console.log('ğŸ—‘ï¸ ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙØ±Ø§Øº...');

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
        const emptyData = {
            tenant_name: '',
            contract_number: '',
            rent_value: null,
            contract_type: null,
            start_date: null,
            end_date: null,
            total_amount: null,
            electricity_account: '',
            remaining_installments: null,
            first_installment_date: null,
            first_installment_amount: null,
            second_installment_date: null,
            second_installment_amount: null,
            installment_end_date: null,
            updated_at: new Date().toISOString()
        };

        const { data: afterData, error: updateError } = await supabaseClient
            .from('properties')
            .update(emptyData)
            .eq('id', beforeData.id)
            .select();

        if (updateError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${updateError.message}`);
        }

        if (!afterData || afterData.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙØ±Ø§Øº');
        }

        console.log('âœ… ØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙØ±Ø§Øº
        console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        const clearedData = afterData[0];

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ±ØºØ©
        const clearedFields = [
            'tenant_name', 'contract_number', 'rent_value', 'contract_type',
            'start_date', 'end_date', 'total_amount', 'electricity_account',
            'remaining_installments', 'first_installment_date', 'first_installment_amount',
            'second_installment_date', 'second_installment_amount', 'installment_end_date'
        ];

        let notClearedFields = [];
        clearedFields.forEach(field => {
            const value = clearedData[field];
            if (value !== null && value !== '' && value !== undefined) {
                notClearedFields.push(`${field}: ${value}`);
            }
        });

        if (notClearedFields.length > 0) {
            throw new Error(`Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù… ÙŠØªÙ… Ø¥ÙØ±Ø§ØºÙ‡Ø§: ${notClearedFields.join(', ')}`);
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        const preservedFields = ['unit_number', 'property_name', 'city', 'area', 'owner', 'deed_number', 'real_estate_registry'];
        let missingPreservedFields = [];
        preservedFields.forEach(field => {
            if (beforeData[field] && (!clearedData[field] || clearedData[field] !== beforeData[field])) {
                missingPreservedFields.push(field);
            }
        });

        if (missingPreservedFields.length > 0) {
            console.warn(`âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØªØºÙŠØ±Øª: ${missingPreservedFields.join(', ')}`);
        }

        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©');

        // 4. Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©...');
        const restoreData = {
            tenant_name: beforeData.tenant_name,
            contract_number: beforeData.contract_number,
            rent_value: beforeData.rent_value,
            contract_type: beforeData.contract_type,
            start_date: beforeData.start_date,
            end_date: beforeData.end_date,
            total_amount: beforeData.total_amount,
            electricity_account: beforeData.electricity_account,
            remaining_installments: beforeData.remaining_installments,
            first_installment_date: beforeData.first_installment_date,
            first_installment_amount: beforeData.first_installment_amount,
            second_installment_date: beforeData.second_installment_date,
            second_installment_amount: beforeData.second_installment_amount,
            installment_end_date: beforeData.installment_end_date,
            updated_at: new Date().toISOString()
        };

        const { error: restoreError } = await supabaseClient
            .from('properties')
            .update(restoreData)
            .eq('id', beforeData.id);

        if (restoreError) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©:', restoreError.message);
        } else {
            console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        }

        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const successMessage = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª!

âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù†Ø¬Ø­Øª:
ğŸ—‘ï¸ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø©: ${unitNumber}
ğŸ  Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: ${beforeData.tenant_name}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø£ØµÙ„ÙŠ: ${beforeData.contract_number}

ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Øº Ø¨Ù†Ø¬Ø§Ø­:
â€¢ ØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯
â€¢ ØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
â€¢ ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŒ Ø§Ù„Ù…Ø³Ø§Ø­Ø©ØŒ Ø¥Ù„Ø®)
â€¢ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©

ğŸ¯ Ù†Ø¸Ø§Ù… Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!
ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± "Ø¥ÙØ±Ø§Øº" ÙÙŠ Ø£ÙŠ Ø¨Ø·Ø§Ù‚Ø©`;

        alert(successMessage);
        showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'success');
        console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª');

        return {
            success: true,
            testedUnit: unitNumber,
            originalData: beforeData,
            clearedSuccessfully: true,
            preservedFieldsIntact: missingPreservedFields.length === 0,
            restoredSuccessfully: !restoreError
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);

        const errorMessage = `âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ Ø§ØªØµØ§Ù„ Supabase
â€¢ ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');

        return { success: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.testUnitDataClearing = testUnitDataClearing;

// Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
function renderLinkedUnits(propertyName, contractNumber) {
    if (!contractNumber) {
        return '<p class="no-units">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø©</p>';
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    if (!ensurePropertiesLoaded('renderLinkedUnits')) {
        return '<p class="no-units">Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</p>';
    }

    const linkedUnits = properties.filter(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber
    );

    if (linkedUnits.length <= 1) {
        return '<p class="no-units">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¥Ø¶Ø§ÙÙŠØ©</p>';
    }

    return linkedUnits.map(unit => `
        <div class="linked-unit-item">
            <span class="unit-number">${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}</span>
            <span class="unit-details">${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] ? unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] + ' Ù…Â²' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
            <button type="button" onclick="unlinkUnit('${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}', '${propertyName}', '${contractNumber}')" class="btn-unlink">
                <i class="fas fa-unlink"></i> ÙØµÙ„
            </button>
        </div>
    `).join('');
}

// ØªØ¨Ø¯ÙŠÙ„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©
async function toggleUnitLinking(unitNumber, propertyName, contractNumber) {
    const checkbox = document.querySelector(`input[value="${unitNumber}"][name="linkingUnits"]`);

    if (checkbox.checked) {
        // Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©
        await linkUnitToContract(unitNumber, propertyName, contractNumber);
    } else {
        // ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©
        await unlinkUnit(unitNumber, propertyName, contractNumber);
    }
}

// Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø¹ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function linkUnitToContract(unitNumber, propertyName, contractNumber) {
    if (!contractNumber) {
        alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!ensurePropertiesLoaded('linkUnitToContract')) {
        return;
    }

    const unitIndex = properties.findIndex(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
    );

    if (unitIndex !== -1) {
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        const oldData = { ...properties[unitIndex] };

        // ğŸ”§ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§
        const existingLinkedUnit = properties.find(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] !== unitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== ''
        );

        if (existingLinkedUnit) {
            console.log(`ğŸ”— ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø±Ø¨ÙˆØ·Ø©ØŒ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†Ù‡Ø§...`);

            // Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const sharedData = {
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': existingLinkedUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': existingLinkedUnit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'] || '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ': existingLinkedUnit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ'] || '',

                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': contractNumber,
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || '',
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': existingLinkedUnit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || '',
                'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': existingLinkedUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø³ÙƒÙ†ÙŠ',

                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹'] || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±'] || '',
                'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±': existingLinkedUnit['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±'] || '',
                'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·': existingLinkedUnit['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'] || ''
            };

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©
            Object.assign(properties[unitIndex], sharedData);

            console.log(`âœ… ØªÙ… Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©ØŒ ÙÙ‚Ø· Ø±Ø¨Ø· Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
            properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = contractNumber;
            console.log(`ğŸ“ ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber} (ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©)`);
        }

        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Supabase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ©
        let supabaseSuccess = false;
        let supabaseError = null;
        let supabaseResult = null;

        try {
            console.log(`ğŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase...`);
            console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:', {
                unitNumber: properties[unitIndex]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                propertyName: properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                contractNumber: properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
                tenant: properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']
            });

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª
            supabaseResult = await saveUnitLinkingToSupabase(properties[unitIndex], 'link');

            if (supabaseResult && supabaseResult.id) {
                console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­`);
                console.log('ğŸ“‹ Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Supabase:', supabaseResult.id);
                supabaseSuccess = true;
            } else {
                console.warn('âš ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¹Ø±Ù ØµØ­ÙŠØ­');
                supabaseError = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¹Ø±Ù ØµØ­ÙŠØ­ Ù…Ù† Supabase';
            }

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
            supabaseError = error.message;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„Ø±Ø¨Ø·
        try {
            await addChangeLog('Ø±Ø¨Ø· ÙˆØ­Ø¯Ø©', properties[unitIndex], oldData, {
                operation: 'link_unit',
                unitNumber: unitNumber,
                contractNumber: contractNumber,
                propertyName: propertyName
            });
        } catch (error) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©:', error);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
        try {
            await createTrackingLogsForLinkedUnits(contractNumber, propertyName, unitNumber, 'Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©');
        } catch (error) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:', error);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        updateLinkedUnitsDisplay(propertyName, contractNumber);
        updateAvailableUnitsDisplay(propertyName, contractNumber, unitNumber);

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª
        initializeApp();

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸
        let message = `âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber} Ø¨Ù†Ø¬Ø§Ø­!`;

        // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            if (supabaseSuccess) {
                message += `\n\nâ˜ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©`;
                if (supabaseResult?.id) {
                    message += `\nğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„: ${supabaseResult.id}`;
                }
                message += `\n\nğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø¨Ø·:`;
                message += `\n- Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}`;
                message += `\n- Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}`;
                message += `\n- Ø§Ù„Ø¹Ù‚Ø¯: ${contractNumber}`;
                message += `\n- Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
                message += `\n\nğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase Dashboard`;
            } else if (supabaseError) {
                message += `\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ`;
                message += `\nØ§Ù„Ø³Ø¨Ø¨: ${supabaseError}`;
                message += `\n\nğŸ’¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ³ØªØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹`;
            }
        } else {
            message += `\n\nğŸ“± ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„)`;
        }

        alert(message);

        // Ø¥Ø¸Ù‡Ø§Ø± toast Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        const toastMessage = supabaseSuccess
            ? `ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­`
            : `ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· - ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ`;

        showToast(toastMessage, supabaseSuccess ? 'success' : 'warning');
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø®ØµØµØ© Ù„Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase - Ù…Ø­Ø³Ù†Ø©
async function saveUnitLinkingToSupabase(unitData, operationType = 'link') {
    try {
        if (!supabaseClient) {
            console.error('âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„ - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¨Ø·');
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        console.log(`ğŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ ${operationType === 'link' ? 'Ø±Ø¨Ø·' : 'ÙØµÙ„'} Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase...`);
        console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©:', {
            unitNumber: unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            propertyName: unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
            tenant: unitData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'],
            contract: unitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
            operation: operationType
        });

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…
        const supabaseData = {
            unit_number: unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '',
            property_name: unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '',
            city: unitData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || '',
            tenant_name: operationType === 'unlink' ? '' : (unitData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''),
            contract_number: operationType === 'unlink' ? '' : (unitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''),
            rent_value: parseFloat(unitData['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']) || 0,
            area: parseFloat(unitData['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || null,
            contract_type: unitData['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø³ÙƒÙ†ÙŠ',
            start_date: unitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] || null,
            end_date: unitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || null,
            owner: unitData['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || '',
            deed_number: unitData['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || '',
            real_estate_registry: unitData['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || '',
            updated_at: new Date().toISOString()
        };

        // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ù†Ø¶Ø¹ Ø§Ù„Ù‚ÙŠÙ… ÙØ§Ø±ØºØ© ØµØ±Ø§Ø­Ø©
        if (operationType === 'unlink') {
            supabaseData.tenant_name = '';
            supabaseData.contract_number = '';
            console.log('ğŸ”“ ØªÙ… ØªØ¹ÙŠÙŠÙ† tenant_name Ùˆ contract_number ÙƒÙØ§Ø±ØºÙŠÙ† Ù„Ù„ÙØµÙ„');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (!supabaseData.unit_number || !supabaseData.property_name) {
            throw new Error('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…ÙÙ‚ÙˆØ¯');
        }

        console.log('ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¶Ø±Ø© Ù„Ù„Ø­ÙØ¸:', {
            operation: operationType,
            unit_number: supabaseData.unit_number,
            property_name: supabaseData.property_name,
            tenant_name: supabaseData.tenant_name,
            contract_number: supabaseData.contract_number
        });

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯...');
        const { data: existingRecord, error: searchError } = await supabaseClient
            .from('properties')
            .select('id, tenant_name, contract_number')
            .eq('unit_number', supabaseData.unit_number)
            .eq('property_name', supabaseData.property_name)
            .maybeSingle();

        if (searchError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', searchError);
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        let result;
        let operationSuccess = false;

        if (existingRecord) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
            console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Supabase...');
            console.log('ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ:', {
                id: existingRecord.id,
                current_tenant: existingRecord.tenant_name,
                current_contract: existingRecord.contract_number
            });

            const { data, error } = await supabaseClient
                .from('properties')
                .update(supabaseData)
                .eq('id', existingRecord.id)
                .select();

            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', error);
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${error.message}`);
            }

            if (data && data.length > 0) {
                result = data[0];
                operationSuccess = true;
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');
                console.log('ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:', {
                    id: result.id,
                    tenant_name: result.tenant_name,
                    contract_number: result.contract_number,
                    updated_at: result.updated_at
                });
            } else {
                throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«');
            }

        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
            console.log('â• Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Supabase...');
            supabaseData.created_at = new Date().toISOString();

            const { data, error } = await supabaseClient
                .from('properties')
                .insert([supabaseData])
                .select();

            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:', error);
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${error.message}`);
            }

            if (data && data.length > 0) {
                result = data[0];
                operationSuccess = true;
                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');
                console.log('ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', {
                    id: result.id,
                    unit_number: result.unit_number,
                    tenant_name: result.tenant_name,
                    contract_number: result.contract_number
                });
            } else {
                throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡');
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        if (!operationSuccess || !result) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù†ØªÙŠØ¬Ø© ØµØ­ÙŠØ­Ø©');
        }

        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ÙÙŠ tracking_logs Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
        try {
            if (typeof window.trackingLogsManager !== 'undefined') {
                const trackingData = {
                    operation_type: operationType === 'link' ? 'Ø±Ø¨Ø· ÙˆØ­Ø¯Ø©' : 'ÙØµÙ„ ÙˆØ­Ø¯Ø©',
                    unit_number: unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                    property_name: unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                    tenant_name: unitData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
                    contract_number: unitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '',
                    description: `ØªÙ… ${operationType === 'link' ? 'Ø±Ø¨Ø·' : 'ÙØµÙ„'} Ø§Ù„ÙˆØ­Ø¯Ø© ${unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ${operationType === 'link' ? 'Ø¨Ø§Ù„Ø¹Ù‚Ø¯' : 'Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯'} ${unitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`,
                    user_name: getCurrentUser() || 'Ø§Ù„Ù†Ø¸Ø§Ù…'
                };

                await window.trackingLogsManager.saveTrackingLogToSupabase(trackingData);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹');
            }
        } catch (trackingError) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹:', trackingError);
            // Ù„Ø§ Ù†Ø±Ù…ÙŠ Ø®Ø·Ø£ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù†Ø¬Ø­Øª
        }

        console.log(`ğŸ‰ ØªÙ… Ø­ÙØ¸ ${operationType === 'link' ? 'Ø±Ø¨Ø·' : 'ÙØµÙ„'} Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase`);
        return result;

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ${operationType === 'link' ? 'Ø±Ø¨Ø·' : 'ÙØµÙ„'} Ø§Ù„ÙˆØ­Ø¯Ø©:`, error);
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        showToast(`âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ ${operationType === 'link' ? 'Ø±Ø¨Ø·' : 'ÙØµÙ„'} Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`, 'error');
        throw error;
    }
}

// ÙØµÙ„ ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯
async function unlinkUnit(unitNumber, propertyName, contractNumber) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø·Ù„Ù‚ Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
    console.log('ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø·Ù„Ù‚...');
    return await absoluteUnlinkUnit(unitNumber, propertyName, contractNumber);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ÙØµÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù„Ù„Ù…Ø±Ø¬Ø¹ ÙÙ‚Ø·)
async function unlinkUnitOld(unitNumber, propertyName, contractNumber) {
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ØŸ`)) return;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!ensurePropertiesLoaded('unlinkUnitOld')) {
        return;
    }

    const unitIndex = properties.findIndex(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber
    );

    if (unitIndex !== -1) {
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        const oldData = { ...properties[unitIndex] };

        // ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = '';
        properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = '';

        console.log(`ğŸ”“ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ø­Ù„ÙŠØ§Ù‹:`, {
            Ù‚Ø¨Ù„: { Ø¹Ù‚Ø¯: oldData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'], Ù…Ø³ØªØ£Ø¬Ø±: oldData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] },
            Ø¨Ø¹Ø¯: { Ø¹Ù‚Ø¯: properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'], Ù…Ø³ØªØ£Ø¬Ø±: properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] }
        });

        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Supabase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ©
        let supabaseSuccess = false;
        let supabaseError = null;

        try {
            console.log(`ğŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase...`);

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø¨Ø³Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            if (!supabaseClient) {
                throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
            }

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
            const { data: existingUnit, error: searchError } = await supabaseClient
                .from('properties')
                .select('id, unit_number, tenant_name, contract_number')
                .eq('unit_number', unitNumber)
                .eq('property_name', propertyName)
                .single();

            if (searchError) {
                if (searchError.code === 'PGRST116') {
                    throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Supabase');
                }
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
            }

            // ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
            const { data: result, error: unlinkError } = await supabaseClient
                .from('properties')
                .update({
                    tenant_name: '',
                    contract_number: '',
                    updated_at: new Date().toISOString()
                })
                .eq('id', existingUnit.id)
                .select()
                .single();

            if (unlinkError) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØµÙ„: ${unlinkError.message}`);
            }

            if (result && result.tenant_name === '' && result.contract_number === '') {
                console.log(`âœ… ØªÙ… Ø­ÙØ¸ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­`);
                console.log('ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', {
                    id: result.id,
                    unit_number: result.unit_number,
                    tenant_name: result.tenant_name,
                    contract_number: result.contract_number
                });
                supabaseSuccess = true;

                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹
                try {
                    if (typeof window.trackingLogsManager !== 'undefined') {
                        const trackingData = {
                            operation_type: 'ÙØµÙ„ ÙˆØ­Ø¯Ø©',
                            unit_number: unitNumber,
                            property_name: propertyName,
                            description: `ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ ${contractNumber}`,
                            user_name: 'Ø§Ù„Ù†Ø¸Ø§Ù…'
                        };

                        await window.trackingLogsManager.saveTrackingLogToSupabase(trackingData);
                        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙØµÙ„');
                    }
                } catch (trackingError) {
                    console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹:', trackingError);
                }
            } else {
                supabaseError = 'ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙØµÙ„ - Ø§Ù„Ù‚ÙŠÙ… Ù„Ù… ØªØµØ¨Ø­ ÙØ§Ø±ØºØ©';
            }

        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
            supabaseError = error.message;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // âš ï¸ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØµÙˆÙ„Ø©
        console.log('âš ï¸ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù…Ù†Ø¹ ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        updateLinkedUnitsDisplay(propertyName, contractNumber);
        updateAvailableUnitsDisplay(propertyName, contractNumber, unitNumber);

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª
        initializeApp();

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸
        let message = `âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!`;

        // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            if (supabaseSuccess) {
                message += `\n\nâ˜ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©`;
            } else if (supabaseError) {
                message += `\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ`;
                message += `\nØ§Ù„Ø³Ø¨Ø¨: ${supabaseError}`;
                message += `\n\nğŸ’¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ³ØªØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹`;
            }
        } else {
            message += `\n\nğŸ“± ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„)`;
        }

        alert(message);

        // Ø¥Ø¸Ù‡Ø§Ø± toast Ù„Ù„ØªØ£ÙƒÙŠØ¯
        showToast(`ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
function updateLinkedUnitsDisplay(propertyName, contractNumber) {
    const container = document.getElementById('linkedUnitsDisplay');
    if (container) {
        container.innerHTML = renderLinkedUnits(propertyName, contractNumber);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
function updateAvailableUnitsDisplay(propertyName, contractNumber, currentUnitNumber) {
    const container = document.getElementById('availableUnitsForLinking');
    if (container) {
        container.innerHTML = renderAvailableUnitsForLinking(propertyName, contractNumber, currentUnitNumber);
    }
}

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ====================

// Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù„Ù„ØªØ­Ø±ÙŠØ±
function renderInstallmentsForEdit(property) {
    let installments = [];

    // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        if (property[dateKey] || property[amountKey]) {
            installments.push({
                number: i,
                date: property[dateKey] || '',
                amount: property[amountKey] || '',
                dateKey: dateKey,
                amountKey: amountKey
            });
        }
    }

    // Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· ÙØ§Ø±Øº Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø·
    if (installments.length === 0) {
        installments.push({
            number: 1,
            date: '',
            amount: '',
            dateKey: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
            amountKey: 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'
        });
    }

    return installments.map(installment => `
        <div class="installment-item" data-installment="${installment.number}">
            <div class="installment-header">
                <h4><i class="fas fa-calendar-check"></i> Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(installment.number)}</h4>
                <button type="button" onclick="removeInstallment(${installment.number})" class="btn-remove-installment">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
            </div>
            <div class="installment-fields">
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø·:</label>
                    <input type="date" name="${installment.dateKey}" value="${formatDateForInput(installment.date)}"
                           placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø·" onchange="setTimeout(() => autoSaveInstallmentChanges(), 1000)">
                </div>
                <div class="form-group">
                    <label>Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø·:</label>
                    <input type="number" name="${installment.amountKey}" value="${installment.amount}" step="0.01"
                           placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø·" onchange="setTimeout(() => autoSaveInstallmentChanges(), 1000)">
                </div>
            </div>
        </div>
    `).join('');
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
function getArabicNumber(num) {
    const arabicNumbers = {
        1: 'Ø§Ù„Ø£ÙˆÙ„', 2: 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 3: 'Ø§Ù„Ø«Ø§Ù„Ø«', 4: 'Ø§Ù„Ø±Ø§Ø¨Ø¹', 5: 'Ø§Ù„Ø®Ø§Ù…Ø³',
        6: 'Ø§Ù„Ø³Ø§Ø¯Ø³', 7: 'Ø§Ù„Ø³Ø§Ø¨Ø¹', 8: 'Ø§Ù„Ø«Ø§Ù…Ù†', 9: 'Ø§Ù„ØªØ§Ø³Ø¹', 10: 'Ø§Ù„Ø¹Ø§Ø´Ø±'
    };
    return arabicNumbers[num] || num.toString();
}

// Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· Ø¬Ø¯ÙŠØ¯
function addNewInstallment() {
    const container = document.getElementById('installmentsContainer');
    const existingInstallments = container.querySelectorAll('.installment-item');
    const nextNumber = existingInstallments.length + 1;

    if (nextNumber > 10) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† 10 Ø£Ù‚Ø³Ø§Ø·');
        return;
    }

    const dateKey = nextNumber === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                   nextNumber === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                   `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(nextNumber)}`;
    const amountKey = nextNumber === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                     nextNumber === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                     `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(nextNumber)}`;

    const installmentHtml = `
        <div class="installment-item" data-installment="${nextNumber}">
            <div class="installment-header">
                <h4><i class="fas fa-calendar-check"></i> Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(nextNumber)}</h4>
                <button type="button" onclick="removeInstallment(${nextNumber})" class="btn-remove-installment">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
            </div>
            <div class="installment-fields">
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø·:</label>
                    <input type="date" name="${dateKey}" value="" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø·">
                </div>
                <div class="form-group">
                    <label>Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø·:</label>
                    <input type="number" name="${amountKey}" value="" step="0.01" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø·">
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', installmentHtml);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const newInstallmentItem = container.lastElementChild;
    const inputs = newInstallmentItem.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù‚ÙŠÙ… Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            setTimeout(() => {
                autoSaveInstallmentChanges();
            }, 1000);
        });
    });
}

// Ø­Ø°Ù Ù‚Ø³Ø·
function removeInstallment(installmentNumber) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ø·ØŸ')) return;

    const installmentItem = document.querySelector(`[data-installment="${installmentNumber}"]`);
    if (installmentItem) {
        installmentItem.remove();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
        renumberInstallments();
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
function renumberInstallments() {
    const container = document.getElementById('installmentsContainer');
    const installmentItems = container.querySelectorAll('.installment-item');

    installmentItems.forEach((item, index) => {
        const newNumber = index + 1;
        const oldNumber = item.getAttribute('data-installment');

        // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ø·
        item.setAttribute('data-installment', newNumber);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        const header = item.querySelector('.installment-header h4');
        header.innerHTML = `<i class="fas fa-calendar-check"></i> Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(newNumber)}`;

        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø°Ù
        const removeBtn = item.querySelector('.btn-remove-installment');
        removeBtn.setAttribute('onclick', `removeInstallment(${newNumber})`);

        // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
        const dateInput = item.querySelector('input[type="date"]');
        const amountInput = item.querySelector('input[type="number"]');

        const newDateKey = newNumber === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                          newNumber === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                          `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(newNumber)}`;
        const newAmountKey = newNumber === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                            newNumber === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                            `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(newNumber)}`;

        dateInput.setAttribute('name', newDateKey);
        amountInput.setAttribute('name', newAmountKey);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        dateInput.addEventListener('change', function() {
            setTimeout(() => autoSaveInstallmentChanges(), 1000);
        });
        amountInput.addEventListener('change', function() {
            setTimeout(() => autoSaveInstallmentChanges(), 1000);
        });
    });
}

// Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
function autoSaveInstallmentChanges() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø´Ø·
    const activeForm = document.querySelector('.modal-overlay form');
    if (!activeForm) return;

    const formData = new FormData(activeForm);
    const originalContractNumber = formData.get('originalContractNumber');
    const originalPropertyName = formData.get('originalPropertyName');
    const originalUnitNumber = formData.get('originalUnitNumber');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±
    let propertyIndex = -1;
    if (originalContractNumber && originalPropertyName) {
        propertyIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === originalContractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );
    } else if (originalUnitNumber && originalPropertyName) {
        propertyIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === originalUnitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName
        );
    }

    if (propertyIndex === -1) return;

    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙÙ‚Ø· - Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    const updatedProperty = { ...properties[propertyIndex] };

    // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¯Ø§Ø®Ù„
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        // Ù…Ø³Ø­ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        updatedProperty[dateKey] = null;
        updatedProperty[amountKey] = null;
    }

    // Ø«Ø§Ù†ÙŠØ§Ù‹: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    for (let [key, value] of formData.entries()) {
        if (key.includes('Ø§Ù„Ù‚Ø³Ø·')) {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            if (key.includes('ØªØ§Ø±ÙŠØ®') && value) {
                const dateParts = value.split('-');
                if (dateParts.length === 3 && dateParts[0].length === 4) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]);
                    const day = parseInt(dateParts[2]);

                    if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                        const testDate = new Date(year, month - 1, day, 12, 0, 0);
                        if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                            value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                        } else {
                            value = null; // ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­
                        }
                    } else {
                        value = null; // ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­
                    }
                }
            }

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            if (key.includes('Ù…Ø¨Ù„Øº') && value) {
                value = parseFloat(value) || 0;
            }

            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµØ§Ù„Ø­Ø©
            if (value !== null && value !== '' && value !== 0) {
                updatedProperty[key] = value;
            }
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠØ§Ù‹
    let installmentCount = 0;
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        if (updatedProperty[dateKey] || updatedProperty[amountKey]) {
            installmentCount = i;
        }
    }

    updatedProperty['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] = installmentCount;

    // Ù„Ø§ ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ø§Ø­ØªØ±Ø§Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙƒØªÙˆØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹)
    if (!updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] === null || updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] === 0) {
        // ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ Ø§Ø­Ø³Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
        const yearlyData = calculateYearlyTotal(updatedProperty);
        if (yearlyData.count > 0) {
            updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = yearlyData.total;
            console.log(`ğŸ’° ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ø·: ${yearlyData.total}`);
        }
    } else {
        console.log(`ğŸ’° ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯: ${updatedProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']} (Ù„Ù† ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡)`);
    }

    // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    properties[propertyIndex] = updatedProperty;

    // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ø±Ø¶ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·...');
    renderData();
    updateTotalStats();

    // Ø­ÙØ¸ ÙÙŠ Supabase
    if (typeof savePropertyToSupabase === 'function') {
        savePropertyToSupabase(updatedProperty);
    }

    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
    saveDataLocally();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…ÙØªÙˆØ­Ø§Ù‹
    const totalDisplay = document.querySelector('.modal-overlay .total-display');
    if (totalDisplay) {
        const yearlyData = calculateYearlyTotal(updatedProperty);
        totalDisplay.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${yearlyData.total.toLocaleString()} Ø±ÙŠØ§Ù„ (${yearlyData.count} Ø£Ù‚Ø³Ø§Ø·)`;
    }

    console.log('âœ… ØªÙ… Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
}

// Ø¯Ø§Ù„Ø© ØªØ´Ø®ÙŠØµ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
function diagnoseInstallments(contractNumber, propertyName) {
    console.log(`ğŸ” ØªØ´Ø®ÙŠØµ Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø¹Ù‚Ø¯: ${contractNumber} - ${propertyName}`);

    const property = properties.find(p =>
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );

    if (!property) {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    console.log('ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·:');
    let foundInstallments = 0;

    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        const date = property[dateKey];
        const amount = property[amountKey];

        if (date || amount) {
            foundInstallments++;
            console.log(`âœ… Ø§Ù„Ù‚Ø³Ø· ${i}: Ø§Ù„ØªØ§Ø±ÙŠØ® = ${date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}, Ø§Ù„Ù…Ø¨Ù„Øº = ${amount || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
        }
    }

    console.log(`ğŸ“ˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${foundInstallments}`);
    console.log(`ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸: ${property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);

    const yearlyData = calculateYearlyTotal(property);
    console.log(`ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨: ${yearlyData.total.toLocaleString()} Ø±ÙŠØ§Ù„ (${yearlyData.count} Ø£Ù‚Ø³Ø§Ø·)`);

    return {
        foundInstallments,
        savedCount: property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'],
        yearlyTotal: yearlyData.total,
        yearlyCount: yearlyData.count
    };
}

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù†Ø© ====================

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function calculateYearlyTotal(property) {
    let yearlyTotal = 0;
    let installmentsCount = 0;
    const targetYear = currentCalculationYear;

    // ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ù…Ù† 1 Ø¥Ù„Ù‰ 10)
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        const installmentDate = property[dateKey];
        const installmentAmount = property[amountKey];

        if (installmentDate && installmentAmount) {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ù†Ø© Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø·
            const dateObj = parseArabicDate(installmentDate);
            if (dateObj && dateObj.getFullYear() === targetYear) {
                yearlyTotal += parseFloat(installmentAmount) || 0;
                installmentsCount++;
            }
        }
    }

    return {
        total: yearlyTotal,
        count: installmentsCount,
        year: targetYear
    };
}

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¨ÙŠ
function parseArabicDate(dateStr) {
    if (!dateStr) return null;

    // ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
    const formats = [
        /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // DD/MM/YYYY
        /^(\d{1,2})-(\d{1,2})-(\d{4})$/, // DD-MM-YYYY
        /^(\d{4})-(\d{1,2})-(\d{1,2})$/, // YYYY-MM-DD
    ];

    for (let format of formats) {
        const match = dateStr.match(format);
        if (match) {
            let day, month, year;
            if (format === formats[2]) { // YYYY-MM-DD
                [, year, month, day] = match;
            } else { // DD/MM/YYYY or DD-MM-YYYY
                [, day, month, year] = match;
            }
            return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        }
    }

    return null;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
function createTotalNote(yearlyData) {
    if (yearlyData.count === 0) {
        return `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù„Ø¹Ø§Ù… ${yearlyData.year}`;
    }

    const countText = yearlyData.count === 1 ? 'Ù‚Ø³Ø· ÙˆØ§Ø­Ø¯' :
                     yearlyData.count === 2 ? 'Ù‚Ø³Ø·Ø§Ù†' :
                     `${yearlyData.count} Ø£Ù‚Ø³Ø§Ø·`;

    return `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ù‚Ø³Ø§Ø· Ø¹Ø§Ù… ${yearlyData.year} - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·: ${countText}`;
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
function formatTotalWithNote(property) {
    const smartTotal = calculateSmartTotal(property);

    const formattedTotal = smartTotal.amount > 0 ?
        `${smartTotal.amount.toLocaleString()} Ø±ÙŠØ§Ù„` :
        '';

    return {
        display: formattedTotal,
        note: smartTotal.note,
        amount: smartTotal.amount,
        source: smartTotal.source
    };
}

// ==================== ÙˆØ¸ÙŠÙØ© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ ====================

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø°ÙƒÙŠØ© (Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŒ Ø«Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ø·ØŒ Ø«Ù… Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±)
function calculateSmartTotal(property) {
    let totalAmount = 0;
    let source = 'none';
    let note = '';

    // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù‚Ù„ "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰" Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
    if (property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] && property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] !== null) {
        totalAmount = parseFloat(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']);
        source = 'saved';
        note = ''; // ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØµÙ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    } else {
        // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        const yearlyData = calculateYearlyTotal(property);
        if (yearlyData.total > 0) {
            totalAmount = yearlyData.total;
            source = 'calculated';
            note = createTotalNote(yearlyData);
        } else if (property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']) {
            // Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙƒØ¨Ø¯ÙŠÙ„
            totalAmount = parseFloat(property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']) || 0;
            source = 'rent';
            note = 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±';
        } else {
            source = 'none';
            note = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§Ù„ÙŠØ©';
        }
    }

    return {
        amount: totalAmount,
        source: source,
        note: note
    };
}

// ==================== ÙˆØ¸ÙŠÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ====================

// Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ù‚ÙŠÙ… "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰" ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function recalculateAllTotals() {
    let updatedCount = 0;

    properties.forEach(property => {
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
        if (!property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].toString().trim() === '') {
            return;
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù‚Ù„ "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰" ÙØ§Ø±Øº Ø£Ùˆ null
        if (!property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] === null) {
            const smartTotal = calculateSmartTotal(property);
            if (smartTotal.amount > 0) {
                property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = smartTotal.amount;
                updatedCount++;
            }
        }
    });

    if (updatedCount > 0) {
        console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} Ù‚ÙŠÙ…Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ`);
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        initializeApp();
        renderData();
    }

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±
    console.log('=== ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===');
    let totalCommercial = 0, totalResidential = 0;
    let commercialCount = 0, residentialCount = 0;

    properties.forEach(property => {
        if (!property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].toString().trim() === '') {
            return;
        }

        const smartTotal = calculateSmartTotal(property);
        if (smartTotal.amount > 0) {
            if (property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ') {
                totalCommercial += smartTotal.amount;
                commercialCount++;
                console.log(`ØªØ¬Ø§Ø±ÙŠ: ${property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']} - ${smartTotal.amount.toLocaleString()} Ø±ÙŠØ§Ù„ (${smartTotal.source})`);
            } else {
                totalResidential += smartTotal.amount;
                residentialCount++;
                console.log(`Ø³ÙƒÙ†ÙŠ: ${property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']} - ${smartTotal.amount.toLocaleString()} Ø±ÙŠØ§Ù„ (${smartTotal.source})`);
            }
        }
    });

    console.log(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ¬Ø§Ø±ÙŠ: ${totalCommercial.toLocaleString()} Ø±ÙŠØ§Ù„ (${commercialCount} Ø¹Ù‚Ø¯)`);
    console.log(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³ÙƒÙ†ÙŠ: ${totalResidential.toLocaleString()} Ø±ÙŠØ§Ù„ (${residentialCount} Ø¹Ù‚Ø¯)`);
    console.log('=====================================');

    return updatedCount;
}

// ==================== ÙˆØ¸Ø§Ø¦Ù ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ====================

// ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø­Ø³Ù† Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
function editPropertyData(propertyName) {
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹
    let propertyData = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);

    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    if (!propertyData) {
        const propertyDefinition = propertyDefinitions.find(p => p.name === propertyName);
        if (propertyDefinition) {
            // ØªØ­ÙˆÙŠÙ„ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
            propertyData = {
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': propertyDefinition.name,
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': propertyDefinition.city,
                'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': propertyDefinition.deed,
                'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': propertyDefinition.area,
                'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': propertyDefinition.registry,
                'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': propertyDefinition.location,
                'Ø§Ù„Ù…Ø§Ù„Ùƒ': propertyDefinition.owner
            };
            console.log('ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', propertyDefinition);
        }
    }

    if (!propertyData) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-box edit-property-modal">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±</h2>
                <p>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}</p>
            </div>
            <div class="modal-content">
                <div class="management-section">
                    <h3><i class="fas fa-building"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                            <input type="text" id="editPropertyName" value="${propertyData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                            <select id="editPropertyCity">
                                ${getUniqueCountries().filter(city => city !== 'Ø§Ù„ÙƒÙ„').map(city =>
                                    `<option value="${city}" ${city === propertyData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] ? 'selected' : ''}>${city}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„ØµÙƒ:</label>
                            <input type="text" id="editPropertyDeed" value="${propertyData['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙƒ">
                        </div>
                        <div class="form-group">
                            <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ:</label>
                            <input type="number" id="editPropertyArea" value="${propertyData['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || ''}" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ:</label>
                            <input type="text" id="editPropertyRegistry" value="${propertyData['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø§Ù„Ùƒ:</label>
                            <select id="editPropertyOwner" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ --</option>
                                <option value="Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯" ${(propertyData['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === 'Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯') ? 'selected' : ''}>Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯</option>
                                <option value="Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…" ${(propertyData['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === 'Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…') ? 'selected' : ''}>Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                            <input type="url" id="editPropertyLocation" value="${propertyData['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''}" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©">
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="handleSavePropertyChanges('${propertyName}')">
                        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ÙˆØ¸ÙŠÙØ© wrapper Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ async ÙÙŠ onclick
function handleSavePropertyChanges(originalPropertyName) {
    console.log(`ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±: ${originalPropertyName}`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø²Ø± Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹
    const saveBtn = document.querySelector('.btn-primary');
    if (saveBtn) {
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© async
        savePropertyChanges(originalPropertyName)
            .then(() => {
                console.log('âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                // Ø§Ù„Ø²Ø± Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            })
            .catch((error) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:', error);
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                if (saveBtn.parentNode) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            });
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±ØŒ Ø§Ø³ØªØ¯Ø¹ÙŠ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…Ø¨Ø§Ø´Ø±Ø©
        savePropertyChanges(originalPropertyName);
    }
}

// Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
async function savePropertyChanges(originalPropertyName) {
    console.log(`ğŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±: ${originalPropertyName}`);

    const newName = document.getElementById('editPropertyName').value.trim();
    const newCity = document.getElementById('editPropertyCity').value;
    const newDeed = document.getElementById('editPropertyDeed').value.trim();
    const newArea = document.getElementById('editPropertyArea').value;
    const newRegistry = document.getElementById('editPropertyRegistry').value.trim();
    const newOwner = document.getElementById('editPropertyOwner').value.trim();
    const newLocation = document.getElementById('editPropertyLocation').value.trim();

    if (!newName || !newCity) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', 'error');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ù‚Ø§Ø± Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¥Ø°Ø§ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…)
    if (newName !== originalPropertyName) {
        const existingProperty = properties.find(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === newName && p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === newCity
        );
        if (existingProperty) {
            showToast('ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø± Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', 'error');
            return;
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.style.display = 'flex';
    loadingModal.style.zIndex = '10001';
    loadingModal.innerHTML = `
        <div class="modal-box loading-modal">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h3>Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª...</h3>
                <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
            </div>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        const relatedProperties = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName);
        const originalData = relatedProperties[0] ? { ...relatedProperties[0] } : {};

        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØªØ¨Ø¹
        const originalUnitNumber = originalData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '';
        const originalTenantName = originalData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '';
        const originalContractNumber = originalData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '';

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„ØªØªØ¨Ø¹
        const changes = {};

        if (newName !== originalPropertyName) {
            changes['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] = {
                fieldName: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±',
                old: originalPropertyName,
                new: newName
            };
        }

        if (newCity !== originalData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']) {
            changes['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] = {
                fieldName: 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©',
                old: originalData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || '',
                new: newCity
            };
        }

        if (newDeed !== (originalData['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || '')) {
            changes['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] = {
                fieldName: 'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ',
                old: originalData['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || '',
                new: newDeed
            };
        }

        if (newArea !== (originalData['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || '')) {
            changes['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] = {
                fieldName: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ',
                old: originalData['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || '',
                new: newArea
            };
        }

        if (newRegistry !== (originalData['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || '')) {
            changes['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] = {
                fieldName: 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ',
                old: originalData['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || '',
                new: newRegistry
            };
        }

        if (newOwner !== (originalData['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || '')) {
            changes['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = {
                fieldName: 'Ø§Ù„Ù…Ø§Ù„Ùƒ',
                old: originalData['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || '',
                new: newOwner
            };
        }

        if (newLocation !== (originalData['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '')) {
            changes['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] = {
                fieldName: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±',
                old: originalData['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '',
                new: newLocation
            };
        }

        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±
        relatedProperties.forEach(property => {
            property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] = newName;
            property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] = newCity;
            property['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] = newDeed || null;
            property['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] = newArea || null;
            property['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] = newRegistry || null;
            property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = newOwner || null;
            property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] = newLocation || null;
            property['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
        });

        // ğŸ”§ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        for (const property of relatedProperties) {
            if (property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] && property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'].trim() !== '') {
                console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}...`);
                try {
                    await updateLinkedUnitsOnEdit(property);
                } catch (error) {
                    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø¹Ù‚Ø¯ ${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}:`, error);
                }
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹
        if (Object.keys(changes).length > 0) {
            const changeLog = createChangeLog(
                OPERATION_TYPES.EDIT_DATA,
                {
                    'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': relatedProperties[0]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'Ù…ØªØ¹Ø¯Ø¯',
                    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': newName,
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': relatedProperties[0]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''
                },
                changes,
                {
                    affectedUnits: relatedProperties.length,
                    originalPropertyName: originalPropertyName
                }
            );

            changeTrackingLogs.push(changeLog);

            // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹
            try {
                localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
            } catch (error) {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
            }

            // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase
            await saveChangeLogToSupabase(changeLog);
        }

        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø§Ù…Ù„Ø© ÙˆÙ…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Supabase...');

        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Supabase (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©)
            console.log('ğŸ’¾ Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©...');
            const directSaveResult = await savePropertiesDirectlyToSupabase(relatedProperties);

            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            if (loadingModal && loadingModal.parentNode) {
                loadingModal.remove();
            }

            if (directSaveResult.success) {
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…ÙØµÙ„Ø©
                const successMessage = directSaveResult.message || `ØªÙ… Ø­ÙØ¸ ${directSaveResult.count} Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`;
                showToast(successMessage, 'success');
                console.log('âœ… ØªÙ… Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');

                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„Ù†Ø¬Ø§Ø­
                const successLog = createChangeLog(
                    'ØªØ­Ø¯ÙŠØ« Ø¹Ù‚Ø§Ø±',
                    originalUnitNumber,
                    originalPropertyName,
                    originalTenantName,
                    originalContractNumber,
                    changes,
                    {
                        method: directSaveResult.method,
                        cloudSync: true,
                        timestamp: new Date().toISOString()
                    }
                );

                await saveChangeLogToSupabase(successLog);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                setTimeout(async () => {
                    try {
                        const verifyResult = await verifyDataSync(originalPropertyName, changes);
                        if (verifyResult.success) {
                            console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                        } else {
                            console.warn('âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù… ØªØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„');
                        }
                    } catch (verifyError) {
                        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', verifyError.message);
                    }
                }, 2000);

                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                updatePropertyDisplayAfterSave(originalPropertyName, changes);

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ
                await refreshDataAfterPropertyEdit(originalPropertyName);

            } else {
                throw new Error(directSaveResult.message || directSaveResult.error || 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
            }

        } catch (saveError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', saveError);

            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            if (loadingModal && loadingModal.parentNode) {
                loadingModal.remove();
            }

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙƒØ¨Ø¯ÙŠÙ„
            try {
                console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙƒØ¨Ø¯ÙŠÙ„...');
                const syncResult = await syncToSupabase(false);

                if (syncResult.success) {
                    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©)', 'success');
                    console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø©');

                    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ø¯ÙŠÙ„
                    const fallbackLog = createChangeLog(
                        'ØªØ­Ø¯ÙŠØ« Ø¹Ù‚Ø§Ø± (Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©)',
                        originalUnitNumber,
                        originalPropertyName,
                        originalTenantName,
                        originalContractNumber,
                        changes,
                        {
                            method: 'fallback_sync',
                            cloudSync: true,
                            originalError: saveError.message
                        }
                    );

                    await saveChangeLogToSupabase(fallbackLog);

                } else {
                    throw new Error(syncResult.message || 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø©');
                }

            } catch (syncError) {
                console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø­ÙØ¸:', syncError);

                // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±ÙŠØ©
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· - Ø³ØªØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'warning');

                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù„Ù„ÙØ´Ù„
                const failureLog = createChangeLog(
                    'ØªØ­Ø¯ÙŠØ« Ø¹Ù‚Ø§Ø± (Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·)',
                    originalUnitNumber,
                    originalPropertyName,
                    originalTenantName,
                    originalContractNumber,
                    changes,
                    {
                        method: 'local_only',
                        cloudSync: false,
                        saveError: saveError.message,
                        syncError: syncError.message,
                        needsRetry: true
                    }
                );

                await saveChangeLogToSupabase(failureLog);

                // Ø¥Ø¸Ù‡Ø§Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª
                setTimeout(() => {
                    const errorDetails = `
                        âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:

                        Ø®Ø·Ø£ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: ${saveError.message}
                        Ø®Ø·Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø©: ${syncError.message}

                        âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­

                        ğŸ”§ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:
                        1. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
                        2. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                        3. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
                        4. Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

                        ğŸ’¡ Ø³ØªØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    `;

                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±Ø¤ÙŠØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„ØŸ')) {
                        alert(errorDetails);
                    }
                }, 1000);
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeModal();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderData();
        updateTotalStats();

        // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        const propertiesTab = document.getElementById('properties-tab');
        if (propertiesTab) {
            propertiesTab.innerHTML = renderPropertiesTab();
        }

        // Ù…Ø³Ø­ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        if (typeof clearPropertiesSearch === 'function') {
            clearPropertiesSearch();
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠØ©
        setTimeout(() => {
            console.log(`âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø± "${originalPropertyName}" Ø¨Ù†Ø¬Ø§Ø­`);

            // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø± "${originalPropertyName}" Ø¨Ù†Ø¬Ø§Ø­
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                z-index: 10000;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideInRight 0.5s ease;
            `;

            document.body.appendChild(notification);

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }
            }, 5000);
        }, 1000);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingModal.remove();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        const errorModal = document.createElement('div');
        errorModal.className = 'modal-overlay';
        errorModal.style.display = 'flex';
        errorModal.style.zIndex = '10002';
        errorModal.innerHTML = `
            <div class="modal-box error-modal">
                <div class="error-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</h3>
                </div>
                <div class="error-content">
                    <p><strong>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:</strong></p>
                    <div class="error-details">${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                    <p><i class="fas fa-info-circle"></i> ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹</p>
                </div>
                <div class="error-actions">
                    <button onclick="retrySavePropertyChanges('${originalPropertyName}')" class="retry-btn">
                        <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                    <button onclick="closeModal()" class="close-btn">
                        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(errorModal);
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
async function retrySavePropertyChanges(originalPropertyName) {
    closeModal(); // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø·Ø£
    await savePropertyChanges(originalPropertyName);
}

// Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±
function showPropertyStatistics(propertyName) {
    const relatedProperties = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
    const propertyData = relatedProperties[0];

    if (!propertyData) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        return;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    const totalUnits = relatedProperties.length;
    const occupiedUnits = relatedProperties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '').length;
    const emptyUnits = totalUnits - occupiedUnits;
    const totalArea = relatedProperties.reduce((sum, p) => sum + (parseFloat(p['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) || 0), 0);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø°ÙƒÙŠØ©
    let yearlyTotal = 0;
    let totalInstallments = 0;

    relatedProperties.forEach(property => {
        if (!property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].toString().trim() === '') {
            return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
        }

        const smartTotal = calculateSmartTotal(property);
        yearlyTotal += smartTotal.amount;

        // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØµØ¯Ø± Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨
        if (smartTotal.source === 'calculated') {
            const yearlyData = calculateYearlyTotal(property);
            totalInstallments += yearlyData.count;
        }
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-box property-stats-modal">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div class="modal-header">
                <h2><i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±</h2>
                <p>${propertyName}</p>
            </div>
            <div class="modal-content">
                <div class="management-section">
                    <h3><i class="fas fa-building"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                    <div class="stats-grid">
                        ${propertyData['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] ? `
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-clipboard-list"></i> Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ</div>
                            <div class="stat-value">${propertyData['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ']}</div>
                        </div>` : ''}
                        ${propertyData['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] ? `
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-file-contract"></i> Ø±Ù‚Ù… Ø§Ù„ØµÙƒ</div>
                            <div class="stat-value">${propertyData['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ']}</div>
                        </div>` : ''}
                        ${propertyData['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] ? `
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-ruler-combined"></i> Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ</div>
                            <div class="stat-value">${parseFloat(propertyData['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ']).toLocaleString()} Ù…Â²</div>
                        </div>` : ''}
                        ${propertyData['Ø§Ù„Ù…Ø§Ù„Ùƒ'] ? `
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-user"></i> Ø§Ù„Ù…Ø§Ù„Ùƒ</div>
                            <div class="stat-value">${propertyData['Ø§Ù„Ù…Ø§Ù„Ùƒ']}</div>
                        </div>` : ''}
                    </div>
                </div>

                <div class="management-section">
                    <h3><i class="fas fa-home"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-building"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</div>
                            <div class="stat-value">${totalUnits}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-check-circle"></i> Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©</div>
                            <div class="stat-value occupied">${occupiedUnits}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-minus-circle"></i> Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©</div>
                            <div class="stat-value empty">${emptyUnits}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-expand-arrows-alt"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§Ø­Ø©</div>
                            <div class="stat-value">${totalArea.toLocaleString()} Ù…Â²</div>
                        </div>
                    </div>
                </div>

                <div class="management-section">
                    <h3><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-calendar-alt"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø§Ù… ${currentCalculationYear}</div>
                            <div class="stat-value financial">${yearlyTotal.toLocaleString()} Ø±ÙŠØ§Ù„</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-list-ol"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</div>
                            <div class="stat-value">${totalInstallments}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-percentage"></i> Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø´ØºØ§Ù„</div>
                            <div class="stat-value">${totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-calculator"></i> Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø³Ø·</div>
                            <div class="stat-value">${totalInstallments > 0 ? Math.round(yearlyTotal / totalInstallments).toLocaleString() : 0} Ø±ÙŠØ§Ù„</div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ==================== ÙˆØ¸Ø§Ø¦Ù ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¯Ù† ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ====================

// ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¯Ù†
function toggleCityFilter() {
    const filterList = document.getElementById('cityFilterList');
    const filterArrow = document.getElementById('filterArrow');
    const isVisible = filterList.classList.contains('show');

    if (isVisible) {
        closeCityFilter();
    } else {
        showCityFilter();
    }
}

// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¯Ù†
function showCityFilter() {
    const filterList = document.getElementById('cityFilterList');
    const filterArrow = document.getElementById('filterArrow');

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    filterList.style.display = 'block';

    // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø¨Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    populateCitiesList();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†
    const allCitiesCount = document.getElementById('allCitiesCount');
    if (allCitiesCount) {
        allCitiesCount.textContent = getUniquePropertiesCount();
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†"
    const allCitiesOption = filterList.querySelector('.all-cities');
    if (allCitiesOption) {
        if (selectedCityFilter === 'all') {
            allCitiesOption.style.background = '#007bff';
            allCitiesOption.style.borderColor = '#007bff';
            allCitiesOption.style.transform = 'translateY(-1px)';
            allCitiesOption.style.boxShadow = '0 2px 8px rgba(0, 123, 255, 0.3)';
        } else {
            allCitiesOption.style.background = '#28a745';
            allCitiesOption.style.borderColor = '#28a745';
            allCitiesOption.style.transform = 'none';
            allCitiesOption.style.boxShadow = '0 1px 3px rgba(40, 167, 69, 0.3)';
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù‡Ù…
    if (filterArrow) {
        filterArrow.style.transform = 'rotate(180deg)';
        filterArrow.className = 'fas fa-chevron-up filter-arrow';
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¯Ù†
function closeCityFilter() {
    const filterList = document.getElementById('cityFilterList');
    const filterArrow = document.getElementById('filterArrow');

    if (filterList) {
        filterList.style.display = 'none';
    }

    if (filterArrow) {
        filterArrow.style.transform = 'rotate(0deg)';
        filterArrow.className = 'fas fa-chevron-down filter-arrow';
    }
}



// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function getUniqueCitiesFromProperties() {
    const cities = new Set();
    const uniqueProperties = getUniquePropertiesForManagement();

    uniqueProperties.forEach(propertyName => {
        const property = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
        if (property && property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']) {
            cities.add(property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']);
        }
    });

    return Array.from(cities).sort();
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© Ù…Ø¹ÙŠÙ†Ø©
function getPropertiesCountByCity(city) {
    const uniqueProperties = getUniquePropertiesForManagement();
    return uniqueProperties.filter(propertyName => {
        const property = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
        return property && property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === city;
    }).length;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
function getUniquePropertiesCount() {
    return getUniquePropertiesForManagement().length;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
function getUniquePropertiesForManagement() {
    const uniqueProperties = new Set();
    properties.forEach(property => {
        if (property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] && property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].trim() !== '') {
            uniqueProperties.add(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
        }
    });
    return Array.from(uniqueProperties);
}

// ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
function filterByCity(city) {
    selectedCityFilter = city;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const filterList = document.getElementById('cityFilterList');
    const cityOptions = filterList.querySelectorAll('.city-option');

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù† ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø£ÙŠØ¶Ø§Ù‹
    updateCityButtonsActive(city);

    cityOptions.forEach(option => {
        option.classList.remove('active');
    });

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
    if (city === 'all') {
        filterList.querySelector('.city-option').classList.add('active');
    } else {
        cityOptions.forEach(option => {
            const cityName = option.querySelector('span').textContent;
            if (cityName === city) {
                option.classList.add('active');
            }
        });
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠÙ…ÙƒÙ† Ø¥Ø¨Ù‚Ø§Ø¤Ù‡Ø§ Ù…ÙØªÙˆØ­Ø©)
    closeCityFilter();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    updatePropertiesDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙÙŠØ©
function updatePropertiesDisplay() {
    const propertiesTab = document.getElementById('properties-tab');
    if (propertiesTab) {
        propertiesTab.innerHTML = renderPropertiesTab();
    }
}

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù†Ø´Ø·Ø©
function updateCityButtonsActive(activeCity) {
    const cityButtons = document.querySelectorAll('.city-btn');
    cityButtons.forEach(button => {
        const buttonCity = button.getAttribute('data-city');
        if (buttonCity === activeCity) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
function addNewCityToSystem() {
    const cityNameInput = document.getElementById('newCityName');
    const cityName = cityNameInput.value.trim();

    if (!cityName) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©');
        cityNameInput.focus();
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
    const existingCities = getUniqueCountries().filter(city => city !== 'Ø§Ù„ÙƒÙ„');
    if (existingCities.includes(cityName)) {
        alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
        cityNameInput.focus();
        return;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø§Ø±Ø§Øª Ø£Ùˆ ÙˆØ­Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©)
    console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© "${cityName}" Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…`);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ©
    if (!cityDefinitions.includes(cityName)) {
        cityDefinitions.push(cityName);
        localStorage.setItem('cityDefinitions', JSON.stringify(cityDefinitions));
        console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© "${cityName}" ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ©`);
    }

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù†
    initCountryButtons();

    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    updatePropertiesDisplay();

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚Ù„
    cityNameInput.value = '';

    // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠÙ†Ø© "${cityName}" Ø¨Ù†Ø¬Ø§Ø­!\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.`);

    console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${cityName}`);
}

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦
function fixCorruptedDates() {
    try {
        console.log('ğŸ”§ ÙØ­Øµ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...');

        let fixedCount = 0;
        const dateFields = ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'];

        properties.forEach((property, index) => {
            dateFields.forEach(field => {
                if (property[field]) {
                    const originalDate = property[field];
                    const fixedDate = fixSingleDate(originalDate);

                    if (fixedDate !== originalDate) {
                        console.log(`ğŸ”§ Ø¥ØµÙ„Ø§Ø­ ØªØ§Ø±ÙŠØ® ${field} Ù„Ù„Ø¹Ù‚Ø§Ø± ${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || index}: ${originalDate} â†’ ${fixedDate}`);
                        property[field] = fixedDate;
                        fixedCount++;
                    }
                }
            });

            // Ø¥ØµÙ„Ø§Ø­ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            for (let i = 1; i <= 20; i++) {
                const installmentDateKey = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
                if (property[installmentDateKey]) {
                    const originalDate = property[installmentDateKey];
                    const fixedDate = fixSingleDate(originalDate);

                    if (fixedDate !== originalDate) {
                        console.log(`ğŸ”§ Ø¥ØµÙ„Ø§Ø­ ${installmentDateKey} Ù„Ù„Ø¹Ù‚Ø§Ø± ${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || index}: ${originalDate} â†’ ${fixedDate}`);
                        property[installmentDateKey] = fixedDate;
                        fixedCount++;
                    }
                }
            }
        });

        if (fixedCount > 0) {
            console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixedCount} ØªØ§Ø±ÙŠØ® Ù…Ø­ÙÙˆØ¸ Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦`);

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ­Ø­Ø©
            saveDataLocally();

            // Ø­ÙØ¸ ÙÙŠ Supabase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
            if (typeof saveAllPropertiesToSupabase === 'function') {
                saveAllPropertiesToSupabase();
            }
        } else {
            console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ØµØ­ÙŠØ­Ø©');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®:', error);
    }
}

// Ø¥ØµÙ„Ø§Ø­ ØªØ§Ø±ÙŠØ® ÙˆØ§Ø­Ø¯
function fixSingleDate(dateStr) {
    if (!dateStr) return dateStr;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ Ø¹Ø±Ø¨ÙŠØŒ Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ù‚Ù…ÙŠ ÙÙ‚Ø·
    if (dateStr.includes('(') && dateStr.includes(')')) {
        const numericPart = dateStr.split('(')[0].trim();
        if (numericPart) {
            dateStr = numericPart;
        }
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
    dateStr = dateStr.trim();

    // ÙØ­Øµ ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ®
    let datePart = dateStr.split(' ')[0];
    let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');

    if (parts.length !== 3) return dateStr;

    let day, month, year;

    // ØªØ­Ø¯ÙŠØ¯ ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (parts[0].length === 4) {
        // yyyy-mm-dd Ø£Ùˆ yyyy/mm/dd
        year = parseInt(parts[0]);
        month = parseInt(parts[1]);
        day = parseInt(parts[2]);
    } else {
        // dd/mm/yyyy Ø£Ùˆ dd-mm-yyyy
        day = parseInt(parts[0]);
        month = parseInt(parts[1]);
        year = parseInt(parts[2]);
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (isNaN(year) || isNaN(month) || isNaN(day) ||
        year < 1900 || year > 2100 ||
        month < 1 || month > 12 ||
        day < 1 || day > 31) {
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­: ${dateStr}`);
        return dateStr; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Date object
    const testDate = new Date(year, month - 1, day);
    if (testDate.getFullYear() !== year || testDate.getMonth() !== (month - 1) || testDate.getDate() !== day) {
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­: ${dateStr}`);
        return dateStr;
    }

    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© dd/mm/yyyy
    return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage - Ù…Ø­Ø³Ù† Ù„Ù…Ù†Ø¹ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
function restoreDataFromLocalStorage() {
    try {
        const savedData = localStorage.getItem('properties_backup');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            if (Array.isArray(parsedData) && parsedData.length > 0) {
                // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©
                parsedData.forEach(property => {
                    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    const dateFields = ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·'];
                    dateFields.forEach(field => {
                        if (property[field]) {
                            property[field] = ensureCorrectDateFormat(property[field]);
                        }
                    });

                    // Ø¥ØµÙ„Ø§Ø­ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
                    for (let i = 1; i <= 20; i++) {
                        const installmentDateKey = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
                        if (property[installmentDateKey]) {
                            property[installmentDateKey] = ensureCorrectDateFormat(property[installmentDateKey]);
                        }
                    }
                });

                properties = parsedData;
                console.log(`âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${parsedData.length} Ø¹Ù‚Ø§Ø± Ù…Ù† localStorage Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®`);

                // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                setTimeout(() => {
                    if (currentUser) {
                        console.log('ğŸ”‘ Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† restoreDataFromLocalStorage');
                        addLogoutButton();
                    }
                }, 100);

                return true;
            }
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage:', error);
    }
    return false;
}

// Ø¶Ù…Ø§Ù† ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ­ÙŠØ­Ø© - Ù…Ø­Ø³Ù† Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
function ensureCorrectDateFormat(dateStr) {
    if (!dateStr) return dateStr;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ Ø¹Ø±Ø¨ÙŠØŒ Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ù‚Ù…ÙŠ ÙÙ‚Ø·
    if (typeof dateStr === 'string' && dateStr.includes('(') && dateStr.includes(')')) {
        const numericPart = dateStr.split('(')[0].trim();
        if (numericPart) {
            dateStr = numericPart;
        }
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
    dateStr = dateStr.toString().trim();

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨ØµÙŠØºØ© dd/mm/yyyyØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­ØªÙ‡ ÙˆØ£Ø¨Ù‚Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ
    if (typeof dateStr === 'string' && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
        const parts = dateStr.split('/');
        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]);
        const year = parseInt(parts[2]);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Date object Ù„ØªØ¬Ù†Ø¨ ØªÙˆØ§Ø±ÙŠØ® Ù…Ø«Ù„ 31 ÙØ¨Ø±Ø§ÙŠØ±
            const testDate = new Date(year, month - 1, day, 12, 0, 0);
            if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
            }
        }
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ ensureCorrectDateFormat: ${dateStr}`);
        return dateStr; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨ØµÙŠØºØ© yyyy-mm-ddØŒ Ø­ÙˆÙ„Ù‡ Ø¥Ù„Ù‰ dd/mm/yyyy
    if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}/)) {
        const parts = dateStr.split('-');
        if (parts.length >= 3) {
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Date object
                const testDate = new Date(year, month - 1, day, 12, 0, 0);
                if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                    return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                }
            }
        }
        console.warn(`ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ ensureCorrectDateFormat: ${dateStr}`);
        return dateStr; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ØŒ Ø£Ø±Ø¬Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ
    return dateStr;
}

// Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« ØªØºÙŠÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
function testDateHandling() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®...');

    const testDates = [
        '2/1/2025',    // 2nd January 2025
        '15/3/2024',   // 15th March 2024
        '31/12/2023',  // 31st December 2023
        '1/6/2025',    // 1st June 2025
        '29/2/2024',   // 29th February 2024 (leap year)
        '2025-01-02',  // ISO format
        '2024-03-15'   // ISO format
    ];

    testDates.forEach(testDate => {
        console.log(`\nğŸ“… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®: ${testDate}`);

        // Test formatDateForInput
        const inputFormat = formatDateForInput(testDate);
        console.log(`  formatDateForInput: ${testDate} â†’ ${inputFormat}`);

        // Test ensureCorrectDateFormat
        const correctFormat = ensureCorrectDateFormat(testDate);
        console.log(`  ensureCorrectDateFormat: ${testDate} â†’ ${correctFormat}`);

        // Test parseDate
        const parsedDate = parseDate(testDate);
        console.log(`  parseDate: ${testDate} â†’ ${parsedDate ? parsedDate.toDateString() : 'null'}`);

        // Test round-trip conversion
        if (inputFormat) {
            const backToDisplay = ensureCorrectDateFormat(inputFormat);
            console.log(`  Round-trip: ${testDate} â†’ ${inputFormat} â†’ ${backToDisplay}`);

            // Check if original date is preserved
            if (testDate.includes('/') && backToDisplay === testDate) {
                console.log(`  âœ… Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø­ÙÙˆØ¸ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­`);
            } else if (testDate.includes('-') && backToDisplay) {
                console.log(`  âœ… Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø­ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­`);
            } else {
                console.warn(`  âš ï¸ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„`);
            }
        }
    });

    console.log('\nâœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®');
}

// Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
function testDateFix() {
    console.log('ğŸ”§ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®...');

    // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠØ³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
    const problematicDate = '15/11/2020';

    console.log(`ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ØµÙ„ÙŠ: ${problematicDate}`);

    // Ø§Ø®ØªØ¨Ø§Ø± formatDateForStorage
    const fixedFormat = formatDateForStorage(problematicDate);
    console.log(`ğŸ”§ Ø¨Ø¹Ø¯ formatDateForStorage: ${fixedFormat}`);

    // Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù€ Supabase
    try {
        const testDate = new Date(fixedFormat);
        if (!isNaN(testDate.getTime())) {
            console.log(`âœ… Ø§Ù„ØªØ§Ø±ÙŠØ® ØµØ§Ù„Ø­ Ù„Ù€ Supabase: ${testDate.toISOString()}`);
            console.log(`âœ… ØªÙ… Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
        } else {
            console.log(`âŒ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø§ ÙŠØ²Ø§Ù„ ØºÙŠØ± ØµØ§Ù„Ø­`);
        }
    } catch (error) {
        console.log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®: ${error.message}`);
    }

    // Ø§Ø®ØªØ¨Ø§Ø± ØªÙˆØ§Ø±ÙŠØ® Ø£Ø®Ø±Ù‰
    const testDates = ['1/1/2023', '31/12/2024', '29/2/2024'];
    testDates.forEach(date => {
        const converted = formatDateForStorage(date);
        const isValid = !isNaN(new Date(converted).getTime());
        console.log(`ğŸ“… ${date} â†’ ${converted} ${isValid ? 'âœ…' : 'âŒ'}`);
    });
}

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
function saveDataLocally() {
    try {
        // Ø­ÙØ¸ ÙÙŠ localStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        localStorage.setItem('properties_backup', JSON.stringify(properties));

        // ğŸ”§ Ø¥Ø¶Ø§ÙØ©: Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ù† Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡Ø§ Ø¹Ù†Ø¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        saveCitiesLocally();

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ÙÙŠ Ù…Ù„Ù JSON (ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±)
        if (typeof saveToFile === 'function') {
            saveToFile();
        }

        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
    }
}

// Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ù† Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ ÙÙŠ localStorage
function saveCitiesLocally() {
    try {
        // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¯Ù† Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const citiesFromProperties = new Set();
        if (properties && properties.length > 0) {
            properties.forEach(property => {
                const city = property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'];
                if (city && city.trim() !== '' && city !== null) {
                    citiesFromProperties.add(city.trim());
                }
            });
        }

        // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
        const savedCities = new Set();
        try {
            const existingSavedCities = localStorage.getItem('savedCities');
            if (existingSavedCities) {
                const parsed = JSON.parse(existingSavedCities);
                if (Array.isArray(parsed)) {
                    parsed.forEach(city => savedCities.add(city));
                }
            }
        } catch (error) {
            console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', error);
        }

        // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¯Ù† Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ù† (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹)
        if (typeof availableCities !== 'undefined' && Array.isArray(availableCities)) {
            availableCities.forEach(city => {
                if (city && city.trim() !== '') {
                    savedCities.add(city.trim());
                }
            });
        }

        // Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù† (Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª + Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© + Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ§Ù‹)
        const allCities = new Set([...citiesFromProperties, ...savedCities]);
        const finalCitiesList = Array.from(allCities).sort();

        // Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        localStorage.setItem('savedCities', JSON.stringify(finalCitiesList));

        // ØªØ­Ø¯ÙŠØ« availableCities Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
        if (typeof availableCities !== 'undefined') {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· (Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©)
            finalCitiesList.forEach(city => {
                if (!availableCities.includes(city)) {
                    availableCities.push(city);
                }
            });
            availableCities.sort();
        }

        console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ ${finalCitiesList.length} Ù…Ø¯ÙŠÙ†Ø© ÙÙŠ localStorage`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ù† Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† localStorage
function loadSavedCities() {
    try {
        const savedCities = localStorage.getItem('savedCities');
        if (savedCities) {
            const citiesList = JSON.parse(savedCities);
            if (Array.isArray(citiesList)) {
                // ØªØ­Ø¯ÙŠØ« availableCities Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
                if (typeof availableCities !== 'undefined') {
                    // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    const allCities = new Set([...availableCities, ...citiesList]);
                    availableCities = Array.from(allCities).sort();

                    console.log(`ğŸ“‚ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${citiesList.length} Ù…Ø¯ÙŠÙ†Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† localStorage`);
                    console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©: ${availableCities.length}`);

                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯Ù† Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªÙˆÙØ±Ø©
                    if (typeof updateCityButtonsState === 'function') {
                        updateCityButtonsState();
                    }
                    if (typeof updateCityDropdowns === 'function') {
                        updateCityDropdowns();
                    }
                } else {
                    console.log(`ğŸ“‚ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${citiesList.length} Ù…Ø¯ÙŠÙ†Ø© Ù…Ø­ÙÙˆØ¸Ø© (availableCities ØºÙŠØ± Ù…ØªÙˆÙØ±)`);
                }

                return citiesList;
            }
        }

        console.log('ğŸ“‚ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ù† Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ localStorage');
        return [];

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', error);
        return [];
    }
}

// ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù„Ù
function saveToFile() {
    try {
        const dataStr = JSON.stringify(properties, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'data_updated.json';

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        // link.click();

        console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    }
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Ù„Ù„Ù…Ø¯Ù† ÙÙ‚Ø·)
function cleanupTempCityProperties() {
    const originalLength = properties.length;
    properties = properties.filter(property => !property.temp_city_marker);
    const removedCount = originalLength - properties.length;

    if (removedCount > 0) {
        console.log(`ğŸ§¹ ØªÙ… Ø­Ø°Ù ${removedCount} Ø¹Ù‚Ø§Ø± Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø¯Ù†`);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        updatePropertiesDisplay();
        initCountryButtons();

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        saveDataLocally();
    }
}

// Ø¬Ø¹Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ console
window.cleanupTempCityProperties = cleanupTempCityProperties;

// ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¯Ù†
function initializeCityFilter() {
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†
    const allCitiesCount = document.getElementById('allCitiesCount');
    if (allCitiesCount) {
        allCitiesCount.textContent = getUniquePropertiesCount();
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØµÙÙŠØ© Ø¥Ù„Ù‰ "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†"
    selectedCityFilter = 'all';

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
    closeCityFilter();

    // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø¨Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    populateCitiesList();
}

// Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø¨ØªØµÙ…ÙŠÙ… OL/LI Ù…Ø­Ø³Ù†
function populateCitiesList() {
    const citiesContainer = document.getElementById('citiesContainer');
    if (!citiesContainer) return;

    const cities = getUniqueCountries().filter(city => city !== 'Ø§Ù„ÙƒÙ„');
    citiesContainer.innerHTML = '';

    cities.forEach((city, index) => {
        const cityCount = properties.filter(p => p['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === city).length;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± li Ù„Ù„Ù…Ø¯ÙŠÙ†Ø©
        const cityElement = document.createElement('li');
        cityElement.className = 'city-item';
        cityElement.onclick = () => filterByCity(city);

        // ØªØ·Ø¨ÙŠÙ‚ CSS Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ù†ØµØ±
        cityElement.style.cssText = `
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif;
            font-weight: 600;
            position: relative;
            counter-increment: city-counter;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        `;

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª hover
        cityElement.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
            this.style.color = 'white';
            this.style.transform = 'translateX(-5px)';
            this.style.boxShadow = '0 4px 15px rgba(0, 123, 255, 0.3)';

            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯
            const icon = this.querySelector('.city-icon');
            const count = this.querySelector('.city-count');
            if (icon) icon.style.color = 'white';
            if (count) {
                count.style.background = 'rgba(255, 255, 255, 0.2)';
                count.style.color = 'white';
            }
        });

        cityElement.addEventListener('mouseleave', function() {
            this.style.background = 'white';
            this.style.color = '#2c3e50';
            this.style.transform = 'translateX(0)';
            this.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.08)';

            // Ø¥Ø¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯
            const icon = this.querySelector('.city-icon');
            const count = this.querySelector('.city-count');
            if (icon) icon.style.color = '#007bff';
            if (count) {
                count.style.background = '#e9ecef';
                count.style.color = '#495057';
            }
        });

        cityElement.innerHTML = `
            <!-- Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
            <span style="
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                width: 25px;
                height: 25px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.6rem;
                font-weight: 700;
                flex-shrink: 0;
            ">${index + 1}</span>

            <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
            <i class="fas fa-map-marker-alt city-icon" style="
                color: #007bff;
                font-size: 0.9rem;
                flex-shrink: 0;
            "></i>

            <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
            <span style="
                flex: 1;
                font-size: 0.9rem;
                color: #2c3e50;
                font-weight: 600;
                text-align: right;
            ">${city}</span>

            <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
            <span class="city-count" style="
                background: #e9ecef;
                color: #495057;
                padding: 3px 6px;
                border-radius: 10px;
                font-size: 0.7rem;
                font-weight: 700;
                min-width: 20px;
                text-align: center;
                flex-shrink: 0;
            ">${cityCount}</span>
        `;

        citiesContainer.appendChild(cityElement);
    });
}

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ====================

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
function toggleHeaderDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId + 'Dropdown');
    const button = dropdown.previousElementSibling;

    // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø£Ø®Ø±ÙŠØ§Øª
    const isCurrentlyOpen = dropdown.classList.contains('show');

    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
    closeAllDropdowns();

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (!isCurrentlyOpen) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØºÙ„Ù‚Ø©ØŒ Ø§ÙØªØ­Ù‡Ø§
        dropdown.classList.add('show');
        button.classList.add('active');
    }
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©ØŒ ØªØ¨Ù‚Ù‰ Ù…ØºÙ„Ù‚Ø© (ØªÙ… Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© closeAllDropdowns)
}

// Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
function closeAllDropdowns() {
    const dropdowns = document.querySelectorAll('.dropdown-menu');
    const buttons = document.querySelectorAll('.dropdown-toggle');

    dropdowns.forEach(dropdown => {
        dropdown.classList.remove('show');
    });

    buttons.forEach(button => {
        button.classList.remove('active');
    });
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', function(event) {
    if (!event.target.closest('.header-dropdown')) {
        closeAllDropdowns();
    }
});

// Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function showMonthFilter() {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†ÙØ³ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
    if (typeof showMonthFilterModal === 'function') {
        showMonthFilterModal();
    } else {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØªØ´ØºÙŠÙ„Ù‡
        const oldBtn = document.getElementById('monthFilterBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function showMultiPropertyFilter() {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†ÙØ³ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
    if (typeof showMultiPropertyCityFilter === 'function') {
        showMultiPropertyCityFilter();
    } else {
        const oldBtn = document.getElementById('multiPropertyFilterBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function showContractTypeFilterFromDropdown() {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const originalFunction = window.showContractTypeFilter;
    if (originalFunction && typeof originalFunction === 'function') {
        originalFunction();
    } else {
        // ØªØ´ØºÙŠÙ„ Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
        const oldBtn = document.getElementById('contractTypeFilterBtn');
        if (oldBtn) {
            oldBtn.click();
        }
    }
}

// Ù…ØªØºÙŠØ± ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
let propertyTypeFilter = null;

// Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
function showPropertyTypeFilter() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        closeModal();
        return;
    }

    const propertyTypes = ['Ù…Ø³ØªÙˆØ¯Ø¹', 'Ù…ØµÙ†Ø¹', 'Ø´Ù‚Ø©', 'ØºØ±ÙØ©', 'Ù…Ø¹Ø±Ø¶', 'Ù…Ø­Ù„', 'Ø­ÙˆØ´', 'Ù…Ø²Ø±Ø¹Ø©', 'ÙÙ„Ø©', 'ÙˆØ±Ø´Ø©', 'Ø£Ø±Ø¶', 'Ø¹Ù…Ø§Ø±Ø©', 'Ù…ÙƒØªØ¨','Ø§Ø³ØªØ±Ø§Ø­Ø©','Ø¨ÙŠØª'];
    let html = `<div class="modal-overlay" style="display:flex; z-index: 10000;">
        <div class="modal-box property-type-filter-modal" style="max-width: 600px; max-height: 80vh; position: relative;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <i class="fas fa-tag" style="color: #28a745;"></i>
                ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
                <span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${propertyTypes.length + 1}</span>
            </h3>
            <div class="property-type-filter" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">`;

    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "Ø§Ù„ÙƒÙ„"
    const isAllActive = !propertyTypeFilter;
    html += `
        <button onclick="if(propertyTypeFilter) { togglePropertyTypeFilter(propertyTypeFilter); } closePropertyTypeFilterModal();"
                class="property-type-btn ${isAllActive ? 'active' : ''}"
                style="width: 100%; padding: 12px; margin: 4px 0; border-radius: 8px; cursor: pointer;
                       transition: all 0.3s ease; border: 1px solid #e9ecef;
                       background: ${isAllActive ? '#28a745' : 'white'}; color: ${isAllActive ? 'white' : '#495057'};
                       display: flex; align-items: center; justify-content: space-between; min-height: 50px; grid-column: 1 / -1;">
            <span style="font-weight: 700; font-size: 1.3rem;">Ø§Ù„ÙƒÙ„</span>
            ${isAllActive ? '<i class="fas fa-check" style="color: white;"></i>' : '<i class="fas fa-list" style="color: #28a745;"></i>'}
        </button>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø¹Ù…ÙˆØ¯ÙŠÙ†
    propertyTypes.forEach(type => {
        const isActive = propertyTypeFilter === type;
        html += `
            <button onclick="togglePropertyTypeFilter('${type}'); closePropertyTypeFilterModal();"
                    class="property-type-btn ${isActive ? 'active' : ''}"
                    style="width: 100%; padding: 12px; margin: 4px 0; border-radius: 8px; cursor: pointer;
                           transition: all 0.3s ease; border: 1px solid #e9ecef;
                           background: ${isActive ? '#28a745' : 'white'}; color: ${isActive ? 'white' : '#495057'};
                           display: flex; align-items: center; justify-content: space-between; min-height: 50px;">
                <span style="font-weight: 700; font-size: 1.3rem;">${type}</span>
                ${isActive ? '<i class="fas fa-check" style="color: white;"></i>' : '<i class="fas fa-tag" style="color: #28a745;"></i>'}
            </button>
        `;
    });

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closePropertyTypeFilterModal();" class="modal-action-btn close-btn property-type-filter-close-btn" id="propertyTypeFilterCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± - Ø¥ØºÙ„Ø§Ù‚');
                    closePropertyTypeFilterModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
function closePropertyTypeFilterModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±...');
    const modal = document.querySelector('.property-type-filter-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±');
        }
    }
}

// ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
function setPropertyTypeFilter(type) {
    propertyTypeFilter = type;

    // ØªØ­Ø¯ÙŠØ« activeFilters Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    activeFilters.propertyType = type || '';

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    renderData();
    closePropertyTypeFilterModal();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    updateAllFilterButtonsState();
    updatePropertyTypeButtonsState();

    console.log(`ğŸ·ï¸ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${type || 'Ø§Ù„ÙƒÙ„'}`);
}

// Ø¯Ø§Ù„Ø© toggle Ù„ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±
function togglePropertyTypeFilter(type) {
    console.log(`ğŸ”„ Toggle ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${type}`);

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙ„ØªØ± Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¦Ù‡
    if (propertyTypeFilter === type) {
        console.log(`âŒ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${type}`);
        setPropertyTypeFilter(null);
        window.currentPropertyType = 'Ø§Ù„ÙƒÙ„';
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨ØªØ·Ø¨ÙŠÙ‚Ù‡
        console.log(`âœ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${type}`);
        setPropertyTypeFilter(type);
        window.currentPropertyType = type;
    }
}

// Ø¯Ø§Ù„Ø© toggle Ù„ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
function toggleContractTypeFilter(type) {
    console.log(`ğŸ”„ Toggle ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${type}`);

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙ„ØªØ± Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¦Ù‡
    if (contractTypeFilter === type) {
        console.log(`âŒ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${type}`);
        setContractTypeFilter(null);
        window.currentContractType = 'Ø§Ù„ÙƒÙ„';
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨ØªØ·Ø¨ÙŠÙ‚Ù‡
        console.log(`âœ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${type}`);
        setContractTypeFilter(type);
        window.currentContractType = type;
    }
}

// Ø¯Ø§Ù„Ø© toggle Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ
function toggleOwnerFilter(owner) {
    console.log(`ğŸ”„ Toggle ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ: ${owner}`);

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙ„ØªØ± Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¦Ù‡
    if (activeFilters.owner === owner) {
        console.log(`âŒ Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ: ${owner}`);
        setOwnerFilter(null);
        window.currentOwner = 'Ø§Ù„ÙƒÙ„';
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨ØªØ·Ø¨ÙŠÙ‚Ù‡
        console.log(`âœ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ: ${owner}`);
        setOwnerFilter(owner);
        window.currentOwner = owner;
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
function showPropertyTypeFilterFromDropdown() {
    showPropertyTypeFilter();
}

function showOwnerFilterFromDropdown() {
    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ
    showOwnerFilter();
}

function showOwnerFilter() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        closeModal();
        return;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· CSS Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
    if (!document.getElementById('owner-filter-styles')) {
        const styles = document.createElement('style');
        styles.id = 'owner-filter-styles';
        styles.textContent = `
            .owner-filter-overlay {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0,0,0,0.5) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10000 !important;
            }

            .owner-filter-modal {
                background: white !important;
                border-radius: 12px !important;
                padding: 20px !important;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
                max-width: 90vw !important;
                width: 500px !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
            }

            .owner-btn {
                transition: all 0.2s ease !important;
            }

            .owner-btn:hover {
                transform: translateY(-1px) !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            }

            .owner-btn:active {
                transform: translateY(0) !important;
            }

            @media (max-width: 768px) {
                .owner-filter-modal {
                    width: 95vw !important;
                    max-width: 95vw !important;
                    padding: 15px !important;
                    margin: 10px !important;
                }

                .owner-btn {
                    padding: 18px 15px !important;
                    font-size: 1.2rem !important;
                    min-height: 60px !important;
                }

                .filter-options {
                    max-height: 60vh !important;
                }
            }

            @media (max-width: 480px) {
                .owner-filter-modal {
                    width: 98vw !important;
                    padding: 12px !important;
                }

                .owner-btn {
                    padding: 20px 12px !important;
                    font-size: 1.1rem !important;
                    min-height: 65px !important;
                }
            }
        `;
        document.head.appendChild(styles);
    }

    const owners = ['Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯', 'Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…'];
    let html = `<div class="modal-overlay owner-filter-overlay" style="display:flex; z-index: 10000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-box owner-filter-modal" style="max-width: 90vw; width: 500px; max-height: 90vh; position: relative; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 1.5rem;">
                <i class="fas fa-user" style="color: #fd7e14;"></i>
                ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ
                <span class="badge" style="background: #fd7e14; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${owners.length + 1}</span>
            </h3>
            <p style="color: #6c757d; margin-bottom: 15px; font-size: 1rem;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø±Ø§Ø¯ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø­Ø³Ø¨Ù‡:</p>
            <div class="filter-options" style="max-height: 50vh; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">`;

    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "Ø§Ù„ÙƒÙ„"
    const isAllActive = !activeFilters.owner || activeFilters.owner === '';
    html += `
        <button onclick="if(activeFilters.owner && activeFilters.owner !== '') { toggleOwnerFilter(activeFilters.owner); } closeOwnerFilterModal();"
                class="owner-btn ${isAllActive ? 'active' : ''}"
                style="width: 100%; padding: 15px 12px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                       transition: all 0.3s ease; border: 1px solid #e9ecef; font-family: inherit;
                       background: ${isAllActive ? '#fd7e14' : 'white'}; color: ${isAllActive ? 'white' : '#495057'};
                       display: flex; align-items: center; justify-content: space-between; min-height: 50px;
                       font-size: 1.1rem; touch-action: manipulation;">
            <span style="font-weight: 700;">Ø§Ù„ÙƒÙ„</span>
            ${isAllActive ? '<i class="fas fa-check" style="color: white; font-size: 1rem;"></i>' : '<i class="fas fa-list" style="color: #fd7e14; font-size: 1rem;"></i>'}
        </button>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠÙ†
    owners.forEach(owner => {
        const isActive = activeFilters.owner === owner;
        html += `
            <button onclick="toggleOwnerFilter('${owner}'); closeOwnerFilterModal();"
                    class="owner-btn ${isActive ? 'active' : ''}"
                    style="width: 100%; padding: 15px 12px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                           transition: all 0.3s ease; border: 1px solid #e9ecef; font-family: inherit;
                           background: ${isActive ? '#fd7e14' : 'white'}; color: ${isActive ? 'white' : '#495057'};
                           display: flex; align-items: center; justify-content: space-between; min-height: 50px;
                           font-size: 1.1rem; touch-action: manipulation;">
                <span style="font-weight: 700;">${owner}</span>
                ${isActive ? '<i class="fas fa-check" style="color: white; font-size: 1rem;"></i>' : '<i class="fas fa-user" style="color: #fd7e14; font-size: 1rem;"></i>'}
            </button>
        `;
    });

    html += `
            </div>
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="closeOwnerFilterModal();" class="modal-action-btn close-btn owner-filter-close-btn" id="ownerFilterCloseBtn"
                        style="flex: 1; background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none;
                               padding: 15px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;
                               transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;
                               min-height: 50px; touch-action: manipulation; font-family: inherit;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ - Ø¥ØºÙ„Ø§Ù‚');
                    closeOwnerFilterModal();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ');
        }
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ
function closeOwnerFilterModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ...');
    const modal = document.querySelector('.owner-filter-modal');
    if (modal) {
        const modalOverlay = modal.closest('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ');
        }
    }
}

function setOwnerFilter(owner) {
    activeFilters.owner = owner || '';

    closeOwnerFilterModal();
    renderData();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateActiveFiltersDisplay();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
    updateAllFilterButtonsState();
}

// ==================== Ù†Ø¸Ø§Ù… Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ====================

function showPropertyStatisticsPrintModal() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        closeModal();
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©
    const cities = getUniqueCountries().filter(city => city !== 'Ø§Ù„ÙƒÙ„');

    let html = `
        <div class="modal-overlay" style="display:flex;">
            <div class="modal-box" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <button class="close-modal" onclick="closeModal()">Ã—</button>
                <div style="text-align: center; margin-bottom: 25px;">
                    <h3 style="color: #007bff; margin: 0 0 10px 0; font-size: 24px;">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                    </h3>
                    <p style="color: #666; margin: 0; font-size: 16px;">
                        <i class="fas fa-info-circle"></i>
                        Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø«Ù… Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡Ø§
                    </p>
                </div>

                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                        <i class="fas fa-city" style="color: #007bff; margin-left: 8px;"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:
                    </label>
                    <select id="printCitySelect" onchange="loadPropertiesForPrint()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white; transition: border-color 0.3s;">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© --</option>
                        ${cities.map(city => `<option value="${city}">${city}</option>`).join('')}
                    </select>
                </div>

                <div id="printPropertiesContainer" style="display: none;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: bold; color: #333;">
                            <i class="fas fa-building" style="color: #007bff; margin-left: 8px;"></i> Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:
                        </label>
                        <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <!-- Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« -->
                            <div style="margin-bottom: 15px;">
                                <div style="position: relative;">
                                    <input type="text" id="propertySearchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø±..."
                                           onkeyup="filterPropertiesForPrint()"
                                           style="width: 100%; padding: 12px 40px 12px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; transition: all 0.3s;">
                                    <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button onclick="selectAllPropertiesForPrint()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; flex: 1;">
                                    <i class="fas fa-check-double"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                                </button>
                                <button onclick="deselectAllPropertiesForPrint()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; flex: 1;">
                                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                                </button>
                                <button onclick="clearPropertySearchForPrint()" style="background: linear-gradient(135deg, #6c757d, #5a6268); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; flex: 1;">
                                    <i class="fas fa-eraser"></i> Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
                                </button>
                            </div>
                            <div id="printPropertiesList" style="max-height: 300px; overflow-y: auto; background: white; border-radius: 6px; padding: 10px;">
                                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù‡Ù†Ø§ -->
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: bold; color: #333;">
                            <i class="fas fa-table" style="color: #007bff; margin-left: 8px;"></i> Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø¬Ø¯ÙˆÙ„:
                        </label>
                        <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px;">
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <button onclick="selectAllPrintColumns()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        <i class="fas fa-check-double"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                                    </button>
                                    <button onclick="deselectAllPrintColumns()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                                    </button>
                                    <button onclick="selectBasicColumns()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        <i class="fas fa-star"></i> Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
                                    </button>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 13px;">
                                <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                                <div style="grid-column: span 3; background: #e3f2fd; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                    <strong style="color: #1976d2;">ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</strong>
                                </div>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeUnitNumber" checked class="data-option-checkbox">
                                    <span>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeTenantName" checked class="data-option-checkbox">
                                    <span>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeContractNumber" checked class="data-option-checkbox">
                                    <span>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</span>
                                </label>

                                <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
                                <div style="grid-column: span 3; background: #e8f5e8; padding: 8px; border-radius: 4px; margin: 8px 0;">
                                    <strong style="color: #388e3c;">ğŸ“… Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</strong>
                                </div>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeStartDate" checked class="data-option-checkbox">
                                    <span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeEndDate" checked class="data-option-checkbox">
                                    <span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeLastUpdate" class="data-option-checkbox">
                                    <span>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</span>
                                </label>

                                <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
                                <div style="grid-column: span 3; background: #fff3e0; padding: 8px; border-radius: 4px; margin: 8px 0;">
                                    <strong style="color: #f57c00;">ğŸ’° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</strong>
                                </div>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeTotalAmount" checked class="data-option-checkbox">
                                    <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includePaidAmount" class="data-option-checkbox">
                                    <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeRemainingAmount" class="data-option-checkbox">
                                    <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeInstallmentCount" class="data-option-checkbox">
                                    <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeContractType" class="data-option-checkbox">
                                    <span>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯</span>
                                </label>

                                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± -->
                                <div style="grid-column: span 3; background: #f3e5f5; padding: 8px; border-radius: 4px; margin: 8px 0;">
                                    <strong style="color: #7b1fa2;">ğŸ¢ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±</strong>
                                </div>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeArea" class="data-option-checkbox">
                                    <span>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeOwner" class="data-option-checkbox">
                                    <span>Ø§Ù„Ù…Ø§Ù„Ùƒ</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeDeedNumber" class="data-option-checkbox">
                                    <span>Ø±Ù‚Ù… Ø§Ù„ØµÙƒ</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeDeedArea" class="data-option-checkbox">
                                    <span>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeRegistryNumber" class="data-option-checkbox">
                                    <span>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeLocation" class="data-option-checkbox">
                                    <span>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</span>
                                </label>

                                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                                <div style="grid-column: span 3; background: #e0f2f1; padding: 8px; border-radius: 4px; margin: 8px 0;">
                                    <strong style="color: #00695c;">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</strong>
                                </div>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeTenantPhone" class="data-option-checkbox">
                                    <span>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeTenantPhone2" class="data-option-checkbox">
                                    <span>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ</span>
                                </label>
                                <label class="data-option-item">
                                    <input type="checkbox" id="includeElectricityAccount" class="data-option-checkbox">
                                    <span>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions" style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                        <button onclick="generatePropertyStatisticsPDF()" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0,123,255,0.3);">
                            <i class="fas fa-file-pdf" style="margin-left: 8px;"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);
}

function loadPropertiesForPrint() {
    const citySelect = document.getElementById('printCitySelect');
    const propertiesContainer = document.getElementById('printPropertiesContainer');
    const propertiesList = document.getElementById('printPropertiesList');

    const selectedCity = citySelect.value;

    if (!selectedCity) {
        propertiesContainer.style.display = 'none';
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    const cityProperties = properties.filter(p => p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === selectedCity);
    const uniqueProperties = [...new Set(cityProperties.map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']))].filter(Boolean);

    if (uniqueProperties.length === 0) {
        propertiesList.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</p>';
        propertiesContainer.style.display = 'block';
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¹ checkboxes
    let html = '';
    uniqueProperties.forEach((propertyName, index) => {
        const unitsCount = cityProperties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName).length;
        const rentedUnits = cityProperties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '').length;
        const emptyUnits = unitsCount - rentedUnits;

        html += `
            <div style="margin-bottom: 12px; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; background: white; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 8px rgba(0,123,255,0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
                    <input type="checkbox" value="${propertyName}" style="margin-left: 15px; transform: scale(1.2);" onchange="updatePrintSelection()">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #007bff; font-size: 16px;">${propertyName}</strong>
                            <span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                ${unitsCount} ÙˆØ­Ø¯Ø©
                            </span>
                        </div>
                        <div style="display: flex; gap: 15px; font-size: 14px;">
                            <span style="color: #28a745;">
                                <i class="fas fa-check-circle" style="margin-left: 5px;"></i>
                                Ù…Ø¤Ø¬Ø±Ø©: ${rentedUnits}
                            </span>
                            <span style="color: #ffc107;">
                                <i class="fas fa-home" style="margin-left: 5px;"></i>
                                ÙØ§Ø±ØºØ©: ${emptyUnits}
                            </span>
                        </div>
                    </div>
                </label>
            </div>
        `;
    });

    propertiesList.innerHTML = html;
    propertiesContainer.style.display = 'block';
}

function selectAllPropertiesForPrint() {
    // ØªØ­Ø¯ÙŠØ¯ ÙÙ‚Ø· Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© (ØºÙŠØ± Ø§Ù„Ù…Ø®ÙÙŠØ© Ø¨Ø§Ù„Ø¨Ø­Ø«)
    const visibleCheckboxes = document.querySelectorAll('#printPropertiesList > div:not([style*="display: none"]) input[type="checkbox"]');
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updatePrintSelection();
}

function deselectAllPropertiesForPrint() {
    // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙÙ‚Ø· Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© (ØºÙŠØ± Ø§Ù„Ù…Ø®ÙÙŠØ© Ø¨Ø§Ù„Ø¨Ø­Ø«)
    const visibleCheckboxes = document.querySelectorAll('#printPropertiesList > div:not([style*="display: none"]) input[type="checkbox"]');
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updatePrintSelection();
}

function updatePrintSelection() {
    const checkboxes = document.querySelectorAll('#printPropertiesList input[type="checkbox"]:checked');
    const selectedCount = checkboxes.length;

    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø± Ù„ÙŠØ¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    const generateButton = document.querySelector('button[onclick="generatePropertyStatisticsPDF()"]');
    if (generateButton) {
        if (selectedCount > 0) {
            generateButton.innerHTML = `<i class="fas fa-file-pdf" style="margin-left: 8px;"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF (${selectedCount} Ø¹Ù‚Ø§Ø±)`;
            generateButton.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
        } else {
            generateButton.innerHTML = `<i class="fas fa-file-pdf" style="margin-left: 8px;"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF`;
            generateButton.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
        }
    }

    console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ ${selectedCount} Ø¹Ù‚Ø§Ø± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©`);
}

function selectAllPrintColumns() {
    const checkboxes = document.querySelectorAll('[id^="include"]:not([id*="Property"])');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function deselectAllPrintColumns() {
    const checkboxes = document.querySelectorAll('[id^="include"]:not([id*="Property"])');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

function selectBasicColumns() {
    // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹
    deselectAllPrintColumns();

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
    const basicColumns = [
        'includeUnitNumber',
        'includeTenantName',
        'includeContractNumber',
        'includeStartDate',
        'includeEndDate',
        'includeTotalAmount'
    ];

    basicColumns.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
}

function filterPropertiesForPrint() {
    const searchTerm = document.getElementById('propertySearchInput').value.toLowerCase().trim();
    const propertyItems = document.querySelectorAll('#printPropertiesList > div:not(#noResultsMessage):not(#searchResultsInfo)');

    let visibleCount = 0;
    const totalCount = propertyItems.length;

    propertyItems.forEach(item => {
        const propertyName = item.querySelector('strong').textContent.toLowerCase();
        const isVisible = searchTerm === '' || propertyName.includes(searchTerm);

        item.style.display = isVisible ? 'block' : 'none';
        if (isVisible) visibleCount++;
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    const existingMessage = document.getElementById('noResultsMessage');
    const existingInfo = document.getElementById('searchResultsInfo');
    if (existingMessage) existingMessage.remove();
    if (existingInfo) existingInfo.remove();

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    if (searchTerm !== '') {
        const resultsInfo = document.createElement('div');
        resultsInfo.id = 'searchResultsInfo';

        if (visibleCount === 0) {
            resultsInfo.innerHTML = `
                <div class="no-results-message">
                    <i class="fas fa-search"></i>
                    <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù‚Ø§Ø±Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "<strong>${searchTerm}</strong>"</p>
                    <small>Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</small>
                </div>
            `;
        } else {
            resultsInfo.innerHTML = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 6px; margin-bottom: 10px; text-align: center;">
                    <i class="fas fa-check-circle"></i>
                    ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ <strong>${visibleCount}</strong> Ù…Ù† Ø£ØµÙ„ <strong>${totalCount}</strong> Ø¹Ù‚Ø§Ø±
                </div>
            `;
        }

        document.getElementById('printPropertiesList').insertBefore(resultsInfo, document.getElementById('printPropertiesList').firstChild);
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
    updatePrintSelection();
}

function clearPropertySearchForPrint() {
    document.getElementById('propertySearchInput').value = '';
    filterPropertiesForPrint();
}

function formatUnitNumbers(unitNumbers) {
    // ØªÙ†Ø³ÙŠÙ‚ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„ØªÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù‚Ø§Ø¨Ù„ÙŠØ© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©
    const numbers = unitNumbers.split('ØŒ ');
    if (numbers.length <= 3) {
        return unitNumbers;
    } else if (numbers.length <= 6) {
        // ØªÙ‚Ø³ÙŠÙ… Ø¥Ù„Ù‰ Ø³Ø·Ø±ÙŠÙ†
        const mid = Math.ceil(numbers.length / 2);
        const firstLine = numbers.slice(0, mid).join('ØŒ ');
        const secondLine = numbers.slice(mid).join('ØŒ ');
        return `${firstLine}<br>${secondLine}`;
    } else {
        // ØªÙ‚Ø³ÙŠÙ… Ø¥Ù„Ù‰ Ø«Ù„Ø§Ø«Ø© Ø£Ø³Ø·Ø±
        const third = Math.ceil(numbers.length / 3);
        const firstLine = numbers.slice(0, third).join('ØŒ ');
        const secondLine = numbers.slice(third, third * 2).join('ØŒ ');
        const thirdLine = numbers.slice(third * 2).join('ØŒ ');
        return `${firstLine}<br>${secondLine}<br>${thirdLine}`;
    }
}

function generateSeparateReportHTML(selectedCity, selectedProperties) {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ©
    const includeUnitNumber = document.getElementById('includeUnitNumber')?.checked ?? true;
    const includeTenantName = document.getElementById('includeTenantName')?.checked ?? true;
    const includeContractNumber = document.getElementById('includeContractNumber')?.checked ?? true;
    const includeStartDate = document.getElementById('includeStartDate')?.checked ?? true;
    const includeEndDate = document.getElementById('includeEndDate')?.checked ?? true;
    const includeLastUpdate = document.getElementById('includeLastUpdate')?.checked ?? false;
    const includeTotalAmount = document.getElementById('includeTotalAmount')?.checked ?? true;
    const includePaidAmount = document.getElementById('includePaidAmount')?.checked ?? false;
    const includeRemainingAmount = document.getElementById('includeRemainingAmount')?.checked ?? false;
    const includeInstallmentCount = document.getElementById('includeInstallmentCount')?.checked ?? false;
    const includeContractType = document.getElementById('includeContractType')?.checked ?? false;
    const includeArea = document.getElementById('includeArea')?.checked ?? false;
    const includeOwner = document.getElementById('includeOwner')?.checked ?? false;
    const includeDeedNumber = document.getElementById('includeDeedNumber')?.checked ?? false;
    const includeDeedArea = document.getElementById('includeDeedArea')?.checked ?? false;
    const includeRegistryNumber = document.getElementById('includeRegistryNumber')?.checked ?? false;
    const includeLocation = document.getElementById('includeLocation')?.checked ?? false;
    const includeTenantPhone = document.getElementById('includeTenantPhone')?.checked ?? false;
    const includeTenantPhone2 = document.getElementById('includeTenantPhone2')?.checked ?? false;
    const includeElectricityAccount = document.getElementById('includeElectricityAccount')?.checked ?? false;

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù…Ø«Ù„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±)
    let totalUnits = 0;
    let totalRentedUnits = 0;
    let totalEmptyUnits = 0;
    let totalExpiredUnits = 0;
    let totalCommercial = 0;
    let totalResidential = 0;
    let propertyDetails = [];

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©)
    const uniqueContracts = {};
    const today = new Date();

    selectedProperties.forEach(propertyName => {
        const propertyUnits = properties.filter(p =>
            p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === selectedCity && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        totalUnits += propertyUnits.length;

        // Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø§Ù„ØµÙƒ ÙˆØ§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ)
        if (propertyUnits.length > 0) {
            const firstUnit = propertyUnits[0];
            propertyDetails.push({
                name: propertyName,
                deedNumber: firstUnit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                deedArea: firstUnit['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || firstUnit['Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                registryNumber: firstUnit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || firstUnit['Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
            });
        }

        propertyUnits.forEach(unit => {
            if (unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '') {
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©)
                const contractKey = `${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}_${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}`;

                if (!uniqueContracts[contractKey]) {
                    uniqueContracts[contractKey] = true;
                    totalRentedUnits++;

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø°ÙƒÙŠØ© (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©)
                    const smartTotal = calculateSmartTotal(unit);
                    const totalAmount = smartTotal.amount;

                    if (unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] === 'Ø¶Ø±ÙŠØ¨ÙŠ') {
                        totalCommercial += totalAmount;
                    } else {
                        totalResidential += totalAmount;
                    }

                    // ØªØ´Ø®ÙŠØµ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…
                    console.log(`âœ… Ø¹Ù‚Ø¯ ${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']} - ${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}: ${totalAmount.toLocaleString()} Ø±ÙŠØ§Ù„ (${smartTotal.source})`);
                }
            } else {
                totalEmptyUnits++;
            }
        });
    });

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©)
    const taxableBase = totalCommercial / 1.15;
    const vat = taxableBase * 0.15;
    const afterTaxCommercial = taxableBase + vat;

    // ØªØ´Ø®ÙŠØµ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº
    console.log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª PDF - ØªØ¬Ø§Ø±ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${taxableBase.toLocaleString()} Ø±ÙŠØ§Ù„`);
    console.log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª PDF - Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠ: ${vat.toLocaleString()} Ø±ÙŠØ§Ù„`);
    console.log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª PDF - ØªØ¬Ø§Ø±ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${afterTaxCommercial.toLocaleString()} Ø±ÙŠØ§Ù„`);
    console.log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª PDF - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³ÙƒÙ†ÙŠ: ${totalResidential.toLocaleString()} Ø±ÙŠØ§Ù„`);
    console.log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª PDF - Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©: ${totalRentedUnits}`);

    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Portrait)
    let firstPageHTML = `
        <div style="font-family: 'Arial', sans-serif; direction: rtl; color: #333; line-height: 1.5; width: 210mm; height: 297mm; padding: 15mm; background: white; box-sizing: border-box; position: relative;">
            <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
            <div style="text-align: center; margin-bottom: 25px; border-bottom: 3px solid #007bff; padding-bottom: 15px;">
                <h1 style="color: #007bff; font-size: 24px; margin: 0 0 8px 0; font-weight: bold;">
                    ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                </h1>
                <h2 style="color: #666; font-size: 18px; margin: 0 0 8px 0;">
                    Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©
                </h2>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 15px;">
                    <p style="margin: 3px 0; font-size: 14px;"><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${selectedCity}</p>
                    <p style="margin: 3px 0; font-size: 14px;"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> ${new Date().toLocaleDateString('ar-SA')}</p>
                    <p style="margin: 3px 0; font-size: 14px;"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:</strong> ${selectedProperties.length}</p>
                </div>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒÙˆÙƒ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹ÙŠÙ†ÙŠØ© -->
            <div style="margin-bottom: 25px;">
                <h2 style="color: #007bff; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 8px;">
                    ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒÙˆÙƒ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹ÙŠÙ†ÙŠØ©
                </h2>
                <div style="display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px;">
    `;

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒÙ„ Ø¹Ù‚Ø§Ø± Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    propertyDetails.forEach((property, index) => {
        firstPageHTML += `
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; border-right: 4px solid #007bff; margin-bottom: 8px;">
                <h3 style="color: #007bff; margin: 0 0 10px 0; font-size: 14px; font-weight: bold;">
                    ğŸ¢ ${property.name}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px;">
                    <div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #dee2e6;">
                        <strong style="color: #6f42c1; font-size: 11px;">ğŸ“„ Ø±Ù‚Ù… Ø§Ù„ØµÙƒ:</strong><br>
                        <span style="font-size: 12px; color: #495057; font-weight: bold;">${property.deedNumber}</span>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #dee2e6;">
                        <strong style="color: #20c997; font-size: 11px;">ğŸ“ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ:</strong><br>
                        <span style="font-size: 12px; color: #495057; font-weight: bold;">${property.deedArea}</span>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #dee2e6;">
                        <strong style="color: #fd7e14; font-size: 11px;">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ:</strong><br>
                        <span style="font-size: 12px; color: #495057; font-weight: bold;">${property.registryNumber}</span>
                    </div>
                </div>
            </div>
        `;
    });

    const firstPageHTMLEnd = `
                </div>
            </div>

            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª -->
            <div style="margin-bottom: 25px;">
                <h2 style="color: #007bff; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 8px;">
                    ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                </h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                    <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; font-size: 14px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
                        <p style="margin: 0; font-size: 24px; font-weight: bold;">${totalUnits}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #28a745, #1e7e34); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; font-size: 14px;">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©</h3>
                        <p style="margin: 0; font-size: 24px; font-weight: bold;">${totalRentedUnits}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; font-size: 14px;">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©</h3>
                        <p style="margin: 0; font-size: 24px; font-weight: bold;">${totalEmptyUnits}</p>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
            <div style="margin-bottom: 25px;">
                <h2 style="color: #007bff; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 8px;">
                    ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                </h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 15px;">
                    <div style="background: linear-gradient(135deg, #2a4b9b, #1e3a8a); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; font-size: 14px;">ØªØ¬Ø§Ø±ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</h3>
                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${taxableBase.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #e46e6d, #dc3545); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; font-size: 14px;">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</h3>
                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${vat.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #05940e, #28a745); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; font-size: 14px;">ØªØ¬Ø§Ø±ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</h3>
                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${afterTaxCommercial.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e42, #fd7e14); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; font-size: 14px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³ÙƒÙ†ÙŠ</h3>
                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})} Ø±ÙŠØ§Ù„</p>
                    </div>
                </div>
            </div>

            <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ -->
            <div style="position: absolute; bottom: 15mm; left: 15mm; right: 15mm; text-align: center; border-top: 2px solid #007bff; padding-top: 10px; color: #666;">
                <p style="margin: 3px 0; font-size: 12px; font-weight: bold;">Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</p>
                <p style="margin: 3px 0; font-size: 10px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-SA')}</p>
                <p style="margin: 3px 0; font-size: 10px;">Ø§Ù„ØµÙØ­Ø© 1 Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒÙˆÙƒ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
            </div>
        </div>
    `;

    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© (Landscape)
    const detailsPageHTML = generateDetailsPageHTML(selectedCity, selectedProperties, {
        includeUnitNumber, includeTenantName, includeContractNumber, includeStartDate, includeEndDate,
        includeLastUpdate, includeTotalAmount, includePaidAmount, includeRemainingAmount,
        includeInstallmentCount, includeContractType, includeArea, includeOwner,
        includeDeedNumber, includeDeedArea, includeRegistryNumber, includeLocation,
        includeTenantPhone, includeTenantPhone2, includeElectricityAccount
    });

    return {
        firstPageHTML: firstPageHTML + firstPageHTMLEnd,
        detailsPageHTML: detailsPageHTML
    };
}

function generateDetailsPageHTML(selectedCity, selectedProperties, options) {
    const {
        includeUnitNumber, includeTenantName, includeContractNumber, includeStartDate, includeEndDate,
        includeLastUpdate, includeTotalAmount, includePaidAmount, includeRemainingAmount,
        includeInstallmentCount, includeContractType, includeArea, includeOwner,
        includeDeedNumber, includeDeedArea, includeRegistryNumber, includeLocation,
        includeTenantPhone, includeTenantPhone2, includeElectricityAccount
    } = options;

    // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    let allTenants = [];

    selectedProperties.forEach(propertyName => {
        const propertyUnits = properties.filter(p =>
            p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === selectedCity && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        const rentedUnits = propertyUnits.filter(u => u['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && u['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '');

        // Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
        const contractGroups = {};
        rentedUnits.forEach(unit => {
            const contractNumber = unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            if (!contractGroups[contractNumber]) {
                contractGroups[contractNumber] = [];
            }
            contractGroups[contractNumber].push(unit);
        });

        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„ Ø¹Ù‚Ø¯ ÙƒÙ…Ø³ØªØ£Ø¬Ø± Ù…Ù†ÙØµÙ„
        Object.entries(contractGroups).forEach(([contractNumber, units]) => {
            allTenants.push({
                contractNumber,
                units,
                propertyName,
                tenantName: units[0]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']
            });
        });
    });

    // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø¥Ù„Ù‰ ØµÙØ­Ø§Øª (4 Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ù„ÙƒÙ„ ØµÙØ­Ø©)
    const tenantsPerPage = 4;
    const pages = [];
    for (let i = 0; i < allTenants.length; i += tenantsPerPage) {
        pages.push(allTenants.slice(i, i + tenantsPerPage));
    }

    let html = '';

    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ Portrait (4 Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ù„ÙƒÙ„ ØµÙØ­Ø©)
    pages.forEach((pageTenantsArray, pageIndex) => {
        html += `
            <div style="font-family: 'Arial', sans-serif; direction: rtl; color: #333; line-height: 1.6; width: 210mm; height: 297mm; padding: 15mm; background: white; box-sizing: border-box; page-break-after: always;">
                <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
                <div style="text-align: center; margin-bottom: 25px; border-bottom: 3px solid #007bff; padding-bottom: 15px;">
                    <h1 style="color: #007bff; font-size: 24px; margin: 0 0 8px 0; font-weight: bold;">
                        ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©
                    </h1>
                    <p style="color: #666; font-size: 14px; margin: 0;">
                        Ø§Ù„ØµÙØ­Ø© ${pageIndex + 1} Ù…Ù† ${pages.length}
                    </p>
                </div>
        `;

        // Ø¹Ø±Ø¶ 4 Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©
        pageTenantsArray.forEach((tenant, tenantIndex) => {
            const { contractNumber, units, propertyName, tenantName } = tenant;

            html += `
                <div style="margin-bottom: 30px; border: 2px solid #e9ecef; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <!-- Ø±Ø£Ø³ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± -->
                    <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 15px; text-align: center;">
                        <h2 style="margin: 0; font-size: 18px; font-weight: bold;">
                            ğŸ‘¤ ${tenantName}
                        </h2>
                        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">
                            ğŸ¢ ${propertyName} | ğŸ“‹ Ø¹Ù‚Ø¯ Ø±Ù‚Ù…: ${contractNumber}
                        </p>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± -->
                    <div style="padding: 20px; background: white;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            `;

            // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯
            units.forEach((unit, unitIndex) => {
                if (unitIndex > 0) {
                    html += `<div style="grid-column: 1 / -1; border-top: 1px solid #e9ecef; margin: 10px 0;"></div>`;
                }

                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
                if (includeUnitNumber && unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-hashtag" style="color: #007bff; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
                            <span style="color: #666;">${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}</span>
                        </div>
                    `;
                }

                if (includeContractType && unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-file-contract" style="color: #28a745; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯:</span>
                            <span style="color: #666;">${unit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯']}</span>
                        </div>
                    `;
                }

                if (includeStartDate && unit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calendar-plus" style="color: #17a2b8; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</span>
                            <span style="color: #666;">${unit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']}</span>
                        </div>
                    `;
                }

                if (includeEndDate && unit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calendar-minus" style="color: #dc3545; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</span>
                            <span style="color: #666;">${unit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']}</span>
                        </div>
                    `;
                }

                if (includeTotalAmount && unit['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-money-bill-wave" style="color: #fd7e14; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                            <span style="color: #666; font-weight: bold;">${parseFloat(unit['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']).toLocaleString()} Ø±ÙŠØ§Ù„</span>
                        </div>
                    `;
                }

                if (includeArea && unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-ruler-combined" style="color: #6f42c1; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</span>
                            <span style="color: #666;">${unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©']} Ù…Â²</span>
                        </div>
                    `;
                }

                // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø±
                if (includeTenantPhone && unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-phone" style="color: #28a745; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
                            <a href="tel:${unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„']}" style="color: #007bff; text-decoration: none;">${unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„']}</a>
                        </div>
                    `;
                }

                if (includeTenantPhone2 && unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-phone-alt" style="color: #17a2b8; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ:</span>
                            <a href="tel:${unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ']}" style="color: #007bff; text-decoration: none;">${unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ']}</a>
                        </div>
                    `;
                }

                // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¹ Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø±
                if (includeLocation && unit['Ø§Ù„Ù…ÙˆÙ‚Ø¹']) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-map-marker-alt" style="color: #dc3545; width: 16px;"></i>
                            <span style="font-weight: bold; color: #333;">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span>
                            <a href="${unit['Ø§Ù„Ù…ÙˆÙ‚Ø¹']}" target="_blank" style="color: #007bff; text-decoration: none;">ğŸ“ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
                        </div>
                    `;
                }
            });

            html += `
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
            </div>
        `;
    });

    return html;
}




function generateReportHTML(selectedCity, selectedProperties) {
    console.warn('âš ï¸ ØªØ­Ø°ÙŠØ±: ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© generateReportHTML Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† generateSeparateReportHTML');
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ©
    const includeUnitNumber = document.getElementById('includeUnitNumber')?.checked ?? true;
    const includeTenantName = document.getElementById('includeTenantName')?.checked ?? true;
    const includeContractNumber = document.getElementById('includeContractNumber')?.checked ?? true;
    const includeStartDate = document.getElementById('includeStartDate')?.checked ?? true;
    const includeEndDate = document.getElementById('includeEndDate')?.checked ?? true;
    const includeLastUpdate = document.getElementById('includeLastUpdate')?.checked ?? false;
    const includeTotalAmount = document.getElementById('includeTotalAmount')?.checked ?? true;
    const includePaidAmount = document.getElementById('includePaidAmount')?.checked ?? false;
    const includeRemainingAmount = document.getElementById('includeRemainingAmount')?.checked ?? false;
    const includeInstallmentCount = document.getElementById('includeInstallmentCount')?.checked ?? false;
    const includeContractType = document.getElementById('includeContractType')?.checked ?? false;
    const includeArea = document.getElementById('includeArea')?.checked ?? false;
    const includeOwner = document.getElementById('includeOwner')?.checked ?? false;
    const includeDeedNumber = document.getElementById('includeDeedNumber')?.checked ?? false;
    const includeDeedArea = document.getElementById('includeDeedArea')?.checked ?? false;
    const includeRegistryNumber = document.getElementById('includeRegistryNumber')?.checked ?? false;
    const includeLocation = document.getElementById('includeLocation')?.checked ?? false;
    const includeTenantPhone = document.getElementById('includeTenantPhone')?.checked ?? false;
    const includeTenantPhone2 = document.getElementById('includeTenantPhone2')?.checked ?? false;
    const includeElectricityAccount = document.getElementById('includeElectricityAccount')?.checked ?? false;

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let totalUnits = 0;
    let totalRentedUnits = 0;
    let totalEmptyUnits = 0;
    let totalAmount = 0;
    let propertyDetails = [];

    selectedProperties.forEach(propertyName => {
        const propertyUnits = properties.filter(p =>
            p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === selectedCity && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        totalUnits += propertyUnits.length;

        // Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø§Ù„ØµÙƒ ÙˆØ§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ)
        if (propertyUnits.length > 0) {
            const firstUnit = propertyUnits[0];
            propertyDetails.push({
                name: propertyName,
                deedNumber: firstUnit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                deedArea: firstUnit['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || firstUnit['Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                registryNumber: firstUnit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || firstUnit['Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
            });
        }

        propertyUnits.forEach(unit => {
            if (unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '') {
                totalRentedUnits++;
                const amount = parseFloat(unit['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || 0);
                totalAmount += amount;
            } else {
                totalEmptyUnits++;
            }
        });
    });

    let html = `
        <div style="font-family: 'Arial', sans-serif; direction: rtl; color: #333; line-height: 1.6;">
            <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
            <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #007bff; padding-bottom: 20px;">
                <h1 style="color: #007bff; font-size: 28px; margin: 0 0 10px 0; font-weight: bold;">
                    ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                </h1>
                <h2 style="color: #666; font-size: 20px; margin: 0 0 10px 0;">
                    Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©
                </h2>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <p style="margin: 5px 0; font-size: 16px;"><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${selectedCity}</p>
                    <p style="margin: 5px 0; font-size: 16px;"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> ${new Date().toLocaleDateString('ar-SA')}</p>
                    <p style="margin: 5px 0; font-size: 16px;"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:</strong> ${selectedProperties.length}</p>
                </div>
            </div>

            <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
            <div style="margin-bottom: 40px;">
                <h2 style="color: #007bff; font-size: 22px; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                    ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
                </h2>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
                        <p style="margin: 0; font-size: 32px; font-weight: bold;">${totalUnits}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #28a745, #1e7e34); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©</h3>
                        <p style="margin: 0; font-size: 32px; font-weight: bold;">${totalRentedUnits}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©</h3>
                        <p style="margin: 0; font-size: 32px; font-weight: bold;">${totalEmptyUnits}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #17a2b8, #117a8b); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h3>
                        <p style="margin: 0; font-size: 24px; font-weight: bold;">${totalAmount.toLocaleString()} Ø±ÙŠØ§Ù„</p>
                    </div>
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒÙˆÙƒ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹ÙŠÙ†ÙŠØ© -->
                <div style="margin-top: 40px;">
                    <h2 style="color: #007bff; font-size: 22px; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                        ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒÙˆÙƒ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹ÙŠÙ†ÙŠØ©
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(1, 1fr); gap: 15px;">
            `;

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒÙ„ Ø¹Ù‚Ø§Ø±
            propertyDetails.forEach((property, index) => {
                html += `
                    <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; border-right: 5px solid #007bff;">
                        <h3 style="color: #007bff; margin: 0 0 15px 0; font-size: 18px;">
                            ğŸ¢ ${property.name}
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 14px;">
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6;">
                                <strong style="color: #6f42c1;">ğŸ“„ Ø±Ù‚Ù… Ø§Ù„ØµÙƒ:</strong><br>
                                <span style="font-size: 16px; color: #495057;">${property.deedNumber}</span>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6;">
                                <strong style="color: #20c997;">ğŸ“ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ:</strong><br>
                                <span style="font-size: 16px; color: #495057;">${property.deedArea}</span>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6;">
                                <strong style="color: #fd7e14;">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ:</strong><br>
                                <span style="font-size: 16px; color: #495057;">${property.registryNumber}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„ ØµÙØ­Ø© Ù‚Ø¨Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
    html += `
            <div style="page-break-before: always;"></div>

            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© -->
            <div style="margin-bottom: 30px;">
                <h1 style="color: #007bff; font-size: 24px; text-align: center; margin-bottom: 30px; border-bottom: 3px solid #007bff; padding-bottom: 15px;">
                    ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©
                </h1>
    `;

    // ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ø¹Ù‚Ø§Ø±
    selectedProperties.forEach((propertyName, propertyIndex) => {
        const propertyUnits = properties.filter(p =>
            p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === selectedCity && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        const rentedUnits = propertyUnits.filter(u => u['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && u['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '');

        if (rentedUnits.length > 0) {
            // Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
            const contractGroups = {};
            rentedUnits.forEach(unit => {
                const contractNumber = unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!contractGroups[contractNumber]) {
                    contractGroups[contractNumber] = [];
                }
                contractGroups[contractNumber].push(unit);
            });

            html += `
                <div style="margin-bottom: 40px; page-break-inside: avoid;">
                    <h2 style="color: #007bff; font-size: 20px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border-right: 5px solid #007bff;">
                        ğŸ¢ ${propertyIndex + 1}. ${propertyName}
                    </h2>

                    <table class="landscape-table" style="width: 100%; border-collapse: collapse; table-layout: auto;">
                        <thead style="position: sticky; top: 0; z-index: 100; background-color: #007bff;">
                            <tr style="background-color: #007bff; color: white;">
            `;

            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            if (includeUnitNumber) {
                html += `<th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th>`;
            }
            if (includeTenantName) {
                html += `<th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>`;
            }
            if (includeContractNumber) {
                html += `<th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>`;
            }
            if (includeStartDate) {
                html += `<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>`;
            }
            if (includeEndDate) {
                html += `<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>`;
            }
            if (includeLastUpdate) {
                html += `<th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>`;
            }
            if (includeTotalAmount) {
                html += `<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>`;
            }
            if (includePaidAmount) {
                html += `<th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>`;
            }
            if (includeRemainingAmount) {
                html += `<th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>`;
            }
            if (includeInstallmentCount) {
                html += `<th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</th>`;
            }
            if (includeContractType) {
                html += `<th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯</th>`;
            }
            if (includeArea) {
                html += `<th>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</th>`;
            }
            if (includeOwner) {
                html += `<th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th>`;
            }
            if (includeDeedNumber) {
                html += `<th>Ø±Ù‚Ù… Ø§Ù„ØµÙƒ</th>`;
            }
            if (includeDeedArea) {
                html += `<th>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ</th>`;
            }
            if (includeRegistryNumber) {
                html += `<th>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ</th>`;
            }
            if (includeLocation) {
                html += `<th>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</th>`;
            }
            if (includeTenantPhone) {
                html += `<th>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>`;
            }
            if (includeTenantPhone2) {
                html += `<th>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ</th>`;
            }
            if (includeElectricityAccount) {
                html += `<th>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</th>`;
            }

            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
            let rowIndex = 0;
            Object.keys(contractGroups).forEach(contractNumber => {
                const contractUnits = contractGroups[contractNumber];
                const firstUnit = contractUnits[0];
                const unitNumbers = contractUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').join('ØŒ ');
                const formattedUnitNumbers = formatUnitNumbers(unitNumbers);

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ù„Ù„Ø¹Ù‚Ø¯
                const totalAmountForContract = contractUnits.reduce((sum, u) => sum + parseFloat(u['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || 0), 0);
                const totalPaidForContract = contractUnits.reduce((sum, u) => sum + parseFloat(u['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹'] || 0), 0);
                const totalRemainingForContract = contractUnits.reduce((sum, u) => sum + parseFloat(u['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'] || 0), 0);

                const rowColor = rowIndex % 2 === 0 ? '#f8f9fa' : 'white';
                rowIndex++;

                html += `<tr style="background: ${rowColor};">`;

                if (includeUnitNumber) {
                    html += `<td class="units-cell" style="font-weight: bold; color: #007bff;">${formattedUnitNumbers}</td>`;
                }
                if (includeTenantName) {
                    html += `<td>${firstUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeContractNumber) {
                    html += `<td style="font-weight: bold; color: #dc3545;">${contractNumber}</td>`;
                }
                if (includeStartDate) {
                    html += `<td>${firstUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] || firstUnit['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeEndDate) {
                    html += `<td>${firstUnit['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || firstUnit['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeLastUpdate) {
                    html += `<td>${firstUnit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || firstUnit['last_update'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeTotalAmount) {
                    html += `<td style="font-weight: bold; color: #28a745;">${totalAmountForContract.toLocaleString()} Ø±ÙŠØ§Ù„</td>`;
                }
                if (includePaidAmount) {
                    html += `<td style="font-weight: bold; color: #17a2b8;">${totalPaidForContract.toLocaleString()} Ø±ÙŠØ§Ù„</td>`;
                }
                if (includeRemainingAmount) {
                    html += `<td style="font-weight: bold; color: #ffc107;">${totalRemainingForContract.toLocaleString()} Ø±ÙŠØ§Ù„</td>`;
                }
                if (includeInstallmentCount) {
                    html += `<td>${firstUnit['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] || firstUnit['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeContractType) {
                    html += `<td>${firstUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeArea) {
                    html += `<td>${firstUnit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeOwner) {
                    html += `<td>${firstUnit['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeDeedNumber) {
                    html += `<td>${firstUnit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeDeedArea) {
                    html += `<td>${firstUnit['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || firstUnit['Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeRegistryNumber) {
                    html += `<td>${firstUnit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || firstUnit['Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }
                if (includeLocation) {
                    const location = firstUnit['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    let displayLocation;
                    if (location.includes('http')) {
                        displayLocation = `<a href="${location}" target="_blank" style="color: #007bff; text-decoration: underline;">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>`;
                    } else {
                        displayLocation = location;
                    }
                    html += `<td>${displayLocation}</td>`;
                }
                if (includeTenantPhone) {
                    const phone = firstUnit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || firstUnit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    let displayPhone;
                    if (phone !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' && phone.trim() !== '') {
                        // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ù„Ù„Ø§ØªØµØ§Ù„
                        const cleanPhone = phone.replace(/\D/g, ''); // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                        displayPhone = `<a href="tel:${cleanPhone}" style="color: #28a745; text-decoration: underline;">ğŸ“ ${phone}</a>`;
                    } else {
                        displayPhone = phone;
                    }
                    html += `<td>${displayPhone}</td>`;
                }
                if (includeTenantPhone2) {
                    const phone2 = firstUnit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ'] || firstUnit['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ 2'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    let displayPhone2;
                    if (phone2 !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' && phone2.trim() !== '') {
                        // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ù„Ù„Ø§ØªØµØ§Ù„
                        const cleanPhone2 = phone2.replace(/\D/g, ''); // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                        displayPhone2 = `<a href="tel:${cleanPhone2}" style="color: #28a745; text-decoration: underline;">ğŸ“ ${phone2}</a>`;
                    } else {
                        displayPhone2 = phone2;
                    }
                    html += `<td>${displayPhone2}</td>`;
                }
                if (includeElectricityAccount) {
                    html += `<td>${firstUnit['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>`;
                }

                html += `</tr>`;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
    });

    html += `</div>`;

    html += `
            <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
            <div style="margin-top: 40px; text-align: center; border-top: 2px solid #007bff; padding-top: 20px; color: #666;">
                <p style="margin: 5px 0;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</p>
                <p style="margin: 5px 0;">Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</p>
                <p style="margin: 5px 0; font-size: 12px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-SA')}</p>
            </div>
        </div>
    `;

    return html;
}

async function generatePropertyStatisticsPDF() {
    const citySelect = document.getElementById('printCitySelect');
    const selectedCity = citySelect.value;

    if (!selectedCity) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }

    const checkboxes = document.querySelectorAll('#printPropertiesList input[type="checkbox"]:checked');
    const selectedProperties = Array.from(checkboxes).map(cb => cb.value);

    if (selectedProperties.length === 0) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù‚Ø§Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
    const loadingMessage = document.createElement('div');
    loadingMessage.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
            <div style="text-align: center;">
                <div style="margin-bottom: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 40px;"></i>
                </div>
                <div>Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF...</div>
                <div style="font-size: 14px; margin-top: 10px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
            </div>
        </div>
    `;
    document.body.appendChild(loadingMessage);

    try {
        // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠØ© Ù…Ù†ÙØµÙ„ØªÙŠÙ†
        const { firstPageHTML, detailsPageHTML } = generateSeparateReportHTML(selectedCity, selectedProperties);

        // Ø¥Ù†Ø´Ø§Ø¡ PDF Ù…Ø®ØªÙ„Ø·
        await createMixedOrientationPDF(firstPageHTML, detailsPageHTML, selectedCity, loadingMessage);

    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF:', error);
        document.body.removeChild(loadingMessage);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

async function createMixedOrientationPDF(firstPageHTML, detailsPageHTML, selectedCity, loadingMessage) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4'); // Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¨Ù€ Portrait Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Portrait)
        const firstPageDiv = document.createElement('div');
        firstPageDiv.innerHTML = firstPageHTML;
        firstPageDiv.style.position = 'absolute';
        firstPageDiv.style.left = '-9999px';
        firstPageDiv.style.top = '0';
        firstPageDiv.style.width = '210mm';
        firstPageDiv.style.background = 'white';
        firstPageDiv.style.fontFamily = 'Arial, sans-serif';
        firstPageDiv.style.fontSize = '14px';
        firstPageDiv.style.lineHeight = '1.6';
        firstPageDiv.style.direction = 'rtl';
        firstPageDiv.style.color = '#333';
        document.body.appendChild(firstPageDiv);

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
        const firstPageCanvas = await html2canvas(firstPageDiv, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            width: firstPageDiv.scrollWidth,
            height: firstPageDiv.scrollHeight
        });

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„Ù€ PDF (Portrait)
        const firstPageImgData = firstPageCanvas.toDataURL('image/png');
        const firstPageImgWidth = 210; // A4 Portrait width
        const firstPagePageHeight = 297; // A4 Portrait height
        const firstPageImgHeight = (firstPageCanvas.height * firstPageImgWidth) / firstPageCanvas.width;

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ØªÙ…Ù„Ø£ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        doc.addImage(firstPageImgData, 'PNG', 0, 0, firstPageImgWidth, Math.min(firstPageImgHeight, firstPagePageHeight));

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        document.body.removeChild(firstPageDiv);

        // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø§Øª Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Portrait) - ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø­ØªÙˆÙ‰
        if (detailsPageHTML.trim() !== '' && detailsPageHTML.length > 100) {
            const detailsPageDiv = document.createElement('div');
            detailsPageDiv.innerHTML = detailsPageHTML;
            detailsPageDiv.style.position = 'absolute';
            detailsPageDiv.style.left = '-9999px';
            detailsPageDiv.style.top = '0';
            detailsPageDiv.style.width = '297mm';
            detailsPageDiv.style.height = 'auto';
            detailsPageDiv.style.background = 'white';
            detailsPageDiv.style.fontFamily = 'Arial, sans-serif';
            detailsPageDiv.style.fontSize = '11px';
            detailsPageDiv.style.lineHeight = '1.4';
            detailsPageDiv.style.direction = 'rtl';
            detailsPageDiv.style.color = '#333';
            detailsPageDiv.style.boxSizing = 'border-box';
            document.body.appendChild(detailsPageDiv);

            // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            await new Promise(resolve => setTimeout(resolve, 500));

            // ØªØ­ÙˆÙŠÙ„ ØµÙØ­Ø§Øª Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
            const detailsPageCanvas = await html2canvas(detailsPageDiv, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: detailsPageDiv.scrollWidth,
                height: detailsPageDiv.scrollHeight,
                logging: false
            });

            // Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø§Øª Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Landscape)
            const detailsImgData = detailsPageCanvas.toDataURL('image/png');
            const detailsImgWidth = 297; // A4 Landscape width
            const detailsPageHeight = 210; // A4 Landscape height
            const detailsImgHeight = (detailsPageCanvas.height * detailsImgWidth) / detailsPageCanvas.width;

            let heightLeft = detailsImgHeight;
            let position = 0;

            // Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨ÙˆØ¶Ø¹ Landscape (Ù…Ù†ÙØµÙ„Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø£ÙˆÙ„Ù‰)
            doc.addPage('a4', 'l'); // 'l' for landscape

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            doc.addImage(detailsImgData, 'PNG', 0, 0, detailsImgWidth, Math.min(detailsImgHeight, detailsPageHeight));
            heightLeft -= detailsPageHeight;

            // Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            while (heightLeft > 0) {
                position = heightLeft - detailsImgHeight;
                doc.addPage('a4', 'l');
                doc.addImage(detailsImgData, 'PNG', 0, position, detailsImgWidth, Math.min(detailsImgHeight, detailsPageHeight));
                heightLeft -= detailsPageHeight;
            }

            // ØªÙ†Ø¸ÙŠÙ ØµÙØ­Ø§Øª Ø§Ù„ØªÙØ§ØµÙŠÙ„
            document.body.removeChild(detailsPageDiv);
        }

        // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
        const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª_Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª_${selectedCity}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);

        // ØªÙ†Ø¸ÙŠÙ
        document.body.removeChild(loadingMessage);
        closeModal();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ø¨Ù†Ø¬Ø§Ø­! âœ…\n\nØ§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${fileName}\n\nğŸ“„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙƒÙˆÙƒ (Ø¹Ù…ÙˆØ¯ÙŠ)\nğŸ“Š Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (Ø£ÙÙ‚ÙŠ)\n\nğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø±:\nğŸ“ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±\nğŸ“ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„ÙØªØ­ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·`);

    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ø§Ù„Ù…Ø®ØªÙ„Ø·:', error);
        document.body.removeChild(loadingMessage);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

function showStatusFilterFromDropdown() {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
    try {
        showStatusFilter();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©:', error);
        // Ø¥Ù†Ø´Ø§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙƒØ¨Ø¯ÙŠÙ„
        const filterContainer = document.getElementById('headerFilters');
        if (filterContainer) {
            filterContainer.innerHTML = `
                <div class="status-filter-container">
                    <select id="statusFilter" onchange="setStatusFilter(this.value === '' ? null : this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                        <option value="ÙØ¹Ø§Ù„">ÙØ¹Ø§Ù„</option>
                        <option value="Ù…Ù†ØªÙ‡Ù‰">Ù…Ù†ØªÙ‡Ù‰</option>
                        <option value="Ø¹Ù„Ù‰ ÙˆØ´Ùƒ">Ø¹Ù„Ù‰ ÙˆØ´Ùƒ</option>
                        <option value="ÙØ§Ø±Øº">ÙØ§Ø±Øº</option>
                    </select>
                </div>
            `;
        }
    }
}

function showAttachmentsManagerFromDropdown() {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const originalFunction = window.showAttachmentsManager;
    if (originalFunction && typeof originalFunction === 'function') {
        originalFunction();
    } else {
        const oldBtn = document.getElementById('attachmentsManagerBtn');
        if (oldBtn) {
            oldBtn.click();
        }
    }
}

function switchToTableView() {
    // ØªØ´ØºÙŠÙ„ Ù†ÙØ³ ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø¬Ø¯ÙˆÙ„
    if (typeof toggleView === 'function') {
        toggleView('table');
    }
}

function switchToCardView() {
    // ØªØ´ØºÙŠÙ„ Ù†ÙØ³ ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    if (typeof toggleView === 'function') {
        toggleView('cards');
    }
}

function showPropertyManagerFromDropdown() {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const originalFunction = window.showPropertyManager;
    if (originalFunction && typeof originalFunction === 'function') {
        originalFunction();
    } else {
        const oldBtn = document.getElementById('propertyManagerBtn');
        if (oldBtn) {
            oldBtn.click();
        }
    }
}

function updateDateSettings() {
    // ØªØ´ØºÙŠÙ„ Ù†ÙØ³ ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    if (typeof showDateUpdateModal === 'function') {
        showDateUpdateModal();
    } else {
        const oldBtn = document.getElementById('updateDatesBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function cleanStorage() {
    // ØªØ´ØºÙŠÙ„ Ù†ÙØ³ ÙˆØ¸ÙŠÙØ© ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ†
    if (typeof showStorageCleanupModal === 'function') {
        showStorageCleanupModal();
    } else {
        const oldBtn = document.getElementById('cleanStorageBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function importData() {
    // ØªØ´ØºÙŠÙ„ Ù†ÙØ³ ÙˆØ¸ÙŠÙØ© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (typeof showDataImportModal === 'function') {
        showDataImportModal();
    } else {
        const oldBtn = document.getElementById('dataImportBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function saveAllData() {
    // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
    try {
        if (typeof saveDataLocally === 'function') {
            saveDataLocally();
        } else {
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage
            localStorage.setItem('properties', JSON.stringify(properties));
            localStorage.setItem('attachments', JSON.stringify(attachments));
            localStorage.setItem('cardAttachments', JSON.stringify(cardAttachments));
        }
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­!');
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

function repairAllData() {
    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª.')) {
        try {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
            if (typeof recalculateAllTotals === 'function') {
                recalculateAllTotals();
            }

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            saveAllData();

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            if (typeof initializeApp === 'function') {
                initializeApp();
            }

            alert('âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        }
    }
}

function updateSupabaseData() {
    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Supabase
    if (typeof updateAllSupabaseData === 'function') {
        updateAllSupabaseData();
    } else if (typeof syncToSupabase === 'function') {
        syncToSupabase();
    } else {
        alert('âš ï¸ ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹');
    }
}

// ==================== ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ====================

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
let updateTotalsData = null;
let updateTotalsPreview = [];

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
function showUpdateTotalsModal() {
    const modalHtml = `
        <div class="update-totals-modal" id="updateTotalsModal">
            <div class="update-totals-content">
                <div class="update-totals-header">
                    <h2 class="update-totals-title">
                        <i class="fas fa-calculator"></i>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
                    </h2>
                    <button class="update-totals-close" onclick="closeUpdateTotalsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="totals-upload-zone" onclick="document.getElementById('totalsFileInput').click()">
                    <div class="totals-upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="totals-upload-text">
                        Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
                    </div>
                    <div class="totals-upload-hint">
                        ÙŠØ¯Ø¹Ù…: JSON, Excel (.xlsx, .xls), CSV<br>
                        <small style="color: #6c757d; font-size: 0.8rem;">
                            Ù…Ø«Ø§Ù„ JSON: [{"Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©": 101, "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ": 50000}]<br>
                            Ù…Ø«Ø§Ù„ CSV: Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ<br>101,50000
                        </small>
                    </div>
                    <input type="file" id="totalsFileInput" class="totals-file-input"
                           accept=".json,.xlsx,.xls,.csv" onchange="handleTotalsFileUpload(this.files[0])">
                </div>

                <div class="totals-preview" id="totalsPreview">
                    <div class="totals-preview-header">
                        <h4>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                        <span id="totalsPreviewCount"></span>
                    </div>
                    <div class="totals-preview-content">
                        <table class="totals-preview-table" id="totalsPreviewTable">
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="totalsPreviewBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="totals-actions">
                    <div>
                        <button class="totals-btn totals-btn-secondary" onclick="closeUpdateTotalsModal()">
                            <i class="fas fa-times"></i>
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                    <div>
                        <button class="totals-btn totals-btn-success" id="applyTotalsBtn"
                                onclick="applyTotalsUpdate()" disabled>
                            <i class="fas fa-check"></i>
                            ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±
    setTimeout(() => {
        document.getElementById('updateTotalsModal').classList.add('show');
    }, 100);

    // Ø¥Ø¹Ø¯Ø§Ø¯ drag & drop
    setupTotalsDragAndDrop();
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
function closeUpdateTotalsModal() {
    const modal = document.getElementById('updateTotalsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
            updateTotalsData = null;
            updateTotalsPreview = [];
        }, 300);
    }
}

// Ø¥Ø¹Ø¯Ø§Ø¯ drag & drop Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
function setupTotalsDragAndDrop() {
    const uploadZone = document.querySelector('.totals-upload-zone');
    if (!uploadZone) return;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        uploadZone.classList.add('dragover');
    }

    function unhighlight() {
        uploadZone.classList.remove('dragover');
    }

    uploadZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            handleTotalsFileUpload(files[0]);
        }
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ù…Ù„Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
async function handleTotalsFileUpload(file) {
    if (!file) return;

    console.log('ğŸ“ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª:', file.name);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    const allowedTypes = [
        'application/json',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel',
        'text/csv'
    ];

    const fileExtension = file.name.split('.').pop().toLowerCase();
    const allowedExtensions = ['json', 'xlsx', 'xls', 'csv'];

    if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
        alert('âŒ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù JSON Ø£Ùˆ Excel Ø£Ùˆ CSV');
        return;
    }

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const uploadZone = document.querySelector('.totals-upload-zone');
        uploadZone.innerHTML = `
            <div class="totals-upload-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="totals-upload-text">
                Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...
            </div>
        `;

        let data = null;

        if (fileExtension === 'json') {
            data = await parseJSONFile(file);
        } else if (fileExtension === 'csv') {
            data = await parseCSVFile(file);
        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
            data = await parseExcelFile(file);
        }

        if (data && data.length > 0) {
            updateTotalsData = data;
            await generateTotalsPreview(data);

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹
            uploadZone.innerHTML = `
                <div class="totals-upload-icon">
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                </div>
                <div class="totals-upload-text" style="color: #28a745;">
                    ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­
                </div>
                <div class="totals-upload-hint">
                    ${data.length} Ø¹Ù†ØµØ± ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡
                </div>
            `;
        } else {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹
        const uploadZone = document.querySelector('.totals-upload-zone');
        uploadZone.innerHTML = `
            <div class="totals-upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="totals-upload-text">
                Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
            </div>
            <div class="totals-upload-hint">
                ÙŠØ¯Ø¹Ù…: JSON, Excel (.xlsx, .xls), CSV
            </div>
        `;
    }
}

// ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù JSON
async function parseJSONFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (Array.isArray(data)) {
                    resolve(data);
                } else if (data && typeof data === 'object') {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒØ§Ø¦Ù†ØŒ Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ØµÙÙˆÙØ©
                    const keys = Object.keys(data);
                    const arrayKey = keys.find(key => Array.isArray(data[key]));
                    if (arrayKey) {
                        resolve(data[arrayKey]);
                    } else {
                        resolve([data]);
                    }
                } else {
                    reject(new Error('ØµÙŠØºØ© Ù…Ù„Ù JSON ØºÙŠØ± ØµØ­ÙŠØ­Ø©'));
                }
            } catch (error) {
                reject(new Error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù JSON: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        reader.readAsText(file);
    });
}

// ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù CSV
async function parseCSVFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    reject(new Error('Ù…Ù„Ù CSV ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø£Ø³ ÙˆØ¨ÙŠØ§Ù†Ø§Øª'));
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};

                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });

                    data.push(row);
                }

                resolve(data);
            } catch (error) {
                reject(new Error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù CSV: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        reader.readAsText(file);
    });
}

// ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Excel (ÙŠØªØ·Ù„Ø¨ Ù…ÙƒØªØ¨Ø© Ø®Ø§Ø±Ø¬ÙŠØ© Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ CSV)
async function parseExcelFile(file) {
    // Ù„Ù„Ø¨Ø³Ø§Ø·Ø©ØŒ Ø³Ù†Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­ÙˆÙŠÙ„ Excel Ø¥Ù„Ù‰ CSV
    // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Ù…Ø«Ù„ SheetJS
    console.log('ğŸ“Š Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Excel:', file.name);
    throw new Error('ÙŠØ±Ø¬Ù‰ ØªØ­ÙˆÙŠÙ„ Ù…Ù„Ù Excel Ø¥Ù„Ù‰ CSV Ø£Ùˆ JSON Ø£ÙˆÙ„Ø§Ù‹');
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function generateTotalsPreview(data) {
    console.log('ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', data.length, 'Ø¹Ù†ØµØ±');

    updateTotalsPreview = [];
    const previewBody = document.getElementById('totalsPreviewBody');
    const previewCount = document.getElementById('totalsPreviewCount');
    const applyBtn = document.getElementById('applyTotalsBtn');

    if (!previewBody) return;

    previewBody.innerHTML = '';

    let validUpdates = 0;
    let newProperties = 0;
    let errors = 0;

    for (const item of data) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
        const unitNumberKeys = ['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©', 'unit_number', 'unitNumber', 'Ø±Ù‚Ù…_Ø§Ù„ÙˆØ­Ø¯Ø©', 'Unit Number'];
        const totalKeys = ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'total', 'Total', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'amount', 'Amount'];

        let unitNumber = null;
        let newTotal = null;

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
        for (const key of unitNumberKeys) {
            if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù†ØµÙˆØµ
                if (typeof item[key] === 'number') {
                    unitNumber = item[key].toString();
                } else {
                    unitNumber = item[key].toString().trim();
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© ØµØ§Ù„Ø­Ø©
                if (unitNumber && unitNumber !== 'undefined' && unitNumber !== 'null') {
                    break;
                } else {
                    unitNumber = null;
                }
            }
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        for (const key of totalKeys) {
            if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ JSON ÙˆØ§Ù„Ù†ØµÙˆØµ
                if (typeof item[key] === 'number') {
                    newTotal = item[key];
                } else {
                    newTotal = parseFloat(item[key].toString().replace(/[^\d.-]/g, ''));
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù…
                if (!isNaN(newTotal) && newTotal > 0) {
                    break;
                } else {
                    newTotal = null;
                }
            }
        }

        if (!unitNumber || isNaN(newTotal)) {
            console.warn('âš ï¸ ØªØ®Ø·ÙŠ Ø¹Ù†ØµØ± ØºÙŠØ± ØµØ§Ù„Ø­:', {
                unitNumber,
                newTotal,
                originalItem: item
            });
            errors++;
            continue;
        }

        console.log('âœ… Ø¹Ù†ØµØ± ØµØ§Ù„Ø­:', {
            unitNumber,
            newTotal,
            type: typeof newTotal
        });

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… (Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ø§ Ø§Ù„ØµÙŠØºØªÙŠÙ† Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©)
        const existingProperty = properties.find(p =>
            (p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] && p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'].toString().trim() === unitNumber) ||
            (p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] && p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toString().trim() === unitNumber)
        );

        let currentTotal = 0;
        let status = '';
        let statusClass = '';

        if (existingProperty) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const smartTotal = calculateSmartTotal(existingProperty);
            currentTotal = smartTotal.amount;

            if (currentTotal === newTotal) {
                status = 'Ù„Ø§ ØªØºÙŠÙŠØ±';
                statusClass = 'text-muted';
            } else {
                status = 'ØªØ­Ø¯ÙŠØ«';
                statusClass = 'text-primary';
                validUpdates++;
            }
        } else {
            status = 'Ø¬Ø¯ÙŠØ¯';
            statusClass = 'text-success';
            newProperties++;
        }

        updateTotalsPreview.push({
            unitNumber,
            newTotal,
            currentTotal,
            status,
            statusClass,
            existingProperty
        });

        // Ø¥Ø¶Ø§ÙØ© ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${unitNumber}</td>
            <td>${newTotal.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td>
            <td>${currentTotal.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td>
            <td class="${statusClass}">${status}</td>
        `;
        previewBody.appendChild(row);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    previewCount.textContent = `${data.length} Ø¹Ù†ØµØ± | ${validUpdates} ØªØ­Ø¯ÙŠØ« | ${newProperties} Ø¬Ø¯ÙŠØ¯ | ${errors} Ø®Ø·Ø£`;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    document.getElementById('totalsPreview').classList.add('show');

    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠØ«Ø§Øª ØµØ§Ù„Ø­Ø©
    if (validUpdates > 0 || newProperties > 0) {
        applyBtn.disabled = false;
        applyBtn.innerHTML = `
            <i class="fas fa-check"></i>
            ØªØ·Ø¨ÙŠÙ‚ ${validUpdates + newProperties} ØªØ­Ø¯ÙŠØ«
        `;
    } else {
        applyBtn.disabled = true;
        applyBtn.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        `;
    }
}

// ØªØ·Ø¨ÙŠÙ‚ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
async function applyTotalsUpdate() {
    if (!updateTotalsPreview || updateTotalsPreview.length === 0) {
        alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ·Ø¨ÙŠÙ‚');
        return;
    }

    // ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const validUpdates = updateTotalsPreview.filter(item =>
        item.status === 'ØªØ­Ø¯ÙŠØ«' || item.status === 'Ø¬Ø¯ÙŠØ¯'
    ).length;

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ ${validUpdates} ØªØ­Ø¯ÙŠØ«ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©.`)) {
        return;
    }

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const applyBtn = document.getElementById('applyTotalsBtn');
        const originalText = applyBtn.innerHTML;
        applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...';
        applyBtn.disabled = true;

        let updatedCount = 0;
        let addedCount = 0;
        let errors = [];

        for (const item of updateTotalsPreview) {
            if (item.status === 'Ù„Ø§ ØªØºÙŠÙŠØ±') continue;

            try {
                if (item.existingProperty) {
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ù‚Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯
                    await updatePropertyTotal(item.existingProperty, item.newTotal);
                    updatedCount++;
                } else {
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
                    console.log('âš ï¸ ØªØ®Ø·ÙŠ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯ - ÙŠØªØ·Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:', item.unitNumber);
                    // addedCount++;
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±:', item.unitNumber, error);
                errors.push(`${item.unitNumber}: ${error.message}`);
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ Supabase
        autoSyncAfterEdit('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        renderData();
        updateTotalStats();

        // Ø¥Ø¸Ù‡Ø§Ø± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        let message = `âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\n\n`;
        message += `ğŸ“Š Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©: ${updatedCount}\n`;
        if (addedCount > 0) message += `â• Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©: ${addedCount}\n`;
        if (errors.length > 0) {
            message += `\nâš ï¸ Ø£Ø®Ø·Ø§Ø¡ (${errors.length}):\n${errors.slice(0, 3).join('\n')}`;
            if (errors.length > 3) message += `\n... Ùˆ ${errors.length - 3} Ø£Ø®Ø·Ø§Ø¡ Ø£Ø®Ø±Ù‰`;
        }

        alert(message);

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeUpdateTotalsModal();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø±
        const applyBtn = document.getElementById('applyTotalsBtn');
        if (applyBtn) {
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
        }
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯
async function updatePropertyTotal(property, newTotal) {
    const unitNumber = property['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] || property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±:', unitNumber, 'Ø¥Ù„Ù‰', newTotal);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© (Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ø§ Ø§Ù„ØµÙŠØºØªÙŠÙ† Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©)
    const propertyIndex = properties.findIndex(p =>
        (p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] && p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'].toString().trim() === unitNumber.toString().trim()) ||
        (p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] && p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '].toString().trim() === unitNumber.toString().trim())
    );

    if (propertyIndex === -1) {
        throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø°ÙƒÙŠØ©
    // Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø­Ù‚Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ†Ø­Ø¯Ø«Ù‡
    const totalFields = [
        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
        'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº',
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
        'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯',
        'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯'
    ];

    let updated = false;

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙˆØªØ­Ø¯ÙŠØ«Ù‡
    for (const field of totalFields) {
        if (properties[propertyIndex][field] !== undefined) {
            properties[propertyIndex][field] = newTotal;
            updated = true;
            console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${field} Ø¥Ù„Ù‰ ${newTotal}`);
            break;
        }
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ Ø£Ø¶Ù ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
    if (!updated) {
        properties[propertyIndex]['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'] = newTotal;
        console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newTotal}`);
    }

    // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„
    properties[propertyIndex]['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');

    return true;
}

// ==================== Ù†Ø¸Ø§Ù… Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ====================

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
let transferSourceCity = null;
let transferSourceProperty = null;
let transferSelectedUnits = [];
let transferDestinationProperty = null;

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function showUnitTransferModal() {
    const modalHtml = `
        <div class="unit-transfer-modal" id="unitTransferModal">
            <div class="unit-transfer-content">
                <div class="unit-transfer-header">
                    <h2 class="unit-transfer-title">
                        <i class="fas fa-exchange-alt"></i>
                        Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                    </h2>
                    <button class="unit-transfer-close" onclick="closeUnitTransferModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØµØ¯Ø± -->
                <div class="transfer-section" id="sourceSection">
                    <h3 class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø±
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                            <select id="sourceCitySelect" onchange="loadSourceProperties(this.value)">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                            <select id="sourcePropertySelect" onchange="loadSourceUnits(this.value)" disabled>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª -->
                    <div class="units-table-container" id="sourceUnitsContainer" style="display: none;">
                        <h4>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</h4>
                        <div class="units-table-wrapper">
                            <table class="units-table" id="sourceUnitsTable">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllUnits" onchange="toggleAllUnits(this.checked)">
                                        </th>
                                        <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="sourceUnitsBody">
                                </tbody>
                            </table>
                        </div>

                        <div class="transfer-actions">
                            <button class="transfer-btn transfer-btn-primary" onclick="showDestinationSection()" disabled id="proceedBtn">
                                <i class="fas fa-arrow-left"></i>
                                Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø©
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø© -->
                <div class="transfer-section" id="destinationSection" style="display: none;">
                    <h3 class="section-title">
                        <i class="fas fa-bullseye"></i>
                        Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø©
                    </h3>

                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø© (ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©):</label>
                        <select id="destinationPropertySelect" onchange="setDestinationProperty(this.value)">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø©</option>
                        </select>
                    </div>

                    <div class="transfer-summary" id="transferSummary" style="display: none;">
                        <h4>Ù…Ù„Ø®Øµ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ù„:</h4>
                        <div class="summary-content">
                            <p><strong>Ù…Ù†:</strong> <span id="summarySource"></span></p>
                            <p><strong>Ø¥Ù„Ù‰:</strong> <span id="summaryDestination"></span></p>
                            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</strong> <span id="summaryCount"></span></p>
                        </div>
                    </div>

                    <div class="transfer-actions">
                        <button class="transfer-btn transfer-btn-secondary" onclick="backToSourceSection()">
                            <i class="fas fa-arrow-right"></i>
                            Ø§Ù„Ø¹ÙˆØ¯Ø©
                        </button>
                        <button class="transfer-btn transfer-btn-success" onclick="confirmUnitTransfer()" disabled id="confirmTransferBtn">
                            <i class="fas fa-check"></i>
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±
    setTimeout(() => {
        document.getElementById('unitTransferModal').classList.add('show');
    }, 100);

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ù†
    loadTransferCities();
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function closeUnitTransferModal() {
    const modal = document.getElementById('unitTransferModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            transferSourceCity = null;
            transferSourceProperty = null;
            transferSelectedUnits = [];
            transferDestinationProperty = null;
        }, 300);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ù† ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ¯Ø±
function loadTransferCities() {
    const citySelect = document.getElementById('sourceCitySelect');
    if (!citySelect) return;

    const cities = getUniqueCountries();
    citySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>';

    cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
function loadSourceProperties(cityName) {
    const propertySelect = document.getElementById('sourcePropertySelect');
    const unitsContainer = document.getElementById('sourceUnitsContainer');

    if (!cityName) {
        propertySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±</option>';
        propertySelect.disabled = true;
        unitsContainer.style.display = 'none';
        return;
    }

    transferSourceCity = cityName;

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    const cityProperties = properties.filter(p => p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === cityName);
    const uniqueProperties = [...new Set(cityProperties.map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']))];

    propertySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±</option>';
    uniqueProperties.forEach(propertyName => {
        const option = document.createElement('option');
        option.value = propertyName;
        option.textContent = propertyName;
        propertySelect.appendChild(option);
    });

    propertySelect.disabled = false;
    unitsContainer.style.display = 'none';
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±
function loadSourceUnits(propertyName) {
    const unitsContainer = document.getElementById('sourceUnitsContainer');
    const unitsBody = document.getElementById('sourceUnitsBody');

    if (!propertyName) {
        unitsContainer.style.display = 'none';
        return;
    }

    transferSourceProperty = propertyName;

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
    const propertyUnits = properties.filter(p =>
        p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === transferSourceCity && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
    );

    unitsBody.innerHTML = '';
    transferSelectedUnits = [];

    propertyUnits.forEach(unit => {
        const status = calculateStatus(unit);
        const unitNumber = unit['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] || unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" value="${unitNumber}"
                       onchange="toggleUnitSelection(this, '${unitNumber}')">
            </td>
            <td>${unitNumber}</td>
            <td>${unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}</td>
            <td>${unit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
            <td>
                <span class="status-badge status-${status.final.replace(' ', '-')}">${status.final}</span>
            </td>
        `;
        unitsBody.appendChild(row);
    });

    unitsContainer.style.display = 'block';
    updateProceedButton();
}

// ØªØ¨Ø¯ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø©
function toggleUnitSelection(checkbox, unitNumber) {
    if (checkbox.checked) {
        if (!transferSelectedUnits.includes(unitNumber)) {
            transferSelectedUnits.push(unitNumber);
        }
    } else {
        transferSelectedUnits = transferSelectedUnits.filter(u => u !== unitNumber);
    }

    updateProceedButton();
    updateSelectAllCheckbox();
}

// ØªØ¨Ø¯ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function toggleAllUnits(checked) {
    const checkboxes = document.querySelectorAll('#sourceUnitsBody input[type="checkbox"]');
    transferSelectedUnits = [];

    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
        if (checked) {
            transferSelectedUnits.push(checkbox.value);
        }
    });

    updateProceedButton();
}

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© checkbox "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllUnits');
    const unitCheckboxes = document.querySelectorAll('#sourceUnitsBody input[type="checkbox"]');
    const checkedBoxes = document.querySelectorAll('#sourceUnitsBody input[type="checkbox"]:checked');

    if (checkedBoxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length === unitCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
function updateProceedButton() {
    const proceedBtn = document.getElementById('proceedBtn');
    if (proceedBtn) {
        proceedBtn.disabled = transferSelectedUnits.length === 0;
        proceedBtn.innerHTML = `
            <i class="fas fa-arrow-left"></i>
            Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø© (${transferSelectedUnits.length} ÙˆØ­Ø¯Ø©)
        `;
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø©
function showDestinationSection() {
    if (transferSelectedUnits.length === 0) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
    }

    // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ÙˆØ¬Ù‡Ø©
    document.getElementById('sourceSection').style.display = 'none';
    document.getElementById('destinationSection').style.display = 'block';

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø±)
    loadDestinationProperties();
}

// ØªØ­Ù…ÙŠÙ„ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ¬Ù‡Ø©
function loadDestinationProperties() {
    const destinationSelect = document.getElementById('destinationPropertySelect');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø±
    const cityProperties = properties.filter(p => p.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === transferSourceCity);
    const uniqueProperties = [...new Set(cityProperties.map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']))]
        .filter(name => name !== transferSourceProperty);

    destinationSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø©</option>';
    uniqueProperties.forEach(propertyName => {
        const option = document.createElement('option');
        option.value = propertyName;
        option.textContent = propertyName;
        destinationSelect.appendChild(option);
    });
}

// ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø©
function setDestinationProperty(propertyName) {
    transferDestinationProperty = propertyName;

    const summaryDiv = document.getElementById('transferSummary');
    const confirmBtn = document.getElementById('confirmTransferBtn');

    if (propertyName) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        document.getElementById('summarySource').textContent =
            `${transferSourceProperty} (${transferSourceCity})`;
        document.getElementById('summaryDestination').textContent =
            `${propertyName} (${transferSourceCity})`;
        document.getElementById('summaryCount').textContent = transferSelectedUnits.length;

        summaryDiv.style.display = 'block';
        confirmBtn.disabled = false;
    } else {
        summaryDiv.style.display = 'none';
        confirmBtn.disabled = true;
    }
}

// Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø±
function backToSourceSection() {
    document.getElementById('destinationSection').style.display = 'none';
    document.getElementById('sourceSection').style.display = 'block';
}

// ØªØ£ÙƒÙŠØ¯ Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
async function confirmUnitTransfer() {
    if (!transferDestinationProperty || transferSelectedUnits.length === 0) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø© ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ù†Ù‚Ù„Ù‡Ø§');
        return;
    }

    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ù‚Ù„ ${transferSelectedUnits.length} ÙˆØ­Ø¯Ø© Ù…Ù† "${transferSourceProperty}" Ø¥Ù„Ù‰ "${transferDestinationProperty}"ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
        let supabaseAvailable = false;
        if (typeof checkSupabaseAvailability === 'function') {
            try {
                supabaseAvailable = await checkSupabaseAvailability();
                if (!supabaseAvailable) {
                    console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·');

                    // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    const proceedWithoutCloud = confirm(
                        'âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.\n\n' +
                        'Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· ÙˆÙ‚Ø¯ ØªÙÙ‚Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.\n\n' +
                        'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'
                    );

                    if (!proceedWithoutCloud) {
                        return; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    }
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Supabase:', error);
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const confirmBtn = document.getElementById('confirmTransferBtn');
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ù‚Ù„...';
        confirmBtn.disabled = true;

        let transferredCount = 0;
        let supabaseSuccessCount = 0;
        let errors = [];

        // Ù†Ù‚Ù„ ÙƒÙ„ ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©
        for (const unitNumber of transferSelectedUnits) {
            try {
                const result = await transferSingleUnit(unitNumber, transferSourceProperty, transferDestinationProperty);
                if (result.success) {
                    transferredCount++;
                    if (result.supabaseSuccess) {
                        supabaseSuccessCount++;
                    }
                }
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
                errors.push(`${unitNumber}: ${error.message}`);
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø¹ Supabase Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ÙØ¸
        if (supabaseSuccessCount < transferredCount) {
            console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...');

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase
            for (const unitNumber of transferSelectedUnits) {
                const unit = properties.find(p =>
                    (p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] === unitNumber || p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber) &&
                    p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === transferDestinationProperty
                );

                if (unit && typeof savePropertyToSupabase === 'function') {
                    try {
                        await savePropertyToSupabase(unit);
                        console.log(`âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù†Ø§Ø¬Ø­Ø© Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
                    } catch (error) {
                        console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
                    }
                }
            }
        }

        // Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ Supabase
        autoSyncAfterEdit('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        renderData();
        updateTotalStats();

        // Ø¥Ø¸Ù‡Ø§Ø± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Øµ ÙˆØ§Ù„Ù†Ù‚Ù„
        let message = `âœ… ØªÙ… Ù‚Øµ ÙˆÙ†Ù‚Ù„ ${transferredCount} ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!\n\n`;
        message += `ğŸ“¤ Ù…Ù†: ${transferSourceProperty}\n`;
        message += `ğŸ“¥ Ø¥Ù„Ù‰: ${transferDestinationProperty}\n\n`;

        // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
        message += `â˜ï¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù‚Øµ ÙˆØ§Ù„Ù†Ù‚Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:\n`;
        message += `   â€¢ ØªÙ… Ù‚Øµ ÙˆÙ†Ù‚Ù„ ${supabaseSuccessCount} ÙˆØ­Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n`;

        // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let preservedDataCount = 0;
        let removedFromSourceCount = 0;
        transferSelectedUnits.forEach(unitNumber => {
            const unitInDestination = properties.find(p =>
                (p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] === unitNumber || p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber) &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === transferDestinationProperty
            );
            const unitInSource = properties.find(p =>
                (p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] === unitNumber || p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber) &&
                p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === transferSourceProperty
            );

            if (unitInDestination) preservedDataCount++;
            if (!unitInSource) removedFromSourceCount++;
        });

        message += `   â€¢ ØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª ${preservedDataCount} ÙˆØ­Ø¯Ø© (Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŒ Ø§Ù„Ø¹Ù‚Ø¯ØŒ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·)\n`;
        message += `   â€¢ ØªÙ… Ø­Ø°Ù ${removedFromSourceCount} ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø£ØµÙ„ÙŠ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹\n\n`;

        // ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù‚Øµ
        message += `âœ‚ï¸ ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù‚Øµ (ÙˆÙ„ÙŠØ³ Ø§Ù„Ù†Ø³Ø®):\n`;
        message += `   â€¢ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù… ØªØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ "${transferSourceProperty}"\n`;
        message += `   â€¢ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø§Ù„Ø¢Ù† ÙÙŠ "${transferDestinationProperty}" ÙÙ‚Ø·\n`;
        message += `   â€¢ Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø· Ù…Ø­ÙÙˆØ¸Ø©\n`;
        message += `   â€¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…\n`;

        if (supabaseSuccessCount < transferredCount) {
            const localOnlyCount = transferredCount - supabaseSuccessCount;
            message += `\nâš ï¸ ØªØ­Ø°ÙŠØ±: ${localOnlyCount} ÙˆØ­Ø¯Ø© ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· (Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„)\n`;
            message += `   â€¢ Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ© Ù„Ø§Ø­Ù‚Ø§Ù‹\n`;
        }

        if (errors.length > 0) {
            message += `\nâŒ Ø£Ø®Ø·Ø§Ø¡ (${errors.length}):\n${errors.slice(0, 3).join('\n')}`;
            if (errors.length > 3) message += `\n... Ùˆ ${errors.length - 3} Ø£Ø®Ø·Ø§Ø¡ Ø£Ø®Ø±Ù‰`;
        }

        alert(message);

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeUnitTransferModal();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ù„:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø±
        const confirmBtn = document.getElementById('confirmTransferBtn');
        if (confirmBtn) {
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        }
    }
}

// Ù†Ù‚Ù„ ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø©
async function transferSingleUnit(unitNumber, sourceProperty, destinationProperty) {
    console.log(`ğŸ”„ Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† ${sourceProperty} Ø¥Ù„Ù‰ ${destinationProperty}`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© (Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ø§ Ø§Ù„ØµÙŠØºØªÙŠÙ† Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©)
    const unitIndex = properties.findIndex(p =>
        (p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] === unitNumber || p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber) &&
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === sourceProperty
    );

    if (unitIndex === -1) {
        console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± ${sourceProperty}`);
        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„ÙˆØ­Ø¯Ø©:', unitNumber);

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
        const allUnitsWithSameNumber = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] === unitNumber || p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );
        console.log('ğŸ” Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø±Ù‚Ù…', unitNumber, ':', allUnitsWithSameNumber);

        throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± ${sourceProperty}`);
    }

    // Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
    const unit = { ...properties[unitIndex] };
    unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] = destinationProperty;
    unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
    unit['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = 'Ù†Ù‚Ù„ ÙˆØ­Ø¯Ø©';
    unit['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();

    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Supabase Ø£ÙˆÙ„Ø§Ù‹
    let supabaseSuccess = false;
    let deletionSuccess = false;

    if (typeof transferUnitInSupabase === 'function') {
        try {
            console.log(`ğŸ’¾ Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase Ù…Ù† "${sourceProperty}" Ø¥Ù„Ù‰ "${destinationProperty}"...`);

            // ğŸ”§ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Supabase
            if (typeof deleteUnitFromSupabaseCompletely === 'function') {
                console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† "${sourceProperty}"...`);
                const deleteResult = await deleteUnitFromSupabaseCompletely(unitNumber, sourceProperty);

                if (deleteResult.success && deleteResult.deletedCount > 0) {
                    deletionSuccess = true;
                    console.log(`âœ… ØªÙ… Ø­Ø°Ù ${deleteResult.deletedCount} Ø³Ø¬Ù„ Ø£ØµÙ„ÙŠ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Supabase`);
                } else {
                    console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø­Ø°Ù Ø£Ùˆ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù:`, deleteResult.reason);
                }
            }

            // ğŸ”§ Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            console.log(`ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± "${destinationProperty}"...`);
            if (typeof savePropertyToSupabase === 'function') {
                const saveResult = await savePropertyToSupabase(unit);

                if (saveResult && saveResult.success) {
                    supabaseSuccess = true;
                    console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ "${destinationProperty}" Ø¨Ù†Ø¬Ø§Ø­`);
                } else {
                    console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, saveResult?.message || 'Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
                }
            }

            // ğŸ”§ Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø©
            console.log(`ğŸ” ÙØ­Øµ ÙˆØ­Ø°Ù Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}...`);
            if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                try {
                    // ÙØ­Øµ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const { data: duplicateCheck } = await supabaseClient
                        .from('properties')
                        .select('id, created_at')
                        .eq('unit_number', unitNumber)
                        .eq('property_name', destinationProperty)
                        .order('created_at', { ascending: false });

                    if (duplicateCheck && duplicateCheck.length > 1) {
                        console.log(`ğŸ—‘ï¸ ÙˆÙØ¬Ø¯Øª ${duplicateCheck.length} Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø©ØŒ Ø­Ø°Ù ${duplicateCheck.length - 1} Ù…Ù†Ù‡Ø§...`);

                        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø« ÙˆØ­Ø°Ù Ø§Ù„Ø¨Ø§Ù‚ÙŠ
                        const recordsToDelete = duplicateCheck.slice(1);
                        for (const record of recordsToDelete) {
                            try {
                                await supabaseClient
                                    .from('properties')
                                    .delete()
                                    .eq('id', record.id);
                                console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙƒØ±Ø±: ${record.id}`);
                            } catch (deleteError) {
                                console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙƒØ±Ø± ${record.id}:`, deleteError);
                            }
                        }
                    }
                } catch (duplicateError) {
                    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©:`, duplicateError);
                }
            }
        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Supabase:`, error);

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©
            console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø®Ø·Ø£...`);
            if (typeof savePropertyToSupabase === 'function') {
                try {
                    const result = await savePropertyToSupabase(unit);
                    if (result && result.success) {
                        supabaseSuccess = true;
                        console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø®Ø·Ø£`);
                    }
                } catch (fallbackError) {
                    console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹:`, fallbackError);
                }
            }
        }
    }

    // Ø¥Ø°Ø§ ÙØ´Ù„ Ø­ÙØ¸ SupabaseØŒ Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± ÙˆÙ„ÙƒÙ† Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹
    if (!supabaseSuccess) {
        console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ SupabaseØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·`);
    }

    // ğŸ”§ Ø¥ØµÙ„Ø§Ø­: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù‚Øµ ÙˆÙ„ÙŠØ³ Ù†Ø³Ø®)
    // Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ù…ÙˆÙ‚Ø¹Ù‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠ
    properties.splice(unitIndex, 1);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ù…ÙˆÙ‚Ø¹Ù‡Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    properties.push(unit);

    // ğŸ”§ Ø¥Ø¶Ø§ÙØ©: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø³Ø® Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    const duplicateUnits = properties.filter((p, index) =>
        (p['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] === unitNumber || p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber) &&
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === sourceProperty
    );

    if (duplicateUnits.length > 0) {
        console.log(`ğŸ—‘ï¸ Ø­Ø°Ù ${duplicateUnits.length} Ù†Ø³Ø®Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø£ØµÙ„ÙŠ "${sourceProperty}"`);
        duplicateUnits.forEach(duplicateUnit => {
            const duplicateIndex = properties.findIndex(p =>
                p === duplicateUnit
            );
            if (duplicateIndex !== -1) {
                properties.splice(duplicateIndex, 1);
                console.log(`âœ… ØªÙ… Ø­Ø°Ù Ù†Ø³Ø®Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ø§Ù„ÙÙ‡Ø±Ø³ ${duplicateIndex}`);
            }
        });
    }

    console.log(`ğŸ“Š ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„: Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…ÙˆØ¬ÙˆØ¯Ø© Ø§Ù„Ø¢Ù† ÙÙŠ "${destinationProperty}" ÙÙ‚Ø·`);

    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©
    try {
        await addChangeLog(
            OPERATION_TYPES.TRANSFER_UNIT,
            unit,
            {},
            {
                sourceProperty: sourceProperty,
                destinationProperty: destinationProperty,
                reason: 'Ù†Ù‚Ù„ ÙˆØ­Ø¯Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª'
            }
        );
        console.log('ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©:', error);
    }

    console.log(`âœ… ØªÙ… Ù‚Øµ ÙˆÙ†Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
    return {
        success: true,
        supabaseSuccess,
        deletionSuccess,
        dataPreserved: true, // ğŸ”§ Ø¥Ø¶Ø§ÙØ©: ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        cutNotCopy: true, // ğŸ”§ Ø¥Ø¶Ø§ÙØ©: ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Øµ ÙˆÙ„ÙŠØ³ Ù†Ø³Ø®
        details: {
            unitNumber,
            sourceProperty,
            destinationProperty,
            savedToNewLocation: supabaseSuccess,
            deletedFromOldLocation: deletionSuccess,
            preservedAllData: true, // ğŸ”§ Ø¥Ø¶Ø§ÙØ©: ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            operationType: 'cut' // ğŸ”§ Ø¥Ø¶Ø§ÙØ©: Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        }
    };
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
function getCurrentUser() {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŒ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ø³Ù…Ù‡ Ø§Ù„ÙƒØ§Ù…Ù„
    if (typeof currentUser !== 'undefined' && currentUser && users[currentUser]) {
        return users[currentUser].fullName || currentUser;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ù…Ù† localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            if (users[userData.username]) {
                return users[userData.username].fullName || userData.username;
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        }
    }

    // Ø¥Ø±Ø¬Ø§Ø¹ "Ø§Ù„Ù†Ø¸Ø§Ù…" ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    return 'Ø§Ù„Ù†Ø¸Ø§Ù…';
}

// ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù…Ø± ÙÙ‚Ø·)
function canEditPropertyName() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    const savedUser = localStorage.getItem('currentUser');
    if (!savedUser) {
        return false;
    }

    try {
        const userData = JSON.parse(savedUser);
        const isOmar = userData.username === 'Ø¹Ù…Ø±' || currentUser === 'Ø¹Ù…Ø±';

        console.log(`ğŸ” ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… = ${userData.username}, Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© = ${isOmar ? 'Ù…Ø³Ù…ÙˆØ­' : 'Ù…Ù…Ù†ÙˆØ¹'}`);

        return isOmar;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        return false;
    }
}

// ğŸ”’ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙ„Ø§Ø­ÙŠØ©
function showNoPermissionMessage(action = 'Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©') {
    const message = `ğŸ”’ Ø¹Ø°Ø±Ø§Ù‹ØŒ ${action} Ù…ØªØ§Ø­Ø© Ù„Ø¹Ù…Ø± ÙÙ‚Ø·.\n\nÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¹Ù…Ø± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.`;
    alert(message);
    showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
}

// ğŸ›¡ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
function validateDataIntegrity() {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
        if (typeof window.properties === 'undefined') {
            console.warn('âš ï¸ Ù…ØªØºÙŠØ± properties ØºÙŠØ± Ù…Ø¹Ø±ÙØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
            loadDataFromStorage();
            return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† properties Ù…ØµÙÙˆÙØ©
        if (!Array.isArray(window.properties)) {
            console.error('âŒ properties Ù„ÙŠØ³ Ù…ØµÙÙˆÙØ©:', typeof window.properties);
            window.properties = [];
            return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
        let validCount = 0;
        let invalidCount = 0;

        window.properties.forEach((property, index) => {
            if (!property || typeof property !== 'object') {
                console.warn(`âš ï¸ Ø¹Ù†ØµØ± ØºÙŠØ± ØµØ§Ù„Ø­ ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ ${index}:`, property);
                invalidCount++;
            } else {
                validCount++;
            }
        });

        if (invalidCount > 0) {
            console.warn(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${invalidCount} Ø¹Ù†ØµØ± ØºÙŠØ± ØµØ§Ù„Ø­ Ù…Ù† Ø£ØµÙ„ ${window.properties.length}`);

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø©
            window.properties = window.properties.filter(p => p && typeof p === 'object');
            console.log(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµØ§Ù„Ø­Ø©: ${window.properties.length}`);
        }

        return true;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        return false;
    }
}

// ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
function loadDataFromStorage() {
    try {
        console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage...');

        const savedData = localStorage.getItem('propertyData');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            if (Array.isArray(parsedData)) {
                window.properties = parsedData;
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${parsedData.length} Ø¹Ù†ØµØ± Ù…Ù† localStorage`);
                return true;
            } else {
                console.warn('âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„ÙŠØ³Øª Ù…ØµÙÙˆÙØ©');
            }
        } else {
            console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ localStorage');
        }

        // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©
        window.properties = [];
        return false;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage:', error);
        window.properties = [];
        return false;
    }
}

// ğŸ¢ Ø¯Ø§Ù„Ø© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù…Ø± ÙÙ‚Ø·)
async function editPropertyName(currentPropertyName) {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        if (!canEditPropertyName()) {
            showNoPermissionMessage('ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!ensurePropertiesLoaded('editPropertyName')) {
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
        if (!validateDataIntegrity()) {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©');
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù‚Ø§Ø±
        const propertyUnits = properties.filter(p =>
            p &&
            typeof p === 'object' &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentPropertyName
        );

        if (propertyUnits.length === 0) {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯');
            return;
        }

        console.log(`ğŸ¢ Ø¨Ø¯Ø¡ ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: "${currentPropertyName}" (${propertyUnits.length} ÙˆØ­Ø¯Ø©)`);

        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content edit-property-name-modal">
                <div class="modal-header">
                    <h3>ğŸ¢ ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±</h3>
                    <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                        <input type="text" id="currentPropertyName" value="${currentPropertyName}" readonly class="readonly-input">
                    </div>

                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: <span class="required">*</span></label>
                        <input type="text" id="newPropertyName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯" maxlength="100" required>
                        <small class="form-hint">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø®ØªÙ„ÙØ§Ù‹ ÙˆØºÙŠØ± Ù…ÙƒØ±Ø±</small>
                    </div>

                    <div class="info-box">
                        <h4>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±:</h4>
                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</strong> ${propertyUnits.length} ÙˆØ­Ø¯Ø©</p>
                        <p><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${propertyUnits[0]['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        <p><strong>Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> ${propertyUnits[0]['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                    </div>

                    <div class="warning-box">
                        <h4>âš ï¸ ØªØ­Ø°ÙŠØ± Ù…Ù‡Ù…:</h4>
                        <ul>
                            <li>Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª (${propertyUnits.length} ÙˆØ­Ø¯Ø©)</li>
                            <li>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                            <li>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</li>
                            <li>ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸</li>
                        </ul>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button class="btn btn-primary" onclick="confirmPropertyNameEdit()">
                        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        setTimeout(() => {
            const newNameInput = document.getElementById('newPropertyName');
            if (newNameInput) {
                newNameInput.focus();
                newNameInput.select();
            }
        }, 100);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        document.getElementById('newPropertyName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmPropertyNameEdit();
            }
        });

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§Ø³Ù…
        document.getElementById('newPropertyName').addEventListener('input', function() {
            validateNewPropertyName();
        });

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±');
    }
}

// ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
function validateNewPropertyName() {
    const newNameInput = document.getElementById('newPropertyName');
    const currentNameInput = document.getElementById('currentPropertyName');
    const saveButton = document.querySelector('.edit-property-name-modal .btn-primary');

    if (!newNameInput || !currentNameInput || !saveButton) return;

    const newName = newNameInput.value.trim();
    const currentName = currentNameInput.value.trim();

    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    const existingError = newNameInput.parentNode.querySelector('.error-message');
    if (existingError) {
        existingError.remove();
    }

    newNameInput.classList.remove('error', 'success');

    let isValid = true;
    let errorMessage = '';

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹
    if (newName === '') {
        isValid = false;
        errorMessage = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯';
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    else if (newName === currentName) {
        isValid = false;
        errorMessage = 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø®ØªÙ„ÙØ§Ù‹ Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ';
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ù‚Ø§Ø± Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
    else if (properties.some(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === newName)) {
        isValid = false;
        errorMessage = 'ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø± Ø¢Ø®Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·ÙˆÙ„ Ø§Ù„Ø§Ø³Ù…
    else if (newName.length < 2) {
        isValid = false;
        errorMessage = 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ø·ÙˆÙ„ Ù…Ù† Ø­Ø±ÙÙŠÙ†';
    }
    else if (newName.length > 100) {
        isValid = false;
        errorMessage = 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 100 Ø­Ø±Ù)';
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù„Ù†Ø¬Ø§Ø­
    if (!isValid) {
        newNameInput.classList.add('error');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = errorMessage;
        newNameInput.parentNode.appendChild(errorDiv);
        saveButton.disabled = true;
    } else {
        newNameInput.classList.add('success');
        saveButton.disabled = false;
    }

    return isValid;
}

// âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØªÙ†ÙÙŠØ° ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
async function confirmPropertyNameEdit() {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!validateNewPropertyName()) {
            return;
        }

        const currentName = document.getElementById('currentPropertyName').value.trim();
        const newName = document.getElementById('newPropertyName').value.trim();

        // ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const confirmMessage = `ğŸ¢ ØªØ£ÙƒÙŠØ¯ ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±\n\n` +
            `Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: "${currentName}"\n` +
            `Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: "${newName}"\n\n` +
            `âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ØªØºÙŠÙŠØ± Ø³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±.\n` +
            `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;

        if (!confirm(confirmMessage)) {
            return;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const saveButton = document.querySelector('.edit-property-name-modal .btn-primary');
        const originalText = saveButton.textContent;
        saveButton.disabled = true;
        saveButton.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

        console.log(`ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† "${currentName}" Ø¥Ù„Ù‰ "${newName}"`);

        // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const result = await updatePropertyNameInAllSystems(currentName, newName);

        if (result.success) {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.querySelector('.modal-overlay').remove();

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            const successMessage = `ğŸ‰ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
                `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${result.updatedUnits} ÙˆØ­Ø¯Ø©\n` +
                `âœ… ØªÙ… Ø­ÙØ¸ ${result.supabaseUpdates} ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©\n` +
                `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹\n\n` +
                `Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: "${newName}"`;

            alert(successMessage);
            showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ù„Ù‰ "${newName}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            refreshCurrentView();

        } else {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            const errorMessage = `âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±\n\n` +
                `Ø§Ù„Ø³Ø¨Ø¨: ${result.reason}\n\n` +
                `ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.`;

            alert(errorMessage);
            showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ' + result.reason, 'error');

            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
            saveButton.disabled = false;
            saveButton.textContent = originalText;
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ£ÙƒÙŠØ¯ ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ' + error.message, 'error');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        const saveButton = document.querySelector('.edit-property-name-modal .btn-primary');
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
        }
    }
}

// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
async function updatePropertyNameInAllSystems(oldName, newName) {
    try {
        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©: "${oldName}" â†’ "${newName}"`);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!validateDataIntegrity()) {
            return { success: false, reason: 'Ø®Ø·Ø£ ÙÙŠ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' };
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
        const propertyUnits = properties.filter(p =>
            p &&
            typeof p === 'object' &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === oldName
        );

        if (propertyUnits.length === 0) {
            return { success: false, reason: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯' };
        }

        console.log(`ğŸ“‹ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${propertyUnits.length} ÙˆØ­Ø¯Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«`);

        let updatedUnits = 0;
        let supabaseUpdates = 0;
        let errors = [];

        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ ÙˆØ­Ø¯Ø©
        for (const unit of propertyUnits) {
            try {
                const unitIndex = properties.findIndex(p =>
                    p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] &&
                    p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === oldName
                );

                if (unitIndex !== -1) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
                    properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] = newName;

                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
                    properties[unitIndex]['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
                    properties[unitIndex]['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = 'ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±';
                    properties[unitIndex]['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();
                    properties[unitIndex]['Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù„Ø¹Ù‚Ø§Ø±'] = oldName;

                    updatedUnits++;
                    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ù…Ø­Ù„ÙŠØ§Ù‹`);

                    // Ø­ÙØ¸ ÙÙŠ Supabase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
                    if (typeof updatePropertyNameInSupabase === 'function') {
                        try {
                            const result = await updatePropertyNameInSupabase(oldName, newName, properties[unitIndex]);
                            if (result && result.success) {
                                supabaseUpdates++;
                                console.log(`â˜ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase: ${result.action}`);
                            } else {
                                console.warn(`âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase: ${result.reason}`);
                                errors.push(`Supabase: ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${result.reason}`);
                            }
                        } catch (supabaseError) {
                            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase:`, supabaseError);
                            errors.push(`Supabase: ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${supabaseError.message}`);
                        }
                    } else {
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙƒØ¨Ø¯ÙŠÙ„
                        if (typeof savePropertyToSupabase === 'function') {
                            try {
                                const result = await savePropertyToSupabase(properties[unitIndex]);
                                if (result && result.success) {
                                    supabaseUpdates++;
                                    console.log(`â˜ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)`);
                                } else {
                                    console.warn(`âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase`);
                                }
                            } catch (supabaseError) {
                                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase:`, supabaseError);
                                errors.push(`Supabase: ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${supabaseError.message}`);
                            }
                        }
                    }
                }

            } catch (unitError) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}:`, unitError);
                errors.push(`Unit: ${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${unitError.message}`);
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Supabase Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        if (supabaseUpdates > 0 && typeof cleanupDuplicatePropertiesForName === 'function') {
            try {
                console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±...');
                await cleanupDuplicatePropertiesForName(newName);
            } catch (cleanupError) {
                console.warn('âš ï¸ ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©:', cleanupError);
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹
        try {
            const trackingData = {
                operationType: 'ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±',
                unitNumber: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª',
                propertyName: newName,
                city: propertyUnits[0]['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                contractNumber: 'Ù…ØªØ¹Ø¯Ø¯',
                tenantName: 'Ù…ØªØ¹Ø¯Ø¯',
                changes: {
                    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…': oldName,
                    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯': newName,
                    'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©': updatedUnits,
                    'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©': supabaseUpdates
                },
                additionalInfo: {
                    totalUnits: propertyUnits.length,
                    updatedUnits,
                    supabaseUpdates,
                    errors: errors.length > 0 ? errors.slice(0, 5) : null
                },
                responsibleUser: getCurrentUser(),
                description: `ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† "${oldName}" Ø¥Ù„Ù‰ "${newName}" - ${updatedUnits} ÙˆØ­Ø¯Ø©`
            };

            await logActivity(trackingData);
            console.log('ğŸ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹');

        } catch (trackingError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:', trackingError);
        }

        // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ ØªÙƒØ±Ø§Ø± Ù…Ø­Ù„ÙŠ Ù‚Ø¯ ÙŠØ­Ø¯Ø«
        console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ...');
        const beforeCleanup = properties.length;

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
        const uniqueProperties = [];
        const seenKeys = new Set();

        properties.forEach(property => {
            const key = `${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}_${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`;
            if (!seenKeys.has(key)) {
                seenKeys.add(key);
                uniqueProperties.push(property);
            } else {
                console.log(`ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹: ${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}`);
            }
        });

        if (uniqueProperties.length !== beforeCleanup) {
            properties.length = 0;
            properties.push(...uniqueProperties);
            saveDataLocally();
            console.log(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ ${beforeCleanup - uniqueProperties.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹`);
        }

        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const result = {
            success: updatedUnits > 0,
            updatedUnits,
            supabaseUpdates,
            totalUnits: propertyUnits.length,
            localCleanup: beforeCleanup - uniqueProperties.length,
            errors: errors.length > 0 ? errors : null,
            reason: updatedUnits === 0 ? 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø£ÙŠ ÙˆØ­Ø¯Ø©' : null
        };

        console.log(`ğŸ‰ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ${updatedUnits}/${propertyUnits.length} ÙˆØ­Ø¯Ø©ØŒ ${supabaseUpdates} Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©ØŒ ${result.localCleanup} Ù…ÙƒØ±Ø±Ø© Ù…Ø­Ø°ÙˆÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹`);

        return result;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©:', error);
        return { success: false, reason: error.message };
    }
}

// ğŸ¢ Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª ØªØ­Ø±ÙŠØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function showPropertyNameEditOptions() {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        if (!canEditPropertyName()) {
            showNoPermissionMessage('ØªØ­Ø±ÙŠØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!ensurePropertiesLoaded('showPropertyNameEditOptions')) {
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!validateDataIntegrity()) {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©');
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
        if (!properties || properties.length === 0) {
            alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©');
            return;
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
        const uniqueProperties = [...new Set(
            properties
                .filter(p => p && typeof p === 'object' && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
                .map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
        )].filter(name => name && typeof name === 'string' && name.trim() !== '');

        if (uniqueProperties.length === 0) {
            alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ­Ø±ÙŠØ±');
            return;
        }

        console.log(`ğŸ¢ Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª ØªØ­Ø±ÙŠØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: ${uniqueProperties.length} Ø¹Ù‚Ø§Ø±`);

        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content property-name-options-modal">
                <div class="modal-header">
                    <h3>ğŸ¢ ØªØ­Ø±ÙŠØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h3>
                    <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                </div>

                <div class="modal-body">
                    <div class="info-box">
                        <h4>ğŸ“‹ Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø±ÙŠØ± Ø§Ø³Ù…Ù‡:</h4>
                        <p>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø£ÙŠ Ø¹Ù‚Ø§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡. Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±.</p>
                    </div>

                    <div class="search-box">
                        <input type="text" id="propertySearchInput" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª..." onkeyup="filterPropertyList()">
                    </div>

                    <div class="properties-list" id="propertiesList">
                        ${generatePropertyListHTML(uniqueProperties)}
                    </div>

                    <div class="stats-box">
                        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:</strong> ${uniqueProperties.length} Ø¹Ù‚Ø§Ø±</p>
                        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</strong> ${properties.length} ÙˆØ­Ø¯Ø©</p>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                        Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
        setTimeout(() => {
            const searchInput = document.getElementById('propertySearchInput');
            if (searchInput) {
                searchInput.focus();
            }
        }, 100);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª ØªØ­Ø±ÙŠØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ­Ø±ÙŠØ±');
    }
}

// ğŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function generatePropertyListHTML(properties) {
    return properties.map(propertyName => {
        const propertyUnits = window.properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
        const unitsCount = propertyUnits.length;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const firstUnit = propertyUnits.length > 0 ? propertyUnits[0] : {};
        const city = firstUnit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const owner = firstUnit['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© ÙˆØ§Ù„ÙØ§Ø±ØºØ©
        const rentedUnits = propertyUnits.filter(u => u && u['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && u['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '').length;
        const emptyUnits = unitsCount - rentedUnits;

        return `
            <div class="property-item" onclick="editPropertyName('${propertyName.replace(/'/g, "\\'")}')">
                <div class="property-header">
                    <h4>ğŸ¢ ${propertyName}</h4>
                    <button class="edit-btn" title="ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>

                <div class="property-details">
                    <div class="detail-row">
                        <span class="label">ğŸ“ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</span>
                        <span class="value">${city}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">ğŸ‘¤ Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
                        <span class="value">${owner}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">ğŸ  Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</span>
                        <span class="value">${unitsCount} ÙˆØ­Ø¯Ø©</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                        <span class="value">
                            <span class="status-rented">${rentedUnits} Ù…Ø¤Ø¬Ø±</span>
                            <span class="status-empty">${emptyUnits} ÙØ§Ø±Øº</span>
                        </span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ğŸ” ÙÙ„ØªØ±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function filterPropertyList() {
    const searchInput = document.getElementById('propertySearchInput');
    const propertiesList = document.getElementById('propertiesList');

    if (!searchInput || !propertiesList) return;

    const searchTerm = searchInput.value.trim().toLowerCase();
    const propertyItems = propertiesList.querySelectorAll('.property-item');

    let visibleCount = 0;

    propertyItems.forEach(item => {
        try {
            const propertyNameElement = item.querySelector('h4');
            const cityElement = item.querySelector('.detail-row .value');

            const propertyName = propertyNameElement ? propertyNameElement.textContent.toLowerCase() : '';
            const city = cityElement ? cityElement.textContent.toLowerCase() : '';

            const isVisible = propertyName.includes(searchTerm) || city.includes(searchTerm);

            item.style.display = isVisible ? 'block' : 'none';
            if (isVisible) visibleCount++;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†ØµØ±
            item.style.display = 'block';
            visibleCount++;
        }
    });

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const statsBox = document.querySelector('.property-name-options-modal .stats-box');
    if (statsBox && searchTerm) {
        const originalStats = statsBox.innerHTML;
        statsBox.innerHTML = `
            <p><strong>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:</strong> ${visibleCount} Ø¹Ù‚Ø§Ø±</p>
            ${originalStats}
        `;
    }
}

// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
function refreshCurrentView() {
    try {
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        if (typeof updatePropertyButtons === 'function') {
            updatePropertyButtons();
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        const currentView = document.querySelector('.content-section:not([style*="display: none"])');

        if (currentView) {
            const viewId = currentView.id;

            switch (viewId) {
                case 'propertyStatsSection':
                    // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                    if (typeof displayPropertyStats === 'function') {
                        displayPropertyStats();
                    }
                    break;

                case 'dataDisplaySection':
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    if (typeof displayData === 'function') {
                        displayData();
                    }
                    break;

                case 'searchSection':
                    // ØªØ­Ø¯ÙŠØ« Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
                    if (typeof performSearch === 'function') {
                        performSearch();
                    }
                    break;

                default:
                    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ù…');
                    break;
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø³Ø¯Ù„Ø© Ù…ÙØªÙˆØ­Ø©
        const dropdowns = document.querySelectorAll('select[id*="property"], select[id*="Property"]');
        dropdowns.forEach(dropdown => {
            if (typeof updateDropdownOptions === 'function') {
                updateDropdownOptions(dropdown);
            }
        });

        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ:', error);
    }
}

// ==================== ÙÙ„ØªØ± Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª ====================

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function showLastUpdatesFilter() {
    const modalHtml = `
        <div class="last-updates-modal" id="lastUpdatesModal">
            <div class="last-updates-content">
                <div class="last-updates-header">
                    <h2 class="last-updates-title">
                        <i class="fas fa-history"></i>
                        Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                    </h2>
                    <button class="last-updates-close" onclick="closeLastUpdatesModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙÙ„ØªØ±Ø© -->
                <div class="updates-filter-form">
                    <div class="updates-form-group required">
                        <label>Ø§Ù„Ø³Ù†Ø©:</label>
                        <select id="updatesYearSelect">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©</option>
                        </select>
                    </div>

                    <div class="updates-form-group required">
                        <label>Ø§Ù„Ø´Ù‡Ø±:</label>
                        <select id="updatesMonthSelect" disabled>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</option>
                        </select>
                    </div>

                    <div class="updates-form-group">
                        <label>Ø§Ù„ÙŠÙˆÙ…:</label>
                        <select id="updatesDaySelect" disabled>
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…</option>
                        </select>
                    </div>

                    <div class="updates-form-group">
                        <label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
                        <select id="updatesWeekSelect" disabled>
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</option>
                            <option value="1">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„</option>
                            <option value="2">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                            <option value="3">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                            <option value="4">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                        </select>
                    </div>
                </div>

                <div class="updates-filter-actions">
                    <button class="updates-btn updates-btn-secondary" onclick="clearUpdatesFilter()">
                        <i class="fas fa-eraser"></i>
                        Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±
                    </button>
                    <button class="updates-btn updates-btn-primary" onclick="applyUpdatesFilter()">
                        <i class="fas fa-search"></i>
                        Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                    </button>
                </div>

                <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
                <div class="updates-results" id="updatesResults">
                    <div class="updates-results-header">
                        <h4>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h4>
                        <span id="updatesResultsCount">0 ØªØ­Ø¯ÙŠØ«</span>
                    </div>
                    <div class="updates-results-content" id="updatesResultsContent">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‡Ù†Ø§ -->
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±
    setTimeout(() => {
        document.getElementById('lastUpdatesModal').classList.add('show');
    }, 100);

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    initializeUpdatesFilter();
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙÙ„ØªØ± Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function closeLastUpdatesModal() {
    const modal = document.getElementById('lastUpdatesModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ù†Ù…ÙˆØ°Ø¬ ÙÙ„ØªØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function initializeUpdatesFilter() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
    loadAvailableYears();

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.getElementById('updatesYearSelect').addEventListener('change', function() {
        loadAvailableMonths(this.value);
    });

    document.getElementById('updatesMonthSelect').addEventListener('change', function() {
        const year = document.getElementById('updatesYearSelect').value;
        if (year && this.value) {
            loadAvailableDays(year, this.value);
        }
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
function loadAvailableYears() {
    const yearSelect = document.getElementById('updatesYearSelect');
    const currentYear = new Date().getFullYear();
    const years = [];

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù†ÙˆØ§Øª Ù…Ù† Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ 5 Ø³Ù†ÙˆØ§Øª Ø³Ø§Ø¨Ù‚Ø©
    for (let i = 0; i <= 5; i++) {
        years.push(currentYear - i);
    }

    yearSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©</option>';
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø©
function loadAvailableMonths(year) {
    const monthSelect = document.getElementById('updatesMonthSelect');
    const daySelect = document.getElementById('updatesDaySelect');
    const weekSelect = document.getElementById('updatesWeekSelect');

    if (!year) {
        monthSelect.disabled = true;
        daySelect.disabled = true;
        weekSelect.disabled = true;
        return;
    }

    const months = [
        { value: '01', name: 'ÙŠÙ†Ø§ÙŠØ±' },
        { value: '02', name: 'ÙØ¨Ø±Ø§ÙŠØ±' },
        { value: '03', name: 'Ù…Ø§Ø±Ø³' },
        { value: '04', name: 'Ø£Ø¨Ø±ÙŠÙ„' },
        { value: '05', name: 'Ù…Ø§ÙŠÙˆ' },
        { value: '06', name: 'ÙŠÙˆÙ†ÙŠÙˆ' },
        { value: '07', name: 'ÙŠÙˆÙ„ÙŠÙˆ' },
        { value: '08', name: 'Ø£ØºØ³Ø·Ø³' },
        { value: '09', name: 'Ø³Ø¨ØªÙ…Ø¨Ø±' },
        { value: '10', name: 'Ø£ÙƒØªÙˆØ¨Ø±' },
        { value: '11', name: 'Ù†ÙˆÙÙ…Ø¨Ø±' },
        { value: '12', name: 'Ø¯ÙŠØ³Ù…Ø¨Ø±' }
    ];

    monthSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</option>';
    months.forEach(month => {
        const option = document.createElement('option');
        option.value = month.value;
        option.textContent = month.name;
        monthSelect.appendChild(option);
    });

    monthSelect.disabled = false;
    daySelect.disabled = true;
    weekSelect.disabled = true;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©
function loadAvailableDays(year, month) {
    const daySelect = document.getElementById('updatesDaySelect');
    const weekSelect = document.getElementById('updatesWeekSelect');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø±
    const daysInMonth = new Date(year, month, 0).getDate();

    daySelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…</option>';
    for (let day = 1; day <= daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day.toString().padStart(2, '0');
        option.textContent = day;
        daySelect.appendChild(option);
    }

    daySelect.disabled = false;
    weekSelect.disabled = false;
}

// Ù…Ø³Ø­ ÙÙ„ØªØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function clearUpdatesFilter() {
    document.getElementById('updatesYearSelect').value = '';
    document.getElementById('updatesMonthSelect').value = '';
    document.getElementById('updatesMonthSelect').disabled = true;
    document.getElementById('updatesDaySelect').value = '';
    document.getElementById('updatesDaySelect').disabled = true;
    document.getElementById('updatesWeekSelect').value = '';
    document.getElementById('updatesWeekSelect').disabled = true;

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('updatesResults').classList.remove('show');
}

// ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function applyUpdatesFilter() {
    const year = document.getElementById('updatesYearSelect').value;
    const month = document.getElementById('updatesMonthSelect').value;
    const day = document.getElementById('updatesDaySelect').value;
    const week = document.getElementById('updatesWeekSelect').value;

    if (!year || !month) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
    }

    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:', { year, month, day, week });

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    const filteredUpdates = findUpdatedUnits(year, month, day, week);

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    displayUpdatesResults(filteredUpdates);
}

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
function findUpdatedUnits(year, month, day, week) {
    const updates = [];

    properties.forEach(property => {
        const updateDate = property['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'];
        const updateType = property['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'];
        const updatedBy = property['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'];

        if (updateDate && isDateInRange(updateDate, year, month, day, week)) {
            updates.push({
                property,
                updateDate,
                updateType: updateType || 'ØªØ¹Ø¯ÙŠÙ„',
                updatedBy: updatedBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                timestamp: parseArabicDate(updateDate)
            });
        }
    });

    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    updates.sort((a, b) => b.timestamp - a.timestamp);

    return updates;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯
function isDateInRange(dateString, year, month, day, week) {
    try {
        const date = parseArabicDate(dateString);
        if (!date) return false;

        const dateYear = date.getFullYear().toString();
        const dateMonth = (date.getMonth() + 1).toString().padStart(2, '0');
        const dateDay = date.getDate().toString().padStart(2, '0');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø±
        if (dateYear !== year || dateMonth !== month) {
            return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙŠÙˆÙ… Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡
        if (day && dateDay !== day) {
            return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡
        if (week) {
            const dayOfMonth = date.getDate();
            const weekNumber = Math.ceil(dayOfMonth / 7);
            if (weekNumber.toString() !== week) {
                return false;
            }
        }

        return true;
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®:', dateString, error);
        return false;
    }
}

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„ØªØªØ¨Ø¹
function parseArabicDate(dateString) {
    if (!dateString) return null;

    try {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
        let normalizedDate = dateString.replace(/[Ù -Ù©]/g, (d) => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d));

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        if (normalizedDate.includes('/')) {
            // ØªÙ†Ø³ÙŠÙ‚ DD/MM/YYYY
            const parts = normalizedDate.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // JavaScript months are 0-based
                const year = parseInt(parts[2]);
                return new Date(year, month, day);
            }
        } else if (normalizedDate.includes('-')) {
            // ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DD Ø£Ùˆ DD-MM-YYYY
            const parts = normalizedDate.split('-');
            if (parts.length === 3) {
                if (parts[0].length === 4) {
                    // YYYY-MM-DD
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else {
                    // DD-MM-YYYY
                    return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                }
            }
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©
        return new Date(normalizedDate);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®:', dateString, error);
        return null;
    }
}

// Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function displayUpdatesResults(updates) {
    const resultsDiv = document.getElementById('updatesResults');
    const resultsContent = document.getElementById('updatesResultsContent');
    const resultsCount = document.getElementById('updatesResultsCount');

    resultsCount.textContent = `${updates.length} ØªØ­Ø¯ÙŠØ«`;

    if (updates.length === 0) {
        resultsContent.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6c757d;">
                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
            </div>
        `;
    } else {
        resultsContent.innerHTML = updates.map(update => `
            <div class="update-item">
                <div class="update-header">
                    <div class="update-unit-info">
                        Ø§Ù„ÙˆØ­Ø¯Ø© ${update.property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || update.property['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${update.property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}
                    </div>
                    <div class="update-timestamp">
                        ${update.updateDate}
                    </div>
                </div>
                <div class="update-details">
                    <div><strong>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</strong> ${update.property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº'}</div>
                    <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${update.property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                    <div><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${update.property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                    <div><strong>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong> ${update.updatedBy}</div>
                </div>
                <span class="update-type ${getUpdateTypeClass(update.updateType)}">
                    ${update.updateType}
                </span>
            </div>
        `).join('');
    }

    resultsDiv.classList.add('show');
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„Ø§Ø³ Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«
function getUpdateTypeClass(updateType) {
    switch (updateType) {
        case 'ØªØ¹Ø¯ÙŠÙ„':
        case 'ØªØ­Ø±ÙŠØ±':
            return 'edit';
        case 'Ø¥ÙØ±Ø§Øº':
            return 'empty';
        case 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯':
        case 'ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯':
            return 'new';
        case 'Ù†Ù‚Ù„ ÙˆØ­Ø¯Ø©':
            return 'transfer';
        default:
            return 'edit';
    }
}

// ==================== Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ====================

// Ù…ØªØºÙŠØ±Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹
let changeTrackingLogs = [];
let isTrackingEnabled = true;

// Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
const OPERATION_TYPES = {
    EDIT_DATA: 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©',
    NEW_CLIENT: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯',
    RENEW_CONTRACT: 'ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯',
    EMPTY_UNIT: 'Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©',
    MERGE_UNITS: 'Ø¯Ù…Ø¬ ÙˆØ­Ø¯Ø§Øª',
    SPLIT_UNITS: 'ÙØµÙ„ ÙˆØ­Ø¯Ø§Øª',
    TRANSFER_UNIT: 'Ù†Ù‚Ù„ ÙˆØ­Ø¯Ø©',
    DELETE_UNIT: 'Ø­Ø°Ù ÙˆØ­Ø¯Ø©',
    CREATE_PROPERTY: 'Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø§Ø±',
    DELETE_PROPERTY: 'Ø­Ø°Ù Ø¹Ù‚Ø§Ø±'
};

// Ù‡ÙŠÙƒÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø­Ø³Ù†
function createChangeLog(operationType, unitData, changes = {}, additionalInfo = {}) {
    const now = new Date();
    const hijriDate = getHijriDate(now);
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‡Ø¬Ø±ÙŠ
    const gregorianDate = formatDate(now); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© formatDate Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    const dayName = getDayName(now);

    return {
        id: `log_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`,
        timestamp: now.toISOString(),
        date: gregorianDate,
        hijriDate: hijriDate,
        time: now.toLocaleTimeString('ar-SA', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        }),
        dayName: dayName,
        year: now.getFullYear(),
        month: now.getMonth() + 1,
        operationType: operationType,
        user: getCurrentUser(),
        unitNumber: unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || unitData['Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        propertyName: unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        city: unitData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        contractNumber: unitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        tenantName: unitData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || unitData['Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
        changes: changes,
        originalData: additionalInfo.originalData || null,
        newData: additionalInfo.newData || null,
        previousTenant: additionalInfo.previousTenant || null,
        newTenant: unitData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || null,
        reason: additionalInfo.reason || null,
        notes: additionalInfo.notes || null,
        affectedUnits: additionalInfo.affectedUnits || [],
        sourceProperty: additionalInfo.sourceProperty || null,
        destinationProperty: additionalInfo.destinationProperty || null
    };
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø§Ù„Ù…Ø­Ø³Ù†
function getHijriDate(date) {
    try {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Intl.DateTimeFormat Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ
        const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }).format(date);

        return hijri;
    } catch (error) {
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø¯Ø¹Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ø±ÙŠØ¨ Ù…Ø­Ø³Ù†
        console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ø±ÙŠØ¨');
        return approximateHijriDate(date);
    }
}

// ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
function approximateHijriDate(date) {
    const hijriMonths = [
        'Ù…Ø­Ø±Ù…', 'ØµÙØ±', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©',
        'Ø±Ø¬Ø¨', 'Ø´Ø¹Ø¨Ø§Ù†', 'Ø±Ù…Ø¶Ø§Ù†', 'Ø´ÙˆØ§Ù„', 'Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©', 'Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©'
    ];

    // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ‚Ø±ÙŠØ¨: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø§Ø¯Ù„Ø© Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©
    const gregorianYear = date.getFullYear();
    const gregorianMonth = date.getMonth();
    const gregorianDay = date.getDate();

    // ØªÙ‚Ø±ÙŠØ¨ Ù…Ø­Ø³Ù† Ù„Ù„Ø³Ù†Ø© Ø§Ù„Ù‡Ø¬Ø±ÙŠØ©
    const hijriYear = Math.floor(gregorianYear - 621.5 + (gregorianMonth * 30.44 + gregorianDay) / 354.37);

    // ØªÙ‚Ø±ÙŠØ¨ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù‡Ø¬Ø±ÙŠ
    const dayOfYear = Math.floor((date - new Date(gregorianYear, 0, 0)) / (1000 * 60 * 60 * 24));
    const hijriMonthIndex = Math.floor((dayOfYear % 354) / 29.5) % 12;
    const hijriDay = Math.floor((dayOfYear % 354) % 29.5) + 1;

    return `${hijriDay} ${hijriMonths[hijriMonthIndex]} ${hijriYear}Ù‡Ù€`;
}

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…ÙƒØ±Ø±Ø© - ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø£Ø¹Ù„Ø§Ù‡

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…
function getDayName(date) {
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    return days[date.getDay()];
}

// Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase
async function saveChangeLogToSupabase(changeLog) {
    if (!isTrackingEnabled) {
        console.log('â„¹ï¸ ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¹Ø·Ù„');
        return false;
    }

    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            await createChangeLogsTableIfNotExists();

            console.log('â˜ï¸ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase:', changeLog.id);

            // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            const dataToSave = {
                id: changeLog.id,
                timestamp: changeLog.timestamp,
                operation_type: changeLog.operationType,
                unit_number: changeLog.unitNumber,
                property_name: changeLog.propertyName,
                tenant_name: changeLog.tenantName || changeLog.newTenant,
                contract_number: changeLog.contractNumber,
                city: changeLog.city,
                changes: changeLog.changes || {},
                additional_info: changeLog.additionalInfo || {},
                user_name: changeLog.user || changeLog.responsibleUser || 'Ø§Ù„Ù†Ø¸Ø§Ù…',
                description: changeLog.description || `${changeLog.operationType} - ${changeLog.unitNumber}`,
                date: changeLog.date,
                time: changeLog.time,
                day_name: changeLog.dayName,
                hijri_date: changeLog.hijriDate,
                new_tenant: changeLog.newTenant,
                previous_tenant: changeLog.previousTenant,
                reason: changeLog.reason,
                source_property: changeLog.sourceProperty,
                destination_property: changeLog.destinationProperty,
                responsible_user: changeLog.responsibleUser || changeLog.user
            };

            console.log('ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ¹Ø¯Ø© Ù„Ù„Ø­ÙØ¸:', dataToSave);

            const { data, error } = await supabaseClient
                .from('change_logs')
                .insert([dataToSave]);

            if (error) {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase:', error.message);

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
                console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„...');
                await new Promise(resolve => setTimeout(resolve, 1000));

                const { data: retryData, error: retryError } = await supabaseClient
                    .from('change_logs')
                    .insert([changeLog]);

                if (retryError) {
                    console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:', retryError.message);
                    return false;
                } else {
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©');
                    return true;
                }
            }

            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­:', changeLog.id);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¬Ù„
            try {
                const { data: verifyData, error: verifyError } = await supabaseClient
                    .from('change_logs')
                    .select('id')
                    .eq('id', changeLog.id)
                    .single();

                if (verifyError || !verifyData) {
                    console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸');
                    return false;
                }

                console.log('ğŸ” ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            } catch (verifyErr) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸:', verifyErr.message);
            }

            return true;
        } else {
            console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªÙˆÙØ± - Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹');
            return false;
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase:', error);
        return false;
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
async function createChangeLogsTableIfNotExists() {
    try {
        console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¬Ø¯ÙˆÙ„
        const { data: testData, error: testError } = await supabaseClient
            .from('change_logs')
            .select('id')
            .limit(1);

        if (!testError) {
            console.log('âœ… Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
            return true;
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        if (testError.message && testError.message.includes('does not exist')) {
            console.log('ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡...');

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const createTableQuery = `
                CREATE TABLE IF NOT EXISTS change_logs (
                    id TEXT PRIMARY KEY,
                    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    operation_type TEXT NOT NULL,
                    unit_number TEXT,
                    property_name TEXT,
                    tenant_name TEXT,
                    contract_number TEXT,
                    city TEXT,
                    changes JSONB DEFAULT '{}',
                    additional_info JSONB DEFAULT '{}',
                    user_name TEXT,
                    description TEXT,
                    date TEXT,
                    time TEXT,
                    day_name TEXT,
                    hijri_date TEXT,
                    new_tenant TEXT,
                    previous_tenant TEXT,
                    reason TEXT,
                    source_property TEXT,
                    destination_property TEXT,
                    responsible_user TEXT,
                    created_at TIMESTAMPTZ DEFAULT NOW(),
                    updated_at TIMESTAMPTZ DEFAULT NOW()
                );
            `;

            console.log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù…Ù† Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Supabase');
            return false;
        }

        console.log('âœ… Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…ØªØ§Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
        return true;

    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹:', error.message);
        console.log('ğŸ“Š Ø³ÙŠØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§ÙØªØ±Ø§Ø¶ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
        return true; // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† Supabase (Ù…Ø­Ø³Ù† Ù…Ø¹ ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„)
async function loadChangeLogsFromSupabase(limit = 2000, offset = 0) {
    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            console.log(`â˜ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† Supabase (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${limit})...`);
            console.log('ğŸ”— Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:', {
                url: supabaseClient.supabaseUrl,
                hasKey: !!supabaseClient.supabaseKey
            });

            const { data, error } = await supabaseClient
                .from('change_logs')
                .select('*')
                .order('timestamp', { ascending: false })
                .range(offset, offset + limit - 1);

            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† Supabase:', {
                    message: error.message,
                    details: error.details,
                    hint: error.hint,
                    code: error.code
                });

                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´Ø®ÙŠØµ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
                if (error.message.includes('permission denied') || error.message.includes('RLS')) {
                    console.warn('ğŸ”’ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª RLS ÙÙŠ Supabase');
                } else if (error.message.includes('does not exist')) {
                    console.warn('ğŸ“Š Ø¬Ø¯ÙˆÙ„ change_logs ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Supabase');
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    console.warn('ğŸŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©');
                }

                console.log('ğŸ“Š Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                return [];
            }

            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.length} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù…Ù† Supabase Ø¨Ù†Ø¬Ø§Ø­`);

            // Ø·Ø¨Ø§Ø¹Ø© Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ´Ø®ÙŠØµ
            if (data.length > 0) {
                console.log('ğŸ“‹ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', {
                    firstRecord: {
                        id: data[0].id,
                        operationType: data[0].operation_type,
                        timestamp: data[0].timestamp,
                        unitNumber: data[0].unit_number,
                        propertyName: data[0].property_name
                    },
                    totalRecords: data.length
                });
            }

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            const processedData = data.map(log => {
                // ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù† snake_case Ø¥Ù„Ù‰ camelCase Ù„Ù„ØªÙˆØ§ÙÙ‚
                const processedLog = {
                    id: log.id,
                    timestamp: log.timestamp,
                    operationType: log.operation_type || log.operationType,
                    unitNumber: log.unit_number || log.unitNumber,
                    propertyName: log.property_name || log.propertyName,
                    tenantName: log.tenant_name || log.tenantName,
                    contractNumber: log.contract_number || log.contractNumber,
                    city: log.city,
                    changes: log.changes || {},
                    additionalInfo: log.additional_info || log.additionalInfo || {},
                    user: log.user_name || log.user || log.responsible_user,
                    responsibleUser: log.responsible_user || log.user_name || log.user,
                    description: log.description,
                    newTenant: log.new_tenant || log.newTenant,
                    previousTenant: log.previous_tenant || log.previousTenant,
                    reason: log.reason,
                    sourceProperty: log.source_property || log.sourceProperty,
                    destinationProperty: log.destination_property || log.destinationProperty
                };

                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
                if (!processedLog.date && processedLog.timestamp) {
                    const date = new Date(processedLog.timestamp);
                    processedLog.date = formatDate(date); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
                    processedLog.time = formatTime(date); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø¨Ø³Ø·
                    processedLog.dayName = getDayName(date);
                    processedLog.hijriDate = getHijriDate(date);
                } else {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                    processedLog.date = log.date || processedLog.date;
                    processedLog.time = log.time || processedLog.time;
                    processedLog.dayName = log.day_name || processedLog.dayName;
                    processedLog.hijriDate = log.hijri_date || processedLog.hijriDate;
                }

                return processedLog;
            });

            console.log(`ğŸ”„ ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${processedData.length} Ø³Ø¬Ù„ ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨`);
            return processedData;
        } else {
            console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªÙˆÙØ± - ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Supabase');
            return [];
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† Supabase:', {
            message: error.message,
            stack: error.stack
        });
        return [];
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase Ø¨Ø¯ÙˆÙ† Ø­Ø¯ Ø£Ù‚ØµÙ‰
async function loadAllChangeLogsFromSupabase() {
    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            console.log('â˜ï¸ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† Supabase...');

            const { data, error } = await supabaseClient
                .from('change_logs')
                .select('*')
                .order('timestamp', { ascending: false });

            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
                return [];
            }

            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.length} Ø³Ø¬Ù„ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª`);

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const processedData = data.map(log => {
                const processedLog = {
                    id: log.id,
                    timestamp: log.timestamp,
                    operationType: log.operation_type || log.operationType,
                    unitNumber: log.unit_number || log.unitNumber,
                    propertyName: log.property_name || log.propertyName,
                    tenantName: log.tenant_name || log.tenantName,
                    contractNumber: log.contract_number || log.contractNumber,
                    city: log.city,
                    changes: log.changes || {},
                    additionalInfo: log.additional_info || log.additionalInfo || {},
                    user: log.user_name || log.user || log.responsible_user,
                    responsibleUser: log.responsible_user || log.user_name || log.user,
                    description: log.description,
                    newTenant: log.new_tenant || log.newTenant,
                    previousTenant: log.previous_tenant || log.previousTenant,
                    reason: log.reason,
                    sourceProperty: log.source_property || log.sourceProperty,
                    destinationProperty: log.destination_property || log.destinationProperty
                };

                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®
                if (!processedLog.date && processedLog.timestamp) {
                    const date = new Date(processedLog.timestamp);
                    processedLog.date = formatDate(date);
                    processedLog.time = formatTime(date);
                    processedLog.dayName = getDayName(date);
                    processedLog.hijriDate = getHijriDate(date);
                } else {
                    processedLog.date = log.date || processedLog.date;
                    processedLog.time = log.time || processedLog.time;
                    processedLog.dayName = log.day_name || processedLog.dayName;
                    processedLog.hijriDate = log.hijri_date || processedLog.hijriDate;
                }

                return processedLog;
            });

            return processedData;
        } else {
            console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±');
            return [];
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
        return [];
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø¬Ø¯ÙŠØ¯ - Ù…Ø­Ø¯Ø« Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ
async function addChangeLog(operationType, unitData, changes = {}, additionalInfo = {}) {
    if (!isTrackingEnabled) return;

    const changeLog = createChangeLog(operationType, unitData, changes, additionalInfo);

    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    changeTrackingLogs.unshift(changeLog);

    // Ø­ÙØ¸ ÙÙŠ localStorage
    try {
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000))); // Ø­ÙØ¸ Ø¢Ø®Ø± 1000 Ø³Ø¬Ù„
    } catch (error) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
    }

    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
    try {
        await saveTrackingLogToNewTable(changeLog, unitData);
    } catch (error) {
        console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ:', error.message);
        // Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
    }

    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„ØªÙˆØ§ÙÙ‚ (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
    try {
        await saveChangeLogToSupabase(changeLog);
    } catch (error) {
        console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…:', error.message);
        // Ø­ÙØ¸ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„
        await saveTrackingLogToPropertiesTable(changeLog, unitData);
    }

    console.log('ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹:', operationType, '- Ø§Ù„ÙˆØ­Ø¯Ø©:', changeLog.unitNumber);
}

// Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„
async function saveTrackingLogToPropertiesTable(changeLog, unitData) {
    try {
        if (!supabaseClient) {
            console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªØµÙ„ØŒ ØªØ®Ø·ÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¨Ø¯ÙŠÙ„');
            return;
        }

        console.log('ğŸ’¾ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„...');

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø±ØªØ¨Ø·
        const { data: existingProperty, error: searchError } = await supabaseClient
            .from('properties')
            .select('id, tracking_logs')
            .eq('unit_number', unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || changeLog.unitNumber)
            .eq('property_name', unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || changeLog.propertyName)
            .single();

        if (searchError && !searchError.message.includes('No rows')) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±:', searchError);
            return;
        }

        if (existingProperty) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
            const existingLogs = existingProperty.tracking_logs || [];
            const updatedLogs = [changeLog, ...existingLogs.slice(0, 49)]; // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 50 Ø³Ø¬Ù„

            const { error: updateError } = await supabaseClient
                .from('properties')
                .update({
                    tracking_logs: updatedLogs,
                    updated_at: new Date().toISOString()
                })
                .eq('id', existingProperty.id);

            if (updateError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹:', updateError);
            } else {
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
            }
        } else {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø±ØªØ¨Ø· Ù„Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø¨Ø¯ÙŠÙ„:', error);
    }
}

// Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ Ø§Ù„Ø¬Ø¯ÙŠØ¯
async function saveTrackingLogToNewTable(changeLog, unitData) {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
        if (typeof window.trackingLogsManager === 'undefined') {
            console.warn('âš ï¸ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±');
            return;
        }

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const trackingLogData = {
            operation_type: changeLog.operationType,
            timestamp: changeLog.timestamp,

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©/Ø§Ù„Ø¹Ù‚Ø§Ø±
            unit_number: unitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || changeLog.unitNumber,
            property_name: unitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || changeLog.propertyName,
            contract_number: unitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || null,
            city: unitData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || null,

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
            tenant_name: unitData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || null,
            tenant_phone: unitData['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || null,
            tenant_phone_2: unitData['Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ'] || null,

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
            rent_value: unitData['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || null,
            start_date: formatDateForDatabase(unitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']) || null,
            end_date: formatDateForDatabase(unitData['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']) || null,
            contract_type: unitData['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || null,

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            changes: changeLog.changes || {},
            additional_info: changeLog.additionalInfo || {},

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            user_name: changeLog.responsibleUser || getCurrentUser(),
            description: changeLog.description || `${changeLog.operationType} - ${changeLog.unitNumber}`,
            source: 'web_app'
        };

        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ
        await window.trackingLogsManager.saveTrackingLogToSupabase(trackingLogData);

        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ:', error);
    }
}

// Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
function compareDataAndCreateChanges(originalData, newData) {
    const changes = {};
    const excludedFields = ['Column1', 'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«', 'Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'];

    Object.keys(newData).forEach(key => {
        if (excludedFields.includes(key)) return;

        const oldValue = originalData[key];
        const newValue = newData[key];

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        const oldStr = (oldValue || '').toString().trim();
        const newStr = (newValue || '').toString().trim();

        if (oldStr !== newStr) {
            changes[key] = {
                old: oldValue,
                new: newValue,
                fieldName: getFieldDisplayName(key)
            };
        }
    });

    return changes;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ Ù„Ù„Ø¹Ø±Ø¶
function getFieldDisplayName(fieldKey) {
    const fieldNames = {
        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±',
        'ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯': 'ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯',
        'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯': 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯',
        'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·',
        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
        'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©',
        'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡': 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
        'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹': 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹',
        'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±',
        'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': 'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ',
        'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ',
        'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ',
        'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'Ø§Ù„Ù…Ø§Ù„Ùƒ'
    };

    return fieldNames[fieldKey] || fieldKey;
}

// ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function loadLocalChangeTrackingLogs() {
    try {
        const savedLogs = localStorage.getItem('changeTrackingLogs');
        if (savedLogs) {
            changeTrackingLogs = JSON.parse(savedLogs);
            console.log(`ğŸ“š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${changeTrackingLogs.length} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠ`);
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
        changeTrackingLogs = [];
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
function addTrackingFieldsToExistingData() {
    let updatedCount = 0;
    const currentDate = new Date().toLocaleDateString('ar-SA');

    properties.forEach((property, index) => {
        // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (!property['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«']) {
            property['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = currentDate;
            property['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©';
            property['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();
            updatedCount++;
        }
    });

    if (updatedCount > 0) {
        console.log(`ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù€ ${updatedCount} ÙˆØ­Ø¯Ø©`);

        // Ø¥Ø¶Ø§ÙØ© ØªÙˆØ§Ø±ÙŠØ® Ù…ØªÙ†ÙˆØ¹Ø© Ù„Ø¨Ø¹Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        addVariedDatesToUnits();

        saveDataLocally();

        // Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ Supabase
        autoSyncAfterEdit('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© (Ù…Ø­Ø³Ù†Ø©)
async function createSampleTrackingDataAndShow() {
    try {
        console.log('ğŸ¯ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹...');

        // ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù…Ù†Ø¹ Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„
        const currentUserName = getCurrentUser();
        const currentUserKey = window.currentUser;

        if (currentUserKey === '1234' ||
            currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ' ||
            currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ1234' ||
            (currentUserName && currentUserName.includes('Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ'))) {

            console.log('ğŸš« Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', currentUserName);
            showDevelopmentModal();
            return;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase...', 'info');

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase Ø£ÙˆÙ„Ø§Ù‹
        console.log('ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...');
        if (typeof supabaseClient === 'undefined' || !supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±');
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase Ù…Ø¨Ø§Ø´Ø±Ø©
        console.log('ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase...');
        const savedCount = await createAndSaveSampleTrackingData();

        if (savedCount === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø³Ø¬Ù„ ÙÙŠ Supabase');
        }

        // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('â³ Ø§Ù†ØªØ¸Ø§Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase...');
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Supabase
        console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Supabase...');
        const cloudLogs = await loadChangeLogsFromSupabase(10);
        console.log(`ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${cloudLogs.length} Ø³Ø¬Ù„ ÙÙŠ Supabase`);

        if (cloudLogs.length === 0) {
            showToast('ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Supabase', 'warning');
        }

        // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹
        console.log('ğŸ“‹ Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† Supabase...');
        await showChangeTrackingModal();

        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
        showToast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${savedCount} Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©: ' + error.message, 'error');
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ù„ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
async function testTrackingFunction() {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    // Ø§Ø®ØªØ¨Ø§Ø± 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Supabase
    console.log('1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase...');
    if (typeof supabaseClient === 'undefined' || !supabaseClient) {
        console.error('âŒ Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±');
        alert('Ø®Ø·Ø£: Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±');
        return;
    }
    console.log('âœ… Supabase Ù…ØªÙˆÙØ±');

    // Ø§Ø®ØªØ¨Ø§Ø± 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø¯ÙˆÙ„ change_logs
    console.log('2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ø¯ÙˆÙ„ change_logs...');
    try {
        const { data: testData, error: testError } = await supabaseClient
            .from('change_logs')
            .select('id')
            .limit(1);

        if (testError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¬Ø¯ÙˆÙ„:', testError);
            alert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¬Ø¯ÙˆÙ„: ${testError.message}`);
            return;
        }
        console.log('âœ… ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ø¯ÙˆÙ„ change_logs');
        console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', testData?.length || 0);
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„:', error);
        alert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„: ${error.message}`);
        return;
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 3: Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    console.log('3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...');
    try {
        const logs = await loadChangeLogsFromSupabase(10);
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', logs.length);

        if (logs.length > 0) {
            console.log('ğŸ“‹ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', logs[0]);
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
        alert(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${error.message}`);
        return;
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 4: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ
    console.log('4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ...');
    try {
        const testLog = {
            id: 'test_' + Date.now(),
            timestamp: new Date().toISOString(),
            operation_type: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…',
            unit_number: 'TEST-001',
            property_name: 'Ø¹Ù‚Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ',
            tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ',
            user_name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
            description: 'Ø³Ø¬Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…',
            date: formatDate(new Date()), // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
            time: formatTime(new Date()) // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø¨Ø³Ø·
        };

        const success = await saveChangeLogToSupabase(testLog);
        if (success) {
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­');

            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙÙ†Ø´Ø£
            const updatedLogs = await loadChangeLogsFromSupabase(5);
            const foundTestLog = updatedLogs.find(log => log.id === testLog.id);

            if (foundTestLog) {
                console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                console.log('ğŸ‰ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!');
                alert('ğŸ‰ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø§Ø¬Ø­! Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
            } else {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ');
                alert('âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
            }
        } else {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ');
            alert('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„:', error);
        alert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„: ${error.message}`);
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 5: Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹
    console.log('5ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹...');
    try {
        await showChangeTrackingModal();
        console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹:', error);
        alert(`Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹: ${error.message}`);
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase Ù…Ø¨Ø§Ø´Ø±Ø©
async function createAndSaveSampleTrackingData() {
    try {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Supabase...');

        // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Supabase Ø£ÙˆÙ„Ø§Ù‹
        await cleanupSampleDataFromSupabase();

        console.log('ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„ØªØªØ¨Ø¹...');

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø© Ø¨ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;

    const sampleLogs = [
        {
            id: 'sample_1_' + Date.now(),
            timestamp: new Date(Date.now() - 86400000).toISOString(), // Ø£Ù…Ø³
            date: `${(today.getDate() - 1).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 86400000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.EDIT_DATA,
            user: 'Ø§Ù„Ù…Ø¯ÙŠØ± - Ø¹Ù…Ø±',
            unitNumber: '101',
            propertyName: 'Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ù†Ø®ÙŠÙ„',
            city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            contractNumber: 'C001',
            changes: {
                'tenant_name': {
                    old: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯',
                    new: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯',
                    fieldName: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'
                },
                'rent_amount': {
                    old: '2000',
                    new: '2200',
                    fieldName: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±'
                }
            },
            newTenant: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯',
            previousTenant: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯'
        },
        {
            id: 'sample_2_' + Date.now(),
            timestamp: new Date(Date.now() - 172800000).toISOString(), // Ù‚Ø¨Ù„ ÙŠÙˆÙ…ÙŠÙ†
            date: `${Math.max(1, today.getDate() - 2).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 172800000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.NEW_CLIENT,
            user: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ - Ù…Ø­Ù…Ø¯',
            unitNumber: '205',
            propertyName: 'Ø¨Ø±Ø¬ Ø§Ù„Ø£Ù…Ù„',
            city: 'Ø¬Ø¯Ø©',
            contractNumber: 'C002',
            changes: {},
            newTenant: 'Ø³Ø§Ø±Ø© Ø¹Ù„ÙŠ',
            previousTenant: null,
            reason: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯'
        },
        {
            id: 'sample_3_' + Date.now(),
            timestamp: new Date(Date.now() - 259200000).toISOString(), // Ù‚Ø¨Ù„ 3 Ø£ÙŠØ§Ù…
            date: `${Math.max(1, today.getDate() - 3).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 259200000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.EMPTY_UNIT,
            user: 'Ø§Ù„Ù…Ø¯ÙŠØ± - Ø¹Ù…Ø±',
            unitNumber: '302',
            propertyName: 'Ù…Ø¬Ù…Ø¹ Ø§Ù„ÙˆØ±ÙˆØ¯',
            city: 'Ø§Ù„Ø¯Ù…Ø§Ù…',
            contractNumber: 'C003',
            changes: {},
            previousTenant: 'Ø®Ø§Ù„Ø¯ Ø³Ø¹Ø¯',
            reason: 'Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©'
        },
        {
            id: 'sample_4_' + Date.now(),
            timestamp: new Date(Date.now() - 345600000).toISOString(), // Ù‚Ø¨Ù„ 4 Ø£ÙŠØ§Ù…
            date: `${Math.max(1, today.getDate() - 4).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 345600000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.TRANSFER_UNIT,
            user: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ - Ù…Ø­Ù…Ø¯',
            unitNumber: '150',
            propertyName: 'ÙÙŠÙ„Ø§ Ø§Ù„ÙŠØ§Ø³Ù…ÙŠÙ†',
            city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            contractNumber: 'C004',
            changes: {},
            sourceProperty: 'Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ù‚Ù…Ø±',
            destinationProperty: 'ÙÙŠÙ„Ø§ Ø§Ù„ÙŠØ§Ø³Ù…ÙŠÙ†',
            reason: 'Ù†Ù‚Ù„ ÙˆØ­Ø¯Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª'
        },
        {
            id: 'sample_5_' + Date.now(),
            timestamp: new Date(Date.now() - 432000000).toISOString(), // Ù‚Ø¨Ù„ 5 Ø£ÙŠØ§Ù…
            date: `${Math.max(1, today.getDate() - 5).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 432000000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.RENEW_CONTRACT,
            user: 'Ø§Ù„Ù…Ø¯ÙŠØ± - Ø¹Ù…Ø±',
            unitNumber: '401',
            propertyName: 'Ø´Ù‚Ù‚ Ø§Ù„ÙØ±Ø¯ÙˆØ³',
            city: 'Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©',
            contractNumber: 'C005',
            changes: {
                'contract_end_date': {
                    old: '31/12/2024',
                    new: '31/12/2025',
                    fieldName: 'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'
                },
                'rent_amount': {
                    old: '1800',
                    new: '1900',
                    fieldName: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±'
                }
            },
            newTenant: 'ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯',
            previousTenant: 'ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯'
        }
    ];

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Supabase
    console.log('â˜ï¸ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙÙŠ Supabase...');
    let savedCount = 0;

    for (const sampleLog of sampleLogs) {
        try {
            const success = await saveChangeLogToSupabase(sampleLog);
            if (success) {
                savedCount++;
                console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ${savedCount}/${sampleLogs.length} ÙÙŠ Supabase`);
            }
        } catch (error) {
            console.warn(`âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Supabase:`, error);
        }
    }

    console.log(`ğŸ“Š ØªÙ… Ø­ÙØ¸ ${savedCount} Ù…Ù† Ø£ØµÙ„ ${sampleLogs.length} Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙÙŠ Supabase`);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙ‚Ø·
    changeTrackingLogs.unshift(...sampleLogs);

    // Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­
    return savedCount;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©:', error);
        throw error;
    }
}

// Ø¥Ø¶Ø§ÙØ© ØªÙˆØ§Ø±ÙŠØ® Ù…ØªÙ†ÙˆØ¹Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
function addVariedDatesToUnits() {
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1; // JavaScript months are 0-based

    const updateTypes = ['ØªØ­Ø±ÙŠØ±', 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', 'ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯', 'Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø©', 'Ù†Ù‚Ù„ ÙˆØ­Ø¯Ø©'];
    const users = ['Ø§Ù„Ù…Ø¯ÙŠØ± - Ø¹Ù…Ø±', 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ - Ù…Ø­Ù…Ø¯', 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯ - Ø£Ø­Ù…Ø¯'];

    // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ 15 ÙˆØ­Ø¯Ø© Ø¨ØªÙˆØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    for (let i = 0; i < Math.min(15, properties.length); i++) {
        // Ø¥Ù†Ø´Ø§Ø¡ ØªÙˆØ§Ø±ÙŠØ® Ù…Ø®ØªÙ„ÙØ© ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        const day = Math.max(1, Math.min(28, i + 1)); // Ø£ÙŠØ§Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ 28 Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±
        const updateDate = `${day.toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`;

        properties[i]['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = updateDate;
        properties[i]['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = updateTypes[i % updateTypes.length];
        properties[i]['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = users[i % users.length];

        console.log(`ğŸ“… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© ${i + 1}: ${updateDate} - ${updateTypes[i % updateTypes.length]}`);
    }

    console.log(`ğŸ“… ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªÙˆØ§Ø±ÙŠØ® Ù…ØªÙ†ÙˆØ¹Ø© Ù„Ù€ ${Math.min(15, properties.length)} ÙˆØ­Ø¯Ø© ÙÙŠ ${currentMonth}/${currentYear}`);
}

// Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
let previousMainContent = null;
let isTrackingViewActive = false;

// Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
async function showChangeTrackingModal() {
    console.log('ğŸ” Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† Supabase...');

    // ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù…Ù†Ø¹ "Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ" Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„
    const currentUserName = getCurrentUser();
    const currentUserKey = window.currentUser; // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…

    // Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… "1234" (Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ) Ø£Ùˆ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ" ÙÙŠ Ø§Ø³Ù…Ù‡
    if (currentUserKey === '1234' ||
        currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ' ||
        currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ1234' ||
        (currentUserName && currentUserName.includes('Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ'))) {

        console.log('ğŸš« Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', currentUserName);
        showDevelopmentModal();
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† Supabase...', 'info');

    let uniqueLogs = []; // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

    try {
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase (Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)
        const cloudLogs = await loadAllChangeLogsFromSupabase(); // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø¯ÙˆÙ† Ø­Ø¯ Ø£Ù‚ØµÙ‰
        console.log('â˜ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase:', cloudLogs.length);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙ‚Ø· (ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§ØªØµØ§Ù„)
        const localLogs = cloudLogs.length === 0 ? changeTrackingLogs : [];
        console.log('ğŸ’¾ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:', localLogs.length);

        // Ø¯Ù…Ø¬ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©)
        const allLogs = [...cloudLogs, ...localLogs];
        console.log('ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù‚Ø¨Ù„ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª:', allLogs.length);

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª ÙˆØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        uniqueLogs = allLogs.filter((log, index, self) =>
            index === self.findIndex(l => l.id === log.id)
        ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        console.log('âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª:', uniqueLogs.length);

        if (uniqueLogs.length > 0) {
            showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${uniqueLogs.length} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ù…Ù† Supabase`, 'success');
        } else {
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù…ØªØ§Ø­Ø©', 'warning');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹', 'error');

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒØ¨Ø¯ÙŠÙ„
        uniqueLogs = changeTrackingLogs.filter((log, index, self) =>
            index === self.findIndex(l => l.id === log.id)
        ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        console.log('ğŸ“± Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', uniqueLogs.length);
    }

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const mainContent = document.getElementById('content');
    if (!isTrackingViewActive) {
        previousMainContent = mainContent.innerHTML;
    }

    // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªØªØ¨Ø¹
    isTrackingViewActive = true;

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const trackingHtml = `
        <div class="tracking-main-view">
            <div class="tracking-header">
                <div class="tracking-title-section">
                    <button onclick="closeTrackingView()" class="back-btn">
                        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </button>
                    <h2><i class="fas fa-history"></i> Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</h2>
                    <p class="tracking-stats">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${uniqueLogs.length}</p>
                    <div class="new-features-notice" style="background: rgba(40, 167, 69, 0.1); padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 14px; color: #155724;">
                        <i class="fas fa-star" style="color: #28a745;"></i>
                        <strong>Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©:</strong>
                        Ø§Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… ÙˆØ­Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©" â€¢
                        Ø§Ø³ØªØ®Ø¯Ù… ÙÙ„ØªØ± "Ø¹Ù…Ù„ÙŠØ§Øª ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ â€¢
                        Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯" Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </div>
                    <div class="data-info-notice" style="background: rgba(23, 162, 184, 0.1); padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 13px; color: #0c5460;">
                        <i class="fas fa-info-circle" style="color: #17a2b8;"></i>
                        <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong>
                        ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ${uniqueLogs.length} Ø³Ø¬Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ Ø§Ø¶ØºØ· "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯" Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
                    </div>
                </div>
            </div>

            <div class="tracking-filters">
                <div class="filter-group">
                    <label>ÙÙ„ØªØ± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="trackingDateFilter" placeholder="Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®">
                </div>
                <div class="filter-group">
                    <label>ÙÙ„ØªØ± Ø¨Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©:</label>
                    <input type="month" id="trackingMonthFilter" placeholder="Ø§Ø®ØªØ± Ø´Ù‡Ø± ÙˆØ³Ù†Ø©">
                </div>
                <div class="filter-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                    <select id="trackingOperationType">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                        ${Object.values(OPERATION_TYPES).map(type =>
                            `<option value="${type}">${type}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Ø§Ù„Ø¨Ø­Ø«:</label>
                    <input type="text" id="trackingSearch" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§ØªØŒ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§ØªØŒ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (ÙŠØ´Ù…Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©)..."
                           oninput="return handleTrackingSearch(event)"
                           onkeydown="if(event.key==='Enter') { event.preventDefault(); return false; }"
                           onsubmit="return false"
                           autocomplete="off">
                </div>

                <!-- ÙÙ„ØªØ± Ø¬Ø¯ÙŠØ¯: Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù…Ù„ÙŠØ§Øª ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                <div class="filter-group">
                    <label>Ø¹Ù…Ù„ÙŠØ§Øª ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</label>
                    <select id="trackingDataEditFilter" title="ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
                        <option value="all">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</option>
                        <option value="hide">Ø¥Ø®ÙØ§Ø¡ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</option>
                        <option value="first_only">Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø·</option>
                    </select>
                </div>

                <div class="filter-buttons-row">
                    <button onclick="filterTrackingLogs()" class="filter-btn">
                        <i class="fas fa-filter"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
                    </button>
                    <button onclick="clearTrackingFilters()" class="clear-filter-btn">
                        <i class="fas fa-times"></i> Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
                    </button>

                    <!-- Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© -->
                    <button onclick="showUnitHistoryModal()" class="unit-history-btn" id="unitHistoryBtn" style="display: none;"
                            title="Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
                        <i class="fas fa-history"></i> Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©
                    </button>
                </div>
            </div>

            <div class="tracking-actions">
                <div class="view-toggle-group">
                    <button onclick="toggleTrackingView('cards')" class="view-toggle-btn" id="trackingCardsBtn">
                        <i class="fas fa-th-large"></i> Ø¨Ø·Ø§Ù‚Ø§Øª
                    </button>
                    <button onclick="toggleTrackingView('table')" class="view-toggle-btn active" id="trackingTableBtn">
                        <i class="fas fa-table"></i> Ø¬Ø¯ÙˆÙ„
                    </button>
                </div>

                <div class="action-buttons-group">
                    <button onclick="exportTrackingLogs()" class="export-btn" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø·">
                        <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙÙ„ØªØ±
                    </button>
                    <button onclick="printTrackingLogs()" class="print-btn" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø·">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙÙ„ØªØ±
                    </button>
                    <button onclick="refreshTrackingLogs()" class="refresh-btn">
                        <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                    <button onclick="loadMoreTrackingLogs()" class="load-more-btn" title="ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
                        <i class="fas fa-plus-circle"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯
                    </button>
                </div>
            </div>

            <div class="tracking-logs-container" id="trackingLogsContainer">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸ -->
            </div>
        </div>
    `;

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    mainContent.innerHTML = trackingHtml;

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ù„Ø¥ÙØ³Ø§Ø­ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø£ÙƒØ«Ø±
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.style.display = 'none';
        }
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Escape Ù„Ù„Ø¹ÙˆØ¯Ø©
    const handleEscapeKey = (event) => {
        if (event.key === 'Escape' && isTrackingViewActive) {
            closeTrackingView();
        }
    };

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.addEventListener('keydown', handleEscapeKey);

    // Ø­ÙØ¸ Ù…Ø±Ø¬Ø¹ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø§Ø­Ù‚Ø§Ù‹
    window.trackingEscapeHandler = handleEscapeKey;

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±ÙˆØ¶
    window.currentTrackingLogs = uniqueLogs;

    // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    if (typeof isConsolidationEnabled === 'undefined') {
        window.isConsolidationEnabled = true;
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØ¶Ù„
    const preferredView = localStorage.getItem('trackingViewPreference') || 'table';

    // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ DOM
    setTimeout(() => {
        toggleTrackingView(preferredView);

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¨Ù‚ÙˆØ© Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
        setTimeout(() => {
            forceSearchFieldStyling();
        }, 100);

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨ DOM Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
        setupSearchFieldObserver();
    }, 200);

    console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ');
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
function cleanupSampleTrackingData() {
    console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©...');

    const originalLength = changeTrackingLogs.length;

    // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 'sample' ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ù
    changeTrackingLogs = changeTrackingLogs.filter(log =>
        !log.id.includes('sample') &&
        !log.id.includes('test') &&
        !log.unitNumber.includes('TEST') &&
        !log.propertyName.includes('ØªØ¬Ø±ÙŠØ¨ÙŠ')
    );

    const deletedCount = originalLength - changeTrackingLogs.length;

    if (deletedCount > 0) {
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        try {
            localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ`);
        } catch (error) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
        }

        // Ø­Ø°Ù Ù…Ù† Supabase Ø£ÙŠØ¶Ø§Ù‹
        cleanupSampleDataFromSupabase();
    } else {
        console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø­Ø°Ù');
    }
}

// Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Supabase
async function cleanupSampleDataFromSupabase() {
    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { data: sampleLogs, error: fetchError } = await supabaseClient
                .from('change_logs')
                .select('id')
                .or('id.ilike.%sample%,id.ilike.%test%,unit_number.ilike.%TEST%,property_name.ilike.%ØªØ¬Ø±ÙŠØ¨ÙŠ%');

            if (!fetchError && sampleLogs && sampleLogs.length > 0) {
                const { error: deleteError } = await supabaseClient
                    .from('change_logs')
                    .delete()
                    .in('id', sampleLogs.map(log => log.id));

                if (!deleteError) {
                    console.log(`âœ… ØªÙ… Ø­Ø°Ù ${sampleLogs.length} Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ù† Supabase`);
                } else {
                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Supabase:', deleteError);
                }
            }
        }
    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Supabase:', error);
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø¹Ø±Ø¶ Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
function closeTrackingView() {
    console.log('ğŸ”™ Ø¥ØºÙ„Ø§Ù‚ Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    const mainContent = document.getElementById('content');

    if (previousMainContent) {
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
        mainContent.innerHTML = previousMainContent;
        console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚');
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø­ØªÙˆÙ‰ Ø³Ø§Ø¨Ù‚ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        renderData();
        console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.style.display = '';
        }
    }

    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬ Ù…ÙØªØ§Ø­ Escape
    if (window.trackingEscapeHandler) {
        document.removeEventListener('keydown', window.trackingEscapeHandler);
        window.trackingEscapeHandler = null;
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    isTrackingViewActive = false;
    previousMainContent = null;

    console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø¹Ø±Ø¶ Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
}

// ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
async function refreshTrackingLogs() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    if (isTrackingViewActive) {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ØªØªØ¨Ø¹
        await showChangeTrackingModal();
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
async function loadMoreTrackingLogs() {
    console.log('ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    if (!isTrackingViewActive) {
        showToast('ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }

    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª...', 'info');

    try {
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase
        const allCloudLogs = await loadAllChangeLogsFromSupabase();
        console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allCloudLogs.length} Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);

        // Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const allLogs = [...allCloudLogs, ...changeTrackingLogs];

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª ÙˆØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        const uniqueLogs = allLogs.filter((log, index, self) =>
            index === self.findIndex(l => l.id === log.id)
        ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        console.log(`âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©: ${uniqueLogs.length}`);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        window.currentTrackingLogs = uniqueLogs;

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶
        const preferredView = localStorage.getItem('trackingViewPreference') || 'table';
        toggleTrackingView(preferredView);

        showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${uniqueLogs.length} Ø³Ø¬Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'error');
    }
}

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·) =====

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ - Ù…Ø­Ø¯Ø« Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ
async function showTrackingManagementModal() {
    console.log('ğŸ”§ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    // ÙØ­Øµ Ø®Ø§Øµ Ù„Ù…Ù†Ø¹ Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
    const currentUserName = getCurrentUser();
    const currentUserKey = window.currentUser;

    if (currentUserKey === '1234' ||
        currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ' ||
        currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ1234' ||
        (currentUserName && currentUserName.includes('Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ'))) {

        console.log('ğŸš« Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', currentUserName);
        showDevelopmentModal();
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    if (!checkPermission('manageProperties')) {
        showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹', 'error');
        return;
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
    cleanupSampleTrackingData();

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    let newTableLogs = [];
    if (typeof window.trackingLogsManager !== 'undefined') {
        try {
            newTableLogs = await window.trackingLogsManager.loadTrackingLogsFromSupabase(1000);
            console.log(`ğŸ“¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${newTableLogs.length} Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ`);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ:', error);
        }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„ØªÙˆØ§ÙÙ‚
    const cloudLogs = await loadChangeLogsFromSupabase(1000);
    const allLogs = [...newTableLogs, ...cloudLogs, ...changeTrackingLogs];

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const processedLogs = [];
    const seenIds = new Set();

    allLogs.forEach(log => {
        let processedLog;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ Ø­ÙˆÙ„Ù‡ Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        if (log.operation_type && log.unit_number !== undefined) {
            processedLog = {
                id: log.id,
                operationType: log.operation_type,
                timestamp: log.timestamp,
                unitNumber: log.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                propertyName: log.property_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                tenantName: log.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                contractNumber: log.contract_number || '',
                city: log.city || '',
                changes: log.changes || {},
                additionalInfo: log.additional_info || {},
                responsibleUser: log.user_name || 'Ø§Ù„Ù†Ø¸Ø§Ù…',
                description: log.description || '',
                source: 'new_table'
            };
        } else {
            // Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
            processedLog = {
                ...log,
                source: 'old_system'
            };
        }

        // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if (!seenIds.has(processedLog.id)) {
            seenIds.add(processedLog.id);
            processedLogs.push(processedLog);
        }
    });

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const uniqueLogs = processedLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©: ${uniqueLogs.length} (${newTableLogs.length} Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ ${cloudLogs.length} Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…)`);

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    let newTableStats = null;
    if (typeof window.trackingLogsManager !== 'undefined') {
        try {
            newTableStats = await window.trackingLogsManager.getTrackingLogsStats();
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', error);
        }
    }

    const modalHtml = `
        <div class="modal-overlay" style="display:flex; z-index: 10000;">
            <div class="modal-box tracking-management-modal" style="max-width: 1400px; max-height: 95vh; width: 95%;">
                <button class="close-modal" onclick="closeModal()">Ã—</button>

                <div class="modal-header">
                    <h2><i class="fas fa-cogs"></i> Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹</h2>
                    <p class="management-warning">âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· - ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</p>

                    ${newTableStats ? `
                    <div class="tracking-stats-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; border: 2px solid #e9ecef;">
                        <h4><i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div class="stat-item" style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #007bff;">${newTableStats.total_logs || 0}</div>
                                <div style="font-size: 0.9rem; color: #666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                            </div>
                            <div class="stat-item" style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${newTableStats.logs_today || 0}</div>
                                <div style="font-size: 0.9rem; color: #666;">Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                            </div>
                            <div class="stat-item" style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">${newTableStats.logs_this_week || 0}</div>
                                <div style="font-size: 0.9rem; color: #666;">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
                            </div>
                            <div class="stat-item" style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">${newTableStats.logs_this_month || 0}</div>
                                <div style="font-size: 0.9rem; color: #666;">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                            <strong>Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹:</strong> ${newTableStats.most_common_operation || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} |
                            <strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹:</strong> ${newTableStats.most_active_user || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </div>
                    </div>
                    ` : ''}
                </div>
                    <div class="logs-stats">
                        <span class="stat-item">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <strong id="totalLogsCount">${uniqueLogs.length}</strong></span>
                        <span class="stat-item">Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: <strong id="selectedLogsCount">0</strong></span>
                    </div>
                </div>

                <div class="management-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>ÙÙ„ØªØ± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                            <input type="date" id="mgmtDateFilter" placeholder="Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®">
                        </div>
                        <div class="filter-group">
                            <label>ÙÙ„ØªØ± Ø¨Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©:</label>
                            <input type="month" id="mgmtMonthFilter" placeholder="Ø§Ø®ØªØ± Ø´Ù‡Ø± ÙˆØ³Ù†Ø©">
                        </div>
                        <div class="filter-group">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                            <select id="mgmtOperationType">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                                ${Object.values(OPERATION_TYPES).map(type =>
                                    `<option value="${type}">${type}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                            <select id="mgmtUserFilter">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>
                                ${getUniqueUsers(uniqueLogs).map(user =>
                                    `<option value="${user}">${user}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Ø§Ù„Ø¨Ø­Ø«:</label>
                            <input type="text" id="mgmtSearch" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø£Ùˆ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...">
                        </div>
                        <div class="filter-actions">
                            <button onclick="applyManagementFilters()" class="filter-btn">
                                <i class="fas fa-filter"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
                            </button>
                            <button onclick="clearManagementFilters()" class="clear-btn">
                                <i class="fas fa-times"></i> Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
                            </button>
                        </div>
                    </div>
                </div>

                <div class="management-actions">
                    <div class="selection-actions">
                        <button onclick="selectAllLogs()" class="select-btn">
                            <i class="fas fa-check-square"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                        </button>
                        <button onclick="deselectAllLogs()" class="deselect-btn">
                            <i class="fas fa-square"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                        </button>
                        <button onclick="selectByType()" class="select-type-btn">
                            <i class="fas fa-filter"></i> ØªØ­Ø¯ÙŠØ¯ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                        </button>
                    </div>

                    <div class="delete-actions">
                        <button onclick="deleteSelectedLogs()" class="delete-selected-btn" disabled>
                            <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                        </button>
                        <button onclick="deleteByDate()" class="delete-date-btn">
                            <i class="fas fa-calendar-times"></i> Ø­Ø°Ù ÙŠÙˆÙ… ÙƒØ§Ù…Ù„
                        </button>
                        <button onclick="deleteByType()" class="delete-type-btn">
                            <i class="fas fa-layer-group"></i> Ø­Ø°Ù Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                        </button>
                        <button onclick="deleteByUser()" class="delete-user-btn">
                            <i class="fas fa-user-times"></i> Ø­Ø°Ù Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        </button>
                        <button onclick="deleteAllLogs()" class="delete-all-btn">
                            <i class="fas fa-exclamation-triangle"></i> Ø­Ø°Ù Ø§Ù„ÙƒÙ„
                        </button>
                    </div>
                </div>

                <div class="management-logs-container" id="managementLogsContainer">
                    ${renderManagementLogs(uniqueLogs)}
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
    window.managementLogsData = uniqueLogs;

    console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙØ±ÙŠØ¯Ø©
function getUniqueUsers(logs) {
    const users = [...new Set(logs.map(log => log.user || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'))];
    return users.sort();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
function renderManagementLogs(logs) {
    if (!logs || logs.length === 0) {
        return `
            <div class="no-logs">
                <i class="fas fa-clipboard-list"></i>
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</h3>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
            </div>
        `;
    }

    return `
        <div class="management-logs-list">
            ${logs.map((log, index) => `
                <div class="management-log-entry" data-log-id="${log.id}">
                    <div class="log-checkbox">
                        <input type="checkbox" id="log_${index}" class="log-selector"
                               onchange="updateSelectedCount()" data-log-id="${log.id}">
                        <label for="log_${index}"></label>
                    </div>

                    <div class="log-content">
                        <div class="log-header">
                            <div class="log-operation">
                                <i class="fas fa-cog"></i>
                                ${log.operationType}
                            </div>
                            <div class="log-meta">
                                <span class="log-date">${log.date} ${log.hijriDate ? `(${log.hijriDate})` : ''}</span>
                                <span class="log-time">${log.time}</span>
                                <span class="log-user">${log.user || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                            </div>
                        </div>

                        <div class="log-details">
                            <div class="log-property">
                                <strong>Ø§Ù„Ø¹Ù‚Ø§Ø±:</strong> ${log.propertyName}
                            </div>
                            <div class="log-unit">
                                <strong>Ø§Ù„ÙˆØ­Ø¯Ø©:</strong> ${log.unitNumber}
                            </div>
                            ${log.changes && Object.keys(log.changes).length > 0 ? `
                                <div class="log-changes">
                                    <strong>Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:</strong>
                                    ${Object.entries(log.changes).map(([field, change]) =>
                                        `<span class="change-item">${change.fieldName}: ${change.old} â†’ ${change.new}</span>`
                                    ).join(', ')}
                                </div>
                            ` : ''}
                        </div>

                        <div class="log-actions">
                            <button onclick="deleteIndividualLog('${log.id}')" class="delete-single-btn">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                            <button onclick="viewLogDetails('${log.id}')" class="view-details-btn">
                                <i class="fas fa-eye"></i> Ø§Ù„ØªÙØ§ØµÙŠÙ„
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.log-selector:checked');
    const count = checkboxes.length;

    document.getElementById('selectedLogsCount').textContent = count;

    // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­Ø°Ù
    const deleteBtn = document.querySelector('.delete-selected-btn');
    if (deleteBtn) {
        deleteBtn.disabled = count === 0;
    }
}

// ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
function selectAllLogs() {
    const checkboxes = document.querySelectorAll('.log-selector');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

// Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
function deselectAllLogs() {
    const checkboxes = document.querySelectorAll('.log-selector');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
function selectByType() {
    const operationType = document.getElementById('mgmtOperationType').value;
    if (!operationType) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }

    const checkboxes = document.querySelectorAll('.log-selector');
    checkboxes.forEach(checkbox => {
        const logEntry = checkbox.closest('.management-log-entry');
        const logOperation = logEntry.querySelector('.log-operation').textContent.trim();
        checkbox.checked = logOperation === operationType;
    });
    updateSelectedCount();
}

// Ø­Ø°Ù Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯ - Ù…Ø­Ø¯Ø« Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ
async function deleteIndividualLog(logId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„: ${logId}`);

    try {
        let deletedFromNewTable = false;
        let deletedFromOldSystem = false;

        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (typeof window.trackingLogsManager !== 'undefined') {
            try {
                const result = await window.trackingLogsManager.deleteTrackingLog(logId);
                if (result) {
                    deletedFromNewTable = true;
                    console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ');
                }
            } catch (error) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ:', error);
            }
        }

        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const localIndex = changeTrackingLogs.findIndex(log => log.id === logId);
        if (localIndex !== -1) {
            changeTrackingLogs.splice(localIndex, 1);
            localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
        }

        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù„Ù„ØªÙˆØ§ÙÙ‚)
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            try {
                const { error } = await supabaseClient
                    .from('change_logs')
                    .delete()
                    .eq('id', logId);

                if (!error) {
                    deletedFromOldSystem = true;
                    console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…');
                } else {
                    console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…:', error);
                }
            } catch (error) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…:', error);
            }
        }

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const logElement = document.querySelector(`[data-log-id="${logId}"]`);
        if (logElement) {
            logElement.remove();
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        updateLogsCount();
        updateSelectedCount();

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø°Ù
        let successMessage = 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­';
        if (deletedFromNewTable && deletedFromOldSystem) {
            successMessage += ' Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©';
        } else if (deletedFromNewTable) {
            successMessage += ' Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ';
        } else if (deletedFromOldSystem) {
            successMessage += ' Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…';
        }

        showToast(successMessage, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„', 'error');
    }
}

// Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
async function deleteSelectedLogs() {
    const checkboxes = document.querySelectorAll('.log-selector:checked');
    const count = checkboxes.length;

    if (count === 0) {
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø­Ø°Ù', 'warning');
        return;
    }

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${count} Ø³Ø¬Ù„ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù ${count} Ø³Ø¬Ù„ Ù…Ø­Ø¯Ø¯...`);

    const logIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-log-id'));

    try {
        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        logIds.forEach(logId => {
            const index = changeTrackingLogs.findIndex(log => log.id === logId);
            if (index !== -1) {
                changeTrackingLogs.splice(index, 1);
            }
        });

        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));

        // Ø­Ø°Ù Ù…Ù† Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .in('id', logIds);

            if (error) {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase:', error);
            }
        }

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        logIds.forEach(logId => {
            const logElement = document.querySelector(`[data-log-id="${logId}"]`);
            if (logElement) {
                logElement.remove();
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        updateLogsCount();
        updateSelectedCount();

        showToast(`ØªÙ… Ø­Ø°Ù ${count} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'error');
    }
}

// Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª ÙŠÙˆÙ… ÙƒØ§Ù…Ù„
async function deleteByDate() {
    const date = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (YYYY-MM-DD):');
    if (!date) return;

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª ÙŠÙˆÙ… ${date}ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª ÙŠÙˆÙ… ${date}...`);

    try {
        const targetDate = formatDate(new Date(date)); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ

        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        const logsToDelete = changeTrackingLogs.filter(log => log.date === targetDate);
        const logIds = logsToDelete.map(log => log.id);

        if (logIds.length === 0) {
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®', 'info');
            return;
        }

        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        changeTrackingLogs = changeTrackingLogs.filter(log => log.date !== targetDate);
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));

        // Ø­Ø°Ù Ù…Ù† Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .in('id', logIds);

            if (error) {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        await refreshManagementView();

        showToast(`ØªÙ… Ø­Ø°Ù ${logIds.length} Ø³Ø¬Ù„ Ù…Ù† ØªØ§Ø±ÙŠØ® ${date}`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…', 'error');
    }
}

// Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
async function deleteByType() {
    const operationType = prompt(`Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø­Ø°Ù:\n${Object.values(OPERATION_TYPES).join('\n')}`);
    if (!operationType) return;

    if (!Object.values(OPERATION_TYPES).includes(operationType)) {
        showToast('Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
        return;
    }

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª "${operationType}"ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ù†ÙˆØ¹ ${operationType}...`);

    try {
        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        const logsToDelete = changeTrackingLogs.filter(log => log.operationType === operationType);
        const logIds = logsToDelete.map(log => log.id);

        if (logIds.length === 0) {
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹', 'info');
            return;
        }

        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        changeTrackingLogs = changeTrackingLogs.filter(log => log.operationType !== operationType);
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));

        // Ø­Ø°Ù Ù…Ù† Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .in('id', logIds);

            if (error) {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        await refreshManagementView();

        showToast(`ØªÙ… Ø­Ø°Ù ${logIds.length} Ø³Ø¬Ù„ Ù…Ù† Ù†ÙˆØ¹ "${operationType}"`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†ÙˆØ¹:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†ÙˆØ¹', 'error');
    }
}

// Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function deleteByUser() {
    const user = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§ØªÙ‡:');
    if (!user) return;

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user}"ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
        return;
    }

    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user}...`);

    try {
        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        const logsToDelete = changeTrackingLogs.filter(log => (log.user || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') === user);
        const logIds = logsToDelete.map(log => log.id);

        if (logIds.length === 0) {
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'info');
            return;
        }

        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        changeTrackingLogs = changeTrackingLogs.filter(log => (log.user || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') !== user);
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));

        // Ø­Ø°Ù Ù…Ù† Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .in('id', logIds);

            if (error) {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        await refreshManagementView();

        showToast(`ØªÙ… Ø­Ø°Ù ${logIds.length} Ø³Ø¬Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user}"`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
    }
}

// Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
async function deleteAllLogs() {
    if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!')) {
        return;
    }

    if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø³Ø­Ø§Ø¨Ø©.\nØ§ÙƒØªØ¨ "Ù†Ø¹Ù…" Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:') ||
        prompt('Ø§ÙƒØªØ¨ "Ø­Ø°Ù Ø§Ù„ÙƒÙ„" Ù„Ù„ØªØ£ÙƒÙŠØ¯:') !== 'Ø­Ø°Ù Ø§Ù„ÙƒÙ„') {
        showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'info');
        return;
    }

    console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    try {
        const totalCount = changeTrackingLogs.length;

        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        changeTrackingLogs = [];
        localStorage.removeItem('changeTrackingLogs');

        // Ø­Ø°Ù Ù…Ù† Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .neq('id', ''); // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª

            if (error) {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase:', error);
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        closeModal();

        showToast(`ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (${totalCount} Ø³Ø¬Ù„) Ø¨Ù†Ø¬Ø§Ø­`, 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'error');
    }
}

// ØªØ·Ø¨ÙŠÙ‚ ÙÙ„Ø§ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function applyManagementFilters() {
    const dateFilter = document.getElementById('mgmtDateFilter').value;
    const monthFilter = document.getElementById('mgmtMonthFilter').value;
    const operationType = document.getElementById('mgmtOperationType').value;
    const userFilter = document.getElementById('mgmtUserFilter').value;
    const searchTerm = document.getElementById('mgmtSearch').value.toLowerCase();

    let filteredLogs = window.managementLogsData || [];

    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯
    if (dateFilter) {
        const filterDate = new Date(dateFilter);
        filteredLogs = filteredLogs.filter(log => {
            const logDate = new Date(log.timestamp);
            return logDate.toDateString() === filterDate.toDateString();
        });
    }

    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©
    if (monthFilter) {
        const [filterYear, filterMonth] = monthFilter.split('-');
        filteredLogs = filteredLogs.filter(log => {
            const logDate = new Date(log.timestamp);
            return logDate.getFullYear() === parseInt(filterYear) &&
                   (logDate.getMonth() + 1) === parseInt(filterMonth);
        });
    }

    // ÙÙ„ØªØ±Ø© Ø¨Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    if (operationType) {
        filteredLogs = filteredLogs.filter(log => log.operationType === operationType);
    }

    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (userFilter) {
        filteredLogs = filteredLogs.filter(log => (log.user || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') === userFilter);
    }

    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø¨Ø­Ø«
    if (searchTerm) {
        filteredLogs = filteredLogs.filter(log =>
            log.propertyName.toLowerCase().includes(searchTerm) ||
            log.unitNumber.toLowerCase().includes(searchTerm) ||
            log.operationType.toLowerCase().includes(searchTerm)
        );
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    const container = document.getElementById('managementLogsContainer');
    if (container) {
        container.innerHTML = renderManagementLogs(filteredLogs);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
    document.getElementById('totalLogsCount').textContent = filteredLogs.length;
    updateSelectedCount();

    console.log(`ğŸ” ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±: ${filteredLogs.length} Ø³Ø¬Ù„`);
}

// Ù…Ø³Ø­ ÙÙ„Ø§ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
function clearManagementFilters() {
    document.getElementById('mgmtDateFilter').value = '';
    document.getElementById('mgmtMonthFilter').value = '';
    document.getElementById('mgmtOperationType').value = '';
    document.getElementById('mgmtUserFilter').value = '';
    document.getElementById('mgmtSearch').value = '';

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const container = document.getElementById('managementLogsContainer');
    if (container && window.managementLogsData) {
        container.innerHTML = renderManagementLogs(window.managementLogsData);
        document.getElementById('totalLogsCount').textContent = window.managementLogsData.length;
    }

    updateSelectedCount();
    console.log('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±');
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
async function refreshManagementView() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const cloudLogs = await loadChangeLogsFromSupabase(1000);
    const allLogs = [...cloudLogs, ...changeTrackingLogs];

    const uniqueLogs = allLogs.filter((log, index, self) =>
        index === self.findIndex(l => l.id === log.id)
    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    window.managementLogsData = uniqueLogs;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    const container = document.getElementById('managementLogsContainer');
    if (container) {
        container.innerHTML = renderManagementLogs(uniqueLogs);
    }

    updateLogsCount();
    updateSelectedCount();
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¬Ù„Ø§Øª
function updateLogsCount() {
    const totalElement = document.getElementById('totalLogsCount');
    if (totalElement && window.managementLogsData) {
        totalElement.textContent = window.managementLogsData.length;
    }
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„
function viewLogDetails(logId) {
    const log = window.managementLogsData?.find(l => l.id === logId);
    if (!log) {
        showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„', 'error');
        return;
    }

    const detailsHtml = `
        <div class="modal-overlay" style="display:flex; z-index: 10001;">
            <div class="modal-box" style="max-width: 800px;">
                <button class="close-modal" onclick="closeModal()">Ã—</button>

                <div class="modal-header">
                    <h3><i class="fas fa-info-circle"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</h3>
                </div>

                <div class="log-details-content">
                    <div class="detail-section">
                        <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                                <span>${log.operationType}</span>
                            </div>
                            <div class="detail-item">
                                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                                <span>${log.date} ${log.hijriDate ? `(${log.hijriDate})` : ''}</span>
                            </div>
                            <div class="detail-item">
                                <label>Ø§Ù„ÙˆÙ‚Øª:</label>
                                <span>${log.time}</span>
                            </div>
                            <div class="detail-item">
                                <label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                                <span>${log.user || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Ø§Ù„Ø¹Ù‚Ø§Ø±:</label>
                                <span>${log.propertyName}</span>
                            </div>
                            <div class="detail-item">
                                <label>Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                                <span>${log.unitNumber}</span>
                            </div>
                        </div>
                    </div>

                    ${log.changes && Object.keys(log.changes).length > 0 ? `
                        <div class="detail-section">
                            <h4>Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</h4>
                            <div class="changes-list">
                                ${Object.entries(log.changes).map(([field, change]) => `
                                    <div class="change-item">
                                        <strong>${change.fieldName}:</strong>
                                        <div class="change-values">
                                            <span class="old-value">Ø§Ù„Ù‚Ø¯ÙŠÙ…: ${change.old}</span>
                                            <span class="arrow">â†’</span>
                                            <span class="new-value">Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${change.new}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="detail-section">
                        <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙ‚Ù†ÙŠØ©</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„:</label>
                                <span style="font-family: monospace; font-size: 0.9em;">${log.id}</span>
                            </div>
                            <div class="detail-item">
                                <label>Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ:</label>
                                <span style="font-family: monospace; font-size: 0.9em;">${log.timestamp}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button onclick="deleteIndividualLog('${log.id}'); closeModal();" class="delete-btn">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„
                    </button>
                    <button onclick="closeModal()" class="cancel-btn">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', detailsHtml);
}

// ===== Ù†Ù‡Ø§ÙŠØ© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ =====

// ===== Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ =====

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
async function testTrackingLogsConnection() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ø¯ÙˆÙ„ tracking_logs...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
        if (typeof window.trackingLogsManager === 'undefined') {
            console.error('âŒ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù…Ø­Ù…Ù„');
            return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const tableExists = await window.trackingLogsManager.ensureTrackingLogsTableExists();
        if (!tableExists) {
            console.error('âŒ Ø¬Ø¯ÙˆÙ„ tracking_logs ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return false;
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¯Ø±Ø§Ø¬ Ø³Ø¬Ù„
        const testLog = {
            operation_type: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„',
            unit_number: 'TEST-CONNECTION',
            property_name: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…',
            description: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯',
            user_name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'
        };

        const result = await window.trackingLogsManager.saveTrackingLogToSupabase(testLog);
        if (result) {
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­:', result.id);

            // Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            await window.trackingLogsManager.deleteTrackingLog(result.id);
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');

            return true;
        } else {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            return false;
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„:', error);
        return false;
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø­ÙØ¸ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø¬Ø¯ÙŠØ¯
async function forceCreateTrackingLog() {
    console.log('ğŸ”§ Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹...');

    try {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø·Ù„
        const wasTrackingEnabled = isTrackingEnabled;
        isTrackingEnabled = true;

        const unitData = {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'FORCE-TEST-' + Date.now(),
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¬Ø¨Ø§Ø±ÙŠ',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø±',
            'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': '0501234567',
            'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ': '0507654321',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶'
        };

        await addChangeLog('Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¬Ø¨Ø§Ø±ÙŠ', unitData, { forced: true }, { test: true });

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        isTrackingEnabled = wasTrackingEnabled;

        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ');
        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø¯ÙˆÙ„ tracking_logs', 'success');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ:', error);
        showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹: ' + error.message, 'error');
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹
function showTrackingStatus() {
    console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹:');
    console.log('- isTrackingEnabled:', isTrackingEnabled);
    console.log('- trackingLogsManager Ù…ØªÙˆÙØ±:', typeof window.trackingLogsManager !== 'undefined');
    console.log('- supabaseClient Ù…ØªÙˆÙØ±:', typeof supabaseClient !== 'undefined');
    console.log('- Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', changeTrackingLogs.length);

    showToast(`Ø§Ù„ØªØªØ¨Ø¹: ${isTrackingEnabled ? 'Ù…ÙØ¹Ù„' : 'Ù…Ø¹Ø·Ù„'} | Ø§Ù„Ù…Ø¯ÙŠØ±: ${typeof window.trackingLogsManager !== 'undefined' ? 'Ù…ØªÙˆÙØ±' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}`, 'info');
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØªØªØ¬Ø§ÙˆØ² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙˆØ·)
async function directTestNewTable() {
    console.log('ğŸ”§ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±
        if (typeof window.trackingLogsManager === 'undefined') {
            console.error('âŒ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù…Ø­Ù…Ù„');
            showToast('Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù…Ø­Ù…Ù„', 'error');
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©
        const testLogData = {
            operation_type: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±',
            unit_number: 'DIRECT-TEST-' + Date.now(),
            property_name: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¬Ø¯ÙˆÙ„',
            tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±',
            tenant_phone: '0501111111',
            tenant_phone_2: '0502222222',
            city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            contract_number: 'TEST-CONTRACT-' + Date.now(),
            rent_value: 1500.00,
            contract_type: 'Ø³ÙƒÙ†ÙŠ',
            description: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯',
            changes: {
                test: true,
                timestamp: new Date().toISOString(),
                method: 'direct_test'
            },
            additional_info: {
                source: 'direct_test_function',
                browser: navigator.userAgent,
                url: window.location.href
            },
            user_name: 'Ù…Ø®ØªØ¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù…'
        };

        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ:', testLogData);

        // Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const result = await window.trackingLogsManager.saveTrackingLogToSupabase(testLogData);

        if (result && result.id) {
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­:', result.id);
            showToast(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­! ID: ${result.id}`, 'success');

            // Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Supabase
            console.log('ğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Supabase: Table Editor â†’ tracking_logs');

        } else {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„');
            showToast('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„', 'error');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message, 'error');
    }
}

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¬Ø¯Ø§Ù‹ ÙÙŠ Supabase (ØªØªØ¬Ø§ÙˆØ² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©)
async function ultraDirectSave() {
    console.log('ğŸš€ Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± Ø¬Ø¯Ø§Ù‹ ÙÙŠ Supabase...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Supabase
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø¬Ø¯Ø§Ù‹
        const simpleData = {
            operation_type: 'Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±',
            unit_number: 'ULTRA-' + Date.now(),
            property_name: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±',
            description: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ tracking_logs',
            user_name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±'
        };

        console.log('ğŸ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸:', simpleData);

        // Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Supabase
        const { data, error } = await supabaseClient
            .from('tracking_logs')
            .insert([simpleData])
            .select();

        if (error) {
            throw new Error(`Ø®Ø·Ø£ Supabase: ${error.message}`);
        }

        if (data && data[0]) {
            console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!', data[0]);
            showToast(`âœ… Ù†Ø¬Ø­ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±! ID: ${data[0].id}`, 'success');

            // Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ­Ù‚Ù‚
            console.log('ğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Supabase Dashboard â†’ Table Editor â†’ tracking_logs');

            return data[0];
        } else {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', error);
        showToast(`âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: ${error.message}`, 'error');
        return null;
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ø¹ ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„
async function testUnitLinking() {
    console.log('ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ø¹ ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„...');

    try {
        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        console.log('ğŸ“‹ ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:');
        console.log('- properties array:', Array.isArray(properties), 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', properties?.length || 0);
        console.log('- supabaseClient:', typeof supabaseClient !== 'undefined' && supabaseClient !== null);
        console.log('- savePropertyToSupabase:', typeof savePropertyToSupabase === 'function');
        console.log('- addChangeLog:', typeof addChangeLog === 'function');

        if (!Array.isArray(properties) || properties.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ©
        const emptyUnit = properties.find(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] &&
            (!p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === '') &&
            (!p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'].trim() === '')
        );

        if (!emptyUnit) {
            // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø±
            const testUnit = {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'TEST-LINK-' + Date.now(),
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': '',
                'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 100,
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 0,
                'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
            };

            properties.push(testUnit);
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø±:', testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);
        }

        const targetUnit = emptyUnit || properties[properties.length - 1];
        const testContractNumber = 'CONTRACT-TEST-' + Date.now();

        console.log('ğŸ¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©:', {
            unitNumber: targetUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            propertyName: targetUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
            currentTenant: targetUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ÙØ§Ø±Øº',
            currentContract: targetUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù‚Ø¯'
        });

        // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©
        console.log('ğŸ”— Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©...');

        const unitIndex = properties.findIndex(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === targetUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] &&
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === targetUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']
        );

        if (unitIndex === -1) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©');
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        const oldData = { ...properties[unitIndex] };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = testContractNumber;
        properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·';

        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹');

        // 4. Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ ÙÙŠ Supabase
        console.log('â˜ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ ÙÙŠ Supabase...');

        if (typeof savePropertyToSupabase === 'function') {
            const saveResult = await savePropertyToSupabase(properties[unitIndex]);

            if (saveResult) {
                console.log('âœ… Ù†Ø¬Ø­ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase');
                showToast('âœ… Ù†Ø¬Ø­ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase', 'success');
            } else {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase');
                showToast('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase', 'error');
            }
        } else {
            console.error('âŒ Ø¯Ø§Ù„Ø© savePropertyToSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
            showToast('âŒ Ø¯Ø§Ù„Ø© savePropertyToSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'error');
        }

        // 5. Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹
        console.log('ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹...');

        if (typeof addChangeLog === 'function') {
            try {
                await addChangeLog('Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· ÙˆØ­Ø¯Ø©', properties[unitIndex], oldData, {
                    operation: 'test_link_unit',
                    unitNumber: targetUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                    contractNumber: testContractNumber,
                    propertyName: targetUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
                });
                console.log('âœ… Ù†Ø¬Ø­ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹');
                showToast('âœ… Ù†Ø¬Ø­ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹', 'success');
            } catch (logError) {
                console.error('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹:', logError);
                showToast('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹: ' + logError.message, 'error');
            }
        } else {
            console.error('âŒ Ø¯Ø§Ù„Ø© addChangeLog ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }

        // 6. Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // 7. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        initializeApp();

        console.log('ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        showToast(`ğŸ‰ ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${targetUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ø¨Ø§Ù„Ø¹Ù‚Ø¯ ${testContractNumber}`, 'success');

        return {
            success: true,
            unitNumber: targetUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            contractNumber: testContractNumber,
            propertyName: targetUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', error);
        showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ' + error.message, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase
async function quickTestUnitLinkingSave() {
    console.log('âš¡ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø±
        const testUnitData = {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'QUICK-TEST-' + Date.now(),
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'CONTRACT-QUICK-' + Date.now(),
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 2000,
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 120,
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
        };

        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testUnitData);

        // Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ©
        const result = await saveUnitLinkingToSupabase(testUnitData, 'link');

        if (result) {
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹!', result);
            showToast(`âœ… Ù†Ø¬Ø­ Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase! ID: ${result.id}`, 'success');

            // Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ­Ù‚Ù‚
            console.log('ğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Supabase Dashboard â†’ Table Editor â†’ properties');

            return { success: true, result: result };
        } else {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ø­ÙØ¸');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹:', error);
        showToast(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ù† Supabase
async function quickTestUnitUnlinkingSave() {
    console.log('âš¡ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const linkedUnit = properties.find(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] &&
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'].trim() !== '' &&
            p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] &&
            p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== ''
        );

        let testUnitData;

        if (linkedUnit) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
            testUnitData = { ...linkedUnit };
            console.log('ğŸ“‹ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testUnitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);
        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±Ø¨ÙˆØ·Ø© Ø£ÙˆÙ„Ø§Ù‹
            testUnitData = {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'UNLINK-TEST-' + Date.now(),
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„',
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'CONTRACT-UNLINK-' + Date.now(),
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 1800,
                'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 100,
                'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
            };

            // Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø£ÙˆÙ„Ø§Ù‹
            console.log('ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...');
            await saveUnitLinkingToSupabase(testUnitData, 'link');

            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            properties.push(testUnitData);
        }

        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ÙØµÙ„:', {
            unitNumber: testUnitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            propertyName: testUnitData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
            contractNumber: testUnitData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
            tenant: testUnitData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']
        });

        // ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ù…Ø³ØªØ£Ø¬Ø±)
        const unlinkedData = { ...testUnitData };
        unlinkedData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = '';
        unlinkedData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = '';

        console.log('ğŸ”“ Ø¨Ø¯Ø¡ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©...');

        // Ø­ÙØ¸ Ø§Ù„ÙØµÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ©
        const result = await saveUnitLinkingToSupabase(unlinkedData, 'unlink');

        if (result) {
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©!', result);
            showToast(`âœ… Ù†Ø¬Ø­ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${testUnitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} ÙÙŠ Supabase!`, 'success');

            // Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ­Ù‚Ù‚
            console.log('ğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Supabase Dashboard â†’ Table Editor â†’ properties');
            console.log('ğŸ“‹ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©:', testUnitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);
            console.log('ğŸ” ÙŠØ¬Ø¨ Ø£Ù† ØªØ¬Ø¯ contract_number Ùˆ tenant_name ÙØ§Ø±ØºÙŠÙ†');

            return {
                success: true,
                result: result,
                unitNumber: testUnitData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                operation: 'unlink'
            };
        } else {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ø­ÙØ¸');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©:', error);
        showToast(`âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ù„Ø±Ø¨Ø· ÙˆÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
async function comprehensiveUnitLinkingTest() {
    console.log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ø±Ø¨Ø· ÙˆÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    try {
        const testResults = {
            link: false,
            unlink: false,
            tracking: false
        };

        // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·
        console.log('ğŸ”— Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©...');
        const linkResult = await quickTestUnitLinkingSave();

        if (linkResult.success) {
            testResults.link = true;
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·');

            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„
            console.log('ğŸ”“ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©...');
            const unlinkResult = await quickTestUnitUnlinkingSave();

            if (unlinkResult.success) {
                testResults.unlink = true;
                console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„');

                // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
                console.log('ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');
                if (typeof window.trackingLogsManager !== 'undefined') {
                    testResults.tracking = true;
                    console.log('âœ… Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…ØªÙˆÙØ±');
                }
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        const successCount = Object.values(testResults).filter(Boolean).length;
        const totalTests = Object.keys(testResults).length;

        let message = `ğŸ¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„:\n\n`;
        message += `âœ… Ø§Ù„Ø±Ø¨Ø·: ${testResults.link ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„'}\n`;
        message += `âœ… Ø§Ù„ÙØµÙ„: ${testResults.unlink ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„'}\n`;
        message += `âœ… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹: ${testResults.tracking ? 'Ù…ØªÙˆÙØ±' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\n\n`;
        message += `ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${successCount}/${totalTests} Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª`;

        if (successCount === totalTests) {
            message += `\n\nğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª! Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ`;
            showToast('ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø±Ø¨Ø·/ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù†Ø¬Ø­Øª!', 'success');
        } else {
            message += `\n\nâš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„ØªØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Console Ù„Ù„ØªÙØ§ØµÙŠÙ„`;
            showToast('âš ï¸ Ø¨Ø¹Ø¶ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø±Ø¨Ø·/ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙØ´Ù„Øª', 'warning');
        }

        console.log(message);
        alert(message);

        return testResults;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„:', error);
        showToast(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase
async function directUnlinkTest() {
    console.log('ğŸ”“ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© ÙÙŠ Supabase
        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© ÙÙŠ Supabase...');
        const { data: linkedUnits, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .not('contract_number', 'is', null)
            .not('contract_number', 'eq', '')
            .not('tenant_name', 'is', null)
            .not('tenant_name', 'eq', '')
            .limit(1);

        if (searchError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        let targetUnit;

        if (linkedUnits && linkedUnits.length > 0) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
            targetUnit = linkedUnits[0];
            console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø©:', {
                unit_number: targetUnit.unit_number,
                tenant_name: targetUnit.tenant_name,
                contract_number: targetUnit.contract_number
            });
        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
            console.log('â• Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...');
            const testUnitData = {
                unit_number: 'DIRECT-UNLINK-TEST-' + Date.now(),
                property_name: 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±',
                city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„',
                contract_number: 'CONTRACT-UNLINK-' + Date.now(),
                rent_value: 1500,
                area: 90,
                contract_type: 'Ø³ÙƒÙ†ÙŠ',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            const { data: newUnit, error: createError } = await supabaseClient
                .from('properties')
                .insert([testUnitData])
                .select()
                .single();

            if (createError) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø©: ${createError.message}`);
            }

            targetUnit = newUnit;
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:', targetUnit.unit_number);
        }

        // Ø§Ù„Ø¢Ù† ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
        console.log('ğŸ”“ Ø¨Ø¯Ø¡ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©...');

        const unlinkData = {
            tenant_name: '',
            contract_number: '',
            updated_at: new Date().toISOString()
        };

        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙ„:', unlinkData);

        const { data: unlinkedUnit, error: unlinkError } = await supabaseClient
            .from('properties')
            .update(unlinkData)
            .eq('id', targetUnit.id)
            .select()
            .single();

        if (unlinkError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${unlinkError.message}`);
        }

        console.log('âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­!', {
            id: unlinkedUnit.id,
            unit_number: unlinkedUnit.unit_number,
            tenant_name: unlinkedUnit.tenant_name,
            contract_number: unlinkedUnit.contract_number
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (unlinkedUnit.tenant_name === '' && unlinkedUnit.contract_number === '') {
            console.log('ğŸ‰ ØªØ£ÙƒÙŠØ¯: Ø§Ù„ÙˆØ­Ø¯Ø© ØªÙ… ÙØµÙ„Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase');
            showToast(`âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unlinkedUnit.unit_number} Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Supabase!`, 'success');

            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹
            try {
                if (typeof window.trackingLogsManager !== 'undefined') {
                    const trackingData = {
                        operation_type: 'ÙØµÙ„ ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±',
                        unit_number: unlinkedUnit.unit_number,
                        property_name: unlinkedUnit.property_name,
                        description: `ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unlinkedUnit.unit_number} Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Supabase`,
                        user_name: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±'
                    };

                    await window.trackingLogsManager.saveTrackingLogToSupabase(trackingData);
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
                }
            } catch (trackingError) {
                console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹:', trackingError);
            }

            return {
                success: true,
                unit: unlinkedUnit,
                operation: 'direct_unlink'
            };
        } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© - Ø§Ù„Ù‚ÙŠÙ… Ù„Ù… ØªØµØ¨Ø­ ÙØ§Ø±ØºØ©');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙØµÙ„:', error);
        showToast(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙØµÙ„: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
async function checkUnitStatusInSupabase(unitNumber, propertyName) {
    try {
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        console.log(`ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase: ${unitNumber} - ${propertyName}`);

        const { data: unit, error } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName)
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                console.log('âš ï¸ Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Supabase');
                return { exists: false };
            }
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${error.message}`);
        }

        const status = {
            exists: true,
            unit_number: unit.unit_number,
            property_name: unit.property_name,
            tenant_name: unit.tenant_name || '',
            contract_number: unit.contract_number || '',
            is_linked: !!(unit.tenant_name && unit.contract_number),
            updated_at: unit.updated_at
        };

        console.log('ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase:', status);

        return status;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©:', error);
        return { error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ù„Ù„ÙØµÙ„ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
async function comprehensiveUnlinkTest(unitNumber, propertyName) {
    console.log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚...');

    try {
        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„ÙØµÙ„
        console.log('ğŸ“‹ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„ÙØµÙ„...');
        const statusBefore = await checkUnitStatusInSupabase(unitNumber, propertyName);

        if (!statusBefore.exists) {
            throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Supabase');
        }

        if (!statusBefore.is_linked) {
            console.log('âš ï¸ Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·Ø© Ø£ØµÙ„Ø§Ù‹');
            showToast('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·Ø© Ø£ØµÙ„Ø§Ù‹', 'warning');
            return { success: false, reason: 'not_linked' };
        }

        console.log('âœ… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø©ØŒ ÙŠÙ…ÙƒÙ† ÙØµÙ„Ù‡Ø§');

        // 2. ØªÙ†ÙÙŠØ° Ø§Ù„ÙØµÙ„
        console.log('ğŸ”“ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªÙ†ÙÙŠØ° Ø§Ù„ÙØµÙ„...');

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const unitIndex = properties.findIndex(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName && p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );

        if (unitIndex === -1) {
            throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
        }

        // ØªÙ†ÙÙŠØ° Ø§Ù„ÙØµÙ„
        await unlinkUnit(unitNumber, propertyName, statusBefore.contract_number);

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙØµÙ„
        console.log('ğŸ” Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙØµÙ„...');

        // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await new Promise(resolve => setTimeout(resolve, 2000));

        const statusAfter = await checkUnitStatusInSupabase(unitNumber, propertyName);

        if (statusAfter.error) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„ÙØµÙ„: ${statusAfter.error}`);
        }

        // 4. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        console.log('ğŸ“Š Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...');

        const results = {
            before: statusBefore,
            after: statusAfter,
            success: !statusAfter.is_linked,
            changes: {
                tenant_cleared: statusBefore.tenant_name !== statusAfter.tenant_name,
                contract_cleared: statusBefore.contract_number !== statusAfter.contract_number
            }
        };

        console.log('ğŸ“ˆ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„:', results);

        if (results.success) {
            console.log('ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„ÙØµÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„!');
            showToast(`âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase`, 'success');
        } else {
            console.error('âŒ ÙØ´Ù„ Ø§Ù„ÙØµÙ„ - Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø§ Ø²Ø§Ù„Øª Ù…Ø±Ø¨ÙˆØ·Ø©');
            showToast(`âŒ ÙØ´Ù„ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} - Ù…Ø§ Ø²Ø§Ù„Øª Ù…Ø±Ø¨ÙˆØ·Ø©`, 'error');
        }

        return results;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„ÙØµÙ„:', error);
        showToast(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© ÙØµÙ„ Ù…Ø¨Ø³Ø·Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase
async function simpleUnlinkUnit(unitNumber, propertyName) {
    console.log(`ğŸ”“ ÙØµÙ„ Ù…Ø¨Ø³Ø· Ù„Ù„ÙˆØ­Ø¯Ø©: ${unitNumber} - ${propertyName}`);

    try {
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹
        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase...');
        const { data: existingUnit, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName)
            .single();

        if (searchError) {
            if (searchError.code === 'PGRST116') {
                throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Supabase');
            }
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        console.log('ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', {
            id: existingUnit.id,
            unit_number: existingUnit.unit_number,
            tenant_name: existingUnit.tenant_name,
            contract_number: existingUnit.contract_number
        });

        // ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
        console.log('ğŸ”“ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©...');
        const { data: unlinkedUnit, error: unlinkError } = await supabaseClient
            .from('properties')
            .update({
                tenant_name: '',
                contract_number: '',
                updated_at: new Date().toISOString()
            })
            .eq('id', existingUnit.id)
            .select()
            .single();

        if (unlinkError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØµÙ„: ${unlinkError.message}`);
        }

        console.log('âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­:', {
            id: unlinkedUnit.id,
            unit_number: unlinkedUnit.unit_number,
            tenant_name: unlinkedUnit.tenant_name,
            contract_number: unlinkedUnit.contract_number,
            updated_at: unlinkedUnit.updated_at
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­
        if (unlinkedUnit.tenant_name === '' && unlinkedUnit.contract_number === '') {
            console.log('ğŸ‰ ØªØ£ÙƒÙŠØ¯: ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase');
            showToast(`âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase`, 'success');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹
            const localUnitIndex = properties.findIndex(p =>
                p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
            );

            if (localUnitIndex !== -1) {
                properties[localUnitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = '';
                properties[localUnitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = '';
                saveDataLocally();
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹');
            }

            return {
                success: true,
                unit: unlinkedUnit,
                operation: 'simple_unlink'
            };
        } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© - Ø§Ù„Ù‚ÙŠÙ… Ù„Ù… ØªØµØ¨Ø­ ÙØ§Ø±ØºØ©');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø¨Ø³Ø·:', error);
        showToast(`âŒ ÙØ´Ù„ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ­Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
async function testUnlinkExistingUnit() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ ÙˆØ­Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©...');

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø©
        const linkedUnit = properties.find(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] &&
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'].trim() !== '' &&
            p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] &&
            p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== ''
        );

        if (!linkedUnit) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        console.log('ğŸ¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:', {
            unitNumber: linkedUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            propertyName: linkedUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
            tenant: linkedUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'],
            contract: linkedUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']
        });

        // ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©
        const result = await simpleUnlinkUnit(
            linkedUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            linkedUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
        );

        if (result.success) {
            console.log('ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©!');
            showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©!', 'success');
        } else {
            console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©');
            showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
        }

        return result;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', error);
        showToast(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ù…Ø®ØµØµØ© Ù„Ù„ÙØµÙ„ ØªÙ…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
async function saveUnlinkToSupabaseOnly(unitNumber, propertyName) {
    console.log(`ğŸ”’ Ø­ÙØ¸ ÙØµÙ„ Ù…Ø®ØµØµ Ù„Ù„ÙˆØ­Ø¯Ø©: ${unitNumber} - ${propertyName}`);

    try {
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
        const { data: existingUnit, error: searchError } = await supabaseClient
            .from('properties')
            .select('id, unit_number, property_name, tenant_name, contract_number')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName)
            .single();

        if (searchError) {
            if (searchError.code === 'PGRST116') {
                throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Supabase');
            }
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        console.log('ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ÙØµÙ„:', {
            id: existingUnit.id,
            tenant_name: existingUnit.tenant_name,
            contract_number: existingUnit.contract_number
        });

        // ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Supabase ÙÙ‚Ø·
        const { data: unlinkedUnit, error: unlinkError } = await supabaseClient
            .from('properties')
            .update({
                tenant_name: '',
                contract_number: '',
                updated_at: new Date().toISOString()
            })
            .eq('id', existingUnit.id)
            .select()
            .single();

        if (unlinkError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØµÙ„: ${unlinkError.message}`);
        }

        console.log('âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase:', {
            id: unlinkedUnit.id,
            tenant_name: unlinkedUnit.tenant_name,
            contract_number: unlinkedUnit.contract_number,
            updated_at: unlinkedUnit.updated_at
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­
        if (unlinkedUnit.tenant_name === '' && unlinkedUnit.contract_number === '') {
            console.log('ğŸ‰ ØªØ£ÙƒÙŠØ¯: ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase ÙÙ‚Ø·');

            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹
            try {
                if (typeof window.trackingLogsManager !== 'undefined') {
                    const trackingData = {
                        operation_type: 'ÙØµÙ„ ÙˆØ­Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠ',
                        unit_number: unitNumber,
                        property_name: propertyName,
                        description: `ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Supabase`,
                        user_name: 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†'
                    };

                    await window.trackingLogsManager.saveTrackingLogToSupabase(trackingData);
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙØµÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
                }
            } catch (trackingError) {
                console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹:', trackingError);
            }

            return {
                success: true,
                unit: unlinkedUnit,
                operation: 'unlink_supabase_only'
            };
        } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© - Ø§Ù„Ù‚ÙŠÙ… Ù„Ù… ØªØµØ¨Ø­ ÙØ§Ø±ØºØ©');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø®ØµØµ:', error);
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© ÙØµÙ„ Ù…Ø­Ø³Ù†Ø© ØªÙ…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
async function improvedUnlinkUnit(unitNumber, propertyName, contractNumber) {
    console.log(`ğŸ”“ ÙØµÙ„ Ù…Ø­Ø³Ù† Ù„Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}`);

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ØŸ`)) return;

    const unitIndex = properties.findIndex(p =>
        p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
        p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber &&
        p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber
    );

    if (unitIndex !== -1) {
        try {
            // 1. ÙØµÙ„ ÙÙŠ Supabase Ø£ÙˆÙ„Ø§Ù‹
            console.log('ğŸ”’ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ÙØµÙ„ ÙÙŠ Supabase...');
            const supabaseResult = await saveUnlinkToSupabaseOnly(unitNumber, propertyName);

            if (!supabaseResult.success) {
                throw new Error(`ÙØ´Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ: ${supabaseResult.error}`);
            }

            console.log('âœ… Ù†Ø¬Ø­ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ');

            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            console.log('ğŸ“± Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
            properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = '';
            properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = '';

            // 3. Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
            saveDataLocally();

            // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            updateLinkedUnitsDisplay(propertyName, contractNumber);
            updateAvailableUnitsDisplay(propertyName, contractNumber, unitNumber);
            initializeApp();

            // 5. Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            const message = `âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!\n\nâ˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©\nğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`;

            alert(message);
            showToast(`ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­`, 'success');

            console.log('ğŸ‰ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');

        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø³Ù†:', error);
            alert(`âŒ ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`);
            showToast(`ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`, 'error');
        }
    } else {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø©');
    }
}

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙØµÙˆÙ„Ø© Ø­Ø¯ÙŠØ«Ø§Ù‹ (Ù„Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©)
let recentlyUnlinkedUnits = new Set();

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙŠØ©
function protectUnlinkedUnit(unitNumber, propertyName) {
    const unitKey = `${unitNumber}|${propertyName}`;
    recentlyUnlinkedUnits.add(unitKey);
    console.log(`ğŸ”’ ØªÙ… Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©: ${unitKey}`);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚
    setTimeout(() => {
        recentlyUnlinkedUnits.delete(unitKey);
        console.log(`ğŸ”“ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitKey}`);
    }, 5 * 60 * 1000);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø©
function isUnitProtected(unitNumber, propertyName) {
    const unitKey = `${unitNumber}|${propertyName}`;
    return recentlyUnlinkedUnits.has(unitKey);
}

// Ø¯Ø§Ù„Ø© ÙØµÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ©
async function finalImprovedUnlinkUnit(unitNumber, propertyName, contractNumber) {
    console.log(`ğŸ”“ ÙØµÙ„ Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ø­Ø³Ù† Ù„Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}`);

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ØŸ`)) return;

    try {
        // 1. Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
        protectUnlinkedUnit(unitNumber, propertyName);

        // 2. ÙØµÙ„ ÙÙŠ Supabase Ø£ÙˆÙ„Ø§Ù‹
        console.log('ğŸ”’ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ÙØµÙ„ ÙÙŠ Supabase...');
        const supabaseResult = await saveUnlinkToSupabaseOnly(unitNumber, propertyName);

        if (!supabaseResult.success) {
            throw new Error(`ÙØ´Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ: ${supabaseResult.error}`);
        }

        console.log('âœ… Ù†Ø¬Ø­ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ');

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
        console.log('ğŸ“± Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
        const unitIndex = properties.findIndex(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );

        if (unitIndex !== -1) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„ØªØ·Ø§Ø¨Ù‚ Supabase
            properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = '';
            properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = '';

            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
            saveDataLocally();
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
        }

        // 4. Ù…Ù†Ø¹ Ø£ÙŠ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚
        window.preventAutoSave = true;
        setTimeout(() => {
            window.preventAutoSave = false;
            console.log('ğŸ”“ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
        }, 10 * 60 * 1000);

        console.log('ğŸ”’ ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚');

        // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        updateLinkedUnitsDisplay(propertyName, contractNumber);
        updateAvailableUnitsDisplay(propertyName, contractNumber, unitNumber);
        initializeApp();

        // 6. Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const message = `âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­!\n\nâ˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©\nğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©\nğŸ”’ ØªÙ… Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚\nâ° ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚`;

        alert(message);
        showToast(`ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­`, 'success');

        console.log('ğŸ‰ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©');

        return { success: true, protected: true };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø­Ø³Ù†:', error);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`);
        showToast(`ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© wrapper Ù„Ø­Ù…Ø§ÙŠØ© savePropertyToSupabase
const originalSavePropertyToSupabase = window.savePropertyToSupabase;

window.savePropertyToSupabase = async function(property) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    if (window.preventAutoSave) {
        const unitNumber = property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
        const propertyName = property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø©
        if (isUnitProtected(unitNumber, propertyName)) {
            console.log(`ğŸ”’ ØªÙ… Ù…Ù†Ø¹ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ù…ÙŠØ©: ${unitNumber}`);
            return { success: true, skipped: true, reason: 'protected_unit' };
        }
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    if (typeof originalSavePropertyToSupabase === 'function') {
        return await originalSavePropertyToSupabase(property);
    } else {
        console.warn('âš ï¸ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© savePropertyToSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        return { success: false, error: 'Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©' };
    }
};

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù…Ø§ÙŠØ©
function resetUnlinkProtection() {
    window.preventAutoSave = false;
    recentlyUnlinkedUnits.clear();
    console.log('ğŸ”“ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ§Øª');
    showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙØµÙ„', 'info');
}

// Ø¯Ø§Ù„Ø© ÙØµÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø·Ù„Ù‚Ø©
async function absoluteUnlinkUnit(unitNumber, propertyName, contractNumber) {
    console.log(`ğŸ”“ ÙØµÙ„ Ù…Ø·Ù„Ù‚ Ù„Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}`);

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ø³ÙŠÙƒÙˆÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙˆÙ„Ù† ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.`)) return;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!ensurePropertiesLoaded('absoluteUnlinkUnit')) {
        return;
    }

    try {
        // 1. Ø­Ù…Ø§ÙŠØ© Ù…Ø·Ù„Ù‚Ø© Ù„Ù„ÙˆØ­Ø¯Ø©
        protectUnlinkedUnit(unitNumber, propertyName);
        window.preventAutoSave = true;

        console.log('ğŸ”’ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©');

        // 2. ÙØµÙ„ ÙÙŠ Supabase Ù…Ø¨Ø§Ø´Ø±Ø©
        console.log('â˜ï¸ ÙØµÙ„ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Supabase...');

        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©
        const { data: existingUnit, error: searchError } = await supabaseClient
            .from('properties')
            .select('id, unit_number, tenant_name, contract_number')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName)
            .single();

        if (searchError) {
            if (searchError.code === 'PGRST116') {
                throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Supabase');
            }
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${searchError.message}`);
        }

        console.log('ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ÙØµÙ„:', {
            id: existingUnit.id,
            tenant_name: existingUnit.tenant_name,
            contract_number: existingUnit.contract_number
        });

        // ÙØµÙ„ Ù…Ø¨Ø§Ø´Ø±
        const { data: unlinkedUnit, error: unlinkError } = await supabaseClient
            .from('properties')
            .update({
                tenant_name: '',
                contract_number: '',
                updated_at: new Date().toISOString()
            })
            .eq('id', existingUnit.id)
            .select()
            .single();

        if (unlinkError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØµÙ„: ${unlinkError.message}`);
        }

        console.log('âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase:', {
            id: unlinkedUnit.id,
            tenant_name: unlinkedUnit.tenant_name,
            contract_number: unlinkedUnit.contract_number
        });

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        console.log('ğŸ“± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
        const unitIndex = properties.findIndex(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName &&
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber
        );

        if (unitIndex !== -1) {
            properties[unitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = '';
            properties[unitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = '';
            saveDataLocally();
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
        }

        // 4. Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹
        try {
            if (typeof window.trackingLogsManager !== 'undefined') {
                const trackingData = {
                    operation_type: 'ÙØµÙ„ ÙˆØ­Ø¯Ø© Ù…Ø·Ù„Ù‚',
                    unit_number: unitNumber,
                    property_name: propertyName,
                    description: `ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ù…Ø·Ù„Ù‚Ø©`,
                    user_name: 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ù„Ù‚'
                };

                await window.trackingLogsManager.saveTrackingLogToSupabase(trackingData);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙØµÙ„ Ø§Ù„Ù…Ø·Ù„Ù‚');
            }
        } catch (trackingError) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹:', trackingError);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
        try {
            await createTrackingLogsForLinkedUnits(contractNumber, propertyName, unitNumber, 'ÙØµÙ„ ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯');
        } catch (error) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:', error);
        }

        // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        updateLinkedUnitsDisplay(propertyName, contractNumber);
        updateAvailableUnitsDisplay(propertyName, contractNumber, unitNumber);
        initializeApp();

        // 6. Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const message = `âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!\n\nâ˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©\nğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©\nğŸ”’ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©\nâš ï¸ Ù„Ù† ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n\nğŸ’¡ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù…Ø§ÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù…Ø§ÙŠØ©" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©`;

        alert(message);
        showToast(`ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹`, 'success');

        console.log('ğŸ‰ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø·Ù„Ù‚ Ø¨Ù†Ø¬Ø§Ø­');

        return { success: true, absolute: true };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø·Ù„Ù‚:', error);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`);
        showToast(`ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: ${error.message}`, 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
function monitorRewriteAttempts() {
    console.log('ğŸ‘ï¸ Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©...');

    // Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
    const monitorInterval = setInterval(async () => {
        if (recentlyUnlinkedUnits.size === 0) {
            return; // Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø­Ù…ÙŠØ©
        }

        console.log(`ğŸ” ÙØ­Øµ ${recentlyUnlinkedUnits.size} ÙˆØ­Ø¯Ø© Ù…Ø­Ù…ÙŠØ©...`);

        for (const unitKey of recentlyUnlinkedUnits) {
            const [unitNumber, propertyName] = unitKey.split('|');

            try {
                // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Supabase
                const { data: unit, error } = await supabaseClient
                    .from('properties')
                    .select('tenant_name, contract_number, updated_at')
                    .eq('unit_number', unitNumber)
                    .eq('property_name', propertyName)
                    .single();

                if (error) {
                    console.warn(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
                    continue;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø·
                if (unit.tenant_name && unit.tenant_name !== '' && unit.contract_number && unit.contract_number !== '') {
                    console.warn(`ğŸš¨ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ù…ÙŠØ©: ${unitNumber}`);
                    console.warn('ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', {
                        tenant_name: unit.tenant_name,
                        contract_number: unit.contract_number,
                        updated_at: unit.updated_at
                    });

                    // Ø¥Ø¹Ø§Ø¯Ø© ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙˆØ±Ø§Ù‹
                    console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙˆØ±Ø§Ù‹...');

                    const { error: refixError } = await supabaseClient
                        .from('properties')
                        .update({
                            tenant_name: '',
                            contract_number: '',
                            updated_at: new Date().toISOString()
                        })
                        .eq('unit_number', unitNumber)
                        .eq('property_name', propertyName);

                    if (refixError) {
                        console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, refixError);
                        showToast(`âŒ ÙØ´Ù„ ÙÙŠ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`, 'error');
                    } else {
                        console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­`);
                        showToast(`ğŸ”’ ØªÙ… Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø·`, 'warning');

                        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹
                        try {
                            if (typeof window.trackingLogsManager !== 'undefined') {
                                const trackingData = {
                                    operation_type: 'Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø·',
                                    unit_number: unitNumber,
                                    property_name: propertyName,
                                    description: `ØªÙ… Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙˆØ¥Ø¹Ø§Ø¯Ø© ÙØµÙ„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹`,
                                    user_name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ©'
                                };

                                await window.trackingLogsManager.saveTrackingLogToSupabase(trackingData);
                            }
                        } catch (trackingError) {
                            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ù…Ø§ÙŠØ©:', trackingError);
                        }
                    }
                }

            } catch (monitorError) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, monitorError);
            }
        }

    }, 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©

    // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
    window.unlinkMonitorInterval = monitorInterval;

    console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©');
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', () => {
    setTimeout(() => {
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            monitorRewriteAttempts();
        }
    }, 5000); // Ø§Ù†ØªØ¸Ø§Ø± 5 Ø«ÙˆØ§Ù† Ù„ØªØ­Ù…ÙŠÙ„ Supabase
});

// Ø¯Ø§Ù„Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
function stopUnlinkMonitoring() {
    if (window.unlinkMonitorInterval) {
        clearInterval(window.unlinkMonitorInterval);
        window.unlinkMonitorInterval = null;
        console.log('ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©');
        showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ©', 'info');
    }
}

// Ø¯Ø§Ù„Ø© ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù†Ø¸Ø§Ù…
function comprehensiveDiagnosis() {
    console.log('ğŸ” ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');
    console.log('=' .repeat(50));

    // 1. ÙØ­Øµ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    console.log('ğŸ“‹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:');
    console.log('- isTrackingEnabled:', isTrackingEnabled);
    console.log('- changeTrackingLogs.length:', changeTrackingLogs.length);

    // 2. ÙØ­Øµ Ù…ÙƒØªØ¨Ø© Supabase
    console.log('ğŸ“¦ Ù…ÙƒØªØ¨Ø© Supabase:');
    console.log('- supabase Ù…ØªÙˆÙØ±:', typeof supabase !== 'undefined');
    console.log('- supabaseClient Ù…ØªÙˆÙØ±:', typeof supabaseClient !== 'undefined');
    console.log('- supabaseClient Ù‚ÙŠÙ…Ø©:', supabaseClient);

    // 3. ÙØ­Øµ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
    console.log('ğŸ”§ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹:');
    console.log('- trackingLogsManager Ù…ØªÙˆÙØ±:', typeof window.trackingLogsManager !== 'undefined');
    if (typeof window.trackingLogsManager !== 'undefined') {
        console.log('- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØªÙˆÙØ±Ø©:', Object.keys(window.trackingLogsManager));
    }

    // 4. ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    console.log('âš™ï¸ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:');
    console.log('- addChangeLog Ù…ØªÙˆÙØ±:', typeof addChangeLog === 'function');
    console.log('- saveTrackingLogToNewTable Ù…ØªÙˆÙØ±:', typeof saveTrackingLogToNewTable === 'function');

    // 5. ÙØ­Øµ URL Ø§Ù„Ø­Ø§Ù„ÙŠ
    console.log('ğŸŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙØ­Ø©:');
    console.log('- URL:', window.location.href);
    console.log('- Protocol:', window.location.protocol);

    console.log('=' .repeat(50));

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const diagnosis = {
        tracking: isTrackingEnabled,
        supabase: typeof supabaseClient !== 'undefined' && supabaseClient !== null,
        manager: typeof window.trackingLogsManager !== 'undefined',
        functions: typeof addChangeLog === 'function' && typeof saveTrackingLogToNewTable === 'function'
    };

    const issues = [];
    if (!diagnosis.tracking) issues.push('Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø¹Ø·Ù„');
    if (!diagnosis.supabase) issues.push('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
    if (!diagnosis.manager) issues.push('Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù…Ø­Ù…Ù„');
    if (!diagnosis.functions) issues.push('Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');

    if (issues.length === 0) {
        showToast('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
    } else {
        showToast(`âš ï¸ Ù…Ø´Ø§ÙƒÙ„: ${issues.join(', ')}`, 'warning');
    }

    return diagnosis;
}

// ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', async () => {
    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
    setTimeout(async () => {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

        // ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ø£ÙˆÙ„Ø§Ù‹
        const diagnosis = comprehensiveDiagnosis();

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¨Ø¯Ùˆ Ø¬ÙŠØ¯
        if (diagnosis.supabase && diagnosis.manager) {
            const connectionTest = await testTrackingLogsConnection();

            if (connectionTest) {
                console.log('ğŸ‰ Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¬Ø§Ù‡Ø² ÙˆÙŠØ¹Ù…Ù„!');
            } else {
                console.warn('âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
            }
        } else {
            console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ - Ù…ÙƒÙˆÙ†Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©');
        }
    }, 3000); // Ø§Ù†ØªØ¸Ø§Ø± 3 Ø«ÙˆØ§Ù†
});

// ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
let currentPropertiesSearchResults = [];
let originalPropertiesList = [];
let propertiesSearchTimeout = null;

// Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¹ debouncing
function handlePropertiesSearch(searchTerm) {
    const searchInput = document.getElementById('propertiesSearchInput');
    if (!searchInput) return;

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (propertiesSearchTimeout) {
        clearTimeout(propertiesSearchTimeout);
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ Ù„Ù„Ø¨Ø­Ø«
    searchInput.classList.add('search-indicator', 'searching');

    // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ù„Ù€ 250ms Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©
    propertiesSearchTimeout = setTimeout(() => {
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù„ÙŠ
        searchProperties(searchTerm);

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨Ø­Ø«
        searchInput.classList.remove('searching');

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¤Ù‚ØªØ§Ù‹
        if (searchTerm) {
            searchInput.style.borderColor = '#28a745';
            setTimeout(() => {
                searchInput.style.borderColor = '';
            }, 800);
        }
    }, 250);
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function searchProperties(searchTerm) {
    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', searchTerm);

    const searchInput = document.getElementById('propertiesSearchInput');
    const clearBtn = document.querySelector('.clear-search-btn');
    const searchCount = document.getElementById('propertiesSearchCount');
    const searchResultsText = document.getElementById('searchResultsText');

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø³Ø­
    if (searchTerm.length > 0) {
        clearBtn.style.display = 'flex';
    } else {
        clearBtn.style.display = 'none';
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    let allProperties = getUniqueProperties();

    // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ø¯Ø¯Ø§Ù‹
    if (selectedCityFilter !== 'all') {
        allProperties = allProperties.filter(propertyName => {
            const property = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
            return property && property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === selectedCityFilter;
        });
    }

    // Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­ÙÙˆØ¸Ø©
    if (originalPropertiesList.length === 0) {
        originalPropertiesList = [...allProperties];
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
    if (searchTerm.trim() === '') {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« ÙØ§Ø±ØºØ§Ù‹ØŒ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        currentPropertiesSearchResults = [...allProperties];
        searchCount.style.display = 'none';
    } else {
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø©
        const searchTermLower = searchTerm.toLowerCase();
        currentPropertiesSearchResults = allProperties.filter(propertyName => {
            const property = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
            if (!property) return false;

            const propertyNameMatch = propertyName.toLowerCase().includes(searchTermLower);
            const cityMatch = (property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || '').toLowerCase().includes(searchTermLower);

            return propertyNameMatch || cityMatch;
        });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        searchCount.style.display = 'block';
        searchResultsText.textContent = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${currentPropertiesSearchResults.length} Ø¹Ù‚Ø§Ø± Ù…Ù† Ø£ØµÙ„ ${allProperties.length}`;
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    updatePropertiesDisplay();

    console.log(`âœ… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: ${currentPropertiesSearchResults.length} Ø¹Ù‚Ø§Ø±`);
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function clearPropertiesSearch() {
    console.log('ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');

    const searchInput = document.getElementById('propertiesSearchInput');
    const clearBtn = document.querySelector('.clear-search-btn');
    const searchCount = document.getElementById('propertiesSearchCount');

    // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ
    if (searchInput) {
        searchInput.value = '';
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø³Ø­ ÙˆØ¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    if (clearBtn) {
        clearBtn.style.display = 'none';
    }
    if (searchCount) {
        searchCount.style.display = 'none';
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    currentPropertiesSearchResults = [];

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    updatePropertiesDisplay();

    console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
function updatePropertiesDisplay() {
    const propertiesContainer = document.querySelector('.existing-properties');
    if (!propertiesContainer) return;

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡Ø§
    let propertiesToShow;
    if (currentPropertiesSearchResults.length > 0 || document.getElementById('propertiesSearchInput')?.value) {
        propertiesToShow = currentPropertiesSearchResults;
    } else {
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø­Ø³Ø¨ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
        propertiesToShow = getUniqueProperties();
        if (selectedCityFilter !== 'all') {
            propertiesToShow = propertiesToShow.filter(propertyName => {
                const property = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);
                return property && property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] === selectedCityFilter;
            });
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    if (propertiesToShow.length > 0) {
        propertiesContainer.innerHTML = propertiesToShow.map(property => {
            const propertyData = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === property);
            const cityName = propertyData ? propertyData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            return `
                <div class="property-item">
                    <div class="property-info">
                        <div class="property-name">${property}</div>
                        <div class="property-city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${cityName}</div>
                    </div>
                    <div class="property-actions">
                        <button onclick="showPropertyStatistics('${property}')" class="stats-btn">
                            <i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                        </button>
                        <button onclick="deleteProperty('${property}')" class="delete-btn">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        const searchTerm = document.getElementById('propertiesSearchInput')?.value || '';
        if (searchTerm) {
            propertiesContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h4>
                    <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù‚Ø§Ø±Ø§Øª ØªØ·Ø§Ø¨Ù‚ "${searchTerm}"</p>
                    <button onclick="clearPropertiesSearch()" class="clear-search-btn-large">
                        <i class="fas fa-times"></i> Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
                    </button>
                </div>
            `;
        } else {
            propertiesContainer.innerHTML = `
                <div class="no-properties">
                    <i class="fas fa-building"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</p>
                </div>
            `;
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙ„ØªØ±
    updateFilterInfo(propertiesToShow.length);
}

// ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙ„ØªØ±
function updateFilterInfo(count) {
    const filterInfo = document.querySelector('.filter-info');
    if (!filterInfo) return;

    const searchTerm = document.getElementById('propertiesSearchInput')?.value || '';

    if (searchTerm) {
        filterInfo.innerHTML = `<span class="filter-badge search">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: ${count} Ø¹Ù‚Ø§Ø±</span>`;
    } else if (selectedCityFilter === 'all') {
        filterInfo.innerHTML = `<span class="filter-badge all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù† (${count} Ø¹Ù‚Ø§Ø±)</span>`;
    } else {
        filterInfo.innerHTML = `<span class="filter-badge filtered">Ù…Ø¯ÙŠÙ†Ø© ${selectedCityFilter} (${count} Ø¹Ù‚Ø§Ø±)</span>`;
    }
}

// ===== Ù†Ù‡Ø§ÙŠØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// ===== Ù†Ø¸Ø§Ù… Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø­Ø³Ù† Ù…Ø¹ Supabase =====

// Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
let isSyncing = false;
let lastSyncTime = null;
let syncRetryCount = 0;
const MAX_SYNC_RETRIES = 3;

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¹ Supabase
async function syncToSupabase(showProgress = true) {
    if (isSyncing) {
        console.log('â³ Ø¹Ù…Ù„ÙŠØ© Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„...');
        return { success: false, message: 'Ø¹Ù…Ù„ÙŠØ© Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„' };
    }

    console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Supabase...');
    isSyncing = true;

    let progressModal = null;

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
        if (showProgress) {
            progressModal = showSyncProgress();
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Supabase
        if (!supabaseClient) {
            throw new Error('Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…ØªØ§Ø­');
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
        updateSyncProgress(progressModal, 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 10);

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        const dataToSync = prepareDataForSync();

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        updateSyncProgress(progressModal, 'Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...', 30);
        const mainDataResult = await syncMainData(dataToSync.properties);

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
        updateSyncProgress(progressModal, 'Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...', 60);
        const logsResult = await syncTrackingLogs(dataToSync.trackingLogs);

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
        updateSyncProgress(progressModal, 'Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...', 80);
        const attachmentsResult = await syncAttachments(dataToSync.attachments);

        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        updateSyncProgress(progressModal, 'ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', 100);

        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©
        lastSyncTime = new Date();
        syncRetryCount = 0;

        // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        if (progressModal) {
            setTimeout(() => {
                progressModal.remove();
            }, 2000);
        }

        console.log('âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');

        return {
            success: true,
            message: 'ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­',
            results: {
                mainData: mainDataResult,
                logs: logsResult,
                attachments: attachmentsResult
            }
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Supabase:', error);

        // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
        if (progressModal) {
            progressModal.remove();
        }

        // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
        syncRetryCount++;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        showSyncError(error, syncRetryCount < MAX_SYNC_RETRIES);

        return {
            success: false,
            message: error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©',
            error: error
        };

    } finally {
        isSyncing = false;
    }
}

// ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
function prepareDataForSync() {
    return {
        properties: properties || [],
        trackingLogs: changeTrackingLogs || [],
        attachments: {
            property: JSON.parse(localStorage.getItem('propertyAttachments') || '{}'),
            card: JSON.parse(localStorage.getItem('cardAttachments') || '{}')
        }
    };
}

// Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
async function syncMainData(propertiesData) {
    console.log('ğŸ“Š Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...');

    if (!propertiesData || propertiesData.length === 0) {
        console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
        return { success: true, count: 0 };
    }

    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        await createPropertiesTableIfNotExists();

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø¯Ø±Ø§Ø¬
        const dataToInsert = propertiesData.map((property, index) => {
            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ù…Ø³Ø·Ø­ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const flattenedProperty = {
                id: property.id || generateUUID(),
                property_name: property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || '',
                city: property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || '',
                unit_number: property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '',
                tenant_name: property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
                contract_number: property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '',
                rent_value: property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || 0,
                start_date: property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] || null,
                end_date: property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || null,
                total_amount: property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || 0,
                area: property['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || null,
                deed_number: property['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || null,
                deed_area: property['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || null,
                registry_number: property['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || null,
                real_estate_registry: property['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || null, // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                owner_name: property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || null,
                owner: property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || null, // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                property_location: property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || null,
                contract_type: property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø³ÙƒÙ†ÙŠ',
                remaining_installments: property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] || null,
                last_update: property['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || new Date().toLocaleDateString('ar-SA'),
                raw_data: JSON.stringify(property), // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙƒÙ€ JSON
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            return flattenedProperty;
        });

        // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        try {
            const { error: deleteError } = await supabaseClient
                .from('properties')
                .delete()
                .neq('id', '');

            if (deleteError && !deleteError.message.includes('does not exist')) {
                console.warn('âš ï¸ ØªØ­Ø°ÙŠØ± ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:', deleteError);
            }
        } catch (deleteErr) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:', deleteErr.message);
        }

        // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        const { data, error } = await supabaseClient
            .from('properties')
            .insert(dataToInsert);

        if (error) {
            throw error;
        }

        console.log(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${propertiesData.length} Ø¹Ù‚Ø§Ø±`);
        return { success: true, count: propertiesData.length };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:', error);

        // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ØŒ Ø¬Ø±Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
        if (error.message.includes('does not exist') || error.message.includes('column')) {
            console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
            try {
                await createPropertiesTableAlternative();
                return await syncMainDataAlternative(propertiesData);
            } catch (altError) {
                console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©:', altError);
                throw altError;
            }
        }

        throw error;
    }
}

// Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
async function syncTrackingLogs(logsData) {
    console.log('ğŸ“‹ Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    if (!logsData || logsData.length === 0) {
        console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
        return { success: true, count: 0 };
    }

    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        const { data: existingLogs } = await supabaseClient
            .from('change_logs')
            .select('id');

        const existingIds = new Set(existingLogs?.map(log => log.id) || []);

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
        const newLogs = logsData.filter(log => !existingIds.has(log.id));

        if (newLogs.length > 0) {
            const { error } = await supabaseClient
                .from('change_logs')
                .insert(newLogs);

            if (error) {
                throw error;
            }

            console.log(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${newLogs.length} Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø¬Ø¯ÙŠØ¯`);
        } else {
            console.log('â„¹ï¸ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ø¯Ø«Ø©');
        }

        return { success: true, count: newLogs.length };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹:', error);
        throw error;
    }
}

// Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
async function syncAttachments(attachmentsData) {
    console.log('ğŸ“ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');

    try {
        let syncCount = 0;

        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        if (attachmentsData.property && Object.keys(attachmentsData.property).length > 0) {
            const { error: propError } = await supabaseClient
                .from('attachments')
                .upsert({
                    id: 'property_attachments',
                    type: 'property',
                    data: attachmentsData.property,
                    updated_at: new Date().toISOString()
                });

            if (propError) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', propError);
            } else {
                syncCount++;
            }
        }

        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        if (attachmentsData.card && Object.keys(attachmentsData.card).length > 0) {
            const { error: cardError } = await supabaseClient
                .from('attachments')
                .upsert({
                    id: 'card_attachments',
                    type: 'card',
                    data: attachmentsData.card,
                    updated_at: new Date().toISOString()
                });

            if (cardError) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª:', cardError);
            } else {
                syncCount++;
            }
        }

        console.log(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${syncCount} Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª`);
        return { success: true, count: syncCount };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', error);
        throw error;
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
function showSyncProgress() {
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.style.zIndex = '10001';

    progressModal.innerHTML = `
        <div class="modal-box sync-progress-modal">
            <div class="sync-progress-header">
                <h3><i class="fas fa-cloud-upload-alt"></i> Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            </div>

            <div class="sync-progress-content">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="syncProgressFill"></div>
                    </div>
                    <div class="progress-percentage" id="syncProgressPercentage">0%</div>
                </div>

                <div class="progress-status" id="syncProgressStatus">
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                </div>

                <div class="sync-details">
                    <div class="sync-step">
                        <i class="fas fa-database"></i>
                        <span>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</span>
                        <i class="fas fa-clock sync-step-status" id="mainDataStatus"></i>
                    </div>
                    <div class="sync-step">
                        <i class="fas fa-history"></i>
                        <span>Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹</span>
                        <i class="fas fa-clock sync-step-status" id="logsStatus"></i>
                    </div>
                    <div class="sync-step">
                        <i class="fas fa-paperclip"></i>
                        <span>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</span>
                        <i class="fas fa-clock sync-step-status" id="attachmentsStatus"></i>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(progressModal);
    return progressModal;
}

// ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
function updateSyncProgress(progressModal, status, percentage) {
    if (!progressModal) return;

    const progressFill = progressModal.querySelector('#syncProgressFill');
    const progressPercentage = progressModal.querySelector('#syncProgressPercentage');
    const progressStatus = progressModal.querySelector('#syncProgressStatus');

    if (progressFill) {
        progressFill.style.width = `${percentage}%`;
    }

    if (progressPercentage) {
        progressPercentage.textContent = `${percentage}%`;
    }

    if (progressStatus) {
        progressStatus.textContent = status;
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·ÙˆØ§Øª
    if (percentage >= 30) {
        const mainDataStatus = progressModal.querySelector('#mainDataStatus');
        if (mainDataStatus) {
            mainDataStatus.className = 'fas fa-check sync-step-status completed';
        }
    }

    if (percentage >= 60) {
        const logsStatus = progressModal.querySelector('#logsStatus');
        if (logsStatus) {
            logsStatus.className = 'fas fa-check sync-step-status completed';
        }
    }

    if (percentage >= 80) {
        const attachmentsStatus = progressModal.querySelector('#attachmentsStatus');
        if (attachmentsStatus) {
            attachmentsStatus.className = 'fas fa-check sync-step-status completed';
        }
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø®Ø·Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© - Ù…Ø¹Ø·Ù„
function showSyncError(error, canRetry = true) {
    // ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    console.log('ğŸ”‡ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
    return;

    /* Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹Ø·Ù„
    const errorModal = document.createElement('div');
    errorModal.className = 'modal-overlay';
    errorModal.style.display = 'flex';
    errorModal.style.zIndex = '10002';

    errorModal.innerHTML = `
        <div class="modal-box sync-error-modal">
            <div class="sync-error-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h3>
            </div>

            <div class="sync-error-content">
                <div class="error-message">
                    <p><strong>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:</strong></p>
                    <div class="error-details">
                        ${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                    </div>
                </div>

                <div class="error-info">
                    <p><i class="fas fa-info-circle"></i> ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ³ØªØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„</p>
                </div>

                <div class="sync-error-actions">
                    ${canRetry ? `
                        <button onclick="retrySyncToSupabase()" class="retry-btn">
                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    ` : ''}
                    <button onclick="closeSyncError()" class="close-error-btn">
                        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(errorModal);

    // Ø­ÙØ¸ Ù…Ø±Ø¬Ø¹ Ù„Ù„Ù†Ø§ÙØ°Ø©
    window.currentSyncErrorModal = errorModal;
    */
}

// Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
async function retrySyncToSupabase() {
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø·Ø£
    closeSyncError();

    // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    await syncToSupabase(true);
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø®Ø·Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
function closeSyncError() {
    if (window.currentSyncErrorModal) {
        window.currentSyncErrorModal.remove();
        window.currentSyncErrorModal = null;
    }
}

// Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function autoSyncAfterEdit(operation = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª') {
    console.log(`ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ ${operation}...`);

    // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
    setTimeout(async () => {
        try {
            const result = await syncToSupabase(false); // Ø¨Ø¯ÙˆÙ† Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù…

            if (result.success) {
                console.log('âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'success');
            } else {
                console.warn('âš ï¸ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:', result.message);
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø³ØªØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'warning');
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:', error);
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·', 'warning');
        }
    }, 1000);
}

// ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Supabase
async function checkSupabaseConnection() {
    try {
        if (!supabaseClient) {
            return { connected: false, error: 'Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…ØªØ§Ø­' };
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„Ø§ØªØµØ§Ù„
        const { data, error } = await supabaseClient
            .from('properties')
            .select('count')
            .limit(1);

        if (error) {
            return { connected: false, error: error.message };
        }

        return { connected: true };

    } catch (error) {
        return { connected: false, error: error.message };
    }
}

// ===== Ù†Ù‡Ø§ÙŠØ© Ù†Ø¸Ø§Ù… Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø­Ø³Ù† Ù…Ø¹ Supabase =====

// ===== ÙˆØ¸ÙŠÙØ© Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„ÙˆØ¸ÙŠÙØ© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
async function testPropertyEditFunction() {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const testProperty = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].trim() !== '');

        if (!testProperty) {
            console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            return;
        }

        const originalPropertyName = testProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        console.log(`ğŸ¢ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±: ${originalPropertyName}`);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø±
        const testData = {
            name: originalPropertyName + ' - Ù…Ø­Ø¯Ø«',
            city: testProperty['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            deed: 'TEST_DEED_' + Date.now(),
            area: '500',
            registry: 'TEST_REG_' + Date.now(),
            owner: 'Ù…Ø§Ù„Ùƒ Ø§Ø®ØªØ¨Ø§Ø±',
            location: 'https://maps.google.com/test'
        };

        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testData);

        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
        const originalData = { ...testProperty };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const relatedProperties = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName);
        relatedProperties.forEach(property => {
            property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] = testData.name;
            property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] = testData.city;
            property['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] = testData.deed;
            property['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] = testData.area;
            property['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] = testData.registry;
            property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = testData.owner;
            property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] = testData.location;
            property['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
        });

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹
        const changes = {
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': {
                fieldName: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±',
                old: originalPropertyName,
                new: testData.name
            },
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': {
                fieldName: 'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ',
                old: originalData['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || '',
                new: testData.deed
            },
            'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': {
                fieldName: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙƒ',
                old: originalData['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || '',
                new: testData.area
            }
        };

        const changeLog = createChangeLog(
            OPERATION_TYPES.EDIT_DATA,
            {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': testProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'Ø§Ø®ØªØ¨Ø§Ø±',
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': testData.name,
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': testProperty['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''
            },
            changes,
            {
                affectedUnits: relatedProperties.length,
                originalPropertyName: originalPropertyName,
                testMode: true
            }
        );

        changeTrackingLogs.push(changeLog);

        // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹
        try {
            localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹');
        } catch (error) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase
        console.log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase...');
        const syncResult = await syncToSupabase(true);

        if (syncResult.success) {
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase');
            showToast('Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'success');
        } else {
            console.warn('âš ï¸ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', syncResult.message);
            showToast('Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'warning');
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
        setTimeout(() => {
            console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©...');
            relatedProperties.forEach(property => {
                property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] = originalPropertyName;
                property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] = originalData['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'];
                property['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] = originalData['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'];
                property['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] = originalData['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'];
                property['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] = originalData['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '];
                property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = originalData['Ø§Ù„Ù…Ø§Ù„Ùƒ'];
                property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] = originalData['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'];
            });

            saveDataLocally();
            renderData();
            console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©');
        }, 5000);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderData();
        updateTotalStats();

        console.log('ğŸ‰ Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');

        return {
            success: true,
            message: 'Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª',
            syncResult: syncResult
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', error);
        showToast('ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: ' + error.message, 'error');

        return {
            success: false,
            message: error.message,
            error: error
        };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.testPropertyEdit = testPropertyEditFunction;

// ===== Ù†Ù‡Ø§ÙŠØ© ÙˆØ¸ÙŠÙØ© Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// ===== ÙˆØ¸ÙŠÙØ© ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ù„Ù…Ø´Ø§ÙƒÙ„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function diagnosePropertyEditIssues() {
    console.log('ğŸ” Ø¨Ø¯Ø¡ ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    const diagnostics = {
        timestamp: new Date().toISOString(),
        functions: {},
        data: {},
        supabase: {},
        localStorage: {}
    };

    // ÙØ­Øµ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    diagnostics.functions.savePropertyChanges = typeof savePropertyChanges === 'function';
    diagnostics.functions.handleSavePropertyChanges = typeof handleSavePropertyChanges === 'function';
    diagnostics.functions.editPropertyData = typeof editPropertyData === 'function';
    diagnostics.functions.showToast = typeof showToast === 'function';
    diagnostics.functions.syncToSupabase = typeof syncToSupabase === 'function';
    diagnostics.functions.createChangeLog = typeof createChangeLog === 'function';
    diagnostics.functions.saveDataLocally = typeof saveDataLocally === 'function';

    // ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    diagnostics.data.propertiesArray = Array.isArray(properties);
    diagnostics.data.propertiesCount = properties ? properties.length : 0;
    diagnostics.data.changeTrackingLogs = Array.isArray(changeTrackingLogs);
    diagnostics.data.operationTypes = typeof OPERATION_TYPES === 'object';

    // ÙØ­Øµ Supabase
    diagnostics.supabase.client = typeof supabaseClient !== 'undefined' && supabaseClient !== null;
    diagnostics.supabase.url = typeof supabaseUrl !== 'undefined';
    diagnostics.supabase.key = typeof supabaseKey !== 'undefined';

    // ÙØ­Øµ localStorage
    try {
        diagnostics.localStorage.available = typeof localStorage !== 'undefined';
        diagnostics.localStorage.propertiesData = localStorage.getItem('propertiesData') !== null;
        diagnostics.localStorage.changeTrackingLogs = localStorage.getItem('changeTrackingLogs') !== null;
    } catch (error) {
        diagnostics.localStorage.error = error.message;
    }

    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ´Ø®ÙŠØµ:', diagnostics);

    // ÙØ­Øµ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (properties && properties.length > 0) {
        const sampleProperty = properties[0];
        console.log('ğŸ“‹ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', {
            propertyName: sampleProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
            city: sampleProperty['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'],
            unitNumber: sampleProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            keys: Object.keys(sampleProperty).slice(0, 10)
        });
    }

    // Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© showToast
    if (diagnostics.functions.showToast) {
        showToast('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµ - ØªØ¹Ù…Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'info');
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
    const issues = [];

    if (!diagnostics.functions.savePropertyChanges) {
        issues.push('ÙˆØ¸ÙŠÙØ© savePropertyChanges ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    }

    if (!diagnostics.functions.showToast) {
        issues.push('ÙˆØ¸ÙŠÙØ© showToast ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    }

    if (!diagnostics.data.propertiesArray) {
        issues.push('Ù…ØµÙÙˆÙØ© properties ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    }

    if (!diagnostics.supabase.client) {
        issues.push('Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…ØªØ§Ø­');
    }

    if (!diagnostics.localStorage.available) {
        issues.push('localStorage ØºÙŠØ± Ù…ØªØ§Ø­');
    }

    if (issues.length > 0) {
        console.error('âŒ Ù…Ø´Ø§ÙƒÙ„ ØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡Ø§:', issues);
        console.error(`ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${issues.length} Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…`);
    } else {
        console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        console.log('Ø¬Ù…ÙŠØ¹ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
    }

    return diagnostics;
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.diagnosePropertyEditIssues = diagnosePropertyEditIssues;

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ´Ø®ÙŠØµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        console.log('ğŸ”„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
        diagnosePropertyEditIssues();
    }, 2000);
});

// ===== Ù†Ù‡Ø§ÙŠØ© ÙˆØ¸ÙŠÙØ© ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// ===== Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø³Ø· Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø³Ø· Ù„ÙˆØ¸ÙŠÙØ© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function simplePropertyEditTest() {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ø· Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        if (!properties || properties.length === 0) {
            console.error('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            return false;
        }

        const testProperty = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].trim() !== '');
        if (!testProperty) {
            console.error('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            return false;
        }

        const originalPropertyName = testProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        console.log(`ğŸ¢ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±: ${originalPropertyName}`);

        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const originalData = { ...testProperty };
        const testUpdates = {
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': 'TEST_DEED_' + Date.now(),
            'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': '500',
            'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'Ù…Ø§Ù„Ùƒ Ø§Ø®ØªØ¨Ø§Ø± - ' + new Date().toLocaleString('ar-SA')
        };

        console.log('ğŸ“ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:', testUpdates);

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        const relatedProperties = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName);
        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« ${relatedProperties.length} ÙˆØ­Ø¯Ø©...`);

        relatedProperties.forEach(property => {
            Object.keys(testUpdates).forEach(key => {
                property[key] = testUpdates[key];
            });
            property['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
        });

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹...');
        saveDataLocally();

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹
        console.log('ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹...');
        const changes = {};
        Object.keys(testUpdates).forEach(key => {
            changes[key] = {
                fieldName: key,
                old: originalData[key] || '',
                new: testUpdates[key]
            };
        });

        const changeLog = createChangeLog(
            OPERATION_TYPES.EDIT_DATA,
            {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': testProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'Ø§Ø®ØªØ¨Ø§Ø±',
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': originalPropertyName,
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': testProperty['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''
            },
            changes,
            {
                affectedUnits: relatedProperties.length,
                testMode: true
            }
        );

        changeTrackingLogs.push(changeLog);

        // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹
        try {
            localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹');
        } catch (error) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase
        console.log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase...');
        syncToSupabase(false)
            .then((result) => {
                if (result.success) {
                    console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase');
                    showToast('Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ø· Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±', 'success');
                } else {
                    console.warn('âš ï¸ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', result.message);
                    showToast('Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'warning');
                }
            })
            .catch((error) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
                showToast('Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'warning');
            });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
        setTimeout(() => {
            console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©...');
            relatedProperties.forEach(property => {
                Object.keys(testUpdates).forEach(key => {
                    property[key] = originalData[key];
                });
            });
            saveDataLocally();
            renderData();
            console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©');
        }, 5000);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderData();
        updateTotalStats();

        console.log('ğŸ‰ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ø· Ø¨Ù†Ø¬Ø§Ø­');
        return true;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ø·:', error);
        showToast('ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ø·: ' + error.message, 'error');
        return false;
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.simplePropertyEditTest = simplePropertyEditTest;

// ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ø· Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// ===== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Supabase (Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù† ÙˆÙ…ÙØµÙ„Ø­)
async function savePropertiesDirectlyToSupabase(propertiesToSave) {
    console.log(`ğŸ’¾ Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ ${propertiesToSave.length} Ø¹Ù‚Ø§Ø± ÙÙŠ Supabase...`);

    if (!supabaseClient) {
        throw new Error('Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…ØªØ§Ø­');
    }

    if (!propertiesToSave || propertiesToSave.length === 0) {
        console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø­ÙØ¸');
        return { success: true, count: 0, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸' };
    }

    try {
        console.log('ğŸ”§ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        const cleanedProperties = sanitizeDataForSave(propertiesToSave);
        console.log(`ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ ${cleanedProperties.length} Ø¹Ù‚Ø§Ø±`);

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
        const dataToSave = [];
        const errors = [];

        for (let i = 0; i < cleanedProperties.length; i++) {
            const property = cleanedProperties[i];

            try {
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ ØµØ­ÙŠØ­ Ù„Ù€ Supabase (YYYY-MM-DD)
                const parseDate = (dateStr) => {
                    if (!dateStr || dateStr === '') return null;
                    try {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠØŒ Ø­ÙˆÙ„Ù‡
                        if (typeof dateStr === 'string' && dateStr.includes('/')) {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                // ØªÙ†Ø³ÙŠÙ‚ DD/MM/YYYY
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]);
                                const year = parseInt(parts[2]);

                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
                                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
                                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Date object Ù„ØªØ¬Ù†Ø¨ ØªÙˆØ§Ø±ÙŠØ® Ù…Ø«Ù„ 31 ÙØ¨Ø±Ø§ÙŠØ±
                                    const testDate = new Date(year, month - 1, day, 12, 0, 0);
                                    if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                                        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© YYYY-MM-DD Ù„Ù€ Supabase
                                        return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                                    }
                                }
                            }
                        }

                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DDØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­ØªÙ‡ ÙˆØ£Ø±Ø¬Ø¹Ù‡
                        if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                            const parts = dateStr.split('-');
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]);
                            const day = parseInt(parts[2]);

                            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                                const testDate = new Date(year, month - 1, day, 12, 0, 0);
                                if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                                    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                                }
                            }
                        }

                        return null;
                    } catch (error) {
                        console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®:', dateStr, error);
                        return null;
                    }
                };

                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¹Ù‚Ø§Ø± (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ UUID)
                const uniqueId = property.id || generateUUID();

                const propertyData = {
                    id: uniqueId,
                    property_name: String(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''),
                    city: String(property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || ''),
                    unit_number: String(property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''),
                    tenant_name: String(property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''),
                    contract_number: String(property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''),
                    rent_value: Number(property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || 0),
                    start_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']),
                    end_date: String(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] || ''),
                    total_amount: Number(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || 0),
                    area: Number(property['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || 0),
                    deed_number: String(property['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'] || ''),
                    deed_area: String(property['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'] || ''),
                    real_estate_registry: String(property['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '] || ''),
                    owner: String(property['Ø§Ù„Ù…Ø§Ù„Ùƒ'] || ''),
                    property_location: String(property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''),
                    contract_type: String(property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø³ÙƒÙ†ÙŠ'),
                    remaining_installments: Number(property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©'] || 0),
                    electricity_account: String(property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'] || ''),
                    height: String(property['Ø§Ù„Ø§Ø±ØªÙØ§Ø¹'] || ''),
                    last_update: new Date().toLocaleDateString('ar-SA'),

                    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
                    installment_count: Number(property['Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'] || 0),
                    first_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„']),
                    first_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] || 0),
                    second_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ']),
                    second_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] || 0),
                    third_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«']),
                    third_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«'] || 0),
                    fourth_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹']),
                    fourth_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹'] || 0),
                    fifth_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³']),
                    fifth_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø®Ø§Ù…Ø³'] || 0),
                    sixth_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³']),
                    sixth_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¯Ø³'] || 0),
                    seventh_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹']),
                    seventh_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ø§Ø¨Ø¹'] || 0),
                    eighth_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†']),
                    eighth_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù…Ù†'] || 0),
                    ninth_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹']),
                    ninth_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ø³Ø¹'] || 0),
                    tenth_installment_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±']),
                    tenth_installment_amount: Number(property['Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø´Ø±'] || 0),
                    installment_end_date: parseDate(property['ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·']),

                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                    raw_data: property,

                    // ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø¸Ø§Ù…
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                dataToSave.push(propertyData);

            } catch (propertyError) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ${i}:`, propertyError);
                errors.push(`Ø§Ù„Ø¹Ù‚Ø§Ø± ${i}: ${propertyError.message}`);
            }
        }

        if (dataToSave.length === 0) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: ${errors.join(', ')}`);
        }

        console.log(`ğŸ“ ØªÙ… ØªØ­Ø¶ÙŠØ± ${dataToSave.length} Ø¹Ù‚Ø§Ø± Ù„Ù„Ø­ÙØ¸`);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±...`);

        let updatedCount = 0;
        let insertedCount = 0;
        const updateErrors = [];

        for (const propertyData of dataToSave) {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ unit_number
                const { data: existingProperty, error: checkError } = await supabaseClient
                    .from('properties')
                    .select('id')
                    .eq('unit_number', propertyData.unit_number)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    console.warn(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± ${propertyData.unit_number}:`, checkError);
                }

                if (existingProperty) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    const { error: updateError } = await supabaseClient
                        .from('properties')
                        .update({
                            ...propertyData,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingProperty.id);

                    if (updateError) {
                        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø± ${propertyData.unit_number}:`, updateError);
                        updateErrors.push(`ØªØ­Ø¯ÙŠØ« ${propertyData.unit_number}: ${updateError.message}`);
                    } else {
                        updatedCount++;
                        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyData.unit_number}`);
                    }
                } else {
                    // Ø¥Ø¯Ø±Ø§Ø¬ Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯
                    const { error: insertError } = await supabaseClient
                        .from('properties')
                        .insert([propertyData]);

                    if (insertError) {
                        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù‚Ø§Ø± ${propertyData.unit_number}:`, insertError);
                        updateErrors.push(`Ø¥Ø¯Ø±Ø§Ø¬ ${propertyData.unit_number}: ${insertError.message}`);
                    } else {
                        insertedCount++;
                        console.log(`âœ… ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${propertyData.unit_number}`);
                    }
                }
            } catch (propertyError) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± ${propertyData.unit_number}:`, propertyError);
                updateErrors.push(`Ù…Ø¹Ø§Ù„Ø¬Ø© ${propertyData.unit_number}: ${propertyError.message}`);
            }
        }

        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} Ø¹Ù‚Ø§Ø± ÙˆØ¥Ø¯Ø±Ø§Ø¬ ${insertedCount} Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯`);

        if (updateErrors.length > 0) {
            console.warn(`âš ï¸ Ø­Ø¯Ø«Øª ${updateErrors.length} Ø£Ø®Ø·Ø§Ø¡:`, updateErrors);
        }

        return {
            success: true,
            count: updatedCount + insertedCount,
            updated: updatedCount,
            inserted: insertedCount,
            method: 'individual_update',
            message: `ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} Ø¹Ù‚Ø§Ø± ÙˆØ¥Ø¯Ø±Ø§Ø¬ ${insertedCount} Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯`,
            errors: updateErrors.length > 0 ? updateErrors : null
        };



    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', error);

        // Ø¥Ø±Ø¬Ø§Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        return {
            success: false,
            error: error.message,
            count: 0,
            message: `ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`
        };
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙƒØ±Ø±
async function handleDuplicateKeyError(dataToSave, originalProperties) {
    console.log('ğŸ”§ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙƒØ±Ø±...');

    try {
        let successCount = 0;
        const errors = [];

        // Ø­ÙØ¸ ÙƒÙ„ Ø¹Ù‚Ø§Ø± Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        for (let i = 0; i < dataToSave.length; i++) {
            const propertyData = dataToSave[i];

            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„Ø§Ù‹
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('properties')
                    .update(propertyData)
                    .eq('property_name', propertyData.property_name)
                    .eq('unit_number', propertyData.unit_number);

                if (updateError) {
                    // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø¹ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯
                    propertyData.id = generateUUID();

                    const { data: insertData, error: insertError } = await supabaseClient
                        .from('properties')
                        .insert([propertyData]);

                    if (insertError) {
                        throw insertError;
                    }
                }

                successCount++;

            } catch (itemError) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø± ${i}:`, itemError);
                errors.push(`Ø§Ù„Ø¹Ù‚Ø§Ø± ${i}: ${itemError.message}`);
            }
        }

        if (successCount > 0) {
            console.log(`âœ… ØªÙ… Ø­ÙØ¸ ${successCount} Ø¹Ù‚Ø§Ø± Ù…Ù† Ø£ØµÙ„ ${dataToSave.length}`);
            return {
                success: true,
                count: successCount,
                method: 'duplicate_handled',
                message: `ØªÙ… Ø­ÙØ¸ ${successCount} Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±)`,
                errors: errors.length > 0 ? errors : null
            };
        } else {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: ${errors.join(', ')}`);
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙƒØ±Ø±:', error);
        throw error;
    }
}

// Ø­ÙØ¸ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¨Ø³Ø·
async function saveWithSimplifiedFormat(propertiesToSave) {
    console.log('ğŸ“ Ø­ÙØ¸ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¨Ø³Ø·...');

    try {
        const simplifiedData = propertiesToSave.map((property, index) => ({
            id: generateUUID(),
            property_name: String(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''),
            city: String(property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || ''),
            unit_number: String(property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''),
            tenant_name: String(property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''),
            contract_number: String(property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''),
            rent_value: Number(property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || 0),
            total_amount: Number(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || 0),
            contract_type: String(property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø³ÙƒÙ†ÙŠ'),
            last_update: new Date().toLocaleDateString('ar-SA'),
            raw_data: property,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        }));

        const { data, error } = await supabaseClient
            .from('properties')
            .insert(simplifiedData);

        if (error) {
            throw error;
        }

        console.log(`âœ… ØªÙ… Ø­ÙØ¸ ${propertiesToSave.length} Ø¹Ù‚Ø§Ø± Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ø³Ø·`);
        return {
            success: true,
            count: propertiesToSave.length,
            method: 'simplified',
            message: `ØªÙ… Ø­ÙØ¸ ${propertiesToSave.length} Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ (ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¨Ø³Ø·)`
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ø³Ø·:', error);
        throw error;
    }
}

// Ø·Ø±ÙŠÙ‚Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø­ÙØ¸
async function fallbackSaveMethod(propertiesToSave) {
    console.log('ğŸ†˜ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø­ÙØ¸...');

    try {
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        const backupData = {
            timestamp: new Date().toISOString(),
            properties: propertiesToSave,
            saved: false
        };

        localStorage.setItem('properties_backup_' + Date.now(), JSON.stringify(backupData));

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© Ø¨Ø£Ø¨Ø³Ø· ØªÙ†Ø³ÙŠÙ‚ Ù…Ù…ÙƒÙ†
        const minimalData = propertiesToSave.map((property, index) => ({
            id: generateUUID(),
            property_name: String(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || 'Ø¹Ù‚Ø§Ø± ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
            city: String(property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
            unit_number: String(property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
            raw_data: property
        }));

        const { data, error } = await supabaseClient
            .from('properties')
            .insert(minimalData);

        if (error) {
            throw error;
        }

        console.log(`âœ… ØªÙ… Ø­ÙØ¸ ${propertiesToSave.length} Ø¹Ù‚Ø§Ø± Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©`);
        return {
            success: true,
            count: propertiesToSave.length,
            method: 'fallback',
            message: `ØªÙ… Ø­ÙØ¸ ${propertiesToSave.length} Ø¹Ù‚Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ (Ø·Ø±ÙŠÙ‚Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)`
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);

        return {
            success: false,
            error: error.message,
            count: 0,
            message: `ÙØ´Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø­ÙØ¸: ${error.message}. ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹.`
        };
    }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø­Ø³Ù†)
async function verifyDataSync(propertyName, changes) {
    console.log(`ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}`);

    if (!supabaseClient) {
        throw new Error('Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„ØªØ­Ù‚Ù‚');
    }

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Supabase Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©
        let data, error;

        // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ property_name
        ({ data, error } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('property_name', propertyName)
            .limit(1));

        // Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ raw_data
        if (error || !data || data.length === 0) {
            ({ data, error } = await supabaseClient
                .from('properties')
                .select('*')
                .contains('raw_data', { 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': propertyName })
                .limit(1));
        }

        if (error) {
            throw error;
        }

        if (!data || data.length === 0) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Supabase');
            return {
                success: false,
                message: 'Ø§Ù„Ø¹Ù‚Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Supabase'
            };
        }

        const supabaseRecord = data[0];
        const supabaseProperty = supabaseRecord.raw_data || supabaseRecord;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        let verificationPassed = true;
        const verificationResults = {};

        Object.keys(changes).forEach(fieldKey => {
            const expectedValue = changes[fieldKey].new;
            let actualValue;

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
            if (supabaseProperty[fieldKey] !== undefined) {
                actualValue = supabaseProperty[fieldKey];
            } else if (supabaseRecord[fieldKey] !== undefined) {
                actualValue = supabaseRecord[fieldKey];
            } else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø©
                const fieldMapping = {
                    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'property_name',
                    'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'city',
                    'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': 'deed_number',
                    'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': 'deed_area',
                    'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': 'registry_number',
                    'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': 'real_estate_registry', // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'owner_name',
                    'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'owner', // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': 'property_location'
                };

                const mappedField = fieldMapping[fieldKey];
                if (mappedField && supabaseRecord[mappedField] !== undefined) {
                    actualValue = supabaseRecord[mappedField];
                }
            }

            verificationResults[fieldKey] = {
                expected: expectedValue,
                actual: actualValue,
                match: String(expectedValue) === String(actualValue)
            };

            if (!verificationResults[fieldKey].match) {
                verificationPassed = false;
            }
        });

        if (verificationPassed) {
            console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
        } else {
            console.warn('âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù… ØªØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§:', verificationResults);
        }

        return {
            success: verificationPassed,
            results: verificationResults,
            supabaseData: supabaseRecord
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
async function retryPropertySync(propertyName) {
    console.log(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}`);

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø­Ù„ÙŠØ§Ù‹
        const relatedProperties = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName);

        if (relatedProperties.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø­Ù„ÙŠØ§Ù‹');
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        await savePropertiesDirectlyToSupabase(relatedProperties);

        showToast(`ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        console.log(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}" Ø¨Ù†Ø¬Ø§Ø­`);

        return { success: true };

    } catch (error) {
        console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}":`, error);
        showToast(`ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}": ${error.message}`, 'error');

        return { success: false, error: error.message };
    }
}

// ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
async function checkAllPropertiesSync() {
    console.log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    if (!supabaseClient) {
        console.warn('âš ï¸ Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„ÙØ­Øµ');
        return { success: false, error: 'Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…ØªØ§Ø­' };
    }

    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù† Supabase
        const { data: supabaseData, error } = await supabaseClient
            .from('properties')
            .select('data');

        if (error) {
            throw error;
        }

        const localProperties = getUniqueProperties();
        const supabaseProperties = supabaseData.map(item => item.data['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']).filter(name => name);

        const syncStatus = {
            localCount: localProperties.length,
            supabaseCount: supabaseProperties.length,
            missingInSupabase: localProperties.filter(name => !supabaseProperties.includes(name)),
            extraInSupabase: supabaseProperties.filter(name => !localProperties.includes(name))
        };

        console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', syncStatus);

        if (syncStatus.missingInSupabase.length > 0) {
            console.warn(`âš ï¸ ${syncStatus.missingInSupabase.length} Ø¹Ù‚Ø§Ø± Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ Supabase:`, syncStatus.missingInSupabase);
        }

        return { success: true, status: syncStatus };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
        return { success: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.retryPropertySync = retryPropertySync;
window.checkAllPropertiesSync = checkAllPropertiesSync;
window.savePropertiesDirectlyToSupabase = savePropertiesDirectlyToSupabase;

// ===== Ù†Ù‡Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// ===== ÙˆØ¸ÙŠÙØ© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ù„Ù†Ø¸Ø§Ù… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
async function testPropertyEditSystem() {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    const testModal = document.createElement('div');
    testModal.className = 'modal-overlay';
    testModal.style.display = 'flex';
    testModal.style.zIndex = '10003';
    testModal.innerHTML = `
        <div class="modal-box test-modal">
            <div class="test-header">
                <h3><i class="fas fa-vial"></i> Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h3>
                <button class="close-modal" onclick="closeModal()">Ã—</button>
            </div>
            <div class="test-content">
                <div class="test-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="testProgressFill"></div>
                    </div>
                    <div class="progress-text" id="testProgressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</div>
                </div>

                <div class="test-steps" id="testSteps">
                    <div class="test-step" id="step1">
                        <i class="fas fa-clock step-icon"></i>
                        <span>ÙØ­Øµ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</span>
                        <div class="step-status" id="status1"></div>
                    </div>
                    <div class="test-step" id="step2">
                        <i class="fas fa-clock step-icon"></i>
                        <span>Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase</span>
                        <div class="step-status" id="status2"></div>
                    </div>
                    <div class="test-step" id="step3">
                        <i class="fas fa-clock step-icon"></i>
                        <span>Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±</span>
                        <div class="step-status" id="status3"></div>
                    </div>
                    <div class="test-step" id="step4">
                        <i class="fas fa-clock step-icon"></i>
                        <span>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</span>
                        <div class="step-status" id="status4"></div>
                    </div>
                    <div class="test-step" id="step5">
                        <i class="fas fa-clock step-icon"></i>
                        <span>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span>
                        <div class="step-status" id="status5"></div>
                    </div>
                </div>

                <div class="test-results" id="testResults" style="display: none;">
                    <h4>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</h4>
                    <div id="testResultsContent"></div>
                </div>

                <div class="test-actions">
                    <button id="startTestBtn" onclick="runFullPropertyEditTest()" class="test-action-btn">
                        <i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                    <button onclick="closeModal()" class="test-action-btn secondary">
                        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(testModal);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    testModal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„
async function runFullPropertyEditTest() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„...');

    const startBtn = document.getElementById('startTestBtn');
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...';

    const results = {
        step1: false,
        step2: false,
        step3: false,
        step4: false,
        step5: false,
        details: {}
    };

    try {
        // Ø§Ù„Ø®Ø·ÙˆØ© 1: ÙØ­Øµ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        updateTestStep(1, 'running', 'ÙØ­Øµ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª...');
        updateTestProgress(20, 'ÙØ­Øµ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...');

        const componentsCheck = await checkSystemComponents();
        results.step1 = componentsCheck.success;
        results.details.components = componentsCheck;

        updateTestStep(1, results.step1 ? 'success' : 'error',
            results.step1 ? 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­' : 'ÙØ´Ù„');

        if (!results.step1) {
            throw new Error('ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©');
        }

        // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase
        updateTestStep(2, 'running', 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...');
        updateTestProgress(40, 'Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase...');

        const connectionCheck = await checkSupabaseConnection();
        results.step2 = connectionCheck.connected;
        results.details.connection = connectionCheck;

        updateTestStep(2, results.step2 ? 'success' : 'error',
            results.step2 ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„');

        // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
        updateTestStep(3, 'running', 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ±...');
        updateTestProgress(60, 'Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±...');

        const editTest = await testPropertyEdit();
        results.step3 = editTest.success;
        results.details.edit = editTest;

        updateTestStep(3, results.step3 ? 'success' : 'error',
            results.step3 ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„');

        // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        updateTestStep(4, 'running', 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
        updateTestProgress(80, 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');

        if (results.step2) {
            const syncTest = await syncToSupabase(false);
            results.step4 = syncTest.success;
            results.details.sync = syncTest;
        } else {
            results.step4 = false;
            results.details.sync = { success: false, message: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase' };
        }

        updateTestStep(4, results.step4 ? 'success' : 'warning',
            results.step4 ? 'Ù†Ø¬Ø­Øª' : 'ÙØ´Ù„Øª');

        // Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        updateTestStep(5, 'running', 'Ø§Ù„ØªØ­Ù‚Ù‚...');
        updateTestProgress(100, 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');

        const overallSuccess = results.step1 && results.step3;
        results.step5 = overallSuccess;

        updateTestStep(5, overallSuccess ? 'success' : 'warning', 'Ø§Ù†ØªÙ‡Ù‰');

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        showTestResults(results);

        console.log('âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„:', results);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„:', error);
        updateTestProgress(100, 'ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        showTestResults(results, error);
    } finally {
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
    }
}

// ØªØ­Ø¯ÙŠØ« Ø®Ø·ÙˆØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
function updateTestStep(stepNumber, status, message) {
    const step = document.getElementById(`step${stepNumber}`);
    const icon = step.querySelector('.step-icon');
    const statusDiv = step.querySelector('.step-status');

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    icon.className = status === 'running' ? 'fas fa-spinner fa-spin step-icon' :
                    status === 'success' ? 'fas fa-check step-icon success' :
                    status === 'error' ? 'fas fa-times step-icon error' :
                    'fas fa-exclamation-triangle step-icon warning';

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    statusDiv.textContent = message;
    statusDiv.className = `step-status ${status}`;
}

// ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
function updateTestProgress(percentage, message) {
    const progressFill = document.getElementById('testProgressFill');
    const progressText = document.getElementById('testProgressText');

    if (progressFill) {
        progressFill.style.width = `${percentage}%`;
    }

    if (progressText) {
        progressText.textContent = message;
    }
}

// Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
function showTestResults(results, error = null) {
    const resultsDiv = document.getElementById('testResults');
    const contentDiv = document.getElementById('testResultsContent');

    let html = '';

    if (error) {
        html += `<div class="result-error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}</div>`;
    }

    const overallSuccess = results.step1 && results.step3;
    html += `<div class="result-summary ${overallSuccess ? 'success' : 'warning'}">`;
    html += `<h5>${overallSuccess ? 'âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­' : 'âš ï¸ ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¥Ù„Ù‰ Ø¥ØµÙ„Ø§Ø­Ø§Øª'}</h5>`;
    html += `</div>`;

    html += '<div class="result-details">';
    html += `<p><strong>Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</strong> ${results.step1 ? 'âœ… Ø³Ù„ÙŠÙ…Ø©' : 'âŒ Ù…Ø´ÙƒÙ„Ø©'}</p>`;
    html += `<p><strong>Ø§ØªØµØ§Ù„ Supabase:</strong> ${results.step2 ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„'}</p>`;
    html += `<p><strong>ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:</strong> ${results.step3 ? 'âœ… ÙŠØ¹Ù…Ù„' : 'âŒ Ù„Ø§ ÙŠØ¹Ù…Ù„'}</p>`;
    html += `<p><strong>Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:</strong> ${results.step4 ? 'âœ… ØªØ¹Ù…Ù„' : 'âš ï¸ Ù„Ø§ ØªØ¹Ù…Ù„'}</p>`;
    html += '</div>';

    if (!overallSuccess) {
        html += '<div class="result-recommendations">';
        html += '<h5>Ø§Ù„ØªÙˆØµÙŠØ§Øª:</h5>';
        html += '<ul>';
        if (!results.step1) html += '<li>ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª JavaScript</li>';
        if (!results.step2) html += '<li>ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase</li>';
        if (!results.step3) html += '<li>ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</li>';
        if (!results.step4) html += '<li>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</li>';
        html += '</ul>';
        html += '</div>';
    }

    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

// ÙØ­Øµ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
async function checkSystemComponents() {
    const components = {
        properties: Array.isArray(properties),
        savePropertyChanges: typeof savePropertyChanges === 'function',
        editPropertyData: typeof editPropertyData === 'function',
        showToast: typeof showToast === 'function',
        syncToSupabase: typeof syncToSupabase === 'function',
        localStorage: typeof localStorage !== 'undefined'
    };

    const allGood = Object.values(components).every(Boolean);

    return {
        success: allGood,
        components: components,
        message: allGood ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø³Ù„ÙŠÙ…Ø©' : 'Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©'
    };
}

// Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±
async function testPropertyEdit() {
    try {
        if (!properties || properties.length === 0) {
            return { success: false, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±' };
        }

        const testProperty = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'].trim() !== '');
        if (!testProperty) {
            return { success: false, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±' };
        }

        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ø±ÙŠØ± Ø¨Ø³ÙŠØ·
        const originalValue = testProperty['Ø§Ù„Ù…Ø§Ù„Ùƒ'];
        const testValue = 'Ø§Ø®ØªØ¨Ø§Ø± - ' + Date.now();

        testProperty['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = testValue;
        saveDataLocally();

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸
        const savedProperty = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === testProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
        const success = savedProperty && savedProperty['Ø§Ù„Ù…Ø§Ù„Ùƒ'] === testValue;

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        testProperty['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = originalValue;
        saveDataLocally();

        return {
            success: success,
            message: success ? 'ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­' : 'ÙØ´Ù„ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ±'
        };

    } catch (error) {
        return { success: false, message: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.testPropertyEditSystem = testPropertyEditSystem;

// ===== Ù†Ù‡Ø§ÙŠØ© ÙˆØ¸ÙŠÙØ© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ù„Ù†Ø¸Ø§Ù… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª =====

// ===== ÙˆØ¸Ø§Ø¦Ù Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Supabase =====

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ properties Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
async function createPropertiesTableIfNotExists() {
    console.log('ğŸ”§ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ properties...');

    if (!supabaseClient) {
        throw new Error('Ø¹Ù…ÙŠÙ„ Supabase ØºÙŠØ± Ù…ØªØ§Ø­');
    }

    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡
        const { data, error } = await supabaseClient
            .from('properties')
            .select('id')
            .limit(1);

        if (!error) {
            console.log('âœ… Ø¬Ø¯ÙˆÙ„ properties Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
            return { success: true, exists: true };
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø£Ù†Ø´Ø¦Ù‡
        if (error.message.includes('does not exist') || error.message.includes('relation')) {
            console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ properties...');

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… SQL Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const createTableSQL = `
                CREATE TABLE IF NOT EXISTS properties (
                    id TEXT PRIMARY KEY,
                    property_name TEXT,
                    city TEXT,
                    unit_number TEXT,
                    tenant_name TEXT,
                    contract_number TEXT,
                    rent_value NUMERIC DEFAULT 0
                    start_date TEXT,
                    end_date TEXT,
                    total_amount NUMERIC DEFAULT 0,
                    area NUMERIC,
                    deed_number TEXT,
                    deed_area NUMERIC,
                    registry_number TEXT,
                    real_estate_registry TEXT, -- Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    owner_name TEXT,
                    owner TEXT, -- Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    property_location TEXT,
                    contract_type TEXT DEFAULT 'Ø³ÙƒÙ†ÙŠ',
                    remaining_installments INTEGER,
                    last_update TEXT,
                    raw_data JSONB,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );

                -- Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø§Ø±Ø³ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
                CREATE INDEX IF NOT EXISTS idx_properties_name ON properties(property_name);
                CREATE INDEX IF NOT EXISTS idx_properties_city ON properties(city);
                CREATE INDEX IF NOT EXISTS idx_properties_unit ON properties(unit_number);
                CREATE INDEX IF NOT EXISTS idx_properties_tenant ON properties(tenant_name);
            `;

            // ØªÙ†ÙÙŠØ° SQL (Ù‡Ø°Ø§ Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ù…Ø¹ REST APIØŒ Ù„Ø°Ø§ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©)
            console.log('ğŸ“ SQL Ù„Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø§Ù‡Ø²ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©...');

            return { success: true, created: true, sql: createTableSQL };
        }

        // Ø®Ø·Ø£ Ø¢Ø®Ø± ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹
        throw error;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø¯ÙˆÙ„ properties:', error);
        return { success: false, error: error.message };
    }
}

// Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
async function createPropertiesTableAlternative() {
    console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ properties Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©...');

    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¯Ø±Ø§Ø¬ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        const testRecord = {
            id: 'test_record_' + Date.now(),
            property_name: 'Ø¹Ù‚Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ',
            city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            unit_number: 'TEST_001',
            tenant_name: '',
            contract_number: '',
            rent_value: 0,
            start_date: null,
            end_date: null,
            total_amount: 0,
            area: null,
            deed_number: null,
            deed_area: null,
            registry_number: null,
            real_estate_registry: null, // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
            owner_name: null,
            owner: null, // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
            property_location: null,
            contract_type: 'Ø³ÙƒÙ†ÙŠ',
            remaining_installments: null,
            last_update: new Date().toLocaleDateString('ar-SA'),
            raw_data: JSON.stringify({ test: true }),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        const { data, error } = await supabaseClient
            .from('properties')
            .insert([testRecord]);

        if (error) {
            throw error;
        }

        // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ
        await supabaseClient
            .from('properties')
            .delete()
            .eq('id', testRecord.id);

        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ properties Ø¨Ù†Ø¬Ø§Ø­');
        return { success: true };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©:', error);
        throw error;
    }
}

// Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function syncMainDataAlternative(propertiesData) {
    console.log('ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©...');

    try {
        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¨Ø³Ø·
        const simplifiedData = propertiesData.map((property, index) => ({
            id: generateUUID(),
            property_name: String(property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || ''),
            city: String(property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || ''),
            unit_number: String(property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || ''),
            tenant_name: String(property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || ''),
            contract_number: String(property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''),
            rent_value: Number(property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || 0),
            total_amount: Number(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || 0),
            raw_data: property, // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        }));

        // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data, error } = await supabaseClient
            .from('properties')
            .insert(simplifiedData);

        if (error) {
            throw error;
        }

        console.log(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${propertiesData.length} Ø¹Ù‚Ø§Ø± Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©`);
        return { success: true, count: propertiesData.length };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©:', error);
        throw error;
    }
}

// ===== Ù†Ù‡Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Supabase =====

// ===== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =====

// Ø¥Ù†Ø´Ø§Ø¡ UUID Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
function generateUUID() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… crypto.randomUUID() Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        try {
            return crypto.randomUUID();
        } catch (error) {
            console.warn('ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… crypto.randomUUID():', error);
        }
    }

    // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ UUID
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¨Ø³ÙŠØ· Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
function generateSimpleId(prefix = 'item') {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    return `${prefix}_${timestamp}_${random}`;
}

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function fixInvalidIds(data) {
    if (!data || !Array.isArray(data)) return data;

    return data.map(item => {
        if (!item.id || typeof item.id !== 'string' || item.id.includes('fallback_')) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯ ØµØ­ÙŠØ­
            item.id = generateUUID();
        }
        return item;
    });
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
function sanitizeDataForSave(propertiesToSave) {
    if (!propertiesToSave || !Array.isArray(propertiesToSave)) {
        return [];
    }

    return propertiesToSave.map((property, index) => {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const sanitized = {
            ...property,
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || `Ø¹Ù‚Ø§Ø± ${index + 1}`,
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || `ÙˆØ­Ø¯Ø©_${index + 1}`,
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || '',
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': Number(property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || 0),
            'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': Number(property['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] || 0),
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': property['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] || 'Ø³ÙƒÙ†ÙŠ'
        };

        return sanitized;
    });
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ
async function refreshDataAfterPropertyEdit(propertyName) {
    console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±:', propertyName);

    try {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
        const savedData = localStorage.getItem('properties');
        if (savedData) {
            const localProperties = JSON.parse(savedData);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            properties = localProperties;
            console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${properties.length} Ø³Ø¬Ù„ Ù…Ù† localStorage`);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
        if (typeof renderData === 'function') {
            renderData();
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ');
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        if (typeof updateTotalStats === 'function') {
            updateTotalStats();
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
        }

        // ØªØ­Ø¯ÙŠØ« ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        const propertiesTab = document.getElementById('properties-tab');
        if (propertiesTab && typeof renderPropertiesTab === 'function') {
            propertiesTab.innerHTML = renderPropertiesTab();
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
        }

        // ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ù†ÙˆØ§ÙØ° Ù…ÙØªÙˆØ­Ø© Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        const openModals = document.querySelectorAll('.modal-overlay');
        openModals.forEach(modal => {
            const modalContent = modal.querySelector('.unit-details-modal');
            if (modalContent) {
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© ÙØªØ­Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                const unitNumber = modalContent.querySelector('h3')?.textContent?.match(/\d+/)?.[0];
                if (unitNumber) {
                    closeModal();
                    setTimeout(() => {
                        showUnitDetails(unitNumber, propertyName);
                    }, 100);
                }
            }
        });

        console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');

    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    }
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ù†Ø§Ø¬Ø­
function updatePropertyDisplayAfterSave(propertyName, changes) {
    console.log('ğŸ¨ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸...');

    try {
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        const cards = document.querySelectorAll('.property-card');
        cards.forEach(card => {
            const cardPropertyName = card.querySelector('.property-name')?.textContent;
            if (cardPropertyName === propertyName) {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ø¬Ø§Ø­
                card.style.border = '2px solid #28a745';
                card.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.3)';

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
                setTimeout(() => {
                    card.style.border = '';
                    card.style.boxShadow = '';
                }, 3000);

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
                Object.keys(changes).forEach(fieldKey => {
                    const fieldElement = card.querySelector(`[data-field="${fieldKey}"]`);
                    if (fieldElement) {
                        fieldElement.textContent = changes[fieldKey].new;

                        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„ØªØºÙŠÙŠØ±
                        fieldElement.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            fieldElement.style.backgroundColor = '';
                        }, 2000);
                    }
                });
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        updateStatisticsAfterSave();

        // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØµÙÙŠØ©
        updateFiltersAfterSave();

        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');

    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
function updateStatisticsAfterSave() {
    try {
        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸...');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
        const savedData = localStorage.getItem('properties');
        if (savedData) {
            properties = JSON.parse(savedData);
            console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${properties.length} Ø³Ø¬Ù„ Ù…Ù† localStorage`);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        if (typeof renderTotals === 'function' && properties) {
            renderTotals(properties);
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©');
        }

        if (typeof renderMobileTotals === 'function' && properties) {
            renderMobileTotals(properties);
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„');
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (typeof renderTable === 'function' && properties) {
            renderTable(properties);
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ±
        if (typeof updateFilters === 'function') {
            updateFilters();
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ±');
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ù†
        if (typeof updateCityFilter === 'function') {
            updateCityFilter();
        }

    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
    }
}

// ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
function updateFiltersAfterSave() {
    try {
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù†
        const cityFilter = document.getElementById('cityFilter');
        if (cityFilter && typeof populateCityFilter === 'function') {
            populateCityFilter();
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨Ø­Ø«
        const searchInputs = document.querySelectorAll('input[type="search"]');
        searchInputs.forEach(input => {
            if (input.value) {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            }
        });

    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØµÙÙŠØ©:', error);
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ù„Ø­ÙØ¸
function addSaveIndicators(element, status = 'saving') {
    if (!element) return;

    const indicators = {
        saving: {
            icon: 'fas fa-spinner fa-spin',
            color: '#007bff',
            text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'
        },
        success: {
            icon: 'fas fa-check-circle',
            color: '#28a745',
            text: 'ØªÙ… Ø§Ù„Ø­ÙØ¸'
        },
        error: {
            icon: 'fas fa-exclamation-triangle',
            color: '#dc3545',
            text: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸'
        }
    };

    const indicator = indicators[status];
    if (!indicator) return;

    // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸
    let saveIndicator = element.querySelector('.save-indicator');
    if (!saveIndicator) {
        saveIndicator = document.createElement('div');
        saveIndicator.className = 'save-indicator';
        saveIndicator.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: white;
            z-index: 1000;
        `;
        element.style.position = 'relative';
        element.appendChild(saveIndicator);
    }

    saveIndicator.innerHTML = `<i class="${indicator.icon}"></i> ${indicator.text}`;
    saveIndicator.style.backgroundColor = indicator.color;

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ ÙØªØ±Ø© (Ù„Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„Ø®Ø·Ø£)
    if (status !== 'saving') {
        setTimeout(() => {
            if (saveIndicator && saveIndicator.parentNode) {
                saveIndicator.remove();
            }
        }, 3000);
    }
}

// ===== Ù†Ù‡Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =====

// ===== Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ =====

// Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
async function testPropertySavingSolution() {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    const testResults = {
        databaseConnection: false,
        tableStructure: false,
        propertyInsert: false,
        propertyUpdate: false,
        propertyDelete: false,
        saveFunction: false,
        errorHandling: false,
        userInterface: false,
        overallSuccess: false,
        errors: []
    };

    try {
        // 1. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        try {
            const connectionTest = await checkSupabaseConnection();
            testResults.databaseConnection = connectionTest.connected;

            if (!testResults.databaseConnection) {
                testResults.errors.push('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                throw new Error(connectionTest.error);
            }

            console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¹Ù…Ù„');
        } catch (connError) {
            testResults.errors.push(`Ø®Ø·Ø£ Ø§Ù„Ø§ØªØµØ§Ù„: ${connError.message}`);
            console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„:', connError);
        }

        // 2. Ø§Ø®ØªØ¨Ø§Ø± Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        console.log('ğŸ—ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ù‡ÙŠÙƒÙ„ Ø¬Ø¯ÙˆÙ„ properties...');
        try {
            const { data, error } = await supabaseClient
                .from('properties')
                .select('id, property_name, city, unit_number, tenant_name, last_update')
                .limit(1);

            testResults.tableStructure = !error;

            if (error) {
                testResults.errors.push(`Ø®Ø·Ø£ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ${error.message}`);
                throw error;
            }

            console.log('âœ… Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØµØ­ÙŠØ­');
        } catch (structError) {
            testResults.errors.push(`Ø®Ø·Ø£ ÙÙŠ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ${structError.message}`);
            console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„:', structError);
        }

        // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¯Ø±Ø§Ø¬ Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯
        console.log('â• Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¯Ø±Ø§Ø¬ Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯...');
        const testPropertyId = generateUUID();
        const testProperty = {
            id: testPropertyId,
            property_name: 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ù„',
            city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            unit_number: 'TEST_SOLUTION_001',
            tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø±',
            contract_number: 'TEST_C001',
            rent_value: 3000,
            total_amount: 36000,
            contract_type: 'Ø³ÙƒÙ†ÙŠ',
            last_update: new Date().toLocaleDateString('ar-SA'),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        try {
            const { data: insertData, error: insertError } = await supabaseClient
                .from('properties')
                .insert([testProperty]);

            testResults.propertyInsert = !insertError;

            if (insertError) {
                testResults.errors.push(`Ø®Ø·Ø£ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬: ${insertError.message}`);
                throw insertError;
            }

            console.log('âœ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù†Ø¬Ø­');
        } catch (insertErr) {
            testResults.errors.push(`ÙØ´Ù„ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬: ${insertErr.message}`);
            console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬:', insertErr);
        }

        // 4. Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±
        console.log('âœï¸ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±...');
        try {
            const { data: updateData, error: updateError } = await supabaseClient
                .from('properties')
                .update({
                    tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø­Ø¯Ø«',
                    rent_value: 3500,
                    last_update: new Date().toLocaleDateString('ar-SA'),
                    updated_at: new Date().toISOString()
                })
                .eq('id', testPropertyId);

            testResults.propertyUpdate = !updateError;

            if (updateError) {
                testResults.errors.push(`Ø®Ø·Ø£ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${updateError.message}`);
                throw updateError;
            }

            console.log('âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø± Ù†Ø¬Ø­');
        } catch (updateErr) {
            testResults.errors.push(`ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${updateErr.message}`);
            console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«:', updateErr);
        }

        // 5. Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        console.log('ğŸ’¾ Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...');
        try {
            const testPropertyForSave = {
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø¬Ø¯Ø©',
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'SAVE_TEST_001',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø­ÙØ¸',
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'SAVE_C001',
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 4000,
                'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰': 48000,
                'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø±Ø§ÙƒØ¶'
            };

            const saveResult = await savePropertiesDirectlyToSupabase([testPropertyForSave]);
            testResults.saveFunction = saveResult.success;

            if (!saveResult.success) {
                testResults.errors.push(`Ø®Ø·Ø£ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸: ${saveResult.error || saveResult.message}`);
                throw new Error(saveResult.error || saveResult.message);
            }

            console.log('âœ… ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ØªØ¹Ù…Ù„');
        } catch (saveErr) {
            testResults.errors.push(`ÙØ´Ù„ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸: ${saveErr.message}`);
            console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸:', saveErr);
        }

        // 6. Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        console.log('ğŸ—‘ï¸ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©...');
        try {
            const { data: deleteData, error: deleteError } = await supabaseClient
                .from('properties')
                .delete()
                .in('unit_number', ['TEST_SOLUTION_001', 'SAVE_TEST_001']);

            testResults.propertyDelete = !deleteError;

            if (deleteError) {
                console.warn('âš ï¸ ØªØ­Ø°ÙŠØ± ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©:', deleteError);
            } else {
                console.log('âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
            }
        } catch (deleteErr) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©:', deleteErr);
        }

        // 7. Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        console.log('ğŸ›¡ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡...');
        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¯Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            const invalidProperty = {
                id: null, // Ù…Ø¹Ø±Ù Ø®Ø§Ø·Ø¦
                property_name: null, // Ø§Ø³Ù… Ø®Ø§Ø·Ø¦
                city: '',
                unit_number: ''
            };

            const errorTestResult = await savePropertiesDirectlyToSupabase([invalidProperty]);

            // Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø­ÙØ¸ Ø±ØºÙ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØªØ¹Ù…Ù„
            testResults.errorHandling = true;
            console.log('âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');

        } catch (errorTestErr) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŒ ÙÙ‡Ø°Ø§ Ø¬ÙŠØ¯ Ø£ÙŠØ¶Ø§Ù‹
            testResults.errorHandling = true;
            console.log('âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØªØ¹Ù…Ù„ (ÙØ´Ù„ Ù…ØªÙˆÙ‚Ø¹)');
        }

        // 8. Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.log('ğŸ¨ Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const saveButtons = document.querySelectorAll('[onclick*="savePropertyChanges"]');
            const editButtons = document.querySelectorAll('[onclick*="editProperty"]');

            testResults.userInterface = saveButtons.length > 0 && editButtons.length > 0;

            if (testResults.userInterface) {
                console.log('âœ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            } else {
                testResults.errors.push('ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                console.warn('âš ï¸ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ­Ø¯ÙŠØ«');
            }
        } catch (uiErr) {
            testResults.errors.push(`Ø®Ø·Ø£ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${uiErr.message}`);
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', uiErr);
        }

    } catch (generalError) {
        testResults.errors.push(`Ø®Ø·Ø£ Ø¹Ø§Ù…: ${generalError.message}`);
        console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', generalError);
    }

    // ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
    const criticalTests = [
        testResults.databaseConnection,
        testResults.tableStructure,
        testResults.propertyInsert,
        testResults.propertyUpdate,
        testResults.saveFunction
    ];

    testResults.overallSuccess = criticalTests.every(test => test === true);

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„:', testResults);

    if (testResults.overallSuccess) {
        console.log('ğŸ‰ ØªÙ… Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ù…Ø´Ø§ÙƒÙ„ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        console.log('ğŸ‰ Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!');

        // Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ ÙÙ‚Ø·
        setTimeout(() => {
            console.log(`
                âœ… ØªÙ… Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø¨Ù†Ø¬Ø§Ø­!

                ğŸ”§ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙŠ ØªÙ… Ø­Ù„Ù‡Ø§:
                â€¢ Ø¥ØµÙ„Ø§Ø­ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                â€¢ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙƒØ±Ø±
                â€¢ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
                â€¢ ØªØ­Ø³ÙŠÙ† ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸
                â€¢ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
                â€¢ ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

                ğŸ¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:
                â€¢ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: ÙŠØ¹Ù…Ù„ âœ…
                â€¢ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: ÙŠØ¹Ù…Ù„ âœ…
                â€¢ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: ØªØ¹Ù…Ù„ âœ…
                â€¢ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: ØªØ¹Ù…Ù„ âœ…

                ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ø«Ù‚Ø©!
            `);
        }, 2000);

    } else {
        const failedTests = [];
        if (!testResults.databaseConnection) failedTests.push('Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        if (!testResults.tableStructure) failedTests.push('Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
        if (!testResults.propertyInsert) failedTests.push('Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
        if (!testResults.propertyUpdate) failedTests.push('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
        if (!testResults.saveFunction) failedTests.push('ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸');

        showToast(`âŒ ÙØ´Ù„ ÙÙŠ: ${failedTests.join(', ')}`, 'error');
        console.error('âŒ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª:', failedTests);

        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ ÙÙ‚Ø·
        if (testResults.errors.length > 0) {
            setTimeout(() => {
                console.error(`
                    âŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:

                    ${testResults.errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}

                    ğŸ”§ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.
                `);
            }, 1000);
        }
    }

    return testResults;
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.testPropertySavingSolution = testPropertySavingSolution;

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·
// ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„: testPropertySavingSolution()

// ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ =====

// ===== Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© UUID =====

// Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© UUID
function testUUIDFix() {
    console.log('ğŸ”§ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© UUID...');

    try {
        // Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ UUID
        const uuid1 = generateUUID();
        const uuid2 = generateUUID();
        const simpleId1 = generateSimpleId('test');
        const simpleId2 = generateSimpleId('test');

        console.log('UUID 1:', uuid1);
        console.log('UUID 2:', uuid2);
        console.log('Simple ID 1:', simpleId1);
        console.log('Simple ID 2:', simpleId2);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
        const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        const isUuid1Valid = uuidPattern.test(uuid1);
        const isUuid2Valid = uuidPattern.test(uuid2);

        console.log('UUID 1 ØµØ­ÙŠØ­:', isUuid1Valid);
        console.log('UUID 2 ØµØ­ÙŠØ­:', isUuid2Valid);
        console.log('UUID Ù…Ø®ØªÙ„ÙØ§Ù†:', uuid1 !== uuid2);
        console.log('Simple ID Ù…Ø®ØªÙ„ÙØ§Ù†:', simpleId1 !== simpleId2);

        // Ø§Ø®ØªØ¨Ø§Ø± ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const testData = [
            {
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø±',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': '001'
            },
            {
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': '',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': '',
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': ''
            }
        ];

        const cleanedData = sanitizeDataForSave(testData);
        console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©:', testData);
        console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©:', cleanedData);

        const success = isUuid1Valid && isUuid2Valid && uuid1 !== uuid2 && cleanedData.length === 2;

        if (success) {
            console.log('âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© UUID Ø¨Ù†Ø¬Ø§Ø­!');
            console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª UUID Ù†Ø¬Ø­Øª');
        } else {
            console.error('âŒ Ù…Ø§Ø²Ø§Ù„Øª Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ UUID');
            console.error('âŒ Ø¨Ø¹Ø¶ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª UUID ÙØ´Ù„Øª');
        }

        return success;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± UUID:', error);
        showToast(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± UUID: ${error.message}`, 'error');
        return false;
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.testUUIDFix = testUUIDFix;

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·
// ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„: testUUIDFix()

// ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© UUID =====

// ===== Ø¥ØµÙ„Ø§Ø­ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª =====

// ÙˆØ¸ÙŠÙØ© Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ­
function calculateCorrectUnitsCount(data) {
    if (!data || !Array.isArray(data)) {
        return 0;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
    const uniqueUnits = new Set();

    data.forEach(property => {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
        const propertyName = property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        const unitNumber = property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];

        if (propertyName && unitNumber &&
            propertyName.toString().trim() !== '' &&
            unitNumber.toString().trim() !== '') {

            // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„ÙˆØ­Ø¯Ø©
            const unitKey = `${propertyName.trim()}_${unitNumber.toString().trim()}`;
            uniqueUnits.add(unitKey);
        }
    });

    return uniqueUnits.size;
}

// ÙˆØ¸ÙŠÙØ© Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø§Ù„ØµØ­ÙŠØ­
function calculateCorrectTenantsCount(data) {
    if (!data || !Array.isArray(data)) {
        return 0;
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø©
    const uniqueContracts = new Set();

    data.forEach(property => {
        const tenantName = property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];
        const contractNumber = property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'];

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ¹Ù‚Ø¯
        if (tenantName && contractNumber &&
            tenantName.toString().trim() !== '' &&
            contractNumber.toString().trim() !== '') {

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙƒÙ…ÙØªØ§Ø­ ÙØ±ÙŠØ¯
            uniqueContracts.add(contractNumber.toString().trim());
        }
    });

    return uniqueContracts.size;
}

// ÙˆØ¸ÙŠÙØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© Ø§Ù„ØµØ­ÙŠØ­
function calculateCorrectEmptyUnitsCount(data) {
    if (!data || !Array.isArray(data)) {
        return 0;
    }

    const uniqueEmptyUnits = new Set();

    data.forEach(property => {
        const propertyName = property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        const unitNumber = property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
        const tenantName = property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'];

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ„ÙƒÙ† ÙØ§Ø±ØºØ©
        if (propertyName && unitNumber &&
            propertyName.toString().trim() !== '' &&
            unitNumber.toString().trim() !== '' &&
            (!tenantName || tenantName.toString().trim() === '')) {

            const unitKey = `${propertyName.trim()}_${unitNumber.toString().trim()}`;
            uniqueEmptyUnits.add(unitKey);
        }
    });

    return uniqueEmptyUnits.size;
}

// ÙˆØ¸ÙŠÙØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ù‚Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function testUnitsCountAccuracy() {
    console.log('ğŸ§® Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ù‚Ø© Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    if (!properties || !Array.isArray(properties)) {
        console.error('âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        return false;
    }

    const totalUnitsOld = properties.length;
    const totalUnitsNew = calculateCorrectUnitsCount(properties);
    const tenantsCountNew = calculateCorrectTenantsCount(properties);
    const emptyUnitsNew = calculateCorrectEmptyUnitsCount(properties);

    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:');
    console.log(`   Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… (data.length): ${totalUnitsOld}`);
    console.log(`   Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ÙØ±ÙŠØ¯): ${totalUnitsNew}`);
    console.log(`   Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†: ${tenantsCountNew}`);
    console.log(`   Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©: ${emptyUnitsNew}`);
    console.log(`   Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©: ${totalUnitsNew - emptyUnitsNew}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚
    const isLogical = (tenantsCountNew + emptyUnitsNew) <= totalUnitsNew;

    if (isLogical) {
        console.log('âœ… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù†Ø·Ù‚ÙŠØ© ÙˆØ¯Ù‚ÙŠÙ‚Ø©');
        console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${totalUnitsNew} ÙˆØ­Ø¯Ø© ÙØ±ÙŠØ¯Ø©`);
    } else {
        console.warn('âš ï¸ Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚');
        console.warn('âš ï¸ Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª');
    }

    return isLogical;
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.testUnitsCountAccuracy = testUnitsCountAccuracy;
window.calculateCorrectUnitsCount = calculateCorrectUnitsCount;

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·
// ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„: testUnitsCountAccuracy()

// ÙˆØ¸ÙŠÙØ© Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹
function fixStatisticsNow() {
    console.log('ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹...');

    try {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!properties || !Array.isArray(properties)) {
            console.warn('âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
            showToast('âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'warning');
            return false;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const correctUnitsCount = calculateCorrectUnitsCount(properties);
        const correctTenantsCount = calculateCorrectTenantsCount(properties);
        const correctEmptyUnitsCount = calculateCorrectEmptyUnitsCount(properties);

        console.log('ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØ­Ø­Ø©:');
        console.log(`   Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${correctUnitsCount}`);
        console.log(`   Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†: ${correctTenantsCount}`);
        console.log(`   Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©: ${correctEmptyUnitsCount}`);
        console.log(`   Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©: ${correctUnitsCount - correctEmptyUnitsCount}`);

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateStatisticsAfterSave();

        console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${correctUnitsCount} ÙˆØ­Ø¯Ø©`);

        return true;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
        showToast(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${error.message}`, 'error');
        return false;
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.fixStatisticsNow = fixStatisticsNow;

// ===== Ù†Ù‡Ø§ÙŠØ© Ø¥ØµÙ„Ø§Ø­ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª =====

// ===== Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© =====

// Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Supabase
async function finalSupabaseFixTest() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Supabase...');

    const results = {
        connection: false,
        tableStructure: false,
        canInsert: false,
        canUpdate: false,
        canDelete: false,
        propertyEditWorks: false,
        error: null
    };

    try {
        // 1. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
        console.log('ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...');
        const connectionTest = await checkSupabaseConnection();
        results.connection = connectionTest.connected;

        if (!results.connection) {
            results.error = connectionTest.error;
            return results;
        }

        // 2. Ø§Ø®ØªØ¨Ø§Ø± Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        console.log('ğŸ—ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„...');
        try {
            const { data, error } = await supabaseClient
                .from('properties')
                .select('id, property_name, city, unit_number')
                .limit(1);

            results.tableStructure = !error;

            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„:', error);
                results.error = error.message;
                return results;
            }
        } catch (structureError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„:', structureError);
            results.error = structureError.message;
            return results;
        }

        // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬
        console.log('â• Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬...');
        const testId = crypto.randomUUID();
        const testData = {
            id: testId,
            property_name: 'Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­',
            city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            unit_number: 'FIX_TEST_001',
            tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø±',
            contract_number: 'FIX_C001',
            rent_value: 1000,
            total_amount: 12000,
            contract_type: 'Ø³ÙƒÙ†ÙŠ',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        try {
            const { data: insertData, error: insertError } = await supabaseClient
                .from('properties')
                .insert([testData]);

            results.canInsert = !insertError;

            if (insertError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬:', insertError);
                results.error = insertError.message;
                return results;
            }

            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬');

        } catch (insertErr) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬:', insertErr);
            results.error = insertErr.message;
            return results;
        }

        // 4. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
        console.log('âœï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
        try {
            const { data: updateData, error: updateError } = await supabaseClient
                .from('properties')
                .update({
                    tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø­Ø¯Ø«',
                    rent_value: 1500,
                    updated_at: new Date().toISOString()
                })
                .eq('id', testId);

            results.canUpdate = !updateError;

            if (updateError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', updateError);
                results.error = updateError.message;
            } else {
                console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«');
            }

        } catch (updateErr) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«:', updateErr);
            results.error = updateErr.message;
        }

        // 5. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù
        console.log('ğŸ—‘ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù...');
        try {
            const { data: deleteData, error: deleteError } = await supabaseClient
                .from('properties')
                .delete()
                .eq('id', testId);

            results.canDelete = !deleteError;

            if (deleteError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', deleteError);
                results.error = deleteError.message;
            } else {
                console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù');
            }

        } catch (deleteErr) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù:', deleteErr);
            results.error = deleteErr.message;
        }

        // 6. Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        console.log('ğŸ  Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');
        try {
            if (properties && properties.length > 0) {
                const testProperty = properties[0];
                const originalValue = testProperty['Ø§Ù„Ù…Ø§Ù„Ùƒ'];
                const testValue = 'Ù…Ø§Ù„Ùƒ Ø§Ø®ØªØ¨Ø§Ø± - ' + Date.now();

                // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
                testProperty['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = testValue;

                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
                const saveResult = await savePropertiesDirectlyToSupabase([testProperty]);
                results.propertyEditWorks = saveResult.success;

                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                testProperty['Ø§Ù„Ù…Ø§Ù„Ùƒ'] = originalValue;

                if (results.propertyEditWorks) {
                    console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
                } else {
                    console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
                }
            } else {
                console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ±');
                results.propertyEditWorks = true; // Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡ ÙŠØ¹Ù…Ù„
            }

        } catch (editErr) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:', editErr);
            results.error = editErr.message;
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
        results.error = error.message;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:', results);

    const allTestsPassed = results.connection &&
                          results.tableStructure &&
                          results.canInsert &&
                          results.canUpdate &&
                          results.canDelete &&
                          results.propertyEditWorks;

    if (allTestsPassed) {
        console.log('ğŸ‰ ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ù…Ø´Ø§ÙƒÙ„ Supabase Ø¨Ù†Ø¬Ø§Ø­!');
        console.log('ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª - Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ØªÙ… Ø­Ù„Ù‡Ø§!');
    } else {
        const failedTests = [];
        if (!results.connection) failedTests.push('Ø§Ù„Ø§ØªØµØ§Ù„');
        if (!results.tableStructure) failedTests.push('Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
        if (!results.canInsert) failedTests.push('Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬');
        if (!results.canUpdate) failedTests.push('Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        if (!results.canDelete) failedTests.push('Ø§Ù„Ø­Ø°Ù');
        if (!results.propertyEditWorks) failedTests.push('ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');

        showToast(`âŒ ÙØ´Ù„ ÙÙŠ: ${failedTests.join(', ')}`, 'error');
        console.error('âŒ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª:', failedTests);
    }

    return results;
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.finalSupabaseFixTest = finalSupabaseFixTest;

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·
// ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„: finalSupabaseFixTest()

// ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© =====

// ===== Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Supabase =====

// Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
async function quickSupabaseTest() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù€ Supabase...');

    const results = {
        connection: false,
        tableExists: false,
        canInsert: false,
        canQuery: false,
        error: null
    };

    try {
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
        const connectionTest = await checkSupabaseConnection();
        results.connection = connectionTest.connected;

        if (!results.connection) {
            results.error = connectionTest.error;
            return results;
        }

        console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase ÙŠØ¹Ù…Ù„');

        // Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        try {
            const { data, error } = await supabaseClient
                .from('properties')
                .select('id')
                .limit(1);

            results.tableExists = !error;
            results.canQuery = !error;

            if (error && error.message.includes('does not exist')) {
                console.log('âš ï¸ Ø¬Ø¯ÙˆÙ„ properties ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡...');

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                await createPropertiesTableIfNotExists();

                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬
                const testData = {
                    id: 'test_' + Date.now(),
                    property_name: 'Ø§Ø®ØªØ¨Ø§Ø±',
                    city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                    unit_number: 'TEST_001',
                    raw_data: { test: true },
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                const { data: insertData, error: insertError } = await supabaseClient
                    .from('properties')
                    .insert([testData]);

                if (!insertError) {
                    results.canInsert = true;
                    results.tableExists = true;

                    // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                    await supabaseClient
                        .from('properties')
                        .delete()
                        .eq('id', testData.id);

                    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬:', insertError);
                    results.error = insertError.message;
                }
            } else if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…:', error);
                results.error = error.message;
            } else {
                console.log('âœ… Ø¬Ø¯ÙˆÙ„ properties Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ¹Ù…Ù„');
                results.tableExists = true;
                results.canQuery = true;
                results.canInsert = true; // Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡ ÙŠØ¹Ù…Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙŠØ¹Ù…Ù„
            }

        } catch (tableError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„:', tableError);
            results.error = tableError.message;
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹:', error);
        results.error = error.message;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹:', results);

    const success = results.connection && results.tableExists && results.canInsert;

    if (success) {
        showToast('âœ… Supabase ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø§Ù„Ø¢Ù†!', 'success');
    } else {
        showToast(`âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Supabase: ${results.error}`, 'error');
    }

    return results;
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.quickSupabaseTest = quickSupabaseTest;

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        console.log('ğŸ”„ ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Supabase Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
        quickSupabaseTest();
    }, 3000);
});

// ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Supabase =====

// ===== Ù†Ø¸Ø§Ù… ÙÙ„ØªØ±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ =====

// ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
function initializeTrackingTableFilter(logs) {
    console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ HTML Ù„Ù„Ø³Ø¬Ù„Ø§Øª
    const tableHtml = createTrackingLogsTable(logs);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø­Ø§ÙˆÙŠØ©
    const container = document.getElementById('trackingLogsContainer');
    if (container) {
        container.innerHTML = tableHtml;

        // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø£Ø·ÙˆÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ DOM
        setTimeout(() => {
            if (window.tableFilterSystem) {
                console.log('ğŸ”§ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø©...');

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                const table = document.getElementById('trackingLogsTable');
                if (!table) {
                    console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ trackingLogsTable');
                    return;
                }

                console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ„ØªØ±Ø©...');
                const success = window.tableFilterSystem.initializeTable('trackingLogsTable', logs);

                if (success) {
                    console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ù†Ø¬Ø§Ø­');

                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    addTrackingTableCounter(logs.length);

                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©
                    updateTrackingTableCounter();
                } else {
                    console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø©');
                }
            } else {
                console.error('âŒ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ØºÙŠØ± Ù…ØªÙˆÙØ± (window.tableFilterSystem)');
            }
        }, 300);
    }
}

// Ø¯Ù…Ø¬ ÙˆØªØ¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
function consolidateTrackingLogs(logs) {
    if (!logs || logs.length === 0) {
        return [];
    }

    console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¯Ù…Ø¬ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    const groupedLogs = new Map();

    logs.forEach(log => {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ¬Ù…ÙŠØ¹: Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ + Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© + Ø§Ù„ØªØ§Ø±ÙŠØ®
        const contractNumber = log.contractNumber || log.contract_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const operationType = log.operationType || log.operation_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const date = log.date || formatDate(log.timestamp);

        const groupKey = `${contractNumber}|${operationType}|${date}`;

        if (!groupedLogs.has(groupKey)) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
            groupedLogs.set(groupKey, {
                date: date,
                time: log.time || formatTime(log.timestamp),
                operationType: operationType,
                tenantName: log.tenantName || log.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                contractNumber: contractNumber,
                user: log.user || log.user_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                propertyName: log.propertyName || log.property_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                city: log.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                unitNumbers: new Set(),
                changes: new Set(),
                events: new Set(), // Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                originalLogs: []
            });
        }

        const group = groupedLogs.get(groupKey);

        // Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
        const unitNumber = log.unitNumber || log.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if (unitNumber && unitNumber !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
            group.unitNumbers.add(unitNumber);
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        const logChanges = extractChangesFromLog(log);
        logChanges.forEach(change => group.changes.add(change));

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        const logEvents = extractEventsFromLog(log);
        logEvents.forEach(event => group.events.add(event));

        // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ
        group.originalLogs.push(log);
    });

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
    const consolidatedLogs = Array.from(groupedLogs.values()).map(group => ({
        date: group.date,
        time: group.time,
        operationType: group.operationType,
        tenantName: group.tenantName,
        contractNumber: group.contractNumber,
        user: group.user,
        propertyName: group.propertyName,
        unitNumbers: Array.from(group.unitNumbers).join('-'),
        city: group.city,
        changes: Array.from(group.changes).map(change => `âœ” ${change}`).join('\n'),
        events: Array.from(group.events).map(event => `â€¢ ${event}`).join('\n'), // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯
        recordCount: group.originalLogs.length
    }));

    console.log(`âœ… ØªÙ… Ø¯Ù…Ø¬ ${logs.length} Ø³Ø¬Ù„ Ø¥Ù„Ù‰ ${consolidatedLogs.length} Ø³Ø¬Ù„ Ù…ÙˆØ­Ø¯`);
    return consolidatedLogs;
}

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
function extractChangesFromLog(log) {
    const changes = [];

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø­Ù‚Ù„ changes ÙÙŠ JSON
    if (log.changes) {
        try {
            let parsedChanges;
            if (typeof log.changes === 'string') {
                parsedChanges = JSON.parse(log.changes);
            } else {
                parsedChanges = log.changes;
            }

            if (Array.isArray(parsedChanges)) {
                changes.push(...parsedChanges);
            } else if (typeof parsedChanges === 'object') {
                Object.entries(parsedChanges).forEach(([field, change]) => {
                    if (typeof change === 'object' && change.old !== change.new) {
                        const fieldName = getArabicFieldName(field);
                        changes.push(`ØªÙ… ØªØºÙŠÙŠØ± ${fieldName} Ù…Ù† ${change.old || '(ÙØ§Ø±Øº)'} Ø¥Ù„Ù‰ ${change.new}`);
                    }
                });
            }
        } catch (e) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ø£Ø¶Ù Ø§Ù„Ù†Øµ ÙƒÙ…Ø§ Ù‡Ùˆ
            changes.push(log.changes);
        }
    }

    // Ø¥Ø¶Ø§ÙØ© ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (log.description || log.operationDescription) {
        changes.push(log.description || log.operationDescription);
    }

    // Ø¥Ø¶Ø§ÙØ© ØªØºÙŠÙŠØ±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    const operationType = log.operationType || log.operation_type || '';
    const unitNumber = log.unitNumber || log.unit_number || '';

    if (operationType.includes('ØªØ­Ø±ÙŠØ±') || operationType.includes('ØªØ¹Ø¯ÙŠÙ„')) {
        changes.push(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
    } else if (operationType.includes('Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯') || operationType.includes('Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯')) {
        const tenantName = log.tenantName || log.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        changes.push(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ù† (ÙØ§Ø±Øº) Ø¥Ù„Ù‰ ${tenantName}`);
    } else if (operationType.includes('Ø¥ÙØ±Ø§Øº')) {
        changes.push(`ØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
    }

    return changes.filter(change => change && change.trim());
}

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ (Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
function extractEventsFromLog(log) {
    const events = [];

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ù†Ø¸Ù…Ø©
    if (log.changes) {
        try {
            let parsedChanges;
            if (typeof log.changes === 'string') {
                parsedChanges = JSON.parse(log.changes);
            } else {
                parsedChanges = log.changes;
            }

            if (typeof parsedChanges === 'object' && !Array.isArray(parsedChanges)) {
                Object.entries(parsedChanges).forEach(([field, change]) => {
                    if (typeof change === 'object' && change.old !== change.new) {
                        const fieldName = getArabicFieldName(field);
                        const oldValue = change.old || '(ÙØ§Ø±Øº)';
                        const newValue = change.new || '(ÙØ§Ø±Øº)';

                        // ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØªÙ„Ù Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
                        if (field === 'tenant_name') {
                            if (!change.old) {
                                events.push(`Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯: ${newValue}`);
                            } else {
                                events.push(`ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${oldValue} â† ${newValue}`);
                            }
                        } else if (field === 'start_date') {
                            events.push(`ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${oldValue} â† ${newValue}`);
                        } else if (field === 'end_date') {
                            events.push(`ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${oldValue} â† ${newValue}`);
                        } else if (field === 'rent_value') {
                            events.push(`ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${oldValue} Ø±ÙŠØ§Ù„ â† ${newValue} Ø±ÙŠØ§Ù„`);
                        } else if (field === 'contract_status') {
                            events.push(`ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯: ${oldValue} â† ${newValue}`);
                        } else if (field === 'unit_status') {
                            events.push(`ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©: ${oldValue} â† ${newValue}`);
                        } else if (field === 'phone_number') {
                            events.push(`ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${oldValue} â† ${newValue}`);
                        } else if (field === 'email') {
                            events.push(`ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${oldValue} â† ${newValue}`);
                        } else if (field === 'address') {
                            events.push(`ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${oldValue} â† ${newValue}`);
                        } else {
                            events.push(`ØªØ­Ø¯ÙŠØ« ${fieldName}: ${oldValue} â† ${newValue}`);
                        }
                    }
                });
            }
        } catch (e) {
            // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„
            events.push(`ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${log.changes}`);
        }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    const operationType = log.operationType || log.operation_type || '';
    const unitNumber = log.unitNumber || log.unit_number || '';
    const tenantName = log.tenantName || log.tenant_name || '';

    if (operationType.includes('Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯') || operationType.includes('Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯')) {
        if (!events.some(event => event.includes('Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±'))) {
            events.push(`Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        }
        if (tenantName && tenantName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
            events.push(`Ø±Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${tenantName}`);
        }
    } else if (operationType.includes('Ø¥ÙØ±Ø§Øº')) {
        events.push(`Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        if (tenantName && tenantName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
            events.push(`Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${tenantName}`);
        }
    } else if (operationType.includes('ØªØ­Ø±ÙŠØ±') || operationType.includes('ØªØ¹Ø¯ÙŠÙ„')) {
        if (events.length === 0) {
            events.push(`ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
        }
    } else if (operationType.includes('ØªØ¬Ø¯ÙŠØ¯')) {
        events.push(`ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
    } else if (operationType.includes('Ù†Ù‚Ù„')) {
        events.push(`Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}`);
    }

    // Ø¥Ø¶Ø§ÙØ© ÙˆØµÙ Ø¥Ø¶Ø§ÙÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (log.description || log.operationDescription) {
        const description = log.description || log.operationDescription;
        if (!events.some(event => event.includes(description))) {
            events.push(`ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©: ${description}`);
        }
    }

    return events.filter(event => event && event.trim());
}

// ØªØ±Ø¬Ù…Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
function getArabicFieldName(fieldName) {
    const fieldTranslations = {
        'tenant_name': 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
        'tenantName': 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
        'start_date': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        'startDate': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        'end_date': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        'endDate': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        'rent_value': 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±',
        'rentValue': 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±',
        'phone_number': 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
        'phoneNumber': 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
        'contract_type': 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
        'contractType': 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
        'unit_status': 'Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©',
        'unitStatus': 'Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©',
        'contract_status': 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯',
        'contractStatus': 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯'
    };

    return fieldTranslations[fieldName] || fieldName;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ HTML Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¹
function createTrackingLogsTable(logs) {
    return createTrackingLogsTableWithToggle(logs);
}

// Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹
let isConsolidationEnabled = true;
let originalTrackingLogs = [];

// ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬ ÙˆØ§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ„ÙŠ
function toggleConsolidation() {
    isConsolidationEnabled = !isConsolidationEnabled;

    const currentLogs = window.currentTrackingLogs || [];

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const tableHtml = createTrackingLogsTableWithToggle(currentLogs);
    const container = document.getElementById('trackingLogsContainer');
    if (container) {
        container.innerHTML = tableHtml;

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø©
        setTimeout(() => {
            if (window.tableFilterSystem) {
                const table = document.getElementById('trackingLogsTable');
                if (table) {
                    window.tableFilterSystem.initializeTable('trackingLogsTable', currentLogs);
                }
            }
        }, 300);
    }

    const mode = isConsolidationEnabled ? 'Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬' : 'Ø§Ù„Ø£ØµÙ„ÙŠ';
    showToast(`ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ ${mode}`, 'info');
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
function createTrackingLogsTableWithToggle(logs) {
    if (!logs || logs.length === 0) {
        return '<div class="no-logs">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹</div>';
    }

    let displayLogs;
    let counterText;

    if (isConsolidationEnabled) {
        displayLogs = consolidateTrackingLogs(logs);
        counterText = `Ø¹Ø±Ø¶ ${displayLogs.length} Ø³Ø¬Ù„ Ù…Ø¯Ù…ÙˆØ¬ Ù…Ù† Ø£ØµÙ„ ${logs.length} Ø³Ø¬Ù„ Ø£ØµÙ„ÙŠ`;
    } else {
        displayLogs = logs.map(log => ({
            date: log.date || formatDate(log.timestamp),
            time: log.time || formatTime(log.timestamp),
            operationType: log.operationType || log.operation_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            tenantName: log.tenantName || log.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            contractNumber: log.contractNumber || log.contract_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            user: log.user || log.user_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            propertyName: log.propertyName || log.property_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            unitNumbers: log.unitNumber || log.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            city: log.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            changes: extractChangesFromLog(log).map(change => `âœ” ${change}`).join('\n') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª',
            events: extractEventsFromLog(log).map(event => `â€¢ ${event}`).join('\n') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«',
            recordCount: 1
        }));
        counterText = `Ø¹Ø±Ø¶ ${displayLogs.length} Ø³Ø¬Ù„ Ø£ØµÙ„ÙŠ`;
    }

    return `
        <div class="tracking-table-container">
            <div class="table-controls">
                <div class="table-counter" id="trackingTableCounter" data-table-counter="trackingLogsTable">
                    ${counterText}
                </div>
                <div class="table-actions">
                    <button class="clear-filters-btn" onclick="clearTrackingTableFilters()">
                        <i class="fas fa-eraser"></i> Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
                    </button>
                    <button class="clear-search-btn" onclick="clearTrackingSearch()">
                        <i class="fas fa-times"></i> Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
                    </button>
                    <button class="toggle-consolidation-btn ${isConsolidationEnabled ? 'active' : ''}" onclick="toggleConsolidation()" title="ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬ ÙˆØ§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ„ÙŠ">
                        <i class="fas fa-layer-group"></i> ${isConsolidationEnabled ? 'Ø¹Ø±Ø¶ Ø£ØµÙ„ÙŠ' : 'Ø¹Ø±Ø¶ Ù…Ø¯Ù…ÙˆØ¬'}
                    </button>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="tracking-logs-table" id="trackingLogsTable">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„Ø¹Ù‚Ø§Ø±</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                            <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                            <th>Ø§Ù„Ø­Ø¯Ø«</th>
                            <th>Ø§Ù„ØªØºÙŠØ±Ø§Øª</th>
                            ${isConsolidationEnabled ? '<th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${displayLogs.map(log => `
                            <tr>
                                <td>${log.date}</td>
                                <td>${log.time}</td>
                                <td>${log.operationType}</td>
                                <td>${log.tenantName}</td>
                                <td>${log.contractNumber}</td>
                                <td>${log.user}</td>
                                <td>${log.propertyName}</td>
                                <td class="unit-numbers-cell">${log.unitNumbers}</td>
                                <td>${log.city}</td>
                                <td class="events-cell">${log.events}</td>
                                <td class="changes-cell">${log.changes}</td>
                                ${isConsolidationEnabled ? `<td class="record-count-cell">${log.recordCount}</td>` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
function addTrackingTableCounter(totalCount) {
    const counterHtml = `
        <style>
            .tracking-table-container {
                background: white;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                margin: 20px 0;
            }

            .table-controls {
                background: #f8f9fa;
                padding: 15px 20px;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .table-counter {
                font-weight: 600;
                color: #495057;
                font-size: 14px;
            }

            .table-actions {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .clear-filters-btn, .clear-search-btn {
                border: none;
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 5px;
                font-weight: 500;
            }

            .clear-filters-btn {
                background: #dc3545;
                color: white;
            }

            .clear-filters-btn:hover {
                background: #c82333;
                transform: translateY(-1px);
            }

            .clear-search-btn {
                background: #6c757d;
                color: white;
            }

            .clear-search-btn:hover {
                background: #5a6268;
                transform: translateY(-1px);
            }

            .table-wrapper {
                overflow-x: auto;
                max-height: 600px;
                overflow-y: auto;
            }

            .tracking-logs-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
                min-width: 800px;
            }

            .tracking-logs-table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .tracking-logs-table th {
                padding: 12px 8px;
                text-align: right;
                font-weight: 600;
                border-bottom: 2px solid #dee2e6;
                white-space: nowrap;
            }

            .tracking-logs-table td {
                padding: 10px 8px;
                border-bottom: 1px solid #dee2e6;
                text-align: right;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 150px;
            }

            .tracking-logs-table tbody tr:hover {
                background: #f8f9fa;
            }

            .tracking-logs-table tbody tr:nth-child(even) {
                background: #f9f9f9;
            }

            .tracking-logs-table tbody tr:nth-child(even):hover {
                background: #f1f1f1;
            }

            /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ù„Ø³ */
            input[type="text"], input[type="search"] {
                transition: all 0.3s ease;
                border: 2px solid #ced4da;
            }

            input[type="text"]:focus, input[type="search"]:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
            }

            /* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø« */
            .search-indicator {
                position: relative;
            }

            .search-indicator::after {
                content: '';
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                width: 12px;
                height: 12px;
                border: 2px solid #007bff;
                border-top: 2px solid transparent;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .search-indicator.searching::after {
                opacity: 1;
            }

            @keyframes spin {
                0% { transform: translateY(-50%) rotate(0deg); }
                100% { transform: translateY(-50%) rotate(360deg); }
            }

            /* Ø£Ù†Ù…Ø§Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ */
            .view-toggle-group {
                display: flex;
                gap: 5px;
                background: #f8f9fa;
                border-radius: 8px;
                padding: 4px;
            }

            .view-toggle-btn {
                padding: 8px 15px;
                border: none;
                background: transparent;
                color: #6c757d;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .view-toggle-btn:hover {
                background: #e9ecef;
                color: #495057;
            }

            .view-toggle-btn.active {
                background: #007bff;
                color: white;
                box-shadow: 0 2px 4px rgba(0,123,255,0.3);
            }

            .action-buttons-group {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .tracking-actions {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 15px;
                margin-bottom: 20px;
                padding: 15px 20px;
                background: #f8f9fa;
                border-radius: 10px;
                border: 1px solid #dee2e6;
            }

            @media (max-width: 768px) {
                .table-controls {
                    flex-direction: column;
                    align-items: stretch;
                }

                .table-counter {
                    text-align: center;
                }

                .tracking-logs-table {
                    font-size: 11px;
                }

                .tracking-logs-table th,
                .tracking-logs-table td {
                    padding: 6px 4px;
                    max-width: 100px;
                }

                .tracking-actions {
                    flex-direction: column;
                    align-items: stretch;
                }

                .view-toggle-group,
                .action-buttons-group {
                    justify-content: center;
                }

                .action-buttons-group {
                    flex-wrap: wrap;
                }

                .table-actions {
                    flex-direction: column;
                    gap: 8px;
                }

                .clear-filters-btn, .clear-search-btn {
                    width: 100%;
                    justify-content: center;
                }
            }
        </style>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (!document.getElementById('tracking-table-styles')) {
        const styleElement = document.createElement('div');
        styleElement.id = 'tracking-table-styles';
        styleElement.innerHTML = counterHtml;
        document.head.appendChild(styleElement);
    }
}

// Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ù…Ø¤Ù‚Øª Ø§Ù„Ø¨Ø­Ø«
let searchTimeout = null;

// Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ debouncing ÙˆØ­Ù…Ø§ÙŠØ© Ø´Ø§Ù…Ù„Ø©
function handleTrackingSearch(event) {
    // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø¯Ø« Ù…Ù† Ù†Ù…ÙˆØ°Ø¬
    if (event && event.preventDefault) {
        event.preventDefault();
    }
    if (event && event.stopPropagation) {
        event.stopPropagation();
    }

    const searchInput = document.getElementById('trackingSearch');
    if (!searchInput) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«');
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
        setTimeout(() => {
            fixMissingSearchField();
        }, 100);
        return false;
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©
    forceSearchFieldStyling();

    // Ø­ÙØ¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙˆØ±Ø§Ù‹
    const searchValue = searchInput.value;
    preserveSearchState();

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ Ù„Ù„Ø¨Ø­Ø«
    searchInput.classList.add('search-indicator', 'searching');

    // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ù„Ù€ 300ms Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©
    searchTimeout = setTimeout(() => {
        try {
            const currentSearchInput = document.getElementById('trackingSearch');
            if (!currentSearchInput) {
                console.error('âŒ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ø®ØªÙÙ‰ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«!');
                fixMissingSearchField();
                return;
            }

            const searchTerm = currentSearchInput.value.trim();
            console.log(`ğŸ” ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø«: "${searchTerm}"`);

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            executeTrackingSearch(searchTerm);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø«
            setTimeout(() => {
                const searchInputAfterSearch = document.getElementById('trackingSearch');
                if (searchInputAfterSearch) {
                    searchInputAfterSearch.classList.remove('searching');

                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¤Ù‚ØªØ§Ù‹
                    if (searchTerm) {
                        searchInputAfterSearch.style.borderColor = '#28a745';
                        setTimeout(() => {
                            if (searchInputAfterSearch) {
                                searchInputAfterSearch.style.borderColor = '';
                            }
                        }, 1000);
                    }
                } else {
                    console.error('âŒ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ø®ØªÙÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø«!');
                    fixMissingSearchField();
                }
            }, 100);

        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
            const currentSearchInput = document.getElementById('trackingSearch');
            if (currentSearchInput) {
                currentSearchInput.classList.remove('searching');
                currentSearchInput.style.borderColor = '#dc3545';
                setTimeout(() => {
                    if (currentSearchInput) {
                        currentSearchInput.style.borderColor = '';
                    }
                }, 2000);
            }
        }
    }, 300); // ØªØ£Ø®ÙŠØ± 300ms

    return false; // Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
function executeTrackingSearch(searchTerm) {
    try {
        console.log(`ğŸ” ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø«: "${searchTerm}"`);

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
        const searchInput = document.getElementById('trackingSearch');
        if (!searchInput) {
            console.warn('âš ï¸ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø­Ø«');
            return;
        }

        // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const tableContainer = document.getElementById('trackingLogsTable');
        const isTableView = tableContainer && tableContainer.style.display !== 'none';

        if (isTableView) {
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            console.log('ğŸ“Š ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
            applySearchToTable(searchTerm);
        } else {
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
            console.log('ğŸ“‹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª');
            filterTrackingLogs();
        }

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø«
        setTimeout(() => {
            const searchInputAfter = document.getElementById('trackingSearch');
            if (!searchInputAfter) {
                console.error('âŒ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ø®ØªÙÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø«!');
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«', 'error');
            }
        }, 100);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø«:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«', 'error');
    }
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function applySearchToTable(searchTerm) {
    console.log(`ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« "${searchTerm}" Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„...`);

    if (window.tableFilterSystem) {
        if (searchTerm && searchTerm.trim() !== '') {
            window.tableFilterSystem.applySearch('trackingLogsTable', searchTerm.trim());
        } else {
            window.tableFilterSystem.clearSearch('trackingLogsTable');
        }
    } else {
        console.warn('âš ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±');
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØªØ¨Ø¹
function updateTrackingTableCounter() {
    const table = document.getElementById('trackingLogsTable');
    const counter = document.getElementById('trackingTableCounter');

    if (table && counter) {
        const totalRows = table.querySelectorAll('tbody tr').length;
        const visibleRows = table.querySelectorAll('tbody tr:not([style*="display: none"])').length;

        counter.textContent = `Ø¹Ø±Ø¶ ${visibleRows} Ù…Ù† Ø£ØµÙ„ ${totalRows} Ø³Ø¬Ù„`;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setTimeout(updateTrackingTableCounter, 1000);
    }
}

// Ù…Ø³Ø­ ÙÙ„Ø§ØªØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØªØ¨Ø¹
function clearTrackingTableFilters() {
    if (window.tableFilterSystem) {
        window.tableFilterSystem.clearAllFilters('trackingLogsTable');
        showToast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ ÙÙ„Ø§ØªØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„', 'success');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø¹Ø¯ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
        setTimeout(updateTrackingTableCounter, 100);
    }
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
function clearTrackingSearch() {
    const searchInput = document.getElementById('trackingSearch');
    if (searchInput) {
        searchInput.value = '';

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ§Ø±Øº
        handleTrackingSearch();

        showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«', 'info');
    }
}

// Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
function preserveSearchState() {
    const searchInput = document.getElementById('trackingSearch');
    if (searchInput && searchInput.value) {
        sessionStorage.setItem('trackingSearchValue', searchInput.value);
    }
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
function restoreSearchState() {
    const savedValue = sessionStorage.getItem('trackingSearchValue');
    if (savedValue) {
        const searchInput = document.getElementById('trackingSearch');
        if (searchInput) {
            searchInput.value = savedValue;
            sessionStorage.removeItem('trackingSearchValue');
        }
    }
}

// Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ Ø§Ø®ØªÙÙ‰
function fixMissingSearchField() {
    const searchInput = document.getElementById('trackingSearch');
    if (!searchInput) {
        console.log('ğŸ”§ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ÙÙ‚ÙˆØ¯...');

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙ„Ø§ØªØ±
        const filtersContainer = document.querySelector('.tracking-filters');
        if (filtersContainer) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¨Ø­Ø«
            const searchGroup = Array.from(filtersContainer.querySelectorAll('.filter-group'))
                .find(group => group.querySelector('label')?.textContent?.includes('Ø§Ù„Ø¨Ø­Ø«'));

            if (searchGroup && !searchGroup.querySelector('#trackingSearch')) {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
                const searchHTML = `
                    <input type="text" id="trackingSearch" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§ØªØŒ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§ØªØŒ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (ÙŠØ´Ù…Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©)..."
                           oninput="return handleTrackingSearch(event)"
                           onkeydown="if(event.key==='Enter') { event.preventDefault(); return false; }"
                           onsubmit="return false"
                           autocomplete="off">
                `;
                searchGroup.insertAdjacentHTML('beforeend', searchHTML);

                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                restoreSearchState();

                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¨Ù‚ÙˆØ©
                forceSearchFieldStyling();

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨ DOM Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                setupSearchFieldObserver();

                console.log('âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«');
                showToast('ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«', 'success');
                return true;
            }
        }
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª
        forceSearchFieldStyling();
    }
    return false;
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¨Ù‚ÙˆØ© Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
function forceSearchFieldStyling() {
    const searchInput = document.getElementById('trackingSearch');
    if (!searchInput) return;

    console.log('ğŸ¨ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¨Ù‚ÙˆØ© Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«...');

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± JavaScript
    const styles = {
        'width': '100%',
        'padding': '12px 16px',
        'border': '2px solid #007bff',
        'border-radius': '8px',
        'font-size': '16px',
        'font-family': "'Cairo', 'Tajawal', sans-serif",
        'background': '#ffffff',
        'background-color': '#ffffff',
        'color': '#212529',
        'direction': 'rtl',
        'text-align': 'right',
        'outline': 'none',
        'box-shadow': '0 2px 4px rgba(0, 123, 255, 0.15)',
        'font-weight': '500',
        'line-height': '1.5',
        'transition': 'all 0.3s ease',
        'opacity': '1',
        'visibility': 'visible',
        'display': 'block',
        'box-sizing': 'border-box'
    };

    // ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„ Ù†Ù…Ø·
    Object.entries(styles).forEach(([property, value]) => {
        searchInput.style.setProperty(property, value, 'important');
    });

    // ØªØ·Ø¨ÙŠÙ‚ Ø£Ù†Ù…Ø§Ø· Ø®Ø§ØµØ© Ù„Ù„Ù†Øµ
    searchInput.style.setProperty('-webkit-text-fill-color', '#212529', 'important');
    searchInput.style.setProperty('text-rendering', 'optimizeLegibility', 'important');
    searchInput.style.setProperty('-webkit-font-smoothing', 'antialiased', 'important');

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª
    searchInput.addEventListener('focus', function() {
        this.style.setProperty('color', '#212529', 'important');
        this.style.setProperty('background', '#ffffff', 'important');
        this.style.setProperty('border-color', '#0056b3', 'important');
        this.style.setProperty('box-shadow', '0 0 0 3px rgba(0, 123, 255, 0.25), 0 4px 8px rgba(0, 123, 255, 0.2)', 'important');
    });

    searchInput.addEventListener('blur', function() {
        this.style.setProperty('color', '#212529', 'important');
        this.style.setProperty('background', '#ffffff', 'important');
        this.style.setProperty('border-color', '#007bff', 'important');
        this.style.setProperty('box-shadow', '0 2px 4px rgba(0, 123, 255, 0.15)', 'important');
    });

    searchInput.addEventListener('input', function() {
        this.style.setProperty('color', '#212529', 'important');
        this.style.setProperty('background', '#ffffff', 'important');
    });

    console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¨Ù‚ÙˆØ©');
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨ DOM Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
function setupSearchFieldObserver() {
    const searchInput = document.getElementById('trackingSearch');
    if (!searchInput) return;

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø§Ù‚Ø¨ DOM
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList') {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
                mutation.removedNodes.forEach((node) => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        const removedSearchInput = node.querySelector('#trackingSearch') ||
                                                 (node.id === 'trackingSearch' ? node : null);
                        if (removedSearchInput) {
                            console.warn('âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«!');
                            setTimeout(() => {
                                fixMissingSearchField();
                            }, 50);
                        }
                    }
                });
            }
        });
    });

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const trackingContainer = document.querySelector('.tracking-main-view') || document.body;
    observer.observe(trackingContainer, {
        childList: true,
        subtree: true
    });

    console.log('ğŸ‘ï¸ ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨ DOM Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«');
}

// ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
function toggleTrackingView(viewType) {
    console.log(`ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¥Ù„Ù‰: ${viewType}`);

    const container = document.getElementById('trackingLogsContainer');
    if (!container) return;

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    const cardsBtn = document.getElementById('trackingCardsBtn');
    const tableBtn = document.getElementById('trackingTableBtn');

    if (cardsBtn && tableBtn) {
        cardsBtn.classList.remove('active');
        tableBtn.classList.remove('active');

        if (viewType === 'cards') {
            cardsBtn.classList.add('active');
        } else {
            tableBtn.classList.add('active');
        }
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const currentLogs = window.currentTrackingLogs || [];

    if (viewType === 'table') {
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø©
        console.log('ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„...');
        initializeTrackingTableFilter(currentLogs);

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        const searchInput = document.getElementById('trackingSearch');
        if (searchInput && searchInput.value.trim() !== '') {
            console.log('ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„...');
            setTimeout(() => {
                applySearchToTable(searchInput.value.trim());
            }, 500);
        }
    } else {
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ„ÙŠ)
        console.log('ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª...');
        container.innerHTML = renderTrackingLogs(currentLogs);
    }

    // Ø­ÙØ¸ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
    localStorage.setItem('trackingViewPreference', viewType);

    showToast(`ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ ${viewType === 'table' ? 'Ø§Ù„Ø¬Ø¯ÙˆÙ„' : 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª'}`, 'info');
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø· (Ø§Ù„Ù…ÙÙ„ØªØ±Ø©)
function getVisibleTrackingLogs() {
    console.log('ğŸ” Ø¬Ù…Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©...');

    const table = document.getElementById('trackingLogsTable');
    if (!table) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø¯ÙˆÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        return window.currentTrackingLogs || [];
    }

    const visibleRows = table.querySelectorAll('tbody tr:not([style*="display: none"])');
    const visibleLogs = [];

    visibleRows.forEach((row, index) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 9) {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const log = {
                date: cells[0].textContent.trim(),
                time: cells[1].textContent.trim(),
                operationType: cells[2].textContent.trim(),
                tenantName: cells[3].textContent.trim(),
                contractNumber: cells[4].textContent.trim(),
                user: cells[5].textContent.trim(),
                propertyName: cells[6].textContent.trim(),
                unitNumber: cells[7].textContent.trim(),
                city: cells[8].textContent.trim()
            };

            visibleLogs.push(log);
        }
    });

    console.log(`ğŸ“‹ ØªÙ… Ø¬Ù…Ø¹ ${visibleLogs.length} Ø³Ø¬Ù„ Ø¸Ø§Ù‡Ø± Ù…Ù† Ø£ØµÙ„ ${table.querySelectorAll('tbody tr').length} Ø³Ø¬Ù„`);
    return visibleLogs;
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® - Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø¨ØµÙŠØºØ© dd/mm/yyyy
function formatDate(timestamp) {
    if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

        // ØªÙ†Ø³ÙŠÙ‚ Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø¨ØµÙŠØºØ© dd/mm/yyyy
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();

        return `${day}/${month}/${year}`;
    } catch (error) {
        console.warn('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®:', error);
        return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    }
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª - Ø¨ØµÙŠØºØ© 24 Ø³Ø§Ø¹Ø©
function formatTime(timestamp) {
    if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø¨ØµÙŠØºØ© HH:MM
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');

        return `${hours}:${minutes}`;
    } catch (error) {
        console.warn('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª:', error);
        return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    }
}

// Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
function renderTrackingLogs(logs) {
    if (logs.length === 0) {
        return '<div class="no-logs">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØªØ¨Ø¹</div>';
    }

    return logs.map(log => `
        <div class="change-log-entry">
            <div class="change-log-header">
                <div class="change-log-operation">${log.operationType}</div>
                <div class="change-log-timestamp">
                    <div class="timestamp-main">
                        <strong>${log.dayName || getDayName(new Date(log.timestamp))}</strong>
                    </div>
                    <div class="timestamp-dates">
                        <div class="gregorian-date">
                            <i class="fas fa-calendar"></i>
                            ${log.date} - ${log.time}
                        </div>
                        <div class="hijri-date">
                            <i class="fas fa-moon"></i>
                            ${log.hijriDate || getHijriDate(new Date(log.timestamp))}
                        </div>
                    </div>
                    <div class="timestamp-user">
                        <i class="fas fa-user"></i>
                        ${log.user}
                    </div>
                </div>
            </div>

            <div class="change-log-details">
                <div class="change-detail-item">
                    <div class="change-detail-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</div>
                    <div class="change-detail-value">${log.unitNumber}</div>
                </div>
                <div class="change-detail-item">
                    <div class="change-detail-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:</div>
                    <div class="change-detail-value">${log.propertyName}</div>
                </div>
                <div class="change-detail-item">
                    <div class="change-detail-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</div>
                    <div class="change-detail-value">${log.city}</div>
                </div>
                ${log.tenantName ? `
                <div class="change-detail-item">
                    <div class="change-detail-label">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</div>
                    <div class="change-detail-value">${log.tenantName}</div>
                </div>` : ''}
                ${log.contractNumber ? `
                <div class="change-detail-item">
                    <div class="change-detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</div>
                    <div class="change-detail-value">${log.contractNumber}</div>
                </div>` : ''}

                ${renderChangeDetails(log)}

                ${log.sourceProperty && log.destinationProperty ? `
                <div class="change-detail-item">
                    <div class="change-detail-label">Ù†Ù‚Ù„ Ù…Ù†:</div>
                    <div class="change-detail-value">${log.sourceProperty} â†’ ${log.destinationProperty}</div>
                </div>` : ''}

                ${log.reason ? `
                <div class="change-detail-item">
                    <div class="change-detail-label">Ø§Ù„Ø³Ø¨Ø¨:</div>
                    <div class="change-detail-value">${log.reason}</div>
                </div>` : ''}
            </div>
        </div>
    `).join('');
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
function renderChangeDetails(log) {
    if (!log.changes || Object.keys(log.changes).length === 0) {
        return '';
    }

    return Object.entries(log.changes).map(([field, change]) => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØºÙŠÙŠØ±
        if (!change || typeof change !== 'object') {
            console.warn('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØªØºÙŠÙŠØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©:', field, change);
            return '';
        }

        const fieldName = change.fieldName || field || 'Ø­Ù‚Ù„ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const oldValue = change.old || 'ÙØ§Ø±Øº';
        const newValue = change.new || 'ÙØ§Ø±Øº';

        return `
            <div class="change-detail-item">
                <div class="change-detail-label">${fieldName}:</div>
                <div class="change-detail-value">
                    <span class="change-detail-old">${oldValue}</span>
                    â†’
                    <span class="change-detail-new">${newValue}</span>
                </div>
            </div>
        `;
    }).filter(item => item !== '').join('');
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù…ØµØ·Ù„Ø­ Ø§Ù„Ø¨Ø­Ø«
function isUnitLinkedToSearchTerm(unitNumber, propertyName, contractNumber, searchTerm) {
    try {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø¹Ù‚Ø¯ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        if (!properties || !contractNumber || contractNumber.trim() === '') {
            return false;
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯
        const linkedUnits = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ØµØ·Ù„Ø­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø£ÙŠ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        return linkedUnits.some(unit => {
            const unitFields = [
                unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] || '',
                unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || '',
                unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'] || '',
                unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø§Ø¶Ø§ÙÙŠ'] || '',
                unit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'] || '',
                unit['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©'] || ''
            ];

            return unitFields.some(field =>
                field.toString().toLowerCase().includes(searchTerm.toLowerCase())
            );
        });
    } catch (error) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:', error);
        return false;
    }
}

// Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
let cachedTrackingLogs = null;
let lastCacheTime = 0;
const CACHE_DURATION = 30000; // 30 Ø«Ø§Ù†ÙŠØ©

// Ù…Ø³Ø­ ÙƒØ§Ø´ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
function clearTrackingLogsCache() {
    cachedTrackingLogs = null;
    lastCacheTime = 0;
    console.log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ ÙƒØ§Ø´ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
}

// ÙÙ„ØªØ±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ÙˆØ§Ù„Ù…ØµØ­Ø­Ø©
async function filterTrackingLogs() {
    console.log('ğŸ” Ø¨Ø¯Ø¡ ÙÙ„ØªØ±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    // ØªØ´Ø®ÙŠØµ Ø­Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù‚Ø¨Ù„ Ø§Ù„ÙÙ„ØªØ±Ø©
    const searchInputBefore = document.getElementById('trackingSearch');
    console.log('ğŸ” Ø­Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù‚Ø¨Ù„ Ø§Ù„ÙÙ„ØªØ±Ø©:', {
        exists: !!searchInputBefore,
        value: searchInputBefore?.value || 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
        visible: searchInputBefore ? window.getComputedStyle(searchInputBefore).display !== 'none' : false
    });

    const dateFilter = document.getElementById('trackingDateFilter')?.value;
    const monthFilter = document.getElementById('trackingMonthFilter')?.value;
    const operationType = document.getElementById('trackingOperationType')?.value;
    const searchTerm = document.getElementById('trackingSearch')?.value?.toLowerCase() || '';
    const dataEditFilter = document.getElementById('trackingDataEditFilter')?.value || 'all';

    console.log('ğŸ“‹ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±Ø©:', { dateFilter, monthFilter, operationType, searchTerm, dataEditFilter });

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹ ÙˆØ­Ø¯ÙŠØ«Ø§Ù‹
    let uniqueLogs;
    const currentTime = Date.now();

    if (cachedTrackingLogs && (currentTime - lastCacheTime) < CACHE_DURATION) {
        console.log('ğŸ“¦ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø¤Ù‚ØªØ§Ù‹');
        uniqueLogs = cachedTrackingLogs;
    } else {
        console.log('ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        const cloudLogs = await loadChangeLogsFromSupabase(1000);
        const allLogs = [...cloudLogs, ...changeTrackingLogs];

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª
        uniqueLogs = allLogs.filter((log, index, self) =>
            index === self.findIndex(l => l.id === log.id)
        );

        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
        cachedTrackingLogs = uniqueLogs;
        lastCacheTime = currentTime;
    }

    console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙÙ„ØªØ±Ø©: ${uniqueLogs.length}`);

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
    let filteredLogs = uniqueLogs.filter(log => {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ timestamp ØµØ­ÙŠØ­
        if (!log.timestamp) {
            console.warn('âš ï¸ Ø³Ø¬Ù„ Ø¨Ø¯ÙˆÙ† timestamp:', log.id);
            return false;
        }

        const logDate = new Date(log.timestamp);

        // ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯
        if (dateFilter) {
            const filterDate = new Date(dateFilter);
            const logDateString = logDate.toISOString().split('T')[0];
            const filterDateString = filterDate.toISOString().split('T')[0];

            if (logDateString !== filterDateString) {
                return false;
            }
        }

        // ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©
        if (monthFilter) {
            const [filterYear, filterMonth] = monthFilter.split('-');
            const logYear = logDate.getFullYear();
            const logMonth = logDate.getMonth() + 1;

            if (logYear !== parseInt(filterYear) || logMonth !== parseInt(filterMonth)) {
                return false;
            }
        }

        // ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        if (operationType && log.operationType !== operationType) {
            return false;
        }

        // ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        if (searchTerm) {
            const searchFields = [
                log.unitNumber || '',
                log.propertyName || '',
                log.city || '',
                log.contractNumber || '',
                log.tenantName || '',
                log.newTenant || '',
                log.previousTenant || '',
                log.user || ''
            ];

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
            let matchFound = searchFields.some(field =>
                field.toString().toLowerCase().includes(searchTerm)
            );

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ·Ø§Ø¨Ù‚ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
            if (!matchFound && log.unitNumber && log.propertyName && log.contractNumber) {
                matchFound = isUnitLinkedToSearchTerm(log.unitNumber, log.propertyName, log.contractNumber, searchTerm);
            }

            if (!matchFound) {
                return false;
            }
        }

        return true;
    });

    // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø¹Ù…Ù„ÙŠØ§Øª ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (dataEditFilter !== 'all') {
        if (dataEditFilter === 'hide') {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            filteredLogs = filteredLogs.filter(log =>
                log.operationType !== 'ØªØ­Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª' &&
                log.operationType !== 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª'
            );
        } else if (dataEditFilter === 'first_only') {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø· Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©
            const editOperationsMap = new Map();
            const nonEditLogs = [];

            filteredLogs.forEach(log => {
                if (log.operationType === 'ØªØ­Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª' || log.operationType === 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª') {
                    const unitKey = `${log.propertyName}_${log.unitNumber}`;
                    if (!editOperationsMap.has(unitKey)) {
                        editOperationsMap.set(unitKey, log);
                    }
                } else {
                    nonEditLogs.push(log);
                }
            });

            // Ø¯Ù…Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØºÙŠØ± Ø§Ù„ØªØ­Ø±ÙŠØ±ÙŠØ© Ù…Ø¹ Ø£ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ­Ø±ÙŠØ± Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©
            filteredLogs = [...nonEditLogs, ...Array.from(editOperationsMap.values())];
        }
    }

    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${filteredLogs.length} Ø³Ø¬Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©`);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ - Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ù…Ù†ÙØµÙ„Ø© Ø¹Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const container = document.getElementById('trackingLogsContainer');
    if (container) {
        console.log('ğŸ“¦ ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø· - Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ù†ÙØµÙ„
        container.innerHTML = renderTrackingLogs(filteredLogs);

        // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        window.currentTrackingLogs = filteredLogs;

        // ØªØ´Ø®ÙŠØµ Ø­Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        setTimeout(() => {
            const searchInputAfter = document.getElementById('trackingSearch');
            console.log('ğŸ” Ø­Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©:', {
                exists: !!searchInputAfter,
                value: searchInputAfter?.value || 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
                visible: searchInputAfter ? window.getComputedStyle(searchInputAfter).display !== 'none' : false,
                parent: searchInputAfter?.parentElement?.className || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ§Ù„Ø¯'
            });

            if (!searchInputAfter) {
                console.error('âŒ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ø®ØªÙÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©!');

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
                const fixed = fixMissingSearchField();
                if (!fixed) {
                    showToast('Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ø®ØªÙÙ‰ - ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©', 'error');
                }
            }
        }, 50);
    }

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙÙ„ØªØ±Ø©
    const resultsCount = filteredLogs.length;
    const totalCount = uniqueLogs.length;

    const statsElement = document.querySelector('.tracking-stats');
    if (statsElement) {
        if (resultsCount === totalCount) {
            statsElement.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${totalCount}`;
        } else {
            statsElement.textContent = `Ø¹Ø±Ø¶ ${resultsCount} Ù…Ù† Ø£ØµÙ„ ${totalCount} Ø³Ø¬Ù„`;
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬
    if (resultsCount === 0 && (dateFilter || monthFilter || operationType || searchTerm)) {
        const container = document.getElementById('trackingLogsContainer');
        if (container) {
            container.innerHTML = `
                <div class="no-logs">
                    <i class="fas fa-search"></i>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
                    <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
                    <button onclick="clearTrackingFilters()" class="clear-filters-btn">
                        <i class="fas fa-times"></i> Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
                    </button>
                </div>
            `;
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©
    const unitHistoryBtn = document.getElementById('unitHistoryBtn');
    if (unitHistoryBtn) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯
        const isUnitSearch = searchTerm && searchTerm.length >= 2 && filteredLogs.some(log =>
            log.unitNumber && log.unitNumber.toLowerCase().includes(searchTerm)
        );

        if (isUnitSearch) {
            unitHistoryBtn.style.display = 'inline-flex';
            // Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¨Ø­ÙˆØ« Ø¹Ù†Ù‡Ø§
            window.currentSearchedUnit = searchTerm;

            // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø± Ù„ÙŠØ´Ù…Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
            const unitCount = filteredLogs.filter(log =>
                log.unitNumber && log.unitNumber.toLowerCase().includes(searchTerm)
            ).length;
            unitHistoryBtn.innerHTML = `
                <i class="fas fa-history"></i>
                Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© (${unitCount} Ø³Ø¬Ù„)
            `;
        } else {
            unitHistoryBtn.style.display = 'none';
            window.currentSearchedUnit = null;
        }
    }

    console.log(`ğŸ” Ø§Ù†ØªÙ‡Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙÙ„ØªØ±Ø©: ${resultsCount}/${totalCount} Ø³Ø¬Ù„`);
}

// Ù…Ø³Ø­ ÙÙ„Ø§ØªØ± Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø­Ø³Ù†
function clearTrackingFilters() {
    console.log('ğŸ§¹ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ ÙÙ„Ø§ØªØ± Ø§Ù„ØªØªØ¨Ø¹...');

    // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙÙ„ØªØ±Ø©
    const dateFilter = document.getElementById('trackingDateFilter');
    const monthFilter = document.getElementById('trackingMonthFilter');
    const operationType = document.getElementById('trackingOperationType');
    const searchInput = document.getElementById('trackingSearch');
    const dataEditFilter = document.getElementById('trackingDataEditFilter');

    if (dateFilter) dateFilter.value = '';
    if (monthFilter) monthFilter.value = '';
    if (operationType) operationType.value = '';
    if (searchInput) searchInput.value = '';
    if (dataEditFilter) dataEditFilter.value = 'all';

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©
    const unitHistoryBtn = document.getElementById('unitHistoryBtn');
    if (unitHistoryBtn) {
        unitHistoryBtn.style.display = 'none';
    }
    window.currentSearchedUnit = null;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    filterTrackingLogs();

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¶
    const statsElement = document.querySelector('.tracking-stats');
    if (statsElement) {
        // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙŠ filterTrackingLogs()
    }

    console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ ÙÙ„Ø§ØªØ± Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª');
}

// ===== Ù…ÙŠØ²Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© =====

// Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
async function showUnitHistoryModal() {
    console.log('ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©...');

    const searchTerm = window.currentSearchedUnit;
    if (!searchTerm) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©
    const cloudLogs = await loadChangeLogsFromSupabase(2000);
    const allLogs = [...cloudLogs, ...changeTrackingLogs];

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª ÙˆÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©
    const uniqueLogs = allLogs.filter((log, index, self) =>
        index === self.findIndex(l => l.id === log.id)
    );

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    const unitLogs = uniqueLogs.filter(log =>
        log.unitNumber && log.unitNumber.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (unitLogs.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©', 'info');
        return;
    }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©)
    unitLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©
    const unitHistory = buildUnitHistory(unitLogs);

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    displayUnitHistoryInSection(searchTerm, unitHistory, unitLogs);

    console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©');
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
function displayUnitHistoryInSection(unitNumber, unitHistory, unitLogs) {
    // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const logsContainer = document.getElementById('trackingLogsContainer');
    if (!logsContainer) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶', 'error');
        return;
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©
    const originalContent = logsContainer.innerHTML;

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„ÙŠÙ‡
    window.originalTrackingContent = originalContent;

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©
    const historyHtml = `
        <div class="unit-history-section">
            <!-- Ø±Ø£Ø³ Ø§Ù„Ù‚Ø³Ù… -->
            <div class="unit-history-header">
                <div class="header-content">
                    <button onclick="returnToTrackingLogs()" class="back-to-logs-btn">
                        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ø¬Ù„Ø§Øª
                    </button>
                    <div class="unit-title">
                        <h3><i class="fas fa-history"></i> Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©</h3>
                        <p class="unit-number">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: <strong>${unitNumber}</strong></p>
                    </div>
                    <div class="quick-actions">
                        <button onclick="exportCurrentUnitHistory()" class="quick-export-btn">
                            <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Excel
                        </button>
                        <button onclick="printCurrentUnitHistory()" class="quick-print-btn">
                            <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </div>

                <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
                <div class="unit-stats-bar">
                    <div class="stat-item">
                        <i class="fas fa-users"></i>
                        <span class="stat-number">${unitHistory.tenants.length}</span>
                        <span class="stat-label">Ù…Ø³ØªØ£Ø¬Ø±</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-list"></i>
                        <span class="stat-number">${unitHistory.operations.length}</span>
                        <span class="stat-label">Ø¹Ù…Ù„ÙŠØ©</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-calendar"></i>
                        <span class="stat-number">${getDateRange(unitLogs)}</span>
                        <span class="stat-label">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</span>
                    </div>
                </div>
            </div>

            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© -->
            <div class="unit-history-content-inline">
                ${renderUnitHistoryInline(unitHistory)}
            </div>
        </div>
    `;

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    logsContainer.innerHTML = historyHtml;

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©
    window.currentUnitHistory = {
        unitNumber: unitNumber,
        history: unitHistory,
        logs: unitLogs
    };

    // ØªÙ…Ø±ÙŠØ± Ø³Ù„Ø³ Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù…
    logsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ©
    showToast(`ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
}

// Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
function returnToTrackingLogs() {
    const logsContainer = document.getElementById('trackingLogsContainer');
    if (logsContainer && window.originalTrackingContent) {
        logsContainer.innerHTML = window.originalTrackingContent;
        window.originalTrackingContent = null;
        window.currentUnitHistory = null;
        showToast('ØªÙ… Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹', 'info');
    }
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ø³Ø¬Ù„Ø§Øª
function getDateRange(logs) {
    if (logs.length === 0) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    const dates = logs.map(log => new Date(log.timestamp)).sort((a, b) => a - b);
    const firstDate = formatDateToGregorian(dates[0]);
    const lastDate = formatDateToGregorian(dates[dates.length - 1]);

    if (firstDate === lastDate) {
        return firstDate;
    }

    return `${firstDate} - ${lastDate}`;
}

// Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø¨Ø³Ø·)
function renderUnitHistoryInline(unitHistory) {
    return `
        <div class="inline-history-tabs">
            <div class="inline-tab-buttons">
                <button class="inline-tab-btn active" onclick="switchInlineTab('tenants')">
                    <i class="fas fa-users"></i> Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (${unitHistory.tenants.length})
                </button>
                <button class="inline-tab-btn" onclick="switchInlineTab('operations')">
                    <i class="fas fa-list"></i> Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (${unitHistory.operations.length})
                </button>
            </div>

            <div class="inline-tab-content">
                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† -->
                <div id="inline-tenants-tab" class="inline-tab-panel active">
                    <div class="inline-table-container">
                        <table class="inline-history-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                                    <th><i class="fas fa-file-contract"></i> Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                                    <th><i class="fas fa-calendar-plus"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                                    <th><i class="fas fa-calendar-minus"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                                    <th><i class="fas fa-clock"></i> Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${unitHistory.tenants.map((tenant, index) => `
                                    <tr class="tenant-row" style="animation-delay: ${index * 0.1}s">
                                        <td class="tenant-name">
                                            <strong>${tenant.name}</strong>
                                        </td>
                                        <td class="contract-number">${tenant.contractNumber}</td>
                                        <td class="start-date">${tenant.startDate}</td>
                                        <td class="end-date">${tenant.endDate}</td>
                                        <td class="first-seen">${tenant.firstSeen}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
                <div id="inline-operations-tab" class="inline-tab-panel">
                    <div class="inline-table-container">
                        <table class="inline-history-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th><i class="fas fa-clock"></i> Ø§Ù„ÙˆÙ‚Øª</th>
                                    <th><i class="fas fa-cog"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th><i class="fas fa-user"></i> Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                                    <th><i class="fas fa-file-contract"></i> Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                                    <th><i class="fas fa-user-cog"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${unitHistory.operations.map((op, index) => `
                                    <tr class="operation-row" style="animation-delay: ${index * 0.05}s">
                                        <td class="operation-date">${op.date}</td>
                                        <td class="operation-time">${op.time}</td>
                                        <td class="operation-type">
                                            <span class="operation-badge-inline">${op.operation}</span>
                                        </td>
                                        <td class="operation-tenant">${op.tenant}</td>
                                        <td class="operation-contract">${op.contractNumber}</td>
                                        <td class="operation-user">${op.user}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ù…Ù†
function switchInlineTab(tabName) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.inline-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.inline-tab-panel').forEach(panel => panel.classList.remove('active'));

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    document.querySelector(`[onclick="switchInlineTab('${tabName}')"]`).classList.add('active');
    document.getElementById(`inline-${tabName}-tab`).classList.add('active');
}

// ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
async function exportCurrentUnitHistory() {
    if (!window.currentUnitHistory) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
        return;
    }

    const { unitNumber, history } = window.currentUnitHistory;

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†
    const tenantsData = [
        ['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±'],
        ...history.tenants.map(tenant => [
            tenant.name,
            tenant.contractNumber,
            tenant.startDate,
            tenant.endDate,
            tenant.firstSeen
        ])
    ];

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    const operationsData = [
        ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙˆÙ‚Øª', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'],
        ...history.operations.map(op => [
            op.date,
            op.time,
            op.operation,
            op.tenant,
            op.contractNumber,
            op.startDate,
            op.endDate,
            op.user
        ])
    ];

    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ù…Ù„
    const wb = XLSX.utils.book_new();
    const tenantsWs = XLSX.utils.aoa_to_sheet(tenantsData);
    const operationsWs = XLSX.utils.aoa_to_sheet(operationsData);

    XLSX.utils.book_append_sheet(wb, tenantsWs, 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†');
    XLSX.utils.book_append_sheet(wb, operationsWs, 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
    const fileName = `ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙˆØ­Ø¯Ø©_${unitNumber}_${formatDateToGregorian(new Date()).replace(/\//g, '-')}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showToast('ØªÙ… ØªØµØ¯ÙŠØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// Ø·Ø¨Ø§Ø¹Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function printCurrentUnitHistory() {
    if (!window.currentUnitHistory) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
        return;
    }

    const { unitNumber, history } = window.currentUnitHistory;
    const printWindow = window.open('', '_blank');

    printWindow.document.write(`
        <html dir="rtl">
        <head>
            <title>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                .section { margin-bottom: 30px; }
                .section h3 { background: #f5f5f5; padding: 10px; margin: 0 0 15px 0; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .operation-badge { background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}</h1>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${formatDateToGregorian(new Date())}</p>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†: ${history.tenants.length} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ${history.operations.length}</p>
            </div>

            <div class="section">
                <h3>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.tenants.map(tenant => `
                            <tr>
                                <td><strong>${tenant.name}</strong></td>
                                <td>${tenant.contractNumber}</td>
                                <td>${tenant.startDate}</td>
                                <td>${tenant.endDate}</td>
                                <td>${tenant.firstSeen}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.operations.map(op => `
                            <tr>
                                <td>${op.date}</td>
                                <td>${op.time}</td>
                                <td><span class="operation-badge">${op.operation}</span></td>
                                <td>${op.tenant}</td>
                                <td>${op.contractNumber}</td>
                                <td>${op.user}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

// Ø¨Ù†Ø§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
function buildUnitHistory(unitLogs) {
    const tenants = [];
    const operations = [];

    unitLogs.forEach(log => {
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        operations.push({
            date: formatDateToGregorian(new Date(log.timestamp)),
            time: formatTime(log.timestamp), // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø¨Ø³Ø·
            operation: log.operationType || log.operation_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            tenant: log.tenantName || log.tenant_name || log.newTenant || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            contractNumber: log.contractNumber || log.contract_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            startDate: formatDateField(log.startDate || log.start_date) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            endDate: formatDateField(log.endDate || log.end_date) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            user: log.user || log.user_name || 'Ø§Ù„Ù†Ø¸Ø§Ù…',
            description: log.description || ''
        });

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø§Ù„ÙØ±ÙŠØ¯ÙŠÙ†
        const tenantName = log.tenantName || log.tenant_name || log.newTenant;
        if (tenantName && tenantName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' && tenantName.trim() !== '') {
            const existingTenant = tenants.find(t => t.name === tenantName);
            if (!existingTenant) {
                tenants.push({
                    name: tenantName,
                    contractNumber: log.contractNumber || log.contract_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    startDate: formatDateField(log.startDate || log.start_date) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    endDate: formatDateField(log.endDate || log.end_date) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    firstSeen: formatDateToGregorian(new Date(log.timestamp))
                });
            }
        }
    });

    return {
        tenants: tenants,
        operations: operations
    };
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
function formatDateToGregorian(date) {
    if (!date || isNaN(date.getTime())) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();

    return `${day}/${month}/${year}`;
}

// ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function formatDateField(dateStr) {
    if (!dateStr || dateStr === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') return null;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© dd/mm/yyyy ÙÙ‡Ùˆ ØµØ­ÙŠØ­
    if (typeof dateStr === 'string' && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
        return dateStr;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© yyyy-mm-ddØŒ Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„Ù‡
    if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}/)) {
        const parts = dateStr.split('-');
        if (parts.length >= 3) {
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);

            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
            }
        }
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒÙ€ Date object
    try {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
            return formatDateToGregorian(date);
        }
    } catch (e) {
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    }

    return dateStr; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (YYYY-MM-DD)
function formatDateForDatabase(dateStr) {
    if (!dateStr || dateStr === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') return null;

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ù…Ø«Ù„: "15/03/2024 (15/Ù…Ø§Ø±Ø³/2024)")
    if (typeof dateStr === 'string' && dateStr.includes('(') && dateStr.includes(')')) {
        const numericPart = dateStr.split('(')[0].trim();
        if (numericPart) {
            dateStr = numericPart;
        }
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© dd/mm/yyyyØŒ Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ yyyy-mm-dd
    if (typeof dateStr === 'string' && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const year = parseInt(parts[2]);

            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            }
        }
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© yyyy-mm-ddØŒ ÙÙ‡Ùˆ ØµØ­ÙŠØ­
    if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);

            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            }
        }
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒÙ€ Date object
    try {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            if (year >= 1900 && year <= 2100) {
                return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            }
        }
    } catch (e) {
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    }

    return null; // Ø¥Ø±Ø¬Ø§Ø¹ null Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„
}

// Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø©
function renderUnitHistoryTable(unitHistory) {
    return `
        <div class="unit-history-tabs">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchUnitHistoryTab('tenants')">
                    <i class="fas fa-users"></i> Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (${unitHistory.tenants.length})
                </button>
                <button class="tab-btn" onclick="switchUnitHistoryTab('operations')">
                    <i class="fas fa-list"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (${unitHistory.operations.length})
                </button>
            </div>

            <div class="tab-content">
                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† -->
                <div id="tenants-tab" class="tab-panel active">
                    <div class="table-container">
                        <table class="unit-history-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${unitHistory.tenants.map(tenant => `
                                    <tr>
                                        <td><strong>${tenant.name}</strong></td>
                                        <td>${tenant.contractNumber}</td>
                                        <td>${tenant.startDate}</td>
                                        <td>${tenant.endDate}</td>
                                        <td>${tenant.firstSeen}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
                <div id="operations-tab" class="tab-panel">
                    <div class="table-container">
                        <table class="unit-history-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${unitHistory.operations.map(op => `
                                    <tr>
                                        <td>${op.date}</td>
                                        <td>${op.time}</td>
                                        <td><span class="operation-badge">${op.operation}</span></td>
                                        <td>${op.tenant}</td>
                                        <td>${op.contractNumber}</td>
                                        <td>${op.startDate}</td>
                                        <td>${op.endDate}</td>
                                        <td>${op.user}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ¨ÙˆÙŠØ¨Ø§Øª ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø©
function switchUnitHistoryTab(tabName) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    document.querySelector(`[onclick="switchUnitHistoryTab('${tabName}')"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
}

// ØªØµØ¯ÙŠØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© Ø¥Ù„Ù‰ Excel
async function exportUnitHistory(unitNumber) {
    if (!window.currentUnitHistory) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
        return;
    }

    const { history } = window.currentUnitHistory;

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†
    const tenantsData = [
        ['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±'],
        ...history.tenants.map(tenant => [
            tenant.name,
            tenant.contractNumber,
            tenant.startDate,
            tenant.endDate,
            tenant.firstSeen
        ])
    ];

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    const operationsData = [
        ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙˆÙ‚Øª', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'],
        ...history.operations.map(op => [
            op.date,
            op.time,
            op.operation,
            op.tenant,
            op.contractNumber,
            op.startDate,
            op.endDate,
            op.user
        ])
    ];

    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ù…Ù„
    const wb = XLSX.utils.book_new();
    const tenantsWs = XLSX.utils.aoa_to_sheet(tenantsData);
    const operationsWs = XLSX.utils.aoa_to_sheet(operationsData);

    XLSX.utils.book_append_sheet(wb, tenantsWs, 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†');
    XLSX.utils.book_append_sheet(wb, operationsWs, 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
    const fileName = `ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙˆØ­Ø¯Ø©_${unitNumber}_${formatDateToGregorian(new Date()).replace(/\//g, '-')}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showToast('ØªÙ… ØªØµØ¯ÙŠØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// Ø·Ø¨Ø§Ø¹Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø©
function printUnitHistory(unitNumber) {
    if (!window.currentUnitHistory) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
        return;
    }

    const { history } = window.currentUnitHistory;
    const printWindow = window.open('', '_blank');

    printWindow.document.write(`
        <html dir="rtl">
        <head>
            <title>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                .section { margin-bottom: 30px; }
                .section h3 { background: #f5f5f5; padding: 10px; margin: 0 0 15px 0; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .operation-badge { background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}</h1>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${formatDateToGregorian(new Date())}</p>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†: ${history.tenants.length} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ${history.operations.length}</p>
            </div>

            <div class="section">
                <h3>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.tenants.map(tenant => `
                            <tr>
                                <td><strong>${tenant.name}</strong></td>
                                <td>${tenant.contractNumber}</td>
                                <td>${tenant.startDate}</td>
                                <td>${tenant.endDate}</td>
                                <td>${tenant.firstSeen}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.operations.map(op => `
                            <tr>
                                <td>${op.date}</td>
                                <td>${op.time}</td>
                                <td><span class="operation-badge">${op.operation}</span></td>
                                <td>${op.tenant}</td>
                                <td>${op.contractNumber}</td>
                                <td>${op.startDate}</td>
                                <td>${op.endDate}</td>
                                <td>${op.user}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

// ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¥Ù„Ù‰ Excel - Ù…Ø­Ø³Ù†Ø© Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙÙ„ØªØ± ÙÙ‚Ø·
async function exportTrackingLogs() {
    console.log('ğŸ“Š Ø¨Ø¯Ø¡ ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©...');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø·
    const visibleLogs = getVisibleTrackingLogs();

    if (visibleLogs.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¸Ø§Ù‡Ø±Ø© Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
        return;
    }

    console.log(`ğŸ“Š Ø³ÙŠØªÙ… ØªØµØ¯ÙŠØ± ${visibleLogs.length} Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©`);

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ± Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
    const exportData = visibleLogs.map(log => {
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        const events = log.events || extractEventsFromLog(log).join('; ') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«';
        const changes = log.changes || extractChangesFromLog(log).join('; ') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª';

        return {
            'Ø§Ù„ØªØ§Ø±ÙŠØ®': log.date || formatDate(log.timestamp),
            'Ø§Ù„ÙˆÙ‚Øª': log.time || formatTime(log.timestamp),
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©': log.operationType || log.operation_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': log.tenantName || log.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': log.contractNumber || log.contract_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': log.user || log.user_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø§Ù„Ø¹Ù‚Ø§Ø±': log.propertyName || log.property_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©': log.unitNumbers || log.unitNumber || log.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': log.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø§Ù„Ø­Ø¯Ø«': events,
            'Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©': changes,
            'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø©': log.recordCount || 1
        };
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹');

    // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    const colWidths = [
        { wch: 12 }, // Ø§Ù„ØªØ§Ø±ÙŠØ®
        { wch: 10 }, // Ø§Ù„ÙˆÙ‚Øª
        { wch: 20 }, // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        { wch: 20 }, // Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
        { wch: 15 }, // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
        { wch: 15 }, // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        { wch: 25 }, // Ø§Ù„Ø¹Ù‚Ø§Ø±
        { wch: 20 }, // Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
        { wch: 12 }, // Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
        { wch: 40 }, // Ø§Ù„Ø­Ø¯Ø«
        { wch: 50 }, // Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©
        { wch: 10 }  // Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø©
    ];
    ws['!cols'] = colWidths;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
    const currentDate = formatDate(new Date()).replace(/\//g, '-');
    const fileName = `Ø³Ø¬Ù„_Ø§Ù„ØªØªØ¨Ø¹_${currentDate}.xlsx`;
    XLSX.writeFile(wb, fileName);

    console.log('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
    showToast(`ØªÙ… ØªØµØ¯ÙŠØ± ${exportData.length} Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ù…Ù„Ù Excel`, 'success');
}

// Ø·Ø¨Ø§Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ - Ù…Ø­Ø³Ù†Ø© Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙÙ„ØªØ± ÙÙ‚Ø·
function printTrackingLogs() {
    console.log('ğŸ–¨ï¸ Ø¨Ø¯Ø¡ Ø·Ø¨Ø§Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©...');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const visibleLogs = getVisibleTrackingLogs();

    if (visibleLogs.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¸Ø§Ù‡Ø±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'warning');
        return;
    }

    console.log(`ğŸ“‹ Ø³ÙŠØªÙ… Ø·Ø¨Ø§Ø¹Ø© ${visibleLogs.length} Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©`);

    const printWindow = window.open('', '_blank');
    const currentDate = formatDate(new Date());
    const currentTime = formatTime(new Date());

    printWindow.document.write(`
        <html dir="rtl">
        <head>
            <title>Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</title>
            <meta charset="UTF-8">
            <style>
                @page {
                    size: A4 landscape;
                    margin: 15mm;
                }

                body {
                    font-family: 'Arial', sans-serif;
                    margin: 0;
                    padding: 0;
                    font-size: 12px;
                    line-height: 1.4;
                    direction: rtl;
                }

                .header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 15px;
                }

                .header h1 {
                    margin: 0 0 10px 0;
                    font-size: 24px;
                    color: #333;
                }

                .header .print-info {
                    font-size: 14px;
                    color: #666;
                    margin: 5px 0;
                }

                .summary-info {
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                    text-align: center;
                    border: 1px solid #dee2e6;
                }

                .tracking-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                    font-size: 11px;
                }

                .tracking-table th {
                    background: #343a40;
                    color: white;
                    padding: 8px 6px;
                    text-align: center;
                    font-weight: bold;
                    border: 1px solid #dee2e6;
                    white-space: nowrap;
                }

                .tracking-table td {
                    padding: 6px 4px;
                    border: 1px solid #dee2e6;
                    text-align: center;
                    vertical-align: middle;
                    word-wrap: break-word;
                    max-width: 120px;
                }

                .tracking-table tbody tr:nth-child(even) {
                    background: #f8f9fa;
                }

                .tracking-table tbody tr:hover {
                    background: #e9ecef;
                }

                .operation-type {
                    font-weight: bold;
                    color: #495057;
                }

                .tenant-name {
                    color: #007bff;
                    font-weight: 500;
                }

                .contract-number {
                    color: #28a745;
                    font-weight: 500;
                }

                .date-cell {
                    color: #6c757d;
                    font-size: 10px;
                }

                .time-cell {
                    color: #6c757d;
                    font-size: 10px;
                }

                .events-cell-print {
                    background: #fff3e0;
                    color: #e65100;
                    font-size: 9px;
                    line-height: 1.3;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                    max-width: 150px;
                    text-align: right;
                    padding: 4px !important;
                    vertical-align: top;
                }

                .changes-cell-print {
                    background: #f8f9fa;
                    color: #28a745;
                    font-size: 9px;
                    line-height: 1.3;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                    max-width: 150px;
                    text-align: right;
                    padding: 4px !important;
                    vertical-align: top;
                }

                .footer {
                    margin-top: 30px;
                    text-align: center;
                    font-size: 10px;
                    color: #6c757d;
                    border-top: 1px solid #dee2e6;
                    padding-top: 10px;
                }

                @media print {
                    body {
                        font-size: 10px;
                    }

                    .tracking-table {
                        font-size: 9px;
                    }

                    .tracking-table th,
                    .tracking-table td {
                        padding: 4px 3px;
                    }

                    .header h1 {
                        font-size: 20px;
                    }

                    .print-info {
                        font-size: 12px;
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</h1>
                <div class="print-info">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${currentDate}</div>
                <div class="print-info">ÙˆÙ‚Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${currentTime}</div>
            </div>

            <div class="summary-info">
                Ø¹Ø±Ø¶ ${visibleLogs.length} Ø³Ø¬Ù„ Ù…ÙÙ„ØªØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
            </div>

            <table class="tracking-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„ÙˆÙ‚Øª</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ø¹Ù‚Ø§Ø±</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                        <th>Ø§Ù„Ø­Ø¯Ø«</th>
                        <th>Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${visibleLogs.map(log => {
                        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                        const events = log.events || extractEventsFromLog(log).map(event => `â€¢ ${event}`).join('\n') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«';
                        const changes = log.changes || extractChangesFromLog(log).map(change => `âœ” ${change}`).join('\n') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª';

                        return `
                        <tr>
                            <td class="date-cell">${log.date || formatDate(log.timestamp)}</td>
                            <td class="time-cell">${log.time || formatTime(log.timestamp)}</td>
                            <td class="operation-type">${log.operationType || log.operation_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td class="tenant-name">${log.tenantName || log.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td class="contract-number">${log.contractNumber || log.contract_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td>${log.user || log.user_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td>${log.propertyName || log.property_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td>${log.unitNumbers || log.unitNumber || log.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td>${log.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td class="events-cell-print">${events}</td>
                            <td class="changes-cell-print">${changes}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>

            <div class="footer">
                ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª - ${currentDate} ${currentTime}
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();

    console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
    showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success');
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ====================

// Ù…ØªØºÙŠØ±Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
let currentUser = null;
let userPermissions = null;

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
const users = {
    'Ø¹Ù…Ø±': {
        password: '159',
        role: 'admin',
        fullName: 'Ø§Ù„Ù…Ø¯ÙŠØ± - Ø¹Ù…Ø±',
        permissions: {
            viewData: true,
            editData: true,
            deleteData: true,
            manageProperties: true,
            manageAttachments: true,
            exportData: true,
            importData: true,
            manageSettings: true,
            clearFilters: true
        }
    },
    'Ù…Ø­Ù…Ø¯': {
        password: 'm12345',
        role: 'assistant_admin',
        fullName: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ - Ù…Ø­Ù…Ø¯',
        permissions: {
            viewData: true,
            editData: true,
            deleteData: true,
            manageProperties: true,
            manageAttachments: true,
            exportData: true,
            importData: true,
            manageSettings: true,
            clearFilters: true
        }
    },
    '1234': {
        password: '1234',
        role: 'restricted_assistant',
        fullName: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ',
        permissions: {
            viewData: true,
            editData: false,
            deleteData: false,
            manageProperties: false,
            manageAttachments: true,  // Can view attachments only
            addAttachments: false,    // Cannot upload attachments
            deleteAttachments: false, // Cannot delete attachments
            exportData: true,
            importData: true,
            manageSettings: false,
            clearFilters: true        // Can use clear filters functionality
        }
    }
};

// ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
function initializePermissionSystem() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸Ø©
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            if (users[userData.username] && userData.loginTime) {
                // Ø§Ù„Ø¬Ù„Ø³Ø© ØµØ§Ù„Ø­Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ - Ù„Ø§ Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠ
                // Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ†ØªÙ‡ÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠØ¯ÙˆÙŠ
                console.log('âœ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù„Ø§ Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠ');
                setCurrentUser(userData.username);

                // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯: Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙˆØ±Ø§Ù‹
                if (users[userData.username] && users[userData.username].role === 'limited') {
                    console.log('ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ - Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙˆØ±Ø§Ù‹ Ù…Ù† initializePermissionSystem');
                    hideCrystalLoading();
                }

                // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙˆØ± Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
                setTimeout(() => {
                    addLogoutButton();
                    updateMobileUserSection();
                    console.log('ğŸ”‘ Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† initializePermissionSystem');
                }, 300);

                return;
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', error);
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    showLoginModal();
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function showLoginModal() {
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.classList.add('show');

        // Ù…Ù†Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙØ­Ø©
        document.body.style.overflow = 'hidden';

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        setTimeout(() => {
            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.focus();
            }
        }, 300);
    }
}

// Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function hideLoginModal() {
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function handleLogin(event) {
    event.preventDefault();

    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    if (!username || !password) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (users[username] && users[username].password === password) {
        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­
        setCurrentUser(username);

        // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ±
        const userData = {
            username: username,
            role: users[username].role,
            fullName: users[username].fullName,
            loginTime: new Date().toISOString()
        };
        localStorage.setItem('currentUser', JSON.stringify(userData));
        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userData);

        // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        hideLoginModal();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠØ© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        console.log('ğŸ”® Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­');
        showCrystalLoading();

        // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø¯ÙˆØ¯ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø©
        if (users[username].role === 'limited') {
            console.log('ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© - Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø©');
            // Ù„Ø§ Ù†Ø®ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ØŒ Ø¨Ù„ Ù†ØªØ±ÙƒÙ‡Ø§ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ Ù…Ø¹ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‡Ø§Ø¯Ø¦
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
        showWelcomeMessage(users[username].fullName);

        // ØªØ­Ø¯ÙŠØ« Ø±Ø¤ÙŠØ© Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±)
        setTimeout(() => {
            toggleAttachmentManagementVisibility();
            showAttachmentManagementButtons();
        }, 500);

        // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯: Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø³Ø±Ø¹Ø© ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆØ±ÙŠØ©
        if (users[username].role === 'limited') {
            setTimeout(() => {
                clearAllNotificationsForLimitedUser();
            }, 1000);

            // Ù…Ø±Ø§Ù‚Ø¨ Ø¯ÙˆØ±ÙŠ Ù„Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ØªØ¸Ù‡Ø±
            const notificationWatcher = setInterval(() => {
                clearAllNotificationsForLimitedUser();
            }, 3000); // ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù

            // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            window.limitedUserNotificationWatcher = notificationWatcher;
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        setTimeout(() => {
            updateMobileUserSection();
            addLogoutButton();
            console.log('ğŸ”‘ Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† handleLogin');
        }, 100);

        // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';

    } else {
        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙØ§Ø´Ù„
        alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        document.getElementById('password').focus();
        document.getElementById('password').select();
    }
}

// ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
function setCurrentUser(username) {
    if (users[username]) {
        currentUser = username;
        userPermissions = users[username].permissions;

        // ØªØ³Ø¬ÙŠÙ„ Ø®Ø§Øµ Ù„Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ… Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        if (username === '1234') {
            console.log('ğŸ” ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…:', userPermissions);
            console.log('ğŸ” ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', userPermissions.manageAttachments);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        resetFiltersToDefault();

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        applyUserPermissions();

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ
        if (username === '1234') {
            ensureTrackingButtonVisibilityForSenidi();
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        if (users[username].role === 'limited') {
            console.log('ğŸ”’ ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©...');

            // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø© Ø¨Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
            console.log('ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ - Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø© Ø³ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ');

            // ØªØ·Ø¨ÙŠÙ‚ ÙÙˆØ±ÙŠ Ù„Ù„Ù‚ÙŠÙˆØ¯
            restrictAdminButtonsForLimitedUser();

            // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ù…Ø­Ø³Ù† Ù…Ø¹ Ø£ÙˆÙ‚Ø§Øª Ø£Ù‚Ù„
            setTimeout(() => restrictAdminButtonsForLimitedUser(), 50);
            setTimeout(() => restrictAdminButtonsForLimitedUser(), 150);

            // ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
            setTimeout(() => {
                setupAttachmentsPermissionObserver();
            }, 500);

            // ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
            setTimeout(() => {
                setupAdminButtonsObserver();
            }, 1000);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙˆØ± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        setTimeout(() => {
            addLogoutButton();
            updateMobileUserSection();
        }, 100);

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ (Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ)
        if (username === '1234') {
            setTimeout(() => {
                ensureTrackingButtonVisibilityForSenidi();
            }, 1500);

            // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
            setTimeout(() => {
                ensureTrackingButtonVisibilityForSenidi();
            }, 3000);
        }

        console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${users[username].fullName}`);
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function resetFiltersToDefault() {
    console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...');

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ "Ø§Ù„ÙƒÙ„"
    currentCountry = null;
    currentProperty = null;
    filterStatus = null;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„Ø§ØªØ± Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª
    if (typeof contractTypeFilter !== 'undefined') {
        contractTypeFilter = null;
    }

    if (typeof propertyTypeFilter !== 'undefined') {
        propertyTypeFilter = null;
    }

    if (typeof multiFilterSelectedCity !== 'undefined') {
        multiFilterSelectedCity = null;
    }

    if (typeof multiFilterSelectedProperties !== 'undefined') {
        multiFilterSelectedProperties = [];
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (typeof dateFilterType !== 'undefined') {
        dateFilterType = '';
        dateFilterDay = '';
        dateFilterMonth = '';
        dateFilterYear = '';
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„Ø§ØªØ± Ø¥Ø¶Ø§ÙÙŠØ©
    if (typeof searchState !== 'undefined') {
        searchState.global = '';
        searchState.property = '';
        searchState.isSearchActive = false;
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„Ø§ØªØ± Ø§Ù„ØªØªØ¨Ø¹ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª
    if (typeof trackingFilters !== 'undefined') {
        trackingFilters = {};
    }

    // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    setTimeout(() => {
        clearAllSearchFields();
        resetAllForms();
        resetUIElements();
    }, 100);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„ØªØ¹ÙƒØ³ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    setTimeout(() => {
        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù† (Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ¯ "Ø§Ù„ÙƒÙ„")
        initCountryButtons();

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª)
        initPropertyList();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const statusFilterButtons = document.querySelectorAll('.status-filter button');
        statusFilterButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes('Ø§Ù„ÙƒÙ„')) {
                btn.classList.add('active');
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        renderData();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        if (typeof updateTotalStats === 'function') {
            updateTotalStats();
        }

        console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ "Ø§Ù„ÙƒÙ„" ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
    }, 200);

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    setTimeout(() => {
        saveAppState();
    }, 400);
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function resetUIElements() {
    try {
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
        const filterButtons = document.querySelectorAll('.filter-btn, .status-filter button, .city-btn');
        filterButtons.forEach(btn => {
            btn.classList.remove('active', 'selected');
            if (btn.textContent.includes('Ø§Ù„ÙƒÙ„') || btn.textContent.includes('Ø¬Ù…ÙŠØ¹')) {
                btn.classList.add('active');
            }
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            if (select.options.length > 0) {
                select.selectedIndex = 0;
            }
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
        const dateInputs = document.querySelectorAll('input[type="date"], input[type="month"]');
        dateInputs.forEach(input => {
            input.value = '';
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† checkboxes Ùˆ radio buttons
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        const radios = document.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => {
            radio.checked = false;
        });

        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø­Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const cancelButtons = document.querySelectorAll('.cancel-btn, .clear-btn, .global-cancel-btn');
        cancelButtons.forEach(btn => {
            if (btn.style) {
                btn.style.display = 'none';
            }
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø«
        const searchIndicators = document.querySelectorAll('.search-indicator, .search-loading');
        searchIndicators.forEach(indicator => {
            indicator.classList.remove('searching', 'active');
            if (indicator.style) {
                indicator.style.display = 'none';
            }
        });

        console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:', error);
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
function resetAllForms() {
    try {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¯Ù†
        const citySelects = document.querySelectorAll('select[id*="city"], select[id*="City"]');
        citySelects.forEach(select => {
            if (select.options.length > 0) {
                select.selectedIndex = 0; // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ (Ø¹Ø§Ø¯Ø© "Ø§Ù„ÙƒÙ„")
            }
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
        const propertySelects = document.querySelectorAll('select[id*="property"], select[id*="Property"]');
        propertySelects.forEach(select => {
            if (select.options.length > 0) {
                select.selectedIndex = 0; // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ (Ø¹Ø§Ø¯Ø© "Ø§Ù„ÙƒÙ„")
            }
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
        const filterButtons = document.querySelectorAll('.filter-btn, .status-filter button');
        filterButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes('Ø§Ù„ÙƒÙ„') || btn.textContent.includes('Ø¬Ù…ÙŠØ¹')) {
                btn.classList.add('active');
            }
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
        const dateInputs = document.querySelectorAll('input[type="date"], input[type="month"]');
        dateInputs.forEach(input => {
            input.value = '';
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³Ù†ÙˆØ§Øª ÙˆØ§Ù„Ø´Ù‡ÙˆØ±
        const yearSelects = document.querySelectorAll('select[id*="year"], select[id*="Year"]');
        const monthSelects = document.querySelectorAll('select[id*="month"], select[id*="Month"]');

        yearSelects.forEach(select => {
            if (select.options.length > 0) {
                select.selectedIndex = 0;
            }
        });

        monthSelects.forEach(select => {
            if (select.options.length > 0) {
                select.selectedIndex = 0;
            }
        });

        console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬:', error);
    }
}

// ØªØ·Ø¨ÙŠÙ‚ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function applyUserPermissions() {
    if (!userPermissions) return;

    const body = document.body;

    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    body.classList.remove('limited-user', 'admin-user', 'assistant-admin-user');

    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (users[currentUser].role === 'limited') {
        body.classList.add('limited-user');
        hideLimitedUserElements();

        // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø­Ø³Ù† Ù…Ø¹ Ø£ÙˆÙ‚Ø§Øª Ø£Ù‚Ù„
        setTimeout(() => {
            restrictAdminButtonsForLimitedUser();
        }, 100);

        setTimeout(() => {
            restrictAdminButtonsForLimitedUser();
        }, 300);
    } else {
        body.classList.add('admin-user');
    }

    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø®Ø§Øµ Ù„Ø¹Ù…Ø± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ©
    if (currentUser === 'Ø¹Ù…Ø±') {
        body.classList.add('user-omar');
        console.log('ğŸ”§ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© Ù„Ø¹Ù…Ø±');
        // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ø¹Ù…Ø±
        setTimeout(() => showAttachmentButtonsForAuthorizedUser(), 100);
    } else {
        body.classList.remove('user-omar');
        console.log('ğŸ”’ ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ©');
    }

    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø®Ø§Øµ Ù„Ù…Ø­Ù…Ø¯ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (currentUser === 'Ù…Ø­Ù…Ø¯') {
        body.classList.add('user-mohammed');
        console.log('ğŸ”§ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ø­Ù…Ø¯');
        // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù…Ø­Ù…Ø¯
        setTimeout(() => showAttachmentButtonsForAuthorizedUser(), 100);
    } else {
        body.classList.remove('user-mohammed');
    }

    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø®Ø§Øµ Ù„Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ… Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    if (currentUser === '1234') {
        body.classList.add('user-abu-tameem');
        console.log('ğŸ”’ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ… - Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
    } else {
        body.classList.remove('user-abu-tameem');
    }

    // ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© getCurrentUser
    window.getCurrentUser = function() {
        return users[currentUser]?.fullName || currentUser || 'Ø§Ù„Ù†Ø¸Ø§Ù…';
    };

    // Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…
    window.testAbuTameemPermissions = function() {
        if (currentUser !== '1234') {
            alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø®ØµØµ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ… ÙÙ‚Ø·');
            return;
        }

        const permissions = users['1234'].permissions;
        const testResults = {
            viewData: permissions.viewData,
            editData: permissions.editData,
            deleteData: permissions.deleteData,
            manageProperties: permissions.manageProperties,
            manageAttachments: permissions.manageAttachments,
            addAttachments: permissions.addAttachments,
            deleteAttachments: permissions.deleteAttachments,
            exportData: permissions.exportData,
            importData: permissions.importData,
            manageSettings: permissions.manageSettings
        };

        console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…:', testResults);

        const message = `
ğŸ§ª Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…:

âœ… Ø§Ù„Ù…Ø³Ù…ÙˆØ­:
â€¢ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${testResults.viewData ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}
â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø¹Ø±Ø¶/ØªØ­Ù…ÙŠÙ„): ${testResults.manageAttachments ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}
â€¢ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${testResults.exportData ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}
â€¢ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${testResults.importData ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}

âŒ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±:
â€¢ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${testResults.editData ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}
â€¢ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${testResults.deleteData ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}
â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: ${testResults.manageProperties ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}
â€¢ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª: ${testResults.addAttachments ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}
â€¢ Ø­Ø°Ù Ù…Ø±ÙÙ‚Ø§Øª: ${testResults.deleteAttachments ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}
â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ${testResults.manageSettings ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}

ğŸ¯ Ø§Ù„Ø­Ø§Ù„Ø©: ${testResults.editData || testResults.deleteData || testResults.manageProperties || testResults.addAttachments || testResults.deleteAttachments || testResults.manageSettings ? 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª' : 'âœ… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØµØ­ÙŠØ­Ø©'}
        `;

        alert(message);
        return testResults;
    };

    // Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ… (Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ)
    window.testAlSenidiClearFilters = function() {
        if (currentUser !== '1234') {
            alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø®ØµØµ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ ÙÙ‚Ø·');
            return;
        }

        console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ...');

        // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
        const clearButtons = document.querySelectorAll('.clear-all-filters-btn');
        console.log(`ğŸ” Ø¹Ø¯Ø¯ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${clearButtons.length}`);

        clearButtons.forEach((btn, index) => {
            console.log(`ğŸ”˜ Ø²Ø± ${index + 1}: Ù…Ø±Ø¦ÙŠ = ${btn.style.display !== 'none'}, Ù…Ø¹Ø·Ù„ = ${btn.disabled}`);
        });

        // ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
        const hasPermission = users['1234'].permissions.clearFilters;
        console.log(`âœ… ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±: ${hasPermission ? 'Ù…Ø³Ù…ÙˆØ­' : 'Ù…Ù…Ù†ÙˆØ¹'}`);

        // Ø§Ø®ØªØ¨Ø§Ø± ØªÙ†ÙÙŠØ° ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
        if (typeof clearAllFilters === 'function') {
            console.log('âœ… ÙˆØ¸ÙŠÙØ© clearAllFilters Ù…ØªÙˆÙØ±Ø©');

            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø£ÙˆÙ„Ø§Ù‹
            if (typeof selectCountry === 'function') {
                selectCountry('Ø§Ù„Ø±ÙŠØ§Ø¶');
                console.log('ğŸ­ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            }

            setTimeout(() => {
                // ØªÙ†ÙÙŠØ° Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
                clearAllFilters();
                console.log('ğŸ—‘ï¸ ØªÙ… ØªÙ†ÙÙŠØ° Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ù†Ø¬Ø§Ø­');

                // ÙØ­Øµ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                setTimeout(() => {
                    const isCleared = !currentCountry && !currentProperty && !filterStatus;
                    console.log(`ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${isCleared ? 'Ù†Ø¬Ø­ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±' : 'ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±'}`);
                    alert(`Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ: ${isCleared ? 'Ù†Ø¬Ø­ âœ…' : 'ÙØ´Ù„ âŒ'}`);
                }, 500);
            }, 1000);
        } else {
            console.log('âŒ ÙˆØ¸ÙŠÙØ© clearAllFilters ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
            alert('âŒ ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }

        return {
            buttonsFound: clearButtons.length,
            hasPermission: hasPermission,
            functionAvailable: typeof clearAllFilters === 'function'
        };
    };
}

// ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ø¨Ø¯ÙˆÙ† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±)
function hideLimitedUserElements() {
    console.log('ğŸ”’ ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...');

    // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø®ÙØ§Ø¦Ù‡Ø§
    restrictAdminButtonsForLimitedUser();

    // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ø­Ø°Ù ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙ‚Ø·
    const editBtns = document.querySelectorAll('.edit-btn, .delete-btn, .add-btn');
    editBtns.forEach(btn => {
        if (btn) btn.style.display = 'none';
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
    const trackingManagementBtn = document.getElementById('trackingManagementBtn');
    if (trackingManagementBtn) {
        trackingManagementBtn.style.display = 'none';
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    applyAttachmentsRestrictions();

    console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
}

// ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
function restrictAdminButtonsForLimitedUser() {
    console.log('ğŸ”’ ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©...');

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
    const restrictedButtons = [
        // Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª - Ø¥Ø®ÙØ§Ø¡ ÙƒØ§Ù…Ù„
        { selector: '#propertyManagerBtn', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª', hide: true },
        { selector: '.management-btn', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª', hide: true },
        { selector: '#mobile-property-manager-btn', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª', hide: true },

        // Ø£Ø²Ø±Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
        { selector: '#updateDatesBtn', name: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®' },
        { selector: '#mobile-date-update-btn', name: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®' },

        // Ø£Ø²Ø±Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        { selector: '#fixStatisticsBtn', name: 'Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },
        { selector: '#mobile-fix-statistics-btn', name: 'Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },

        // Ø£Ø²Ø±Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
        { selector: '#mobile-clear-state-btn', name: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©' },

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - Ø¥Ø®ÙØ§Ø¡ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©ØŒ ØªÙ‚ÙŠÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
        { selector: '.settings-btn', name: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', hide: true },
        { selector: '.header-dropdown:has(.settings-btn)', name: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', hide: true },
        { selector: '#mobile-settings-btn', name: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' },

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ø­Ø°Ù ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        { selector: '.edit-btn', name: 'ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©' },
        { selector: '.delete-btn', name: 'Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©' },
        { selector: '.add-btn', name: 'Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯' }
    ];

    restrictedButtons.forEach(buttonInfo => {
        const buttons = document.querySelectorAll(buttonInfo.selector);
        buttons.forEach(button => {
            if (button) {
                if (buttonInfo.hide) {
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± ÙƒØ§Ù…Ù„Ø§Ù‹ (Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª)
                    button.style.display = 'none';
                    console.log(`ğŸš« ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø²Ø±: ${buttonInfo.name}`);
                } else {
                    // ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø²Ø± Ù…Ø±Ø¦ÙŠØ§Ù‹
                    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);

                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø¬Ø¯ÙŠØ¯ ÙŠØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showNoPermissionMessage(`Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ "${buttonInfo.name}"`);
                        return false;
                    });

                    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø­Ø¸ÙˆØ±
                    newButton.classList.add('restricted-button');
                    newButton.title = `Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ "${buttonInfo.name}"`;

                    console.log(`ğŸ”’ ØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø²Ø±: ${buttonInfo.name}`);
                }
            }
        });
    });

    // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    const dropdownItems = [
        { selector: '[onclick*="showPropertyManager"]', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª', hide: true },
        { selector: '[onclick*="fixStatisticsNow"]', name: 'Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },
        { selector: '[onclick*="showDateUpdateModal"]', name: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®' },
        { selector: '[onclick*="openDateUpdateModal"]', name: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®' },
        { selector: '[onclick*="clearAppStateWithConfirmation"]', name: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©' }
    ];

    dropdownItems.forEach(itemInfo => {
        const items = document.querySelectorAll(itemInfo.selector);
        items.forEach(item => {
            if (item) {
                if (itemInfo.hide) {
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± ÙƒØ§Ù…Ù„Ø§Ù‹
                    item.style.display = 'none';
                    console.log(`ğŸš« ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ${itemInfo.name}`);
                } else {
                    // ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø±Ø¦ÙŠØ§Ù‹
                    // Ø¥Ø²Ø§Ù„Ø© onclick Ø§Ù„Ø³Ø§Ø¨Ù‚
                    item.removeAttribute('onclick');

                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø¬Ø¯ÙŠØ¯
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showNoPermissionMessage(`Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ "${itemInfo.name}"`);
                        closeAllDropdowns(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
                        return false;
                    });

                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ
                    item.style.opacity = '0.6';
                    item.style.cursor = 'not-allowed';
                    item.title = `Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ "${itemInfo.name}"`;

                    console.log(`ğŸ”’ ØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ${itemInfo.name}`);
                }
            }
        });
    });

    console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©');
}

// ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
function applyAttachmentsRestrictions() {
    console.log('ğŸ“ ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...');

    // Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø±ÙØ¹ (Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©)
    const uploadElements = document.querySelectorAll(`
        .upload-area, .upload-section, .upload-dropzone, .upload-zone,
        .file-upload-area, .totals-upload-zone, .enhanced-upload,
        .upload-notes-sidebar, .mobile-upload-section, .add-attachment-btn,
        .upload-btn, .file-input-wrapper, .drag-drop-area
    `);
    uploadElements.forEach(element => {
        if (element) element.style.display = 'none';
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„ØªØ­Ø±ÙŠØ±
    const deleteElements = document.querySelectorAll(`
        .btn-delete, .delete-btn, .mobile-action-btn.delete,
        .attachment-btn.delete-btn, .btn-enhanced.btn-delete,
        .sync-btn, .attachment-btn.sync-btn, .edit-attachment-btn,
        .modify-btn, .update-btn
    `);
    deleteElements.forEach(element => {
        if (element) element.style.display = 'none';
    });

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    const contentLayouts = document.querySelectorAll('.content-layout-new');
    contentLayouts.forEach(layout => {
        if (layout) {
            layout.style.gridTemplateColumns = '1fr';
        }
    });

    const attachmentLists = document.querySelectorAll('.attachments-list');
    attachmentLists.forEach(list => {
        if (list) {
            list.style.width = '100%';
            list.style.maxWidth = '100%';
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ù„Ù…Ù†Ø¹ Ø§Ù„Ø±ÙØ¹
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        if (input.id && (input.id.includes('Upload') || input.id.includes('File'))) {
            input.disabled = true;
            input.style.display = 'none';
        }
    });

    // Ù…Ù†Ø¹ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
    const dragElements = document.querySelectorAll('.upload-area, .upload-dropzone, .enhanced-upload');
    dragElements.forEach(element => {
        if (element) {
            element.style.pointerEvents = 'none';
            element.style.cursor = 'not-allowed';
            element.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                showNoPermissionMessage();
                return false;
            };
        }
    });

    console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ø¹Ù„Ø§Ù…ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
function addLimitedUserNoticeToAttachments() {
    if (!userPermissions || userPermissions.manageAttachments) return;

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
    const attachmentModals = document.querySelectorAll('.attachments-modal, .card-attachments-modal, .mobile-attachments-modal');

    attachmentModals.forEach(modal => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
        if (modal.querySelector('.limited-user-attachments-notice')) return;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©
        const notice = document.createElement('div');
        notice.className = 'limited-user-attachments-notice';
        notice.innerHTML = `
            <i class="fas fa-info-circle"></i>
            ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· - ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ù‡Ø¯Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆÙ„ÙƒÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø£Ùˆ Ø­Ø°Ù Ù…Ù„ÙØ§Øª
        `;

        // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø©
        const modalContent = modal.querySelector('.attachments-modal-content, .card-modal-content, .mobile-attachments-content');
        if (modalContent) {
            modalContent.insertBefore(notice, modalContent.firstChild);
        }
    });
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¸Ù‡Ø§Ø± Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙˆØ¯
const originalShowAttachmentsModal = window.showAttachmentsModal;
window.showAttachmentsModal = function(city, propertyName) {
    if (originalShowAttachmentsModal) {
        originalShowAttachmentsModal(city, propertyName);

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø¨Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
        setTimeout(() => {
            if (users[currentUser]?.role === 'limited') {
                applyAttachmentsRestrictions();
                addLimitedUserNoticeToAttachments();
            } else if (currentUser === 'Ø¹Ù…Ø±' || currentUser === 'Ù…Ø­Ù…Ø¯') {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø®ÙˆÙ„ÙŠÙ†
                showAttachmentButtonsForAuthorizedUser();
            }
        }, 100);
    }
};

const originalShowCardAttachmentsModal = window.showCardAttachmentsModal;
window.showCardAttachmentsModal = function(city, propertyName, contractNumber, unitNumber) {
    if (originalShowCardAttachmentsModal) {
        originalShowCardAttachmentsModal(city, propertyName, contractNumber, unitNumber);

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø¨Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
        setTimeout(() => {
            if (users[currentUser]?.role === 'limited') {
                applyAttachmentsRestrictions();
                addLimitedUserNoticeToAttachments();
            } else if (currentUser === 'Ø¹Ù…Ø±' || currentUser === 'Ù…Ø­Ù…Ø¯') {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø®ÙˆÙ„ÙŠÙ†
                showAttachmentButtonsForAuthorizedUser();
            }
        }, 100);
    }
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø¹ÙŠÙ†Ø©
function checkPermission(action) {
    if (!userPermissions) {
        showNoPermissionMessage();
        return false;
    }

    const hasPermission = userPermissions[action] === true;

    if (!hasPermission) {
        showNoPermissionMessage();
    }

    return hasPermission;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ù…Ù‚ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø¹Ù…Ø± ÙˆÙ…Ø­Ù…Ø¯ ÙÙ‚Ø·)
function checkAttachmentPermission(operation = 'manage', showError = true) {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    let currentUserName = null;

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            currentUserName = userData.username;
        } catch (e) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ parsingØŒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ ÙƒÙ†Øµ Ø¨Ø³ÙŠØ·
            currentUserName = savedUser;
        }
    }

    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ ÙÙŠ localStorageØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    if (!currentUserName && window.currentUser) {
        currentUserName = window.currentUser;
    }

    // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ø¹Ù…Ø± ÙˆÙ…Ø­Ù…Ø¯
    const allowedUsers = ['Ø¹Ù…Ø±', 'Ù…Ø­Ù…Ø¯'];

    if (!allowedUsers.includes(currentUserName)) {
        if (showError) {
            let operationText = '';
            switch(operation) {
                case 'upload':
                    operationText = 'Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª';
                    break;
                case 'delete':
                    operationText = 'Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª';
                    break;
                case 'bulk_delete':
                    operationText = 'Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª';
                    break;
                default:
                    operationText = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª';
            }

            showNoPermissionMessage(`Ø¹Ø°Ø±Ø§Ù‹ØŒ ${operationText} Ù…Ù‚ØµÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† (Ø¹Ù…Ø± ÙˆÙ…Ø­Ù…Ø¯) ÙÙ‚Ø·`);
        }
        return false;
    }

    return true;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø®ÙˆÙ„ Ù„Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø­Ø°Ù (Ø¹Ù…Ø± ÙˆÙ…Ø­Ù…Ø¯ ÙÙ‚Ø·)
function isAuthorizedUser() {
    let currentUserName = null;

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            currentUserName = userData.username;
        } catch (e) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ parsingØŒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ ÙƒÙ†Øµ Ø¨Ø³ÙŠØ·
            currentUserName = savedUser;
        }
    }

    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ ÙÙŠ localStorageØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    if (!currentUserName && window.currentUser) {
        currentUserName = window.currentUser;
    }

    const allowedUsers = ['Ø¹Ù…Ø±', 'Ù…Ø­Ù…Ø¯'];
    const isAuthorized = allowedUsers.includes(currentUserName);

    console.log(`ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±ÙØ¹/Ø§Ù„Ø­Ø°Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUserName} - Ù…Ø®ÙˆÙ„: ${isAuthorized}`);

    return isAuthorized;
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„Ø¹Ø±Ø¶)
function canViewAttachments() {
    let currentUserName = null;

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            currentUserName = userData.username;
        } catch (e) {
            currentUserName = savedUser;
        }
    }

    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ ÙÙŠ localStorageØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    if (!currentUserName && window.currentUser) {
        currentUserName = window.currentUser;
    }

    // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    const allUsers = ['Ø¹Ù…Ø±', 'Ù…Ø­Ù…Ø¯', '1234'];
    const canView = allUsers.includes(currentUserName);

    console.log(`ğŸ‘ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUserName} - ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø±Ø¶: ${canView}`);

    return canView;
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø®ÙˆÙ„ÙŠÙ† (Ø¹Ù…Ø± ÙˆÙ…Ø­Ù…Ø¯)
function showAttachmentButtonsForAuthorizedUser() {
    console.log('ğŸ”“ Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø®ÙˆÙ„');

    // Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø¥Ø±ÙØ§Ù‚
    const deleteButtons = document.querySelectorAll('.delete-btn, .attachment-btn.delete-btn, .btn-delete');
    const uploadAreas = document.querySelectorAll('.upload-area, .upload-section, .upload-dropzone, .upload-zone, .file-upload-area');
    const attachmentActions = document.querySelectorAll('.attachment-actions');

    deleteButtons.forEach(btn => {
        btn.style.display = '';
        btn.style.visibility = 'visible';
    });

    uploadAreas.forEach(area => {
        area.style.display = '';
        area.style.visibility = 'visible';
    });

    attachmentActions.forEach(actions => {
        actions.style.display = 'flex';
        actions.style.visibility = 'visible';
    });

    console.log(`âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ${deleteButtons.length} Ø²Ø± Ø­Ø°Ù Ùˆ ${uploadAreas.length} Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹`);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†)
function canViewAttachmentManager() {
    let currentUserName = null;

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            currentUserName = userData.username;
        } catch (e) {
            currentUserName = savedUser;
        }
    }

    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ ÙÙŠ localStorageØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    if (!currentUserName && window.currentUser) {
        currentUserName = window.currentUser;
    }

    // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    const canView = currentUserName && currentUserName !== 'guest';

    console.log(`ğŸ‘ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUserName} - ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø±Ø¶: ${canView}`);

    return canView;
}

// Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function toggleAttachmentManagementVisibility() {
    const canView = canViewAttachmentManager();

    console.log(`ğŸ” Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø±Ø¤ÙŠØ© Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª - ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø±Ø¶: ${canView}`);

    // Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
    const attachmentElements = [
        // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        {
            element: document.querySelector('.dropdown-item[onclick*="showAttachmentsManagerFromDropdown"]'),
            name: 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©'
        },
        // Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        {
            element: document.getElementById('attachmentsManagerBtn'),
            name: 'Ø²Ø± Ø§Ù„Ù‡ÙŠØ¯Ø±'
        },
        // Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
        {
            element: document.getElementById('mobile-attachments-btn'),
            name: 'Ø²Ø± Ø§Ù„Ø¬ÙˆØ§Ù„'
        }
    ];

    attachmentElements.forEach(({element, name}) => {
        if (element) {
            if (canView) {
                element.style.display = '';
                element.style.visibility = 'visible';
                element.style.opacity = '1';
                console.log(`âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ${name}`);
            } else {
                element.style.display = 'none';
                element.style.visibility = 'hidden';
                element.style.opacity = '0';
                console.log(`âŒ ØªÙ… Ø¥Ø®ÙØ§Ø¡ ${name}`);
            }
        } else {
            console.log(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${name}`);
        }
    });

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø£ÙŠØ¶Ø§Ù‹
    const headerAttachmentBtns = document.querySelectorAll('[onclick*="showAttachmentsManager"]');
    headerAttachmentBtns.forEach(btn => {
        if (btn) {
            if (canView) {
                btn.style.display = '';
                btn.style.visibility = 'visible';
            } else {
                btn.style.display = 'none';
                btn.style.visibility = 'hidden';
            }
        }
    });

    console.log(`ğŸ” Ø§Ù†ØªÙ‡Ù‰ ØªØ­Ø¯ÙŠØ« Ø±Ø¤ÙŠØ© Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª - ${canView ? 'Ù…Ø±Ø¦ÙŠØ©' : 'Ù…Ø®ÙÙŠØ©'}`);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­ (Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†)
function showAttachmentManagementButtons() {
    const canView = canViewAttachmentManager();

    if (!canView) {
        console.log('ğŸ” Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - Ù„Ù† ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        return;
    }

    console.log('ğŸ” Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„');

    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    const headerBtn = document.getElementById('attachmentsManagerBtn');
    if (headerBtn) {
        headerBtn.style.display = 'inline-block';
        headerBtn.style.visibility = 'visible';
        headerBtn.style.opacity = '1';

        // Ø¥Ø¶Ø§ÙØ© event listener Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
        if (!headerBtn.onclick) {
            headerBtn.onclick = function() {
                showAttachmentsManager();
            };
        }

        console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±');
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
    const mobileBtn = document.getElementById('mobile-attachments-btn');
    if (mobileBtn) {
        mobileBtn.style.display = 'block';
        mobileBtn.style.visibility = 'visible';
        mobileBtn.style.opacity = '1';

        // Ø¥Ø¶Ø§ÙØ© event listener Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
        if (!mobileBtn.onclick) {
            mobileBtn.onclick = function() {
                showAttachmentsManager();
                // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬ÙˆØ§Ù„
                const mobileMenu = document.getElementById('mobileMenu');
                const menuOverlay = document.getElementById('menuOverlay');
                if (mobileMenu) mobileMenu.classList.remove('active');
                if (menuOverlay) menuOverlay.classList.remove('active');
            };
        }

        console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„');
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    const dropdownItem = document.querySelector('.dropdown-item[onclick*="showAttachmentsManagerFromDropdown"]');
    if (dropdownItem) {
        dropdownItem.style.display = 'block';
        dropdownItem.style.visibility = 'visible';
        dropdownItem.style.opacity = '1';
        console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©');
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª
function showNoPermissionMessage(customMessage = null) {
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø©
    const existingMessage = document.querySelector('.no-permission-message');
    if (existingMessage) {
        existingMessage.remove();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    const message = document.createElement('div');
    message.className = 'no-permission-message';

    const messageText = customMessage || 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡';

    message.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-lock" style="margin-left: 8px; color: #dc3545;"></i>
            <span>${messageText}</span>
        </div>
    `;

    // ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #fff, #f8f9fa);
        color: #721c24;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        z-index: 10000;
        font-weight: 600;
        font-size: 16px;
        border: 2px solid #dc3545;
        min-width: 300px;
        text-align: center;
        animation: slideInScale 0.3s ease-out;
    `;

    // Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
    if (!document.querySelector('#noPermissionAnimation')) {
        const style = document.createElement('style');
        style.id = 'noPermissionAnimation';
        style.textContent = `
            @keyframes slideInScale {
                0% {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.8);
                }
                100% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }

            .no-permission-message:hover {
                transform: translate(-50%, -50%) scale(1.02) !important;
                transition: transform 0.2s ease;
            }
        `;
        document.head.appendChild(style);
    }

    document.body.appendChild(message);

    // Ø¥Ø¶Ø§ÙØ© ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
        audio.volume = 0.1;
        audio.play().catch(() => {}); // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„ØµÙˆØª
    } catch (e) {}

    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let displayDuration = 4000; // 4 Ø«ÙˆØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†

    // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† ÙÙ‚Ø·
    if (currentUser && users[currentUser] && users[currentUser].role === 'limited') {
        displayDuration = 2000; // Ø«Ø§Ù†ÙŠØªØ§Ù† ÙÙ‚Ø·
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    setTimeout(() => {
        if (message.parentNode) {
            message.style.animation = 'slideInScale 0.3s ease-out reverse';
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 300);
        }
    }, displayDuration);

    console.log('ğŸ”’ ØªÙ… Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', messageText);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
function showWelcomeMessage(fullName) {
    const message = document.createElement('div');
    message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        z-index: 2500;
        font-weight: 600;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;

    // Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…
    if (currentUser === '1234') {
        message.innerHTML = `
            <i class="fas fa-user-check" style="margin-left: 8px;"></i>
            Ù…Ø±Ø­Ø¨Ø§Ù‹ ${fullName} - Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        `;
    } else {
        message.innerHTML = `
            <i class="fas fa-check-circle" style="margin-left: 8px;"></i>
            Ù…Ø±Ø­Ø¨Ø§Ù‹ ${fullName}
        `;
    }

    document.body.appendChild(message);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    setTimeout(() => {
        message.style.transform = 'translateX(0)';
    }, 100);

    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let displayDuration = 4000; // 4 Ø«ÙˆØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†

    // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø³Ø±Ø¹Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    if (currentUser && users[currentUser] && users[currentUser].role === 'limited') {
        displayDuration = 800; // Ø£Ù‚Ù„ Ù…Ù† Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
        console.log('ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© - Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¨Ø³Ø±Ø¹Ø©');
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    setTimeout(() => {
        message.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (message.parentNode) {
                message.remove();
            }
        }, 300);
    }, displayDuration);
}

// Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
function clearAllNotificationsForLimitedUser() {
    console.log('ğŸ§¹ Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯...');

    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ±Ø­ÙŠØ¨
    const welcomeMessages = document.querySelectorAll('div[style*="position: fixed"][style*="top: 20px"][style*="right: 20px"]');
    welcomeMessages.forEach(message => {
        if (message.textContent.includes('Ù…Ø±Ø­Ø¨Ø§Ù‹')) {
            message.remove();
        }
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
    const connectionNotifications = document.querySelectorAll('.connection-notification');
    connectionNotifications.forEach(notification => notification.remove());

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰
    const allNotifications = document.querySelectorAll('[class*="notification"], [class*="alert"], [class*="toast"], .message-toast');
    allNotifications.forEach(notification => {
        if (notification.style.position === 'fixed' || notification.style.position === 'absolute') {
            notification.remove();
        }
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø°Ø§Øª position: fixed ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ
    const fixedElements = document.querySelectorAll('div[style*="position: fixed"][style*="top:"]');
    fixedElements.forEach(element => {
        // ØªØ¬Ø§Ù‡Ù„ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù‡Ù…Ø©
        if (!element.id.includes('loading') &&
            !element.classList.contains('crystal-loading-overlay') &&
            !element.classList.contains('sidebar') &&
            !element.classList.contains('navbar')) {
            element.remove();
        }
    });

    console.log('âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯');
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
function logout() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯
        if (window.limitedUserNotificationWatcher) {
            clearInterval(window.limitedUserNotificationWatcher);
            window.limitedUserNotificationWatcher = null;
        }

        // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ
        hideMobileUserSection();

        // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
        localStorage.removeItem('currentUser');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        currentUser = null;
        userPermissions = null;

        // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.body.classList.remove('user-omar', 'admin-user', 'limited-user');

        // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
        toggleAttachmentManagementVisibility();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        location.reload();
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
function addLogoutButton() {
    if (!currentUser) {
        console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - ØªØ®Ø·ÙŠ Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬');
        return;
    }

    console.log('ğŸ”‘ Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', currentUser);

    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    const header = document.querySelector('.header-section.header-actions');
    if (header && !document.getElementById('logoutBtn')) {
        const logoutBtn = document.createElement('button');
        logoutBtn.id = 'logoutBtn';
        logoutBtn.className = 'header-btn logout-btn';
        logoutBtn.innerHTML = `
            <i class="fas fa-sign-out-alt"></i>
            Ø®Ø±ÙˆØ¬ (${users[currentUser].fullName})
        `;
        logoutBtn.onclick = logout;
        logoutBtn.style.cssText = `
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 1rem;
        `;

        header.appendChild(logoutBtn);
        console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
    } else if (!header) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ header Ù„Ù„Ø£Ø²Ø±Ø§Ø±');
    } else {
        console.log('â„¹ï¸ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
    updateMobileUserSection();
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ
function updateMobileUserSection() {
    const mobileUserSection = document.getElementById('mobileUserSection');
    const mobileUserName = document.getElementById('mobileUserName');
    const mobileUserRole = document.getElementById('mobileUserRole');

    if (!mobileUserSection || !mobileUserName || !mobileUserRole) return;

    if (currentUser && users[currentUser]) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        mobileUserSection.style.display = 'block';
        mobileUserSection.classList.remove('hidden');

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        mobileUserName.textContent = users[currentUser].fullName;

        // ØªØ­Ø¯ÙŠØ¯ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        let roleText = '';
        let roleColor = '';

        switch (users[currentUser].role) {
            case 'admin':
                roleText = 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…';
                roleColor = '#28a745';
                break;
            case 'assistant_admin':
                roleText = 'Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯';
                roleColor = '#17a2b8';
                break;
            case 'limited':
                roleText = 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯ÙˆØ¯';
                roleColor = '#ffc107';
                break;
            default:
                roleText = 'Ù…Ø³ØªØ®Ø¯Ù…';
                roleColor = '#6c757d';
        }

        mobileUserRole.textContent = roleText;
        mobileUserRole.style.color = roleColor;

        console.log('ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ');
    } else {
        // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        mobileUserSection.style.display = 'none';
        mobileUserSection.classList.add('hidden');
    }
}

// Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
function hideMobileUserSection() {
    const mobileUserSection = document.getElementById('mobileUserSection');
    if (mobileUserSection) {
        mobileUserSection.style.display = 'none';
        mobileUserSection.classList.add('hidden');
    }
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ø­Ø°Ù Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
const originalEditCard = window.editCard;
window.editCard = function(index) {
    if (!checkPermission('editData')) return;
    if (originalEditCard) originalEditCard(index);
};

const originalDeleteCard = window.deleteCard;
window.deleteCard = function(index) {
    if (!checkPermission('deleteData')) return;
    if (originalDeleteCard) originalDeleteCard(index);
};

const originalShowPropertyManager = window.showPropertyManager;
window.showPropertyManager = function() {
    if (!checkPermission('manageProperties')) return;
    if (originalShowPropertyManager) originalShowPropertyManager();
};

// Ø­Ù…Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
const originalDeletePropertyAttachment = window.deletePropertyAttachment;
window.deletePropertyAttachment = function(propertyKey, fileIndex) {
    if (!checkAttachmentPermission('delete')) return;
    if (originalDeletePropertyAttachment) originalDeletePropertyAttachment(propertyKey, fileIndex);
};

const originalDeletePropertyAttachmentFromSupabase = window.deletePropertyAttachmentFromSupabase;
window.deletePropertyAttachmentFromSupabase = function(attachmentId, propertyKey) {
    if (!checkAttachmentPermission('delete')) return;
    if (originalDeletePropertyAttachmentFromSupabase) originalDeletePropertyAttachmentFromSupabase(attachmentId, propertyKey);
};

const originalDeleteCardAttachment = window.deleteCardAttachment;
window.deleteCardAttachment = function(cardKey, fileName) {
    if (!checkAttachmentPermission('delete')) return;
    if (originalDeleteCardAttachment) originalDeleteCardAttachment(cardKey, fileName);
};

const originalDeleteCardAttachmentFromSupabase = window.deleteCardAttachmentFromSupabase;
window.deleteCardAttachmentFromSupabase = function(attachmentId, cardKey) {
    if (!checkAttachmentPermission('delete')) return;
    if (originalDeleteCardAttachmentFromSupabase) originalDeleteCardAttachmentFromSupabase(attachmentId, cardKey);
};

const originalDeleteAttachment = window.deleteAttachment;
window.deleteAttachment = function(propertyKey, fileName, city, propertyName) {
    if (!checkAttachmentPermission('delete')) return;
    if (originalDeleteAttachment) originalDeleteAttachment(propertyKey, fileName, city, propertyName);
};

const originalDeleteAttachmentFromSupabase = window.deleteAttachmentFromSupabase;
window.deleteAttachmentFromSupabase = function(attachmentId, propertyKey) {
    if (!checkAttachmentPermission('delete')) return;
    if (originalDeleteAttachmentFromSupabase) originalDeleteAttachmentFromSupabase(attachmentId, propertyKey);
};

// Ø­Ù…Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
const originalHandleFileUploadEnhanced = window.handleFileUploadEnhanced;
window.handleFileUploadEnhanced = function(event, city, propertyName) {
    if (!checkAttachmentPermission('upload')) return;
    if (originalHandleFileUploadEnhanced) originalHandleFileUploadEnhanced(event, city, propertyName);
};

const originalHandleCardFileUpload = window.handleCardFileUpload;
window.handleCardFileUpload = function(event, cardKey) {
    if (!checkAttachmentPermission('upload')) return;
    if (originalHandleCardFileUpload) originalHandleCardFileUpload(event, cardKey);
};

// Ø­Ù…Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
const originalSyncLocalAttachment = window.syncLocalAttachment;
window.syncLocalAttachment = function(propertyKey, fileName) {
    if (!checkPermission('manageAttachments')) return;
    if (originalSyncLocalAttachment) originalSyncLocalAttachment(propertyKey, fileName);
};

// Ø­Ù…Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© - Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… ØµÙ„Ø§Ø­ÙŠØ© manageAttachments
const originalShowAttachmentsManager = window.showAttachmentsManager;
window.showAttachmentsManager = function() {
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    if (!canViewAttachmentManager()) {
        showNoPermissionMessage('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        return;
    }
    if (originalShowAttachmentsManager) originalShowAttachmentsManager();
};

const originalShowAttachmentsManagerFromDropdown = window.showAttachmentsManagerFromDropdown;
window.showAttachmentsManagerFromDropdown = function() {
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    if (!canViewAttachmentManager()) {
        showNoPermissionMessage('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
        return;
    }
    if (originalShowAttachmentsManagerFromDropdown) originalShowAttachmentsManagerFromDropdown();
};

// Ø­Ù…Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª)
const originalShowUpdateTotalsModal = window.showUpdateTotalsModal;
window.showUpdateTotalsModal = function() {
    if (!checkPermission('manageAttachments')) return;
    if (originalShowUpdateTotalsModal) originalShowUpdateTotalsModal();
};

const originalShowDataImportModal = window.showDataImportModal;
window.showDataImportModal = function() {
    if (!checkPermission('importData')) return;
    if (originalShowDataImportModal) originalShowDataImportModal();
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
function checkAuthentication() {
    console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ ÙÙŠ localStorage
    const savedUser = localStorage.getItem('currentUser');

    if (savedUser && users[savedUser]) {
        console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸:', savedUser);
        setCurrentUser(savedUser);
        return true;
    } else {
        console.log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
        // ØªØ¹ÙŠÙŠÙ† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„
        currentUser = 'guest';
        userPermissions = {
            viewData: true,
            editData: true,
            deleteData: true,
            manageProperties: true,
            manageAttachments: true,
            exportData: true,
            importData: true,
            manageSettings: true
        };
        return false;
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    setTimeout(() => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹
        checkAuthentication();

        initializePermissionSystem();

        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
        if (currentUser && currentUser !== 'guest') {
            addLogoutButton();
            // ØªØ­Ø¯ÙŠØ« Ø±Ø¤ÙŠØ© Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±)
            setTimeout(() => {
                toggleAttachmentManagementVisibility();
                showAttachmentManagementButtons();
            }, 1000);
            updateMobileUserSection();
        }

        // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
        loadLocalChangeTrackingLogs();

        // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        addTrackingFieldsToExistingData();

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„ØªØªØ¨Ø¹ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
        createSampleTrackingData();
    }, 1000);
});

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± ====================

// ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø±
function toggleHeaderButtons() {
    areHeaderButtonsVisible = !areHeaderButtonsVisible;

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ localStorage
    localStorage.setItem('headerButtonsVisible', areHeaderButtonsVisible);

    updateHeaderButtonsDisplay();
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
function updateHeaderButtonsDisplay() {
    const hideableButtons = document.querySelectorAll('.hideable-header-btn');
    const toggleIcon = document.getElementById('toggleHeaderIcon');
    const toggleText = document.getElementById('toggleHeaderText');

    hideableButtons.forEach(button => {
        if (areHeaderButtonsVisible) {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            button.style.opacity = '1';
            button.style.transform = 'scale(1)';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
        } else {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            button.style.opacity = '0';
            button.style.transform = 'scale(0.8)';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
        }
    });

    // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆÙ†Øµ Ø§Ù„Ø²Ø±
    if (toggleIcon && toggleText) {
        if (areHeaderButtonsVisible) {
            toggleIcon.className = 'fas fa-eye';
            toggleText.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±';
            document.getElementById('toggleHeaderBtn').title = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±';
        } else {
            toggleIcon.className = 'fas fa-eye-slash';
            toggleText.textContent = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±';
            document.getElementById('toggleHeaderBtn').title = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±';
        }
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
function initializeHeaderButtons() {
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† localStorage
    const savedState = localStorage.getItem('headerButtonsVisible');
    if (savedState !== null) {
        areHeaderButtonsVisible = savedState === 'true';
    }

    const hideableButtons = document.querySelectorAll('.hideable-header-btn');

    hideableButtons.forEach(button => {
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
        button.style.transition = 'all 0.3s ease';
    });

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    updateHeaderButtonsDisplay();
}

// ==================== ÙˆØ¸ÙŠÙØ© Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© ====================

// Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
async function emptyUnit(contractNumber, propertyName, unitNumber) {
    // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙØ±Ø§Øº Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:\n- Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±\n- Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯\n- ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯\n- Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·\n\nØ³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ÙÙ‚Ø·.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©
    let propertyIndex = -1;

    if (contractNumber && propertyName) {
        propertyIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );
    } else if (unitNumber && propertyName) {
        propertyIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );
    }

    if (propertyIndex === -1) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }

    const property = properties[propertyIndex];

    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ÙÙ‚Ø·
    const basicInfo = {
        'Column1': property['Column1'],
        'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
        'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'],
        'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
        'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': property['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'],
        'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡': property['Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡'],
        'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹': property['Ø§Ù„Ø§Ø±ØªÙØ§Ø¹'],
        'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±': property['Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±'],
        'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': property['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'],
        'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': property['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ '],
        'Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ': property['Ù…Ø³Ø§Ø­Ø©Ø§Ù„ØµÙƒ'],
        'Ø§Ù„Ù…Ø§Ù„Ùƒ': property['Ø§Ù„Ù…Ø§Ù„Ùƒ']
    };

    // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
    const fieldsToEmpty = [
        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        'ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ø·',
        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ',
        'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰',
        'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©',
        'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©',
        'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'
    ];

    // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ù…Ù† 1 Ø¥Ù„Ù‰ 10)
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                       i === 2 ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                       `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„' :
                         i === 2 ? 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                         `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· ${getArabicNumber(i)}`;

        fieldsToEmpty.push(dateKey, amountKey);
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ÙØ±Ø§Øº
    fieldsToEmpty.forEach(field => {
        basicInfo[field] = null;
    });

    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø©
    try {
        await addChangeLog(
            OPERATION_TYPES.EMPTY_UNIT,
            basicInfo,
            {},
            {
                previousTenant: originalTenant,
                reason: 'Ø¥ÙØ±Ø§Øº ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'
            }
        );
        console.log('ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø©');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØªØ¨Ø¹ Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø©:', error);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±
    properties[propertyIndex] = basicInfo;

    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª
    initializeApp();

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    closeModal();
    alert('ØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø·.');

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    renderData();
}

// ==================== Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø© ====================

// Ù…Ø¹Ø§Ù„Ø¬ Ø£Ø®Ø·Ø§Ø¡ Ø¹Ø§Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙØ§Ø¬Ø¦ Ù„Ù„Ù†ÙˆØ§ÙØ°
window.addEventListener('error', function(event) {
    console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', event.error);
    // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    event.preventDefault();
    return false;
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Promise ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬:', event.reason);
    // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¨Ø³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡ Promise
    event.preventDefault();
});

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    try {
        initializeApp();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        setTimeout(() => {
            console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...');
            resetFiltersToDefault();
        }, 1500);

        // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙØ­
        setTimeout(() => {
            console.log('ğŸ’¾ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙØ­...');
            initializeStatePersistence();
        }, 2000);

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ
        setTimeout(() => {
            if (typeof initializeChatBot === 'function') {
                console.log('ğŸ¤– ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ...');
                initializeChatBot();
            }
        }, 3000);

    } catch (initError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', initError);
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
        setTimeout(() => {
            try {
                initializeApp();
            } catch (retryError) {
                console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', retryError);
            }
        }, 1000);
    }
});

// Ù…Ø±Ø§Ù‚Ø¨ DOM Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function setupAttachmentsPermissionObserver() {
    if (!currentUser || users[currentUser]?.role !== 'limited') return;

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø§Ù‚Ø¨ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ DOM
    const observer = new MutationObserver(function(mutations) {
        let shouldApplyRestrictions = false;

        mutations.forEach(function(mutation) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯Ø©
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø§ØµØ± Ù…Ø±ÙÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
                        if (node.classList && (
                            node.classList.contains('attachments-modal') ||
                            node.classList.contains('card-attachments-modal') ||
                            node.classList.contains('mobile-attachments-modal') ||
                            node.querySelector && (
                                node.querySelector('.upload-area') ||
                                node.querySelector('.delete-btn') ||
                                node.querySelector('.btn-delete')
                            )
                        )) {
                            shouldApplyRestrictions = true;
                        }
                    }
                });
            }
        });

        if (shouldApplyRestrictions) {
            setTimeout(() => {
                applyAttachmentsRestrictions();
                addLimitedUserNoticeToAttachments();
            }, 100);
        }
    });

    // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    console.log('ğŸ‘ï¸ ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© setCurrentUser Ù„ØªØ´Ù…Ù„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
// (ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ Ù…Ø¹ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙÙ‡Ø§)

// ==================== ÙˆØ¸Ø§Ø¦Ù Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± ====================

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø©
function checkForDuplicateUnits(unitNumber, propertyName) {
    if (!unitNumber || !propertyName) {
        return { hasDuplicates: false, count: 0, indices: [] };
    }

    const duplicateIndices = [];
    properties.forEach((p, index) => {
        if (p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName) {
            duplicateIndices.push(index);
        }
    });

    const hasDuplicates = duplicateIndices.length > 1;

    if (hasDuplicates) {
        console.warn(`âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${duplicateIndices.length} Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© "${unitNumber}" ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± "${propertyName}"`);
        console.log('ğŸ“ ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙƒØ±Ø±Ø©:', duplicateIndices);
    }

    return {
        hasDuplicates: hasDuplicates,
        count: duplicateIndices.length,
        indices: duplicateIndices
    };
}

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø¨Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«
function fixDuplicateUnits(unitNumber, propertyName) {
    const duplicateCheck = checkForDuplicateUnits(unitNumber, propertyName);

    if (!duplicateCheck.hasDuplicates) {
        return { fixed: false, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø©' };
    }

    console.log(`ğŸ”§ Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ ${duplicateCheck.count} Ù†Ø³Ø®Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© "${unitNumber}"`);

    // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«)
    let latestIndex = duplicateCheck.indices[0];
    let latestDate = new Date(0); // ØªØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ… Ø¬Ø¯Ø§Ù‹

    duplicateCheck.indices.forEach(index => {
        const unit = properties[index];
        const updateDate = unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] ? new Date(unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«']) : new Date(0);

        if (updateDate > latestDate) {
            latestDate = updateDate;
            latestIndex = index;
        }
    });

    console.log(`ğŸ“… Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³: ${latestIndex} (ØªØ§Ø±ÙŠØ®: ${properties[latestIndex]['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'})`);

    // Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙƒØ±Ø±Ø© (Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ø³ÙÙ„ Ù„ØªØ¬Ù†Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ‡Ø§Ø±Ø³)
    let deletedCount = 0;
    for (let i = duplicateCheck.indices.length - 1; i >= 0; i--) {
        const index = duplicateCheck.indices[i];
        if (index !== latestIndex) {
            console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ø§Ù„ÙÙ‡Ø±Ø³: ${index}`);
            properties.splice(index, 1);
            deletedCount++;
        }
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    localStorage.setItem('properties', JSON.stringify(properties));

    console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±: Ø­ÙØ°ÙØª ${deletedCount} Ù†Ø³Ø®Ø©ØŒ ØªØ¨Ù‚Øª Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø©`);

    return {
        fixed: true,
        deletedCount: deletedCount,
        keptIndex: latestIndex,
        message: `ØªÙ… Ø­Ø°Ù ${deletedCount} Ù†Ø³Ø®Ø© Ù…ÙƒØ±Ø±Ø© ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«`
    };
}

// ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function performGlobalDuplicateCheck() {
    console.log('ğŸ” Ø¨Ø¯Ø¡ ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    const unitMap = new Map();
    const duplicates = [];

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ±ÙŠØ¯
    properties.forEach((unit, index) => {
        const unitKey = `${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;

        if (!unitMap.has(unitKey)) {
            unitMap.set(unitKey, []);
        }

        unitMap.get(unitKey).push({ unit, index });
    });

    // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª
    unitMap.forEach((units, unitKey) => {
        if (units.length > 1) {
            duplicates.push({
                key: unitKey,
                count: units.length,
                units: units
            });
        }
    });

    if (duplicates.length > 0) {
        console.warn(`âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${duplicates.length} Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©:`);
        duplicates.forEach(dup => {
            console.log(`   - ${dup.key}: ${dup.count} Ù†Ø³Ø®Ø©`);
        });
    } else {
        console.log('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø©');
    }

    return {
        hasDuplicates: duplicates.length > 0,
        duplicateGroups: duplicates,
        totalDuplicates: duplicates.reduce((sum, dup) => sum + dup.count - 1, 0)
    };
}

// Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
function fixAllDuplicates() {
    const globalCheck = performGlobalDuplicateCheck();

    if (!globalCheck.hasDuplicates) {
        return { fixed: false, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ø¥ØµÙ„Ø§Ø­' };
    }

    console.log(`ğŸ”§ Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ ${globalCheck.duplicateGroups.length} Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©...`);

    let totalFixed = 0;
    globalCheck.duplicateGroups.forEach(group => {
        const [propertyName, unitNumber] = group.key.split('_');
        const result = fixDuplicateUnits(unitNumber, propertyName);
        if (result.fixed) {
            totalFixed += result.deletedCount;
        }
    });

    console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª: Ø­ÙØ°ÙØª ${totalFixed} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©`);

    return {
        fixed: true,
        totalFixed: totalFixed,
        message: `ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ÙˆØ­Ø°Ù ${totalFixed} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©`
    };
}

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…Ø¹ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯
function fixAllDuplicatesWithConfirmation() {
    console.log('ğŸ” ÙØ­Øµ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©...');

    const globalCheck = performGlobalDuplicateCheck();

    if (!globalCheck.hasDuplicates) {
        alert('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø©!\n\nØ¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙØ±ÙŠØ¯Ø© ÙˆÙ„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥ØµÙ„Ø§Ø­.');
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay';
    confirmModal.style.display = 'flex';
    confirmModal.innerHTML = `
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3 style="color: #dc3545; margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i> ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø©
                </h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404;">
                        <i class="fas fa-info-circle"></i>
                        <strong>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${globalCheck.duplicateGroups.length} Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©</strong>
                    </p>
                    <p style="margin: 10px 0 0 0; color: #856404;">
                        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©: ${globalCheck.totalDuplicates}
                    </p>
                </div>

                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©:</h4>
                    ${globalCheck.duplicateGroups.map(group => {
                        const [propertyName, unitNumber] = group.key.split('_');
                        return `<p style="margin: 5px 0;">â€¢ Ø§Ù„ÙˆØ­Ø¯Ø© "${unitNumber}" ÙÙŠ "${propertyName}" (${group.count} Ù†Ø³Ø®Ø©)</p>`;
                    }).join('')}
                </div>

                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #0c5460;">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Ù…Ø§ Ø³ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­:</strong>
                    </p>
                    <ul style="margin: 10px 0 0 20px; color: #0c5460;">
                        <li>Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† ÙƒÙ„ ÙˆØ­Ø¯Ø©</li>
                        <li>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø§Ù„Ø£Ù‚Ø¯Ù…</li>
                        <li>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                        <li>Ù„Ù† ØªÙÙ‚Ø¯ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‡Ù…Ø©</li>
                    </ul>
                </div>

                <p style="color: #dc3545; font-weight: 600; text-align: center;">
                    Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©ØŸ
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeDuplicateFixModal()">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
                <button class="modal-action-btn print-btn" onclick="confirmFixAllDuplicates()"
                        style="background: #28a745; border-color: #28a745;">
                    <i class="fas fa-broom"></i> Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(confirmModal);
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±
function closeDuplicateFixModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// ØªØ£ÙƒÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±
function confirmFixAllDuplicates() {
    closeDuplicateFixModal();

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.style.display = 'flex';
    loadingModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #28a745; margin-bottom: 20px;"></i>
            <h3>Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±...</h3>
            <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        const result = fixAllDuplicates();

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingModal.remove();

        if (result.fixed) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            renderData();
            updateTotalStats();

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            showSuccessMessage(
                'ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰',
                `ØªÙ… Ø­Ø°Ù ${result.totalFixed} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† ÙƒÙ„ ÙˆØ­Ø¯Ø©.\n\nØ§Ù„Ø¢Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙØ±ÙŠØ¯Ø© ÙˆÙ„Ù† ØªØ¸Ù‡Ø± Ù…ÙƒØ±Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.`
            );
        } else {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ø¥ØµÙ„Ø§Ø­.');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±:', error);
        loadingModal.remove();
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

// ==================== Ù†Ø§ÙØ°Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±" ====================

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø±Ø³Ø§Ù„Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±"
function showDevelopmentModal() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© Ø¨Ø§Ù„ÙØ¹Ù„
    const existingModal = document.getElementById('developmentModal');
    if (existingModal) {
        return; // Ù„Ø§ ØªÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    const modalHtml = `
        <div id="developmentModal" class="modal-overlay" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        ">
            <div class="development-modal-box" style="
                background: linear-gradient(135deg, #ff9800, #f57c00);
                color: white;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                max-width: 500px;
                width: 90%;
                position: relative;
                animation: slideIn 0.4s ease;
                border: 3px solid #fff3e0;
            ">
                <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ -->
                <button onclick="closeDevelopmentModal()" style="
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    background: rgba(255, 255, 255, 0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    Ã—
                </button>

                <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
                <div style="margin-bottom: 30px;">
                    <div style="
                        font-size: 80px;
                        margin-bottom: 20px;
                        animation: bounce 2s infinite;
                    ">ğŸš§</div>

                    <h2 style="
                        margin: 0 0 15px 0;
                        font-size: 28px;
                        font-weight: bold;
                        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                    ">Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</h2>

                    <p style="
                        margin: 0 0 20px 0;
                        font-size: 18px;
                        opacity: 0.9;
                        line-height: 1.6;
                    ">Ù†Ø¹ØªØ°Ø±ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹<br>ÙˆØ³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
                </div>

                <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
                <div style="
                    background: rgba(255, 255, 255, 0.3);
                    height: 6px;
                    border-radius: 3px;
                    overflow: hidden;
                    margin-bottom: 15px;
                ">
                    <div id="developmentProgressBar" style="
                        background: white;
                        height: 100%;
                        width: 0%;
                        border-radius: 3px;
                        transition: width 0.1s linear;
                    "></div>
                </div>

                <!-- Ù†Øµ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ -->
                <p style="
                    margin: 0;
                    font-size: 14px;
                    opacity: 0.8;
                ">Ø³ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø®Ù„Ø§Ù„ <span id="developmentCountdown">5</span> Ø«ÙˆØ§Ù†</p>
            </div>
        </div>

        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            @keyframes slideIn {
                from {
                    transform: translateY(-50px) scale(0.9);
                    opacity: 0;
                }
                to {
                    transform: translateY(0) scale(1);
                    opacity: 1;
                }
            }

            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% {
                    transform: translateY(0);
                }
                40% {
                    transform: translateY(-10px);
                }
                60% {
                    transform: translateY(-5px);
                }
            }

            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }

            @keyframes slideOut {
                from {
                    transform: translateY(0) scale(1);
                    opacity: 1;
                }
                to {
                    transform: translateY(-50px) scale(0.9);
                    opacity: 0;
                }
            }
        </style>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„ØµÙØ­Ø©
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
    startDevelopmentCountdown();

    // Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        closeDevelopmentModal();
    }, 5000);

    console.log('ğŸš§ ØªÙ… Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±" Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†');
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆØ´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
function startDevelopmentCountdown() {
    let timeLeft = 5;
    const countdownElement = document.getElementById('developmentCountdown');
    const progressBar = document.getElementById('developmentProgressBar');

    const interval = setInterval(() => {
        timeLeft--;

        if (countdownElement) {
            countdownElement.textContent = timeLeft;
        }

        if (progressBar) {
            const progress = ((5 - timeLeft) / 5) * 100;
            progressBar.style.width = progress + '%';
        }

        if (timeLeft <= 0) {
            clearInterval(interval);
        }
    }, 1000);
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±"
function closeDevelopmentModal() {
    const modal = document.getElementById('developmentModal');
    if (modal) {
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        modal.style.animation = 'fadeOut 0.3s ease';
        const modalBox = modal.querySelector('.development-modal-box');
        if (modalBox) {
            modalBox.style.animation = 'slideOut 0.3s ease';
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ø«ÙŠØ±
        setTimeout(() => {
            modal.remove();
        }, 300);

        console.log('ğŸš§ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±"');
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
window.showDevelopmentModal = showDevelopmentModal;
window.closeDevelopmentModal = closeDevelopmentModal;

// ==================== Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ ====================

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ
function ensureTrackingButtonVisibilityForSenidi() {
    console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ...');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
    const mobileTrackingBtn = document.getElementById('mobile-change-tracking-btn');

    if (mobileTrackingBtn) {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø²Ø± Ù…Ø±Ø¦ÙŠ
        mobileTrackingBtn.style.display = 'block';
        mobileTrackingBtn.style.visibility = 'visible';
        mobileTrackingBtn.style.opacity = '1';

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£Ø¨ (li) Ù…Ø±Ø¦ÙŠ Ø£ÙŠØ¶Ø§Ù‹
        const parentLi = mobileTrackingBtn.closest('li');
        if (parentLi) {
            parentLi.style.display = 'block';
            parentLi.style.visibility = 'visible';
            parentLi.style.opacity = '1';
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø³Ø§Ø¨Ù‚Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø¬Ø¯ÙŠØ¯
        const newButton = mobileTrackingBtn.cloneNode(true);
        mobileTrackingBtn.parentNode.replaceChild(newButton, mobileTrackingBtn);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
            const mobileMenu = document.getElementById('mobileMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            if (mobileMenu) mobileMenu.classList.remove('active');
            if (menuOverlay) menuOverlay.classList.remove('active');
            document.body.style.overflow = '';

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±"
            console.log('ğŸš§ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
            showDevelopmentModal();

            return false;
        });

        // Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚ Ù…Ø±Ø¦ÙŠ Ù„Ù„Ø²Ø±
        newButton.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
        newButton.style.color = 'white';
        newButton.style.border = '2px solid #fff3e0';
        newButton.style.borderRadius = '8px';
        newButton.style.padding = '12px 16px';
        newButton.style.margin = '4px 0';
        newButton.style.width = '100%';
        newButton.style.textAlign = 'right';
        newButton.style.fontSize = '16px';
        newButton.style.fontWeight = '500';
        newButton.style.transition = 'all 0.3s ease';

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± hover
        newButton.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #f57c00, #ef6c00)';
            this.style.transform = 'translateX(-5px)';
        });

        newButton.addEventListener('mouseleave', function() {
            this.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
            this.style.transform = 'translateX(0)';
        });

        console.log('âœ… ØªÙ… Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± ÙˆØ¹Ù…Ù„ Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');

    } else {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        createMobileTrackingButtonForSenidi();
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø£ÙŠØ¶Ø§Ù‹
    ensureDesktopTrackingButtonsForSenidi();
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
function createMobileTrackingButtonForSenidi() {
    console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©...');

    const mobileMenuContent = document.querySelector('.mobile-menu-content ol');
    if (mobileMenuContent) {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± li Ø¬Ø¯ÙŠØ¯
        const newLi = document.createElement('li');

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø²Ø±
        const newButton = document.createElement('button');
        newButton.id = 'mobile-change-tracking-btn';
        newButton.innerHTML = '<i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹';

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø¯Ø«
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
            const mobileMenu = document.getElementById('mobileMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            if (mobileMenu) mobileMenu.classList.remove('active');
            if (menuOverlay) menuOverlay.classList.remove('active');
            document.body.style.overflow = '';

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
            showDevelopmentModal();

            return false;
        });

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
        newButton.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
        newButton.style.color = 'white';
        newButton.style.border = '2px solid #fff3e0';
        newButton.style.borderRadius = '8px';
        newButton.style.padding = '12px 16px';
        newButton.style.margin = '4px 0';
        newButton.style.width = '100%';
        newButton.style.textAlign = 'right';
        newButton.style.fontSize = '16px';
        newButton.style.fontWeight = '500';

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ li
        newLi.appendChild(newButton);

        // Ø¥Ø¶Ø§ÙØ© li Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
        mobileMenuContent.insertBefore(newLi, mobileMenuContent.firstChild);

        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
    }
}

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ø£Ø²Ø±Ø§Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø£ÙŠØ¶Ø§Ù‹
function ensureDesktopTrackingButtonsForSenidi() {
    console.log('ğŸ–¥ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø²Ø±Ø§Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©...');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
    const trackingButtons = document.querySelectorAll('[onclick*="createSampleTrackingDataAndShow"], [onclick*="showChangeTrackingModal"]');

    trackingButtons.forEach((button, index) => {
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ (ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„)
        if (button.id === 'mobile-change-tracking-btn') {
            return;
        }

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø¬Ø¯ÙŠØ¯
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            console.log('ğŸš§ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±" Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©');
            showDevelopmentModal();

            return false;
        });

        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ #${index + 1} ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©`);
    });
}

// ==================== Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ====================

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ
function testTrackingAccessRestriction() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    const currentUserName = getCurrentUser();
    const currentUserKey = window.currentUser;

    console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:', {
        userKey: currentUserKey,
        userName: currentUserName,
        fullUserData: users[currentUserKey]
    });

    // ÙØ­Øµ Ø´Ø±ÙˆØ· Ø§Ù„Ù…Ù†Ø¹
    const isBlocked = currentUserKey === '1234' ||
                     currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ' ||
                     currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ1234' ||
                     (currentUserName && currentUserName.includes('Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ'));

    console.log('ğŸ” Ù†ØªÙŠØ¬Ø© ÙØ­Øµ Ø§Ù„Ù…Ù†Ø¹:', {
        isBlocked: isBlocked,
        reason: isBlocked ? 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù…Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„' : 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø¨Ø§Ù„ÙˆØµÙˆÙ„'
    });

    if (isBlocked) {
        showToast('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø§Ø¬Ø­: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù…Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹', 'success');
        console.log('âœ… Ø§Ù„ÙØ­Øµ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù…Ù†ÙˆØ¹');

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        setTimeout(() => {
            showDevelopmentModal();
        }, 1000);
    } else {
        showToast('â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹', 'info');
        console.log('â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø¨Ø§Ù„ÙˆØµÙˆÙ„');
    }

    return isBlocked;
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
function testAllTrackingAccessPoints() {
    console.log('ğŸ”¬ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹...');

    const currentUserName = getCurrentUser();
    const currentUserKey = window.currentUser;

    console.log('ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', {
        userKey: currentUserKey,
        userName: currentUserName
    });

    // Ø§Ø®ØªØ¨Ø§Ø± 1: Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
    console.log('1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± showChangeTrackingModal...');
    try {
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ (Ø¨Ø¯ÙˆÙ† ØªÙ†ÙÙŠØ° ÙØ¹Ù„ÙŠ)
        const isBlocked1 = currentUserKey === '1234' ||
                          currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ' ||
                          currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ1234' ||
                          (currentUserName && currentUserName.includes('Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ'));
        console.log('   Ø§Ù„Ù†ØªÙŠØ¬Ø©:', isBlocked1 ? 'Ù…Ù…Ù†ÙˆØ¹ âœ…' : 'Ù…Ø³Ù…ÙˆØ­ âŒ');
    } catch (e) {
        console.log('   Ø®Ø·Ø£:', e.message);
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 2: Ø¯Ø§Ù„Ø© Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
    console.log('2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± showTrackingManagementModal...');
    try {
        const isBlocked2 = currentUserKey === '1234' ||
                          currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ' ||
                          currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ1234' ||
                          (currentUserName && currentUserName.includes('Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ'));
        console.log('   Ø§Ù„Ù†ØªÙŠØ¬Ø©:', isBlocked2 ? 'Ù…Ù…Ù†ÙˆØ¹ âœ…' : 'Ù…Ø³Ù…ÙˆØ­ âŒ');
    } catch (e) {
        console.log('   Ø®Ø·Ø£:', e.message);
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 3: Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
    console.log('3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± createSampleTrackingDataAndShow...');
    try {
        const isBlocked3 = currentUserKey === '1234' ||
                          currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ' ||
                          currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ1234' ||
                          (currentUserName && currentUserName.includes('Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ'));
        console.log('   Ø§Ù„Ù†ØªÙŠØ¬Ø©:', isBlocked3 ? 'Ù…Ù…Ù†ÙˆØ¹ âœ…' : 'Ù…Ø³Ù…ÙˆØ­ âŒ');
    } catch (e) {
        console.log('   Ø®Ø·Ø£:', e.message);
    }

    const allBlocked = currentUserKey === '1234' ||
                      currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ' ||
                      currentUserName === 'Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ1234' ||
                      (currentUserName && currentUserName.includes('Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ'));

    if (allBlocked) {
        showToast('âœ… Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø­Ù…ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
        console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù…Ù†ÙˆØ¹ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆØµÙˆÙ„');
    } else {
        showToast('â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø¨Ø§Ù„ÙˆØµÙˆÙ„', 'info');
        console.log('â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
    }

    return allBlocked;
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
window.testTrackingAccessRestriction = testTrackingAccessRestriction;
window.testAllTrackingAccessPoints = testAllTrackingAccessPoints;

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ÙˆØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ ====================

// ØªØ¹ÙŠÙŠÙ† Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
function setNewClient(contractNumber, propertyName, unitNumber) {
    if (!checkPermission('editData')) return;

    const confirmMessage = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹ÙŠÙŠÙ† Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ\n\nØ³ÙŠØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯.';

    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©
        const propertyIndex = properties.findIndex(p => {
            if (contractNumber && propertyName) {
                return p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName;
            } else if (unitNumber && propertyName) {
                return p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName;
            }
            return false;
        });

        if (propertyIndex === -1) {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const property = properties[propertyIndex];
        const fieldsToKeep = [
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±', 'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ', 'Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©',
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©', 'Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù', 'Ø¹Ø¯Ø¯ Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡', 'Ø§Ù„Ø·Ø§Ø¨Ù‚',
            'Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø©', 'Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©'
        ];

        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
        const newProperty = {};
        fieldsToKeep.forEach(field => {
            if (property[field] !== undefined) {
                newProperty[field] = property[field];
            }
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
        newProperty['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
        newProperty['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
        newProperty['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();
        newProperty['Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©'] = 'ÙØ§Ø±Øº';

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        properties[propertyIndex] = newProperty;

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        saveDataLocally();

        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase Ø¥Ø°Ø§ Ù…ØªØ§Ø­
        if (typeof syncToSupabase === 'function') {
            syncToSupabase().catch(error => {
                console.error('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Supabase:', error);
            });
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        renderData();
        updateTotalStats();

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeModal();

        alert('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!\n\nØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© ÙÙ‚Ø·.');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:', error);
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

// ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯
function renewContract(contractNumber, propertyName, unitNumber) {
    if (!checkPermission('editData')) return;

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©
    const property = properties.find(p => {
        if (contractNumber && propertyName) {
            return p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName;
        } else if (unitNumber && propertyName) {
            return p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName;
        }
        return false;
    });

    if (!property) {
        alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯
    const renewalModalHtml = `
        <div class="modal-overlay" style="display:flex;">
            <div class="modal-box renewal-modal">
                <button class="close-modal" onclick="closeModal()">Ã—</button>
                <div class="modal-header">
                    <h2><i class="fas fa-sync-alt"></i> ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯</h2>
                    <p>ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø©: ${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} - ${propertyName}</p>
                </div>
                <div class="modal-content">
                    <div class="current-contract-info">
                        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>
                        <div class="info-grid">
                            <div><strong>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</strong> ${property['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</strong> ${property['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</strong> ${property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</strong> ${property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] ? parseFloat(property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']).toLocaleString() + ' Ø±ÙŠØ§Ù„' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                    </div>

                    <form id="renewalForm" onsubmit="processContractRenewal(event, '${contractNumber}', '${propertyName}', '${unitNumber}')">
                        <div class="renewal-section">
                            <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯:</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                                    <input type="text" name="newContractNumber" value="${property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                                    <input type="date" name="newStartDate" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                                    <input type="date" name="newEndDate" required>
                                </div>
                                <div class="form-group">
                                    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                                    <input type="number" name="newRentAmount" value="${property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] || ''}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯:</label>
                                <textarea name="renewalNotes" rows="3" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ¬Ø¯ÙŠØ¯..."></textarea>
                            </div>
                        </div>

                        <div class="modal-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯
                            </button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">
                                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', renewalModalHtml);
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯
function processContractRenewal(event, contractNumber, propertyName, unitNumber) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const renewalData = {
        newContractNumber: formData.get('newContractNumber'),
        newStartDate: formData.get('newStartDate'),
        newEndDate: formData.get('newEndDate'),
        newRentAmount: formData.get('newRentAmount'),
        renewalNotes: formData.get('renewalNotes')
    };

    if (!renewalData.newContractNumber || !renewalData.newStartDate || !renewalData.newEndDate) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§
        const propertyIndex = properties.findIndex(p => {
            if (contractNumber && propertyName) {
                return p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === contractNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName;
            } else if (unitNumber && propertyName) {
                return p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName;
            }
            return false;
        });

        if (propertyIndex === -1) {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
        const property = properties[propertyIndex];
        property['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = renewalData.newContractNumber;
        property['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] = renewalData.newStartDate;
        property['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯'] = renewalData.newEndDate;

        if (renewalData.newRentAmount) {
            property['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] = parseFloat(renewalData.newRentAmount);
        }

        if (renewalData.renewalNotes) {
            property['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯'] = renewalData.renewalNotes;
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
        property['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toLocaleDateString('ar-SA');
        property['Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = 'ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯';
        property['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«'] = getCurrentUser();
        property['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¬Ø¯ÙŠØ¯'] = new Date().toLocaleDateString('ar-SA');

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        saveDataLocally();

        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Supabase Ø¥Ø°Ø§ Ù…ØªØ§Ø­
        if (typeof syncToSupabase === 'function') {
            syncToSupabase().catch(error => {
                console.error('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Supabase:', error);
            });
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        renderData();
        updateTotalStats();

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeModal();

        alert('âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!\n\nØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯.');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯: ' + error.message);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
setTimeout(() => {
    testDateFix();
}, 2000);

// ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ù†Ø¹ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
// ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©

// ğŸš€ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function comprehensiveDatabaseCleanup() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

    if (!supabaseClient) {
        alert('âŒ Supabase ØºÙŠØ± Ù…ØªØ§Ø­! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
        return;
    }

    const confirmCleanup = confirm(
        `ğŸ§¹ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n\n` +
        `Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªÙ‚ÙˆÙ… Ø¨Ù€:\n` +
        `âœ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©\n` +
        `âœ… ØªØ­Ø¯ÙŠØ¯ ÙˆØ­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù…Ù† Supabase\n` +
        `âœ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©\n` +
        `âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©\n` +
        `âœ… Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬\n\n` +
        `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`
    );

    if (!confirmCleanup) return;

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© ØªÙ‚Ø¯Ù… Ù…ØªÙ‚Ø¯Ù…Ø©
    const progressModal = createAdvancedProgressModal();
    document.body.appendChild(progressModal);

    const statusEl = document.getElementById('cleanupStatus');
    const progressEl = document.getElementById('cleanupProgress');
    const detailsEl = document.getElementById('cleanupDetails');
    const logEl = document.getElementById('cleanupLog');

    let cleanupResults = {
        originalCount: properties.length,
        duplicatesFound: 0,
        duplicatesDeleted: 0,
        finalCount: 0,
        cities: new Set(),
        properties: new Set(),
        errors: []
    };

    try {
        // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        await executeStep1_CreateBackup(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 2. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase ÙˆØ§Ù„ØªØ­Ù‚Ù‚
        await executeStep2_ConnectSupabase(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        await executeStep3_IdentifyDuplicates(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 4. Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        await executeStep4_DeleteDuplicates(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 5. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©
        await executeStep5_FetchCleanData(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 6. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        await executeStep6_UpdateLocalData(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 7. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        await executeStep7_UpdateDisplay(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 8. Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        await executeStep8_ShowFinalReport(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // Ø¥Ø²Ø§Ù„Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
        setTimeout(() => {
            document.body.removeChild(progressModal);
        }, 3000);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„:', error);
        cleanupResults.errors.push(error.message);

        statusEl.textContent = 'âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ';
        detailsEl.textContent = error.message;
        logEl.innerHTML += `<div style="color: #dc3545;">âŒ Ø®Ø·Ø£: ${error.message}</div>`;

        setTimeout(() => {
            document.body.removeChild(progressModal);
            alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„:\n${error.message}`);
        }, 2000);
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© ØªÙ‚Ø¯Ù… Ù…ØªÙ‚Ø¯Ù…Ø©
function createAdvancedProgressModal() {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.9); z-index: 10000; display: flex;
                    align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 15px;
                       box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
                       min-width: 600px; max-width: 80%; max-height: 80%; overflow-y: auto;">
                <h2 style="margin: 0 0 20px 0; color: #007bff;">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>

                <div id="cleanupStatus" style="font-size: 18px; margin-bottom: 15px; color: #333; font-weight: bold;">
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...
                </div>

                <div style="width: 100%; height: 10px; background: #f0f0f0; border-radius: 5px; overflow: hidden; margin-bottom: 15px;">
                    <div id="cleanupProgress" style="width: 0%; height: 100%;
                                                   background: linear-gradient(90deg, #007bff, #28a745);
                                                   transition: width 0.5s ease;"></div>
                </div>

                <div id="cleanupDetails" style="font-size: 14px; color: #666; margin-bottom: 20px;">
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„ØªÙ†Ø¸ÙŠÙ...
                </div>

                <div style="text-align: left; max-height: 200px; overflow-y: auto;
                           background: #f8f9fa; padding: 15px; border-radius: 8px;
                           font-family: monospace; font-size: 12px;">
                    <div id="cleanupLog" style="color: #333;">
                        ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:<br>
                    </div>
                </div>
            </div>
        </div>
    `;
    return modal;
}

// Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
async function executeStep1_CreateBackup(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...';
    progressEl.style.width = '5%';
    detailsEl.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©';

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const backupKey = `properties_backup_${timestamp}`;

    try {
        localStorage.setItem(backupKey, JSON.stringify(properties));
        localStorage.setItem('latest_backup_key', backupKey);

        logEl.innerHTML += `<div style="color: #28a745;">âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${backupKey}</div>`;
        console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${properties.length} ÙˆØ­Ø¯Ø©`);

        await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
        throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${error.message}`);
    }
}

// Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase ÙˆØ§Ù„ØªØ­Ù‚Ù‚
async function executeStep2_ConnectSupabase(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'ğŸ”— Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...';
    progressEl.style.width = '10%';
    detailsEl.textContent = 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£ÙˆÙ„ÙŠØ©';

    try {
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
        const { data: testData, error: testError } = await supabaseClient
            .from('properties')
            .select('id')
            .limit(1);

        if (testError) {
            throw new Error(`ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase: ${testError.message}`);
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        const { data: countData, error: countError } = await supabaseClient
            .from('properties')
            .select('id', { count: 'exact', head: true });

        if (countError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${countError.message}`);
        }

        const totalCount = countData?.length || 0;

        logEl.innerHTML += `<div style="color: #007bff;">ğŸ”— ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase Ø¨Ù†Ø¬Ø§Ø­</div>`;
        logEl.innerHTML += `<div style="color: #6c757d;">ğŸ“Š Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Supabase: ${totalCount} ÙˆØ­Ø¯Ø©</div>`;

        console.log(`âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase Ù†Ø§Ø¬Ø­ - Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalCount}`);

        await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase: ${error.message}`);
    }
}

// Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
async function executeStep3_IdentifyDuplicates(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'ğŸ” ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©...';
    progressEl.style.width = '25%';
    detailsEl.textContent = 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Supabase';

    try {
        logEl.innerHTML += `<div style="color: #ffc107;">ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©...</div>`;

        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±
        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;

        while (hasMore) {
            const { data: batchData, error } = await supabaseClient
                .from('properties')
                .select('id, "Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±", "Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ", "ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«", created_at')
                .range(from, from + batchSize - 1)
                .order('id', { ascending: true });

            if (error) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù„ÙŠÙ„: ${error.message}`);
            }

            if (batchData && batchData.length > 0) {
                allData.push(...batchData);
                from += batchSize;
                hasMore = batchData.length === batchSize;

                detailsEl.textContent = `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${allData.length} ÙˆØ­Ø¯Ø©...`;
            } else {
                hasMore = false;
            }
        }

        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±
        const unitMap = new Map();
        const duplicates = [];

        allData.forEach(unit => {
            if (!unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || !unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']) {
                return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©
            }

            const unitKey = `${unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}_${unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`;

            if (unitMap.has(unitKey)) {
                const existing = unitMap.get(unitKey);
                const existingDate = new Date(existing['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || existing.created_at || '1900-01-01');
                const currentDate = new Date(unit['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] || unit.created_at || '1900-01-01');

                if (currentDate > existingDate) {
                    // Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£Ø­Ø¯Ø« - Ø§Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                    duplicates.push(existing.id);
                    unitMap.set(unitKey, unit);
                } else {
                    // Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ø­Ø¯Ø« - Ø§Ø­Ø°Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    duplicates.push(unit.id);
                }
            } else {
                unitMap.set(unitKey, unit);
            }
        });

        results.duplicatesFound = duplicates.length;
        results.duplicateIds = duplicates;

        logEl.innerHTML += `<div style="color: #dc3545;">ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${duplicates.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©</div>`;
        logEl.innerHTML += `<div style="color: #28a745;">âœ… Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€ ${unitMap.size} ÙˆØ­Ø¯Ø© ÙØ±ÙŠØ¯Ø©</div>`;

        console.log(`ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±: ${duplicates.length} Ù…ÙƒØ±Ø±Ø© Ù…Ù† Ø£ØµÙ„ ${allData.length}`);

        await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©: ${error.message}`);
    }
}

// Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
async function executeStep4_DeleteDuplicates(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©...';
    progressEl.style.width = '50%';

    if (!results.duplicateIds || results.duplicateIds.length === 0) {
        detailsEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ø­Ø°Ù';
        logEl.innerHTML += `<div style="color: #28a745;">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ø­Ø°Ù</div>`;
        await new Promise(resolve => setTimeout(resolve, 500));
        return;
    }

    try {
        detailsEl.textContent = `Ø­Ø°Ù ${results.duplicateIds.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©...`;
        logEl.innerHTML += `<div style="color: #ffc107;">ğŸ—‘ï¸ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù ${results.duplicateIds.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©...</div>`;

        // Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª
        const batchSize = 100;
        let deletedCount = 0;

        for (let i = 0; i < results.duplicateIds.length; i += batchSize) {
            const batch = results.duplicateIds.slice(i, i + batchSize);

            const { error } = await supabaseClient
                .from('properties')
                .delete()
                .in('id', batch);

            if (error) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© ${Math.floor(i/batchSize) + 1}: ${error.message}`);
            }

            deletedCount += batch.length;
            detailsEl.textContent = `ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…Ù† ${results.duplicateIds.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©...`;

            // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø¯ÙØ¹Ø§Øª
            await new Promise(resolve => setTimeout(resolve, 200));
        }

        results.duplicatesDeleted = deletedCount;

        logEl.innerHTML += `<div style="color: #28a745;">âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­</div>`;
        console.log(`âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ù† Supabase`);

        await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©: ${error.message}`);
    }
}

// Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©
async function executeStep5_FetchCleanData(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'ğŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©...';
    progressEl.style.width = '70%';
    detailsEl.textContent = 'Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ© Ù…Ù† Supabase';

    try {
        logEl.innerHTML += `<div style="color: #007bff;">ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©...</div>`;

        let allCleanData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;

        while (hasMore) {
            const { data: batchData, error } = await supabaseClient
                .from('properties')
                .select('*')
                .range(from, from + batchSize - 1)
                .order('id', { ascending: true });

            if (error) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©: ${error.message}`);
            }

            if (batchData && batchData.length > 0) {
                allCleanData.push(...batchData);
                from += batchSize;
                hasMore = batchData.length === batchSize;

                detailsEl.textContent = `ØªÙ… Ø¬Ù„Ø¨ ${allCleanData.length} ÙˆØ­Ø¯Ø© Ù…Ù†Ø¸ÙØ©...`;

                // Ø¬Ù…Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ù† ÙˆØ§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                batchData.forEach(unit => {
                    if (unit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']) results.cities.add(unit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']);
                    if (unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']) results.properties.add(unit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
                });
            } else {
                hasMore = false;
            }
        }

        results.cleanData = allCleanData;
        results.finalCount = allCleanData.length;

        logEl.innerHTML += `<div style="color: #28a745;">âœ… ØªÙ… Ø¬Ù„Ø¨ ${allCleanData.length} ÙˆØ­Ø¯Ø© Ù…Ù†Ø¸ÙØ©</div>`;
        logEl.innerHTML += `<div style="color: #6c757d;">ğŸ“Š ${results.cities.size} Ù…Ø¯ÙŠÙ†Ø©ØŒ ${results.properties.size} Ø¹Ù‚Ø§Ø±</div>`;

        console.log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${allCleanData.length} ÙˆØ­Ø¯Ø© Ù…Ù†Ø¸ÙØ©`);

        await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©: ${error.message}`);
    }
}

// Ø§Ù„Ø®Ø·ÙˆØ© 6: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
async function executeStep6_UpdateLocalData(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...';
    progressEl.style.width = '85%';
    detailsEl.textContent = 'Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©';

    try {
        logEl.innerHTML += `<div style="color: #007bff;">ğŸ’¾ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...</div>`;

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        properties.length = 0;
        properties.push(...results.cleanData);

        // Ø­ÙØ¸ ÙÙŠ localStorage
        saveDataLocally();

        logEl.innerHTML += `<div style="color: #28a745;">âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (${properties.length} ÙˆØ­Ø¯Ø©)</div>`;
        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ${properties.length} ÙˆØ­Ø¯Ø©`);

        await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ${error.message}`);
    }
}

// Ø§Ù„Ø®Ø·ÙˆØ© 7: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
async function executeStep7_UpdateDisplay(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'ğŸ–¥ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶...';
    progressEl.style.width = '95%';
    detailsEl.textContent = 'ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';

    try {
        logEl.innerHTML += `<div style="color: #007bff;">ğŸ–¥ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</div>`;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderData();
        updateTotalStats();

        logEl.innerHTML += `<div style="color: #28a745;">âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>`;
        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…`);

        await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶: ${error.message}`);
    }
}

// Ø§Ù„Ø®Ø·ÙˆØ© 8: Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
async function executeStep8_ShowFinalReport(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­!';
    progressEl.style.width = '100%';
    detailsEl.textContent = 'ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­';

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    const citiesList = Array.from(results.cities).sort();
    const propertiesList = Array.from(results.properties).sort();

    const report = `
ğŸ‰ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø§Ù…Ù„

ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:
â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©: ${results.originalCount} ÙˆØ­Ø¯Ø©
â€¢ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: ${results.duplicatesDeleted} ÙˆØ­Ø¯Ø©
â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${results.finalCount} ÙˆØ­Ø¯Ø©
â€¢ Ø§Ù„ÙØ±Ù‚: ${results.finalCount - results.originalCount > 0 ? '+' : ''}${results.finalCount - results.originalCount} ÙˆØ­Ø¯Ø©

ğŸ™ï¸ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ØªØ§Ø­Ø© (${citiesList.length}):
${citiesList.slice(0, 10).join(', ')}${citiesList.length > 10 ? '...' : ''}

ğŸ¢ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (${propertiesList.length}):
${propertiesList.slice(0, 10).join(', ')}${propertiesList.length > 10 ? '...' : ''}

âœ… ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!
    `.trim();

    logEl.innerHTML += `<div style="color: #28a745; font-weight: bold;">âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!</div>`;

    console.log('âœ… ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„:', results);

    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    setTimeout(() => {
        alert(report);
    }, 1000);

    await new Promise(resolve => setTimeout(resolve, 2000));
}

// ğŸš€ Ø¯Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.runDatabaseCleanup = comprehensiveDatabaseCleanup;

// ğŸ‰ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„
async function updateAfterCleanup() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„...');

    if (!supabaseClient) {
        alert('âŒ Supabase ØºÙŠØ± Ù…ØªØ§Ø­!');
        return;
    }

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; padding: 30px; border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000; text-align: center;">
                <h3 style="color: #28a745; margin-bottom: 15px;">ğŸ‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ</h3>
                <div style="margin-bottom: 15px;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ© Ù…Ù† Supabase...</div>
                <div style="width: 300px; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                    <div id="updateProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997);
                                                  transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
        document.body.appendChild(loadingDiv);

        const progressBar = document.getElementById('updateProgress');

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©
        progressBar.style.width = '30%';

        const { data: cleanData, error } = await supabaseClient
            .from('properties')
            .select('*')
            .order('id', { ascending: true });

        if (error) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
        }

        progressBar.style.width = '60%';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const oldCount = properties.length;
        properties.length = 0;
        properties.push(...cleanData);

        progressBar.style.width = '80%';

        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        progressBar.style.width = '90%';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderData();
        updateTotalStats();

        progressBar.style.width = '100%';

        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        setTimeout(() => {
            document.body.removeChild(loadingDiv);

            // Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­
            alert(`ğŸ‰ ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
                  `ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬:\n` +
                  `â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: ${oldCount} ÙˆØ­Ø¯Ø©\n` +
                  `â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©: ${properties.length} ÙˆØ­Ø¯Ø©\n` +
                  `â€¢ ØªÙ… Ø­Ø°Ù: ${3832 - properties.length} ÙˆØ­Ø¯Ø© Ù…ÙƒØ±Ø±Ø©\n` +
                  `â€¢ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ÙƒØ±Ø±Ø© Ø§Ù„Ø¢Ù†\n\n` +
                  `âœ… ØªÙ… Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!`);
        }, 1000);

        console.log(`âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${properties.length} ÙˆØ­Ø¯Ø© Ù…Ù†Ø¸ÙØ©`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', error);
        alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${error.message}`);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
window.updateAfterCleanup = updateAfterCleanup;

// ğŸ—‘ï¸ Ø¯Ø§Ù„Ø© Ø­Ø°Ù ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function deleteSpecificUnit(unitNumber) {
    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}`);

    if (!supabaseClient) {
        alert('âŒ Supabase ØºÙŠØ± Ù…ØªØ§Ø­!');
        return;
    }

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        const localIndex = properties.findIndex(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber);
        const localUnit = localIndex !== -1 ? properties[localIndex] : null;

        if (localUnit) {
            // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            properties.splice(localIndex, 1);
            saveDataLocally();

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            renderData();
            updateTotalStats();

            console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`);

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            showSuccessMessage(
                'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                `ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} Ø¨Ù†Ø¬Ø§Ø­\n` +
                `Ø§Ù„Ø¹Ù‚Ø§Ø±: ${localUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n` +
                `Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${properties.length} ÙˆØ­Ø¯Ø©`
            );
        } else {
            console.log(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber} ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase Ù„Ù„ØªØ£ÙƒØ¯
            await updateAfterCleanup();
        }

    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${unitNumber}:`, error);
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù', error.message);
    }
}

// Ø¯Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ø­Ø°Ù STRU04000
window.deleteSTRU04000 = () => deleteSpecificUnit('STRU04000');

// ğŸ§ª Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
async function testUnitNumberEdit() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©...');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    const testUnit = properties.find(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === '8888');
    if (!testUnit) {
        console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© 8888 Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        return;
    }

    console.log('ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:', {
        unitNumber: testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
        propertyName: testUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
        tenant: testUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']
    });

    // Ø¹Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    const countBefore = properties.length;
    const unitsWithOldNumber = properties.filter(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === '8888').length;
    const unitsWithNewNumber = properties.filter(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === '7').length;

    console.log(`ğŸ“Š Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ=${countBefore}, ÙˆØ­Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… 8888=${unitsWithOldNumber}, ÙˆØ­Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… 7=${unitsWithNewNumber}`);

    // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
    const unitIndex = properties.findIndex(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === '8888');
    if (unitIndex !== -1) {
        // ØªØ·Ø¨ÙŠÙ‚ Ù†ÙØ³ Ù…Ù†Ø·Ù‚ savePropertyEdit
        const originalUnitNumber = '8888';
        const newUnitNumber = '7';
        const originalPropertyName = testUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø¯Ø© Ø£Ø®Ø±Ù‰ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const existingUnitWithNewNumber = properties.find(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === newUnitNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === originalPropertyName &&
            properties.indexOf(p) !== unitIndex
        );

        if (existingUnitWithNewNumber) {
            console.log(`âŒ ÙŠÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø±Ù‚Ù… "${newUnitNumber}" ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø±!`);
            return;
        }

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø­Ø°Ù Ù…Ù† Supabase
        const oldUnitDataForSupabase = { ...properties[unitIndex] };

        // Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Supabase
        if (typeof deletePropertyFromSupabase === 'function') {
            try {
                console.log(`â˜ï¸ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø±Ù‚Ù… "${originalUnitNumber}" Ù…Ù† Supabase...`);
                const deleteResult = await deletePropertyFromSupabase(oldUnitDataForSupabase);
                console.log('ğŸ” Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø°Ù:', deleteResult);
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Supabase:`, error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const newUnitData = { ...properties[unitIndex], 'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': newUnitNumber };
        properties[unitIndex] = newUnitData;

        // Ø¹Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const countAfter = properties.length;
        const unitsWithOldNumberAfter = properties.filter(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === '8888').length;
        const unitsWithNewNumberAfter = properties.filter(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === '7').length;

        console.log(`ğŸ“Š Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ=${countAfter}, ÙˆØ­Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… 8888=${unitsWithOldNumberAfter}, ÙˆØ­Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… 7=${unitsWithNewNumberAfter}`);

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderData();
        updateTotalStats();

        console.log('âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        alert(`ğŸ§ª Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:\n\n` +
              `Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:\n` +
              `â€¢ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: ${countBefore}\n` +
              `â€¢ ÙˆØ­Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… 8888: ${unitsWithOldNumber}\n` +
              `â€¢ ÙˆØ­Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… 7: ${unitsWithNewNumber}\n\n` +
              `Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:\n` +
              `â€¢ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: ${countAfter}\n` +
              `â€¢ ÙˆØ­Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… 8888: ${unitsWithOldNumberAfter}\n` +
              `â€¢ ÙˆØ­Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… 7: ${unitsWithNewNumberAfter}\n\n` +
              `${countAfter === countBefore && unitsWithOldNumberAfter === 0 && unitsWithNewNumberAfter === 1 ? 'âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!' : 'âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!'}`);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
window.testUnitNumberEdit = testUnitNumberEdit;

// ğŸš€ Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ÙƒØ§Ù…Ù„Ø© ÙˆÙÙˆØ±ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function fullDataRecovery() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Supabase...');

    if (!supabaseClient) {
        alert('âŒ Supabase ØºÙŠØ± Ù…ØªØ§Ø­!');
        return;
    }

    const confirmRestore = confirm(
        `ğŸ”„ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n\n` +
        `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${properties.length} ÙˆØ­Ø¯Ø©\n` +
        `Ø³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase (Ø­ÙˆØ§Ù„ÙŠ 3800+ ÙˆØ­Ø¯Ø©)\n\n` +
        `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`
    );

    if (!confirmRestore) return;

    try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© ØªÙ‚Ø¯Ù… Ù…Ø­Ø³Ù†Ø©
        const progressModal = document.createElement('div');
        progressModal.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                        align-items: center; justify-content: center;">
                <div style="background: white; padding: 40px; border-radius: 15px;
                           box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
                           min-width: 400px;">
                    <h2 style="margin: 0 0 20px 0; color: #007bff;">ğŸ”„ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                    <div id="recoveryStatus" style="font-size: 16px; margin-bottom: 20px; color: #333;">
                        Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...
                    </div>
                    <div style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                        <div id="recoveryProgress" style="width: 0%; height: 100%;
                                                          background: linear-gradient(90deg, #28a745, #20c997);
                                                          transition: width 0.3s ease;"></div>
                    </div>
                    <div id="recoveryDetails" style="font-size: 14px; color: #666;">
                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(progressModal);

        const statusEl = document.getElementById('recoveryStatus');
        const progressEl = document.getElementById('recoveryProgress');
        const detailsEl = document.getElementById('recoveryDetails');

        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª
        statusEl.textContent = 'Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase...';
        progressEl.style.width = '10%';

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchCount = 0;

        while (hasMore) {
            batchCount++;
            detailsEl.textContent = `Ø§Ù„Ø¯ÙØ¹Ø© ${batchCount} - ØªÙ… Ø¬Ù„Ø¨ ${allData.length} ÙˆØ­Ø¯Ø©`;

            const { data: batchData, error } = await supabaseClient
                .from('properties')
                .select('*')
                .range(from, from + batchSize - 1)
                .order('id', { ascending: true });

            if (error) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹Ø© ${batchCount}: ${error.message}`);
            }

            if (batchData && batchData.length > 0) {
                allData.push(...batchData);
                from += batchSize;
                hasMore = batchData.length === batchSize;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…
                const progress = Math.min(10 + (allData.length / 4000) * 70, 80);
                progressEl.style.width = `${progress}%`;

                console.log(`ğŸ“¦ Ø¯ÙØ¹Ø© ${batchCount}: ${batchData.length} ÙˆØ­Ø¯Ø© (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${allData.length})`);
            } else {
                hasMore = false;
            }

            // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„ØªØ¬Ù†Ø¨ Ø¥Ø±Ù‡Ø§Ù‚ Ø§Ù„Ø®Ø§Ø¯Ù…
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        statusEl.textContent = 'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
        progressEl.style.width = '85%';
        detailsEl.textContent = `ØªÙ… Ø¬Ù„Ø¨ ${allData.length} ÙˆØ­Ø¯Ø© - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...`;

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        const oldData = [...properties];
        localStorage.setItem('properties_backup_before_recovery', JSON.stringify(oldData));

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        properties.length = 0;
        properties.push(...allData);

        statusEl.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
        progressEl.style.width = '95%';

        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        statusEl.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶...';
        progressEl.style.width = '100%';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderData();
        updateTotalStats();

        // Ø¥Ø²Ø§Ù„Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
        document.body.removeChild(progressModal);

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        alert(`âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
              `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: ${oldData.length} ÙˆØ­Ø¯Ø©\n` +
              `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${properties.length} ÙˆØ­Ø¯Ø©\n` +
              `ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯: ${properties.length - oldData.length} ÙˆØ­Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ©\n\n` +
              `ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©`);

        console.log(`âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯: ${properties.length} ÙˆØ­Ø¯Ø©`);

    } catch (error) {
        // Ø¥Ø²Ø§Ù„Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        const modal = document.querySelector('[style*="position: fixed"]');
        if (modal) {
            document.body.removeChild(modal);
        }

        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…Ù„:', error);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…Ù„:\n${error.message}`);
    }
}

// ğŸš¨ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ÙÙˆØ±ÙŠ ÙˆÙƒØ§Ù…Ù„ Ù…Ù† Supabase
async function recoverDeletedData() {
    console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Supabase...');

    if (!supabaseClient) {
        alert('âŒ Supabase ØºÙŠØ± Ù…ØªØ§Ø­!');
        return;
    }

    const confirmRestore = confirm(
        'ğŸš¨ Ù‡Ø°Ø§ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase\n\n' +
        'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'
    );

    if (!confirmRestore) return;

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loadingMessage = document.createElement('div');
        loadingMessage.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        z-index: 10000; text-align: center;">
                <div style="font-size: 18px; margin-bottom: 15px;">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù…Ù† Supabase...</div>
                <div style="width: 300px; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #007bff, #0056b3);
                                                  transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="margin-top: 10px; color: #666;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        `;
        document.body.appendChild(loadingMessage);

        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…
        progressBar.style.width = '20%';
        progressText.textContent = 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...';

        console.log('ğŸ“¡ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase...');

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;

        while (hasMore) {
            progressText.textContent = `Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... (${allData.length} ÙˆØ­Ø¯Ø©)`;

            const { data: batchData, error } = await supabaseClient
                .from('properties')
                .select('*')
                .range(from, from + batchSize - 1)
                .order('created_at', { ascending: false });

            if (error) {
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            }

            if (batchData && batchData.length > 0) {
                allData.push(...batchData);
                from += batchSize;
                hasMore = batchData.length === batchSize;

                // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                const progress = Math.min(60 + (allData.length / 4000) * 20, 80);
                progressBar.style.width = `${progress}%`;
            } else {
                hasMore = false;
            }
        }

        const supabaseData = allData;

        progressBar.style.width = '60%';
        progressText.textContent = 'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

        if (error) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase: ${error.message}`);
        }

        if (!supabaseData || supabaseData.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯');
        }

        console.log(`ğŸ“Š ØªÙ… Ø¬Ù„Ø¨ ${supabaseData.length} ÙˆØ­Ø¯Ø© Ù…Ù† Supabase`);

        progressBar.style.width = '80%';
        progressText.textContent = 'Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...';

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        const oldCount = properties.length;
        properties.length = 0; // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        properties.push(...supabaseData); // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Supabase

        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
        saveDataLocally();

        progressBar.style.width = '100%';
        progressText.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶...';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderData();
        updateTotalStats();

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.body.removeChild(loadingMessage);

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        alert(`âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
              `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ${oldCount} ÙˆØ­Ø¯Ø©\n` +
              `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${properties.length} ÙˆØ­Ø¯Ø©\n` +
              `Ø§Ù„ÙØ±Ù‚: ${properties.length - oldCount > 0 ? '+' : ''}${properties.length - oldCount} ÙˆØ­Ø¯Ø©`);

        console.log(`âœ… ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ${properties.length} ÙˆØ­Ø¯Ø© Ù…Ù† Supabase Ø¨Ù†Ø¬Ø§Ø­`);

    } catch (error) {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        const loadingElement = document.querySelector('[style*="position: fixed"]');
        if (loadingElement) {
            document.body.removeChild(loadingElement.parentElement || loadingElement);
        }

        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:', error);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:\n${error.message}`);
    }
}

// ğŸ”§ Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†
async function testEnhancedUnitLinking() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!properties || properties.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯ØªÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const testProperty = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']);
        if (!testProperty) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        const propertyName = testProperty['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'];
        const testUnits = properties.filter(p =>
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        ).slice(0, 2);

        if (testUnits.length < 2) {
            console.log('âš ï¸ ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù„Ù‰ ÙˆØ­Ø¯ØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø±');

            // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ©
            const newTestUnit = {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'TEST_LINK_' + Date.now(),
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': propertyName,
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': testProperty['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'] || 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': '',
                'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': '100',
                'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«': new Date().toLocaleDateString('ar-SA'),
                'Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«': 'Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø±',
                'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«': 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'
            };

            properties.push(newTestUnit);
            testUnits.push(newTestUnit);
            console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø±: ${newTestUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
        }

        const testContractNumber = 'CONTRACT_TEST_' + Date.now();

        console.log(`ğŸ“‹ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:`);
        console.log(`- Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyName}`);
        console.log(`- Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${testUnits.map(u => u['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']).join(', ')}`);
        console.log(`- Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ${testContractNumber}`);

        // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø§Ù„Ø¹Ù‚Ø¯
        console.log('ğŸ”— Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰...');
        const firstUnit = testUnits[0];

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        const firstUnitIndex = properties.findIndex(p =>
            p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === firstUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === firstUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']
        );

        if (firstUnitIndex !== -1) {
            properties[firstUnitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] = testContractNumber;
            properties[firstUnitIndex]['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] = 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ (Ø§Ø®ØªØ¨Ø§Ø±)';
            properties[firstUnitIndex]['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'] = '0501234567';
            properties[firstUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] = '01/01/2024';
            properties[firstUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] = '31/12/2024';
            properties[firstUnitIndex]['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] = '50000';
            properties[firstUnitIndex]['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'] = 'Ø³ÙƒÙ†ÙŠ';
            properties[firstUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] = '01/01/2024';
            properties[firstUnitIndex]['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„'] = '12500';
            properties[firstUnitIndex]['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] = '01/04/2024';
            properties[firstUnitIndex]['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'] = '12500';

            console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: ${firstUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
        }

        // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø¯
        console.log('ğŸ”— Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©...');
        await linkUnitToContract(testUnits[1]['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '], propertyName, testContractNumber);

        // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        console.log('ğŸ” Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

        const linkedUnits = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === testContractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        console.log(`ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${linkedUnits.length} ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø©`);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
        const firstLinkedUnit = linkedUnits[0];
        const secondLinkedUnit = linkedUnits[1];

        const sharedFields = [
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', 'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ'
        ];

        let syncedFields = 0;
        let totalFields = sharedFields.length;

        for (const field of sharedFields) {
            if (firstLinkedUnit[field] === secondLinkedUnit[field]) {
                syncedFields++;
                console.log(`âœ… ${field}: Ù…ØªØ·Ø§Ø¨Ù‚ (${firstLinkedUnit[field]})`);
            } else {
                console.log(`âŒ ${field}: ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ (${firstLinkedUnit[field]} â‰  ${secondLinkedUnit[field]})`);
            }
        }

        const syncPercentage = Math.round((syncedFields / totalFields) * 100);
        console.log(`ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${syncPercentage}% (${syncedFields}/${totalFields})`);

        // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('ğŸ”„ Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©...');

        const updatedData = {
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯ (Ù…Ø­Ø¯Ø«)',
            'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': '0509876543',
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': '60000',
            'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„': '15000',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': testContractNumber,
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': propertyName
        };

        const updateResult = await updateLinkedUnitsOnEdit(updatedData);

        if (updateResult.success) {
            console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${updateResult.updatedCount} ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø©`);
        } else {
            console.error(`âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©: ${updateResult.reason}`);
        }

        // Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        console.log('ğŸ” Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');

        const finalLinkedUnits = properties.filter(p =>
            p['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'] === testContractNumber &&
            p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === propertyName
        );

        const finalSyncCheck = finalLinkedUnits.every(unit =>
            unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] === updatedData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] &&
            unit['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'] === updatedData['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'] &&
            unit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '] === updatedData['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ']
        );

        // Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const testResults = {
            success: finalSyncCheck && syncPercentage >= 80,
            linkedUnitsCount: finalLinkedUnits.length,
            syncPercentage,
            updateSuccess: updateResult.success,
            finalSyncCheck
        };

        console.log('ğŸ¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:');
        console.log(`- Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©: ${testResults.linkedUnitsCount}`);
        console.log(`- Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©: ${testResults.syncPercentage}%`);
        console.log(`- Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${testResults.updateSuccess ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`);
        console.log(`- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${testResults.finalSyncCheck ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`);
        console.log(`- Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ø§Ù…Ø©: ${testResults.success ? 'âœ… Ù†Ø¬Ø­' : 'âŒ ÙØ´Ù„'}`);

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        saveDataLocally();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const message = testResults.success
            ? `ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†!\n\nâœ… ØªÙ… Ø±Ø¨Ø· ${testResults.linkedUnitsCount} ÙˆØ­Ø¯Ø©\nâœ… Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${testResults.syncPercentage}%\nâœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­`
            : `âš ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†\n\nØ§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:\n${!testResults.updateSuccess ? '- ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n' : ''}${!testResults.finalSyncCheck ? '- Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©\n' : ''}${testResults.syncPercentage < 80 ? '- Ù†Ø³Ø¨Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù†Ø®ÙØ¶Ø©\n' : ''}`;

        alert(message);
        showToast(testResults.success ? 'Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†' : 'Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†',
                 testResults.success ? 'success' : 'warning');

        return testResults;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', error);
        alert(`âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:\n\n${error.message}`);
        showToast('ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ' + error.message, 'error');
        return { success: false, error: error.message };
    }
}

// ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙŠØ²Ø© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±
function testPropertyNameEdit() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙŠØ²Ø© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        const hasPermission = canEditPropertyName();
        console.log(`ğŸ” ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ${hasPermission ? 'Ù…Ø³Ù…ÙˆØ­' : 'Ù…Ù…Ù†ÙˆØ¹'}`);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const dataIntegrity = validateDataIntegrity();
        console.log(`ğŸ›¡ï¸ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${dataIntegrity ? 'Ø³Ù„ÙŠÙ…Ø©' : 'ØªØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­'}`);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù‚Ø§Ø±Ø§Øª
        if (properties && properties.length > 0) {
            const uniqueProperties = [...new Set(
                properties
                    .filter(p => p && typeof p === 'object' && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
                    .map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'])
            )].filter(name => name && typeof name === 'string' && name.trim() !== '');

            console.log(`ğŸ¢ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${uniqueProperties.length}`);
            console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${properties.length}`);

            if (uniqueProperties.length > 0) {
                console.log(`ğŸ“‹ Ø£ÙˆÙ„ 5 Ø¹Ù‚Ø§Ø±Ø§Øª:`, uniqueProperties.slice(0, 5));
            }
        } else {
            console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        const testResults = {
            permission: hasPermission,
            dataIntegrity: dataIntegrity,
            propertiesCount: properties ? properties.length : 0,
            uniquePropertiesCount: properties ? [...new Set(properties.map(p => p && p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']).filter(Boolean))].length : 0,
            functionsAvailable: {
                canEditPropertyName: typeof canEditPropertyName === 'function',
                validateDataIntegrity: typeof validateDataIntegrity === 'function',
                editPropertyName: typeof editPropertyName === 'function',
                showPropertyNameEditOptions: typeof showPropertyNameEditOptions === 'function'
            }
        };

        console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testResults);

        // Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const message = hasPermission
            ? `âœ… Ù…ÙŠØ²Ø© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¬Ø§Ù‡Ø²Ø©!\n\nğŸ¢ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${testResults.uniquePropertiesCount}\nğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${testResults.propertiesCount}\nğŸ›¡ï¸ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${dataIntegrity ? 'Ù…Ù…ØªØ§Ø²Ø©' : 'ØªØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­'}`
            : `ğŸ”’ Ù…ÙŠØ²Ø© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…ØªØ§Ø­Ø© Ù„Ø¹Ù…Ø± ÙÙ‚Ø·\n\nÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¹Ù…Ø± Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.`;

        alert(message);
        return testResults;

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙŠØ²Ø© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);
        alert('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙŠØ²Ø© ØªØ­Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ' + error.message);
        return { success: false, error: error.message };
    }
}

// ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
async function testPropertyNameUpdateWithoutDuplication() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ø¯ÙˆÙ† Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø® Ù…ÙƒØ±Ø±Ø©...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        if (!canEditPropertyName()) {
            console.log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
            alert('ğŸ”’ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø­ Ù„Ø¹Ù…Ø± ÙÙ‚Ø·');
            return { success: false, reason: 'No permission' };
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!properties || properties.length === 0) {
            console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            return { success: false, reason: 'No data' };
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const uniqueProperties = [...new Set(properties.map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']))].filter(Boolean);
        if (uniqueProperties.length === 0) {
            console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            return { success: false, reason: 'No properties' };
        }

        const testProperty = uniqueProperties[0];
        const testUnits = properties.filter(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === testProperty);

        console.log(`ğŸ“‹ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±: "${testProperty}" (${testUnits.length} ÙˆØ­Ø¯Ø©)`);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ù‚Øª
        const testNewName = `${testProperty}_TEST_${Date.now()}`;

        console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† "${testProperty}" Ø¥Ù„Ù‰ "${testNewName}"`);

        // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const updateResult = await updatePropertyNameInAllSystems(testProperty, testNewName);

        if (updateResult.success) {
            console.log(`âœ… Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${updateResult.updatedUnits} ÙˆØ­Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ ${updateResult.supabaseUpdates} ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªÙƒØ±Ø§Ø± ÙÙŠ Supabase
            if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                try {
                    const { data: duplicateCheck } = await supabaseClient
                        .from('properties')
                        .select('id, unit_number, property_name')
                        .eq('property_name', testNewName);

                    if (duplicateCheck) {
                        // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
                        const unitGroups = {};
                        duplicateCheck.forEach(record => {
                            const unitNumber = record.unit_number;
                            if (!unitGroups[unitNumber]) {
                                unitGroups[unitNumber] = [];
                            }
                            unitGroups[unitNumber].push(record);
                        });

                        let duplicatesFound = 0;
                        Object.values(unitGroups).forEach(group => {
                            if (group.length > 1) {
                                duplicatesFound += group.length - 1;
                            }
                        });

                        console.log(`ğŸ” ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±: ${duplicatesFound} Ø³Ø¬Ù„ Ù…ÙƒØ±Ø± ÙÙŠ Supabase`);

                        if (duplicatesFound === 0) {
                            console.log('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© - Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¬Ø­!');
                        } else {
                            console.warn(`âš ï¸ ÙˆÙØ¬Ø¯Øª ${duplicatesFound} Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© - ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†`);
                        }
                    }
                } catch (checkError) {
                    console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±:', checkError);
                }
            }

            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
            console.log(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ù† "${testNewName}" Ø¥Ù„Ù‰ "${testProperty}"`);
            const restoreResult = await updatePropertyNameInAllSystems(testNewName, testProperty);

            if (restoreResult.success) {
                console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ù†Ø¬Ø§Ø­');

                const testResults = {
                    success: true,
                    testProperty,
                    testNewName,
                    originalUnits: testUnits.length,
                    updatedUnits: updateResult.updatedUnits,
                    supabaseUpdates: updateResult.supabaseUpdates,
                    restoredUnits: restoreResult.updatedUnits,
                    restoredSupabaseUpdates: restoreResult.supabaseUpdates
                };

                const message = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±!\n\n` +
                    `ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬:\n` +
                    `â€¢ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ¨Ø±: "${testProperty}"\n` +
                    `â€¢ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${testUnits.length}\n` +
                    `â€¢ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆÙ„: ${updateResult.updatedUnits} Ù…Ø­Ù„ÙŠØŒ ${updateResult.supabaseUpdates} Ø³Ø­Ø§Ø¨ÙŠ\n` +
                    `â€¢ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©: ${restoreResult.updatedUnits} Ù…Ø­Ù„ÙŠØŒ ${restoreResult.supabaseUpdates} Ø³Ø­Ø§Ø¨ÙŠ\n\n` +
                    `âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…`;

                alert(message);
                return testResults;

            } else {
                console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ:', restoreResult.reason);
                alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ: ${restoreResult.reason}\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù‚Ø§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† "${testNewName}" Ø¥Ù„Ù‰ "${testProperty}"`);
                return { success: false, reason: 'Failed to restore original name', partialSuccess: true };
            }

        } else {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:', updateResult.reason);
            alert(`âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±: ${updateResult.reason}`);
            return { success: false, reason: updateResult.reason };
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±:', error);
        alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`);
        return { success: false, error: error.message };
    }
}

// ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function testFilterResetOnLogin() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');

    try {
        // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const originalState = {
            currentCountry,
            currentProperty,
            filterStatus,
            contractTypeFilter: typeof contractTypeFilter !== 'undefined' ? contractTypeFilter : null
        };

        console.log('ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', originalState);

        // ØªØ¹ÙŠÙŠÙ† ÙÙ„Ø§ØªØ± Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        currentCountry = 'Ø§Ù„Ø±ÙŠØ§Ø¶';
        currentProperty = 'Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ù†Ø®ÙŠÙ„';
        filterStatus = 'ÙØ¹Ø§Ù„';
        if (typeof contractTypeFilter !== 'undefined') {
            contractTypeFilter = 'Ø³ÙƒÙ†ÙŠ';
        }

        console.log('ğŸ”§ ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙÙ„Ø§ØªØ± Ø§Ø®ØªØ¨Ø§Ø±:', {
            currentCountry,
            currentProperty,
            filterStatus,
            contractTypeFilter: typeof contractTypeFilter !== 'undefined' ? contractTypeFilter : null
        });

        // ØªÙ†ÙÙŠØ° Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
        resetFiltersToDefault();

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±
        setTimeout(() => {
            const newState = {
                currentCountry,
                currentProperty,
                filterStatus,
                contractTypeFilter: typeof contractTypeFilter !== 'undefined' ? contractTypeFilter : null
            };

            console.log('ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†:', newState);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
            const isReset = (
                currentCountry === null &&
                currentProperty === null &&
                filterStatus === null &&
                (typeof contractTypeFilter === 'undefined' || contractTypeFilter === null)
            );

            const testResults = {
                success: isReset,
                originalState,
                newState,
                resetCorrectly: {
                    currentCountry: currentCountry === null,
                    currentProperty: currentProperty === null,
                    filterStatus: filterStatus === null,
                    contractTypeFilter: typeof contractTypeFilter === 'undefined' || contractTypeFilter === null
                }
            };

            console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testResults);

            const message = isReset
                ? `âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±!\n\nğŸ”„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ø¥Ù„Ù‰ "Ø§Ù„ÙƒÙ„":\nâ€¢ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry || 'Ø§Ù„ÙƒÙ„'}\nâ€¢ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${currentProperty || 'Ø§Ù„ÙƒÙ„'}\nâ€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${filterStatus || 'Ø§Ù„ÙƒÙ„'}\nâ€¢ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${(typeof contractTypeFilter !== 'undefined' ? contractTypeFilter : null) || 'Ø§Ù„ÙƒÙ„'}`
                : `âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±\n\nØ§Ù„Ù…Ø´Ø§ÙƒÙ„:\n${!testResults.resetCorrectly.currentCountry ? 'â€¢ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§\n' : ''}${!testResults.resetCorrectly.currentProperty ? 'â€¢ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡\n' : ''}${!testResults.resetCorrectly.filterStatus ? 'â€¢ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡\n' : ''}${!testResults.resetCorrectly.contractTypeFilter ? 'â€¢ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡\n' : ''}`;

            alert(message);

            return testResults;

        }, 1000);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±:', error);
        alert('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±: ' + error.message);
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª
async function fixUnitLinkingIssues() {
    console.log('ğŸ› ï¸ Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    try {
        let fixedIssues = [];
        let totalIssues = 0;

        // 1. ÙØ­Øµ Ø§ØªØµØ§Ù„ Supabase
        console.log('ğŸ” ÙØ­Øµ Ø§ØªØµØ§Ù„ Supabase...');
        if (!supabaseClient) {
            totalIssues++;
            console.error('âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„');
            fixedIssues.push('âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        } else {
            try {
                const { error } = await supabaseClient.from('properties').select('count', { count: 'exact', head: true });
                if (error) {
                    totalIssues++;
                    fixedIssues.push(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Supabase: ${error.message}`);
                } else {
                    fixedIssues.push('âœ… Ø§ØªØµØ§Ù„ Supabase ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ');
                }
            } catch (error) {
                totalIssues++;
                fixedIssues.push(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Supabase: ${error.message}`);
            }
        }

        // 2. ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        console.log('ğŸ” ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©...');
        const requiredFunctions = [
            'saveUnitLinkingToSupabase',
            'linkUnitToContract',
            'unlinkUnit',
            'savePropertyToSupabase'
        ];

        requiredFunctions.forEach(funcName => {
            if (typeof window[funcName] === 'function') {
                fixedIssues.push(`âœ… ${funcName} Ù…ØªÙˆÙØ±Ø©`);
            } else {
                totalIssues++;
                fixedIssues.push(`âŒ ${funcName} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©`);
            }
        });

        // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø±Ø¨Ø·
        console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø±Ø¨Ø·...');
        if (supabaseClient && typeof saveUnitLinkingToSupabase === 'function') {
            try {
                const testResult = await quickUnitLinkingTest();
                if (testResult.success) {
                    fixedIssues.push('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ù†Ø¬Ø­');
                } else {
                    totalIssues++;
                    fixedIssues.push(`âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·: ${testResult.error}`);
                }
            } catch (error) {
                totalIssues++;
                fixedIssues.push(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·: ${error.message}`);
            }
        }

        // 4. Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const successRate = Math.round(((fixedIssues.length - totalIssues) / fixedIssues.length) * 100);

        let message = `ğŸ› ï¸ ØªÙ‚Ø±ÙŠØ± Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª\n\n`;
        message += `ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ø§Ù…Ø©: ${successRate}%\n`;
        message += `âœ… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„ÙŠÙ…Ø©: ${fixedIssues.length - totalIssues}\n`;
        message += `âŒ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${totalIssues}\n\n`;
        message += `ğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n${fixedIssues.join('\n')}\n\n`;

        if (totalIssues === 0) {
            message += `ğŸ‰ Ù…Ù…ØªØ§Ø²! Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ`;
            showToast('ğŸ‰ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ', 'success');
        } else if (successRate >= 70) {
            message += `âš ï¸ ÙŠÙˆØ¬Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©`;
            showToast('âš ï¸ ÙŠÙˆØ¬Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©', 'warning');
        } else {
            message += `âŒ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ÙƒØ¨ÙŠØ±Ø© ØªØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­`;
            showToast('âŒ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ÙƒØ¨ÙŠØ±Ø©', 'error');
        }

        alert(message);
        console.log('ğŸ› ï¸ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ÙØ­Øµ Ù…Ø´Ø§ÙƒÙ„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª');

        return {
            success: totalIssues === 0,
            successRate,
            totalIssues,
            fixedIssues
        };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', error);
        alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:\n\n${error.message}`);
        showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', 'error');
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª - Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
async function quickUnitLinkingTest() {
    console.log('ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        if (typeof saveUnitLinkingToSupabase !== 'function') {
            throw new Error('Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø· ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø±
        const testData = {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'QUICK-LINK-' + Date.now(),
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø±',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'CONTRACT-QUICK-' + Date.now(),
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 1500,
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 100,
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
        };

        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testData);

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¨Ø·
        const result = await saveUnitLinkingToSupabase(testData, 'link');

        if (result && result.id) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸
            const { data: verifyData, error: verifyError } = await supabaseClient
                .from('properties')
                .select('*')
                .eq('id', result.id)
                .single();

            if (verifyError) {
                console.warn('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸:', verifyError);
            }

            const message = `âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª!\n\nğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©:\n- Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„: ${result.id}\n- Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${testData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}\n- Ø§Ù„Ø¹Ù‚Ø¯: ${testData['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}\n- Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${testData['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}\n\n${verifyError ? 'âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸' : 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­'}\n\nğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Supabase Dashboard â†’ Table Editor â†’ properties`;

            alert(message);
            showToast('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª!', 'success');

            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', result);
            return { success: true, result, verified: !verifyError };

        } else {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù†ØªÙŠØ¬Ø© ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ø­ÙØ¸');
        }

    } catch (error) {
        const message = `âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª!\n\nØ§Ù„Ø®Ø·Ø£: ${error.message}\n\nğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:\n- Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª\n- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase\n- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©`;

        alert(message);
        showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª', 'error');

        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', error);
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ - ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¨Ù€ testLinking()
async function testLinking() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        if (!supabaseClient) {
            console.error('âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„');
            alert('âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
            return false;
        }

        console.log('âœ… Supabase Ù…ØªØµÙ„');

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø±
        const timestamp = Date.now();
        const testUnit = {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': `TEST-${timestamp}`,
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø±',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': `CONTRACT-${timestamp}`,
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 2000,
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 120,
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '01/01/2024',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '31/12/2024',
            'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'Ù…Ø§Ù„Ùƒ Ø§Ø®ØªØ¨Ø§Ø±',
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': `DEED-${timestamp}`,
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': `REG-${timestamp}`
        };

        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testUnit);

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·
        console.log('ğŸ”— Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·...');
        const linkResult = await saveUnitLinkingToSupabase(testUnit, 'link');

        if (linkResult && linkResult.id) {
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ù„Ø±Ø¨Ø·! Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„:', linkResult.id);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸
            const { data: savedData, error: fetchError } = await supabaseClient
                .from('properties')
                .select('*')
                .eq('id', linkResult.id)
                .single();

            if (fetchError) {
                console.warn('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸:', fetchError);
            } else {
                console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­:', savedData);
            }

            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„
            console.log('ğŸ”“ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„...');
            const unlinkResult = await saveUnitLinkingToSupabase(testUnit, 'unlink');

            if (unlinkResult && unlinkResult.id) {
                console.log('âœ… Ù†Ø¬Ø­ Ø§Ù„ÙØµÙ„! Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„:', unlinkResult.id);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„
                const { data: unlinkedData, error: unlinkFetchError } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('id', unlinkResult.id)
                    .single();

                if (unlinkFetchError) {
                    console.warn('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„:', unlinkFetchError);
                } else {
                    console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­:', unlinkedData);
                    console.log('ğŸ” Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø¨Ø¹Ø¯ Ø§Ù„ÙØµÙ„:', {
                        contract: unlinkedData.contract_number,
                        tenant: unlinkedData.tenant_name
                    });
                }

                const successMessage = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· ÙˆØ§Ù„ÙØµÙ„!\n\nâœ… Ø§Ù„Ø±Ø¨Ø·: ${linkResult.id}\nâœ… Ø§Ù„ÙØµÙ„: ${unlinkResult.id}\n\nğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Supabase Dashboard`;
                alert(successMessage);
                showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· ÙˆØ§Ù„ÙØµÙ„!', 'success');

                return true;
            } else {
                throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙØµÙ„');
            }
        } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø±Ø¨Ø·');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
        alert(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`);
        showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
        return false;
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.testLinking = testLinking;

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª
function showUnitLinkingGuide() {
    const guideMessage = `
ğŸ”— Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª

ğŸ“‹ ÙƒÙŠÙÙŠØ© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:

1ï¸âƒ£ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø£ØµÙØ± "ØªØ­Ø±ÙŠØ±" Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©
2ï¸âƒ£ Ø§Ù†Ø²Ù„ Ù„Ù„Ø£Ø³ÙÙ„ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±
3ï¸âƒ£ Ø³ØªØ¬Ø¯ Ù‚Ø³Ù… "Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¨Ø·"
4ï¸âƒ£ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø±Ø¨Ø·" Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
5ï¸âƒ£ Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· ÙÙˆØ±Ø§Ù‹ ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Supabase

âœ… Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
â€¢ Ø§Ù„Ø±Ø¨Ø· ÙŠØ­ÙØ¸ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
â€¢ Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
â€¢ ÙŠØ¸Ù‡Ø± Ø±Ø³Ø§Ø¦Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù†Ø¬Ø§Ø­ Ø£Ùˆ Ø§Ù„ÙØ´Ù„
â€¢ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase Dashboard

ğŸ§ª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:
â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª" ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
â€¢ Ø£Ùˆ Ø§ÙƒØªØ¨ testLinking() ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„

ğŸ”§ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:
â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
â€¢ Ø±Ø§Ø¬Ø¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    `;

    alert(guideMessage);
    console.log('ğŸ“– Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', guideMessage);
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.showUnitLinkingGuide = showUnitLinkingGuide;

// ===== Ù†Ø¸Ø§Ù… Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª =====

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø¬ÙˆØ§Ù†Ø¨ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª
async function comprehensiveUnitLinkingTest() {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    const testResults = {
        supabaseConnection: false,
        basicLinking: false,
        unlinking: false,
        dataVerification: false,
        uiIntegration: false,
        errors: []
    };

    try {
        // 1. Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase
        console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± 1: ÙØ­Øµ Ø§ØªØµØ§Ù„ Supabase...');
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„Ø§ØªØµØ§Ù„
        const { data: testConnection, error: connectionError } = await supabaseClient
            .from('properties')
            .select('id')
            .limit(1);

        if (connectionError) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${connectionError.message}`);
        }

        testResults.supabaseConnection = true;
        console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø¬Ø­');

        // 2. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        console.log('ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± 2: Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ...');
        const timestamp = Date.now();
        const testUnit = {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': `COMPREHENSIVE-TEST-${timestamp}`,
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': `CONTRACT-COMPREHENSIVE-${timestamp}`,
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 2500,
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 150,
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '01/01/2024',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '31/12/2024',
            'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'Ù…Ø§Ù„Ùƒ Ø§Ø®ØªØ¨Ø§Ø±',
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': `DEED-${timestamp}`,
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': `REG-${timestamp}`
        };

        const linkResult = await saveUnitLinkingToSupabase(testUnit, 'link');
        if (!linkResult || !linkResult.id) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ');
        }

        testResults.basicLinking = true;
        console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù†Ø¬Ø­');

        // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        const { data: verifyData, error: verifyError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('id', linkResult.id)
            .single();

        if (verifyError || !verifyData) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        if (verifyData.tenant_name !== testUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] ||
            verifyData.contract_number !== testUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {
            throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø§ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©');
        }

        testResults.dataVerification = true;
        console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø¬Ø­');

        // 4. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„
        console.log('ğŸ”“ Ø§Ø®ØªØ¨Ø§Ø± 4: ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©...');
        const unlinkResult = await saveUnitLinkingToSupabase(testUnit, 'unlink');
        if (!unlinkResult || !unlinkResult.id) {
            throw new Error('ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„
        const { data: unlinkVerifyData, error: unlinkVerifyError } = await supabaseClient
            .from('properties')
            .select('tenant_name, contract_number')
            .eq('id', unlinkResult.id)
            .single();

        if (unlinkVerifyError || !unlinkVerifyData) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„');
        }

        if (unlinkVerifyData.tenant_name !== '' || unlinkVerifyData.contract_number !== '') {
            throw new Error('Ù„Ù… ÙŠØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        }

        testResults.unlinking = true;
        console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„ Ù†Ø¬Ø­');

        // 5. Ø§Ø®ØªØ¨Ø§Ø± ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        console.log('ğŸ¨ Ø§Ø®ØªØ¨Ø§Ø± 5: ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
        const requiredFunctions = [
            'linkUnitToGroup',
            'unlinkUnitFromGroup',
            'saveUnitLinkingToSupabase',
            'updateLinkedUnitsDisplay',
            'updateAvailableUnitsForLinking'
        ];

        let missingFunctions = [];
        requiredFunctions.forEach(funcName => {
            if (typeof window[funcName] !== 'function') {
                missingFunctions.push(funcName);
            }
        });

        if (missingFunctions.length > 0) {
            throw new Error(`Ø¯ÙˆØ§Ù„ Ù…ÙÙ‚ÙˆØ¯Ø©: ${missingFunctions.join(', ')}`);
        }

        testResults.uiIntegration = true;
        console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù†Ø¬Ø­');

        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const allTestsPassed = Object.values(testResults).every(result =>
            typeof result === 'boolean' ? result : true
        );

        if (allTestsPassed) {
            const successMessage = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨Ù†Ø³Ø¨Ø© 100%!

âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª:
â€¢ Ø§ØªØµØ§Ù„ Supabase: Ù†Ø¬Ø­
â€¢ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: Ù†Ø¬Ø­
â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù†Ø¬Ø­
â€¢ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: Ù†Ø¬Ø­
â€¢ ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ù†Ø¬Ø­

ğŸ”— Ù…Ø¹Ø±Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${linkResult.id}
ğŸ“Š Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„!`;

            alert(successMessage);
            showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„!', 'success');
            console.log('ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª');

            return { success: true, results: testResults, testId: linkResult.id };
        } else {
            throw new Error('Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª');
        }

    } catch (error) {
        testResults.errors.push(error.message);
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„:', error);

        const errorMessage = `âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:
â€¢ Ø§ØªØµØ§Ù„ Supabase: ${testResults.supabaseConnection ? 'âœ…' : 'âŒ'}
â€¢ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ${testResults.basicLinking ? 'âœ…' : 'âŒ'}
â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${testResults.dataVerification ? 'âœ…' : 'âŒ'}
â€¢ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${testResults.unlinking ? 'âœ…' : 'âŒ'}
â€¢ ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: ${testResults.uiIntegration ? 'âœ…' : 'âŒ'}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„', 'error');

        return { success: false, results: testResults, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
async function quickUILinkingTest() {
    console.log('ğŸ¨ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if (!window.allData || !Array.isArray(window.allData) || window.allData.length === 0) {
            throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const emptyUnit = window.allData.find(unit =>
            !unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === ''
        );

        if (!emptyUnit) {
            // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ù‚ØªØ©
            const testUnit = {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': `UI-TEST-${Date.now()}`,
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': '',
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 0,
                'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 100,
                'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
            };

            window.allData.push(testUnit);
            console.log('ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ù‚ØªØ©');
        }

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const testUnitNumber = emptyUnit ? emptyUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] : `UI-TEST-${Date.now()}`;
        const testPropertyName = emptyUnit ? emptyUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] : 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©';

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        window.currentPrimaryUnit = {
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': testPropertyName,
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': testUnitNumber
        };

        window.currentEditingUnits = [];

        console.log(`ğŸ”— Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${testUnitNumber}...`);

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø· Ø§Ù„ÙØ¹Ù„ÙŠØ©
        await linkUnitToGroup(testUnitNumber);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø±Ø¨Ø·
        const wasLinked = window.currentEditingUnits.some(unit =>
            unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === testUnitNumber
        );

        if (wasLinked) {
            const successMessage = `âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©!

ğŸ”— ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©: ${testUnitNumber}
ğŸ¢ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${testPropertyName}
ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø¬Ø§Ø­
â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase

ğŸ¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ!`;

            alert(successMessage);
            showToast('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©!', 'success');
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');

            return { success: true, unitNumber: testUnitNumber, propertyName: testPropertyName };
        } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:', error);

        const errorMessage = `âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
â€¢ Ø§ØªØµØ§Ù„ Supabase
â€¢ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©', 'error');

        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„Ø© Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø±Ø¨Ø·
async function diagnoseLinkingIssues() {
    console.log('ğŸ” Ø¨Ø¯Ø¡ ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø±Ø¨Ø·...');

    const diagnostics = {
        supabase: { connected: false, tableExists: false, canWrite: false },
        functions: { linkUnitToGroup: false, saveUnitLinkingToSupabase: false },
        data: { allDataExists: false, hasUnits: false },
        ui: { editFormsExist: false, buttonsExist: false },
        issues: []
    };

    try {
        // 1. ØªØ´Ø®ÙŠØµ Supabase
        console.log('ğŸ” ØªØ´Ø®ÙŠØµ Supabase...');
        if (supabaseClient) {
            diagnostics.supabase.connected = true;

            try {
                const { data, error } = await supabaseClient.from('properties').select('id').limit(1);
                if (!error) {
                    diagnostics.supabase.tableExists = true;

                    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
                    const testData = {
                        unit_number: `DIAG-TEST-${Date.now()}`,
                        property_name: 'ØªØ´Ø®ÙŠØµ',
                        city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                        tenant_name: 'Ø§Ø®ØªØ¨Ø§Ø±',
                        contract_number: 'TEST-DIAG'
                    };

                    const { data: writeData, error: writeError } = await supabaseClient
                        .from('properties')
                        .insert([testData])
                        .select();

                    if (!writeError && writeData && writeData.length > 0) {
                        diagnostics.supabase.canWrite = true;

                        // Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                        await supabaseClient
                            .from('properties')
                            .delete()
                            .eq('id', writeData[0].id);
                    }
                }
            } catch (supabaseError) {
                diagnostics.issues.push(`Ø®Ø·Ø£ ÙÙŠ Supabase: ${supabaseError.message}`);
            }
        } else {
            diagnostics.issues.push('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // 2. ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¯ÙˆØ§Ù„
        console.log('ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¯ÙˆØ§Ù„...');
        diagnostics.functions.linkUnitToGroup = typeof linkUnitToGroup === 'function';
        diagnostics.functions.saveUnitLinkingToSupabase = typeof saveUnitLinkingToSupabase === 'function';

        if (!diagnostics.functions.linkUnitToGroup) {
            diagnostics.issues.push('Ø¯Ø§Ù„Ø© linkUnitToGroup Ù…ÙÙ‚ÙˆØ¯Ø©');
        }
        if (!diagnostics.functions.saveUnitLinkingToSupabase) {
            diagnostics.issues.push('Ø¯Ø§Ù„Ø© saveUnitLinkingToSupabase Ù…ÙÙ‚ÙˆØ¯Ø©');
        }

        // 3. ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        if (window.allData && Array.isArray(window.allData)) {
            diagnostics.data.allDataExists = true;
            diagnostics.data.hasUnits = window.allData.length > 0;
        } else {
            diagnostics.issues.push('Ø¨ÙŠØ§Ù†Ø§Øª allData Ù…ÙÙ‚ÙˆØ¯Ø© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        }

        // 4. ØªØ´Ø®ÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        console.log('ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
        const editForms = document.querySelectorAll('#multiUnitEditForm, #propertyEditForm');
        diagnostics.ui.editFormsExist = editForms.length > 0;

        const linkButtons = document.querySelectorAll('[onclick*="linkUnitToGroup"]');
        diagnostics.ui.buttonsExist = linkButtons.length > 0;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        const report = generateDiagnosticReport(diagnostics);
        console.log('ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ:', report);

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        const issueCount = diagnostics.issues.length;
        const successRate = Math.round(((Object.keys(diagnostics).length - 1 - issueCount) / (Object.keys(diagnostics).length - 1)) * 100);

        const message = `ğŸ” ØªÙ‚Ø±ÙŠØ± ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø±Ø¨Ø·

ğŸ“Š Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­: ${successRate}%
âŒ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: ${issueCount}

${report}

${issueCount === 0 ? 'ğŸ‰ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!' : 'ğŸ’¡ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡'}`;

        alert(message);

        if (issueCount === 0) {
            showToast('ğŸ‰ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!', 'success');
        } else {
            showToast(`âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${issueCount} Ù…Ø´ÙƒÙ„Ø©`, 'warning');
        }

        return { success: issueCount === 0, diagnostics, report };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ:', error);
        alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ: ${error.message}`);
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ
function generateDiagnosticReport(diagnostics) {
    let report = '';

    // Supabase
    report += 'â˜ï¸ Supabase:\n';
    report += `  â€¢ Ø§Ù„Ø§ØªØµØ§Ù„: ${diagnostics.supabase.connected ? 'âœ…' : 'âŒ'}\n`;
    report += `  â€¢ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ${diagnostics.supabase.tableExists ? 'âœ…' : 'âŒ'}\n`;
    report += `  â€¢ Ø§Ù„ÙƒØªØ§Ø¨Ø©: ${diagnostics.supabase.canWrite ? 'âœ…' : 'âŒ'}\n\n`;

    // Ø§Ù„Ø¯ÙˆØ§Ù„
    report += 'âš™ï¸ Ø§Ù„Ø¯ÙˆØ§Ù„:\n';
    report += `  â€¢ linkUnitToGroup: ${diagnostics.functions.linkUnitToGroup ? 'âœ…' : 'âŒ'}\n`;
    report += `  â€¢ saveUnitLinkingToSupabase: ${diagnostics.functions.saveUnitLinkingToSupabase ? 'âœ…' : 'âŒ'}\n\n`;

    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    report += 'ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n';
    report += `  â€¢ allData Ù…ÙˆØ¬ÙˆØ¯: ${diagnostics.data.allDataExists ? 'âœ…' : 'âŒ'}\n`;
    report += `  â€¢ ÙŠØ­ØªÙˆÙŠ ÙˆØ­Ø¯Ø§Øª: ${diagnostics.data.hasUnits ? 'âœ…' : 'âŒ'}\n\n`;

    // Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    report += 'ğŸ¨ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:\n';
    report += `  â€¢ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ­Ø±ÙŠØ±: ${diagnostics.ui.editFormsExist ? 'âœ…' : 'âŒ'}\n`;
    report += `  â€¢ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¨Ø·: ${diagnostics.ui.buttonsExist ? 'âœ…' : 'âŒ'}\n\n`;

    // Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
    if (diagnostics.issues.length > 0) {
        report += 'âŒ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:\n';
        diagnostics.issues.forEach((issue, index) => {
            report += `  ${index + 1}. ${issue}\n`;
        });
    }

    return report;
}

// Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.comprehensiveUnitLinkingTest = comprehensiveUnitLinkingTest;
window.quickUILinkingTest = quickUILinkingTest;
window.diagnoseLinkingIssues = diagnoseLinkingIssues;

// Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
async function runAllLinkingTests() {
    console.log('ğŸ§ª ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¨Ø·...');

    const results = {
        comprehensive: null,
        uiTest: null,
        diagnostics: null,
        overallSuccess: false
    };

    try {
        // 1. Ø§Ù„ØªØ´Ø®ÙŠØµ Ø£ÙˆÙ„Ø§Ù‹
        console.log('ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´Ø®ÙŠØµ...');
        results.diagnostics = await diagnoseLinkingIssues();

        if (!results.diagnostics.success) {
            throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ - ÙŠØ¬Ø¨ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        }

        // 2. Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„
        console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„...');
        results.comprehensive = await comprehensiveUnitLinkingTest();

        if (!results.comprehensive.success) {
            throw new Error('ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„');
        }

        // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        console.log('ğŸ¨ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
        results.uiTest = await quickUILinkingTest();

        if (!results.uiTest.success) {
            console.warn('âš ï¸ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ Ù„ÙƒÙ† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù†Ø¬Ø­Øª');
        }

        results.overallSuccess = results.comprehensive.success && results.diagnostics.success;

        const finalMessage = `ğŸ‰ Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¨Ø·!

ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬:
âœ… Ø§Ù„ØªØ´Ø®ÙŠØµ: ${results.diagnostics.success ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„'}
âœ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„: ${results.comprehensive.success ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„'}
${results.uiTest ? (results.uiTest.success ? 'âœ…' : 'âš ï¸') : 'âš ï¸'} Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: ${results.uiTest ? (results.uiTest.success ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„') : 'Ù„Ù… ÙŠØªÙ…'}

ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ø§Ù…Ø©: ${results.overallSuccess ? 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!' : 'ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­Ø§Øª'}

ğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨Ø«Ù‚Ø©!`;

        alert(finalMessage);
        showToast('ğŸ‰ Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª!', 'success');

        return results;

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:', error);

        const errorMessage = `âŒ ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©:
${results.diagnostics ? (results.diagnostics.success ? 'âœ…' : 'âŒ') : 'â³'} Ø§Ù„ØªØ´Ø®ÙŠØµ: ${results.diagnostics ? (results.diagnostics.success ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„') : 'Ù„Ù… ÙŠØªÙ…'}
${results.comprehensive ? (results.comprehensive.success ? 'âœ…' : 'âŒ') : 'â³'} Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„: ${results.comprehensive ? (results.comprehensive.success ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„') : 'Ù„Ù… ÙŠØªÙ…'}
${results.uiTest ? (results.uiTest.success ? 'âœ…' : 'âŒ') : 'â³'} Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: ${results.uiTest ? (results.uiTest.success ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„') : 'Ù„Ù… ÙŠØªÙ…'}`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª', 'error');

        return { ...results, overallSuccess: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.runAllLinkingTests = runAllLinkingTests;

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø±Ø¨Ø· - ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
async function directLinkingTest() {
    console.log('ğŸš€ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¨Ø·...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        if (typeof saveUnitLinkingToSupabase !== 'function') {
            throw new Error('Ø¯Ø§Ù„Ø© saveUnitLinkingToSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }

        const timestamp = Date.now();

        // 1. Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø±
        console.log('ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø±...');
        const testUnit = {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': `DIRECT-${timestamp}`,
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±',
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': `CONTRACT-DIRECT-${timestamp}`,
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 2800,
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 180,
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '01/01/2024',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '31/12/2024',
            'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'Ù…Ø§Ù„Ùƒ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±',
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': `DEED-DIRECT-${timestamp}`,
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': `REG-DIRECT-${timestamp}`
        };

        // 2. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·
        console.log('ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø·...');
        const linkResult = await saveUnitLinkingToSupabase(testUnit, 'link');

        if (!linkResult || !linkResult.id) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©');
        }

        console.log('âœ… Ù†Ø¬Ø­ Ø§Ù„Ø±Ø¨Ø· - Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„:', linkResult.id);

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¨Ø·
        console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¨Ø·...');
        const { data: verifyData, error: verifyError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('id', linkResult.id)
            .single();

        if (verifyError || !verifyData) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¨Ø·');
        }

        if (verifyData.tenant_name !== testUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] ||
            verifyData.contract_number !== testUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {
            throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø§ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©');
        }

        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­');

        // 4. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„
        console.log('ğŸ”“ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„...');
        const unlinkResult = await saveUnitLinkingToSupabase(testUnit, 'unlink');

        if (!unlinkResult || !unlinkResult.id) {
            throw new Error('ÙØ´Ù„ ÙÙŠ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©');
        }

        console.log('âœ… Ù†Ø¬Ø­ Ø§Ù„ÙØµÙ„ - Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„:', unlinkResult.id);

        // 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„
        console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„...');
        const { data: unlinkVerifyData, error: unlinkVerifyError } = await supabaseClient
            .from('properties')
            .select('tenant_name, contract_number')
            .eq('id', unlinkResult.id)
            .single();

        if (unlinkVerifyError || !unlinkVerifyData) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„');
        }

        if (unlinkVerifyData.tenant_name !== '' || unlinkVerifyData.contract_number !== '') {
            throw new Error('Ù„Ù… ÙŠØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        }

        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­');

        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const successMessage = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ù†Ø³Ø¨Ø© 100%!

âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù†Ø¬Ø­Øª:
ğŸ”— Ø§Ù„Ø±Ø¨Ø·: Ù†Ø¬Ø­ (ID: ${linkResult.id})
ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¨Ø·: Ù†Ø¬Ø­
ğŸ”“ Ø§Ù„ÙØµÙ„: Ù†Ø¬Ø­ (ID: ${unlinkResult.id})
ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„: Ù†Ø¬Ø­

ğŸ“Š Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}
ğŸ¢ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${testUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${testUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯: ${testUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']}

ğŸ¯ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!
ğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Dashboard`;

        alert(successMessage);
        showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±!', 'success');
        console.log('ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¨Ø·');

        return {
            success: true,
            linkId: linkResult.id,
            unlinkId: unlinkResult.id,
            unitNumber: testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
            testData: testUnit
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', error);

        const errorMessage = `âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
â€¢ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

ğŸ” Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', 'error');

        return { success: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.directLinkingTest = directLinkingTest;

// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙÙŠ Supabase
async function linkRealUnitsInSupabase(primaryUnitNumber, secondaryUnitNumber) {
    console.log(`ğŸ”— Ø¨Ø¯Ø¡ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©: ${primaryUnitNumber} Ù…Ø¹ ${secondaryUnitNumber}`);

    try {
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        console.log(`ğŸ“‹ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ${primaryUnitNumber}...`);
        const { data: primaryUnit, error: primaryError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', primaryUnitNumber)
            .single();

        if (primaryError || !primaryUnit) {
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ${primaryUnitNumber}: ${primaryError?.message}`);
        }

        console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:', {
            unit: primaryUnit.unit_number,
            tenant: primaryUnit.tenant_name,
            contract: primaryUnit.contract_number,
            rent: primaryUnit.rent_value
        });

        // 2. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
        console.log(`ğŸ“‹ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© ${secondaryUnitNumber}...`);
        const { data: secondaryUnit, error: secondaryError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', secondaryUnitNumber)
            .single();

        if (secondaryError || !secondaryUnit) {
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© ${secondaryUnitNumber}: ${secondaryError?.message}`);
        }

        console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©:', {
            unit: secondaryUnit.unit_number,
            tenant: secondaryUnit.tenant_name || 'ÙØ§Ø±Øº',
            contract: secondaryUnit.contract_number || 'ÙØ§Ø±Øº'
        });

        // 3. Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
        console.log(`ğŸ“ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ${primaryUnitNumber} Ø¥Ù„Ù‰ ${secondaryUnitNumber}...`);

        const updatedSecondaryData = {
            tenant_name: primaryUnit.tenant_name,
            contract_number: primaryUnit.contract_number,
            rent_value: primaryUnit.rent_value,
            contract_type: primaryUnit.contract_type,
            start_date: primaryUnit.start_date,
            end_date: primaryUnit.end_date,
            total_amount: primaryUnit.total_amount,
            owner: primaryUnit.owner,
            deed_number: primaryUnit.deed_number,
            real_estate_registry: primaryUnit.real_estate_registry,
            electricity_account: primaryUnit.electricity_account,
            remaining_installments: primaryUnit.remaining_installments,
            first_installment_date: primaryUnit.first_installment_date,
            first_installment_amount: primaryUnit.first_installment_amount,
            second_installment_date: primaryUnit.second_installment_date,
            second_installment_amount: primaryUnit.second_installment_amount,
            installment_end_date: primaryUnit.installment_end_date,
            updated_at: new Date().toISOString()
        };

        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© ÙÙŠ Supabase
        console.log(`â˜ï¸ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙˆØ®Ø© ÙÙŠ Supabase...`);
        const { data: updatedUnit, error: updateError } = await supabaseClient
            .from('properties')
            .update(updatedSecondaryData)
            .eq('id', secondaryUnit.id)
            .select();

        if (updateError) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©: ${updateError.message}`);
        }

        if (!updatedUnit || updatedUnit.length === 0) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        }

        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');

        // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
        if (window.allData && Array.isArray(window.allData)) {
            console.log('ğŸ“± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');

            const localSecondaryIndex = window.allData.findIndex(unit =>
                unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === secondaryUnitNumber
            );

            if (localSecondaryIndex !== -1) {
                // Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
                const localPrimary = window.allData.find(unit =>
                    unit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === primaryUnitNumber
                );

                if (localPrimary) {
                    const fieldsToSync = [
                        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±',
                        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
                        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
                        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ',
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
                        'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰',
                        'Ø§Ù„Ù…Ø§Ù„Ùƒ',
                        'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ',
                        'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ',
                        'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                        'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©',
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
                        'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø§ÙˆÙ„',
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ',
                        'Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ',
                        'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·'
                    ];

                    fieldsToSync.forEach(field => {
                        if (localPrimary[field] !== undefined && localPrimary[field] !== null) {
                            window.allData[localSecondaryIndex][field] = localPrimary[field];
                        }
                    });

                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    localStorage.setItem('propertyData', JSON.stringify(window.allData));
                    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                }
            }
        }

        // 6. Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const successMessage = `ğŸ‰ ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!

ğŸ”— Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: ${primaryUnitNumber}
ğŸ”— Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©: ${secondaryUnitNumber}

ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙˆØ®Ø©:
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${primaryUnit.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯: ${primaryUnit.contract_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
ğŸ’° Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${primaryUnit.rent_value ? parseFloat(primaryUnit.rent_value).toLocaleString() + ' Ø±ÙŠØ§Ù„' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­
ğŸ“± ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
ğŸ”„ Ø³ØªØ¸Ù‡Ø± Ø§Ù„ÙˆØ­Ø¯ØªØ§Ù† ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø©

ğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Supabase Dashboard`;

        alert(successMessage);
        showToast(`ØªÙ… Ø±Ø¨Ø· ${primaryUnitNumber} Ù…Ø¹ ${secondaryUnitNumber} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

        console.log(`ğŸ‰ ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­: ${primaryUnitNumber} Ù…Ø¹ ${secondaryUnitNumber}`);

        return {
            success: true,
            primaryUnit: primaryUnit,
            secondaryUnit: updatedUnit[0],
            message: 'ØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­'
        };

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', error);

        const errorMessage = `âŒ ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª!

ğŸ”— Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: ${primaryUnitNumber}
ğŸ”— Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡Ø§: ${secondaryUnitNumber}

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
â€¢ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Supabase`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª', 'error');

        return {
            success: false,
            error: error.message
        };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.linkRealUnitsInSupabase = linkRealUnitsInSupabase;

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
function showRealUnitLinkingModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-link"></i> Ø±Ø¨Ø· ÙˆØ­Ø¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©</h2>
                <p>Ø±Ø¨Ø· ÙˆØ­Ø¯ØªÙŠÙ† Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„ØªØ¸Ù‡Ø±Ø§ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="primaryUnitNumber">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª):</label>
                    <input type="text" id="primaryUnitNumber" placeholder="Ù…Ø«Ø§Ù„: STDM080101" class="form-control">
                    <small class="form-text">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯</small>
                </div>

                <div class="form-group">
                    <label for="secondaryUnitNumber">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡Ø§:</label>
                    <input type="text" id="secondaryUnitNumber" placeholder="Ù…Ø«Ø§Ù„: STDM080124" class="form-control">
                    <small class="form-text">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙŠ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</small>
                </div>

                <div class="info-box" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4><i class="fas fa-info-circle"></i> ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø±Ø¨Ø·:</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</li>
                        <li>Ø³ØªØ­ØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ…Ø§Ù…Ø§Ù‹</li>
                        <li>Ø³ØªØ¸Ù‡Ø± Ø§Ù„ÙˆØ­Ø¯ØªØ§Ù† ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</li>
                        <li>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Supabase ÙÙˆØ±Ø§Ù‹</li>
                    </ul>
                </div>

                <div class="example-box" style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4><i class="fas fa-lightbulb"></i> Ù…Ø«Ø§Ù„:</h4>
                    <p><strong>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</strong> STDM080101 (Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø´Ø±ÙƒØ© Ø±Ø§Ù…Ø³ÙˆÙ†Ø²)</p>
                    <p><strong>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡Ø§:</strong> STDM080124 (ÙØ§Ø±ØºØ©)</p>
                    <p><strong>Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> ÙƒÙ„Ø§ Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ† Ø³ØªØ¸Ù‡Ø±Ø§Ù† Ù…Ø±Ø¨ÙˆØ·ØªÙŠÙ† Ø¨Ø´Ø±ÙƒØ© Ø±Ø§Ù…Ø³ÙˆÙ†Ø²</p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="executeRealUnitLinking()">
                    <i class="fas fa-link"></i> Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                </button>
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    // ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„
    setTimeout(() => {
        document.getElementById('primaryUnitNumber').focus();
    }, 100);
}

// Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
async function executeRealUnitLinking() {
    const primaryUnitNumber = document.getElementById('primaryUnitNumber').value.trim();
    const secondaryUnitNumber = document.getElementById('secondaryUnitNumber').value.trim();

    if (!primaryUnitNumber || !secondaryUnitNumber) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ†');
        return;
    }

    if (primaryUnitNumber === secondaryUnitNumber) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†ÙØ³Ù‡Ø§');
        return;
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§ØªØŸ

ğŸ”— Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: ${primaryUnitNumber}
ğŸ”— Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡Ø§: ${secondaryUnitNumber}

âš ï¸ Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆØ§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©.
âœ… Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Supabase ÙÙˆØ±Ø§Ù‹.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    const linkButton = document.querySelector('.btn-primary');
    const originalText = linkButton.innerHTML;
    linkButton.disabled = true;
    linkButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø·...';

    try {
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¨Ø·
        const result = await linkRealUnitsInSupabase(primaryUnitNumber, secondaryUnitNumber);

        if (result.success) {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
            closeModal();

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
            if (typeof loadDataFromSupabase === 'function') {
                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase...');
                await loadDataFromSupabase();
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            if (typeof renderProperties === 'function') {
                renderProperties();
            }

        } else {
            throw new Error(result.error || 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø±Ø¨Ø·');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:', error);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${error.message}`);

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        linkButton.disabled = false;
        linkButton.innerHTML = originalText;
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.showRealUnitLinkingModal = showRealUnitLinkingModal;
window.executeRealUnitLinking = executeRealUnitLinking;

// Ø¯Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ØªÙŠÙ†
async function testLinkSTDMUnits() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ† STDM080101 Ùˆ STDM080124...');

    try {
        const result = await linkRealUnitsInSupabase('STDM080101', 'STDM080124');

        if (result.success) {
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ† STDM');
            return result;
        } else {
            throw new Error(result.error);
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ† STDM:', error);
        return { success: false, error: error.message };
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©
async function checkLinkingStatus() {
    console.log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');

    try {
        if (!supabaseClient) {
            throw new Error('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
        }

        // ÙØ­Øµ Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ØªÙŠÙ†
        const { data: units, error } = await supabaseClient
            .from('properties')
            .select('unit_number, property_name, tenant_name, contract_number, rent_value')
            .in('unit_number', ['STDM080101', 'STDM080124'])
            .order('unit_number');

        if (error) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
        }

        if (!units || units.length !== 2) {
            throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯ØªÙŠÙ†');
        }

        const unit1 = units[0];
        const unit2 = units[1];

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·
        const isLinked = unit1.tenant_name === unit2.tenant_name &&
                        unit1.contract_number === unit2.contract_number &&
                        unit1.tenant_name && unit1.contract_number;

        const statusMessage = `ğŸ“Š Ø­Ø§Ù„Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª:

ğŸ  Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: ${unit1.unit_number}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${unit1.tenant_name || 'ÙØ§Ø±Øº'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯: ${unit1.contract_number || 'ÙØ§Ø±Øº'}
ğŸ’° Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${unit1.rent_value ? parseFloat(unit1.rent_value).toLocaleString() + ' Ø±ÙŠØ§Ù„' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

ğŸ  Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ${unit2.unit_number}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${unit2.tenant_name || 'ÙØ§Ø±Øº'}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯: ${unit2.contract_number || 'ÙØ§Ø±Øº'}
ğŸ’° Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${unit2.rent_value ? parseFloat(unit2.rent_value).toLocaleString() + ' Ø±ÙŠØ§Ù„' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

ğŸ”— Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·: ${isLinked ? 'âœ… Ù…Ø±Ø¨ÙˆØ·ØªØ§Ù†' : 'âŒ ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·ØªÙŠÙ†'}

${isLinked ? 'ğŸ‰ Ø§Ù„ÙˆØ­Ø¯ØªØ§Ù† Ù…Ø±Ø¨ÙˆØ·ØªØ§Ù† Ø¨Ù†Ø¬Ø§Ø­ ÙˆÙ„Ù‡Ù…Ø§ Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!' : 'ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø·Ù‡Ù…Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± "Ø±Ø¨Ø· ÙˆØ­Ø¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©" Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'}`;

        alert(statusMessage);
        console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·:', { isLinked, unit1, unit2 });

        return { success: true, isLinked, units: [unit1, unit2] };

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·:', error);
        alert(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·: ${error.message}`);
        return { success: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.testLinkSTDMUnits = testLinkSTDMUnits;
window.checkLinkingStatus = checkLinkingStatus;

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© linkUnitToGroup
async function testImprovedLinkUnitToGroup() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© linkUnitToGroup...');

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        if (!window.allData || !Array.isArray(window.allData)) {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª allData ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        let testUnit = window.allData.find(unit =>
            !unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] || unit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() === ''
        );

        if (!testUnit) {
            // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ù‚ØªØ©
            testUnit = {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': `TEST-IMPROVED-${Date.now()}`,
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­Ø³Ù†',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': '',
                'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 0,
                'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 100,
                'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
            };

            window.allData.push(testUnit);
            console.log('ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ù‚ØªØ©');
        }

        // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª
        const primaryUnit = {
            'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': `PRIMARY-${Date.now()}`,
            'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': testUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
            'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­Ø³Ù†',
            'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': `CONTRACT-IMPROVED-${Date.now()}`,
            'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 3500,
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 150,
            'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '01/01/2024',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '31/12/2024',
            'Ø§Ù„Ù…Ø§Ù„Ùƒ': 'Ù…Ø§Ù„Ùƒ Ø§Ø®ØªØ¨Ø§Ø±',
            'Ø±Ù‚Ù… Ø§Ù„ØµÙƒ': `DEED-${Date.now()}`,
            'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ': `REG-${Date.now()}`
        };

        window.allData.push(primaryUnit);

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        window.currentPrimaryUnit = primaryUnit;
        window.currentEditingUnits = [primaryUnit];

        console.log(`ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']} Ù…Ø¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ${primaryUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}...`);

        // Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase
        if (supabaseClient) {
            console.log('ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const primaryData = {
                unit_number: primaryUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                property_name: primaryUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                city: primaryUnit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'],
                tenant_name: primaryUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'],
                contract_number: primaryUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯'],
                rent_value: primaryUnit['Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± '],
                area: primaryUnit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'],
                contract_type: primaryUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯'],
                owner: primaryUnit['Ø§Ù„Ù…Ø§Ù„Ùƒ'],
                deed_number: primaryUnit['Ø±Ù‚Ù… Ø§Ù„ØµÙƒ'],
                real_estate_registry: primaryUnit['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠÙ†ÙŠ ']
            };

            const { data: createdPrimary, error: primaryError } = await supabaseClient
                .from('properties')
                .insert([primaryData])
                .select();

            if (primaryError) {
                throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: ${primaryError.message}`);
            }

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ§Ø±ØºØ©
            const testData = {
                unit_number: testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                property_name: testUnit['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                city: testUnit['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'],
                tenant_name: '',
                contract_number: '',
                rent_value: 0,
                area: testUnit['Ø§Ù„Ù…Ø³Ø§Ø­Ø©'],
                contract_type: testUnit['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯']
            };

            const { data: createdTest, error: testError } = await supabaseClient
                .from('properties')
                .insert([testData])
                .select();

            if (testError) {
                throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${testError.message}`);
            }

            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© linkUnitToGroup Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        await linkUnitToGroup(testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Supabase
        if (supabaseClient) {
            console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Supabase...');

            const { data: verifyData, error: verifyError } = await supabaseClient
                .from('properties')
                .select('*')
                .eq('unit_number', testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '])
                .single();

            if (verifyError) {
                throw new Error(`ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚: ${verifyError.message}`);
            }

            if (verifyData.tenant_name === primaryUnit['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] &&
                verifyData.contract_number === primaryUnit['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']) {

                const successMessage = `ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©!

âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase
ğŸ”— Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©: ${testUnit['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${verifyData.tenant_name}
ğŸ“„ Ø§Ù„Ø¹Ù‚Ø¯: ${verifyData.contract_number}
ğŸ’° Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${verifyData.rent_value} Ø±ÙŠØ§Ù„

ğŸ¯ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!`;

                alert(successMessage);
                showToast('ğŸ‰ Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©!', 'success');
                console.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© linkUnitToGroup');

                return { success: true, verifyData };
            } else {
                throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Ù„Ø§ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©');
            }
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©:', error);

        const errorMessage = `âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©!

Ø§Ù„Ø®Ø·Ø£: ${error.message}

ğŸ’¡ ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ Ø§ØªØµØ§Ù„ Supabase
â€¢ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`;

        alert(errorMessage);
        showToast('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©', 'error');

        return { success: false, error: error.message };
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.testImprovedLinkUnitToGroup = testImprovedLinkUnitToGroup;

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
window.fullDataRecovery = fullDataRecovery;
window.recoverDeletedData = recoverDeletedData;
window.testEnhancedUnitLinking = testEnhancedUnitLinking;
window.testPropertyNameEdit = testPropertyNameEdit;
window.testPropertyNameUpdateWithoutDuplication = testPropertyNameUpdateWithoutDuplication;
window.testFilterResetOnLogin = testFilterResetOnLogin;
window.resetFiltersToDefault = resetFiltersToDefault;
window.quickUnitLinkingTest = quickUnitLinkingTest;
window.fixUnitLinkingIssues = fixUnitLinkingIssues;

// ØªÙ… Ø­Ø°Ù Ù…Ø³ØªÙ…Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ£Ø®Ø± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ±
// Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªØ¸Ù‡Ø± Ø§Ù„Ø¢Ù† ÙÙˆØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ



// Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.testMobilePropertyNameDisplay = function() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
    console.log('currentProperty:', currentProperty);
    console.log('currentCountry:', currentCountry);
    console.log('Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©:', window.innerWidth);
    updateMobilePropertyName();
};

// Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
window.forceShowPropertyName = function() {
    console.log('ğŸ”§ Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');

    const propertyHeaderContainer = document.getElementById('mobilePropertyHeader');
    const propertyTextElement = document.getElementById('mobilePropertyText');

    if (propertyHeaderContainer && propertyTextElement) {
        propertyTextElement.textContent = 'Ø§Ù„Ø±ÙŠØ§Ø¶ - Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ù†Ø®ÙŠÙ„ (Ø§Ø®ØªØ¨Ø§Ø±)';
        propertyHeaderContainer.style.display = 'flex';
        propertyHeaderContainer.style.visibility = 'visible';
        propertyHeaderContainer.style.opacity = '1';
        console.log('âœ… ØªÙ… Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
    } else {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');
    }
};

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù…
window.testPermanentTotal = function() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù…');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    const testProperty = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '');

    if (testProperty) {
        console.log('ğŸ  Ø¹Ù‚Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '], testProperty['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±']);
        console.log('ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ:', testProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']);

        // ØªØ¬Ø±Ø¨Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¬Ø¯ÙŠØ¯
        const originalTotal = testProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'];
        testProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = 99999;

        console.log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ¬Ø±ÙŠØ¨ÙŠ: 99999');
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

        renderData();
        updateTotalStats();

        // Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
        console.log('ğŸ“ Ø§Ù„Ø¢Ù† Ø¬Ø±Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± - Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ù‚Ù‰ 99999');
        console.log(`ğŸ“ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ„ÙŠ ÙƒØ§Ù†: ${originalTotal}`);
        console.log('âœ… ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ù‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ 99999 ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† reload!');
    } else {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
    }
};

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ
window.testInstantUpdate = function() {
    console.log('âš¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ');

    const testProperty = properties.find(p => p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && p['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== '');

    if (testProperty) {
        console.log('ğŸ  Ø¹Ù‚Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', testProperty['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']);
        console.log('ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªØºÙŠÙŠØ±:', testProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰']);

        // ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        const newTotal = Math.floor(Math.random() * 100000) + 50000;
        testProperty['Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰'] = newTotal;

        console.log(`ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newTotal}`);

        // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
        renderData();
        updateTotalStats();

        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙˆØ±Ø§Ù‹! ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
    } else {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù‚Ø§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
    }
};

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ø£Ø²Ø±Ø§Ø±
function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    const button = event.currentTarget;
    button.classList.add('drag-over');
}

function handleDragEnter(event) {
    event.preventDefault();
    event.stopPropagation();
    const button = event.currentTarget;
    button.classList.add('drag-over');
}

function handleDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    const button = event.currentTarget;
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¤Ø´Ø± Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø²Ø± ÙØ¹Ù„Ø§Ù‹ ÙˆÙ„ÙŠØ³ Ù…Ù† Ø¹Ù†ØµØ± ÙØ±Ø¹ÙŠ
    if (!button.contains(event.relatedTarget)) {
        button.classList.remove('drag-over');
    }
}

function handleDrop(event, inputId) {
    event.preventDefault();
    event.stopPropagation();

    const button = event.currentTarget;
    button.classList.remove('drag-over');

    const files = event.dataTransfer.files;
    if (files.length > 0) {
        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
        const fileInput = document.getElementById(inputId);
        if (fileInput) {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
            fileInput.files = files;

            // ØªØ´ØºÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„ØªØºÙŠÙŠØ± Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
            const changeEvent = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(changeEvent);

            console.log(`âœ… ØªÙ… Ø¥Ø³Ù‚Ø§Ø· ${files.length} Ù…Ù„Ù Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±ÙØ§Ù‚`);
        } else {
            console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„: ${inputId}`);
        }
    }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ø¬ÙˆØ§Ù„
function toggleMobileCities() {
    console.log('ğŸ™ï¸ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù† Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±');

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    clearAllNavActive();

    // ØªÙØ¹ÙŠÙ„ Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¯Ù†
    const navCities = document.getElementById('navCities');
    navCities.classList.add('active');

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù† Ù…Ø¨Ø§Ø´Ø±Ø© (Ù†ÙØ³ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
    if (typeof showCountrySelection === 'function') {
        showCountrySelection();
        console.log('âœ… ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù†');
    } else {
        console.error('âŒ ÙˆØ¸ÙŠÙØ© showCountrySelection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
    }
}

function toggleMobileProperties() {
    console.log('ğŸ¢ ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±');

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    clearAllNavActive();

    // ØªÙØ¹ÙŠÙ„ Ø¹Ù†ØµØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const navProperties = document.getElementById('navProperties');
    navProperties.classList.add('active');

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø©
    showMobilePropertiesModal();
}

function toggleMobileAttachments() {
    console.log('ğŸ“ ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±');

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    clearAllNavActive();

    // ØªÙØ¹ÙŠÙ„ Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    const navAttachments = document.getElementById('navAttachments');
    navAttachments.classList.add('active');

    // ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (Ù†ÙØ³ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
    if (typeof showAttachmentsManagerFromDropdown === 'function') {
        showAttachmentsManagerFromDropdown();
        console.log('âœ… ØªÙ… ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª');
    } else {
        console.error('âŒ ÙˆØ¸ÙŠÙØ© showAttachmentsManagerFromDropdown ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
    }
}

function scrollToTop() {
    console.log('â¬†ï¸ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±');

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    clearAllNavActive();

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹
    const navMain = document.getElementById('navMain');
    navMain.classList.add('active');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…
    const globalSearch = document.getElementById('globalSearch');
    const searchSection = document.getElementById('searchSection');

    if (globalSearch) {
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ù„Ø³ Ø¥Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
        globalSearch.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
            inline: 'nearest'
        });

        // ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        setTimeout(() => {
            globalSearch.focus();
            console.log('âœ… ØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙˆØªØ±ÙƒÙŠØ² Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«');
        }, 500);

    } else if (searchSection) {
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
        searchSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
        console.log('âœ… ØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø«');

    } else {
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        console.log('âœ… ØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©');
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
    setTimeout(() => {
        navMain.classList.remove('active');
    }, 1000);
}

function toggleMobileStatistics() {
    console.log('ğŸ“Š ÙØªØ­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±');

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    clearAllNavActive();

    // ØªÙØ¹ÙŠÙ„ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    const navStatistics = document.getElementById('navStatistics');
    navStatistics.classList.add('active');

    // ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø©
    showMobileStatistics();
}

function showMobileStatistics() {
    console.log('ğŸ“Š Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø©...');

    const statisticsMenu = document.getElementById('mobileStatisticsMenu');
    if (!statisticsMenu) {
        console.error('âŒ Ø¹Ù†ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    statisticsMenu.classList.add('active');
    document.body.style.overflow = 'hidden';

    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    updateStatisticsDisplay();

    console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
}

function closeMobileStatistics() {
    console.log('ğŸ“Š Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');

    const statisticsMenu = document.getElementById('mobileStatisticsMenu');
    if (statisticsMenu) {
        statisticsMenu.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±
    clearAllNavActive();

    console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
}

function updateStatisticsDisplay() {
    console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');

    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    updateStatisticsPropertyHeader();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    updateStatisticsTotals();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateStatisticsActiveFilters();
}

function updateStatisticsPropertyHeader() {
    const propertyHeader = document.getElementById('statisticsPropertyHeader');
    const propertyText = document.getElementById('statisticsPropertyText');

    if (!propertyHeader || !propertyText) return;

    if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
        propertyHeader.style.display = 'flex';
        propertyText.textContent = currentProperty;
    } else {
        propertyHeader.style.display = 'none';
    }
}

function updateStatisticsTotals() {
    const statisticsTotals = document.getElementById('statisticsTotals');
    if (!statisticsTotals) return;

    // Ù†Ø³Ø® Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ØµÙ„ÙŠ
    const originalTotals = document.getElementById('mobileTotals');
    if (originalTotals && originalTotals.innerHTML.trim() !== '') {
        // Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù†Ù…Ø§Ø·
        statisticsTotals.innerHTML = originalTotals.innerHTML;

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØµØ­ÙŠØ­Ø©
        statisticsTotals.className = 'statistics-totals';

        // Ù†Ø³Ø® Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ±Ø¹ÙŠØ©
        const originalItems = originalTotals.querySelectorAll('.total-item');
        const statisticsItems = statisticsTotals.querySelectorAll('.total-item');

        originalItems.forEach((originalItem, index) => {
            if (statisticsItems[index]) {
                // Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª
                statisticsItems[index].className = originalItem.className;
            }
        });

        console.log('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø·');
    } else {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (typeof renderMobileTotals === 'function' && properties) {
            console.log('ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');
            renderMobileTotals(properties);

            // Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
            setTimeout(() => {
                const updatedTotals = document.getElementById('mobileTotals');
                if (updatedTotals && updatedTotals.innerHTML.trim() !== '') {
                    statisticsTotals.innerHTML = updatedTotals.innerHTML;
                    statisticsTotals.className = 'statistics-totals';

                    // Ù†Ø³Ø® Ø§Ù„Ø£Ù†Ù…Ø§Ø·
                    const originalItems = updatedTotals.querySelectorAll('.total-item');
                    const statisticsItems = statisticsTotals.querySelectorAll('.total-item');

                    originalItems.forEach((originalItem, index) => {
                        if (statisticsItems[index]) {
                            statisticsItems[index].className = originalItem.className;
                        }
                    });

                    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ†Ø³Ø® Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
                } else {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ ÙƒÙ„ Ø´ÙŠØ¡
                    createBasicStatistics(statisticsTotals);
                }
            }, 200);
        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø³Ø§Ø³ÙŠØ©
            createBasicStatistics(statisticsTotals);
        }
    }
}

function createBasicStatistics(container) {
    console.log('ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø³Ø§Ø³ÙŠØ©...');

    if (!properties || !Array.isArray(properties)) {
        container.innerHTML = `
            <div class="total-item units-stat">
                <div class="total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</div>
                <div class="total-value">0</div>
            </div>
            <div class="total-item empty-stat">
                <div class="total-label">ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ©</div>
                <div class="total-value">0</div>
            </div>
        `;
        return;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    let filteredData = properties;

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„') {
        filteredData = filteredData.filter(item => item.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === currentCountry);
    }

    if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
        filteredData = filteredData.filter(item => item['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'] === currentProperty);
    }

    const totalUnits = filteredData.length;
    const occupiedUnits = filteredData.filter(item =>
        item['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'] && item['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'].trim() !== ''
    ).length;
    const emptyUnits = totalUnits - occupiedUnits;

    const totalRent = filteredData.reduce((sum, item) => {
        const rent = parseFloat(item['Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±']) || 0;
        return sum + rent;
    }, 0);

    container.innerHTML = `
        <div class="total-item units-stat">
            <div class="total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</div>
            <div class="total-value">${totalUnits}</div>
        </div>
        <div class="total-item active-stat">
            <div class="total-label">ÙˆØ­Ø¯Ø§Øª Ù…Ø¤Ø¬Ø±Ø©</div>
            <div class="total-value">${occupiedUnits}</div>
        </div>
        <div class="total-item empty-stat">
            <div class="total-label">ÙˆØ­Ø¯Ø§Øª ÙØ§Ø±ØºØ©</div>
            <div class="total-value">${emptyUnits}</div>
        </div>
        <div class="total-item taxable-base-stat">
            <div class="total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª</div>
            <div class="total-value">${totalRent.toLocaleString()} Ø±ÙŠØ§Ù„</div>
        </div>
    `;

    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©');
}

// ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù† Ø¢Ø®Ø± - Ø§Ø³ØªØ®Ø¯Ù… updateStatisticsActiveFilters Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

function clearAllNavActive() {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±
    const navItems = document.querySelectorAll('.mobile-bottom-nav .nav-item');
    navItems.forEach(item => {
        item.classList.remove('active');
    });
}

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø© Ù„Ù„Ù†Ø§Ù Ø¨Ø§Ø±
function showMobilePropertiesModal() {
    console.log('ğŸ¢ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø©...');

    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
    closeModal();

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    let filteredProperties = properties;
    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„') {
        filteredProperties = properties.filter(property => property.Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© === currentCountry);
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
    const propertyNames = [...new Set(filteredProperties.map(p => p['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±']).filter(name => name && name.trim() !== ''))];

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
    if (typeof propertyDefinitions !== 'undefined' && propertyDefinitions) {
        Object.keys(propertyDefinitions).forEach(cityName => {
            if (!currentCountry || currentCountry === 'Ø§Ù„ÙƒÙ„' || cityName === currentCountry) {
                if (propertyDefinitions[cityName] && Array.isArray(propertyDefinitions[cityName])) {
                    propertyDefinitions[cityName].forEach(propName => {
                        if (propName && propName.trim() !== '' && !propertyNames.includes(propName)) {
                            propertyNames.push(propName);
                        }
                    });
                }
            }
        });
    }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    propertyNames.sort();

    // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹ (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
    let displayedPropertyNames = propertyNames;
    if (currentPropertyTypeFilter) {
        displayedPropertyNames = filterPropertiesByTypeLogic(propertyNames, currentPropertyTypeFilter, currentCountry);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ù†Ø§ÙØ°Ø©
    const cityText = currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„' ? currentCountry : 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†';
    const filterText = currentPropertyTypeFilter === 'buildings' ? ' - Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' :
                      currentPropertyTypeFilter === 'lands' ? ' - Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ' : '';

    // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
    const screenHeight = window.innerHeight;
    const screenWidth = window.innerWidth;
    const isVerySmallScreen = screenHeight <= 700 && screenWidth <= 500;
    const isExtraSmallScreen = screenHeight <= 600 && screenWidth <= 500;

    let modalOverlayStyle = "display: flex; z-index: 10000;";
    let modalBoxStyle = "max-width: 500px; position: relative;";
    let propertiesListStyle = "max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;";

    if (isExtraSmallScreen) {
        modalOverlayStyle += " padding: 5px; align-items: flex-start; padding-top: 10px;";
        modalBoxStyle += " max-height: calc(100vh - 20px); min-height: calc(100vh - 20px); margin: 0; display: flex; flex-direction: column; border-radius: 8px;";
        propertiesListStyle = "flex: 1; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; min-height: 250px;";
    } else if (isVerySmallScreen) {
        modalOverlayStyle += " padding: 10px; align-items: flex-start; padding-top: 20px;";
        modalBoxStyle += " max-height: calc(100vh - 40px); min-height: calc(100vh - 40px); margin: 0; display: flex; flex-direction: column;";
        propertiesListStyle = "flex: 1; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; min-height: 300px;";
    } else {
        modalBoxStyle += " max-height: 80vh;";
    }

    let html = `
        <div class="modal-overlay" style="${modalOverlayStyle}">
            <div class="modal-box properties-modal" style="${modalBoxStyle}">

                <!-- Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¬ÙˆØ§Ù„ -->
                <button onclick="closePropertiesModalDirect();" class="mobile-close-btn"
                        style="position: absolute; top: 15px; left: 15px; background: rgba(108, 117, 125, 0.1);
                               border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
                               transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;
                               z-index: 1000; color: #6c757d; font-size: 1.3rem; touch-action: manipulation;
                               box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                        onmouseover="this.style.background='rgba(108, 117, 125, 0.2)'; this.style.transform='scale(1.1)';"
                        onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'; this.style.transform='scale(1)';"
                        ontouchstart="this.style.background='rgba(108, 117, 125, 0.3)';"
                        ontouchend="this.style.background='rgba(108, 117, 125, 0.1)';">
                    <i class="fas fa-times"></i>
                </button>

                <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-left: 50px;">
                    <i class="fas fa-building" style="color: #007bff;"></i>
                    Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª - ${cityText}${filterText}
                    <span class="badge" style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${displayedPropertyNames.length}</span>
                </h3>

                <!-- Ù‚Ø³Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© -->
                <div id="propertiesActiveFilters" class="properties-active-filters" style="display: none; background: #f8f9fa; margin: 0 0 15px 0; border-radius: 10px; padding: 15px; border: 1px solid #e9ecef;">
                    <div class="properties-filters-title" style="font-weight: 600; color: #495057; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-filter" style="color: #ffc107;"></i>
                        Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©:
                    </div>
                    <div class="properties-filters-list" id="propertiesFiltersList" style="margin-bottom: 15px;"></div>
                    <button class="clear-all-filters-btn" onclick="clearAllFiltersWithLoading(this); setTimeout(() => refreshPropertiesModal(), 1000);" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; position: relative; overflow: hidden;">
                        <i class="fas fa-times-circle"></i>
                        <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
                    </button>
                </div>

                <!-- ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± -->
                <div class="mobile-property-type-filters" style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <button class="mobile-property-filter-btn buildings-filter" onclick="filterMobilePropertiesByType('buildings')"
                            style="flex: 1; padding: 10px 12px; border: 2px solid #007bff;
                                   background: ${currentPropertyTypeFilter === 'buildings' ? '#007bff' : 'white'};
                                   color: ${currentPropertyTypeFilter === 'buildings' ? 'white' : '#007bff'};
                                   border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
                                   transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i class="fas fa-building"></i> Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
                    </button>
                    <button class="mobile-property-filter-btn lands-filter" onclick="filterMobilePropertiesByType('lands')"
                            style="flex: 1; padding: 10px 12px; border: 2px solid #28a745;
                                   background: ${currentPropertyTypeFilter === 'lands' ? '#28a745' : 'white'};
                                   color: ${currentPropertyTypeFilter === 'lands' ? 'white' : '#28a745'};
                                   border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
                                   transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i class="fas fa-mountain"></i> Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ
                    </button>
                </div>

                <div class="property-search-container" style="margin-bottom: 15px;">
                    <input type="text" id="mobilePropertiesSearch" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª..."
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                </div>

                <div id="mobilePropertiesList" style="${propertiesListStyle}">
    `;

    if (displayedPropertyNames.length === 0) {
        const filterText = currentPropertyTypeFilter === 'buildings' ? 'Ù…Ø¨Ø§Ù†ÙŠ' :
                          currentPropertyTypeFilter === 'lands' ? 'Ø£Ø±Ø§Ø¶ÙŠ' : 'Ø¹Ù‚Ø§Ø±Ø§Øª';
        html += `
            <div style="text-align: center; padding: 40px; color: #6c757d;">
                <i class="fas fa-building" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ${filterText} Ù…ØªØ§Ø­Ø©</p>
            </div>
        `;
    } else {
        displayedPropertyNames.forEach(propertyName => {
            const isActive = currentProperty === propertyName;
            const activeClass = isActive ? 'active' : '';
            const activeStyle = isActive ? 'background: #007bff; color: white;' : '';

            html += `
                <div class="mobile-property-item ${activeClass}" data-property="${propertyName}"
                     onclick="selectPropertyFromModal('${propertyName}')"
                     style="padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer;
                            transition: all 0.3s ease; border: 1px solid #e9ecef; ${activeStyle}
                            display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-weight: 500;">${propertyName}</span>
                    ${isActive ? '<i class="fas fa-check" style="color: white;"></i>' : '<i class="fas fa-building" style="color: #007bff;"></i>'}
                </div>
            `;
        });
    }

    html += `
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);

    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø«
    const searchInput = document.getElementById('mobilePropertiesSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const propertyItems = document.querySelectorAll('.mobile-property-item');

            propertyItems.forEach(item => {
                const propertyName = item.dataset.property.toLowerCase();
                if (propertyName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©
    setTimeout(() => {
        const modalOverlay = document.querySelector('.modal-overlay:last-child');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø© - Ø¥ØºÙ„Ø§Ù‚');
                    closePropertiesModalDirect();
                }
            });
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©');
        }
    }, 50);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    updatePropertiesActiveFilters();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    setTimeout(() => {
        const closeButton = document.querySelector('#propertiesCloseBtn');
        if (closeButton) {
            console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¹ onclick');
        } else {
            console.warn('âš ï¸ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        }
    }, 100);

    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø©');
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
function cleanOldNumberingFromMenu() {
    console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©...');

    const menuList = document.querySelector('.mobile-dropdown-list');
    if (!menuList) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
        return;
    }

    const allButtons = menuList.querySelectorAll('li > button');
    let cleanedCount = 0;

    allButtons.forEach(button => {
        // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø¨Ù€ JavaScript
        const existingNumbers = button.querySelectorAll('.menu-number');
        existingNumbers.forEach(num => {
            num.remove();
            cleanedCount++;
        });

        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Øµ
        const textNodes = Array.from(button.childNodes).filter(node => node.nodeType === Node.TEXT_NODE);
        textNodes.forEach(textNode => {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Øµ
            const cleanedText = textNode.textContent.replace(/^\s*\d+\.\s*/, '').trim();
            if (cleanedText !== textNode.textContent.trim()) {
                textNode.textContent = cleanedText;
                cleanedCount++;
            }
        });

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
        button.innerHTML = button.innerHTML.replace(/^\s+|\s+$/g, '').replace(/\s+/g, ' ');
    });

    console.log(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ ${cleanedCount} Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©`);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ù‚Ø§Ù… ØªØ³Ù„Ø³Ù„ÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
function addNumbersToVisibleMenuItems() {
    console.log('ğŸ”¢ Ø¨Ø¯Ø¡ ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©...');

    // Ø£ÙˆÙ„Ø§Ù‹ ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ ØªØ±Ù‚ÙŠÙ… Ù‚Ø¯ÙŠÙ…
    cleanOldNumberingFromMenu();

    const menuList = document.querySelector('.mobile-dropdown-list');
    if (!menuList) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø·
    const visibleItems = [];
    const allItems = menuList.querySelectorAll('li');

    allItems.forEach(item => {
        const button = item.querySelector('button');
        if (!button) return;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø¸Ø§Ù‡Ø±
        const isHidden = item.style.display === 'none' ||
                        getComputedStyle(item).display === 'none' ||
                        button.style.display === 'none' ||
                        getComputedStyle(button).display === 'none';

        if (!isHidden) {
            visibleItems.push({ item, button });
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©
    visibleItems.forEach((itemData, index) => {
        const { button } = itemData;
        const number = index + 1;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ù‚Ù…
        const numberElement = document.createElement('span');
        numberElement.className = 'menu-number';
        numberElement.textContent = number + '. ';
        numberElement.style.cssText = `
            color: #007bff;
            font-weight: bold;
            font-size: 1.1em;
            margin-left: 8px;
            background: rgba(0, 123, 255, 0.1);
            padding: 2px 6px;
            border-radius: 50%;
            min-width: 24px;
            text-align: center;
            display: inline-block;
        `;

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Øµ
        button.insertBefore(numberElement, button.firstChild);
    });

    console.log(`âœ… ØªÙ… ØªØ±Ù‚ÙŠÙ… ${visibleItems.length} Ø²Ø± Ø¸Ø§Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©`);
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ§Ø±ØºØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
function removeEmptyMenuButtons() {
    console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ§Ø±ØºØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©...');

    const menuList = document.querySelector('.mobile-dropdown-list');
    if (!menuList) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
        return;
    }

    const allItems = Array.from(menuList.querySelectorAll('li'));
    let removedCount = 0;

    allItems.forEach((item, index) => {
        const button = item.querySelector('button');

        // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ
        const isHidden = item.style.display === 'none' ||
                        getComputedStyle(item).display === 'none';

        if (isHidden) {
            console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ: ${index + 1}`);
            item.remove();
            removedCount++;
            return;
        }

        if (!button) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø²Ø±ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±
            console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø²Ø±: ${index + 1}`);
            item.remove();
            removedCount++;
            return;
        }

        // ÙØ­Øµ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø²Ø±
        const buttonText = button.textContent.trim();
        const buttonIcons = button.querySelectorAll('i, svg, img');

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        const cleanText = buttonText.replace(/^\d+\.\s*/, '').replace(/^\s*$/, '').trim();

        // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± ÙØ§Ø±Øº Ø£Ùˆ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù…ÙÙŠØ¯
        if (cleanText.length === 0 && buttonIcons.length === 0) {
            console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø²Ø± ÙØ§Ø±Øº: "${buttonText}" ÙÙŠ Ø§Ù„Ù…ÙˆØ¶Ø¹ ${index + 1}`);
            item.remove();
            removedCount++;
        } else if (buttonText.match(/^\s*\d+\s*\.?\s*$/) && buttonIcons.length === 0) {
            console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø²Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·: "${buttonText}" ÙÙŠ Ø§Ù„Ù…ÙˆØ¶Ø¹ ${index + 1}`);
            item.remove();
            removedCount++;
        } else if (buttonText.trim() === '' && buttonIcons.length === 0) {
            console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø²Ø± ÙØ§Ø±Øº ØªÙ…Ø§Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙˆØ¶Ø¹ ${index + 1}`);
            item.remove();
            removedCount++;
        }
    });

    console.log(`âœ… ØªÙ… Ø­Ø°Ù ${removedCount} Ø²Ø± ÙØ§Ø±Øº Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©`);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
function removeNumberingFromMenu() {
    console.log('ğŸ”¢ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©...');

    const menuList = document.querySelector('.mobile-dropdown-list');
    if (!menuList) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
        return;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ù†ÙˆØ¹ olØŒ Ø­ÙˆÙ„Ù‡Ø§ Ø¥Ù„Ù‰ ul Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠÙ…
    if (menuList.tagName.toLowerCase() === 'ol') {
        const newUl = document.createElement('ul');
        newUl.className = menuList.className;
        newUl.id = menuList.id;

        // Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† ol Ø¥Ù„Ù‰ ul
        while (menuList.firstChild) {
            newUl.appendChild(menuList.firstChild);
        }

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ol Ø¨Ù€ ul
        menuList.parentNode.replaceChild(newUl, menuList);
        console.log('âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† ol Ø¥Ù„Ù‰ ul Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠÙ…');
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ CSS ÙŠØ¶ÙŠÙ ØªØ±Ù‚ÙŠÙ…
    const style = document.createElement('style');
    style.textContent = `
        .mobile-dropdown-list {
            list-style: none !important;
            counter-reset: none !important;
        }
        .mobile-dropdown-list li {
            counter-increment: none !important;
        }
        .mobile-dropdown-list li::before {
            display: none !important;
            content: none !important;
        }
        .mobile-dropdown-list li::marker {
            display: none !important;
        }
    `;
    document.head.appendChild(style);

    console.log('âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©');
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© ØªØ±Ù‚ÙŠÙ… Ø¬Ø¯ÙŠØ¯
function cleanMenuOnly() {
    console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© Ù…Ù† Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...');

    // Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    removeNumberingFromMenu();

    // Ø«Ø§Ù†ÙŠØ§Ù‹ Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ§Ø±ØºØ©
    removeEmptyMenuButtons();

    // Ø«Ø§Ù„Ø«Ø§Ù‹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ù† Ø§Ù„Ù†ØµÙˆØµ
    cleanOldNumberingFromMenu();

    console.log('âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø¯Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function closePropertiesModal() {
    console.log('ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    const propertiesModal = document.querySelector('.modal-overlay .properties-modal');
    const modalOverlay = document.querySelector('.modal-overlay');

    if (propertiesModal && modalOverlay) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø©
        modalOverlay.remove();
        console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±
        clearAllNavActive();
        console.log('âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±');

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
        document.body.style.height = '';
        document.documentElement.style.overflow = '';

        return true;
    } else {
        console.warn('âš ï¸ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        return false;
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚ (ØªØ³ØªØ¯Ø¹Ù‰ Ù…Ù† onclick)
function closePropertiesModalDirect() {
    console.log('ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ - Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¨Ø§Ø´Ø±');

    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
        const modalOverlay = document.querySelector('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.remove();
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø§ÙØ°Ø©');
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±
        if (typeof clearAllNavActive === 'function') {
            clearAllNavActive();
            console.log('âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±');
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
        document.body.style.height = '';
        document.documentElement.style.overflow = '';

        console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ù†Ø¬Ø§Ø­');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©:', error);

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©
        const allModals = document.querySelectorAll('.modal-overlay');
        allModals.forEach(modal => modal.remove());
        clearAllNavActive();
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†ÙØµÙ„Ø©
function selectPropertyFromModal(propertyName) {
    console.log('ğŸ¢ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±:', propertyName);

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±
    if (typeof selectProperty === 'function') {
        selectProperty(propertyName);
    } else {
        // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
        currentProperty = propertyName === 'Ø§Ù„ÙƒÙ„' ? null : propertyName;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        if (typeof renderData === 'function') {
            renderData();
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        if (typeof updatePropertyButtonsState === 'function') {
            updatePropertyButtonsState();
        }
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    closeModal();
    clearAllNavActive();

    console.log('âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©');
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
function updatePropertiesActiveFilters() {
    const activeFiltersContainer = document.getElementById('propertiesActiveFilters');
    const filtersList = document.getElementById('propertiesFiltersList');

    if (!activeFiltersContainer || !filtersList) return;

    // Ø¬Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    const activeFilters = [];

    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry}`);
    }

    if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ø¹Ù‚Ø§Ø±: ${currentProperty}`);
    }

    if (currentStatus && currentStatus !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ø­Ø§Ù„Ø©: ${currentStatus}`);
    }

    if (currentOwnerFilter && currentOwnerFilter !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ù…Ø§Ù„Ùƒ: ${currentOwnerFilter}`);
    }

    // Ø¥Ø¶Ø§ÙØ© ÙÙ„Ø§ØªØ± Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (typeof window.currentDateFilter !== 'undefined' && window.currentDateFilter && window.currentDateFilter !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${window.currentDateFilter}`);
    }

    if (typeof window.currentRentFilter !== 'undefined' && window.currentRentFilter && window.currentRentFilter !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${window.currentRentFilter}`);
    }

    if (activeFilters.length > 0) {
        activeFiltersContainer.style.display = 'block';
        filtersList.innerHTML = activeFilters.map(filter =>
            `<span class="filter-tag" style="display: inline-block; background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin: 2px;">${filter}</span>`
        ).join('');

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
        let clearButton = activeFiltersContainer.querySelector('.clear-all-filters-btn');
        if (clearButton) {
            clearButton.style.display = 'flex';
        }

        console.log(`ğŸ¢ Ø¹Ø±Ø¶ ${activeFilters.length} ÙÙ„ØªØ± Ù†Ø´Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª`);
    } else {
        activeFiltersContainer.style.display = 'none';
        console.log('ğŸ¢ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙ„Ø§ØªØ± Ù†Ø´Ø·Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
    }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
function refreshPropertiesModal() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const propertiesModal = document.querySelector('.properties-modal');
    if (!propertiesModal) {
        console.log('â„¹ï¸ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ØºÙŠØ± Ù…ÙØªÙˆØ­Ø©');
        return;
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    closeModal();

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±
    setTimeout(() => {
        showMobilePropertiesModal();
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª');
    }, 100);
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)
function toggleMobileMainMenu() {
    console.log('â˜° ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±');

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    clearAllNavActive();

    // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    if (mobileMenuBtn) {
        mobileMenuBtn.click();

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        setTimeout(() => {
            hideMobileTotalsInMenu();
        }, 100);
    }
}

function hideMobileTotalsInMenu() {
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­Ù‡Ø§ Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±
    const mobileTotals = document.querySelector('#mobileMenu #mobileTotals');
    const mobilePropertyHeader = document.querySelector('#mobileMenu #mobilePropertyHeader');

    if (mobileTotals) {
        mobileTotals.style.display = 'none';
    }

    if (mobilePropertyHeader) {
        mobilePropertyHeader.style.display = 'none';
    }

    console.log('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
}

function showMobileTotalsInMenu() {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­Ù‡Ø§ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    const mobileTotals = document.querySelector('#mobileMenu #mobileTotals');
    const mobilePropertyHeader = document.querySelector('#mobileMenu #mobilePropertyHeader');

    if (mobileTotals) {
        mobileTotals.style.display = 'block';
    }

    if (mobilePropertyHeader && currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
        mobilePropertyHeader.style.display = 'flex';
    }

    console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ
function testClearAllFilters(button) {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ...');
    console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentUser);

    if (currentUser === '1234') {
        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ - ØªÙ†ÙÙŠØ° Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±');

        // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ù…Ø¤Ù‚ØªØ§Ù‹
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...';
        button.disabled = true;

        // ØªÙ†ÙÙŠØ° Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
        setTimeout(() => {
            try {
                clearAllFilters();
                console.log('âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ù†Ø¬Ø§Ø­');

                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 1000);

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±:', error);
                button.innerHTML = originalText;
                button.disabled = false;
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±: ' + error.message);
            }
        }, 500);

    } else {
        console.log('âŒ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø®ÙˆÙ„');
        alert('Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ù†ÙŠØ¯ÙŠ ÙÙ‚Ø·');
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ø¹ ØªØ£Ø«ÙŠØ± loading Ù…Ø­Ø³Ù†
function clearAllFiltersWithLoading(button) {
    console.log('ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ø¹ loading Ù…Ø­Ø³Ù†...');

    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± loading Ù„Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
    showClearFiltersLoading(true);

    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± loading Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    if (button) {
        button.classList.add('loading');
        button.style.transform = 'scale(0.95)';
        button.style.transition = 'all 0.3s ease';
    }

    // ØªÙ†ÙÙŠØ° Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù„Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ
    setTimeout(() => {
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ loading Ø¨Ø§Ù„ÙØ¹Ù„)
        clearAllFilters();

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateStatisticsDisplay();

        // Ø¥Ø²Ø§Ù„Ø© ØªØ£Ø«ÙŠØ± loading Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
        setTimeout(() => {
            if (button) {
                button.classList.remove('loading');
                button.style.transform = 'scale(1)';
                button.style.transition = 'all 0.3s ease';
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            showMiniIconNotification('ğŸ—‘ï¸', '#28a745', 2000);

            console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ù†Ø¬Ø§Ø­');
        }, 800);

    }, 300);
}

// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updateStatisticsActiveFilters() {
    const activeFiltersContainer = document.getElementById('statisticsActiveFilters');
    const filtersList = document.getElementById('statisticsFiltersList');

    if (!activeFiltersContainer || !filtersList) return;

    // Ø¬Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    const activeFilters = [];

    if (currentCountry && currentCountry !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${currentCountry}`);
    }

    if (currentProperty && currentProperty !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ø¹Ù‚Ø§Ø±: ${currentProperty}`);
    }

    if (currentStatus && currentStatus !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ø­Ø§Ù„Ø©: ${currentStatus}`);
    }

    if (currentOwnerFilter && currentOwnerFilter !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ù…Ø§Ù„Ùƒ: ${currentOwnerFilter}`);
    }

    // Ø¥Ø¶Ø§ÙØ© ÙÙ„Ø§ØªØ± Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (typeof window.currentDateFilter !== 'undefined' && window.currentDateFilter && window.currentDateFilter !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${window.currentDateFilter}`);
    }

    if (typeof window.currentRentFilter !== 'undefined' && window.currentRentFilter && window.currentRentFilter !== 'Ø§Ù„ÙƒÙ„') {
        activeFilters.push(`Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: ${window.currentRentFilter}`);
    }

    if (activeFilters.length > 0) {
        activeFiltersContainer.style.display = 'block';
        filtersList.innerHTML = activeFilters.map(filter =>
            `<span class="filter-tag">${filter}</span>`
        ).join('');

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± (Ù…Ø´ØªØ±Ùƒ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
        let clearButton = activeFiltersContainer.querySelector('.clear-all-filters-btn');
        if (!clearButton) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            clearButton = document.createElement('button');
            clearButton.className = 'clear-all-filters-btn';
            clearButton.onclick = function() { clearAllFiltersWithLoading(this); };
            clearButton.innerHTML = `
                <i class="fas fa-times-circle"></i>
                <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
            `;
            activeFiltersContainer.appendChild(clearButton);
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
        }
        clearButton.style.display = 'flex';

        console.log(`ğŸ“Š Ø¹Ø±Ø¶ ${activeFilters.length} ÙÙ„ØªØ± Ù†Ø´Ø· ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª`);
    } else {
        activeFiltersContainer.style.display = 'none';
        console.log('ğŸ“Š Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙ„Ø§ØªØ± Ù†Ø´Ø·Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ°
document.addEventListener('click', function(event) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ°
    if (event.target.classList.contains('modal-overlay') ||
        event.target.classList.contains('close') ||
        event.target.closest('.close') ||
        event.target.classList.contains('mobile-statistics-overlay')) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø± Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±
        setTimeout(clearAllNavActive, 300);
    }
});

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
window.testNewDesign = function() {
    console.log('ğŸ¨ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
    console.log('ğŸ‘¤ ØªÙ…ÙŠÙŠØ² Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª - ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø¨Ø®Ù„ÙÙŠØ© Ù…Ù„ÙˆÙ†Ø© Ø¬Ø°Ø§Ø¨Ø©');
    console.log('ğŸ—‘ï¸ Ø­Ø°Ù ÙˆØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: Ù„Ù† ØªØ±Ù‰ "Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ®Øµ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ..." Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†');
    console.log('âœ¨ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØ´Ù…Ù„:');
    console.log('   â€¢ Ø®Ù„ÙÙŠØ© Ù…ØªØ¯Ø±Ø¬Ø© Ù…Ù„ÙˆÙ†Ø© Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±');
    console.log('   â€¢ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø°Ù‡Ø¨ÙŠØ© Ù…ØªØ­Ø±ÙƒØ©');
    console.log('   â€¢ ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ø¬Ø°Ø§Ø¨Ø©');
    console.log('   â€¢ ØªØ­Ø³ÙŠÙ† Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©');

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
    renderData();
    updateTotalStats();

    console.log('ğŸ‰ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª! ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¢Ù†');
};

