let properties = [];
let currentView = 'cards';
let currentCountry = null;
let currentProperty = null;
let filterStatus = null;

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูููุชุฑุฉ ุงูุญููู ุงููุฎููุฉ
function shouldHideField(fieldName) {
    const hiddenFields = [
        'Column1',
        'supabase_id',
        'created_at',
        'updated_at',
        'ูููุฉ  ุงูุงูุฌุงุฑ ',
        'id',
        'raw_data'
    ];
    return hiddenFields.includes(fieldName);
}

// ==================== ุดุงุดุฉ ุงูุชุญููู ุงูุจููุฑูุฉ ====================

// ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู ุงูุจููุฑูุฉ
function showCrystalLoading() {
    console.log('๐ฎ ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู ุงูุจููุฑูุฉ');

    // ุงูุชุญูู ูู ูุฌูุฏ ุดุงุดุฉ ุชุญููู ูุณุจูุงู
    const existingOverlay = document.getElementById('crystalLoadingOverlay');
    if (existingOverlay) {
        console.log('โ๏ธ ุดุงุดุฉ ุงูุชุญููู ููุฌูุฏุฉ ุจุงููุนู');
        return;
    }

    // ุฅูุดุงุก ุนูุตุฑ ุดุงุดุฉ ุงูุชุญููู
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'crystalLoadingOverlay';
    loadingOverlay.className = 'crystal-loading-overlay';

    loadingOverlay.innerHTML = `
        <div class="crystal-container">
            <div class="crystal-spinner">
                <div class="crystal-facet"></div>
                <div class="crystal-facet"></div>
                <div class="crystal-facet"></div>
            </div>
            <div class="crystal-text">ุฌุงุฑู ุชุญููู ุงููุญุชูู</div>
            <div class="crystal-subtitle">ูุฑุฌู ุงูุงูุชุธุงุฑ...</div>
            <div class="crystal-progress">
                <div class="crystal-progress-bar"></div>
            </div>
        </div>
        <div class="crystal-particles">
            <div class="crystal-particle"></div>
            <div class="crystal-particle"></div>
            <div class="crystal-particle"></div>
            <div class="crystal-particle"></div>
            <div class="crystal-particle"></div>
            <div class="crystal-particle"></div>
            <div class="crystal-particle"></div>
            <div class="crystal-particle"></div>
        </div>
    `;

    // ุฅุถุงูุฉ ุงูุดุงุดุฉ ุฅูู ุงูุตูุญุฉ
    document.body.appendChild(loadingOverlay);

    // ุฅุฎูุงุก ุงูุดุงุดุฉ ุจุนุฏ 5 ุซูุงูู ุฃู ุจุนุฏ ุงุฎุชูุงุก ุงูุฅุดุนุงุฑุงุช ุงูุนูููุฉ
    setTimeout(() => {
        checkNotificationsAndHideLoading();
    }, 5000);
}

// ุงูุชุญูู ูู ุงุฎุชูุงุก ุงูุฅุดุนุงุฑุงุช ุงูุนูููุฉ ูุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู
function checkNotificationsAndHideLoading() {
    console.log('๐ ูุญุต ุญุงูุฉ ุงูุฅุดุนุงุฑุงุช ุงูุนูููุฉ...');

    // ุงูุจุญุซ ุนู ุฌููุน ุฃููุงุน ุงูุฅุดุนุงุฑุงุช ูุงูุฑุณุงุฆู ุงูุนูููุฉ
    const notifications = document.querySelectorAll(`
        .notification,
        .no-permission-message,
        .success-message,
        .error-message,
        .welcome-message,
        .toast,
        .alert,
        [style*="position: fixed"][style*="top:"],
        [style*="position:fixed"][style*="top:"]
    `);

    // ููุชุฑุฉ ุงูุฅุดุนุงุฑุงุช ุงููุฑุฆูุฉ ููุท (ุงุณุชุซูุงุก ุดุงุดุฉ ุงูุชุญููู)
    const visibleNotifications = Array.from(notifications).filter(notification => {
        // ุชุฌุงูู ุดุงุดุฉ ุงูุชุญููู ููุณูุง
        if (notification.id === 'crystalLoadingOverlay' ||
            notification.classList.contains('crystal-loading-overlay')) {
            return false;
        }

        // ูุญุต ุฅุฐุง ูุงู ุงูุนูุตุฑ ูุฑุฆู
        const style = window.getComputedStyle(notification);
        const isVisible = style.display !== 'none' &&
                         style.visibility !== 'hidden' &&
                         style.opacity !== '0' &&
                         notification.offsetParent !== null;

        return isVisible;
    });

    console.log('๐ ุญุงูุฉ ุงูุฅุดุนุงุฑุงุช:', {
        totalNotifications: notifications.length,
        visibleNotifications: visibleNotifications.length,
        notificationTypes: visibleNotifications.map(n => n.className || n.tagName)
    });

    if (visibleNotifications.length === 0) {
        // ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ูุฑุฆูุฉุ ูููู ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู
        console.log('โ ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ูุฑุฆูุฉ - ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู');
        hideCrystalLoading();
    } else {
        // ููุงู ุฅุดุนุงุฑุงุช ูุฑุฆูุฉุ ุงูุชุธุงุฑ ูููู ุซู ูุญุต ูุฑุฉ ุฃุฎุฑู
        console.log('โณ ููุฌุฏ ุฅุดุนุงุฑุงุช ูุฑุฆูุฉ - ุงูุชุธุงุฑ ุงุฎุชูุงุฆูุง...');
        setTimeout(() => {
            checkNotificationsAndHideLoading();
        }, 1000); // ูุญุต ูู ุซุงููุฉ
    }
}

// ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู ุงูุจููุฑูุฉ
function hideCrystalLoading() {
    console.log('๐ฎ ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู ุงูุจููุฑูุฉ');

    const loadingOverlay = document.getElementById('crystalLoadingOverlay');
    if (loadingOverlay) {
        // ุฅูุบุงุก ุงููุคูุช ุฅุฐุง ูุงู ููุฌูุฏุงู
        const timeoutId = loadingOverlay.dataset.timeoutId;
        if (timeoutId) {
            clearTimeout(parseInt(timeoutId));
        }

        loadingOverlay.classList.add('fade-out');

        // ุฅุฒุงูุฉ ุงูุนูุตุฑ ุจุนุฏ ุงูุชูุงุก ุงูุงูุชูุงู
        setTimeout(() => {
            if (loadingOverlay.parentNode) {
                loadingOverlay.parentNode.removeChild(loadingOverlay);
            }
        }, 800);
    }
}

// ==================== ููุงูุฉ ุดุงุดุฉ ุงูุชุญููู ุงูุจููุฑูุฉ ====================

// ==================== ุชุญุฏูุซ ุนูุงุฆุฑ ุงููุณูู ูู ููู JSON ====================

// ุฏุงูุฉ ูุชุญุฏูุซ ุนูุงุฆุฑ ุงููุณูู ูู ููู JSON
async function updateNaseemBuildingsFromJSON() {
    try {
        console.log('๐ข ุจุฏุก ุชุญุฏูุซ ุนูุงุฆุฑ ุงููุณูู ูู ููู JSON...');

        // ูุฑุงุกุฉ ููู JSON
        const response = await fetch('./info2.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const jsonData = await response.json();
        console.log(`๐ ุชู ุชุญููู ${jsonData.length} ุณุฌู ูู ููู JSON`);

        // ููุชุฑุฉ ุจูุงูุงุช ุนูุงุฆุฑ ุงููุณูู
        const naseemUnits = jsonData.filter(unit =>
            unit['ุงุณู ุงูุนูุงุฑ'] && unit['ุงุณู ุงูุนูุงุฑ'].includes('ุนูุงุฆุฑ ุงููุณูู')
        );

        console.log(`๐๏ธ ุชู ุงูุนุซูุฑ ุนูู ${naseemUnits.length} ูุญุฏุฉ ูู ุนูุงุฆุฑ ุงููุณูู`);

        if (naseemUnits.length === 0) {
            console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุญุฏุงุช ุนูุงุฆุฑ ุงููุณูู ูู ุงูููู');
            return false;
        }

        // ุชุฌููุน ุงููุญุฏุงุช ุญุณุจ ุงูุนูุงุฑ (ุงููุจูู)
        const buildingGroups = {};
        naseemUnits.forEach(unit => {
            const buildingKey = `${unit['ุงุณู ุงูุนูุงุฑ']}_${unit['ุฑูู ุงูุตู'] || 'unknown'}`;
            if (!buildingGroups[buildingKey]) {
                buildingGroups[buildingKey] = [];
            }
            buildingGroups[buildingKey].push(unit);
        });

        console.log(`๐ข ุชู ุชุฌููุน ุงููุญุฏุงุช ูู ${Object.keys(buildingGroups).length} ูุจูู`);

        // ุชุญุฏูุซ ุฃู ุฅุถุงูุฉ ุงููุจุงูู
        let updatedCount = 0;
        let addedCount = 0;

        for (const [buildingKey, units] of Object.entries(buildingGroups)) {
            const firstUnit = units[0];
            const propertyName = firstUnit['ุงุณู ุงูุนูุงุฑ'];

            // ุงูุจุญุซ ุนู ุงูุนูุงุฑ ุงูููุฌูุฏ
            let existingProperty = properties.find(p =>
                p.name === propertyName &&
                p.deedNumber === firstUnit['ุฑูู ุงูุตู']
            );

            if (existingProperty) {
                // ุชุญุฏูุซ ุงูุนูุงุฑ ุงูููุฌูุฏ
                console.log(`๐ ุชุญุฏูุซ ุงูุนูุงุฑ ุงูููุฌูุฏ: ${propertyName}`);
                updateExistingProperty(existingProperty, units);
                updatedCount++;
            } else {
                // ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ
                console.log(`โ ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ: ${propertyName}`);
                const newProperty = createNewPropertyFromJSON(units);
                properties.push(newProperty);
                addedCount++;
            }
        }

        // ุญูุธ ุงูุจูุงูุงุช
        await saveDataToLocalStorage();
        await saveAllPropertiesToSupabase();

        // ุชุญุฏูุซ ุงููุงุฌูุฉ
        displayProperties();
        updateSidebar();

        console.log(`โ ุชู ุชุญุฏูุซ ุนูุงุฆุฑ ุงููุณูู ุจูุฌุงุญ:`);
        console.log(`   - ุชู ุชุญุฏูุซ ${updatedCount} ุนูุงุฑ ููุฌูุฏ`);
        console.log(`   - ุชู ุฅุถุงูุฉ ${addedCount} ุนูุงุฑ ุฌุฏูุฏ`);
        console.log(`   - ุฅุฌูุงูู ุงููุญุฏุงุช ุงููุนุงูุฌุฉ: ${naseemUnits.length}`);

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        showNotification(
            `ุชู ุชุญุฏูุซ ุนูุงุฆุฑ ุงููุณูู ุจูุฌุงุญ!\n` +
            `ุชู ุชุญุฏูุซ ${updatedCount} ุนูุงุฑ ูุฅุถุงูุฉ ${addedCount} ุนูุงุฑ ุฌุฏูุฏ\n` +
            `ุฅุฌูุงูู ${naseemUnits.length} ูุญุฏุฉ`,
            'success'
        );

        return true;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุนูุงุฆุฑ ุงููุณูู:', error);
        showNotification(`ุฎุทุฃ ูู ุชุญุฏูุซ ุนูุงุฆุฑ ุงููุณูู: ${error.message}`, 'error');
        return false;
    }
}

// ุฏุงูุฉ ูุชุญุฏูุซ ุนูุงุฑ ููุฌูุฏ
function updateExistingProperty(property, units) {
    // ุชุญุฏูุซ ูุนูููุงุช ุงูุนูุงุฑ ุงูุฃุณุงุณูุฉ ูู ุฃูู ูุญุฏุฉ
    const firstUnit = units[0];

    property.city = firstUnit['ุงููุฏููุฉ'] || property.city;
    property.location = firstUnit['ูููุน ุงูุนูุงุฑ'] || property.location;
    property.deedNumber = firstUnit['ุฑูู ุงูุตู'] || property.deedNumber;
    property.realEstateRegistry = firstUnit['ุงูุณุฌู ุงูุนููู '] || property.realEstateRegistry;
    property.deedArea = firstUnit['ูุณุงุญุฉุงูุตู'] || property.deedArea;
    property.owner = firstUnit['ุงููุงูู'] || property.owner;

    // ุชุญุฏูุซ ุงููุญุฏุงุช
    units.forEach(jsonUnit => {
        const unitNumber = jsonUnit['ุฑูู  ุงููุญุฏุฉ '];
        if (!unitNumber) return;

        // ุงูุจุญุซ ุนู ุงููุญุฏุฉ ุงูููุฌูุฏุฉ
        let existingUnit = property.units.find(u => u.unitNumber === unitNumber);

        if (existingUnit) {
            // ุชุญุฏูุซ ุงููุญุฏุฉ ุงูููุฌูุฏุฉ
            updateUnitFromJSON(existingUnit, jsonUnit);
        } else {
            // ุฅุถุงูุฉ ูุญุฏุฉ ุฌุฏูุฏุฉ
            const newUnit = createUnitFromJSON(jsonUnit);
            property.units.push(newUnit);
        }
    });

    // ุชุญุฏูุซ ุชุงุฑูุฎ ุงูุชุนุฏูู
    property.lastModified = new Date().toISOString();
}

// ุฏุงูุฉ ูุฅูุดุงุก ุนูุงุฑ ุฌุฏูุฏ ูู JSON
function createNewPropertyFromJSON(units) {
    const firstUnit = units[0];
    const propertyId = generateUUID();

    const newProperty = {
        id: propertyId,
        name: firstUnit['ุงุณู ุงูุนูุงุฑ'],
        city: firstUnit['ุงููุฏููุฉ'] || 'ุงูุฑูุงุถ',
        location: firstUnit['ูููุน ุงูุนูุงุฑ'] || '',
        deedNumber: firstUnit['ุฑูู ุงูุตู'] || '',
        realEstateRegistry: firstUnit['ุงูุณุฌู ุงูุนููู '] || '',
        deedArea: firstUnit['ูุณุงุญุฉุงูุตู'] || '',
        owner: firstUnit['ุงููุงูู'] || '',
        units: [],
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };

    // ุฅุถุงูุฉ ุงููุญุฏุงุช
    units.forEach(jsonUnit => {
        if (jsonUnit['ุฑูู  ุงููุญุฏุฉ ']) {
            const unit = createUnitFromJSON(jsonUnit);
            newProperty.units.push(unit);
        }
    });

    return newProperty;
}

// ุฏุงูุฉ ูุฅูุดุงุก ูุญุฏุฉ ูู JSON
function createUnitFromJSON(jsonUnit) {
    const unitId = generateUUID();

    return {
        id: unitId,
        unitNumber: jsonUnit['ุฑูู  ุงููุญุฏุฉ '],
        tenantName: jsonUnit['ุงุณู ุงููุณุชุฃุฌุฑ'] || '',
        tenantPhone: '', // ุณูุชู ุฅุถุงูุชู ูุงุญูุงู ุฅุฐุง ูุงู ูุชููุฑุงู
        contractNumber: jsonUnit['ุฑูู ุงูุนูุฏ'] || '',
        rentAmount: parseFloat(jsonUnit['ูููุฉ  ุงูุงูุฌุงุฑ ']) || 0,
        area: parseFloat(jsonUnit['ุงููุณุงุญุฉ']) || 0,
        startDate: jsonUnit['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']) : '',
        endDate: jsonUnit['ุชุงุฑูุฎ ุงูููุงูุฉ'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ุงูููุงูุฉ']) : '',
        totalAmount: parseFloat(jsonUnit['ุงูุงุฌูุงูู']) || 0,
        electricityAccount: jsonUnit['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] ? String(jsonUnit['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก']).replace('.0', '') : '',
        remainingInstallments: jsonUnit['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] || 0,
        firstInstallmentDate: jsonUnit['ุชุงุฑูุฎ ุงููุณุท ุงูุงูู'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ุงููุณุท ุงูุงูู']) : '',
        firstInstallmentAmount: parseFloat(jsonUnit['ูุจูุบ ุงููุณุท ุงูุงูู']) || 0,
        secondInstallmentDate: jsonUnit['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู']) : '',
        secondInstallmentAmount: parseFloat(jsonUnit['ูุจูุบ ุงููุณุท ุงูุซุงูู']) || 0,
        installmentEndDate: jsonUnit['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']) : '',
        contractType: jsonUnit['ููุน ุงูุนูุฏ'] || 'ุณููู',
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
}

// ุฏุงูุฉ ูุชุญุฏูุซ ูุญุฏุฉ ููุฌูุฏุฉ ูู JSON
function updateUnitFromJSON(unit, jsonUnit) {
    unit.tenantName = jsonUnit['ุงุณู ุงููุณุชุฃุฌุฑ'] || unit.tenantName;
    unit.contractNumber = jsonUnit['ุฑูู ุงูุนูุฏ'] || unit.contractNumber;
    unit.rentAmount = parseFloat(jsonUnit['ูููุฉ  ุงูุงูุฌุงุฑ ']) || unit.rentAmount;
    unit.area = parseFloat(jsonUnit['ุงููุณุงุญุฉ']) || unit.area;
    unit.startDate = jsonUnit['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']) : unit.startDate;
    unit.endDate = jsonUnit['ุชุงุฑูุฎ ุงูููุงูุฉ'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ุงูููุงูุฉ']) : unit.endDate;
    unit.totalAmount = parseFloat(jsonUnit['ุงูุงุฌูุงูู']) || unit.totalAmount;
    unit.electricityAccount = jsonUnit['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] ? String(jsonUnit['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก']).replace('.0', '') : unit.electricityAccount;
    unit.remainingInstallments = jsonUnit['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] || unit.remainingInstallments;
    unit.firstInstallmentDate = jsonUnit['ุชุงุฑูุฎ ุงููุณุท ุงูุงูู'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ุงููุณุท ุงูุงูู']) : unit.firstInstallmentDate;
    unit.firstInstallmentAmount = parseFloat(jsonUnit['ูุจูุบ ุงููุณุท ุงูุงูู']) || unit.firstInstallmentAmount;
    unit.secondInstallmentDate = jsonUnit['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู']) : unit.secondInstallmentDate;
    unit.secondInstallmentAmount = parseFloat(jsonUnit['ูุจูุบ ุงููุณุท ุงูุซุงูู']) || unit.secondInstallmentAmount;
    unit.installmentEndDate = jsonUnit['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท'] ? formatDateFromJSON(jsonUnit['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']) : unit.installmentEndDate;
    unit.contractType = jsonUnit['ููุน ุงูุนูุฏ'] || unit.contractType;
    unit.lastModified = new Date().toISOString();
}

// ุฏุงูุฉ ูุชูุณูู ุงูุชุงุฑูุฎ ูู JSON
function formatDateFromJSON(dateString) {
    if (!dateString) return '';

    try {
        // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ูุญุชูู ุนูู ููุช
        if (dateString.includes(' ')) {
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
        }

        // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุจุตูุบุฉ DD/MM/YYYY ุฃู DD-MM-YYYY
        if (dateString.includes('/') || dateString.includes('-')) {
            const separator = dateString.includes('/') ? '/' : '-';
            const parts = dateString.split(separator);

            if (parts.length === 3) {
                // ุชุญููู ูู DD/MM/YYYY ุฅูู YYYY-MM-DD
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];

                return `${year}-${month}-${day}`;
            }
        }

        return dateString;
    } catch (error) {
        console.warn('ุชุญุฐูุฑ: ูุง ูููู ุชูุณูู ุงูุชุงุฑูุฎ:', dateString);
        return dateString;
    }
}

// ==================== ููุงูุฉ ุชุญุฏูุซ ุนูุงุฆุฑ ุงููุณูู ูู ููู JSON ====================

// ==================== ุงุฎุชุจุงุฑ ุญูุธ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู ====================

// ุฏุงูุฉ ูุงุฎุชุจุงุฑ ุญูุธ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู
async function testPhoneFieldSave() {
    console.log('๐งช ุจุฏุก ุงุฎุชุจุงุฑ ุญูุธ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู...');

    try {
        // ุฅูุดุงุก ุนูุงุฑ ุชุฌุฑูุจู
        const testProperty = {
            'ุฑูู  ุงููุญุฏุฉ ': 'TEST_PHONE_001',
            'ุงุณู ุงูุนูุงุฑ': 'ุงุฎุชุจุงุฑ ุฑูู ุงูุฌูุงู',
            'ุงููุฏููุฉ': 'ุงูุฑูุงุถ',
            'ุงุณู ุงููุณุชุฃุฌุฑ': 'ูุณุชุฃุฌุฑ ุชุฌุฑูุจู',
            'ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ': '0501234567',
            'ุฑูู ุฌูุงู ุฅุถุงูู': '0509876543',
            'ุฑูู ุงูุนูุฏ': 'CONTRACT_TEST_001',
            'ูููุฉ  ุงูุงูุฌุงุฑ ': 5000,
            'ุงููุณุงุญุฉ': 100,
            'ุฑูู ุงูุตู': 'DEED_TEST_001',
            'ุงููุงูู': 'ูุงูู ุชุฌุฑูุจู',
            'ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ': new Date().toLocaleDateString('ar-SA'),
            'ููุน ุงูุชุญุฏูุซ': 'ุงุฎุชุจุงุฑ',
            'ุงููุณุคูู ุนู ุงูุชุญุฏูุซ': getCurrentUser()
        };

        console.log('๐ ุงูุนูุงุฑ ุงูุชุฌุฑูุจู:', testProperty);

        // ุฅุถุงูุฉ ุงูุนูุงุฑ ุฅูู ุงููุตูููุฉ ุงููุญููุฉ
        properties.push(testProperty);

        // ุญูุธ ูุญููุงู
        saveDataLocally();
        console.log('โ ุชู ุญูุธ ุงูุนูุงุฑ ูุญููุงู');

        // ุญูุธ ูู Supabase
        if (typeof savePropertyToSupabase === 'function') {
            console.log('โ๏ธ ุญูุธ ุงูุนูุงุฑ ูู Supabase...');
            const result = await savePropertyToSupabase(testProperty);

            if (result) {
                console.log('โ ุชู ุญูุธ ุงูุนูุงุฑ ูู Supabase ุจูุฌุงุญ');

                // ุงูุชุญูู ูู ุงูุญูุธ
                setTimeout(async () => {
                    try {
                        const { data: verifyData, error } = await supabaseClient
                            .from('properties')
                            .select('unit_number, tenant_name, tenant_phone, tenant_phone_2')
                            .eq('unit_number', 'TEST_PHONE_001')
                            .single();

                        if (error) {
                            console.error('โ ุฎุทุฃ ูู ุงูุชุญูู:', error);
                        } else {
                            console.log('๐ ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู Supabase:', verifyData);

                            if (verifyData.tenant_phone_2 === '0509876543') {
                                console.log('๐ ูุฌุญ ุงุฎุชุจุงุฑ ุญูุธ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู!');
                                showNotification('ูุฌุญ ุงูุงุฎุชุจุงุฑ! ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู ููุญูุธ ุจุดูู ุตุญูุญ ูู Supabase', 'success');
                            } else {
                                console.error('โ ูุดู ุงุฎุชุจุงุฑ ุญูุธ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู');
                                showNotification('ูุดู ุงูุงุฎุชุจุงุฑ! ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู ูู ููุญูุธ ูู Supabase', 'error');
                            }
                        }

                        // ุญุฐู ุงูุนูุงุฑ ุงูุชุฌุฑูุจู
                        setTimeout(async () => {
                            try {
                                await supabaseClient
                                    .from('properties')
                                    .delete()
                                    .eq('unit_number', 'TEST_PHONE_001');

                                // ุญุฐู ูู ุงููุตูููุฉ ุงููุญููุฉ
                                const testIndex = properties.findIndex(p => p['ุฑูู  ุงููุญุฏุฉ '] === 'TEST_PHONE_001');
                                if (testIndex !== -1) {
                                    properties.splice(testIndex, 1);
                                    saveDataLocally();
                                }

                                console.log('๐๏ธ ุชู ุญุฐู ุงูุนูุงุฑ ุงูุชุฌุฑูุจู');
                            } catch (cleanupError) {
                                console.warn('โ๏ธ ูุดู ูู ุญุฐู ุงูุนูุงุฑ ุงูุชุฌุฑูุจู:', cleanupError);
                            }
                        }, 3000);

                    } catch (verifyError) {
                        console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุจูุงูุงุช:', verifyError);
                    }
                }, 2000);

            } else {
                console.error('โ ูุดู ุญูุธ ุงูุนูุงุฑ ูู Supabase');
                showNotification('ูุดู ูู ุญูุธ ุงูุนูุงุฑ ุงูุชุฌุฑูุจู ูู Supabase', 'error');
            }
        } else {
            console.error('โ ุฏุงูุฉ savePropertyToSupabase ุบูุฑ ูุชููุฑุฉ');
            showNotification('ุฏุงูุฉ ุงูุญูุธ ุบูุฑ ูุชููุฑุฉ', 'error');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุญูุธ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู:', error);
        showNotification(`ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ: ${error.message}`, 'error');
    }
}

// ุฏุงูุฉ ูุฅุธูุงุฑ ุงูุฅุดุนุงุฑุงุช
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        font-size: 1rem;
        font-weight: 500;
        max-width: 400px;
        word-wrap: break-word;
        animation: slideInRight 0.3s ease-out;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

// ==================== ููุงูุฉ ุงุฎุชุจุงุฑ ุญูุธ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู ====================

// ==================== ุชุญุฏูุซ ุจูุงูุงุช info2.json ====================

// ุฏุงูุฉ ูุชุญุฏูุซ ุจูุงูุงุช info2.json ุฅูู Supabase
async function updateInfo2DataToSupabase() {
    console.log('๐ ุจุฏุก ุชุญุฏูุซ ุจูุงูุงุช info2.json ุฅูู Supabase...');

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        const loadingModal = document.createElement('div');
        loadingModal.className = 'modal-overlay';
        loadingModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        `;

        loadingModal.innerHTML = `
            <div style="
                background: white;
                padding: 40px;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                max-width: 500px;
                width: 90%;
            ">
                <div style="
                    width: 60px;
                    height: 60px;
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #007bff;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                "></div>
                <h3 style="color: #333; margin: 0 0 10px 0;">ุฌุงุฑู ุชุญุฏูุซ ุงูุจูุงูุงุช</h3>
                <p style="color: #666; margin: 0;" id="updateProgress">ุชุญููู ููู info2.json...</p>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        `;

        document.body.appendChild(loadingModal);

        const updateProgress = (message) => {
            const progressElement = document.getElementById('updateProgress');
            if (progressElement) {
                progressElement.textContent = message;
            }
            console.log('๐ ' + message);
        };

        // ุชุญููู ููู info2.json
        updateProgress('ุชุญููู ููู info2.json...');
        const response = await fetch('info2.json');
        if (!response.ok) {
            throw new Error(`ูุดู ูู ุชุญููู ููู info2.json: ${response.status}`);
        }

        const info2Data = await response.json();
        console.log(`๐ ุชู ุชุญููู ${info2Data.length} ุนูุงุฑ ูู info2.json`);

        // ุงูุชุญูู ูู ุงูุงุชุตุงู ุจู Supabase
        updateProgress('ุงูุชุญูู ูู ุงูุงุชุตุงู ุจู Supabase...');
        if (!supabaseClient) {
            await initSupabase();
        }

        if (!supabaseClient) {
            throw new Error('ูุดู ูู ุงูุงุชุตุงู ุจู Supabase');
        }

        // ูุนุงูุฌุฉ ุงูุจูุงูุงุช ูุชุญุฏูุซูุง
        updateProgress('ูุนุงูุฌุฉ ุงูุจูุงูุงุช...');
        let successCount = 0;
        let errorCount = 0;
        let updateCount = 0;
        let insertCount = 0;

        for (let i = 0; i < info2Data.length; i++) {
            const property = info2Data[i];
            const unitNumber = property['ุฑูู  ุงููุญุฏุฉ '];

            updateProgress(`ูุนุงูุฌุฉ ุงููุญุฏุฉ ${i + 1}/${info2Data.length}: ${unitNumber}`);

            try {
                // ุชุญููู ุงูุจูุงูุงุช ุฅูู ุตูุบุฉ Supabase
                const supabaseData = convertPropertyToSupabaseFormat(property);

                // ุงูุชุญูู ูู ูุฌูุฏ ุงููุญุฏุฉ
                const { data: existingUnit, error: checkError } = await supabaseClient
                    .from('properties')
                    .select('id')
                    .eq('unit_number', unitNumber)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    console.error(`ุฎุทุฃ ูู ุงูุชุญูู ูู ุงููุญุฏุฉ ${unitNumber}:`, checkError);
                    errorCount++;
                    continue;
                }

                if (existingUnit) {
                    // ุชุญุฏูุซ ุงููุญุฏุฉ ุงูููุฌูุฏุฉ
                    const { error: updateError } = await supabaseClient
                        .from('properties')
                        .update(supabaseData)
                        .eq('unit_number', unitNumber);

                    if (updateError) {
                        console.error(`ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุญุฏุฉ ${unitNumber}:`, updateError);
                        errorCount++;
                    } else {
                        console.log(`โ ุชู ุชุญุฏูุซ ุงููุญุฏุฉ ${unitNumber}`);
                        updateCount++;
                        successCount++;
                    }
                } else {
                    // ุฅุฏุฑุงุฌ ูุญุฏุฉ ุฌุฏูุฏุฉ
                    const { error: insertError } = await supabaseClient
                        .from('properties')
                        .insert([supabaseData]);

                    if (insertError) {
                        console.error(`ุฎุทุฃ ูู ุฅุฏุฑุงุฌ ุงููุญุฏุฉ ${unitNumber}:`, insertError);
                        errorCount++;
                    } else {
                        console.log(`โ ุชู ุฅุฏุฑุงุฌ ุงููุญุฏุฉ ${unitNumber}`);
                        insertCount++;
                        successCount++;
                    }
                }

                // ุชุฃุฎูุฑ ูุตูุฑ ูุชุฌูุจ ุฅุฑูุงู ุงูุฎุงุฏู
                await new Promise(resolve => setTimeout(resolve, 100));

            } catch (error) {
                console.error(`ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงููุญุฏุฉ ${unitNumber}:`, error);
                errorCount++;
            }
        }

        // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
        updateProgress('ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ...');

        // ุฏูุฌ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูุน ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ
        info2Data.forEach(newProperty => {
            const existingIndex = properties.findIndex(p =>
                p['ุฑูู  ุงููุญุฏุฉ '] === newProperty['ุฑูู  ุงููุญุฏุฉ ']
            );

            if (existingIndex !== -1) {
                // ุชุญุฏูุซ ุงูุนูุงุฑ ุงูููุฌูุฏ
                properties[existingIndex] = { ...properties[existingIndex], ...newProperty };
            } else {
                // ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ
                properties.push(newProperty);
            }
        });

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        saveDataLocally();

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู
        updateProgress('ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู...');
        initializeApp();

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        // ุฅุธูุงุฑ ุชูุฑูุฑ ุงููุชุงุฆุฌ
        const reportMessage = `
๐ ุชู ุชุญุฏูุซ ุจูุงูุงุช info2.json ุจูุฌุงุญ!

๐ ุชูุฑูุฑ ุงูุชุญุฏูุซ:
โข ุฅุฌูุงูู ุงููุญุฏุงุช: ${info2Data.length}
โข ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ: ${successCount}
โข ุชู ุงูุชุญุฏูุซ: ${updateCount}
โข ุชู ุงูุฅุฏุฑุงุฌ: ${insertCount}
โข ูุดู: ${errorCount}

โ ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ ูุงูุณุญุงุจูุฉ
        `;

        alert(reportMessage);
        console.log('๐ ุชู ุงูุงูุชูุงุก ูู ุชุญุฏูุซ ุจูุงูุงุช info2.json');

        return {
            total: info2Data.length,
            success: successCount,
            updated: updateCount,
            inserted: insertCount,
            errors: errorCount
        };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุจูุงูุงุช info2.json:', error);

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        const loadingModal = document.querySelector('.modal-overlay');
        if (loadingModal) {
            loadingModal.remove();
        }

        alert(`โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุจูุงูุงุช: ${error.message}`);
        throw error;
    }
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุญููู ุงูุจูุงูุงุช ุฅูู ุตูุบุฉ Supabase
function convertPropertyToSupabaseFormat(jsonProperty) {
    // ุชุญููู ุงูุชูุงุฑูุฎ ูู ุตูุบุฉ ISO ุฅูู ุตูุบุฉ dd/mm/yyyy
    const convertDate = (dateStr) => {
        if (!dateStr) return null;

        // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุจุตูุบุฉ ISO (yyyy-mm-dd hh:mm:ss)
        if (dateStr.includes('-') && dateStr.length > 10) {
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
        }

        // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุจุตูุบุฉ dd/mm/yyyy ุฃู dd-mm-yyyy
        if (typeof dateStr === 'string') {
            return dateStr.replace(/-/g, '/');
        }

        return dateStr;
    };

    return {
        unit_number: jsonProperty['ุฑูู  ุงููุญุฏุฉ '],
        city: jsonProperty['ุงููุฏููุฉ'],
        property_name: jsonProperty['ุงุณู ุงูุนูุงุฑ'],
        property_location: jsonProperty['ูููุน ุงูุนูุงุฑ'],
        height: jsonProperty['ุงูุงุฑุชูุงุน'],
        deed_number: jsonProperty['ุฑูู ุงูุตู'],
        real_estate_registry: jsonProperty['ุงูุณุฌู ุงูุนููู '],
        deed_area: jsonProperty['ูุณุงุญุฉุงูุตู'],
        owner: jsonProperty['ุงููุงูู'],
        tenant_name: jsonProperty['ุงุณู ุงููุณุชุฃุฌุฑ'],
        tenant_phone: jsonProperty['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ'],
        tenant_phone_2: jsonProperty['ุฑูู ุฌูุงู ุฅุถุงูู'],
        contract_number: jsonProperty['ุฑูู ุงูุนูุฏ'],
        rent_value: parseFloat(jsonProperty['ูููุฉ  ุงูุงูุฌุงุฑ ']) || null,
        area: parseFloat(jsonProperty['ุงููุณุงุญุฉ']) || null,
        start_date: convertDate(jsonProperty['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']),
        end_date: convertDate(jsonProperty['ุชุงุฑูุฎ ุงูููุงูุฉ']),
        total_amount: parseFloat(jsonProperty['ุงูุงุฌูุงูู']) || null,
        electricity_account: jsonProperty['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'],
        remaining_installments: parseFloat(jsonProperty['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']) || null,
        first_installment_date: convertDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุงูู']),
        first_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุงูู']) || null,
        second_installment_date: convertDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู']),
        second_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุซุงูู']) || null,
        installment_end_date: convertDate(jsonProperty['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']),
        contract_type: jsonProperty['ููุน ุงูุนูุฏ'],
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
    };
}

// ==================== ููุงูุฉ ุชุญุฏูุซ ุจูุงูุงุช info2.json ====================
let contractTypeFilter = null;
let multiFilterSelectedCity = null;
let multiFilterSelectedProperties = [];
let isReverseOrder = true; // ุชุฑุชูุจ ุนูุณู ุงูุชุฑุงุถูุงู (ุงูุฃุญุฏุซ ุฃููุงู)
// ูุชุบูุฑุงุช ุนุงูุฉ ููููุชุฑ
let dateFilterType = '';
let dateFilterDay = '';
let dateFilterMonth = '';
let dateFilterYear = '';
let attachments = {}; // ูุฑููุงุช ุงูุนูุงุฑุงุช ุงูุนุงูุฉ
let cardAttachments = {}; // ูุฑููุงุช ุงูุจุทุงูุงุช ุงููููุตูุฉ

// ุชููุฆุฉ ุงููุชุบูุฑ ุงูุนุงู ูููุฑููุงุช
if (!window.attachments) {
    window.attachments = {};
}

// ุชุญุฏูุซ ุงููุชุบูุฑ ุงูุนุงู ูู localStorage
try {
    const storedAttachments = JSON.parse(localStorage.getItem('propertyAttachments') || '{}');
    const storedLegacyAttachments = JSON.parse(localStorage.getItem('attachments') || '{}');

    // ุฏูุฌ ุงููุฑููุงุช ูู ูุตุงุฏุฑ ูุฎุชููุฉ
    window.attachments = { ...storedLegacyAttachments, ...storedAttachments };
    attachments = window.attachments;

    console.log(`๐ ุชู ุชุญููู ${Object.keys(window.attachments).length} ูุฌููุนุฉ ูุฑููุงุช ูู localStorage`);
} catch (error) {
    console.warn('โ๏ธ ุฎุทุฃ ูู ุชุญููู ุงููุฑููุงุช ูู localStorage:', error);
    window.attachments = {};
    attachments = {};
}
let isManagementMode = false; // ูุชุบูุฑ ูุชุชุจุน ูุถุน ุงูุฅุฏุงุฑุฉ
let currentCalculationYear = new Date().getFullYear(); // ุงูุณูุฉ ุงูุญุงููุฉ ููุญุณุงุจ (2025)
let selectedCityFilter = 'all'; // ุงููุฏููุฉ ุงููุฎุชุงุฑุฉ ููุชุตููุฉ ูู ุตูุญุฉ ุงูุฅุฏุงุฑุฉ
let areHeaderButtonsVisible = true; // ูุชุบูุฑ ูุชุชุจุน ุญุงูุฉ ุฅุธูุงุฑ/ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูููุฏุฑ
let propertyManagement = {
    properties: [],
    units: []
};

// ===== ุฏูุงู ูุณุงุนุฏุฉ ููุชุนุงูู ูุน ุฃุนูุฏุฉ ุงููุงูู =====

// ุฏุงูุฉ ูุณุงุนุฏุฉ ููุญุตูู ุนูู ูููุฉ ุงููุงูู ูู ุฃู ูู ุงูุนููุฏูู
function getOwnerValue(property) {
    return property.owner_name || property.owner || null;
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุญุฏูุซ ุฃุนูุฏุฉ ุงููุงูู (ููุงููุง)
function setOwnerValue(propertyData, ownerValue) {
    propertyData.owner = ownerValue;
    propertyData.owner_name = ownerValue;
    return propertyData;
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ููุญุตูู ุนูู ูููุฉ ุงูุณุฌู ุงูุนูุงุฑู ูู ุฃู ูู ุงูุนููุฏูู
function getRegistryValue(property) {
    return property.registry_number || property.real_estate_registry || null;
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุญุฏูุซ ุฃุนูุฏุฉ ุงูุณุฌู ุงูุนูุงุฑู (ููุงููุง)
function setRegistryValue(propertyData, registryValue) {
    propertyData.registry_number = registryValue;
    propertyData.real_estate_registry = registryValue;
    return propertyData;
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ููุญุตูู ุนูู ูููุฉ ุงูุฅูุฌุงุฑ ูู ุงูุนููุฏ ุงูุฃุณุงุณู ููุท
function getRentValue(property) {
    return property.rent_value || null;
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุญุฏูุซ ุนููุฏ ุงูุฅูุฌุงุฑ ุงูุฃุณุงุณู ููุท
function setRentValue(propertyData, rentValue) {
    propertyData.rent_value = rentValue;
    return propertyData;
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ููุญุตูู ุนูู ูููุฉ ุงูุณุฌู ุงูุนูุงุฑู ูู ุฃู ูู ุงูุนููุฏูู
function getRegistryValue(property) {
    return property.registry_number || property.real_estate_registry || null;
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุญุฏูุซ ุฃุนูุฏุฉ ุงูุณุฌู ุงูุนูุงุฑู (ููุงููุง)
function setRegistryValue(propertyData, registryValue) {
    propertyData.registry_number = registryValue;
    propertyData.real_estate_registry = registryValue;
    return propertyData;
}

// ุฅุนุฏุงุฏุงุช ุงููุทูุฑ ููุฅุดุนุงุฑุงุช ุงูุชูุตูููุฉ
let developerMode = localStorage.getItem('developerMode') === 'true' || false;

// ===== ูุธุงู ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช ูุงููุฏู ุจุฏูู ูุญุฏุงุช ุงูุชุฑุงุถูุฉ =====

// ูุตูููุฉ ูููุตูุฉ ูุญูุธ ูุนูููุงุช ุงูุนูุงุฑุงุช ุงูุฃุณุงุณูุฉ
let propertyDefinitions = JSON.parse(localStorage.getItem('propertyDefinitions') || '[]');

// ูุตูููุฉ ูููุตูุฉ ูุญูุธ ุงููุฏู ุงููุถุงูุฉ
let cityDefinitions = JSON.parse(localStorage.getItem('cityDefinitions') || '[]');

// ูุธููุฉ ุฐููุฉ ููุฅุดุนุงุฑุงุช - ุชุธูุฑ ููุท ุงูุฅุดุนุงุฑุงุช ุงููููุฉ
function smartToast(message, type = 'info', force = false) {
    // ุงูุฅุดุนุงุฑุงุช ุงููููุฉ ุงูุชู ุชุธูุฑ ุฏุงุฆูุงู
    const importantTypes = ['error', 'warning'];
    const importantKeywords = ['ุฎุทุฃ', 'ูุดู', 'ูุดููุฉ', 'ุชุญุฐูุฑ', 'ุญุฐู', 'ูุฌุญ ุงูุญูุธ', 'ุชู ุงูุญูุธ'];

    // ุฅุธูุงุฑ ุงูุฅุดุนุงุฑ ุฅุฐุง ูุงู:
    // 1. ููุฑูุถ ุฅุธูุงุฑู (force = true)
    // 2. ูู ุงูููุน ุงูููู (ุฎุทุฃ ุฃู ุชุญุฐูุฑ)
    // 3. ูุญุชูู ุนูู ูููุงุช ูููุฉ
    // 4. ูุถุน ุงููุทูุฑ ููุนู
    const shouldShow = force ||
                      importantTypes.includes(type) ||
                      importantKeywords.some(keyword => message.includes(keyword)) ||
                      developerMode;

    if (shouldShow) {
        showToast(message, type);
    } else {
        // ุฅุฑุณุงู ูููููุณูู ุจุฏูุงู ูู ุงูุฅุดุนุงุฑ
        console.log(`๐ข ${type.toUpperCase()}: ${message}`);
    }
}

// ุชุจุฏูู ูุถุน ุงููุทูุฑ
function toggleDeveloperMode() {
    developerMode = !developerMode;
    localStorage.setItem('developerMode', developerMode.toString());
    updateDeveloperModeButton();

    if (developerMode) {
        showToast('ุชู ุชูุนูู ูุถุน ุงููุทูุฑ - ุณุชุธูุฑ ุฌููุน ุงูุฅุดุนุงุฑุงุช ุงูุชูุตูููุฉ', 'success');
        console.log('๐ง ุชู ุชูุนูู ูุถุน ุงููุทูุฑ - ุณุชุธูุฑ ุฌููุน ุงูุฅุดุนุงุฑุงุช ุงูุชูุตูููุฉ');
    } else {
        showToast('ุชู ุฅูุบุงุก ูุถุน ุงููุทูุฑ - ุณุชุธูุฑ ุงูุฅุดุนุงุฑุงุช ุงููููุฉ ููุท', 'info');
        console.log('๐ง ุชู ุฅูุบุงุก ูุถุน ุงููุทูุฑ - ุณุชุธูุฑ ุงูุฅุดุนุงุฑุงุช ุงููููุฉ ููุท');
    }
}

// ุชุญุฏูุซ ุญุงูุฉ ุฒุฑ ูุถุน ุงููุทูุฑ
function updateDeveloperModeButton() {
    const btn = document.getElementById('developerModeBtn');
    const text = document.getElementById('developerModeText');

    if (!btn || !text) return;

    if (developerMode) {
        btn.style.background = 'linear-gradient(to left, #28a745, #20c997)';
        text.textContent = 'ูุถุน ุงููุทูุฑ (ููุนู)';
    } else {
        btn.style.background = 'linear-gradient(to left, #6f42c1, #5a2d91)';
        text.textContent = 'ูุถุน ุงููุทูุฑ';
    }
}

// ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', function() {
    // ุชููุฆุฉ ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ููุฌูุงู
    initMobileMenu();

    // ุชุญุฏูุซ ุญุงูุฉ ุฒุฑ ูุถุน ุงููุทูุฑ
    updateDeveloperModeButton();

    // ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู localStorage ุฅุฐุง ูุงูุช ูุชููุฑุฉ
    restoreDataFromLocalStorage();

    // Initialize data loading (Supabase or JSON fallback)
    console.log('๐ ุจุฏุก ุชุญููู ุงูุจูุงูุงุช...');

    // ูุญุต ุงูุจูุงูุงุช ููุชุฃูุฏ ูู ุงูุญูุธ ุงูุฏุงุฆู
    setTimeout(() => {
        verifyDataPersistence();
    }, 1000);

    initializeDataLoading()
        .then(() => {
            console.log(`โ ุชู ุชุญููู ${properties ? properties.length : 0} ุนูุงุฑ`);

            // ุฅุตูุงุญ ุงูุชูุงุฑูุฎ ุงููุญููุธุฉ ุจุดูู ุฎุงุทุฆ
            fixCorruptedDates();

            // ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุชูุงุฑูุฎ
            testDateHandling();

            // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช ุงููุงุฑุบุฉ
            recalculateAllTotals();

            initializeApp();

            // ุชููุฆุฉ ุฃุฒุฑุงุฑ ุงูููุฏุฑ
            setTimeout(() => {
                initializeHeaderButtons();
            }, 100);

            // Initialize Supabase attachments system
            initializeAttachmentsSystem();

            console.log('๐ ุชู ุชููุฆุฉ ุงูุชุทุจูู ุจูุฌุงุญ');
        })
        .catch(error => {
            console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);

            // Fallback to JSON if everything fails
            console.log('๐ ูุญุงููุฉ ุชุญููู ุงูุจูุงูุงุช ูู JSON...');
            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`โ ุชู ุชุญููู ${data.length} ุนูุงุฑ ูู JSON`);
                    properties = data;
                    recalculateAllTotals();
                    initializeApp();
                    setTimeout(() => {
                        initializeHeaderButtons();
                    }, 100);
                })
                .catch(jsonError => {
                    console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช ูู JSON:', jsonError);

                    // ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุฅุฐุง ูุดู ูู ุดูุก
                    console.log('๐ง ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ...');
                    createSampleData();
                    initializeApp();
                });
        });
});

// ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูู ุญุงูุฉ ูุดู ุชุญููู ุงูุจูุงูุงุช
function createSampleData() {
    console.log('๐ง ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุงุฎุชุจุงุฑ...');

    properties = [
        {
            'ุฑูู  ุงููุญุฏุฉ ': 'SAMPLE_001',
            'ุงููุฏููุฉ': 'ุงูุฑูุงุถ',
            'ุงุณู ุงูุนูุงุฑ': 'ุนูุงุฑ ุชุฌุฑูุจู 1',
            'ุงุณู ุงููุณุชุฃุฌุฑ': 'ูุณุชุฃุฌุฑ ุชุฌุฑูุจู 1',
            'ุฑูู ุงูุนูุฏ': 'CONTRACT_001',
            'ูููุฉ  ุงูุงูุฌุงุฑ ': '50000',
            'ุงููุณุงุญุฉ': '150',
            'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ': '01/01/2024',
            'ุชุงุฑูุฎ ุงูููุงูุฉ': '31/12/2024',
            'ุงูุงุฌูุงูู': '57500',
            'ููุน ุงูุนูุฏ': 'ุถุฑูุจู',
            'ุนุฏุฏ ุงูุงูุณุงุท': 3,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู': '01/01/2024',
            'ูุจูุบ ุงููุณุท ุงูุงูู': 19166.67,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู': '01/05/2024',
            'ูุจูุบ ุงููุณุท ุงูุซุงูู': 19166.67,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูุซ': '01/09/2024',
            'ูุจูุบ ุงููุณุท ุงูุซุงูุซ': 19166.66,
            'ุฑูู ุงูุตู': '123456789',
            'ูุณุงุญุฉุงูุตู': '500',
            'ุงูุณุฌู ุงูุนููู ': 'REG-001-2024'
        },
        {
            'ุฑูู  ุงููุญุฏุฉ ': 'SAMPLE_002',
            'ุงููุฏููุฉ': 'ุฌุฏุฉ',
            'ุงุณู ุงูุนูุงุฑ': 'ุนูุงุฑ ุชุฌุฑูุจู 2',
            'ุงุณู ุงููุณุชุฃุฌุฑ': 'ูุณุชุฃุฌุฑ ุชุฌุฑูุจู 2',
            'ุฑูู ุงูุนูุฏ': 'CONTRACT_002',
            'ูููุฉ  ุงูุงูุฌุงุฑ ': '40000',
            'ุงููุณุงุญุฉ': '120',
            'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ': '01/02/2024',
            'ุชุงุฑูุฎ ุงูููุงูุฉ': '31/01/2025',
            'ุงูุงุฌูุงูู': '46000',
            'ููุน ุงูุนูุฏ': 'ุถุฑูุจู',
            'ุนุฏุฏ ุงูุงูุณุงุท': 2,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู': '01/02/2024',
            'ูุจูุบ ุงููุณุท ุงูุงูู': 23000,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู': '01/08/2024',
            'ูุจูุบ ุงููุณุท ุงูุซุงูู': 23000,
            'ุฑูู ุงูุตู': '987654321',
            'ูุณุงุญุฉุงูุตู': '300',
            'ุงูุณุฌู ุงูุนููู ': 'REG-002-2024'
        },
        {
            'ุฑูู  ุงููุญุฏุฉ ': 'SAMPLE_003',
            'ุงููุฏููุฉ': 'ุงูุฏูุงู',
            'ุงุณู ุงูุนูุงุฑ': 'ุนูุงุฑ ุชุฌุฑูุจู 3',
            'ุงุณู ุงููุณุชุฃุฌุฑ': 'ูุณุชุฃุฌุฑ ุชุฌุฑูุจู 3',
            'ุฑูู ุงูุนูุฏ': 'CONTRACT_003',
            'ูููุฉ  ุงูุงูุฌุงุฑ ': '60000',
            'ุงููุณุงุญุฉ': '200',
            'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ': '01/03/2024',
            'ุชุงุฑูุฎ ุงูููุงูุฉ': '28/02/2025',
            'ุงูุงุฌูุงูู': '60000',
            'ููุน ุงูุนูุฏ': 'ุณููู',
            'ุนุฏุฏ ุงูุงูุณุงุท': 4,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู': '01/03/2024',
            'ูุจูุบ ุงููุณุท ุงูุงูู': 15000,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู': '01/06/2024',
            'ูุจูุบ ุงููุณุท ุงูุซุงูู': 15000,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูุซ': '01/09/2024',
            'ูุจูุบ ุงููุณุท ุงูุซุงูุซ': 15000,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุฑุงุจุน': '01/12/2024',
            'ูุจูุบ ุงููุณุท ุงูุฑุงุจุน': 15000,
            'ุฑูู ุงูุตู': '456789123',
            'ูุณุงุญุฉุงูุตู': '800',
            'ุงูุณุฌู ุงูุนููู ': 'REG-003-2024'
        }
    ];

    console.log(`โ ุชู ุฅูุดุงุก ${properties.length} ุนูุงุฑ ุชุฌุฑูุจู`);
}

// ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ
function updateTotalStats() {
    console.log('๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช...');

    if (!properties || properties.length === 0) {
        console.warn('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช');
        return;
    }

    // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุดุงุดุฉ ุงููุจูุฑุฉ
    renderTotals(properties);

    // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุดุงุดุฉ ุงูุตุบูุฑุฉ
    renderMobileTotals(properties);

    console.log('โ ุชู ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช');
}

// ุชููุฆุฉ ุฃุฒุฑุงุฑ ุงููุฏู
function initializeCityButtons() {
    console.log('๐ ุชููุฆุฉ ุฃุฒุฑุงุฑ ุงููุฏู...');
    initCountryButtons();
}

// ุชููุฆุฉ ุงูุจุญุซ
function initializeSearch() {
    console.log('๐ ุชููุฆุฉ ุงูุจุญุซ...');
    initGlobalSearch();
    initPropertySearch();
}

// ุชููุฆุฉ ุงูุชุตููุฉ
function initializeFilters() {
    console.log('๐ ุชููุฆุฉ ุงูุชุตููุฉ...');
    initStatusFilter();
    initDateFilter();
}

// ุชููุฆุฉ ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ููุฌูุงู
function initMobileMenu() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileMenuClose = document.getElementById('mobileMenuClose');
    const menuOverlay = document.getElementById('menuOverlay');
    
    // ูุชุญ ุงููุงุฆูุฉ
    mobileMenuBtn.addEventListener('click', function() {
        mobileMenu.classList.add('active');
        menuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    });
    
    // ุฅุบูุงู ุงููุงุฆูุฉ
    mobileMenuClose.addEventListener('click', function() {
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    // ุฅุบูุงู ุงููุงุฆูุฉ ุนูุฏ ุงูููุฑ ุนูู ุงูุฎูููุฉ
    menuOverlay.addEventListener('click', function() {
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    // ุฃุฒุฑุงุฑ ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
    document.getElementById('mobile-country-btn').addEventListener('click', function() {
        showCountrySelection();
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    document.getElementById('mobile-property-btn').addEventListener('click', function() {
        // ุฅุธูุงุฑ ุงูู sidebar ุจุงูุนูุงุฑุงุช
        toggleSidebar();
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    document.getElementById('mobile-filter-btn').addEventListener('click', function() {
        showStatusFilter();
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    document.getElementById('mobile-view-btn').addEventListener('click', function() {
        showViewToggle();
        mobileMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    document.getElementById('mobile-contract-type-btn').addEventListener('click', function() {
        document.getElementById('mobileMenu').classList.remove('active');
        document.getElementById('menuOverlay').classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('contractTypeFilterBtn').click();
    });
    
    document.getElementById('mobile-date-filter-btn').addEventListener('click', function() {
  showMonthFilterModal();
  document.getElementById('mobileMenu').classList.remove('active');
  document.getElementById('menuOverlay').classList.remove('active');
  document.body.style.overflow = '';
});

    document.getElementById('mobile-property-manager-btn').addEventListener('click', function() {
        showPropertyManager();
        document.getElementById('mobileMenu').classList.remove('active');
        document.getElementById('menuOverlay').classList.remove('active');
        document.body.style.overflow = '';
    });
}

// ุนุฑุถ ุงุฎุชูุงุฑ ุงููุฏููุฉ
function showCountrySelection() {
    const countries = getUniqueCountries();
    let html = '<div class="modal-overlay" style="display:flex;"><div class="modal-box"><button class="close-modal" onclick="closeModal()">ร</button>';
    html += '<h3>ุงุฎุชุฑ ุงููุฏููุฉ</h3><div class="country-selection">';
    
    countries.forEach(country => {
        html += `<button onclick="selectCountry('${country}'); closeModal();" class="${currentCountry === country ? 'active' : ''}">${country}</button>`;
    });
    
    html += '</div></div></div>';
    document.body.insertAdjacentHTML('beforeend', html);
    
    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // ุชูุณูุน ููุทูุฉ ุฅุบูุงู ุงููุงูุฐุฉ ุญูู X
    const closeBtn = document.querySelector('.modal-overlay:last-child .close-modal');
    if (closeBtn) {
        closeBtn.style.padding = '15px';
        closeBtn.style.margin = '-15px';
    }
}

// ุนุฑุถ ููุชุฑ ุงูุญุงูุฉ
function showStatusFilter() {
    // ุฃุถู "ุงููุงุฑุบ" ุฅูู ูุงุฆูุฉ ุงูุญุงูุงุช
    const statuses = ['ุฌุงุฑู', 'ููุชูู', 'ุนูู ูุดู', 'ูุงุฑุบ'];
    let html = '<div class="modal-overlay" style="display:flex;"><div class="modal-box"><button class="close-modal" onclick="closeModal()">ร</button>';
    html += '<h3>ููุชุฑ ุงูุญุงูุฉ</h3><div class="status-filter">';
    
    html += `<button onclick="setStatusFilter(null); closeModal();" class="${filterStatus === null ? 'active' : ''}">ุงููู</button>`;
    statuses.forEach(status => {
        html += `<button onclick="setStatusFilter('${status}'); closeModal();" class="${filterStatus === status ? 'active' : ''}">${status}</button>`;
    });
    
    html += '</div></div></div>';
    document.body.insertAdjacentHTML('beforeend', html);
    
    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // ุชูุณูุน ููุทูุฉ ุฅุบูุงู ุงููุงูุฐุฉ ุญูู X
    const closeBtn = document.querySelector('.modal-overlay:last-child .close-modal');
    if (closeBtn) {
        closeBtn.style.padding = '15px';
        closeBtn.style.margin = '-15px';
    }
}

// ุนุฑุถ ุชุจุฏูู ุทุฑููุฉ ุงูุนุฑุถ
function showViewToggle() {
    let html = '<div class="modal-overlay" style="display:flex;"><div class="modal-box"><button class="close-modal" onclick="closeModal()">ร</button>';
    html += '<h3>ุทุฑููุฉ ุงูุนุฑุถ</h3><div class="view-selection">';
    
    html += `<button onclick="toggleView('table'); closeModal();" class="${currentView === 'table' ? 'active' : ''}"><i class="fas fa-table"></i> ุฌุฏูู</button>`;
    html += `<button onclick="toggleView('cards'); closeModal();" class="${currentView === 'cards' ? 'active' : ''}"><i class="fas fa-th-large"></i> ุจุทุงูุงุช</button>`;
    
    html += '</div></div></div>';
    document.body.insertAdjacentHTML('beforeend', html);
    
    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // ุชูุณูุน ููุทูุฉ ุฅุบูุงู ุงููุงูุฐุฉ ุญูู X
    const closeBtn = document.querySelector('.modal-overlay:last-child .close-modal');
    if (closeBtn) {
        closeBtn.style.padding = '15px';
        closeBtn.style.margin = '-15px';
    }
}

// ุชููุฆุฉ ุงูุชุทุจูู
function initializeApp() {
    console.log('๐ ุจุฏุก ุชููุฆุฉ ุงูุชุทุจูู...');

    // ุชุญููู ุฅุนุฏุงุฏ ุงูุชุฑุชูุจ
    loadSortOrderSetting();

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช
    if (!properties || properties.length === 0) {
        console.warn('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุนุฑุถ ูู initializeApp');

        // ูุญุงููุฉ ุชุญููู ุงูุจูุงูุงุช ูู localStorage
        const localData = localStorage.getItem('properties');
        if (localData) {
            try {
                properties = JSON.parse(localData);
                console.log(`โ ุชู ุชุญููู ${properties.length} ุนูุงุฑ ูู localStorage`);
            } catch (e) {
                console.error('โ ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช localStorage:', e);
                properties = [];
            }
        }

        // ุฅุฐุง ูู ุชูู ููุงู ุจูุงูุงุชุ ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ
        if (!properties || properties.length === 0) {
            console.log('๐ง ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ...');
            createSampleData();
        }
    }

    console.log(`๐ ุนุฏุฏ ุงูุนูุงุฑุงุช ุงููุชุงุญุฉ: ${properties ? properties.length : 0}`);

    // ูุนุงูุฌุฉ ุงูุญุงูุงุช ุงููุงุฑุบุฉ ุชููุงุฆูุงู
    properties.forEach(property => {
        // ุฅุฐุง ูุงู ุงุณู ุงููุณุชุฃุฌุฑ ุฃู ุงููุงูู ูุงุฑุบุ ุงุฌุนู ุงูุญุงูุชูู ูุงุฑุบุชูู
        if (!property['ุงุณู ุงููุณุชุฃุฌุฑ'] || !property['ุงููุงูู']) {
            property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = '';
            property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = '';
            property['isInstallmentEnded'] = false;
            return;
        }

        // ุฅุฐุง ูุงูุช ุงูุญุงูุฉ ุงูููุงุฆูุฉ ุฃู ุงูุฌุฏูุฏุฉ ูุงุฑุบุฉ
        if (!property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] || !property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ']) {
            const today = new Date();
            
            // ุชุญูู ูู ูุฌูุฏ ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท
            const installmentEndDateStr = property['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุทุงูุซุงูู'];
            const endDateStr = property['ุชุงุฑูุฎ ุงูููุงูุฉ'];
            
            // ุฅุฐุง ูู ููู ููุงู ุชุงุฑูุฎ ููุงูุฉุ ุงุฌุนู ุงูุญุงูุฉ ูุงุฑุบุฉ
            if (!endDateStr && !installmentEndDateStr) {
                property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = '';
                property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = '';
                property['isInstallmentEnded'] = false;
                return;
            }
            
            // ุญุณุงุจ ุงูุญุงูุฉ ุจูุงุกู ุนูู ุชุงุฑูุฎ ููุงูุฉ ุงููุณุทุฅุฐุง ูุงู ููุฌูุฏุงู
            if (installmentEndDateStr) {
                // ุฏุนู ุงูุตูุบ dd/mm/yyyy ุฃู dd-mm-yyyy
                const installmentParts = installmentEndDateStr.split(/[\/\-]/);
                if (installmentParts.length === 3) {
                    // ุชุญููู ุชุงุฑูุฎ ููุงูุฉ ุงููุณุทุฅูู ูุงุฆู ุชุงุฑูุฎ
                    let installmentDay, installmentMonth, installmentYear;
                    
                    // ุชุญูู ูู ุตูุบุฉ ุงูุชุงุฑูุฎ (ูุฏ ูููู yyyy-mm-dd ุฃู dd/mm/yyyy)
                    if (installmentEndDateStr.includes('-') && !isNaN(installmentEndDateStr.split('-')[0]) && installmentEndDateStr.split('-')[0].length === 4) {
                        // ุตูุบุฉ yyyy-mm-dd
                        [installmentYear, installmentMonth, installmentDay] = installmentParts.map(Number);
                    } else {
                        // ุตูุบุฉ dd/mm/yyyy ุฃู dd-mm-yyyy
                        [installmentDay, installmentMonth, installmentYear] = installmentParts.map(Number);
                    }
                    
                    const installmentEndDate = new Date(installmentYear, installmentMonth - 1, installmentDay);
                    
                    // ุญุณุงุจ ุงููุฑู ุจุงูุฃูุงู ุจูู ุชุงุฑูุฎ ุงูููู ูุชุงุฑูุฎ ููุงูุฉ ุงููุณุท
                    const installmentDiffDays = Math.floor((installmentEndDate - today) / (1000 * 60 * 60 * 24));
                    
                    // ุชุญูู ูู ูุฌูุฏ ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ
                    let contractEndDate = null;
                    if (endDateStr) {
                        const contractParts = endDateStr.split(/[\/\-]/);
                        if (contractParts.length === 3) {
                            const [contractDay, contractMonth, contractYear] = contractParts.map(Number);
                            contractEndDate = new Date(contractYear, contractMonth - 1, contractDay);
                        }
                    }
                    
                    // ุฅุฐุง ูุงู ุชุงุฑูุฎ ููุงูุฉ ุงููุณุทูุจู ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ ุฃู ูู ููู ููุงู ุชุงุฑูุฎ ููุงูุฉ ููุนูุฏ
                    if (!contractEndDate || installmentEndDate < contractEndDate) {
                        // ุญุณุงุจ ุงูุญุงูุฉ ุจูุงุกู ุนูู ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท
                        if (installmentDiffDays < 0) {
                            // ุฅุฐุง ุงูุชูู ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู ูุงูุนูุฏ ูุง ูุฒุงู ุฌุงุฑููุง
                            if (!contractEndDate || contractEndDate > today) {
                                property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = 'ุฌุงุฑู';
                                property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = 'ุงูุฃูุณุงุท ููุชููุฉ ูุงูุนูุฏ ุฌุงุฑู';
                                property['isInstallmentEnded'] = true;
                                return;
                            } else {
                                property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = 'ููุชูู';
                                property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = `ุงููุณุท ููุชูู ููุฐ ${Math.abs(installmentDiffDays)} ููู ูุงูุชูู ุงูุนูุฏ`;
                                property['isInstallmentEnded'] = false;
                                return;
                            }
                        } else if (installmentDiffDays <= 60) {
                            property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = 'ุนูู ูุดู';
                            property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = `ุงููุณุท ุณููุชูู ุจุนุฏ ${installmentDiffDays} ููู`;
                            property['isInstallmentEnded'] = false;
                            return;
                        }
                    }
                }
            }
            
            // ุฅุฐุง ูู ููู ููุงู ุชุงุฑูุฎ ููุงูุฉ ูุณุท ุฃู ูุงู ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ ูุจู ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท
            // ุงุณุชุฎุฏู ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ
            if (endDateStr) {
                // ุฏุนู ุงูุตูุบ dd/mm/yyyy ุฃู dd-mm-yyyy
                const parts = endDateStr.split(/[\/\-]/);
                if (parts.length !== 3) {
                    property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = '';
                    property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = '';
                    property['isInstallmentEnded'] = false;
                    return;
                }
                // ุชุฑุชูุจ ุงูููู ูุงูุดูุฑ ูุงูุณูุฉ ุญุณุจ ุงูุตูุบุฉ
                const [day, month, year] = parts.map(Number);
                const endDate = new Date(year, month - 1, day);

                // ุญุณุงุจ ุงููุฑู ุจุงูุฃูุงู
                const diffDays = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
                // ูุจู ุงูููุงูุฉ ุจุดูุฑูู = 60 ููู
                if (diffDays < 0) {
                    property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = 'ููุชูู';
                    property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = `ููุชูู ููุฐ ${Math.abs(diffDays)} ููู`;
                    property['isInstallmentEnded'] = false;
                } else if (diffDays <= 60) {
                    property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = 'ุนูู ูุดู';
                    property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = `ุณููุชูู ุจุนุฏ ${diffDays} ููู`;
                    property['isInstallmentEnded'] = false;
                } else {
                    property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] = 'ุฌุงุฑู';
                    property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'] = 'ูุนุงู';
                    property['isInstallmentEnded'] = false;
                }
            }
        }
    });

    // ุชููุฆุฉ ุฃุฒุฑุงุฑ ุงููุฏููุฉุงู
    initCountryButtons();
    
    // ุชููุฆุฉ ูุงุฆูุฉ ุงูุนูุงุฑุงุช
    initPropertyList();
    
    // ุชููุฆุฉ ููุชุฑ ุงูุญุงูุฉ
    initStatusFilter();
    
    // ุชููุฆุฉ ุงูุจุญุซ ุงูุนุงู
    initGlobalSearch();
    
    // ุชููุฆุฉ ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช
    initPropertySearch();
    
    // ุชููุฆุฉ ููุชุฑ ุงูุชุงุฑูุฎ
    initDateFilter();
    
    // ุนุฑุถ ุงูุจูุงูุงุช ุงูุฃูููุฉ
    renderData();

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    updateTotalStats();

    // ุชููุฆุฉ ุงูู sidebar
    initializeSidebar();

    console.log('โ ุชู ุชููุฆุฉ ุงูุชุทุจูู ุจูุฌุงุญ');

    // ุฅุถุงูุฉ ุฒุฑ ุฅุฎูุงุก ุงูุณุงูุฏุจุงุฑ
    const sidebar = document.getElementById('sidebar');
    const hideBtn = document.querySelector('.hide-sidebar-btn');
    if (!hideBtn) {
        const btn = document.createElement('button');
        btn.className = 'hide-sidebar-btn';
        btn.textContent = 'ุฅุฎูุงุก ุงููุงุฆูุฉ';
        btn.onclick = function() {
            toggleSidebar();
        };
        sidebar.appendChild(btn);
    }

    // ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
    setTimeout(() => {
        if (currentUser) {
            console.log('๐ ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ูู initializeApp');
            addLogoutButton();
        }
    }, 500);

    // ููุงุญุธุฉ: ุดุงุดุฉ ุงูุชุญููู ุณุชุฎุชูู ุชููุงุฆูุงู ุจุนุฏ 5 ุซูุงูู ุฃู ุจุนุฏ ุงุฎุชูุงุก ุงูุฅุดุนุงุฑุงุช
}

// ุงูุญุตูู ุนูู ุงููุฏู ุงููุฑูุฏุฉ (ูุญุณู ููุดูู ุงููุฏู ุงููุนุฑูุฉ)
function getUniqueCountries() {
    const countries = new Set();

    // ุฅุถุงูุฉ ุงููุฏู ูู ุงูุนูุงุฑุงุช ุงูููุฌูุฏุฉ
    properties.forEach(property => {
        if (property.ุงููุฏููุฉ) {
            countries.add(property.ุงููุฏููุฉ);
        }
    });

    // ุฅุถุงูุฉ ุงููุฏู ุงููุนุฑูุฉ (ุงููุถุงูุฉ ูุฏููุงู)
    cityDefinitions.forEach(city => {
        countries.add(city);
    });

    return ['ุงููู', ...Array.from(countries).sort()];
}

// ุงูุญุตูู ุนูู ุงูุนูุงุฑุงุช ุงููุฑูุฏุฉ (ูุญุณู ููุดูู ุงูุนูุงุฑุงุช ุงููุนุฑูุฉ)
function getUniqueProperties() {
    const uniqueProperties = new Set();

    // ุฅุถุงูุฉ ุงูุนูุงุฑุงุช ูู ุงููุญุฏุงุช ุงูููุฌูุฏุฉ
    properties.forEach(property => {
        if (property['ุงุณู ุงูุนูุงุฑ']) {
            uniqueProperties.add(property['ุงุณู ุงูุนูุงุฑ']);
        }
    });

    // ุฅุถุงูุฉ ุงูุนูุงุฑุงุช ุงููุนุฑูุฉ (ุงููุถุงูุฉ ูุฏููุงู)
    propertyDefinitions.forEach(propDef => {
        uniqueProperties.add(propDef.name);
    });

    return Array.from(uniqueProperties).sort();
}

// ุชููุฆุฉ ุฃุฒุฑุงุฑ ุงููุฏููุฉุงู
function initCountryButtons() {
    const countries = getUniqueCountries();
    const container = document.getElementById('countryButtons');
    if (!container) {
        console.warn('โ๏ธ ุนูุตุฑ countryButtons ุบูุฑ ููุฌูุฏ');
        return;
    }
    container.innerHTML = '';
    
    countries.forEach(country => {
        const button = document.createElement('button');
        button.textContent = country;
        button.onclick = () => selectCountry(country === 'ุงููู' ? null : country);
        if ((currentCountry === null && country === 'ุงููู') || currentCountry === country) {
            button.classList.add('active');
        }
        container.appendChild(button);
    });
}

// ูุชุบูุฑ ูุญูุธ ุชุฑุชูุจ ุงูุนูุงุฑุงุช ุงูุซุงุจุช
let fixedPropertyOrder = JSON.parse(localStorage.getItem('fixedPropertyOrder')) || [];

// ุชููุฆุฉ ูุงุฆูุฉ ุงูุนูุงุฑุงุช ูุน ุชุฑุชูุจ ุซุงุจุช
function initPropertyList(selectedCountry = null) {
    // โ ุงูุญุตูู ุนูู ุงูุนูุงุฑุงุช ูู ูุตุฏุฑูู: properties ู propertyDefinitions
    const allPropertyNames = new Set();

    // 1. ุฅุถุงูุฉ ุงูุนูุงุฑุงุช ูู ุงููุญุฏุงุช ุงูููุฌูุฏุฉ (properties)
    let filteredProperties = properties;
    if (selectedCountry) {
        filteredProperties = properties.filter(property => property.ุงููุฏููุฉ === selectedCountry);
    }
    filteredProperties.forEach(property => {
        if (property['ุงุณู ุงูุนูุงุฑ'] && property['ุงุณู ุงูุนูุงุฑ'].trim() !== '') {
            allPropertyNames.add(property['ุงุณู ุงูุนูุงุฑ']);
        }
    });

    // 2. ุฅุถุงูุฉ ุงูุนูุงุฑุงุช ูู ุงูุชุนุฑููุงุช (propertyDefinitions) โ
    let filteredDefinitions = propertyDefinitions || [];
    if (selectedCountry) {
        filteredDefinitions = propertyDefinitions.filter(propDef => propDef.city === selectedCountry);
    }
    filteredDefinitions.forEach(propDef => {
        if (propDef.name && propDef.name.trim() !== '') {
            allPropertyNames.add(propDef.name);
        }
    });

    // ุชุญููู ุฅูู ูุตูููุฉ
    const propertyNames = Array.from(allPropertyNames);

    console.log(`๐ ุนุฑุถ ุงูุนูุงุฑุงุช ูููุฏููุฉ "${selectedCountry || 'ุงููู'}": ${propertyNames.length} ุนูุงุฑ`);
    console.log('๐ ูุตุงุฏุฑ ุงูุนูุงุฑุงุช:', {
        fromProperties: filteredProperties.length,
        fromDefinitions: filteredDefinitions.length,
        total: propertyNames.length
    });

    // ุชุทุจูู ุงูุชุฑุชูุจ ุงูุซุงุจุช ููุนูุงุฑุงุช
    const sortedPropertyNames = applySortedPropertyOrder(propertyNames, selectedCountry);

    // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนูุงุฑุงุช ูู ุงูู sidebar
    const container = document.getElementById('propertyList');
    if (!container) {
        console.warn('โ๏ธ ุนูุตุฑ propertyList ุบูุฑ ููุฌูุฏ');
        return;
    }
    container.innerHTML = '';

    sortedPropertyNames.forEach(propertyName => {
        // ุชุฌุงูู ุงูุฃุณูุงุก ุงููุงุฑุบุฉ ุฃู ุบูุฑ ุงููุนุฑูุฉ
        if (!propertyName || propertyName.trim() === '') return;
        const div = document.createElement('div');
        div.textContent = propertyName;
        div.onclick = () => selectProperty(propertyName);
        if (currentProperty === propertyName) {
            div.classList.add('active');
        }
        // ุฅุถุงูุฉ ุชุฃุซูุฑ ุญุฑูู ููุธููุฑ
        div.style.animation = 'slideIn 0.3s ease-out forwards';
        container.appendChild(div);
    });

    // ุฅุถุงูุฉ ุฑุณุงูุฉ ุฅุฐุง ูู ุชูู ููุงู ุนูุงุฑุงุช
    if (sortedPropertyNames.filter(name => name && name.trim() !== '').length === 0) {
        const noProperties = document.createElement('div');
        noProperties.className = 'no-properties';
        noProperties.textContent = 'ูุง ุชูุฌุฏ ุนูุงุฑุงุช ูู ูุฐุง ุงููุฏููุฉ';
        noProperties.style.textAlign = 'center';
        noProperties.style.padding = '1rem';
        noProperties.style.color = '#666';
        container.appendChild(noProperties);
    }
}

// ุฏุงูุฉ ุชุทุจูู ุงูุชุฑุชูุจ ุงูุซุงุจุช ููุนูุงุฑุงุช
function applySortedPropertyOrder(propertyNames, selectedCountry = null) {
    // ุฅูุดุงุก ููุชุงุญ ูุฑูุฏ ูููุฏููุฉ (ุฃู "ุงููู" ููุนุฑุถ ุงูุนุงู)
    const cityKey = selectedCountry || 'ุงููู';

    // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุชุฑุชูุจ ูุญููุธ ููุฐู ุงููุฏููุฉ
    if (!fixedPropertyOrder[cityKey]) {
        fixedPropertyOrder[cityKey] = [];
    }

    const savedOrder = fixedPropertyOrder[cityKey];
    const newProperties = [];
    const sortedProperties = [];

    // ูุตู ุงูุนูุงุฑุงุช ุงูุฌุฏูุฏุฉ ุนู ุงูููุฌูุฏุฉ
    propertyNames.forEach(propertyName => {
        if (propertyName && propertyName.trim() !== '') {
            if (savedOrder.includes(propertyName)) {
                // ุนูุงุฑ ููุฌูุฏ ูู ุงูุชุฑุชูุจ ุงููุญููุธ
                sortedProperties.push(propertyName);
            } else {
                // ุนูุงุฑ ุฌุฏูุฏ
                newProperties.push(propertyName);
            }
        }
    });

    // ุชุฑุชูุจ ุงูุนูุงุฑุงุช ุงูููุฌูุฏุฉ ุญุณุจ ุงูุชุฑุชูุจ ุงููุญููุธ
    sortedProperties.sort((a, b) => {
        const indexA = savedOrder.indexOf(a);
        const indexB = savedOrder.indexOf(b);
        return indexA - indexB;
    });

    // ุชุฑุชูุจ ุงูุนูุงุฑุงุช ุงูุฌุฏูุฏุฉ ุฃุจุฌุฏูุงู
    newProperties.sort();

    // ุฏูุฌ ุงูููุงุฆู: ุงูุนูุงุฑุงุช ุงููุฑุชุจุฉ ุฃููุงูุ ุซู ุงูุฌุฏูุฏุฉ
    const finalOrder = [...sortedProperties, ...newProperties];

    // ุชุญุฏูุซ ุงูุชุฑุชูุจ ุงููุญููุธ
    fixedPropertyOrder[cityKey] = finalOrder;
    localStorage.setItem('fixedPropertyOrder', JSON.stringify(fixedPropertyOrder));

    console.log(`๐ ุชุฑุชูุจ ุงูุนูุงุฑุงุช ููุฏููุฉ "${cityKey}":`, finalOrder);

    return finalOrder;
}

// ุฏุงูุฉ ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงูุนูุงุฑุงุช ูุฏููุงู
function reorderProperties(cityKey, newOrder) {
    if (!fixedPropertyOrder[cityKey]) {
        fixedPropertyOrder[cityKey] = [];
    }

    fixedPropertyOrder[cityKey] = newOrder;
    localStorage.setItem('fixedPropertyOrder', JSON.stringify(fixedPropertyOrder));

    // ุฅุนุงุฏุฉ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนูุงุฑุงุช
    initPropertyList(cityKey === 'ุงููู' ? null : cityKey);

    console.log(`โ ุชู ุชุญุฏูุซ ุชุฑุชูุจ ุงูุนูุงุฑุงุช ููุฏููุฉ "${cityKey}"`);
}

// ุฏุงูุฉ ุฅุนุงุฏุฉ ุชุนููู ุชุฑุชูุจ ุงูุนูุงุฑุงุช
function resetPropertyOrder(cityKey = null) {
    if (cityKey) {
        // ุฅุนุงุฏุฉ ุชุนููู ูุฏููุฉ ูุญุฏุฏุฉ
        delete fixedPropertyOrder[cityKey];
    } else {
        // ุฅุนุงุฏุฉ ุชุนููู ุฌููุน ุงููุฏู
        fixedPropertyOrder = {};
    }

    localStorage.setItem('fixedPropertyOrder', JSON.stringify(fixedPropertyOrder));

    // ุฅุนุงุฏุฉ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนูุงุฑุงุช
    initPropertyList(currentCountry);

    console.log(`๐ ุชู ุฅุนุงุฏุฉ ุชุนููู ุชุฑุชูุจ ุงูุนูุงุฑุงุช${cityKey ? ` ููุฏููุฉ "${cityKey}"` : ' ูุฌููุน ุงููุฏู'}`);
}

// ุฏุงูุฉ ุนุฑุถ ูุงูุฐุฉ ุฅุฏุงุฑุฉ ุชุฑุชูุจ ุงูุนูุงุฑุงุช
function showPropertyOrderManager() {
    const cityKey = currentCountry || 'ุงููู';
    const currentOrder = fixedPropertyOrder[cityKey] || [];

    // โ ุงูุญุตูู ุนูู ุฌููุน ุงูุนูุงุฑุงุช ูู ุงููุฏููุฉ ุงูุญุงููุฉ ูู ูุตุฏุฑูู
    const allPropertyNames = new Set();

    // 1. ูู ุงููุญุฏุงุช ุงูููุฌูุฏุฉ (properties)
    let filteredProperties = properties;
    if (currentCountry) {
        filteredProperties = properties.filter(property => property.ุงููุฏููุฉ === currentCountry);
    }
    filteredProperties.forEach(property => {
        if (property['ุงุณู ุงูุนูุงุฑ'] && property['ุงุณู ุงูุนูุงุฑ'].trim() !== '') {
            allPropertyNames.add(property['ุงุณู ุงูุนูุงุฑ']);
        }
    });

    // 2. ูู ุงูุชุนุฑููุงุช (propertyDefinitions) โ
    let filteredDefinitions = propertyDefinitions || [];
    if (currentCountry) {
        filteredDefinitions = propertyDefinitions.filter(propDef => propDef.city === currentCountry);
    }
    filteredDefinitions.forEach(propDef => {
        if (propDef.name && propDef.name.trim() !== '') {
            allPropertyNames.add(propDef.name);
        }
    });

    const allProperties = Array.from(allPropertyNames);

    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box" style="max-width: 600px;">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <h3><i class="fas fa-sort"></i> ุฅุฏุงุฑุฉ ุชุฑุชูุจ ุงูุนูุงุฑุงุช</h3>
            <p style="color: #666; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i>
                ุงุณุญุจ ุงูุนูุงุฑุงุช ูุฅุนุงุฏุฉ ุชุฑุชูุจูุง. ุงูุชุฑุชูุจ ุณูุจูู ุซุงุจุชุงู ุญุชู ูู ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช.
            </p>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>ุงููุฏููุฉ ุงูุญุงููุฉ:</strong> ${cityKey}
                <br><strong>ุนุฏุฏ ุงูุนูุงุฑุงุช:</strong> ${allProperties.length}
            </div>

            <div id="sortablePropertyList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
    `;

    // ุนุฑุถ ุงูุนูุงุฑุงุช ุจุงูุชุฑุชูุจ ุงูุญุงูู
    const displayOrder = currentOrder.length > 0 ? currentOrder : allProperties.sort();
    displayOrder.forEach((propertyName, index) => {
        if (propertyName && propertyName.trim() !== '') {
            html += `
                <div class="sortable-property-item" data-property="${propertyName}" style="
                    background: white;
                    border: 1px solid #e9ecef;
                    border-radius: 6px;
                    padding: 12px;
                    margin: 8px 0;
                    cursor: move;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    transition: all 0.2s ease;
                ">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-grip-vertical" style="color: #6c757d;"></i>
                        <span style="font-weight: 500;">${index + 1}.</span>
                        <span>${propertyName}</span>
                    </div>
                    <i class="fas fa-building" style="color: #007bff;"></i>
                </div>
            `;
        }
    });

    html += `
            </div>

            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="savePropertyOrder()" class="modal-action-btn print-btn" style="flex: 1;">
                    <i class="fas fa-save"></i> ุญูุธ ุงูุชุฑุชูุจ
                </button>
                <button onclick="resetPropertyOrder('${cityKey}')" class="modal-action-btn" style="flex: 1; background: #ffc107;">
                    <i class="fas fa-undo"></i> ุฅุนุงุฏุฉ ุชุนููู
                </button>
                <button onclick="closeModal()" class="modal-action-btn close-btn" style="flex: 1;">
                    <i class="fas fa-times"></i> ุฅูุบุงุก
                </button>
            </div>
        </div>
    </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);

    // ุชูุนูู ุงูุณุญุจ ูุงูุฅููุงุช
    enablePropertySorting();
}

// ุชูุนูู ุงูุณุญุจ ูุงูุฅููุงุช ููุนูุงุฑุงุช
function enablePropertySorting() {
    const container = document.getElementById('sortablePropertyList');
    const items = container.querySelectorAll('.sortable-property-item');

    let draggedElement = null;

    items.forEach(item => {
        item.draggable = true;

        item.addEventListener('dragstart', function(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', function(e) {
            this.style.opacity = '1';
            draggedElement = null;
        });

        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.style.borderColor = '#007bff';
            this.style.backgroundColor = '#f8f9ff';
        });

        item.addEventListener('dragleave', function(e) {
            this.style.borderColor = '#e9ecef';
            this.style.backgroundColor = 'white';
        });

        item.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#e9ecef';
            this.style.backgroundColor = 'white';

            if (draggedElement && draggedElement !== this) {
                // ุชุญุฏูุฏ ูููุน ุงูุฅุฏุฑุงุฌ
                const rect = this.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;

                if (e.clientY < midpoint) {
                    // ุฅุฏุฑุงุฌ ูุจู ุงูุนูุตุฑ ุงูุญุงูู
                    container.insertBefore(draggedElement, this);
                } else {
                    // ุฅุฏุฑุงุฌ ุจุนุฏ ุงูุนูุตุฑ ุงูุญุงูู
                    container.insertBefore(draggedElement, this.nextSibling);
                }

                // ุชุญุฏูุซ ุฃุฑูุงู ุงูุชุฑุชูุจ
                updatePropertyOrderNumbers();
            }
        });
    });
}

// ุชุญุฏูุซ ุฃุฑูุงู ุงูุชุฑุชูุจ ูู ุงููุงูุฐุฉ
function updatePropertyOrderNumbers() {
    const items = document.querySelectorAll('.sortable-property-item');
    items.forEach((item, index) => {
        const numberSpan = item.querySelector('span');
        numberSpan.textContent = `${index + 1}.`;
    });
}

// ุญูุธ ุงูุชุฑุชูุจ ุงูุฌุฏูุฏ
function savePropertyOrder() {
    const cityKey = currentCountry || 'ุงููู';
    const items = document.querySelectorAll('.sortable-property-item');
    const newOrder = Array.from(items).map(item => item.dataset.property);

    // ุญูุธ ุงูุชุฑุชูุจ ุงูุฌุฏูุฏ
    reorderProperties(cityKey, newOrder);

    // ุฅุบูุงู ุงููุงูุฐุฉ
    closeModal();

    // ุนุฑุถ ุฑุณุงูุฉ ุชุฃููุฏ
    showSuccessMessage(`ุชู ุญูุธ ุชุฑุชูุจ ุงูุนูุงุฑุงุช ููุฏููุฉ "${cityKey}" ุจูุฌุงุญ!`);
}

// ุฏุงูุฉ ุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ
function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
        z-index: 10000;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideInRight 0.3s ease-out;
    `;

    successDiv.innerHTML = `
        <i class="fas fa-check-circle"></i>
        ${message}
    `;

    document.body.appendChild(successDiv);

    // ุฅุฒุงูุฉ ุงูุฑุณุงูุฉ ุจุนุฏ 3 ุซูุงู
    setTimeout(() => {
        successDiv.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 300);
    }, 3000);
}

// ุชููุฆุฉ ููุชุฑ ุงูุญุงูุฉ
function initStatusFilter() {
    const container = document.getElementById('headerFilters');
    container.innerHTML = '';
    
    const button = document.createElement('button');
    button.innerHTML = '<i class="fas fa-filter"></i> ููุชุฑ ุงูุญุงูุฉ';
    button.onclick = showStatusFilter;
    container.appendChild(button);
}

// ุชููุฆุฉ ุงูุจุญุซ ุงูุนุงู
function initGlobalSearch() {
    const searchInput = document.getElementById('globalSearch');
    searchInput.addEventListener('input', renderData);
}

// ุชููุฆุฉ ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช
function initPropertySearch() {
    const searchInput = document.getElementById('propertySearch');
    if (!searchInput) return;

    // ููุน ุฅุบูุงู ุงูุณุงูุฏุจุงุฑ ุนูุฏ ุงูุชูุงุนู ูุน ุงูุจุญุซ
    searchInput.addEventListener('focus', function(e) {
        e.stopPropagation();
        // ุฅุถุงูุฉ ููุงุณ ุญูุงูุฉ ููุณุงูุฏุจุงุฑ
        const sidebar = document.querySelector('aside');
        if (sidebar) {
            sidebar.classList.add('search-active');
        }
    });

    searchInput.addEventListener('blur', function(e) {
        // ุฅุฒุงูุฉ ููุงุณ ุงูุญูุงูุฉ ุจุนุฏ ุชุฃุฎูุฑ ูุตูุฑ
        setTimeout(() => {
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                sidebar.classList.remove('search-active');
            }
        }, 300);
    });

    searchInput.addEventListener('input', function(e) {
        e.stopPropagation(); // ููุน ุงูุชุดุงุฑ ุงูุญุฏุซ
        const searchTerm = this.value.toLowerCase();
        const propertyItems = document.querySelectorAll('#propertyList div');

        propertyItems.forEach(item => {
            const propertyName = item.textContent.toLowerCase();
            if (propertyName.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // ููุน ุฅุบูุงู ุงูุณุงูุฏุจุงุฑ ุนูุฏ ุงูููุฑ ุนูู ุงูุจุญุซ
    searchInput.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    searchInput.addEventListener('touchstart', function(e) {
        e.stopPropagation();
    });
}

// ุงุฎุชูุงุฑ ุจูุฏ
function selectCountry(country) {
    // ุนูุฏ ุงุฎุชูุงุฑ "ุงููู" ุฃุฒู ูู ุงูููุงุชุฑ
    if (!country || country === 'ุงููู') {
        currentCountry = null;
        currentProperty = null;
    } else {
        // ุฅุฐุง ุชู ุงุฎุชูุงุฑ ุจูุฏ ุฌุฏูุฏ ุฃุฒู ููุชุฑ ุงูุนูุงุฑ
        if (currentCountry !== country) {
            currentCountry = country;
            currentProperty = null;
        } else {
            // ุฅุฐุง ุชู ุงูุถุบุท ุนูู ููุณ ุงููุฏููุฉ ูุฑุฉ ุฃุฎุฑู ุฃุฒู ููุชุฑ ุงูุนูุงุฑ ููุท
            currentProperty = null;
        }
    }
    initCountryButtons();
    initPropertyList(currentCountry);
    renderData();
}

// ุงุฎุชูุงุฑ ุนูุงุฑ
function selectProperty(propertyName) {
    // ุฅุฐุง ุชู ุงุฎุชูุงุฑ ููุณ ุงูุนูุงุฑ ุฃุฒู ุงูููุชุฑ
    if (currentProperty === propertyName) {
        currentProperty = null;
    } else {
        currentProperty = propertyName;
    }
    // ุชุญุฏูุซ ุชูููุฒ ุงูุนูุงุฑ ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
    initPropertyList(currentCountry);
    renderData();
    // ุฅุฎูุงุก ุงูุณุงูุฏุจุงุฑ ุชููุงุฆูุงู ุจุนุฏ ุงุฎุชูุงุฑ ุนูุงุฑ (ููุท ุนูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ)
    const sidebar = document.getElementById('sidebar');
    if (window.innerWidth <= 900) {
        sidebar.classList.remove('active');
    }
}

// ุชุนููู ููุชุฑ ุงูุญุงูุฉ
function setStatusFilter(status) {
    filterStatus = status;
    renderData();
}

// ุชุจุฏูู ุทุฑููุฉ ุงูุนุฑุถ
function toggleView(view) {
    currentView = view;
    
    const tableBtn = document.getElementById('table-btn');
    const cardsBtn = document.getElementById('cards-btn');
    
    if (view === 'table') {
        tableBtn.classList.add('active');
        cardsBtn.classList.remove('active');
    } else {
        tableBtn.classList.remove('active');
        cardsBtn.classList.add('active');
    }
    
    renderData();
}

// ุชุจุฏูู ุนุฑุถ ุงูุดุฑูุท ุงูุฌุงูุจู
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const searchInput = document.getElementById('propertySearch');

    // ูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ ููุท
    if (window.innerWidth <= 900) {
        // ุงูุชุญูู ูู ุญุงูุฉ ุงูุจุญุซ ุงููุดุท
        if (sidebar.classList.contains('search-active') ||
            (searchInput && document.activeElement === searchInput)) {
            // ูุง ุชุบูู ุงูุณุงูุฏุจุงุฑ ุฅุฐุง ูุงู ุงูุจุญุซ ูุดุทุงู
            console.log('๐ ููุน ุฅุบูุงู ุงูุณุงูุฏุจุงุฑ - ุงูุจุญุซ ูุดุท');
            return;
        }

        sidebar.classList.toggle('active');
    }
    // ูู ุงูุดุงุดุงุช ุงููุจูุฑุฉ ุงูู sidebar ุฏุงุฆูุงู ุธุงูุฑ
}


// ุชููุฆุฉ ุงูู sidebar ุญุณุจ ุญุฌู ุงูุดุงุดุฉ
function initializeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const main = document.querySelector('main');
    const footer = document.querySelector('footer');

    if (window.innerWidth > 900) {
        // ูู ุงูุดุงุดุงุช ุงููุจูุฑุฉ: ุงูู sidebar ุฏุงุฆูุงู ุธุงูุฑ
        sidebar.classList.add('active');

        // ุชุทุจูู ุงูุฃููุงุท ูุจุงุดุฑุฉ ููุชุฃูุฏ
        sidebar.style.position = 'fixed';
        sidebar.style.top = '70px';
        sidebar.style.right = '0';
        sidebar.style.width = '280px';
        sidebar.style.height = 'calc(100vh - 70px)';
        sidebar.style.transform = 'translateX(0)';
        sidebar.style.zIndex = '900';
        sidebar.style.backgroundColor = 'white';
        sidebar.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';
        sidebar.style.overflowY = 'auto';
        sidebar.style.padding = '1rem';

        document.body.classList.add('desktop-layout');

        // ุงูุชุฃูุฏ ูู ุงูููุงูุด ุงูุตุญูุญุฉ
        if (main) {
            main.style.marginRight = '280px';
            main.style.marginLeft = '20px';
            main.style.width = 'calc(100vw - 320px)';
            main.style.boxSizing = 'border-box';
        }
        if (footer) {
            footer.style.marginRight = '280px';
            footer.style.marginLeft = '20px';
            footer.style.width = 'calc(100vw - 320px)';
            footer.style.boxSizing = 'border-box';
        }
    } else {
        // ูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ: ุงูู sidebar ูุฎูู ุงูุชุฑุงุถูุงู
        sidebar.classList.remove('active');

        // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃููุงุท ููุดุงุดุงุช ุงูุตุบูุฑุฉ
        sidebar.style.position = 'fixed';
        sidebar.style.top = '0';
        sidebar.style.right = '0';
        sidebar.style.width = '100%';
        sidebar.style.height = '100vh';
        sidebar.style.transform = 'translateX(100%)';
        sidebar.style.zIndex = '1500';

        document.body.classList.remove('desktop-layout');

        // ุฅุฒุงูุฉ ุงูููุงูุด ูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ
        if (main) {
            main.style.marginRight = '0';
            main.style.marginLeft = '0';
            main.style.width = '100%';

            // ุชุญุณูู padding ุญุณุจ ุญุฌู ุงูุดุงุดุฉ ูุน ููุงูุด ุฌุงูุจูุฉ
            if (window.innerWidth <= 480) {
                main.style.padding = '0.5rem 0.75rem';
            } else if (window.innerWidth <= 360) {
                main.style.padding = '0.5rem 0.75rem';
            } else {
                main.style.padding = '1rem 0.75rem';
            }
        }
        if (footer) {
            footer.style.marginRight = '0';
            footer.style.marginLeft = '0';
            footer.style.width = '100%';
        }
    }
}

// ูุณุชูุน ูุชุบููุฑ ุญุฌู ุงูุดุงุดุฉ
window.addEventListener('resize', function() {
    initializeSidebar();
});

// ุญูุงูุฉ ุงูุณุงูุฏุจุงุฑ ูู ุงูุฅุบูุงู ุฃุซูุงุก ุงูุจุญุซ
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const searchInput = document.getElementById('propertySearch');

    // ุฅุฐุง ูุงู ุงูููุฑ ุฎุงุฑุฌ ุงูุณุงูุฏุจุงุฑ ูููุณ ุนูู ุฒุฑ ุงูุชุจุฏูู
    if (sidebar && !sidebar.contains(e.target) &&
        !e.target.closest('.toggle-sidebar-btn') &&
        !e.target.closest('#mobile-property-btn') &&
        window.innerWidth <= 900) {

        // ุงูุชุญูู ูู ุญุงูุฉ ุงูุจุญุซ ุงููุดุท
        if (sidebar.classList.contains('search-active') ||
            (searchInput && document.activeElement === searchInput)) {
            // ูุง ุชุบูู ุงูุณุงูุฏุจุงุฑ ุฅุฐุง ูุงู ุงูุจุญุซ ูุดุทุงู
            console.log('๐ ููุน ุฅุบูุงู ุงูุณุงูุฏุจุงุฑ - ุงูุจุญุซ ูุดุท');
            return;
        }

        // ุฅุบูุงู ุงูุณุงูุฏุจุงุฑ ููุท ุฅุฐุง ูู ููู ุงูุจุญุซ ูุดุทุงู
        sidebar.classList.remove('active');
    }
});

// ุญูุงูุฉ ุฅุถุงููุฉ ููุจุญุซ ูู ุฃุญุฏุงุซ ุงูููุณ
document.addEventListener('touchstart', function(e) {
    const sidebar = document.getElementById('sidebar');
    const searchInput = document.getElementById('propertySearch');

    // ุฅุฐุง ูุงู ุงูููุณ ุนูู ุงูุจุญุซุ ููุน ุฅุบูุงู ุงูุณุงูุฏุจุงุฑ
    if (searchInput && (e.target === searchInput || searchInput.contains(e.target))) {
        e.stopPropagation();
        if (sidebar) {
            sidebar.classList.add('search-active');
        }
    }
});

// ุชููุฆุฉ ููุชุฑ ุงูุชุงุฑูุฎ
function initDateFilter() {
  // ุชููุฆุฉ ููุงุฆู ุงูุชุงุฑูุฎ
  const yearSelect = document.getElementById('filterYear');
  const monthSelect = document.getElementById('filterMonth');
  const daySelect = document.getElementById('filterDay');
  
  // ุฅุถุงูุฉ ุงูุณููุงุช
  for (let year = 2020; year <= 2100; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
  
  // ุฅุถุงูุฉ ุงูุฃุดูุฑ
  const months = [
    'ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฅุจุฑูู', 'ูุงูู', 'ููููู',
    'ููููู', 'ุฃุบุณุทุณ', 'ุณุจุชูุจุฑ', 'ุฃูุชูุจุฑ', 'ููููุจุฑ', 'ุฏูุณูุจุฑ'
  ];
  months.forEach((month, index) => {
    const option = document.createElement('option');
    option.value = index + 1;
    option.textContent = month;
    monthSelect.appendChild(option);
  });
  
  // ุฅุถุงูุฉ ุงูุฃูุงู
  for (let day = 1; day <= 31; day++) {
    const option = document.createElement('option');
    option.value = day;
    option.textContent = day;
    daySelect.appendChild(option);
  }
  
  // ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ
  document.querySelector('.apply-filter-btn').addEventListener('click', applyDateFilter);
  document.querySelector('.clear-filter-btn').addEventListener('click', clearDateFilter);
  
  // ุฅุถุงูุฉ ุญุฏุซ ุชุบููุฑ ููุน ุงูุชุงุฑูุฎ
  document.getElementById('filterType').addEventListener('change', updateDateFilterOptions);
}

// ุชุญุฏูุซ ุฎูุงุฑุงุช ููุชุฑ ุงูุชุงุฑูุฎ
function updateDateFilterOptions() {
  dateFilterType = document.getElementById('filterType').value;
  renderData();
}

// ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ
function applyDateFilter() {
  dateFilterType = document.getElementById('filterType').value;
  dateFilterDay = document.getElementById('filterDay').value;
  dateFilterMonth = document.getElementById('filterMonth').value;
  dateFilterYear = document.getElementById('filterYear').value;
  
  renderData();
}

// ูุณุญ ููุชุฑ ุงูุชุงุฑูุฎ
function clearDateFilter() {
  dateFilterType = '';
  dateFilterDay = '';
  dateFilterMonth = '';
  dateFilterYear = '';
  
  document.getElementById('filterType').value = '';
  document.getElementById('filterDay').value = '';
  document.getElementById('filterMonth').value = '';
  document.getElementById('filterYear').value = '';
  
  renderData();
}

// ุชุนุฏูู ุฏุงูุฉ ุชุตููุฉ ุงูุจูุงูุงุช
function renderData() {
  // ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช
  if (!properties || properties.length === 0) {
    console.warn('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุนุฑุถ');
    const container = document.getElementById('content');
    if (container) {
      container.innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #666;">
          <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: #f39c12;"></i>
          <h3>ูุง ุชูุฌุฏ ุจูุงูุงุช ููุนุฑุถ</h3>
          <p>ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ุฃู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ</p>
          <button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 1rem;">
            ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
          </button>
        </div>
      `;
    }
    return;
  }

  let filteredData = properties;

  // ููุชุฑ ุงูุชุงุฑูุฎ ุดุงูู ุฌููุน ุชูุงุฑูุฎ ุงูุจุฏุงูุฉ ุฃู ุงูููุงูุฉ ูุงูุฃูุณุงุท
  if (dateFilterType && (dateFilterDay || dateFilterMonth || dateFilterYear)) {
    filteredData = filteredData.filter(property => {
      let datesToCheck = [];

      if (dateFilterType === 'start') {
        // ูุดูู ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุฌููุน ุชูุงุฑูุฎ ุงูุฃูุณุงุท
        if (property['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']) datesToCheck.push(property['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']);
        // ุฌููุน ุชูุงุฑูุฎ ุงูุฃูุณุงุท (ูุฏุนู: ุชุงุฑูุฎ ุงููุณุท ุงูุงููุ ุงูุซุงููุ ุงูุซุงูุซ ... ุงูุฎ)
        Object.keys(property).forEach(key => {
          if (/^ุชุงุฑูุฎ ุงููุณุท( |_)?(ุงูุงูู|ุงูุซุงูู|ุงูุซุงูุซ|ุงูุฑุงุจุน|ุงูุฎุงูุณ|ุงูุณุงุฏุณ|\d+)$/i.test(key) && property[key]) {
            datesToCheck.push(property[key]);
          }
        });
      } else if (dateFilterType === 'end') {
        // ูุดูู ุชุงุฑูุฎ ุงูููุงูุฉ ูุชุงุฑูุฎ ููุงูุฉ ุงููุณุท
        if (property['ุชุงุฑูุฎ ุงูููุงูุฉ']) datesToCheck.push(property['ุชุงุฑูุฎ ุงูููุงูุฉ']);
        if (property['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']) datesToCheck.push(property['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']);
      }

      if (datesToCheck.length === 0) return false;

      // ุฅุฐุง ุฃู ุชุงุฑูุฎ ูู ุงููุฌููุนุฉ ูุทุงุจู ุงูููุชุฑ ุงุนุชุจุฑ ุงูุนูุงุฑ ูุทุงุจู
      return datesToCheck.some(dateStr => {
        const date = parseDate(dateStr);
        if (!date) return false;
        if (dateFilterYear && date.getFullYear() !== parseInt(dateFilterYear)) return false;
        if (dateFilterMonth && (date.getMonth() + 1) !== parseInt(dateFilterMonth)) return false;
        if (dateFilterDay && date.getDate() !== parseInt(dateFilterDay)) return false;
        return true;
      });
    });
  }
  
  // ุชุตููุฉ ุงูุจูุงูุงุช ุญุณุจ ุงููุฏููุฉ
  if (currentCountry) {
    filteredData = filteredData.filter(property => property.ุงููุฏููุฉ === currentCountry);
  }
  
  // ุชุตููุฉ ุงูุจูุงูุงุช ุญุณุจ ุงูุนูุงุฑ
  if (currentProperty) {
    filteredData = filteredData.filter(property => property['ุงุณู ุงูุนูุงุฑ'] === currentProperty);
  }
  
  // ุชุตููุฉ ุงูุจูุงูุงุช ุญุณุจ ุงูุญุงูุฉ
  if (filterStatus) {
    filteredData = filteredData.filter(property => {
      const status = calculateStatus(property);
      return status.final === filterStatus;
    });
  }
  
  // ุชุตููุฉ ุงูุจูุงูุงุช ุญุณุจ ุงูุจุญุซ ุงูุนุงู
  const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
  if (searchTerm) {
    filteredData = filteredData.filter(property => {
      return Object.values(property).some(value => 
        value && value.toString().toLowerCase().includes(searchTerm)
      );
    });
  }
  
  // ุชุตููุฉ ุงูุจูุงูุงุช ุญุณุจ ููุน ุงูุนูุฏ
  if (contractTypeFilter) {
    filteredData = filteredData.filter(property => property['ููุน ุงูุนูุฏ'] === contractTypeFilter);
  }
  
  // ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
  renderTotals(filteredData);
  renderMobileTotals(filteredData);
  
  // ุนุฑุถ ุงูุจูุงูุงุช ุญุณุจ ุทุฑููุฉ ุงูุนุฑุถ
  if (currentView === 'table') {
    renderTable(filteredData);
  } else {
    renderCards(filteredData);
  }
  
  // ุชุญุฏูุซ ุนุฏุงุฏุงุช ุงููุงุฆูุฉ ุงููุชูููุฉ
  updateMobileMenuCounts(filteredData);
}

// ุชุญุฏูุซ ุนุฏุงุฏุงุช ุงููุงุฆูุฉ ุงููุชูููุฉ
function updateMobileMenuCounts(data) {
    // ุนุฏุฏ ุงููุฏููุฉุงู
    const countries = new Set();
    properties.forEach(property => {
        if (property.ุงููุฏููุฉ) {
            countries.add(property.ุงููุฏููุฉ);
        }
    });
    document.getElementById('countryCount').textContent = countries.size;
    
    // ุนุฏุฏ ุงูุนูุงุฑุงุช
    const uniqueProperties = new Set();
    data.forEach(property => {
        if (property['ุงุณู ุงูุนูุงุฑ']) {
            uniqueProperties.add(property['ุงุณู ุงูุนูุงุฑ']);
        }
    });
    document.getElementById('propertyCount').textContent = uniqueProperties.size;
    
    // ุนุฏุฏ ุงูููุงุชุฑ ุงููุดุทุฉ
    let filterCount = 0;
    if (currentCountry) filterCount++;
    if (currentProperty) filterCount++;
    if (filterStatus) filterCount++;
    document.getElementById('filterCount').textContent = filterCount || '';
}

// ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช - ูุน ุญุณุงุจ ุฐูู ููุฅุฌูุงูู
function renderTotals(data) {
    const container = document.getElementById('totalContainer');
    container.innerHTML = '';

    const today = new Date();
    let countEmpty = 0, countExpired = 0, countPending = 0, countActive = 0;
    let totalCommercial = 0, totalResidential = 0;
    let tenantsCount = 0;

    // ุชุฌููุน ุงูุนููุฏ ุงููุฑูุฏุฉ ุญุณุจ ุฑูู ุงูุนูุฏ
    const uniqueContracts = {};

    data.forEach(property => {
        // ูููุญุฏุงุช ุงููุงุฑุบุฉ
        if (!property['ุงุณู ุงููุณุชุฃุฌุฑ'] || property['ุงุณู ุงููุณุชุฃุฌุฑ'].toString().trim() === '') {
            countEmpty++;
            return;
        }

        // ุงุณุชุฎุฏู ุฑูู ุงูุนูุฏ ูููุชุงุญ ูุฑูุฏ
        const contractKey = property['ุฑูู ุงูุนูุฏ'];

        // ุฅุฐุง ูู ูุชู ูุนุงูุฌุฉ ูุฐุง ุงูุนูุฏ ูู ูุจู
        if (!uniqueContracts[contractKey]) {
            uniqueContracts[contractKey] = true;
            tenantsCount++;

            // ุญุณุงุจ ุงูุฅุฌูุงูู ุจุทุฑููุฉ ุฐููุฉ
            const smartTotal = calculateSmartTotal(property);
            const totalAmount = smartTotal.amount;

            if (property['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู') {
                totalCommercial += totalAmount;
            } else {
                totalResidential += totalAmount;
            }
        }

        // ุญุณุงุจ ุงูุญุงูุงุช
        const status = calculateStatus(property);
        if (status.final === 'ุฌุงุฑู') {
            countActive++;
        } else if (status.final === 'ููุชูู') {
            countExpired++;
        } else if (status.final === 'ุนูู ูุดู') {
            countPending++;
        }
    });

    // ุญุณุงุจ ุนุฏุฏ ุงููุญุฏุงุช ุงููุนูู (ุจุฏูู ุชูุฑุงุฑ)
    const uniqueUnits = new Set();
    data.forEach(property => {
        const unitKey = `${property['ุงุณู ุงูุนูุงุฑ']}_${property['ุฑูู  ุงููุญุฏุฉ ']}`;
        if (property['ุฑูู  ุงููุญุฏุฉ '] && property['ุฑูู  ุงููุญุฏุฉ '].toString().trim() !== '') {
            uniqueUnits.add(unitKey);
        }
    });

    const totalUnits = uniqueUnits.size;
    const activeCount = totalUnits - countEmpty;
    const taxableBase = totalCommercial / 1.15;
    const vat = taxableBase * 0.15;
    const afterTaxCommercial = taxableBase + vat;

    // ุฅูุดุงุก 3 ุจุทุงูุงุช ุฅุญุตุงุฆูุงุช ููุดุงุดุงุช ุงููุจูุฑุฉ
    if (window.innerWidth > 900) {
        // ุงูุจุทุงูุฉ ุงูุฃููู: ุฅุญุตุงุฆูุงุช ุงููุญุฏุงุช
        const unitsCard = document.createElement('div');
        unitsCard.className = 'total-card';
        unitsCard.innerHTML = `
            <h3><i class="fas fa-building"></i> ุฅุญุตุงุฆูุงุช ุงููุญุฏุงุช</h3>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value">${totalUnits}</div>
                    <div class="stat-label">ุนุฏุฏ ุงููุญุฏุงุช</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${tenantsCount}</div>
                    <div class="stat-label">ุนุฏุฏ ุงููุณุชุฃุฌุฑูู</div>
                </div>
                <div class="stat-item clickable-empty-units" style="cursor: pointer;">
                    <div class="stat-value">${countEmpty}</div>
                    <div class="stat-label">ุงููุญุฏุงุช ุงููุงุฑุบุฉ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${activeCount}</div>
                    <div class="stat-label">ุงููุญุฏุงุช ุงููุคุฌุฑุฉ</div>
                </div>
            </div>
        `;
        container.appendChild(unitsCard);

        // ุงูุจุทุงูุฉ ุงูุซุงููุฉ: ุญุงูุงุช ุงูุนููุฏ
        const statusCard = document.createElement('div');
        statusCard.className = 'total-card';
        statusCard.innerHTML = `
            <h3><i class="fas fa-chart-pie"></i> ุญุงูุงุช ุงูุนููุฏ</h3>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value" style="color: #28a745;">${countActive}</div>
                    <div class="stat-label">ุงูุฌุงุฑู</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #dc3545;">${countExpired}</div>
                    <div class="stat-label">ุงูููุชูู</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #fd7e14;">${countPending}</div>
                    <div class="stat-label">ุนูู ูุดู</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #6c757d;">${countEmpty}</div>
                    <div class="stat-label">ูุงุฑุบ</div>
                </div>
            </div>
        `;
        container.appendChild(statusCard);

        // ุงูุจุทุงูุฉ ุงูุซุงูุซุฉ: ุงูุฅุฌูุงููุงุช ุงููุงููุฉ
        const financialCard = document.createElement('div');
        financialCard.className = 'total-card';
        financialCard.innerHTML = `
            <h3><i class="fas fa-money-bill-wave"></i> ุงูุฅุฌูุงููุงุช ุงููุงููุฉ</h3>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value" style="color: #2a4b9b;">${taxableBase.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="stat-label">ุชุฌุงุฑู ูุจู ุงูุถุฑูุจุฉ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #e46e6d;">${vat.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="stat-label">ุถุฑูุจุฉ ุงูุชุฌุงุฑู</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #05940e;">${afterTaxCommercial.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="stat-label">ุชุฌุงุฑู ุจุนุฏ ุงูุถุฑูุจุฉ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #f59e42;">${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="stat-label">ุฅุฌูุงูู ุณููู</div>
                </div>
            </div>
        `;
        container.appendChild(financialCard);

        // ููุงุญุธุฉ: ุชู ุฅุฒุงูุฉ ุนุฑุถ ูุนูููุงุช ุงูุตู ูู ุงูุจุทุงูุงุช ูุชุฌูุจ ุงูุชูุฑุงุฑ
        // ูุนูููุงุช ุงูุตู ุชุธูุฑ ููุท ูู ูุณู ุงูุฅุญุตุงุฆูุงุช
    } else {
        // ููุดุงุดุงุช ุงูุตุบูุฑุฉ: ุงุณุชุฎุฏู ุงูุชุตููู ุงููุฏูู
        addTotalItem(container, 'ุนุฏุฏ ุงููุญุฏุงุช', totalUnits, 'units-stat');
        addTotalItem(container, 'ุนุฏุฏ ุงููุณุชุฃุฌุฑูู', tenantsCount, 'tenants-stat');
        addTotalItem(container, 'ุนุฏุฏ ุงููุญุฏุงุช ุงููุงุฑุบุฉ', `<i class=\"fas fa-minus-circle\"></i> ${countEmpty}`, 'empty-stat clickable-empty-units');
        addTotalItem(container, 'ุงูุฌุงุฑู', activeCount, 'active-stat');
        addTotalItem(container, 'ุงูููุชูู', countExpired, 'expired-stat');
        addTotalItem(container, 'ุนูู ูุดู', countPending, 'pending-stat');
        addTotalItem(container, 'ุฅุฌูุงูู ุชุฌุงุฑู ูุจู ุงูุถุฑูุจุฉ', `<i class=\"fas fa-cash-register\" style=\"color:#2a4b9b;\"></i> ${taxableBase.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู`, 'taxable-base-stat');
        addTotalItem(container, 'ุถุฑูุจุฉ ุงูุชุฌุงุฑู', `<i class=\"fas fa-receipt\" style=\"color:#e46e6d;\"></i> ${vat.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู`, 'vat-stat');
        addTotalItem(container, 'ุฅุฌูุงูู ุชุฌุงุฑู ุจุนุฏ ุงูุถุฑูุจุฉ', `<i class=\"fas fa-coins\" style=\"color:#05940e;\"></i> ${afterTaxCommercial.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู`, 'after-taxonly-stat');
        addTotalItem(container, 'ุฅุฌูุงูู ุณููู', `<i class=\"fas fa-home\" style=\"color:#f59e42;\"></i> ${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู`, 'residential-stat');
    }
    // ุฑูู ุงูุตู ููุณุงุญุฉ ุงูุตู ุนูุฏ ุชุญุฏูุฏ ุนูุงุฑ
    const uniqueContractsList = {};
    data.forEach(property => {
        if (property['ุฑูู ุงูุนูุฏ'] && property['ุงุณู ุงูุนูุงุฑ']) {
            const key = `${property['ุฑูู ุงูุนูุฏ']}_${property['ุงุณู ุงูุนูุงุฑ']}`;
            if (!uniqueContractsList[key]) uniqueContractsList[key] = property;
        }
    });
    const uniqueList = Object.values(uniqueContractsList);
    if (currentProperty) {
        const firstDeedNumber = uniqueList.find(p => p['ุฑูู ุงูุตู'] && p['ุฑูู ุงูุตู'].toString().trim() !== '');
        if (firstDeedNumber && firstDeedNumber['ุฑูู ุงูุตู']) {
            addTotalItem(container, 'ุฑูู ุงูุตู', `<i class=\"fas fa-file-alt\"></i> ${firstDeedNumber['ุฑูู ุงูุตู']}`, 'deed-number-stat');
        }
        const firstDeedArea = uniqueList.find(p => p['ูุณุงุญุฉุงูุตู'] && !isNaN(parseFloat(p['ูุณุงุญุฉุงูุตู'])));
        if (firstDeedArea && firstDeedArea['ูุณุงุญุฉุงูุตู']) {
            addTotalItem(container, 'ูุณุงุญุฉ ุงูุตู', `<i class=\"fas fa-ruler-combined\"></i> ${parseFloat(firstDeedArea['ูุณุงุญุฉุงูุตู']).toLocaleString()} ูยฒ`, 'deed-area-stat');
        }
        // ุฅุถุงูุฉ ุงูุณุฌู ุงูุนููู
        const firstSijil = uniqueList.find(p => p['ุงูุณุฌู ุงูุนููู '] && p['ุงูุณุฌู ุงูุนููู '].toString().trim() !== '');
        if (firstSijil && firstSijil['ุงูุณุฌู ุงูุนููู ']) {
            addTotalItem(container, 'ุงูุณุฌู ุงูุนููู', `<i class=\"fas fa-book\"></i> ${firstSijil['ุงูุณุฌู ุงูุนููู '].toString().trim()}`, 'deed-area-stat');
        }
    }
}

// ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ููุฌูุงู - ูุน ุญุณุงุจ ุฐูู ููุฅุฌูุงูู
function renderMobileTotals(data) {
    const container = document.getElementById('mobileTotals');
    container.innerHTML = '';

    // ุญุณุงุจ ููุณ ุงูุฅุญุตุงุฆูุงุช ููุง ูู ุงูุดุงุดุฉ ุงููุจูุฑุฉ
    const today = new Date();
    let countEmpty = 0, countExpired = 0, countPending = 0;
    let totalCommercial = 0, totalResidential = 0;
    let tenantsCount = 0;

    // ุชุฌููุน ุงูุนููุฏ ุงููุฑูุฏุฉ
    const uniqueContracts = {};

    data.forEach(property => {
        if (!property['ุงุณู ุงููุณุชุฃุฌุฑ'] || property['ุงุณู ุงููุณุชุฃุฌุฑ'].toString().trim() === '') {
            countEmpty++;
            return;
        }

        const contractKey = property['ุฑูู ุงูุนูุฏ'];
        if (!uniqueContracts[contractKey]) {
            uniqueContracts[contractKey] = true;
            tenantsCount++;

            // ุญุณุงุจ ุงูุฅุฌูุงูู ุจุทุฑููุฉ ุฐููุฉ
            const smartTotal = calculateSmartTotal(property);
            const totalAmount = smartTotal.amount;

            if (property['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู') {
                totalCommercial += totalAmount;
            } else {
                totalResidential += totalAmount;
            }
        }

        const endDateStr = property['ุชุงุฑูุฎ ุงูููุงูุฉ'];
        if (endDateStr) {
            const parts = endDateStr.split(/[\/\-]/);
            if (parts.length === 3) {
                const [day, month, year] = parts.map(Number);
                const endDate = new Date(year, month - 1, day);
                const diffDays = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
                if (diffDays < 0) {
                    countExpired++;
                } else if (diffDays <= 60) {
                    countPending++;
                }
            }
        }
    });

    // ุญุณุงุจ ุนุฏุฏ ุงููุญุฏุงุช ุงููุนูู (ุจุฏูู ุชูุฑุงุฑ) ููููุจุงูู
    const uniqueUnits = new Set();
    data.forEach(property => {
        const unitKey = `${property['ุงุณู ุงูุนูุงุฑ']}_${property['ุฑูู  ุงููุญุฏุฉ ']}`;
        if (property['ุฑูู  ุงููุญุฏุฉ '] && property['ุฑูู  ุงููุญุฏุฉ '].toString().trim() !== '') {
            uniqueUnits.add(unitKey);
        }
    });

    const totalUnits = uniqueUnits.size;
    const activeCount = totalUnits - countEmpty;
    const taxableBase = totalCommercial / 1.15;
    const vat = taxableBase * 0.15;
    const afterTaxCommercial = taxableBase + vat;

    // ุฅุถุงูุฉ ููุณ ุงูุฅุญุตุงุฆูุงุช ููููุจุงูู
    addTotalItem(container, 'ุนุฏุฏ ุงููุญุฏุงุช', totalUnits, 'units-stat');
    addTotalItem(container, 'ุนุฏุฏ ุงููุณุชุฃุฌุฑูู', tenantsCount, 'tenants-stat');
    addTotalItem(container, 'ุนุฏุฏ ุงููุญุฏุงุช ุงููุงุฑุบุฉ', `<i class="fas fa-minus-circle"></i> ${countEmpty}`, 'empty-stat clickable-empty-units');
    addTotalItem(container, 'ุงูุฌุงุฑู', activeCount, 'active-stat');
    addTotalItem(container, 'ุงูููุชูู', countExpired, 'expired-stat');
    addTotalItem(container, 'ุนูู ูุดู', countPending, 'pending-stat');
    addTotalItem(container, 'ุฅุฌูุงูู ุชุฌุงุฑู ูุจู ุงูุถุฑูุจุฉ', `<i class="fas fa-cash-register" style="color:#2a4b9b;"></i> ${taxableBase.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู`, 'taxable-base-stat');
    addTotalItem(container, 'ุถุฑูุจุฉ ุงูุชุฌุงุฑู', `<i class="fas fa-receipt" style="color:#e46e6d;"></i> ${vat.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู`, 'vat-stat');
    addTotalItem(container, 'ุฅุฌูุงูู ุชุฌุงุฑู ุจุนุฏ ุงูุถุฑูุจุฉ', `<i class="fas fa-coins" style="color:#05940e;"></i> ${afterTaxCommercial.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู`, 'after-taxonly-stat');
    addTotalItem(container, 'ุฅุฌูุงูู ุณููู', `<i class="fas fa-home" style="color:#f59e42;"></i> ${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู`, 'residential-stat');

    // ุฅุถุงูุฉ ูุนูููุงุช ุงูุตู ููุดุงุดุงุช ุงููุจูุฑุฉ ุฏุงุฆูุงูุ ูููุฌูุงู ุนูุฏ ุงุฎุชูุงุฑ ุนูุงุฑ ูุญุฏุฏ
    const shouldShowDeedInfo = !isMobileDevice() || currentProperty;

    console.log(`๐ฑ ูุนูููุงุช ุงูุตู - ุงูุฌูุงุฒ: ${isMobileDevice() ? 'ุฌูุงู' : 'ุดุงุดุฉ ูุจูุฑุฉ'}, ุงูุนูุงุฑ ุงููุฎุชุงุฑ: ${currentProperty || 'ูุง ููุฌุฏ'}, ุณูุชู ุงูุนุฑุถ: ${shouldShowDeedInfo}`);

    if (shouldShowDeedInfo) {
        // ๐ ุฅุถุงูุฉ ุชูุงุตูู ุงูุตู ููุฅุญุตุงุฆูุงุช
        const uniqueContractsList = {};
        data.forEach(property => {
            if (property['ุฑูู ุงูุนูุฏ'] && property['ุงุณู ุงูุนูุงุฑ']) {
                const key = `${property['ุฑูู ุงูุนูุฏ']}_${property['ุงุณู ุงูุนูุงุฑ']}`;
                if (!uniqueContractsList[key]) uniqueContractsList[key] = property;
            }
        });
        const uniqueList = Object.values(uniqueContractsList);

        // ุฅุถุงูุฉ ุฑูู ุงูุตู ุฅุฐุง ููุฌุฏ ูู ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ
        const firstDeedNumber = uniqueList.find(p => p['ุฑูู ุงูุตู'] && p['ุฑูู ุงูุตู'].toString().trim() !== '');
        if (firstDeedNumber && firstDeedNumber['ุฑูู ุงูุตู']) {
            const cssClass = isMobileDevice() ? 'deed-number-stat mobile-deed-info' : 'deed-number-stat desktop-deed-info';
            addTotalItem(container, 'ุฑูู ุงูุตู', `<i class="fas fa-file-contract" style="color:#dc3545;"></i> ${firstDeedNumber['ุฑูู ุงูุตู']}`, cssClass);
        }

        // ุฅุถุงูุฉ ูุณุงุญุฉ ุงูุตู ุฅุฐุง ููุฌุฏุช ูู ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ
        const firstDeedArea = uniqueList.find(p => p['ูุณุงุญุฉุงูุตู'] && !isNaN(parseFloat(p['ูุณุงุญุฉุงูุตู'])));
        if (firstDeedArea && firstDeedArea['ูุณุงุญุฉุงูุตู']) {
            const cssClass = isMobileDevice() ? 'deed-area-stat mobile-deed-info' : 'deed-area-stat desktop-deed-info';
            addTotalItem(container, 'ูุณุงุญุฉ ุงูุตู', `<i class="fas fa-ruler-combined" style="color:#fd7e14;"></i> ${parseFloat(firstDeedArea['ูุณุงุญุฉุงูุตู']).toLocaleString()} ูยฒ`, cssClass);
        }

        // ุฅุถุงูุฉ ุงูุณุฌู ุงูุนููู ุฅุฐุง ููุฌุฏ ูู ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ
        const firstSijil = uniqueList.find(p => p['ุงูุณุฌู ุงูุนููู '] && p['ุงูุณุฌู ุงูุนููู '].toString().trim() !== '');
        if (firstSijil && firstSijil['ุงูุณุฌู ุงูุนููู ']) {
            const cssClass = isMobileDevice() ? 'registry-stat mobile-deed-info' : 'registry-stat desktop-deed-info';
            addTotalItem(container, 'ุงูุณุฌู ุงูุนููู', `<i class="fas fa-clipboard-list" style="color:#28a745;"></i> ${firstSijil['ุงูุณุฌู ุงูุนููู '].toString().trim()}`, cssClass);
        }
    }

    // ููุงุญุธุฉ: ูู ุงูุฌูุงูุ ูุนูููุงุช ุงูุตู ุชุธูุฑ ููุท ุนูุฏ ุชุญุฏูุฏ ุนูุงุฑ ูุญุฏุฏ
}

// ุฅุถุงูุฉ ุนูุตุฑ ุฅุญุตุงุฆู
function addTotalItem(container, label, value, extraClass = '') {
    const item = document.createElement('div');
    item.className = 'total-item' + (extraClass ? ' ' + extraClass : '');
    item.innerHTML = `<span class="total-label">${label}:</span> <span class="total-value">${value}</span>`;
    container.appendChild(item);
}

// ุญุณุงุจ ุญุงูุฉ ุงูุนูุงุฑ
function parseDate(dateStr) {
    if (!dateStr) return null;

    // ุชุญููู ุฅูู ูุต ูุชูุธูู
    dateStr = String(dateStr).trim();

    // ุฅุฒุงูุฉ ุฃู ูุต ุฅุถุงูู (ูุซู ุงููุต ุงูุนุฑุจู)
    let datePart = dateStr;

    // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ูุญุชูู ุนูู ููุช (YYYY-MM-DD HH:MM:SS)ุ ุฃุฎุฐ ุงูุฌุฒุก ุงูุฎุงุต ุจุงูุชุงุฑูุฎ ููุท
    if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2}$/)) {
        datePart = dateStr.split(' ')[0];
    } else {
        // ุฅุฒุงูุฉ ุฃู ูุต ุฅุถุงูู ุขุฎุฑ
        datePart = dateStr.split(' ')[0];
        if (datePart.includes('(')) {
            datePart = datePart.split('(')[0].trim();
        }
    }

    let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');

    if (parts.length !== 3) return null;

    let day, month, year;

    // ุฅุฐุง ูุงู ุฃูู ุฌุฒุก 4 ุฃุฑูุงู ููู ุงูุณูุฉ (YYYY-MM-DD)
    if (parts[0].length === 4) {
        year = parseInt(parts[0]);
        month = parseInt(parts[1]);
        day = parseInt(parts[2]);
    } else {
        // ุชูุณูู DD/MM/YYYY ุฃู DD-MM-YYYY
        day = parseInt(parts[0]);
        month = parseInt(parts[1]);
        year = parseInt(parts[2]);
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
    if (isNaN(day) || isNaN(month) || isNaN(year) ||
        day < 1 || day > 31 ||
        month < 1 || month > 12 ||
        year < 1900 || year > 2100) {
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ ูู parseDate: ${dateStr}`);
        return null;
    }

    // ุฅูุดุงุก ูุงุฆู ุงูุชุงุฑูุฎ ูุน ุชุฌูุจ timezone issues ุจุงุณุชุฎุฏุงู ููุชุตู ุงูููุงุฑ
    const testDate = new Date(year, month - 1, day, 12, 0, 0);

    // ุงูุชุญูู ูู ุฃู ุงูุชุงุฑูุฎ ุงูููุดุฃ ูุทุงุจู ุงููุฏุฎูุงุช (ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุชูุงุฑูุฎ ูุซู 31 ูุจุฑุงูุฑ)
    if (testDate.getFullYear() !== year || testDate.getMonth() !== (month - 1) || testDate.getDate() !== day) {
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุงูุญ ูู parseDate: ${dateStr}`);
        return null;
    }

    return testDate;
}

function isSameDate(d1, d2) {
    return d1 && d2 &&
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();
}

function calculateStatus(property) {
    // ุญุณุงุจ ุนุฏุฏ ุงูุฃูุณุงุท ุงููุนูู ูู ุฌููุน ุงูุฃูุณุงุท ุงูููุฌูุฏุฉ
    let actualInstallmentCount = 0;
    const propertyName = property['ุงุณู ุงูุนูุงุฑ'] || 'ุบูุฑ ูุญุฏุฏ';

    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        if (property[dateKey] || property[amountKey]) {
            actualInstallmentCount = i; // ูุญูุธ ุฃุนูู ุฑูู ูุณุท ููุฌูุฏ
            console.log(`๐ ${propertyName}: ูุฌุฏ ูุณุท ุฑูู ${i} (${dateKey}: ${property[dateKey]}, ${amountKey}: ${property[amountKey]})`);
        }
    }

    // ุชุญุฏูุซ ุนุฏุฏ ุงูุฃูุณุงุท ุฅุฐุง ูุงู ููุงู ุฃูุณุงุท ูุนููุฉ
    if (actualInstallmentCount > 0) {
        const oldCount = property['ุนุฏุฏ ุงูุงูุณุงุท'];
        property['ุนุฏุฏ ุงูุงูุณุงุท'] = actualInstallmentCount;
        console.log(`โ ${propertyName}: ุชู ุชุญุฏูุซ ุนุฏุฏ ุงูุฃูุณุงุท ูู ${oldCount} ุฅูู ${actualInstallmentCount}`);
    } else {
        console.log(`โ๏ธ ${propertyName}: ูุง ุชูุฌุฏ ุฃูุณุงุท`);
    }

    if (!property['ุงุณู ุงููุณุชุฃุฌุฑ'] || !property['ุงููุงูู']) {
        return { final: 'ูุงุฑุบ', display: 'ูุงุฑุบ', isInstallmentEnded: false };
    }

    const today = new Date();

    // ุฅุฐุง ูุงู ุนุฏุฏ ุงูุฃูุณุงุท ุงููุชุจููุฉ > 0 ุฃู ุบูุฑ ูุงุฑุบุ ุงุนุชูุฏ ุนูู ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท
    if (property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] && Number(property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']) > 0 && property['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']) {
        const installmentEndDate = parseDate(property['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']);
        if (installmentEndDate) {
            const diffDays = Math.floor((installmentEndDate - today) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) {
                // ููุชูู - ููู ููู
                return {
                    final: 'ููุชูู',
                    display: `ุฃูุณุงุท ููุชููุฉ ููุฐ ${Math.abs(diffDays)} ููู <span class="need-more-installments">ุจุญุงุฌุฉ ูุฅุถุงูุฉ ุจุงูู ุงูุฃูุณุงุท (${property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']})</span>`,
                    isInstallmentEnded: true
                };
            } else if (diffDays <= 60) {
                // ุนูู ูุดู - ุชุฏุฑุฌ ุจุฑุชูุงูู/ุฃุฒุฑู
                return {
                    final: 'ุนูู ูุดู',
                    display: `ุฃูุณุงุท ุนูู ูุดู ุงูุงูุชูุงุก ุจุนุฏ ${diffDays} ููู (ูุชุจูู ${property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']} ุฃูุณุงุท)`,
                    isInstallmentEnded: false,
                    isPending: true
                };
            } else {
                // ุฌุงุฑู
                return {
                    final: 'ุฌุงุฑู',
                    display: `ูุนุงู (ูุชุจูู ${property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']} ุฃูุณุงุท)`,
                    isInstallmentEnded: false
                };
            }
        }
    }

    // ุฅุฐุง ูู ููุฌุฏ ุฃูุณุงุท ูุชุจููุฉ ุฃู ูุงูุช ุตูุฑุ ุงุณุชุฎุฏู ุชุงุฑูุฎ ุงูููุงูุฉ
    if (property['ุชุงุฑูุฎ ุงูููุงูุฉ']) {
        const contractDate = parseDate(property['ุชุงุฑูุฎ ุงูููุงูุฉ']);
        if (contractDate) {
            const diffDays = Math.floor((contractDate - today) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) {
                return { final: 'ููุชูู', display: `ููุชูู ููุฐ ${Math.abs(diffDays)} ููู`, isInstallmentEnded: false };
            } else if (diffDays <= 60) {
                return { final: 'ุนูู ูุดู', display: `ุณููุชูู ุจุนุฏ ${diffDays} ููู`, isInstallmentEnded: false };
            } else {
                return { final: 'ุฌุงุฑู', display: 'ูุนุงู', isInstallmentEnded: false };
            }
        }
    }

    // ุงุณุชุฎุฏุงู ุงูุญุงูุฉ ุงููุฎุฒูุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
    if (property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] && property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ']) {
        let isInstallmentEnded = property['isInstallmentEnded'] || false;
        return {
            final: property['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'],
            display: property['ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'],
            isInstallmentEnded: isInstallmentEnded
        };
    }

    return { final: '', display: '', isInstallmentEnded: false };
}

// ุนุฑุถ ุงูุจูุงูุงุช ูู ุฌุฏูู
function renderTable(data) {
    const container = document.getElementById('content');
    if (data.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem;">ูุง ุชูุฌุฏ ุจูุงูุงุช</div>';
        return;
    }

    // ุชุฌููุน ุงูุจูุงูุงุช ุญุณุจ ุฑูู ุงูุนูุฏ ูุงุณู ุงูุนูุงุฑ
    const groupedData = {};
    data.forEach(property => {
        const key = `${property['ุฑูู ุงูุนูุฏ']}_${property['ุงุณู ุงูุนูุงุฑ']}`;
        if (!groupedData[key]) {
            groupedData[key] = {
                ...property,
                units: [property['ุฑูู  ุงููุญุฏุฉ ']],
                meters: [property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก']], // ุฅุถุงูุฉ ูุตูููุฉ ูุฃุฑูุงู ุงูุนุฏุงุฏุงุช
                totalUnits: 1,
                ุงูุงุฌูุงูู: property['ุงูุงุฌูุงูู'],
                totalArea: parseFloat(property['ุงููุณุงุญุฉ']) || 0
            };
        } else {
            groupedData[key].units.push(property['ุฑูู  ุงููุญุฏุฉ ']);
            // ุฅุถุงูุฉ ุฑูู ุงูุนุฏุงุฏ ุฅุฐุง ูุงู ููุฌูุฏุงู ููู ููู ููุฑุฑุงู
            if (property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] && !groupedData[key].meters.includes(property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'])) {
                groupedData[key].meters.push(property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก']);
            }
            groupedData[key].totalUnits++;
            groupedData[key].totalArea += parseFloat(property['ุงููุณุงุญุฉ']) || 0;
        }
    });

    let html = '<div class="table-container"><table>';
    const orderedFields = [
        'ุฑูู  ุงููุญุฏุฉ ',
        'ุงุณู ุงูุนูุงุฑ',
        'ุงููุฏููุฉ',
        'ุฑูู ุงูุตู',
        'ุงููุณุงุญุฉ',
        'ุงูุงุฑุชูุงุน',
        'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก',
        'ุงุณู ุงููุณุชุฃุฌุฑ',
        'ุฑูู ุงูุนูุฏ',
        'ููุน ุงูุนูุฏ',
        'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ',
        'ุชุงุฑูุฎ ุงูููุงูุฉ',
        'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท',
        'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ', // ุฅุถุงูุฉ ูุฐุง ุงูุณุทุฑ
        'ุงููุงูู',
        'ุงูุญุงูุฉ',
        'ุงูุงุฌูุงูู'
    ];
    // ูุงุญุธ ุฃููุง ูู ูุถู 'ูุณุงุญุฉ ุงูุตู' ุฅูู ุงููุงุฆูุฉ

    // ุฑุคูุณ ุงูุฃุนูุฏุฉ
    html += '<tr>';
    orderedFields.forEach(header => {
        html += `<th>${header}</th>`;
    });
    html += '<th>ุงูุฅุฌุฑุงุกุงุช</th>';
    html += '</tr>';

    // ุชุฑุชูุจ ุงูุนููุฏ ุญุณุจ ุงุณู ุงูุนูุงุฑ ุฃู ุฑูู ุงูุนูุฏ
    let groupedOrder = Object.keys(groupedData).sort((a, b) => {
        // ุชุฑุชูุจ ุญุณุจ ุงุณู ุงูุนูุงุฑ ุซู ุฑูู ุงูุนูุฏ
        const [contractA, nameA] = a.split('_');
        const [contractB, nameB] = b.split('_');
        if (nameA === nameB) {
            return contractA.localeCompare(contractB, 'ar', {numeric: true});
        }
        return nameA.localeCompare(nameB, 'ar', {numeric: true});
    });

    // ุชุทุจูู ุงูุชุฑุชูุจ ุงูุนูุณู ุฅุฐุง ูุงู ููุนูุงู
    if (isReverseOrder) {
        groupedOrder = groupedOrder.reverse();
    }

    groupedOrder.forEach(key => {
        const property = groupedData[key];
        // ุฑุชุจ ุงููุญุฏุงุช ุฏุงุฎู ุงูุจุทุงูุฉ
        property.units = property.units.filter(Boolean).sort((a, b) => a.localeCompare(b, 'ar', {numeric: true}));
        const status = calculateStatus(property);
        let statusClass = '';
        if (status.isInstallmentEnded) statusClass = 'installment-ended-status';
        else if (status.final === 'ุฌุงุฑู') statusClass = 'active-status';
        else if (status.final === 'ููุชูู') statusClass = 'expired-status';
        else if (status.final === 'ุนูู ูุดู') statusClass = 'pending-status';
        else if (status.final === 'ูุงุฑุบ') statusClass = 'empty-status';

        html += '<tr>';
        orderedFields.forEach(field => {
            if (field === 'ุฑูู  ุงููุญุฏุฉ ') {
                const unitsDisplay = property.units.filter(Boolean).map(unit => 
                    `<span class="unit-link" onclick="showUnitDetails('${unit}', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู ุงูุนูุฏ']}')">${unit}</span>`
                ).join(' , ') +
                (property.totalUnits > 1 ? `<span class="units-count"> (${property.totalUnits} ูุญุฏุงุช)</span>` : '');
                html += `<td>${unitsDisplay}</td>`;
            } else if (field === 'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก') {
                const metersDisplay = property.meters.filter(Boolean).map(meter => 
                    `<span class="meter-link" onclick="showMeterDetails('${meter}', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู ุงูุนูุฏ']}')">${meter}</span>`
                ).join(' , ') +
                (property.meters.length > 1 ? `<span class="meters-count">(${property.meters.length} ุนุฏุงุฏุงุช)</span>` : '');
                html += `<td>${metersDisplay}</td>`;
            } else if (field === 'ุงููุณุงุญุฉ') {
                html += `<td>${property.totalArea ? property.totalArea.toLocaleString() + ' ูยฒ' : ''}</td>`;
            } else if (field === 'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ') {
                html += `<td>${formatArabicDate(property[field])}</td>`;
            } else if (field === 'ุชุงุฑูุฎ ุงูููุงูุฉ') {
                html += `<td>${formatArabicDate(property[field])}</td>`;
            } else if (field === 'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท') {
                html += `<td>${formatArabicDate(property[field])}</td>`;
            } else if (field === 'ุงูุญุงูุฉ') {
                html += `<td class="${statusClass}">${status.display || ''}</td>`;
            } else if (field === 'ุงูุงุฌูุงูู') {
                const totalData = formatTotalWithNote(property);
                if (property['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู') {
                    html += `<td onclick="showTaxDetails(${totalData.amount}, '${property['ููุน ุงูุนูุฏ']}')" style="cursor: pointer;">
                        <div class="total-display">
                            <span class="total-amount">${totalData.display}</span>
                            <small class="total-note">${totalData.note}</small>
                        </div>
                        <i class="fas fa-info-circle" style="margin-right: 5px; color: #2a4b9b;"></i>
                    </td>`;
                } else {
                    html += `<td onclick="showTaxDetails(${totalData.amount}, '${property['ููุน ุงูุนูุฏ']}')" style="cursor: pointer;">
                        <div class="total-display">
                            <span class="total-amount">${totalData.display}</span>
                            <small class="total-note">${totalData.note}</small>
                        </div>
                    </td>`;
                }
            } else if (field === 'ุนุฏุฏ ุงูุงูุณุงุท') {
                if (property['ุนุฏุฏ ุงูุงูุณุงุท']) {
                    const status = calculateStatus(property);
                    const installmentClass = status.isInstallmentEnded ? 'installment-ended' : 
                                            status.final === 'ุฌุงุฑู' ? 'active' : 
                                            status.final === 'ููุชูู' ? 'expired' : 
                                            status.final === 'ุนูู ูุดู' ? 'pending' : 'empty';
                    html += `<td>
            <span class="installments-link installment-${installmentClass}" style="color:#2a4b9b;cursor:pointer;font-weight:bold;"
                onclick="showInstallmentsDetails('${property['ุฑูู ุงูุนูุฏ']}', '${property['ุงุณู ุงูุนูุงุฑ']}')">
                ${property['ุนุฏุฏ ุงูุงูุณุงุท']}
            </span>
        </td>`;
                } else {
                    html += `<td></td>`;
                }
            } else if (field === 'ุนุฏุฏ ุงูุงูุณุงุท ุงููููุฉ') {
                html += `<td>${property['ุนุฏุฏ ุงูุงูุณุงุท ุงููููุฉ'] || ''}</td>`;
            } else if (field === 'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจูู') {
                const remaining = property['ุนุฏุฏ ุงูุงูุณุงุท ุงููููุฉ'] && property['ุนุฏุฏ ุงูุงูุณุงุท'] ? 
                    (parseInt(property['ุนุฏุฏ ุงูุงูุณุงุท ุงููููุฉ']) - parseInt(property['ุนุฏุฏ ุงูุงูุณุงุท'])) : '';
                html += `<td>${remaining}</td>`;
            } else if (field === 'ูููุน ุงูุนูุงุฑ' && property[field]) {
                html += `<td><a href="#" onclick="openLocation('${property[field]}'); return false;" class="location-link">ุงูุฎุฑูุทุฉ <i class="fas fa-map-marker-alt"></i></a></td>`;
            } else {
                html += `<td>${property[field] || ''}</td>`;
            }
        });
        
        // ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช
        html += `<td class="table-actions-cell">
            <div class="table-actions-group">
                <button onclick="showPropertyDetailsByKey(${property['ุฑูู ุงูุนูุฏ'] ? `'${property['ุฑูู ุงูุนูุฏ']}', '${property['ุงุณู ุงูุนูุงุฑ']}'` : `'', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู  ุงููุญุฏุฉ '] || ''}'`})" class="table-action-btn">
                    <i class="fas fa-eye"></i> ุนุฑุถ
                </button>
                <button onclick="showPrintOptions(${property['ุฑูู ุงูุนูุฏ'] ? `'${property['ุฑูู ุงูุนูุฏ']}', '${property['ุงุณู ุงูุนูุงุฑ']}'` : `'', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู  ุงููุญุฏุฉ '] || ''}'`})" class="table-action-btn">
                    <i class="fas fa-print"></i> ุทุจุงุนุฉ
                </button>
                ${property['ูููุน ุงูุนูุงุฑ'] ? `<button onclick="openLocation('${property['ูููุน ุงูุนูุงุฑ']}')" class="table-action-btn"><i class="fas fa-map-marker-alt"></i> ูููุน</button>` : ''}
            </div>
            <div class="table-actions-group">
                <button onclick="showCardAttachmentsModal('${property['ุงููุฏููุฉ']}', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู ุงูุนูุฏ'] || ''}', '${property['ุฑูู  ุงููุญุฏุฉ '] || ''}')" class="table-action-btn attachment-btn">
                    <i class="fas fa-paperclip"></i> ูุฑููุงุช
                </button>
                <button onclick="showCardEditModal('${property['ุฑูู ุงูุนูุฏ'] || ''}', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู  ุงููุญุฏุฉ '] || ''}')" class="table-action-btn edit-btn">
                    <i class="fas fa-edit"></i> ุชุญุฑูุฑ
                </button>
            </div>
        </td>`;
        html += '</tr>';
    });

    html += '</table></div>';
    container.innerHTML = html;
}

// ุนุฑุถ ุงูุจูุงูุงุช ูู ุจุทุงูุงุช
function renderCards(data) {
    const container = document.getElementById('content');
    if (data.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem;">ูุง ุชูุฌุฏ ุจูุงูุงุช</div>';
        return;
    }

    // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑ: ูู ุจุทุงูุฉ ุจุฑูู ุงูุนูุฏ ูุงุณู ุงูุนูุงุฑ ุฃู ุฑูู ุงููุญุฏุฉ ุฅุฐุง ูู ููุฌุฏ ุนูุฏ
    const uniqueMap = new Map();
    data.forEach(property => {
        let key = '';
        if (property['ุฑูู ุงูุนูุฏ'] && property['ุงุณู ุงูุนูุงุฑ']) {
            key = `${property['ุฑูู ุงูุนูุฏ']}_${property['ุงุณู ุงูุนูุงุฑ']}`;
        } else if (property['ุฑูู  ุงููุญุฏุฉ ']) {
            key = property['ุฑูู  ุงููุญุฏุฉ '];
        }
        if (key && !uniqueMap.has(key)) {
            uniqueMap.set(key, property);
        }
    });
    const uniqueData = Array.from(uniqueMap.values());

    // ุชุฑุชูุจ ุงูุจุทุงูุงุช ุญุณุจ ุงูุฅุนุฏุงุฏ ุงููุญุฏุฏ
    const sortedData = isReverseOrder ? uniqueData.reverse() : uniqueData;

    let html = '<div class="cards-container">';
    sortedData.forEach(property => {
        const status = calculateStatus(property);
        let headerClass = '', badgeClass = 'badge-empty', badgeIcon = '', displayStatus = status.display;
        
        // ุฅุถุงูุฉ ุญุงูุฉ ุฌุฏูุฏุฉ ูููุณุท ุงูููุชูู ูุน ุงุณุชูุฑุงุฑ ุงูุนูุฏ
        if (status.isInstallmentEnded) {
            headerClass = 'installment-ended-status';
            badgeClass = 'installment-ended-badge';
            badgeIcon = '<i class="fas fa-check-circle"></i>';
        } else {
            switch(status.final) {
                case 'ุฌุงุฑู': headerClass = 'active-status'; badgeClass = 'active-badge'; badgeIcon = '<i class="fas fa-check-circle"></i>'; break;
                case 'ููุชูู': headerClass = 'expired-status'; badgeClass = 'expired-badge'; badgeIcon = '<i class="fas fa-times-circle"></i>'; break;
                case 'ุนูู ูุดู': headerClass = 'pending-status'; badgeClass = 'pending-badge'; badgeIcon = '<i class="fas fa-exclamation-circle"></i>'; break;
                case 'ูุงุฑุบ': headerClass = 'empty-status'; badgeClass = 'empty-badge'; badgeIcon = '<i class="fas fa-minus-circle"></i>'; break;
            }
        }
        let startColor = '', endColor = '';
        if (status.isInstallmentEnded) {
            startColor = 'background:#f3e5f5;color:#9c27b0;'; // ููู ููู ูููุณุท ุงูููุชูู ูุน ุงุณุชูุฑุงุฑ ุงูุนูุฏ
            endColor = 'background:#f3e5f5;color:#9c27b0;';
        } else {
            switch(status.final) {
                case 'ุฌุงุฑู': startColor = 'background:#e8f7ef;color:#2a4b9b;'; endColor = 'background:#e8f7ef;color:#2a4b9b;'; break;
                case 'ููุชูู': startColor = 'background:#fbeee6;color:#e74c3c;'; endColor = 'background:#fbeee6;color:#e74c3c;'; break;
                case 'ุนูู ูุดู': startColor = 'background:#fffbe6;color:#f39c12;'; endColor = 'background:#fffbe6;color:#f39c12;'; break;
                default: startColor = 'background:#f6f6f6;color:#333;'; endColor = 'background:#f6f6f6;color:#333;';
            }
        }
        // ุงุฌูุน ูู ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุจููุณ ุฑูู ุงูุนูุฏ ููุท
        let relatedUnits = [];
        let totalArea = 0;
        if (property['ุฑูู ุงูุนูุฏ']) {
            const relatedProps = properties.filter(
                p => p['ุฑูู ุงูุนูุฏ'] === property['ุฑูู ุงูุนูุฏ']
            );
            relatedUnits = relatedProps.map(p => p['ุฑูู  ุงููุญุฏุฉ ']).filter(Boolean);
            totalArea = relatedProps.reduce((sum, p) => sum + (parseFloat(p['ุงููุณุงุญุฉ']) || 0), 0);
        } else if (property['ุฑูู  ุงููุญุฏุฉ ']) {
            relatedUnits = [property['ุฑูู  ุงููุญุฏุฉ ']];
            totalArea = parseFloat(property['ุงููุณุงุญุฉ']) || 0;
        }
        relatedUnits = [...new Set(relatedUnits)].sort((a, b) => a.localeCompare(b, 'ar', {numeric: true}));

        html += `
        <div class="property-card">
            <div class="card-header ${headerClass}">
                <span>${property['ุงุณู ุงูุนูุงุฑ'] || ''}</span>
                <span>${property['ููุน ุงูุนูุฏ'] || ''}</span>
            </div>
            <div class="card-body">
                <div class="card-row">
                    <span class="card-label">ุฑูู ุงููุญุฏุฉ:</span>
                    <span class="card-value">
                        ${relatedUnits.map(unit =>
                            `<span class="unit-link" onclick="showUnitDetails('${unit}', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู ุงูุนูุฏ']}')">${unit}</span>`
                        ).join(' , ')}
                        ${relatedUnits.length > 1 ? `<span class="units-count">(${relatedUnits.length} ูุญุฏุงุช)</span>` : ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">ุงููุณุงุญุฉ:</span>
                    <span class="card-value">${totalArea ? totalArea.toLocaleString() + ' ูยฒ' : ''}</span>
                </div>
                ${property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] ? `
                <div class="card-row electric-meter-row">
                    <span class="card-label"><i class="fas fa-bolt"></i> ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก:</span>
                    <span class="card-value">${property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก']}</span>
                </div>` : ''}
                <div class="card-row">
                    <span class="card-label">ุงุณู ุงููุณุชุฃุฌุฑ:</span>
                    <span class="card-value">${property['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ุงููุงูู:</span>
                    <span class="card-value">${property['ุงููุงูู'] || ''}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ุฑูู ุงูุนูุฏ:</span>
                    <span class="card-value">${property['ุฑูู ุงูุนูุฏ'] || ''}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:</span>
                    <span class="card-value" style="${startColor} padding:4px 8px; border-radius:4px;">
                        ${formatArabicDate(property['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']) || ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">ุชุงุฑูุฎ ุงูููุงูุฉ:</span>
                    <span class="card-value" style="${endColor} padding:4px 8px; border-radius:4px;">
                        ${formatArabicDate(property['ุชุงุฑูุฎ ุงูููุงูุฉ']) || ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท:</span>
                    <span class="card-value" style="${endColor} padding:4px 8px; border-radius:4px;">
                        ${formatArabicDate(property['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']) || ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">ุญุงูุฉ ุงููุญุฏุฉ:</span>
                    <span class="status-value ${badgeClass} ${
                        status.final === 'ุนูู ูุดู' && property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] && Number(property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']) > 0
                            ? 'pending-gradient'
                            : ''
                    }">
                        ${badgeIcon} ${displayStatus || ''}
                    </span>
                </div>
                <div class="card-row">
                    <span class="card-label">ุงูุงุฌูุงูู:</span>
                    <span class="card-value">
                        ${(() => {
                            const totalData = formatTotalWithNote(property);
                            return `
                                <div class="total-display-card">
                                    <span class="total-amount">${totalData.display}</span>
                                    <small class="total-note">${totalData.note}</small>
                                </div>
                            `;
                        })()}
                    </span>
                </div>
                ${property['ุนุฏุฏ ุงูุงูุณุงุท'] && property['ุนุฏุฏ ุงูุงูุณุงุท'] > 0 ? `
                <div class="card-row">
                    <span class="card-label">ุนุฏุฏ ุงูุฃูุณุงุท:</span>
                    <span class="card-value">
                        <span class="installments-count-badge installment-${status.isInstallmentEnded ? 'installment-ended' : status.final === 'ุฌุงุฑู' ? 'active' : status.final === 'ููุชูู' ? 'expired' : status.final === 'ุนูู ูุดู' ? 'pending' : 'empty'}"
                              onclick="showInstallmentsDetails('${property['ุฑูู ุงูุนูุฏ']}', '${property['ุงุณู ุงูุนูุงุฑ']}')"
                              title="ุงููุฑ ูุนุฑุถ ุชูุงุตูู ุฌููุน ุงูุฃูุณุงุท">
                            <i class="fas fa-calendar-check"></i>
                            ${property['ุนุฏุฏ ุงูุงูุณุงุท']} ${property['ุนุฏุฏ ุงูุงูุณุงุท'] === 1 ? 'ูุณุท' : 'ุฃูุณุงุท'}
                        </span>
                    </span>
                </div>` : ''}
                ${property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] ? `
                <div class="card-row">
                    <span class="card-label">ุงูุฃูุณุงุท ุงููุชุจููุฉ:</span>
                    <span class="card-value">
                        <span class="remaining-installments ${Number(property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']) <= 2 ? 'warning' : ''}">
                            <i class="fas fa-clock"></i>
                            ${property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']} ${Number(property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']) === 1 ? 'ูุณุท ูุชุจูู' : 'ุฃูุณุงุท ูุชุจููุฉ'}
                        </span>
                    </span>
                </div>` : ''}
            </div>
            <div class="card-footer">
                <div class="card-actions-row">
                    <button onclick="showPropertyDetailsByKey(${property['ุฑูู ุงูุนูุฏ'] ? `'${property['ุฑูู ุงูุนูุฏ']}', '${property['ุงุณู ุงูุนูุงุฑ']}'` : `'', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู  ุงููุญุฏุฉ '] || ''}'`})">
                        <i class="fas fa-eye"></i> ุนุฑุถ ุงูุชูุงุตูู
                    </button>
                    <button onclick="showPrintOptions(${property['ุฑูู ุงูุนูุฏ'] ? `'${property['ุฑูู ุงูุนูุฏ']}', '${property['ุงุณู ุงูุนูุงุฑ']}'` : `'', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู  ุงููุญุฏุฉ '] || ''}'`})">
                        <i class="fas fa-print"></i> ุทุจุงุนุฉ
                    </button>
                    ${property['ูููุน ุงูุนูุงุฑ'] ?
                        `<button onclick="openLocation('${property['ูููุน ุงูุนูุงุฑ']}')" class="location-btn">
                            <i class="fas fa-map-marker-alt"></i> ุงููููุน
                        </button>` :
                        ''}
                </div>
                <div class="card-actions-row">
                    <button onclick="showCardAttachmentsModal('${property['ุงููุฏููุฉ']}', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู ุงูุนูุฏ'] || ''}', '${property['ุฑูู  ุงููุญุฏุฉ '] || ''}')" class="attachment-btn">
                        <i class="fas fa-paperclip"></i> ุงููุฑููุงุช
                    </button>
                    <button onclick="showCardEditModal('${property['ุฑูู ุงูุนูุฏ'] || ''}', '${property['ุงุณู ุงูุนูุงุฑ']}', '${property['ุฑูู  ุงููุญุฏุฉ '] || ''}')" class="edit-btn">
                        <i class="fas fa-edit"></i> ุชุญุฑูุฑ
                    </button>
                </div>
            </div>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

// ูุชุญ ูููุน ุงูุนูุงุฑ
function openLocation(location) {
    // ุชุญูู ููุง ุฅุฐุง ูุงู ุงููููุน ูุญุชูู ุนูู ุฑุงุจุท URL
    if (location.startsWith('http://') || location.startsWith('https://')) {
        window.open(location, '_blank');
    } else {
        // ุฅุฐุง ูู ููู ุฑุงุจุทูุงุ ุงุจุญุซ ุนูู ูู ุฎุฑุงุฆุท ุฌูุฌู
        const googleMapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(location)}`;
        window.open(googleMapsUrl, '_blank');
    }
}

// ุนุฑุถ ุชูุงุตูู ุงูุนูุงุฑ
function showPropertyDetails(index) {
    const property = properties[index];
    if (!property) return;
    
    const status = calculateStatus(property);
    let statusClass = '';
    let badgeIcon = '';
    
    if (status.isInstallmentEnded) {
        statusClass = 'installment-ended-status';
        badgeIcon = '<i class="fas fa-money-bill-wave"></i>';
    } else if (status.final === 'ุฌุงุฑู') {
        statusClass = 'active-status';
        badgeIcon = '<i class="fas fa-check-circle"></i>';
    } else if (status.final === 'ููุชูู') {
        statusClass = 'expired-status';
        badgeIcon = '<i class="fas fa-times-circle"></i>';
    } else if (status.final === 'ุนูู ูุดู') {
        statusClass = 'pending-status';
        badgeIcon = '<i class="fas fa-exclamation-circle"></i>';
    }

    // ุชุฌููุน ุงููุญุฏุงุช ูุงููุณุงุญุฉ ูููุณ ุงูุนูุฏ
    const contractKey = `${property['ุฑูู ุงูุนูุฏ']}_${property['ุงุณู ุงูุนูุงุฑ']}`;
    const related = properties.filter(
        p => `${p['ุฑูู ุงูุนูุฏ']}_${p['ุงุณู ุงูุนูุงุฑ']}` === contractKey
    );
    const allUnits = related.map(p => p['ุฑูู  ุงููุญุฏุฉ ']).filter(Boolean);
    const totalArea = related.reduce((sum, p) => sum + (parseFloat(p['ุงููุณุงุญุฉ']) || 0), 0);

    let html = '<div class="modal-overlay" style="display:flex;"><div class="modal-box property-details-modal"><button class="close-modal" onclick="closeModal()">ร</button>';
    html += `<h3>${property['ุงุณู ุงูุนูุงุฑ'] || ''}</h3>`;

    // ูุณู ูุนูููุงุช ุงูุนูุงุฑ ุงูุฃุณุงุณูุฉ
    html += '<div class="property-basic-info">';
    html += '<h4><i class="fas fa-building"></i> ูุนูููุงุช ุงูุนูุงุฑ ุงูุฃุณุงุณูุฉ</h4>';

    // ููุงุญุธุฉ: ุชู ุฅุฒุงูุฉ ุนุฑุถ ูุนูููุงุช ุงูุตู ูู ุชูุงุตูู ุงููุญุฏุฉ ูู ุงูุฌูุงู
    // ูุนูููุงุช ุงูุตู ุณุชุธูุฑ ููุท ุนูุฏ ุชุญุฏูุฏ ุนูุงุฑ ูุญุฏุฏ
    html += '</div>';

    // ูุณู ูุนูููุงุช ุงููุญุฏุงุช
    html += '<div class="property-details">';
    html += '<h4><i class="fas fa-home"></i> ูุนูููุงุช ุงููุญุฏุงุช</h4>';

    // ุฑูู  ุงููุญุฏุฉ (ุฌููุน ุงููุญุฏุงุช)
    html += `
    <div class="detail-row">
        <span class="detail-label">ุฑูู ุงููุญุฏุฉ:</span>
        <span class="detail-value">${allUnits.join(' , ')}${allUnits.length > 1 ? ` <span class="units-count">(${allUnits.length} ูุญุฏุงุช)</span>` : ''}</span>
    </div>
    <div class="detail-row">
        <span class="detail-label">ุงููุณุงุญุฉ ุงููุฌูุนุฉ:</span>
        <span class="detail-value">${totalArea ? totalArea.toLocaleString() : '0'} ูยฒ</span>
    </div>
    `;

    // ุจุงูู ุงูุญููู (ุชุฌุงูู ุงูุญููู ุงูุชู ุชู ุนุฑุถูุง ุจุงููุนู)
    const excludedFields = ['Column1', 'ุฑูู  ุงููุญุฏุฉ ', 'ุงููุณุงุญุฉ', 'ุฑูู ุงูุตู', 'ุงูุณุฌู ุงูุนููู ', 'ูุณุงุญุฉุงูุตู', 'ุงูุญุงูุฉ ุงูููุงุฆูุฉ', 'ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'];
    Object.entries(property).forEach(([key, value]) => {
        if (excludedFields.includes(key)) return;
        if (!value && value !== 0) return;
        let displayValue = value;
        if (key === 'ุงูุงุฌูุงูู' && value) {
            displayValue = parseFloat(value).toLocaleString() + ' ุฑูุงู';
        } else if (key === 'ูููุน ุงูุนูุงุฑ' && value) {
            let url = value;
            if (!url.startsWith('http')) {
                url = `https://www.google.com/maps/search/${encodeURIComponent(url)}`;
            }
            displayValue = `<a href="${url}" target="_blank" class="location-link">ุงูุฎุฑูุทุฉ <i class="fas fa-map-marker-alt"></i></a>`;
        }
        html += `
        <div class="detail-row">
            <span class="detail-label">${key}:</span>
            <span class="detail-value">${displayValue}</span>
        </div>
        `;
    });

    // ุฅุถุงูุฉ ุงูุญุงูุฉ ุจุดูู ูุฎุตุต
    html += `
    <div class="detail-row ${statusClass}">
        <span class="detail-label">ุงูุญุงูุฉ:</span>
        <span class="detail-value">${badgeIcon} ${status.display || ''}</span>
    </div>
    `;

    // ุฅุถุงูุฉ ุงููุจูุบ ุงูุฎุงุถุน ููุถุฑูุจุฉ ููููุฉ ุงูุถุฑูุจุฉ
    if (property['ุงูุงุฌูุงูู']) {
        if (property['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู') {
            const baseAmount = property['ุงูุงุฌูุงูู'] / 1.15;
            const vatAmount = property['ุงูุงุฌูุงูู'] - baseAmount;
            html += `
            <div class="detail-row">
                <span class="detail-label">ุงููุจูุบ ุงูุฎุงุถุน ููุถุฑูุจุฉ:</span>
                <span class="detail-value">${parseFloat(baseAmount).toFixed(2).toLocaleString()} ุฑูุงู</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ูููุฉ ุงูุถุฑูุจุฉ (15%):</span>
                <span class="detail-value">${parseFloat(vatAmount).toFixed(2).toLocaleString()} ุฑูุงู</span>
            </div>
            <div class="detail-row" style="font-weight: bold;">
                <span class="detail-label">ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ:</span>
                <span class="detail-value" style="color: #2a4b9b;">
                    ${parseFloat(property['ุงูุงุฌูุงูู']).toLocaleString()} ุฑูุงู
                </span>
            </div>`;
        } else {
            html += `
            <div class="detail-row">
                <span class="detail-label">ุงูุฅุฌูุงูู:</span>
                <span class="detail-value" style="color: #2a4b9b; font-weight: bold;">
                    ${parseFloat(property['ุงูุงุฌูุงูู']).toLocaleString()} ุฑูุงู
                </span>
            </div>`;
        }
    }

    // ุนุฑุถ ูููุน ุงูุนูุงุฑ ุฅุฐุง ูุงู ูุชููุฑุงู
    if (property['ูููุน ุงูุนูุงุฑ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label">ูููุน ุงูุนูุงุฑ:</span>
            <span class="detail-value">
                <a href="#" onclick="openLocation('${property['ูููุน ุงูุนูุงุฑ']}'); return false;" 
                   class="location-link">ูุชุญ ุงูุฎุฑูุทุฉ <i class="fas fa-map-marker-alt"></i></a>
            </span>
        </div>`;
    }

    html += `</div>`;

    // ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช
    html += `
    <div class="modal-actions">
        <button onclick="closeModal()" class="modal-action-btn close-btn">
            <i class="fas fa-times"></i> ุฅุบูุงู
        </button>
    </div>
    </div></div>`;

    // ุฅุถุงูุฉ ูุณุชูุน ูุฅุบูุงู ุงูููุฏุงู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ุฏุงูุฉ ุฌุฏูุฏุฉ ูุนุฑุถ ุงููุญุฏุงุช ุงููุงุฑุบุฉ ููุท
function renderOnlyEmptyUnits() {
    const emptyUnits = properties.filter(property => !property['ุงุณู ุงููุณุชุฃุฌุฑ'] || property['ุงุณู ุงููุณุชุฃุฌุฑ'].toString().trim() === '');
    renderTotals(emptyUnits);
    renderMobileTotals(emptyUnits);
    if (currentView === 'table') {
        renderTable(emptyUnits);
    } else {
        renderCards(emptyUnits);
    }
    // ุชุญุฏูุซ ุนุฏุงุฏุงุช ุงููุงุฆูุฉ ุงููุชูููุฉ
    updateMobileMenuCounts(emptyUnits);
}

// ุงุฌูุจ ูู ุงูุฃุดูุฑ ูุงูุณููุงุช ูู ุชูุงุฑูุฎ ุงูุฃูุณุงุท
function getInstallmentMonthsAndYears() {
    const months = new Set();
    const years = new Set();
    properties.forEach(prop => {
        if (!prop['ุนุฏุฏ ุงูุงูุณุงุท']) return;
        for (let i = 1; i <= Number(prop['ุนุฏุฏ ุงูุงูุณุงุท']); i++) {
            let dateStr = prop[`ุชุงุฑูุฎ ุงููุณุท ${i === 1 ? 'ุงูุงูู' : `ุงูุซุงูู`}`] || prop[`ุชุงุฑูุฎ ุงููุณุท ${i}`];
            if (!dateStr) continue;
            let datePart = dateStr.split(' ')[0];
            let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');
            if (parts.length !== 3) continue;
            let day, month, year;
            // ุฅุฐุง ูุงู ุฃูู ุฌุฒุก 4 ุฃุฑูุงู ููู ุงูุณูุฉ
            if (parts[0].length === 4) {
                year = parts[0];
                month = parts[1];
                day = parts[2];
            } else {
                day = parts[0];
                month = parts[1];
                year = parts[2];
            }
            // ุฅุฒุงูุฉ ุงูุตูุฑ ุงูุฒุงุฆุฏ
            month = parseInt(month, 10);
            const months = [
                '', 'ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฃุจุฑูู', 'ูุงูู', 'ููููู',
                'ููููู', 'ุฃุบุณุทุณ', 'ุณุจุชูุจุฑ', 'ุฃูุชูุจุฑ', 'ููููุจุฑ', 'ุฏูุณูุจุฑ'
            ];
            // ุงูุชุงุฑูุฎ ุงูุฑููู + (ุงูุชุงุฑูุฎ ุงููุตู)
            return `${datePart} (${parseInt(day,10)}/${months[month]}/${year})`;
        }
    });
}

// ุชูุณูู ุงูุชุงุฑูุฎ ูููุฌุฉ ุงูุนุฑุจูุฉ - ูุญุณู ูููุน ุงูุชูุงุฑูุฎ ุงูุนุดูุงุฆูุฉ
function formatArabicDate(dateStr) {
    if (!dateStr) return '';

    // ุญูุธ ุงูุชุงุฑูุฎ ุงูุฃุตูู
    const originalDateStr = dateStr;

    // ุฏุนู ุตูุบ: yyyy-mm-dd, dd/mm/yyyy, dd-mm-yyyy, yyyy/mm/dd, ูุน ุฃู ุจุฏูู ููุช
    let datePart = dateStr.split(' ')[0];
    let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');

    if (parts.length !== 3) return originalDateStr;

    let day, month, year;

    // ุฅุฐุง ูุงู ุฃูู ุฌุฒุก 4 ุฃุฑูุงู ููู ุงูุณูุฉ
    if (parts[0].length === 4) {
        year = parseInt(parts[0]);
        month = parseInt(parts[1]);
        day = parseInt(parts[2]);
    } else {
        day = parseInt(parts[0]);
        month = parseInt(parts[1]);
        year = parseInt(parts[2]);
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
    if (isNaN(year) || isNaN(month) || isNaN(day) ||
        year < 1900 || year > 2100 ||
        month < 1 || month > 12 ||
        day < 1 || day > 31) {
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ ูู formatArabicDate: ${originalDateStr}`);
        return originalDateStr; // ุฅุฑุฌุงุน ุงูุชุงุฑูุฎ ุงูุฃุตูู ุฅุฐุง ูุงู ุบูุฑ ุตุญูุญ
    }

    const months = [
        '', 'ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฃุจุฑูู', 'ูุงูู', 'ููููู',
        'ููููู', 'ุฃุบุณุทุณ', 'ุณุจุชูุจุฑ', 'ุฃูุชูุจุฑ', 'ููููุจุฑ', 'ุฏูุณูุจุฑ'
    ];

    // ุฅูุดุงุก ุงูุชุงุฑูุฎ ุงูููุณู ุจุตูุบุฉ dd/mm/yyyy
    const formattedDate = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;

    // ุงูุชุงุฑูุฎ ุงูุฑููู + (ุงูุชุงุฑูุฎ ุงููุตู)
    return `${formattedDate} (${day}/${months[month]}/${year})`;
}

// ุนุฑุถ ุชูุงุตูู ุงูุฃูุณุงุท
function showInstallmentsDetails(contractNumber, propertyName) {
    // ุงุจุญุซ ุนู ุฃูู ุนูุตุฑ ูุทุงุจู ุฑูู ุงูุนูุฏ ูุงุณู ุงูุนูุงุฑ
    const prop = properties.find(p => p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    if (!prop || !prop['ุนุฏุฏ ุงูุงูุณุงุท']) return;

    // ุชุญุฏูุฏ ููู ุงูุญุงูุฉ
    let status = 'default';
    const statusObj = calculateStatus(prop);
       if (statusObj.isInstallmentEnded) {
        status = 'installment-ended';
    } else if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ']) {
        if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] === 'ุฌุงุฑู') status = 'active';
        else if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] === 'ููุชูู') status = 'expired';
        else if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] === 'ุนูู ูุดู') status = 'pending';
        else if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] === 'ูุงุฑุบ') status = 'empty';
    }

    // ุญุณุงุจ ุฌููุน ุงููุญุฏุงุช ูุงููุณุงุญุฉ ุงููุฌูุนุฉ ููุฐุง ุงูุนูุฏ/ุงูุนูุงุฑ
    const related = properties.filter(
        p => p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );
    const allUnits = related.map(p => p['ุฑูู  ุงููุญุฏุฉ ']).filter(Boolean);
    const totalArea = related.reduce((sum, p) => sum + (parseFloat(p['ุงููุณุงุญุฉ']) || 0), 0);

    let html = '<div class="modal-overlay" style="display:flex;"><div class="modal-box"><button class="close-modal" onclick="closeModal()">ร</button>';
    html += `<h3>${property['ุงุณู ุงูุนูุงุฑ'] || ''}</h3>`;
    html += '<div class="property-details">';

    // ุฑูู  ุงููุญุฏุฉ (ุฌููุน ุงููุญุฏุงุช)
    html += `
    <div class="detail-row">
        <span class="detail-label">ุฑูู ุงููุญุฏุฉ:</span>
        <span class="detail-value">${allUnits.join(' , ')}${allUnits.length > 1 ? ` <span class="units-count">(${allUnits.length} ูุญุฏุงุช)</span>` : ''}</span>
    </div>
    <div class="detail-row">
        <span class="detail-label">ุงููุณุงุญุฉ ุงููุฌูุนุฉ:</span>
        <span class="detail-value">${totalArea ? totalArea.toLocaleString() : '0'} ูยฒ</span>
    </div>
    `;

    // ุจุงูู ุงูุญููู (ุชู ุฅุฒุงูุฉ ูุนูููุงุช ุงูุตู ูู ุงูุนุฑุถ ุงูุนุงู ูู ุงูุฌูุงู)
    const basicInfo = [
        { label: 'ุฑูู ุงูุนูุฏ', key: 'ุฑูู ุงูุนูุฏ' },
        { label: 'ุงุณู ุงููุณุชุฃุฌุฑ', key: 'ุงุณู ุงููุณุชุฃุฌุฑ' },
        { label: 'ุงููุงูู', key: 'ุงููุงูู' },
        { label: 'ุงููุฏููุฉ', key: 'ุงููุฏููุฉ' },
        { label: 'ููุน ุงูุนูุฏ', key: 'ููุน ุงูุนูุฏ' },
        { label: 'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก', key: 'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก' },
        { label: 'ุงูุงุฑุชูุงุน', key: 'ุงูุงุฑุชูุงุน' }
        // ููุงุญุธุฉ: ุชู ุฅุฒุงูุฉ 'ุฑูู ุงูุตู' ูู ุงูุนุฑุถ ุงูุนุงู ูู ุงูุฌูุงู
    ];

    basicInfo.forEach(info => {
        if (property[info.key]) {
            html += `
            <div class="detail-row">
                <span class="detail-label">${info.label}:</span>
                <span class="detail-value">${property[info.key]}</span>
            </div>`;
        }
    });

    // ุนุฑุถ ุงูุชูุงุฑูุฎ
    if (property['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:</span>
            <span class="detail-value" style="color: #2a4b9b;">${property['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']}</span>
        </div>`;
    }

    if (property['ุชุงุฑูุฎ ุงูููุงูุฉ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label">ุชุงุฑูุฎ ุงูููุงูุฉ:</span>
            <span class="detail-value" style="color: #2a4b9b;">${property['ุชุงุฑูุฎ ุงูููุงูุฉ']}</span>
        </div>`;
    }

    // ุนุฑุถ ุงูุญุงูุฉ
    const propertyStatus = calculateStatus(property);
    let statusClass = '';
    let badgeIcon = '';

    if (propertyStatus.isInstallmentEnded) {
        statusClass = 'installment-ended-status';
        badgeIcon = '<i class="fas fa-money-bill-wave"></i>';
    } else if (propertyStatus.final === 'ุฌุงุฑู') {
        statusClass = 'active-status';
        badgeIcon = '<i class="fas fa-check-circle"></i>';
    } else if (propertyStatus.final === 'ููุชูู') {
        statusClass = 'expired-status';
        badgeIcon = '<i class="fas fa-times-circle"></i>';
    } else if (propertyStatus.final === 'ุนูู ูุดู') {
        statusClass = 'pending-status';
        badgeIcon = '<i class="fas fa-exclamation-circle"></i>';
    }

    html += `
    <div class="detail-row ${statusClass}">
        <span class="detail-label">ุงูุญุงูุฉ:</span>
        <span class="detail-value">${badgeIcon} ${propertyStatus.display || ''}</span>
    </div>`;

    // ุฅุถุงูุฉ ุงููุจูุบ ุงูุฎุงุถุน ููุถุฑูุจุฉ ููููุฉ ุงูุถุฑูุจุฉ
    if (property['ุงูุงุฌูุงูู']) {
        if (property['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู') {
            const baseAmount = property['ุงูุงุฌูุงูู'] / 1.15;
            const vatAmount = property['ุงูุงุฌูุงูู'] - baseAmount;
            html += `
            <div class="detail-row">
                <span class="detail-label">ุงููุจูุบ ุงูุฎุงุถุน ููุถุฑูุจุฉ:</span>
                <span class="detail-value">${parseFloat(baseAmount).toFixed(2).toLocaleString()} ุฑูุงู</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ูููุฉ ุงูุถุฑูุจุฉ (15%):</span>
                <span class="detail-value">${parseFloat(vatAmount).toFixed(2).toLocaleString()} ุฑูุงู</span>
            </div>
            <div class="detail-row" style="font-weight: bold;">
                <span class="detail-label">ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ:</span>
                <span class="detail-value" style="color: #2a4b9b;">
                    ${parseFloat(property['ุงูุงุฌูุงูู']).toLocaleString()} ุฑูุงู
                </span>
            </div>`;
        } else {
            html += `
            <div class="detail-row">
                <span class="detail-label">ุงูุฅุฌูุงูู:</span>
                <span class="detail-value" style="color: #2a4b9b; font-weight: bold;">
                    ${parseFloat(property['ุงูุงุฌูุงูู']).toLocaleString()} ุฑูุงู
                </span>
            </div>`;
        }
    }

    // ุนุฑุถ ูููุน ุงูุนูุงุฑ ุฅุฐุง ูุงู ูุชููุฑุงู
    if (property['ูููุน ุงูุนูุงุฑ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label">ูููุน ุงูุนูุงุฑ:</span>
            <span class="detail-value">
                <a href="#" onclick="openLocation('${property['ูููุน ุงูุนูุงุฑ']}'); return false;" 
                   class="location-link">ูุชุญ ุงูุฎุฑูุทุฉ <i class="fas fa-map-marker-alt"></i></a>
            </span>
        </div>`;
    }

    html += `</div>`;

    // ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช
    html += `
    <div class="modal-actions">
        <button onclick="showPrintOptions('${property['ุฑูู ุงูุนูุฏ']}', '${property['ุงุณู ุงูุนูุงุฑ']}')" 
                class="modal-action-btn print-btn">
            <i class="fas fa-print"></i> ุทุจุงุนุฉ
        </button>`;
            
    if (property['ูููุน ุงูุนูุงุฑ']) {
        html += `
            <button onclick="openLocation('${property['ูููุน ุงูุนูุงุฑ']}')" 
                    class="modal-action-btn location-btn">
                <i class="fas fa-map-marker-alt"></i> ูุชุญ ุงููููุน
            </button>`;
    }
    
    html += `
        <button onclick="closeModal()" class="modal-action-btn close-btn">
            <i class="fas fa-times"></i> ุฅุบูุงู
        </button>
    </div>
    </div></div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // ุฅุถุงูุฉ ูุณุชูุน ูุฅุบูุงู ุงูููุฏุงู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ูุงูุฐุฉ ูููุฉ ุงููุฑูุฑ ูุน ุชุฃุซูุฑ blur
document.addEventListener('DOMContentLoaded', function() {
    if (!sessionStorage.getItem('auth_ok')) {
        showPasswordModal();
    }
});



function checkPassword() {
    const input = document.getElementById('passwordInput');
    const errorDiv = document.getElementById('passwordError');
    if (input.value === 'sa12345') {
        sessionStorage.setItem('auth_ok', '1');
        document.getElementById('blur-overlay').remove();
        document.body.style.overflow = '';
    } else {
        errorDiv.textContent = 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ';
        input.value = '';
        input.focus();
    }
}

// ุฅุบูุงู ุงูููุฏุงู (ุงูุชุตููู ุงูุณุงุจู)
function closeModal() {
    // ุญูุธ ุชููุงุฆู ูุจู ุงูุฅุบูุงู ุฅุฐุง ูุงู ููุงู ูููุฐุฌ ุชุญุฑูุฑ ูุดุท
    const activeForm = document.querySelector('.modal-overlay form');
    if (activeForm && typeof autoSaveInstallmentChanges === 'function') {
        autoSaveInstallmentChanges();
    }

    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(modal => {
        modal.remove();
    });
}

// ุฏุงูุฉ ููุชุญูู ูู ูุฌูุฏ ูุงูุฐุฉ ููุชูุญุฉ ูุฅุบูุงููุง ุฃู ูุชุญ ูุงูุฐุฉ ุฌุฏูุฏุฉ
function toggleModal(modalCheckFunction, modalOpenFunction) {
    // ุงูุชุญูู ูู ูุฌูุฏ ูุงูุฐุฉ ููุชูุญุฉ
    const existingModal = document.querySelector('.modal-overlay');

    if (existingModal) {
        // ุฅุฐุง ูุงูุช ููุงู ูุงูุฐุฉ ููุชูุญุฉุ ุฃุบูููุง
        closeModal();
        return false; // ุชู ุงูุฅุบูุงู
    } else {
        // ุฅุฐุง ูู ุชูู ููุงู ูุงูุฐุฉ ููุชูุญุฉุ ุงูุชุญ ุงููุงูุฐุฉ ุงูุฌุฏูุฏุฉ
        modalOpenFunction();
        return true; // ุชู ุงููุชุญ
    }
}

// ุนุฑุถ ููุชุฑ ุงูุดูุฑ ูุน ุขููุฉ ุงูุชุจุฏูู
function showMonthFilterModal() {
  // ุงูุชุญูู ูู ูุฌูุฏ ูุงูุฐุฉ ููุชูุญุฉ ูุฅุบูุงููุง ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
  const existingModal = document.querySelector('.modal-overlay');
  if (existingModal) {
    closeModal();
    return;
  }

  let html = `
    <div class="modal-overlay" style="display:flex;">
      <div class="modal-box">
        <button class="close-modal" onclick="closeModal()">ร</button>
        <h3>ููุชุฑ ุงูุดูุฑ</h3>
        <div class="date-filter-container" style="flex-direction:column;gap:10px;">
          <select id="filterTypeModal" class="date-filter-select">
            <option value="">ููุน ุงูุชุงุฑูุฎ</option>
            <option value="start">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</option>
            <option value="end">ุชุงุฑูุฎ ุงูููุงูุฉ</option>
          </select>
          <select id="filterDayModal" class="date-filter-select">
            <option value="">ุงูููู</option>
            ${Array.from({length: 31}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
          </select>
          <select id="filterMonthModal" class="date-filter-select">
            <option value="">ุงูุดูุฑ</option>
            ${['ููุงูุฑ','ูุจุฑุงูุฑ','ูุงุฑุณ','ุฅุจุฑูู','ูุงูู','ููููู','ููููู','ุฃุบุณุทุณ','ุณุจุชูุจุฑ','ุฃูุชูุจุฑ','ููููุจุฑ','ุฏูุณูุจุฑ']
              .map((m,i)=>`<option value="${i+1}">${m}</option>`).join('')}
          </select>
          <select id="filterYearModal" class="date-filter-select">
            <option value="">ุงูุณูุฉ</option>
            ${Array.from({length: 81}, (_, i) => `<option value="${2020+i}">${2020+i}</option>`).join('')}
          </select>
          <div style="display:flex;gap:10px;justify-content:center;margin-top:10px;">
            <button onclick="applyMonthFilterModal()" class="apply-filter-btn"><i class="fas fa-check"></i> ุชุทุจูู</button>
            <button onclick="clearMonthFilterModal()" class="clear-filter-btn"><i class="fas fa-times"></i> ูุณุญ</button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
  // ุชุนุจุฆุฉ ุงูููู ุงูุญุงููุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
  document.getElementById('filterTypeModal').value = dateFilterType;
  document.getElementById('filterDayModal').value = dateFilterDay;
  document.getElementById('filterMonthModal').value = dateFilterMonth;
  document.getElementById('filterYearModal').value = dateFilterYear;
}

function applyMonthFilterModal() {
  dateFilterType = document.getElementById('filterTypeModal').value;
  dateFilterDay = document.getElementById('filterDayModal').value;
  dateFilterMonth = document.getElementById('filterMonthModal').value;
  dateFilterYear = document.getElementById('filterYearModal').value;
  closeModal();
  renderData();
}

function clearMonthFilterModal() {
  dateFilterType = '';
  dateFilterDay = '';
  dateFilterMonth = '';
  dateFilterYear = '';
  closeModal();
  renderData();
}
// ูุงูุฐุฉ ููุชุฑ ููุน ุงูุนูุฏ ูุน ุขููุฉ ุงูุชุจุฏูู
function showContractTypeFilter() {
    // ุงูุชุญูู ูู ูุฌูุฏ ูุงูุฐุฉ ููุชูุญุฉ ูุฅุบูุงููุง ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        closeModal();
        return;
    }

    let html = `
    <div class="modal-overlay" style="display:flex;">
      <div class="modal-box">
        <button class="close-modal" onclick="closeModal()">ร</button>
        <h3>ููุชุฑ ููุน ุงูุนูุฏ</h3>
        <div class="contract-type-filter">
          <button onclick="setContractTypeFilter(null)" class="filter-btn${!contractTypeFilter ? ' active' : ''}">ุงููู</button>
          <button onclick="setContractTypeFilter('ุถุฑูุจู')" class="filter-btn${contractTypeFilter === 'ุถุฑูุจู' ? ' active' : ''}">ุถุฑูุจู</button>
          <button onclick="setContractTypeFilter('ุณููู')" class="filter-btn${contractTypeFilter === 'ุณููู' ? ' active' : ''}">ุณููู</button>
        </div>
      </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
    // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงูููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ุชุนููู ููุชุฑ ููุน ุงูุนูุฏ
function setContractTypeFilter(type) {
    contractTypeFilter = type;
    closeModal();
    renderData();
}

// ุฑุจุท ุงูุฒุฑ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', function() {
    const contractTypeBtn = document.getElementById('contractTypeFilterBtn');
    if (contractTypeBtn) {
        contractTypeBtn.addEventListener('click', showContractTypeFilter);
    }
});
// ...existing code...

// ุฏุงูุฉ ูุณูุทุฉ ูุนุฑุถ ุงูุชูุงุตูู ุญุณุจ ุฑูู ุงูุนูุฏ ูุงุณู ุงูุนูุงุฑ
function showPropertyDetailsByKey(contractNumber, propertyName) {
    // ุงุจุญุซ ุนู ุฃูู ุนูุตุฑ ูุทุงุจู ุฑูู ุงูุนูุฏ ูุงุณู ุงูุนูุงุฑ
    const prop = properties.find(
        p => p['ุฑูู ุงูุนูุฏ'] == contractNumber && p['ุงุณู ุงูุนูุงุฑ'] == propertyName
    );
    if (!prop) return;
    // ุงุณุชุฎุฏู ุฏุงูุฉ ุนุฑุถ ุงูุชูุงุตูู ุงูุฃุตููุฉ
    showPropertyDetails(properties.indexOf(prop));
}
// ุนุฑุถ ุชูุงุตูู ุงููุญุฏุฉ ุนูุฏ ุงูููุฑ ุนูู ุฑูู ุงููุญุฏุฉ
function showUnitDetails(unitNumber, propertyName, contractNumber = null) {
    // ุงุจุญุซ ุนู ุงููุญุฏุฉ ุจูุงุกู ุนูู ุฑูู ุงููุญุฏุฉ ูุงุณู ุงูุนูุงุฑ (ูุฑูู ุงูุนูุฏ ุฅู ูุฌุฏ)
    let unit = null;
    if (contractNumber) {
        unit = properties.find(
            p => p['ุฑูู  ุงููุญุฏุฉ '] == unitNumber && p['ุงุณู ุงูุนูุงุฑ'] == propertyName && p['ุฑูู ุงูุนูุฏ'] == contractNumber
        );
    } else {
        unit = properties.find(
            p => p['ุฑูู  ุงููุญุฏุฉ '] == unitNumber && p['ุงุณู ุงูุนูุงุฑ'] == propertyName
        );
    }
    if (!unit) return;

    // ูุงูุฐุฉ ุชูุงุตูู ุงููุญุฏุฉ (ุฌููุน ุงููุนูููุงุช ุงููุญุฏุซุฉ)
    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box unit-details-modal">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <div class="modal-header">
                <h3><i class="fas fa-home"></i> ุชูุงุตูู ุงููุญุฏุฉ ${unitNumber}</h3>
                <p>${unit['ุงุณู ุงูุนูุงุฑ'] || ''} - ${unit['ุงููุฏููุฉ'] || ''}</p>
            </div>
            <div class="property-details">

                <!-- ูุนูููุงุช ุงูุนูุงุฑ ุงูุฃุณุงุณูุฉ -->
                <div class="details-section">
                    <h4><i class="fas fa-building"></i> ูุนูููุงุช ุงูุนูุงุฑ</h4>
                    <div class="details-grid">`;

    // ุงุณู ุงูุนูุงุฑ
    html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-building"></i> ุงุณู ุงูุนูุงุฑ:</span>
            <span class="detail-value">${unit['ุงุณู ุงูุนูุงุฑ'] || ''}</span>
        </div>`;

    // ุงููุฏููุฉ
    html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-map-marker-alt"></i> ุงููุฏููุฉ:</span>
            <span class="detail-value">${unit['ุงููุฏููุฉ'] || ''}</span>
        </div>`;

    // ุฑูู ุงูุตู (ูุนูููุงุช ุงูุนูุงุฑ ุงููุญุฏุซุฉ)
    if (unit['ุฑูู ุงูุตู']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-file-contract"></i> ุฑูู ุงูุตู:</span>
            <span class="detail-value">${unit['ุฑูู ุงูุตู']}</span>
        </div>`;
    }

    // ูุณุงุญุฉ ุงูุตู (ูุนูููุงุช ุงูุนูุงุฑ ุงููุญุฏุซุฉ)
    if (unit['ูุณุงุญุฉุงูุตู']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-ruler-combined"></i> ูุณุงุญุฉ ุงูุตู:</span>
            <span class="detail-value">${parseFloat(unit['ูุณุงุญุฉุงูุตู']).toLocaleString()} ูยฒ</span>
        </div>`;
    }

    // ุงูุณุฌู ุงูุนููู (ูุนูููุงุช ุงูุนูุงุฑ ุงููุญุฏุซุฉ)
    if (unit['ุงูุณุฌู ุงูุนููู ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-clipboard-list"></i> ุงูุณุฌู ุงูุนููู:</span>
            <span class="detail-value">${unit['ุงูุณุฌู ุงูุนููู ']}</span>
        </div>`;
    }

    // ุงููุงูู (ูุนูููุงุช ุงูุนูุงุฑ ุงููุญุฏุซุฉ)
    if (unit['ุงููุงูู']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-user"></i> ุงููุงูู:</span>
            <span class="detail-value">${unit['ุงููุงูู']}</span>
        </div>`;
    }

    // ูููุน ุงูุนูุงุฑ (ูุนูููุงุช ุงูุนูุงุฑ ุงููุญุฏุซุฉ)
    if (unit['ูููุน ุงูุนูุงุฑ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-location-arrow"></i> ูููุน ุงูุนูุงุฑ:</span>
            <span class="detail-value">
                <a href="https://www.google.com/maps/search/${encodeURIComponent(unit['ูููุน ุงูุนูุงุฑ'])}" target="_blank" class="location-link">
                    ${unit['ูููุน ุงูุนูุงุฑ']} <i class="fas fa-external-link-alt"></i>
                </a>
            </span>
        </div>`;
    }

    html += `
                    </div>
                </div>

                <!-- ูุนูููุงุช ุงููุญุฏุฉ -->
                <div class="details-section">
                    <h4><i class="fas fa-door-open"></i> ูุนูููุงุช ุงููุญุฏุฉ</h4>
                    <div class="details-grid">`;

    // ุฑูู ุงููุญุฏุฉ
    html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-hashtag"></i> ุฑูู ุงููุญุฏุฉ:</span>
            <span class="detail-value">${unit['ุฑูู  ุงููุญุฏุฉ '] || ''}</span>
        </div>`;

    // ุงููุณุงุญุฉ
    html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-expand-arrows-alt"></i> ุงููุณุงุญุฉ:</span>
            <span class="detail-value">${unit['ุงููุณุงุญุฉ'] ? parseFloat(unit['ุงููุณุงุญุฉ']).toLocaleString() + ' ูยฒ' : 'ุบูุฑ ูุญุฏุฏ'}</span>
        </div>`;

    // ูุนูููุงุช ุงููุณุชุฃุฌุฑ ูุงูุนูุฏ
    if (unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || unit['ุฑูู ุงูุนูุฏ']) {
        html += `
                    </div>
                </div>

                <!-- ูุนูููุงุช ุงููุณุชุฃุฌุฑ ูุงูุนูุฏ -->
                <div class="details-section">
                    <h4><i class="fas fa-user-tie"></i> ูุนูููุงุช ุงููุณุชุฃุฌุฑ ูุงูุนูุฏ</h4>
                    <div class="details-grid">`;

        // ุงุณู ุงููุณุชุฃุฌุฑ
        if (unit['ุงุณู ุงููุณุชุฃุฌุฑ']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-user"></i> ุงุณู ุงููุณุชุฃุฌุฑ:</span>
            <span class="detail-value">${unit['ุงุณู ุงููุณุชุฃุฌุฑ']}</span>
        </div>`;
        }

        // ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ
        if (unit['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-phone"></i> ุฑูู ุงูุฌูุงู:</span>
            <span class="detail-value">
                <a href="tel:${unit['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ']}" class="phone-link">
                    ${unit['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ']} <i class="fas fa-phone-alt"></i>
                </a>
            </span>
        </div>`;
        }

        // ุฑูู ุฌูุงู ุฅุถุงูู
        if (unit['ุฑูู ุฌูุงู ุฅุถุงูู']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-mobile-alt"></i> ุฌูุงู ุฅุถุงูู:</span>
            <span class="detail-value">
                <a href="tel:${unit['ุฑูู ุฌูุงู ุฅุถุงูู']}" class="phone-link">
                    ${unit['ุฑูู ุฌูุงู ุฅุถุงูู']} <i class="fas fa-phone-alt"></i>
                </a>
            </span>
        </div>`;
        }

        // ุฑูู ุงูุนูุฏ
        if (unit['ุฑูู ุงูุนูุฏ']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-file-signature"></i> ุฑูู ุงูุนูุฏ:</span>
            <span class="detail-value">${unit['ุฑูู ุงูุนูุฏ']}</span>
        </div>`;
        }

        // ูููุฉ ุงูุฅูุฌุงุฑ - ูุฎูู ุญุณุจ ุทูุจ ุงููุณุชุฎุฏู
        // if (unit['ูููุฉ  ุงูุงูุฌุงุฑ ']) {
        //     html += `
        // <div class="detail-row">
        //     <span class="detail-label"><i class="fas fa-money-bill-wave"></i> ูููุฉ ุงูุฅูุฌุงุฑ:</span>
        //     <span class="detail-value">${parseFloat(unit['ูููุฉ  ุงูุงูุฌุงุฑ ']).toLocaleString()} ุฑูุงู</span>
        // </div>`;
        // }

        // ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ
        if (unit['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-calendar-plus"></i> ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ:</span>
            <span class="detail-value">${unit['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ']}</span>
        </div>`;
        }

        // ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ
        if (unit['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-calendar-minus"></i> ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ:</span>
            <span class="detail-value">${unit['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ']}</span>
        </div>`;
        }

        // ููุน ุงูุนูุฏ
        if (unit['ููุน ุงูุนูุฏ']) {
            html += `
        <div class="detail-row">
            <span class="detail-label"><i class="fas fa-tag"></i> ููุน ุงูุนูุฏ:</span>
            <span class="detail-value">${unit['ููุน ุงูุนูุฏ']}</span>
        </div>`;
        }

        html += `
                    </div>
                </div>`;
    } else {
        html += `
                    </div>
                </div>

                <!-- ูุญุฏุฉ ูุงุฑุบุฉ -->
                <div class="details-section">
                    <div class="empty-unit-notice">
                        <i class="fas fa-info-circle"></i>
                        <span>ูุฐู ุงููุญุฏุฉ ูุงุฑุบุฉ - ูุง ููุฌุฏ ูุณุชุฃุฌุฑ ุญุงููุงู</span>
                    </div>
                </div>`;
    }

    // ูุนูููุงุช ุงูุชุญุฏูุซ
    if (unit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ']) {
        html += `
                <div class="details-section">
                    <h4><i class="fas fa-clock"></i> ูุนูููุงุช ุงูุชุญุฏูุซ</h4>
                    <div class="details-grid">
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-calendar-check"></i> ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ:</span>
                            <span class="detail-value">${unit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ']}</span>
                        </div>`;

        if (unit['ููุน ุงูุชุญุฏูุซ']) {
            html += `
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-edit"></i> ููุน ุงูุชุญุฏูุซ:</span>
                            <span class="detail-value">${unit['ููุน ุงูุชุญุฏูุซ']}</span>
                        </div>`;
        }

        if (unit['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ']) {
            html += `
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-user-cog"></i> ุงููุณุคูู ุนู ุงูุชุญุฏูุซ:</span>
                            <span class="detail-value">${unit['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ']}</span>
                        </div>`;
        }

        html += `
                    </div>
                </div>`;
    }

    html += `
            </div>
            <div class="modal-actions">
                <button onclick="showCardEditModal('${unit['ุฑูู ุงูุนูุฏ'] || ''}', '${unit['ุงุณู ุงูุนูุงุฑ']}', '${unit['ุฑูู  ุงููุญุฏุฉ ']}')" class="modal-action-btn edit-btn">
                    <i class="fas fa-edit"></i> ุชุญุฑูุฑ ุงููุญุฏุฉ
                </button>
                <button onclick="editProperty('${unit['ุงุณู ุงูุนูุงุฑ']}')" class="modal-action-btn property-btn">
                    <i class="fas fa-building"></i> ุชุญุฑูุฑ ุงูุนูุงุฑ
                </button>
                <button onclick="closeModal()" class="modal-action-btn close-btn">
                    <i class="fas fa-times"></i> ุฅุบูุงู
                </button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // ุฅุบูุงู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌ ุงูููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}
// ...existing code...
// ุฏุงูุฉ ูุชุญ ูุงูุฐุฉ ุงุฎุชูุงุฑ ุงูุญููู ููุทุจุงุนุฉ
function showPrintOptions(contractNumber, propertyName, unitNumber = null) {
    let property;
    if (contractNumber) {
        property = properties.find(p => p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    } else if (unitNumber) {
        property = properties.find(p => p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    } else {
        property = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    }
    if (!property) return;
    
    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <h3>ุงุฎุชุฑ ุงูุจูุงูุงุช ุงููุฑุงุฏ ุทุจุงุนุชูุง</h3>
            <div class="print-options">
                <div class="select-actions">
                    <button onclick="selectAllFields()" class="select-btn select-all">
                        <i class="fas fa-check-double"></i>
                        ุชุญุฏูุฏ ุงููู
                    </button>
                    <button onclick="deselectAllFields()" class="select-btn deselect-all">
                        <i class="fas fa-times"></i>
                        ุฅูุบุงุก ุงูุชุญุฏูุฏ
                    </button>
                </div>
                <div class="fields-container">`;
    
    // ุฅุถุงูุฉ ุฌููุน ุงูุญููู ุงูููููุฉ ูุฎูุงุฑุงุช (ูุน ุฅุฎูุงุก ุงูุญููู ุบูุฑ ุงููุฑุบูุจ ูููุง)
    Object.keys(property).forEach(key => {
        if (!shouldHideField(key)) {
            html += `
            <label class="field-option">
                <input type="checkbox" name="printFields" value="${key}" checked>
                <span>${key}</span>
            </label>`;
        }
    });
    
    html += `
                </div>
                <div class="print-actions">
                    <button onclick="executePrint('${contractNumber}', '${propertyName}'${unitNumber ? `, '${unitNumber}'` : ''})" class="modal-action-btn print-btn">
                        <i class="fas fa-print"></i> ุทุจุงุนุฉ
                    </button>
                    <button onclick="closeModal()" class="modal-action-btn close-btn">
                        <i class="fas fa-times"></i> ุฅูุบุงุก
                    </button>
                </div>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', html);
}

// ุชุญุฏูุฏ ูู ุงูุญููู ููุทุจุงุนุฉ
function selectAllFields() {
    document.querySelectorAll('input[name="printFields"]').forEach(cb => cb.checked = true);
}

// ุฅูุบุงุก ุชุญุฏูุฏ ูู ุงูุญููู ููุทุจุงุนุฉ
function deselectAllFields() {
    document.querySelectorAll('input[name="printFields"]').forEach(cb => cb.checked = false);
}

// ุชูููุฐ ุงูุทุจุงุนุฉ ุจูุงุกู ุนูู ุงูุญููู ุงููุฎุชุงุฑุฉ
function executePrint(contractNumber, propertyName, unitNumber = null) {
    let related;
    if (contractNumber) {
        related = properties.filter(p => p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    } else if (unitNumber) {
        related = properties.filter(p => p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    } else {
        related = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    }
    if (related.length === 0) return;

    const property = related[0];
    const status = calculateStatus(property);
    const printWindow = window.open('', '_blank');

    // ุงูุญุตูู ุนูู ุงูุญููู ุงููุญุฏุฏุฉ ููุท
    const selectedFields = Array.from(document.querySelectorAll('input[name="printFields"]:checked')).map(cb => cb.value);

    if (selectedFields.length === 0) {
        alert('ุงูุฑุฌุงุก ุชุญุฏูุฏ ุญูู ูุงุญุฏ ุนูู ุงูุฃูู ููุทุจุงุนุฉ');
        return;
    }

    let printContent = `
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>ุทุจุงุนุฉ ุงูุนูุงุฑ - ${property['ุงุณู ุงูุนูุงุฑ'] || ''}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
            body {
                font-family: 'Tajawal', sans-serif;
                padding: 20px;
                direction: rtl;
            }
            .header {
                text-align: center;
                margin-bottom:  20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #2a4b9b;
                position: relative;
            }
            .print-logo {
                position: absolute;
                top: 0;
                left: 0;
                width: 110px;
                height: auto;
                margin: 10px 0 0 10px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            th, td {
                padding: 10px;
                border: 1px solid #ddd;
                text-align: right;
            }
            th {
                background-color: #333;
                color: white;
                font-weight: bold;
                width: 30%;
            }
            .footer {
                margin-top: 30px;
                text-align: center;
                font-size: 0.9rem;
                color: #777;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <img src="logo.jpeg" class="print-logo" alt="logo" />
            <h1>ุชูุงุตูู ุงูุนูุงุฑ</h1>
            <h2>${property['ุงุณู ุงูุนูุงุฑ'] || ''}</h2>
        </div>
        <table>`;

    // ุฅุฐุง ุชู ุงุฎุชูุงุฑ ุฑูู ุงููุญุฏุฉุ ุงุนุฑุถ ุฌููุน ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ
    if (selectedFields.includes('ุฑูู  ุงููุญุฏุฉ ')) {
        const allUnits = related.map(p => p['ุฑูู  ุงููุญุฏุฉ ']).filter(Boolean);
        if (allUnits.length > 0) {
            printContent += `
                <tr>
                    <th>ุฑูู ุงููุญุฏุฉ:</th>
                    <td>${allUnits.join(' , ')}${allUnits.length > 1 ? ` (${allUnits.length} ูุญุฏุงุช)` : ''}</td>
                </tr>`;
        }
    }

    // ุทุจุงุนุฉ ุงูุญููู ุงููุญุฏุฏุฉ ููุท (ูุน ุฅุฎูุงุก ุงูุญููู ุบูุฑ ุงููุฑุบูุจ ูููุง)
    const additionalHiddenFields = ['ุฑูู  ุงููุญุฏุฉ ', 'ุงูุญุงูุฉ ุงูููุงุฆูุฉ', 'ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'];
    selectedFields.forEach(key => {
        if (shouldHideField(key) || additionalHiddenFields.includes(key)) return; // ุชุฌุงูู ุงูุญููู ุงููุฎููุฉ
        let value = property[key];
        if (!value && value !== 0) return;
        let displayValue = value;
        if (key === 'ุงูุงุฌูุงูู' && value) {
            displayValue = parseFloat(value).toLocaleString() + ' ุฑูุงู';
        } else if (key === 'ูููุน ุงูุนูุงุฑ' && value) {
            let url = value;
            if (!url.startsWith('http')) {
                url = `https://www.google.com/maps/search/${encodeURIComponent(url)}`;
            }
            displayValue = `<a href="${url}" target="_blank" class="location-link">ุงูุฎุฑูุทุฉ <i class="fas fa-map-marker-alt"></i></a>`;
        }
        printContent += `
            <tr>
                <th>${key}</th>
                <td>${displayValue}</td>
            </tr>`;
    });

    printContent += `
        </table>
        <div class="footer">
            <p>ุชูุช ุทุจุงุนุฉ ูุฐุง ุงููุณุชูุฏ ูู ูุธุงู ุดุฑูุฉ ุงูุณููุฏู ุงูุนูุงุฑูุฉ</p>
            <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${new Date().toLocaleDateString('ar-SA')}</p>
        </div>
        <script>
            window.onload = function() {
                window.print();
            }
        </script>
    </body>
    </html>`;

    printWindow.document.write(printContent);
    printWindow.document.close();
    closeModal();
}
function showInstallmentsDetails(contractNumber, propertyName) {
    // ุงุจุญุซ ุนู ุฃูู ุนูุตุฑ ูุทุงุจู ุฑูู ุงูุนูุฏ ูุงุณู ุงูุนูุงุฑ
    const prop = properties.find(p => p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    if (!prop) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ');
        return;
    }

    // ุญุณุงุจ ุนุฏุฏ ุงูุฃูุณุงุท ุงููุนูู
    let actualInstallmentCount = 0;
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        if (prop[dateKey] || prop[amountKey]) {
            actualInstallmentCount = i;
        }
    }

    if (actualInstallmentCount === 0) {
        alert('ูุง ุชูุฌุฏ ุฃูุณุงุท ููุฐุง ุงูุนูุงุฑ');
        return;
    }

    // ุชุญุฏูุฏ ููู ุงูุญุงูุฉ
    let status = 'default';
    const statusObj = calculateStatus(prop);
    if (statusObj.isInstallmentEnded) {
        status = 'installment-ended';
    } else if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ']) {
        if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] === 'ุฌุงุฑู') status = 'active';
        else if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] === 'ููุชูู') status = 'expired';
        else if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] === 'ุนูู ูุดู') status = 'pending';
        else if (prop['ุงูุญุงูุฉ ุงูููุงุฆูุฉ'] === 'ูุงุฑุบ') status = 'empty';
    }

    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box installments-details-modal">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <div class="modal-header">
                <h3><i class="fas fa-calendar-check"></i> ุชูุงุตูู ุงูุฃูุณุงุท</h3>
                <p>${prop['ุงุณู ุงูุนูุงุฑ']} - ${prop['ุงุณู ุงููุณุชุฃุฌุฑ'] || 'ุบูุฑ ูุญุฏุฏ'}</p>
            </div>
            <div class="installments-summary">
                <div class="summary-item">
                    <span class="summary-label">ุฅุฌูุงูู ุงูุฃูุณุงุท:</span>
                    <span class="summary-value">${actualInstallmentCount}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ุฑูู ุงูุนูุฏ:</span>
                    <span class="summary-value">${prop['ุฑูู ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ููุน ุงูุนูุฏ:</span>
                    <span class="summary-value">${prop['ููุน ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</span>
                </div>
            </div>
            <div class="installments-grid">`;

    let totalAmount = 0;
    let installmentsWithAmount = 0;

    for (let i = 1; i <= actualInstallmentCount; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        const date = prop[dateKey];
        const amount = prop[amountKey];

        if (date || amount) {
            const amountValue = parseFloat(amount) || 0;
            if (amountValue > 0) {
                totalAmount += amountValue;
                installmentsWithAmount++;
            }

            const base = amountValue / 1.15;
            const vat = amountValue - base;

            html += `
            <div class="installment-card installment-${status}">
                <div class="installment-header">
                    <h4><i class="fas fa-calendar-day"></i> ุงููุณุท ${getArabicNumber(i)}</h4>
                    <span class="installment-number">#${i}</span>
                </div>
                <div class="installment-body">
                    ${date ? `
                    <div class="installment-field">
                        <span class="field-label"><i class="fas fa-calendar"></i> ุงูุชุงุฑูุฎ:</span>
                        <span class="field-value">${date}</span>
                    </div>` : `
                    <div class="installment-field missing">
                        <span class="field-label"><i class="fas fa-calendar"></i> ุงูุชุงุฑูุฎ:</span>
                        <span class="field-value">ุบูุฑ ูุญุฏุฏ</span>
                    </div>`}

                    ${amount ? `
                    <div class="installment-field">
                        <span class="field-label"><i class="fas fa-money-bill-wave"></i> ุงููุจูุบ ุงูููู:</span>
                        <span class="field-value amount">${amountValue.toLocaleString()} ุฑูุงู</span>
                    </div>
                    ${prop['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู' ? `
                    <div class="installment-field tax-details">
                        <span class="field-label">ุงููุจูุบ ุงูุฎุงุถุน ููุถุฑูุจุฉ:</span>
                        <span class="field-value">${base.toFixed(2).toLocaleString()} ุฑูุงู</span>
                    </div>
                    <div class="installment-field tax-details">
                        <span class="field-label">ูููุฉ ุงูุถุฑูุจุฉ (15%):</span>
                        <span class="field-value">${vat.toFixed(2).toLocaleString()} ุฑูุงู</span>
                    </div>` : ''}` : `
                    <div class="installment-field missing">
                        <span class="field-label"><i class="fas fa-money-bill-wave"></i> ุงููุจูุบ:</span>
                        <span class="field-value">ุบูุฑ ูุญุฏุฏ</span>
                    </div>`}
                </div>
            </div>`;
        }
    }

    html += `</div>
            <div class="installments-total">
                <div class="total-item">
                    <span class="total-label">ุฅุฌูุงูู ุงููุจูุบ:</span>
                    <span class="total-value">${totalAmount.toLocaleString()} ุฑูุงู</span>
                </div>
                <div class="total-item">
                    <span class="total-label">ุฃูุณุงุท ุจูุจุงูุบ:</span>
                    <span class="total-value">${installmentsWithAmount} ูู ${actualInstallmentCount}</span>
                </div>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);

    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}
// ุฑุจุท ุฒุฑ ููุชุฑ ุงูุดูุฑ ูู ุงูููุฏุฑ ุจุฌููุน ุงูุดุงุดุงุช
document.addEventListener('DOMContentLoaded', function() {
    const monthBtn = document.getElementById('monthFilterBtn');
    if (monthBtn) {
        monthBtn.addEventListener('click', showMonthFilterModal);
    }
});
// ุนุฑุถ ูุงูุฐุฉ ุงุฎุชูุงุฑ ุงููุฏููุฉ ููููุชุฑ ุงูุฌุฏูุฏ ูุน ุขููุฉ ุงูุชุจุฏูู
function showMultiPropertyCityFilter() {
    // ุงูุชุญูู ูู ูุฌูุฏ ูุงูุฐุฉ ููุชูุญุฉ ูุฅุบูุงููุง ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        closeModal();
        return;
    }

    const cities = getUniqueCountries().filter(c => c !== 'ุงููู');
    let html = `<div class="modal-overlay" style="display:flex;">
      <div class="modal-box">
        <button class="close-modal" onclick="closeModal()">ร</button>
        <h3>ุงุฎุชุฑ ุงููุฏููุฉ</h3>
        <div class="country-selection">`;
    cities.forEach(city => {
        html += `<button onclick="selectMultiFilterCity('${city}')">${city}</button>`;
    });
    html += `</div></div></div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

function selectMultiFilterCity(city) {
    closeModal();
    multiFilterSelectedCity = city;
    multiFilterSelectedProperties = [];
    const props = properties.filter(p => p.ุงููุฏููุฉ === city)
        .map(p => p['ุงุณู ุงูุนูุงุฑ'])
        .filter((v, i, arr) => v && arr.indexOf(v) === i);

    let html = `<div class="modal-overlay" style="display:flex;">
      <div class="modal-box" style="max-width:420px;">
        <button class="close-modal" onclick="closeModal()">ร</button>
        <h3>ุงุฎุชุฑ ุงูุนูุงุฑุงุช (ูููู ุชุญุฏูุฏ ุฃูุซุฑ ูู ุนูุงุฑ)</h3>
        <input type="text" id="multiPropertySearch" placeholder="ุจุญุซ ุนู ุนูุงุฑ..." style="width:95%;margin-bottom:12px;padding:10px 12px;border-radius:8px;border:1.5px solid #d1d5db;font-size:1.05rem;">
        <div id="multiPropertyList" style="max-height:300px;overflow:auto;padding:10px 0 10px 0;">`;

    props.forEach(prop => {
        html += `<label class="multi-property-option" style="display:block;margin-bottom:8px;padding:7px 8px;border-radius:7px;transition:background 0.2s;">
            <input type="checkbox" value="${prop}" onchange="toggleMultiFilterProperty(this)">
            <span>${prop}</span>
        </label>`;
    });
    html += `</div>
      <div class="modal-actions" style="flex-direction:row;gap:10px;">
        <button onclick="applyMultiPropertyFilter()" class="modal-action-btn print-btn" style="flex:1;">
          <i class="fas fa-check"></i> ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
        </button>
        <button onclick="closeModal()" class="modal-action-btn close-btn" style="flex:1;">
          <i class="fas fa-times"></i> ุฅูุบุงุก
        </button>
      </div>
      </div></div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // ุจุญุซ ุฏููุงูููู
    document.getElementById('multiPropertySearch').addEventListener('input', function() {
        const term = this.value.trim().toLowerCase();
        document.querySelectorAll('#multiPropertyList .multi-property-option').forEach(label => {
            const text = label.textContent.trim().toLowerCase();
            label.style.display = text.includes(term) ? '' : 'none';
        });
    });

    // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงูููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนูุงุฑุงุช ุงููุฎุชุงุฑุฉ
function toggleMultiFilterProperty(checkbox) {
    const val = checkbox.value;
    if (checkbox.checked) {
        if (!multiFilterSelectedProperties.includes(val)) multiFilterSelectedProperties.push(val);
    } else {
        multiFilterSelectedProperties = multiFilterSelectedProperties.filter(p => p !== val);
    }
}

// ุนูุฏ ุงูุถุบุท ุนูู "ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช"
function applyMultiPropertyFilter() {
    closeModal();
    if (!multiFilterSelectedCity || multiFilterSelectedProperties.length === 0) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ูุฏููุฉ ูุนูุงุฑ ูุงุญุฏ ุนูู ุงูุฃูู');
        return;
    }
    // ุชุตููุฉ ุงูุจูุงูุงุช
    const filtered = properties.filter(p =>
        p.ุงููุฏููุฉ === multiFilterSelectedCity &&
        multiFilterSelectedProperties.includes(p['ุงุณู ุงูุนูุงุฑ'])
    );
    showMultiPropertyStats(filtered);
}

// ุนุฑุถ ูุงูุฐุฉ ุงูุฅุญุตุงุฆูุงุช ุงููุฌูุนุฉ
// ...existing code...
function showMultiPropertyStats(filtered) {
    // ุชุฌููุน ุญุณุจ ุงุณู ุงูุนูุงุฑ
    const grouped = {};
    filtered.forEach(p => {
        const name = p['ุงุณู ุงูุนูุงุฑ'];
        if (!name) return;
        if (!grouped[name]) grouped[name] = [];
        grouped[name].push(p);
    });

    // ุชุญุถูุฑ ุจูุงูุงุช ูู ุนูุงุฑ
    const stats = {};
    let totalUnits = 0, totalTenants = 0, totalBeforeTax = 0, totalVat = 0, totalAfterTax = 0, totalResidential = 0;

    Object.entries(grouped).forEach(([name, props]) => {
        const units = props.length;
        // ุชุฌููุน ุงูุนููุฏ ุงููุฑูุฏุฉ ูุน ุงุนุชูุงุฏ ุฃูู ูุจูุบ ุบูุฑ ูุงุฑุบ ุฃู ุงูุฃูุจุฑ
        const contracts = {};
        props.forEach(p => {
            if (p['ุฑูู ุงูุนูุฏ']) {
                if (
                    !contracts[p['ุฑูู ุงูุนูุฏ']] ||
                    (!contracts[p['ุฑูู ุงูุนูุฏ']]['ุงูุงุฌูุงูู'] && p['ุงูุงุฌูุงูู']) ||
                    (
                        p['ุงูุงุฌูุงูู'] && contracts[p['ุฑูู ุงูุนูุฏ']]['ุงูุงุฌูุงูู'] &&
                        parseFloat(p['ุงูุงุฌูุงูู']) > parseFloat(contracts[p['ุฑูู ุงูุนูุฏ']]['ุงูุงุฌูุงูู'])
                    )
                ) {
                    contracts[p['ุฑูู ุงูุนูุฏ']] = p;
                }
            }
        });
        const contractsArr = Object.values(contracts);

        // ุนุฏุฏ ุงููุณุชุฃุฌุฑูู ุงููุฑูุฏูู (ุญุณุจ ุฑูู ุงูุนูุฏ)
        const tenants = new Set(contractsArr.map(p => p['ุงุณู ุงููุณุชุฃุฌุฑ'])).size;

        // ูุจุงูุบ ุงูุนููุฏ ุงูุถุฑูุจูุฉ ูุฑุฉ ูุงุญุฏุฉ ููู ุนูุฏ
        let beforeTax = 0, vat = 0, afterTax = 0, residential = 0;
        contractsArr.forEach(p => {
            if (p['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู' && p['ุงูุงุฌูุงูู']) {
                const amount = parseFloat(p['ุงูุงุฌูุงูู']) || 0;
                const base = amount / 1.15;
                beforeTax += base;
                vat += base * 0.15;
                afterTax += amount;
            } else if (p['ููุน ุงูุนูุฏ'] !== 'ุถุฑูุจู' && p['ุงูุงุฌูุงูู']) {
                residential += parseFloat(p['ุงูุงุฌูุงูู']) || 0;
            }
        });

        stats[name] = {
            units,
            tenants,
            beforeTax,
            vat,
            afterTax,
            residential,
            total: beforeTax + residential // ุงูุฅุฌูุงูู ุงูููู ุจุฏูู ุงูุถุฑูุจุฉ
        };

        // ุฌูุน ุงูุฅุฌูุงููุงุช
        totalUnits += units;
        totalTenants += tenants;
        totalBeforeTax += beforeTax;
        totalVat += vat;
        totalAfterTax += afterTax;
        totalResidential += residential;
    });

    // ุจูุงุก ุงูุฌุฏูู ุจุดูู ุฃููู ูุน ุฒุฑ PDF
    let html = `<div class="modal-overlay" style="display:flex;">
      <div class="modal-box" style="max-width:1100px;">
        <button class="close-modal" onclick="closeModal()">ร</button>
        <h3>ุฅุญุตุงุฆูุงุช ุงูุนูุงุฑุงุช ุงููุฎุชุงุฑุฉ</h3>
        <div style="text-align:left;margin-bottom:10px;">

        </div>
        <div class="property-details" style="padding:0;">
        <div style="overflow-x:auto;">
        <div id="multiStatsTableToPrint">
        <table style="width:100%;border-collapse:collapse;text-align:center;">
            <thead>
                <tr style="background:#2a4b9b;color:#fff;">
                    <th>ุงูุฅุญุตุงุฆูุฉ</th>
                    ${Object.keys(stats).map(name => `<th>${name}</th>`).join('')}
                    <th>ุงูุฅุฌูุงูู</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="font-weight:bold;">ุนุฏุฏ ุงููุญุฏุงุช</td>
                    ${Object.values(stats).map(s => `<td>${s.units}</td>`).join('')}
                    <td>${totalUnits}</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">ุนุฏุฏ ุงููุณุชุฃุฌุฑูู</td>
                    ${Object.values(stats).map(s => `<td>${s.tenants}</td>`).join('')}
                    <td>${totalTenants}</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">ูุจู ุงูุถุฑูุจุฉ</td>
                    ${Object.values(stats).map(s => `<td>${s.beforeTax.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>`).join('')}
                    <td>${totalBeforeTax.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">ุงูุถุฑูุจุฉ</td>
                    ${Object.values(stats).map(s => `<td>${s.vat.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>`).join('')}
                    <td>${totalVat.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">ุจุนุฏ ุงูุถุฑูุจุฉ</td>
                    ${Object.values(stats).map(s => `<td>${s.afterTax.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>`).join('')}
                    <td>${totalAfterTax.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">ุณููู</td>
                    ${Object.values(stats).map(s => `<td>${s.residential.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>`).join('')}
                    <td>${totalResidential.toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>
                </tr>
                <tr>
                    <td style="font-weight:bold;color:#2a4b9b;">ุงูุฅุฌูุงูู ุงูููู</td>
                    ${Object.values(stats).map(s => `<td style="font-weight:bold;color:#2a4b9b;">${(s.beforeTax + s.residential).toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>`).join('')}
                    <td style="font-weight:bold;color:#2a4b9b;">${(totalBeforeTax + totalResidential).toLocaleString(undefined, {maximumFractionDigits:2})} ุฑูุงู</td>
                </tr>
            </tbody>
        </table>
        </div>
        </div>
        </div>
        <div class="modal-actions" style="flex-direction:row;gap:10px;">
  <button onclick="printMultiStatsTable()" class="modal-action-btn print-btn" style="flex:1;">
    <i class="fas fa-file-pdf"></i> ุทุจุงุนุฉ PDF
  </button>
  <button onclick="closeModal()" class="modal-action-btn close-btn" style="flex:1;">
    <i class="fas fa-times"></i> ุฅุบูุงู
  </button>
</div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ุฏุงูุฉ ุทุจุงุนุฉ ุฌุฏูู ุงูุฅุญุตุงุฆูุงุช PDF
function printMultiStatsTable() {
    const tableHtml = document.getElementById('multiStatsTableToPrint').innerHTML;
    const win = window.open('', '', 'width=1100,height=700');
    win.document.write(`
        <html lang="ar" dir="rtl">
        <head>
            <title>ุทุจุงุนุฉ ุฅุญุตุงุฆูุงุช ุงูุนูุงุฑุงุช</title>
            <style>
                body { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 30px; }
                table { width: 100%; border-collapse: collapse; text-align: center; }
                th, td { border: 1px solid #333; padding: 10px; font-size: 1.1em; }
                th { background: #2a4b9b; color: #fff; }
                td { background: #f7f9fa; }
                tr:last-child td, tr:last-child th { font-weight: bold; color: #2a4b9b; background: #e8f7ef; }
            </style>
        </head>
        <body>
            <h2 style="text-align:center;">ุฅุญุตุงุฆูุงุช ุงูุนูุงุฑุงุช ุงููุฎุชุงุฑุฉ</h2>
            <div>${tableHtml}</div>
            <script>window.print();</script>
        </body>
        </html>
    `);
    win.document.close();
}
// ุฑุจุท ุฒุฑ ููุชุฑ ุนูุงุฑุงุช ูุชุนุฏุฏ ูู ุงูููุฏุฑ ูุงูุฌูุงู
document.addEventListener('DOMContentLoaded', function() {
    const multiBtn = document.getElementById('multiPropertyFilterBtn');
    if (multiBtn) multiBtn.addEventListener('click', showMultiPropertyCityFilter);

    const mobileMultiBtn = document.getElementById('mobile-multi-property-filter-btn');
    if (mobileMultiBtn) mobileMultiBtn.addEventListener('click', function() {
        showMultiPropertyCityFilter();
        // ุฅุบูุงู ูุงุฆูุฉ ุงูุฌูุงู ุฅุฐุง ูุงูุช ููุชูุญุฉ
        const mobileMenu = document.getElementById('mobileMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        if (mobileMenu) mobileMenu.classList.remove('active');
        if (menuOverlay) menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
});
// ุฏุงูุฉ ุนุฑุถ ุชูุงุตูู ุงูุนูุงุฑ
function showPropertyDetails(index) {
    const property = properties[index];
    if (!property) return;
    
    const status = calculateStatus(property);
    let statusClass = '';
    let badgeIcon = '';
    
    if (status.isInstallmentEnded) {
        statusClass = 'installment-ended-status';
        badgeIcon = '<i class="fas fa-money-bill-wave"></i>';
    } else if (status.final === 'ุฌุงุฑู') {
        statusClass = 'active-status';
        badgeIcon = '<i class="fas fa-check-circle"></i>';
    } else if (status.final === 'ููุชูู') {
        statusClass = 'expired-status';
        badgeIcon = '<i class="fas fa-times-circle"></i>';
    } else if (status.final === 'ุนูู ูุดู') {
        statusClass = 'pending-status';
        badgeIcon = '<i class="fas fa-exclamation-circle"></i>';
    }

    // ุชุฌููุน ุงููุญุฏุงุช ูุงููุณุงุญุฉ ูููุณ ุงูุนูุฏ
    const contractKey = `${property['ุฑูู ุงูุนูุฏ']}_${property['ุงุณู ุงูุนูุงุฑ']}`;
    const related = properties.filter(
        p => `${p['ุฑูู ุงูุนูุฏ']}_${p['ุงุณู ุงูุนูุงุฑ']}` === contractKey
    );
    const allUnits = related.map(p => p['ุฑูู  ุงููุญุฏุฉ ']).filter(Boolean);
    const totalArea = related.reduce((sum, p) => sum + (parseFloat(p['ุงููุณุงุญุฉ']) || 0), 0);

    let html = '<div class="modal-overlay" style="display:flex;"><div class="modal-box"><button class="close-modal" onclick="closeModal()">ร</button>';
    html += `<h3>${property['ุงุณู ุงูุนูุงุฑ'] || ''}</h3>`;
    html += '<div class="property-details">';

    // ุฑูู ุงููุญุฏุฉ (ุฌููุน ุงููุญุฏุงุช)
    html += `
    <div class="detail-row">
        <span class="detail-label">ุฑูู ุงููุญุฏุฉ:</span>
        <span class="detail-value">${allUnits.join(' , ')}${allUnits.length > 1 ? ` <span class="units-count">(${allUnits.length} ูุญุฏุงุช)</span>` : ''}</span>
    </div>
    <div class="detail-row">
        <span class="detail-label">ุงููุณุงุญุฉ ุงููุฌูุนุฉ:</span>
        <span class="detail-value">${totalArea ? totalArea.toLocaleString() : '0'} ูยฒ</span>
    </div>
    `;

    // ุจุงูู ุงูุญููู
    Object.entries(property).forEach(([key, value]) => {
        if (key === 'Column1' || key === 'ุฑูู  ุงููุญุฏุฉ ' || key === 'ุงููุณุงุญุฉ') return;
        if (!value && value !== 0) return;
        let displayValue = value;
        if (key === 'ุงูุงุฌูุงูู' && value) {
            displayValue = parseFloat(value).toLocaleString() + ' ุฑูุงู';
        } else if (key === 'ุงูุญุงูุฉ ุงูููุงุฆูุฉ' || key === 'ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ') {
            return;
        } else if (key === 'ูููุน ุงูุนูุงุฑ' && value) {
            let url = value;
            if (!url.startsWith('http')) {
                url = `https://www.google.com/maps/search/${encodeURIComponent(url)}`;
            }
            displayValue = `<a href="${url}" target="_blank" class="location-link">ุงูุฎุฑูุทุฉ <i class="fas fa-map-marker-alt"></i></a>`;
        }
        html += `
        <div class="detail-row">
            <span class="detail-label">${key}:</span>
            <span class="detail-value">${displayValue}</span>
        </div>
        `;
    });

    // ุฅุถุงูุฉ ุงูุญุงูุฉ ุจุดูู ูุฎุตุต
    html += `
    <div class="detail-row ${statusClass}">
        <span class="detail-label">ุงูุญุงูุฉ:</span>
        <span class="detail-value">${badgeIcon} ${status.display || ''}</span>
    </div>
    `;

    // ุฅุถุงูุฉ ุงููุจูุบ ุงูุฎุงุถุน ููุถุฑูุจุฉ ููููุฉ ุงูุถุฑูุจุฉ
    if (property['ุงูุงุฌูุงูู']) {
        if (property['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู') {
            const baseAmount = property['ุงูุงุฌูุงูู'] / 1.15;
            const vatAmount = property['ุงูุงุฌูุงูู'] - baseAmount;
            html += `
            <div class="detail-row">
                <span class="detail-label">ุงููุจูุบ ุงูุฎุงุถุน ููุถุฑูุจุฉ:</span>
                <span class="detail-value">${parseFloat(baseAmount).toFixed(2).toLocaleString()} ุฑูุงู</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ูููุฉ ุงูุถุฑูุจุฉ (15%):</span>
                <span class="detail-value">${parseFloat(vatAmount).toFixed(2).toLocaleString()} ุฑูุงู</span>
            </div>
            <div class="detail-row" style="font-weight: bold;">
                <span class="detail-label">ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ:</span>
                <span class="detail-value" style="color: #2a4b9b;">
                    ${parseFloat(property['ุงูุงุฌูุงูู']).toLocaleString()} ุฑูุงู
                </span>
            </div>`;
        } else {
            html += `
            <div class="detail-row">
                <span class="detail-label">ุงูุฅุฌูุงูู:</span>
                <span class="detail-value" style="color: #2a4b9b; font-weight: bold;">
                    ${parseFloat(property['ุงูุงุฌูุงูู']).toLocaleString()} ุฑูุงู
                </span>
            </div>`;
        }
    }

    // ุนุฑุถ ูููุน ุงูุนูุงุฑ ุฅุฐุง ูุงู ูุชููุฑุงู
    if (property['ูููุน ุงูุนูุงุฑ']) {
        html += `
        <div class="detail-row">
            <span class="detail-label">ูููุน ุงูุนูุงุฑ:</span>
            <span class="detail-value">
                <a href="#" onclick="openLocation('${property['ูููุน ุงูุนูุงุฑ']}'); return false;" 
                   class="location-link">ูุชุญ ุงูุฎุฑูุทุฉ <i class="fas fa-map-marker-alt"></i></a>
            </span>
        </div>`;
    }

    html += `</div>`;

    // ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช
    html += `
    <div class="modal-actions">
        <button onclick="closeModal()" class="modal-action-btn close-btn">
            <i class="fas fa-times"></i> ุฅุบูุงู
        </button>
    </div>
    </div></div>`;
    
    document.body.insertAdjacentHTML('beforeend', html);

    // ุฅุถุงูุฉ ูุณุชูุน ูุฅุบูุงู ุงูููุฏุงู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ุฏุงูุฉ ูุณูุทุฉ ูุนุฑุถ ุงูุชูุงุตูู ุญุณุจ ุฑูู ุงูุนูุฏ ูุงุณู ุงูุนูุงุฑ
function showPropertyDetailsByKey(contractNumber, propertyName) {
    const prop = properties.find(
        p => p['ุฑูู ุงูุนูุฏ'] == contractNumber && p['ุงุณู ุงูุนูุงุฑ'] == propertyName
    );
    if (!prop) return;
    showPropertyDetails(properties.indexOf(prop));
}
function exportToExcel() {
    // ูุณุฎ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ุจุฏูู ุชูุณูู ุงูุชูุงุฑูุฎ
    const formattedData = properties.map(property => {
        // ูุณุฎ ูู ุงูุญููู ููุง ูู
        return { ...property };
    });

    // ุฅูุดุงุก ูุฑูุฉ ุนูู
    const ws = XLSX.utils.json_to_sheet(formattedData, {
        header: [
            'ุฑูู  ุงููุญุฏุฉ ',
            'ุงููุฏููุฉ',
            'ุงุณู ุงูุนูุงุฑ',
            'ูููุน ุงูุนูุงุฑ',
            'ุงูุงุฑุชูุงุน',
            'ุฑูู ุงูุตู',
            'ุงูุณุฌู ุงูุนููู ',
            'ูุณุงุญุฉุงูุตู',
            'ุงููุงูู',
            'ุงุณู ุงููุณุชุฃุฌุฑ',
            'ุฑูู ุงูุนูุฏ',
            'ูููุฉ  ุงูุงูุฌุงุฑ ',
            'ุงููุณุงุญุฉ',
            'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ',
            'ุชุงุฑูุฎ ุงูููุงูุฉ',
            'ุงูุงุฌูุงูู',
            'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก',
            'ููุน ุงูุนูุฏ'
        ]
    });

    // ุชุนุฏูู ุนุฑุถ ุงูุฃุนูุฏุฉ
    const colWidths = [
        { wch: 15 },  // ุฑูู ุงููุญุฏุฉ
        { wch: 15 },  // ุงููุฏููุฉ
        { wch: 25 },  // ุงุณู ุงูุนูุงุฑ
        { wch: 40 },  // ูููุน ุงูุนูุงุฑ
        { wch: 10 },  // ุงูุงุฑุชูุงุน
        { wch: 20 },  // ุฑูู ุงูุตู
        { wch: 20 },  // ุงูุณุฌู ุงูุนููู
        { wch: 15 },  // ูุณุงุญุฉ ุงูุตู
        { wch: 20 },  // ุงููุงูู
        { wch: 35 },  // ุงุณู ุงููุณุชุฃุฌุฑ
        { wch: 20 },  // ุฑูู ุงูุนูุฏ
        { wch: 15 },  // ูููุฉ ุงูุงูุฌุงุฑ
        { wch: 15 },  // ุงููุณุงุญุฉ
        { wch: 15 },  // ุชุงุฑูุฎ ุงูุจุฏุงูุฉ
        { wch: 15 },  // ุชุงุฑูุฎ ุงูููุงูุฉ
        { wch: 15 },  // ุงูุงุฌูุงูู
        { wch: 20 },  // ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก
        { wch: 15 }   // ููุน ุงูุนูุฏ
    ];
    ws['!cols'] = colWidths;

    // ุฅูุดุงุก ูุตูู ุนูู
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ุงูุจูุงูุงุช");

    // ุชุญุฏูุฏ ุงุณู ุงูููู ูุงูุชุงุฑูุฎ
    const now = new Date();
    const fileName = `ุจูุงูุงุช_ุงูุนูุงุฑุงุช_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}.xlsx`;

    // ุชุตุฏูุฑ ุงูููู
    XLSX.writeFile(wb, fileName);
}

// ุงููุฑููุงุช ููุนูุงุฑุงุช

// ุชุญููู ุงููุฑููุงุช ูู localStorage ุนูุฏ ุจุฏุก ุงูุชุทุจูู
document.addEventListener('DOMContentLoaded', function() {
    console.log('๐ ุจุฏุก ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช...');

    // Enable debug mode by adding ?debug=true to URL
    const urlParams = new URLSearchParams(window.location.search);
    window.debugMode = urlParams.get('debug') === 'true';

    if (window.debugMode) {
        console.log('๐ ูุถุน ุงูุชุตุญูุญ ููุนู');
    }

    // ุชููุฆุฉ Supabase ุฃููุงู
    if (typeof initSupabase === 'function') {
        const supabaseInitialized = initSupabase();
        console.log('Supabase ุชููุฆุฉ:', supabaseInitialized ? 'ูุฌุญ' : 'ูุดู');
    } else {
        console.warn('โ๏ธ ูุธููุฉ initSupabase ุบูุฑ ูุชููุฑุฉ');
    }

    const savedAttachments = localStorage.getItem('propertyAttachments');
    if (savedAttachments) {
        attachments = JSON.parse(savedAttachments);
    }

    // ุชุญููู ูุฑููุงุช ุงูุจุทุงูุงุช ุงููุญููุธุฉ
    const savedCardAttachments = localStorage.getItem('cardAttachments');
    if (savedCardAttachments) {
        cardAttachments = JSON.parse(savedCardAttachments);
    }

    // ุฑุจุท ุฒุฑ ุฅุฏุงุฑุฉ ุงููุฑููุงุช ูู ุงูููุฏุฑ
    const attachmentsBtn = document.getElementById('attachmentsManagerBtn');
    if (attachmentsBtn) {
        attachmentsBtn.addEventListener('click', showAttachmentsManager);
    }

    // ุฑุจุท ุฒุฑ ุฅุฏุงุฑุฉ ุงููุฑููุงุช ูู ุงูุฌูุงู
    const mobileAttachmentsBtn = document.getElementById('mobile-attachments-btn');
    if (mobileAttachmentsBtn) {
        mobileAttachmentsBtn.addEventListener('click', function() {
            document.getElementById('mobileMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
            document.body.style.overflow = '';
            showAttachmentsManager();
        });
    }

    // ุฑุจุท ุฒุฑ ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช ูู ุงูููุฏุฑ
    const propertyManagerBtn = document.getElementById('propertyManagerBtn');
    if (propertyManagerBtn) {
        propertyManagerBtn.addEventListener('click', showPropertyManager);
    }

    // Initialize enhanced attachments system
    setTimeout(() => {
        initializeAttachmentsSystem();

        // Initialize card attachments real-time sync
        if (typeof subscribeToCardAttachmentChanges === 'function') {
            console.log('๐ ุชูุนูู ุงููุฒุงููุฉ ุงูููุฑูุฉ ููุฑููุงุช ุงูุจุทุงูุงุช...');
            const cardSubscription = subscribeToCardAttachmentChanges();
            if (cardSubscription) {
                console.log('โ ุชู ุชูุนูู ุงููุฒุงููุฉ ุงูููุฑูุฉ ููุฑููุงุช ุงูุจุทุงูุงุช');

                // Test the subscription after a short delay
                setTimeout(() => {
                    console.log('๐งช ุงุฎุชุจุงุฑ ุงูุงุดุชุฑุงู...');
                    console.log('๐ก ุญุงูุฉ ุงูุงุดุชุฑุงู:', cardSubscription.state);
                }, 3000);
            } else {
                console.warn('โ๏ธ ูุดู ูู ุชูุนูู ุงููุฒุงููุฉ ุงูููุฑูุฉ ููุฑููุงุช ุงูุจุทุงูุงุช');
            }
        } else {
            console.warn('โ๏ธ ูุธููุฉ subscribeToCardAttachmentChanges ุบูุฑ ูุชููุฑุฉ');
        }

        // Setup global card attachment event listeners
        setupGlobalCardAttachmentListeners();

    }, 2000); // Wait 2 seconds for other systems to load
});

// Setup global card attachment event listeners
function setupGlobalCardAttachmentListeners() {
    // Listen for card attachment events globally
    window.addEventListener('cardAttachmentAdded', (event) => {
        console.log(`๐ ุญุฏุซ ุนุงููู: ุชู ุฅุถุงูุฉ ูุฑูู ููุจุทุงูุฉ ${event.detail.cardKey}`);

        // Update any open card modals
        const openCardModal = document.querySelector('.card-attachments-modal[data-card-key="' + event.detail.cardKey + '"]');
        if (openCardModal) {
            refreshCardAttachmentsList(event.detail.cardKey);
        }

        // Update card counters in any open lists
        updateCardAttachmentCounters(event.detail.cardKey);
    });

    window.addEventListener('cardAttachmentDeleted', (event) => {
        console.log(`๐ ุญุฏุซ ุนุงููู: ุชู ุญุฐู ูุฑูู ูู ุงูุจุทุงูุฉ ${event.detail.cardKey}`);

        // Update any open card modals
        const openCardModal = document.querySelector('.card-attachments-modal[data-card-key="' + event.detail.cardKey + '"]');
        if (openCardModal) {
            refreshCardAttachmentsList(event.detail.cardKey);
        }

        // Update card counters in any open lists
        updateCardAttachmentCounters(event.detail.cardKey);
    });

    console.log('โ ุชู ุชููุฆุฉ ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ ุงูุนุงูุฉ ููุฑููุงุช ุงูุจุทุงูุงุช');
}

// Update card attachment counters in UI
function updateCardAttachmentCounters(cardKey) {
    // Update attachment count badges in property cards
    const propertyCards = document.querySelectorAll('.property-card');
    propertyCards.forEach(card => {
        const cardKeyAttr = card.getAttribute('data-card-key');
        if (cardKeyAttr === cardKey) {
            // Update attachment count
            updateCardAttachmentCount(card, cardKey);
        }
    });
}

// Helper function to update card attachment count
async function updateCardAttachmentCount(cardElement, cardKey) {
    try {
        let count = 0;

        if (typeof getCardAttachmentsEnhanced === 'function') {
            const attachments = await getCardAttachmentsEnhanced(cardKey);
            count = attachments.length;
        }

        // Update count badge
        const countBadge = cardElement.querySelector('.attachment-count');
        if (countBadge) {
            countBadge.textContent = `${count} ูุฑูู`;
        }

    } catch (error) {
        console.warn(`โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ุนุฏุงุฏ ูุฑููุงุช ุงูุจุทุงูุฉ ${cardKey}:`, error);
    }
}

// ูุงูุฐุฉ ุงุฎุชูุงุฑ ุงููุฏููุฉ
function showAttachmentsManager() {
    closeModal();
    const cities = getUniqueCountries().filter(c => c !== 'ุงููู');
    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <h3>ุงุฎุชุฑ ุงููุฏููุฉ</h3>
            <div class="country-selection">`;
    cities.forEach(city => {
        html += `<button onclick="showAttachmentsProperties('${city}')">${city}</button>`;
    });
    html += `</div></div></div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ูุงูุฐุฉ ุงุฎุชูุงุฑ ุงูุนูุงุฑ
// ...existing code...

// ...existing code...

function showAttachmentsProperties(city) {
    closeModal();
    const props = properties.filter(p => p.ุงููุฏููุฉ === city)
        .map(p => p['ุงุณู ุงูุนูุงุฑ'])
        .filter((v, i, arr) => v && arr.indexOf(v) === i);

    let html = `<div class="modal-overlay" style="display:flex;">
        <div class="modal-box" style="max-width:420px;">
            <button class="close-modal" onclick="closeModal()" title="ุฅุบูุงู">ร</button>
            <h3>ุนูุงุฑุงุช ูุฏููุฉ <span style="color:#2a4b9b">${city}</span></h3>
            <input type="text" id="attachmentsPropertySearch" placeholder="ุจุญุซ ุนู ุนูุงุฑ..." style="width:100%;margin-bottom:12px;padding:10px 12px;border-radius:8px;border:1.5px solid #d1d5db;font-size:1.05rem;">
            <div id="attachmentsPropertyList" style="max-height:350px;overflow:auto;display:flex;flex-direction:column;gap:8px;">`;
    props.forEach(prop => {
        html += `<button onclick="showAttachmentsModal('${city}','${prop}')" class="filter-btn" style="width:100%;margin-bottom:0;text-align:right;font-weight:bold;font-size:1.1em;">
            <i class="fas fa-building" style="color:#1e88e5;margin-left:8px;"></i>${prop}
        </button>`;
    });
    html += `</div>
        <div class="modal-actions">
            <button onclick="closeModal()" class="modal-action-btn close-btn">
                <i class="fas fa-times"></i> ุฅุบูุงู
            </button>
        </div>
    </div></div>`;
    document.body.insertAdjacentHTML('beforeend', html);

    // ุจุญุซ ุฏููุงูููู
    document.getElementById('attachmentsPropertySearch').addEventListener('input', function() {
        const term = this.value.trim().toLowerCase();
        document.querySelectorAll('#attachmentsPropertyList button').forEach(btn => {
            btn.style.display = btn.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
    });

    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// Enhanced attachments modal with real-time cross-device synchronization (Updated to match Card Attachments)
function showAttachmentsModal(city, propertyName) {
    console.log('๐ฏ ูุชุญ ูุงูุฐุฉ ูุฑููุงุช ุงูุนูุงุฑ...', { city, propertyName });

    // ุฅุบูุงู ุฃู ููุงูุฐ ููุฌูุฏุฉ ูุณุจูุงู
    closeModal();

    const propertyKey = `${city}_${propertyName}`;

    // Try to get attachments from Supabase first, fallback to local
    async function loadPropertyAttachments() {
        let propertyAttachments = [];
        let isFromCloud = false;

        // Try Supabase first
        if (typeof getPropertyAttachmentsEnhanced === 'function' && supabaseClient) {
            try {
                console.log(`โ๏ธ ุฌูุจ ูุฑููุงุช ${propertyKey} ูู ุงูุณุญุงุจุฉ...`);
                propertyAttachments = await getPropertyAttachmentsEnhanced(propertyKey);
                isFromCloud = true;
                console.log(`โ ุชู ุฌูุจ ${propertyAttachments.length} ูุฑูู ูู ุงูุณุญุงุจุฉ`);
            } catch (error) {
                console.warn('โ๏ธ ูุดู ูู ุฌูุจ ุงููุฑููุงุช ูู ุงูุณุญุงุจุฉ:', error);
            }
        }

        // Fallback to local attachments if no cloud data
        if (!isFromCloud || propertyAttachments.length === 0) {
            propertyAttachments = window.attachments?.[propertyKey] || [];
            console.log(`๐พ ุชู ุฌูุจ ${propertyAttachments.length} ูุฑูู ูุญูู`);
        }

        return { propertyAttachments, isFromCloud };
    }

    // ุชุตููู ูุฎุชูู ููุฌูุงู ูุงูุดุงุดุงุช ุงููุจูุฑุฉ
    const isMobile = isMobileDevice();

    let html;

    if (isMobile) {
        // ุชุตููู ูุฎุตุต ููุฌูุงู - ูุจุณุท ููุถุบูุท
        html = `
        <div class="modal-overlay mobile-attachments-overlay" style="display:flex;">
            <div class="modal-box mobile-attachments-modal">
                <!-- ุฑุฃุณ ุงููุงูุฐุฉ ุงููุจุณุท ููุฌูุงู -->
                <div class="mobile-attachments-header">
                    <h2><i class="fas fa-paperclip"></i> ูุฑููุงุช ุงูุนูุงุฑ</h2>
                    <button class="mobile-close-btn" onclick="closeModal()" title="ุฅุบูุงู">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- ูุนูููุงุช ุงูุนูุงุฑ ุงููุถุบูุทุฉ -->
                <div class="mobile-card-info">
                    <span><i class="fas fa-building"></i> ${propertyName}</span>
                    <span><i class="fas fa-map-marker-alt"></i> ${city}</span>
                </div>

                <!-- ุฒุฑ ุงูุฅุฑูุงู ุงููุถุบูุท (20% ูู ุงููุณุงุญุฉ) -->
                <div class="mobile-upload-section">
                    <button class="mobile-upload-btn" onclick="document.getElementById('propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}').click()">
                        <i class="fas fa-plus"></i> ุฅุถุงูุฉ ูุฑูู
                    </button>
                    <input type="file" id="propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" multiple style="display:none" onchange="handleFileUploadEnhanced(event, '${city}', '${propertyName}')">
                </div>

                <!-- ูุงุฆูุฉ ุงููุฑููุงุช (80% ูู ุงููุณุงุญุฉ) -->
                <div class="mobile-attachments-section">
                    <div class="mobile-attachments-header-small">
                        <span><i class="fas fa-folder-open"></i> ุงููุฑููุงุช ุงูููุฌูุฏุฉ</span>
                        <span class="mobile-attachments-count" id="mobilePropertyAttachmentsCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}">ุฌุงุฑู ุงูุชุญููู...</span>
                    </div>
                    <div id="propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="mobile-attachments-list">
                        <div class="mobile-loading" style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 10px;"></i>
                            <p style="font-size: 0.9rem;">ุฌุงุฑู ุชุญููู ุงููุฑููุงุช...</p>
                        </div>
                    </div>
                </div>

                <!-- ุฒุฑ ุงูุฅุบูุงู ูู ุงูุฃุณูู -->
                <div class="mobile-footer">
                    <button class="mobile-close-footer-btn" onclick="closeModal()">
                        <i class="fas fa-times"></i> ุฅุบูุงู
                    </button>
                </div>
            </div>
        </div>`;
    } else {
        // ุงูุชุตููู ุงูุญุงูู ููุดุงุดุงุช ุงููุจูุฑุฉ (ุจุฏูู ุชุบููุฑ)
        html = `
        <div class="modal-overlay enhanced-modal-overlay" style="display:flex;">
            <div class="modal-box attachments-modal enhanced-attachments-modal">
                <!-- ุฒุฑ ุงูุฅุบูุงู ุงููุญุณู -->
                <button class="close-modal enhanced-close-btn" onclick="closeModal()" title="ุฅุบูุงู ุงููุงูุฐุฉ">
                    <i class="fas fa-times"></i>
                </button>

                <!-- ุฑุฃุณ ุงููุงูุฐุฉ ุงููุญุณู -->
                <div class="attachments-modal-header enhanced-header">
                    <div class="header-content">
                        <h2><i class="fas fa-paperclip"></i> ูุฑููุงุช ุงูุนูุงุฑ</h2>
                        <div class="card-info">
                            <span class="info-item"><i class="fas fa-building"></i> ${propertyName}</span>
                            <span class="info-item"><i class="fas fa-map-marker-alt"></i> ${city}</span>
                        </div>
                    </div>
                </div>

                <!-- ูุญุชูู ุงููุงูุฐุฉ ุจุงูุชุฎุทูุท ุงูุฌุฏูุฏ -->
                <div class="attachments-modal-content enhanced-content">
                    <div class="content-layout-new">
                        <!-- ุงูุฌุงูุจ ุงูุฃูุณุฑ: ููุทูุฉ ุงูุฑูุน ูุงูููุงุญุธุงุช -->
                        <div class="upload-notes-sidebar">
                            <!-- ููุทูุฉ ุงูุฑูุน -->
                            <div class="upload-section compact-upload">
                                <div class="upload-area enhanced-upload" id="propertyUploadArea_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="upload-dropzone" onclick="document.getElementById('propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}').click()">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>ุงุณุญุจ ุงููููุงุช ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
                                        <small>ูุฏุนู ุฌููุน ุฃููุงุน ุงููููุงุช</small>
                                    </div>
                                    <input type="file" id="propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" multiple style="display:none" onchange="handleFileUploadEnhanced(event, '${city}', '${propertyName}')">
                                </div>
                            </div>

                            <!-- ูุณู ุงูููุงุญุธุงุช -->
                            <div class="notes-section-compact">
                                <div class="notes-container-compact">
                                    <h4><i class="fas fa-sticky-note"></i> ููุงุญุธุงุช</h4>
                                    <textarea
                                        id="propertyUploadNotes_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}"
                                        class="notes-textarea-compact"
                                        placeholder="ุฃุถู ููุงุญุธุงุช..."
                                        rows="3"
                                    ></textarea>
                                    <div class="notes-info-compact">
                                        <small><i class="fas fa-info-circle"></i> ุณุชูุญูุธ ูุน ุงููุฑููุงุช ุงูุฌุฏูุฏุฉ</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ุงูุฌุงูุจ ุงูุฃููู: ูุงุฆูุฉ ุงููุฑููุงุช (ุงูุนุฑุถ ุงููุงูู) -->
                        <div class="attachments-main-section">
                            <div class="attachments-header">
                                <h3><i class="fas fa-folder-open"></i> ุงููุฑููุงุช ุงูููุฌูุฏุฉ</h3>
                            </div>
                            <div id="propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="attachments-list compact-list scrollable-attachments">
                                <div class="loading-attachments" style="text-align: center; padding: 20px; color: #666;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <p>ุฌุงุฑู ุชุญููู ุงููุฑููุงุช...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุฒุฑ ุงูุฅุบูุงู ูู ุงูุฃุณูู -->
                <div class="modal-footer-actions">
                    <button class="close-modal-btn" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                        ุฅุบูุงู ุงููุงูุฐุฉ
                    </button>
                </div>

                <!-- ุฒุฑ ุงูุนูุฏุฉ ููุฃุนูู -->
                <button class="scroll-to-top-btn" id="scrollToTopBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}" onclick="scrollToTopPropertyAttachments('${propertyKey}')" title="ุงูุนูุฏุฉ ููุฃุนูู">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>`;
    }

    // ุฅุฏุฑุงุฌ ุงููุงูุฐุฉ ูู ุงูุตูุญุฉ
    document.body.insertAdjacentHTML('beforeend', html);

    // ๐ฏ ุชุญููู ุงููุฑููุงุช ุจุนุฏ ุฅูุดุงุก ุงููุงูุฐุฉ
    loadPropertyAttachments().then(({ propertyAttachments, isFromCloud }) => {
        console.log(`๐ ุชู ุชุญููู ${propertyAttachments.length} ูุฑูู ููุนูุงุฑ ${propertyKey} (${isFromCloud ? 'ูู ุงูุณุญุงุจุฉ' : 'ูุญูู'})`);

        const listContainer = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (listContainer) {
            // Force visibility with enhanced mobile support
            listContainer.style.display = 'block';
            listContainer.style.visibility = 'visible';
            listContainer.style.opacity = '1';

            // Add mobile-specific classes
            if (isMobileDevice()) {
                listContainer.classList.add('mobile-list', 'mobile-optimized');
                listContainer.style.minHeight = '300px';
                listContainer.style.maxHeight = '60vh';
                listContainer.style.overflowY = 'auto';
            }

            // Render attachments with layout specific to device type
            if (isMobileDevice()) {
                listContainer.innerHTML = renderMobilePropertyAttachmentsList(propertyKey, propertyAttachments);

                // Update mobile attachments count
                const mobileCountBadge = document.getElementById(`mobilePropertyAttachmentsCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (mobileCountBadge) {
                    mobileCountBadge.textContent = `${propertyAttachments.length} ูุฑูู`;
                }
            } else {
                listContainer.innerHTML = renderPropertyAttachmentsList(propertyKey, propertyAttachments);

                // Enhanced mobile display optimization
                enhanceAttachmentDisplayForMobile();
            }

            // ุฅุนุฏุงุฏ ุงุณูุฑูู ุงููุฑููุงุช ุจุนุฏ ุงูุชุญููู
            setTimeout(() => {
                setupPropertyAttachmentsScroll(propertyKey);
            }, 100);

            // ุฅุถุงูุฉ ุณูุฑูู ููุฃุนูู ูุฅุธูุงุฑ ุงููุฑููุงุช (ููุดุงุดุงุช ุงููุจูุฑุฉ ููุท)
            if (!isMobileDevice()) {
                setTimeout(() => {
                    scrollToAttachments();
                }, 300);
            }

            console.log('โ ุชู ุนุฑุถ ุงููุฑููุงุช ูู ุงููุงูุฐุฉ ูุน ุชุญุณููุงุช ุงูุฌูุงู');
        } else {
            console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุงููุฉ ูุงุฆูุฉ ุงููุฑููุงุช');
        }
    }).catch(error => {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ูุฑููุงุช ุงูุนูุงุฑ:', error);

        const listContainer = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="error-loading-attachments enhanced-error" style="text-align: center; padding: ${isMobileDevice() ? '40px 20px' : '20px'}; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="font-size: ${isMobileDevice() ? '3rem' : '2rem'}; margin-bottom: ${isMobileDevice() ? '20px' : '10px'};"></i>
                    <p style="font-size: ${isMobileDevice() ? '1.2rem' : '1rem'};">ุฎุทุฃ ูู ุชุญููู ุงููุฑููุงุช</p>
                    <button onclick="refreshPropertyAttachmentsList('${propertyKey}')" class="btn-primary" style="margin-top: ${isMobileDevice() ? '15px' : '10px'}; padding: ${isMobileDevice() ? '12px 20px' : '8px 16px'}; font-size: ${isMobileDevice() ? '1.1rem' : '0.9rem'};">
                        <i class="fas fa-refresh"></i> ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                    </button>
                </div>
            `;
        }
    });

    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // ุฅุถุงูุฉ ุฃุญุฏุงุซ ุงูุณุญุจ ูุงูุฅููุงุช
    setupPropertyDragAndDrop(propertyKey);
}

// ===== Render Property Attachments List (Desktop) =====
function renderPropertyAttachmentsList(propertyKey, attachments) {
    console.log(`๐ฅ๏ธ ุนุฑุถ ${attachments.length} ูุฑูู ููุดุงุดุงุช ุงููุจูุฑุฉ - ุงูุนูุงุฑ: ${propertyKey}`);

    if (!attachments || attachments.length === 0) {
        return `
            <div class="no-attachments-state" style="text-align: center; padding: 40px 20px; color: #6c757d;">
                <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                <h4 style="margin: 10px 0; font-size: 1.2rem;">ูุง ุชูุฌุฏ ูุฑููุงุช</h4>
                <p style="margin: 0; opacity: 0.7;">ุงุณุชุฎุฏู ููุทูุฉ ุงูุฑูุน ูุฅุถุงูุฉ ุงููููุงุช</p>
            </div>
        `;
    }

    return attachments.map((file, index) => {
        // Handle both local and cloud file formats
        const fileName = file.file_name || file.name;
        const fileSize = formatFileSize(file.file_size || file.size);
        const fileType = file.file_type || file.type;
        const uploadDate = new Date(file.created_at || file.uploadDate).toLocaleDateString('ar-SA');
        const fileIcon = getFileIcon(fileName);

        // Determine file source
        const isCloudFile = file.file_url || file.url;
        const sourceIcon = isCloudFile ? 'โ๏ธ' : '๐พ';
        const sourceText = isCloudFile ? 'ุณุญุงุจู' : 'ูุญูู';

        return `
            <div class="attachment-item desktop-enhanced-item" data-file-index="${index}">
                <div class="file-icon-enhanced" style="color: ${getFileIconColor(fileName)};">
                    ${fileIcon}
                </div>
                <div class="file-details-enhanced">
                    <div class="file-name-text" title="${fileName}">
                        ${fileName}
                    </div>
                    <div class="file-meta-enhanced">
                        <span><i class="fas fa-weight-hanging"></i> ${fileSize}</span>
                        <span><i class="fas fa-calendar"></i> ${uploadDate}</span>
                        <span title="${sourceText}">${sourceIcon}</span>
                    </div>
                </div>
                <div class="attachment-actions-enhanced">
                    ${isCloudFile ?
                        `<button class="btn-enhanced view-btn" onclick="viewAttachmentFromSupabase('${file.id}', '${file.file_url || file.url}', '${file.file_type || file.type}')" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-enhanced download-btn" onclick="downloadAttachmentFromSupabase('${file.file_url || file.url}', '${fileName}')" title="ุชุญููู">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn-enhanced delete-btn" onclick="deletePropertyAttachmentFromSupabase('${file.id}', '${propertyKey}')" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>` :
                        `<button class="btn-enhanced view-btn" onclick="viewPropertyAttachment('${propertyKey}', ${index})" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-enhanced download-btn" onclick="downloadPropertyAttachment('${propertyKey}', ${index})" title="ุชุญููู">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn-enhanced delete-btn" onclick="deletePropertyAttachment('${propertyKey}', ${index})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>`
                    }
                </div>
            </div>
        `;
    }).join('');
}

// ===== Render Mobile Property Attachments List =====
function renderMobilePropertyAttachmentsList(propertyKey, attachments) {
    console.log(`๐ฑ ุนุฑุถ ${attachments.length} ูุฑูู ููุฌูุงู - ุงูุนูุงุฑ: ${propertyKey}`);

    if (!attachments || attachments.length === 0) {
        return `
            <div class="mobile-no-attachments" style="text-align: center; padding: 30px 20px; color: #6c757d;">
                <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p style="margin: 0; font-size: 0.9rem;">ูุง ุชูุฌุฏ ูุฑููุงุช</p>
                <small style="opacity: 0.7;">ุงุณุชุฎุฏู ุฒุฑ "ุฅุถุงูุฉ ูุฑูู" ูุฑูุน ุงููููุงุช</small>
            </div>
        `;
    }

    let html = '';

    attachments.forEach((file, index) => {
        // Handle both local and cloud file formats
        const fileName = file.file_name || file.name;
        const fileSize = formatFileSize(file.file_size || file.size);
        const uploadDate = new Date(file.created_at || file.uploadDate).toLocaleDateString('ar-SA');
        const fileIcon = getFileIcon(fileName);

        // Determine file source
        const isCloudFile = file.file_url || file.url;
        const sourceIcon = isCloudFile ? 'โ๏ธ' : '๐พ';
        const sourceText = isCloudFile ? 'ุณุญุงุจู' : 'ูุญูู';

        html += `
            <div class="mobile-attachment-item" data-file-index="${index}">
                <!-- ุฃููููุฉ ุงูููู -->
                <div class="mobile-file-icon" style="color: ${getFileIconColor(fileName)};">
                    ${fileIcon}
                </div>

                <!-- ูุนูููุงุช ุงูููู -->
                <div class="mobile-file-info">
                    <div class="mobile-file-name" title="${fileName}">
                        ${fileName}
                    </div>
                    <div class="mobile-file-meta">
                        <span><i class="fas fa-weight-hanging"></i> ${fileSize}</span>
                        <span><i class="fas fa-calendar"></i> ${uploadDate}</span>
                        <span title="${sourceText}">${sourceIcon}</span>
                    </div>
                </div>

                <!-- ุฃุฒุฑุงุฑ ุงูุนูููุงุช -->
                <div class="mobile-file-actions">
                    ${isCloudFile ?
                        `<button class="mobile-action-btn view" onclick="viewAttachmentFromSupabase('${file.id}', '${file.file_url || file.url}', '${file.file_type || file.type}')" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="mobile-action-btn download" onclick="downloadAttachmentFromSupabase('${file.file_url || file.url}', '${fileName}')" title="ุชุญููู">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="mobile-action-btn delete" onclick="deletePropertyAttachmentFromSupabase('${file.id}', '${propertyKey}')" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>` :
                        `<button class="mobile-action-btn view" onclick="viewPropertyAttachment('${propertyKey}', ${index})" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="mobile-action-btn download" onclick="downloadPropertyAttachment('${propertyKey}', ${index})" title="ุชุญููู">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="mobile-action-btn delete" onclick="deletePropertyAttachment('${propertyKey}', ${index})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>`
                    }
                </div>
            </div>
        `;
    });

    console.log(`โ ุชู ุฅูุดุงุก ูุงุฆูุฉ ุงููุฑููุงุช ููุฌูุงู - ${attachments.length} ุนูุตุฑ`);
    return html;
}

// ===== Setup Property Attachments Scroll =====
function setupPropertyAttachmentsScroll(propertyKey) {
    console.log('๐ ุฅุนุฏุงุฏ ุงุณูุฑูู ูุฑููุงุช ุงูุนูุงุฑ ูุน ุฒุฑ ุงูุนูุฏุฉ ููุฃุนูู...');

    const attachmentsList = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const scrollToTopBtn = document.getElementById(`scrollToTopBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (!attachmentsList || !scrollToTopBtn) {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุงุตุฑ ุงูุงุณูุฑูู ููุนูุงุฑ');
        return;
    }

    // ุฅุถุงูุฉ ุญุฏุซ ุงูุงุณูุฑูู ูุฅุธูุงุฑ/ุฅุฎูุงุก ุฒุฑ ุงูุนูุฏุฉ ููุฃุนูู
    attachmentsList.addEventListener('scroll', function() {
        const scrollTop = this.scrollTop;
        const scrollThreshold = 100; // ุฅุธูุงุฑ ุงูุฒุฑ ุจุนุฏ ุงูุชูุฑูุฑ 100px

        if (scrollTop > scrollThreshold) {
            scrollToTopBtn.classList.add('show');
        } else {
            scrollToTopBtn.classList.remove('show');
        }
    });

    // ุชุญุณูู ุงูุงุณูุฑูู ููุฌูุงู
    if (isMobileDevice()) {
        attachmentsList.style.webkitOverflowScrolling = 'touch';
        attachmentsList.style.scrollBehavior = 'smooth';
    }

    console.log('โ ุชู ุฅุนุฏุงุฏ ุงุณูุฑูู ูุฑููุงุช ุงูุนูุงุฑ ุจูุฌุงุญ');
}

// ===== Scroll to Top Function for Property Attachments =====
function scrollToTopPropertyAttachments(propertyKey) {
    console.log('โฌ๏ธ ุงูุนูุฏุฉ ูุฃุนูู ูุงุฆูุฉ ูุฑููุงุช ุงูุนูุงุฑ...');

    const attachmentsList = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (attachmentsList) {
        // ุงุณูุฑูู ุณูุณ ููุฃุนูู
        attachmentsList.scrollTo({
            top: 0,
            behavior: 'smooth'
        });

        // ุชุฃุซูุฑ ุจุตุฑู ููุฒุฑ
        const scrollToTopBtn = document.getElementById(`scrollToTopBtn_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (scrollToTopBtn) {
            scrollToTopBtn.style.transform = 'scale(0.9)';
            setTimeout(() => {
                scrollToTopBtn.style.transform = 'scale(1)';
            }, 150);
        }

        console.log('โ ุชู ุงูุชูุฑูุฑ ูุฃุนูู ูุงุฆูุฉ ูุฑููุงุช ุงูุนูุงุฑ');
    } else {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุงุฆูุฉ ูุฑููุงุช ุงูุนูุงุฑ');
    }
}

// ===== Setup Property Drag and Drop =====
function setupPropertyDragAndDrop(propertyKey) {
    console.log('๐ฏ ุฅุนุฏุงุฏ ุงูุณุญุจ ูุงูุฅููุงุช ููุฑููุงุช ุงูุนูุงุฑ...');

    const uploadArea = document.getElementById(`propertyUploadArea_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (!uploadArea) {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ููุทูุฉ ุงูุฑูุน ููุนูุงุฑ');
        return;
    }

    // ููุน ุงูุณููู ุงูุงูุชุฑุงุถู ููุณุญุจ ูุงูุฅููุงุช
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // ุชุฃุซูุฑุงุช ุจุตุฑูุฉ ุนูุฏ ุงูุณุญุจ
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });

    // ูุนุงูุฌุฉ ุงูุฅููุงุช
    uploadArea.addEventListener('drop', handlePropertyDrop, false);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        uploadArea.classList.add('dragover');
        uploadArea.style.borderColor = '#007bff';
        uploadArea.style.backgroundColor = '#f8f9ff';
    }

    function unhighlight(e) {
        uploadArea.classList.remove('dragover');
        uploadArea.style.borderColor = '#007bff';
        uploadArea.style.backgroundColor = 'white';
    }

    function handlePropertyDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            // ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุงูุนูุงุฑ ูู propertyKey
            const [city, propertyName] = propertyKey.split('_');

            // ูุญุงูุงุฉ ุญุฏุซ ุชุบููุฑ ุงูููู
            const fileInput = document.getElementById(`propertyFileInput_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (fileInput) {
                // ุฅูุดุงุก ุญุฏุซ ูุฎุตุต
                const event = new Event('change');
                Object.defineProperty(event, 'target', {
                    value: { files: files },
                    enumerable: true
                });

                handleFileUploadEnhanced(event, city, propertyName);
            }
        }
    }

    console.log('โ ุชู ุฅุนุฏุงุฏ ุงูุณุญุจ ูุงูุฅููุงุช ููุฑููุงุช ุงูุนูุงุฑ');
}

// ===== Property Attachment Functions =====

// ุนุฑุถ ูุฑูู ุงูุนูุงุฑ
function viewPropertyAttachment(propertyKey, fileIndex) {
    const propertyFiles = attachments[propertyKey] || [];
    const file = propertyFiles[fileIndex];

    if (!file) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููู');
        return;
    }

    // ูุชุญ ุงูููู ูู ูุงูุฐุฉ ุฌุฏูุฏุฉ
    const newWindow = window.open('', '_blank');
    newWindow.document.write(`
        <html>
            <head>
                <title>${file.name}</title>
                <style>
                    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                    img { max-width: 100%; height: auto; }
                    .file-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                </style>
            </head>
            <body>
                <div class="file-info">
                    <h2>${file.name}</h2>
                    <p>ุงูุญุฌู: ${formatFileSize(file.size)}</p>
                    <p>ุชุงุฑูุฎ ุงูุฑูุน: ${new Date(file.uploadDate).toLocaleDateString('ar-SA')}</p>
                    ${file.notes ? `<p>ููุงุญุธุงุช: ${file.notes}</p>` : ''}
                </div>
                ${file.type.startsWith('image/') ?
                    `<img src="${file.data}" alt="${file.name}">` :
                    `<p>ูุง ูููู ุนุฑุถ ูุฐุง ุงูููุน ูู ุงููููุงุช. <a href="${file.data}" download="${file.name}">ุชุญููู ุงูููู</a></p>`
                }
            </body>
        </html>
    `);
}

// ุชุญููู ูุฑูู ุงูุนูุงุฑ
function downloadPropertyAttachment(propertyKey, fileIndex) {
    const propertyFiles = attachments[propertyKey] || [];
    const file = propertyFiles[fileIndex];

    if (!file) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููู');
        return;
    }

    // ุฅูุดุงุก ุฑุงุจุท ุงูุชุญููู
    const link = document.createElement('a');
    link.href = file.data;
    link.download = file.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ุญุฐู ูุฑูู ุงูุนูุงุฑ
function deletePropertyAttachment(propertyKey, fileIndex) {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุฑููุ')) return;

    attachments[propertyKey] = (attachments[propertyKey] || []).filter((_, index) => index !== fileIndex);
    localStorage.setItem('attachments', JSON.stringify(attachments));

    // ุชุญุฏูุซ ุงููุงุฆูุฉ
    const listContainer = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (listContainer) {
        if (isMobileDevice()) {
            listContainer.innerHTML = renderMobilePropertyAttachmentsList(propertyKey, attachments[propertyKey] || []);
        } else {
            listContainer.innerHTML = renderPropertyAttachmentsList(propertyKey, attachments[propertyKey] || []);
        }
    }
}

// ุญุฐู ูุฑูู ุงูุนูุงุฑ ูู Supabase
async function deletePropertyAttachmentFromSupabase(attachmentId, propertyKey) {
    try {
        if (typeof deleteAttachmentEnhanced === 'function') {
            const success = await deleteAttachmentEnhanced(attachmentId);

            if (success) {
                // ุชุญุฏูุซ ุงููุงุฆูุฉ
                await refreshPropertyAttachmentsList(propertyKey);
                console.log('โ ุชู ุญุฐู ูุฑูู ุงูุนูุงุฑ ูู ุงูุณุญุงุจุฉ');
            }
        } else {
            console.warn('โ๏ธ ูุธููุฉ ุญุฐู ุงููุฑููุงุช ูู ุงูุณุญุงุจุฉ ุบูุฑ ูุชููุฑุฉ');
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ูุฑูู ุงูุนูุงุฑ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงููุฑูู');
    }
}

// ุชุญุฏูุซ ูุงุฆูุฉ ูุฑููุงุช ุงูุนูุงุฑ
async function refreshPropertyAttachmentsList(propertyKey) {
    console.log(`๐ ุชุญุฏูุซ ูุงุฆูุฉ ูุฑููุงุช ุงูุนูุงุฑ: ${propertyKey}`);
    console.log(`๐ ุญุงูุฉ ุงููุชุบูุฑุงุช: window.attachments=${!!window.attachments}, attachments=${!!attachments}`);

    const listContainer = document.getElementById(`propertyAttachmentsList_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (!listContainer) {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุงููุฉ ูุงุฆูุฉ ุงููุฑููุงุช');
        return;
    }

    try {
        // ุฅุธูุงุฑ ุญุงูุฉ ุงูุชุญููู
        listContainer.style.opacity = '0.5';

        // ุชุญููู ุงููุฑููุงุช ุงููุญุฏุซุฉ
        let propertyAttachments = [];
        let isFromCloud = false;

        // ูุญุงููุฉ ุงูุชุญููู ูู ุงูุณุญุงุจุฉ ุฃููุงู
        if (typeof getPropertyAttachmentsEnhanced === 'function' && supabaseClient) {
            try {
                console.log(`โ๏ธ ุฌูุจ ูุฑููุงุช ${propertyKey} ูู ุงูุณุญุงุจุฉ...`);
                propertyAttachments = await getPropertyAttachmentsEnhanced(propertyKey);
                isFromCloud = true;
                console.log(`โ ุชู ุฌูุจ ${propertyAttachments.length} ูุฑูู ูู ุงูุณุญุงุจุฉ`);
            } catch (cloudError) {
                console.warn('โ๏ธ ูุดู ูู ุชุญููู ุงููุฑููุงุช ูู ุงูุณุญุงุจุฉ:', cloudError);
            }
        }

        // ุงูุชุฑุงุฌุน ูููุฑููุงุช ุงููุญููุฉ
        if (!isFromCloud || propertyAttachments.length === 0) {
            // ุงุณุชุฎุฏุงู ุงููุชุบูุฑ ุงูุนุงู ูููุฑููุงุช ุฃู localStorage
            const localAttachments = window.attachments?.[propertyKey] ||
                                   JSON.parse(localStorage.getItem('propertyAttachments') || '{}')[propertyKey] ||
                                   [];
            propertyAttachments = localAttachments;
            console.log(`๐พ ุชู ุฌูุจ ${propertyAttachments.length} ูุฑูู ูุญูู`);
        }

        // ุชุญุฏูุซ ุงููุงุฆูุฉ
        if (isMobileDevice()) {
            listContainer.innerHTML = renderMobilePropertyAttachmentsList(propertyKey, propertyAttachments);

            // Update mobile attachments count
            const mobileCountBadge = document.getElementById(`mobilePropertyAttachmentsCount_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (mobileCountBadge) {
                mobileCountBadge.textContent = `${propertyAttachments.length} ูุฑูู`;
            }
        } else {
            listContainer.innerHTML = renderPropertyAttachmentsList(propertyKey, propertyAttachments);
        }

        // ุงุณุชุนุงุฏุฉ ุงูุดูุงููุฉ
        listContainer.style.opacity = '1';

        console.log(`โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ูุฑููุงุช ุงูุนูุงุฑ: ${attachments.length} ููู`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฆูุฉ ูุฑููุงุช ุงูุนูุงุฑ:', error);

        // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ
        listContainer.innerHTML = `
            <div class="error-loading-attachments" style="text-align: center; padding: 20px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุฑููุงุช</p>
                <button onclick="refreshPropertyAttachmentsList('${propertyKey}')" class="btn-primary">
                    <i class="fas fa-refresh"></i> ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                </button>
            </div>
        `;

        // ุงุณุชุนุงุฏุฉ ุงูุดูุงููุฉ
        listContainer.style.opacity = '1';
    }
}

// Enhanced file upload with comprehensive cross-device synchronization
async function handleFileUploadEnhanced(event, city, propertyName) {
    console.log(`๐ ุจุฏุก ุฑูุน ุงููููุงุช ููุนูุงุฑ: ${city}_${propertyName}`);

    const files = event.target.files;
    const propertyKey = `${city}_${propertyName}`;

    console.log(`๐ ุนุฏุฏ ุงููููุงุช ุงููุญุฏุฏุฉ: ${files.length}`);
    console.log(`๐ ููุชุงุญ ุงูุนูุงุฑ: ${propertyKey}`);

    // Get notes from the correct element based on the new design
    let notes = '';
    const notesElement = document.getElementById(`propertyUploadNotes_${propertyKey.replace(/[^a-zA-Z0-9]/g, '_')}`) ||
                        document.getElementById('uploadNotes');
    if (notesElement) {
        notes = notesElement.value || '';
        console.log(`๐ ููุงุญุธุงุช: ${notes}`);
    } else {
        console.log(`โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุตุฑ ุงูููุงุญุธุงุช`);
    }

    if (files.length === 0) {
        console.log(`โ ูุง ุชูุฌุฏ ูููุงุช ููุฑูุน`);
        return;
    }

    // Show enhanced upload progress modal
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.innerHTML = `
        <div class="modal-box upload-progress-modal" style="text-align: center; padding: 40px; max-width: 500px;">
            <div class="upload-header">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #17a2b8; margin-bottom: 1rem;"></i>
                <h3>ุฑูุน ุงููููุงุช</h3>
            </div>
            <div class="upload-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progressText">0 ูู ${files.length} ููู</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                </div>
                <div class="upload-details">
                    <p id="uploadStatus">ุฌุงุฑู ุงูุชุญูู ูู ุงูุงุชุตุงู...</p>
                    <p id="currentFile" style="font-size: 0.9rem; color: #666;"></p>
                </div>
            </div>
            <div class="device-sync-info" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <i class="fas fa-sync-alt" style="color: #17a2b8;"></i>
                <small>ุณูุชู ูุฒุงููุฉ ุงููููุงุช ุชููุงุฆูุงู ูุน ุฌููุน ุงูุฃุฌูุฒุฉ ุงููุชุตูุฉ</small>
            </div>
        </div>
    `;
    document.body.appendChild(progressModal);

    try {
        // Check if Supabase is available and working
        const supabaseAvailable = await checkSupabaseAvailability();

        if (supabaseAvailable) {
            document.getElementById('uploadStatus').textContent = 'ุฌุงุฑู ุงูุฑูุน ุฅูู ุงูุณุญุงุจุฉ...';

            // Upload files with progress tracking
            await handleFilesEnhanced(files, city, propertyName, notes);

            // Remove progress modal
            progressModal.remove();

            // Update the attachments list immediately
            try {
                await refreshPropertyAttachmentsList(propertyKey);
                console.log('โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช ุจุนุฏ ุงูุฑูุน');
            } catch (updateError) {
                console.warn('โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช:', updateError);
            }

            // Show success message with cross-device info
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box success-modal" style="text-align: center; padding: 40px;">
                    <div class="success-animation">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
                    </div>
                    <h3>ุชู ุฑูุน ุงููููุงุช ุจูุฌุงุญ!</h3>
                    <div class="success-details">
                        <p>ุชู ุฑูุน ${files.length} ููู ุฅูู ุงูุณุญุงุจุฉ</p>
                        <div class="sync-status" style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
                            <i class="fas fa-globe" style="margin-left: 8px;"></i>
                            <strong>ูุชุฒุงูู ุนุจุฑ ุฌููุน ุงูุฃุฌูุฒุฉ</strong>
                            <br>
                            <small>ุงููููุงุช ูุชุงุญุฉ ุงูุขู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ ูุงููุชุตูุญุงุช</small>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-primary" onclick="closeModal(); refreshPropertyAttachmentsList('${propertyKey}')">
                            <i class="fas fa-eye"></i> ุนุฑุถ ุงููุฑููุงุช
                        </button>
                        <button class="btn-secondary" onclick="closeModal()">
                            <i class="fas fa-times"></i> ุฅุบูุงู
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);

            // Auto-close success modal after 5 seconds
            setTimeout(() => {
                if (document.body.contains(successModal)) {
                    successModal.remove();
                }
            }, 5000);

        } else {
            throw new Error('Supabase ุบูุฑ ูุชููุฑ');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฑูุน ุงููููุงุช:', error);

        // Update status
        document.getElementById('uploadStatus').textContent = 'ุฌุงุฑู ุงูุญูุธ ูุญููุงู...';

        // Fallback to local upload
        await handleFilesLocal(files, city, propertyName, notes);

        // Remove progress modal
        progressModal.remove();

        // Update the attachments list immediately
        try {
            await refreshPropertyAttachmentsList(propertyKey);
            console.log('โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช ุจุนุฏ ุงูุญูุธ ุงููุญูู');
        } catch (updateError) {
            console.warn('โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช:', updateError);
        }

        // Show fallback message with sync options
        const fallbackModal = document.createElement('div');
        fallbackModal.className = 'modal-overlay';
        fallbackModal.innerHTML = `
            <div class="modal-box fallback-modal" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                <h3>ุชู ุงูุญูุธ ูุญููุงู</h3>
                <div class="fallback-details">
                    <p>ูู ูุชููู ูู ุงูุฑูุน ููุณุญุงุจุฉุ ุชู ุญูุธ ุงููููุงุช ูุญููุงู</p>
                    <div class="local-storage-info" style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
                        <i class="fas fa-laptop" style="margin-left: 8px;"></i>
                        <strong>ูุญููุธ ุนูู ูุฐุง ุงูุฌูุงุฒ ููุท</strong>
                        <br>
                        <small>ููููู ุงููุฒุงููุฉ ูุงุญูุงู ุนูุฏ ุชููุฑ ุงูุงุชุตุงู</small>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="closeModal(); refreshPropertyAttachmentsList('${propertyKey}')">
                        <i class="fas fa-eye"></i> ุนุฑุถ ุงููุฑููุงุช
                    </button>
                    <button class="btn-warning" onclick="closeModal(); retryUploadToSupabase('${city}', '${propertyName}')">
                        <i class="fas fa-sync"></i> ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> ุฅุบูุงู
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(fallbackModal);
    }
}

// Check if Supabase is available and working
async function checkSupabaseAvailability() {
    try {
        if (!supabaseClient) {
            console.warn('โ๏ธ Supabase client ุบูุฑ ูุชููุฑ');
            return false;
        }

        console.log('๐ ูุญุต ุงุชุตุงู Supabase...');

        // Test basic connection first
        const { data: testData, error: testError } = await supabaseClient
            .from('properties')
            .select('count', { count: 'exact', head: true });

        if (testError) {
            console.warn('โ๏ธ ุฎุทุฃ ูู ุงูุงุชุตุงู ุงูุฃุณุงุณู:', testError.message);
            return false;
        }

        console.log('โ ุงูุงุชุตุงู ุงูุฃุณุงุณู ูุนูู');

        // Test attachments table
        const { data: attachmentsData, error: attachmentsError } = await supabaseClient
            .from('attachments')
            .select('count', { count: 'exact', head: true });

        if (attachmentsError) {
            console.warn('โ๏ธ ุฌุฏูู ุงููุฑููุงุช ุบูุฑ ูุชููุฑ:', attachmentsError.message);

            // Try to create the table if it doesn't exist
            if (typeof ensureAttachmentsTableExists === 'function') {
                console.log('๐ง ูุญุงููุฉ ุฅูุดุงุก ุฌุฏูู ุงููุฑููุงุช...');
                await ensureAttachmentsTableExists();

                // Test again after creation
                const { error: retestError } = await supabaseClient
                    .from('attachments')
                    .select('count', { count: 'exact', head: true });

                if (retestError) {
                    console.warn('โ๏ธ ูุง ูุฒุงู ุฌุฏูู ุงููุฑููุงุช ุบูุฑ ูุชููุฑ ุจุนุฏ ุงูุฅูุดุงุก');
                    return false;
                }
            } else {
                return false;
            }
        }

        console.log('โ ุฌุฏูู ุงููุฑููุงุช ูุชููุฑ');

        // Test storage bucket
        try {
            const { data: buckets, error: bucketError } = await supabaseClient.storage.listBuckets();

            if (bucketError) {
                console.warn('โ๏ธ ุฎุทุฃ ูู ูุญุต ูุฌูุฏุงุช ุงูุชุฎุฒูู:', bucketError.message);
            } else {
                const attachmentsBucket = buckets?.find(bucket => bucket.name === 'attachments');
                if (!attachmentsBucket) {
                    console.warn('โ๏ธ ูุฌูุฏ ุงููุฑููุงุช ุบูุฑ ููุฌูุฏ');

                    // Try to create bucket
                    if (typeof ensureStorageBucketExists === 'function') {
                        console.log('๐ง ูุญุงููุฉ ุฅูุดุงุก ูุฌูุฏ ุงูุชุฎุฒูู...');
                        await ensureStorageBucketExists();
                    }
                } else {
                    console.log('โ ูุฌูุฏ ุงูุชุฎุฒูู ูุชููุฑ');
                }
            }
        } catch (storageError) {
            console.warn('โ๏ธ ุฎุทุฃ ูู ูุญุต ุงูุชุฎุฒูู:', storageError.message);
            // Don't fail completely for storage issues
        }

        console.log('โ Supabase ูุชููุฑ ููุนูู ุจุดูู ูุงูู');
        return true;

    } catch (error) {
        console.warn('โ๏ธ ุฎุทุฃ ูู ุงูุชุญูู ูู Supabase:', error.message);
        return false;
    }
}

// Retry upload to Supabase
async function retryUploadToSupabase(city, propertyName) {
    try {
        const propertyKey = `${city}_${propertyName}`;

        // Show retry modal
        const retryModal = document.createElement('div');
        retryModal.className = 'modal-overlay';
        retryModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-sync fa-spin" style="font-size: 2rem; color: #17a2b8;"></i>
                <h3>ุฌุงุฑู ุฅุนุงุฏุฉ ุงููุญุงููุฉ...</h3>
                <p>ูุชู ุฑูุน ุงููุฑููุงุช ุงููุญููุฉ ุฅูู ุงูุณุญุงุจุฉ</p>
            </div>
        `;
        document.body.appendChild(retryModal);

        // Check if Supabase is available
        const supabaseAvailable = await checkSupabaseAvailability();

        if (supabaseAvailable && typeof syncLocalAttachmentsToSupabase === 'function') {
            await syncLocalAttachmentsToSupabase();

            // Remove retry modal
            retryModal.remove();

            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box" style="text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                    <h3>ุชูุช ุงููุฒุงููุฉ ุจูุฌุงุญ!</h3>
                    <p>ุชู ุฑูุน ุฌููุน ุงููุฑููุงุช ุงููุญููุฉ ุฅูู ุงูุณุญุงุจุฉ</p>
                    <button class="btn-primary" onclick="closeModal(); showAttachmentsModal('${city}', '${propertyName}')">
                        ุนุฑุถ ุงููุฑููุงุช
                    </button>
                </div>
            `;
            document.body.appendChild(successModal);

        } else {
            // Remove retry modal
            retryModal.remove();

            // Show error message
            const errorModal = document.createElement('div');
            errorModal.className = 'modal-overlay';
            errorModal.innerHTML = `
                <div class="modal-box" style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                    <h3>ูุดู ูู ุงููุฒุงููุฉ</h3>
                    <p>ูุง ูุฒุงู ุงูุงุชุตุงู ุจุงูุณุญุงุจุฉ ุบูุฑ ูุชููุฑ</p>
                    <button class="btn-secondary" onclick="closeModal()">ุฅุบูุงู</button>
                </div>
            `;
            document.body.appendChild(errorModal);
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุงููุญุงููุฉ:', error);

        // Show error message
        const errorModal = document.createElement('div');
        errorModal.className = 'modal-overlay';
        errorModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                <h3>ุฎุทุฃ ูู ุงููุฒุงููุฉ</h3>
                <p>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุงููุฒุงููุฉ</p>
                <button class="btn-secondary" onclick="closeModal()">ุฅุบูุงู</button>
            </div>
        `;
        document.body.appendChild(errorModal);
    }
}

// Enhanced file handling with detailed progress tracking and cross-device sync
async function handleFilesEnhanced(files, city, propertyName, notes = '') {
    const propertyKey = `${city}_${propertyName}`;
    let filesProcessed = 0;
    const totalFiles = files.length;
    let cloudUploads = 0;
    let localUploads = 0;

    for (const file of files) {
        try {
            // Update current file being processed
            const currentFileElement = document.getElementById('currentFile');
            if (currentFileElement) {
                currentFileElement.innerHTML = `<i class="fas fa-upload"></i> ุฌุงุฑู ุฑูุน: ${file.name}`;
            }

            // Always try Supabase upload first for cross-device sync
            let uploadSuccess = false;

            // Try Supabase upload first
            try {
                console.log(`โ๏ธ ุฑูุน ${file.name} ุฅูู ุงูุณุญุงุจุฉ...`);

                // Check if uploadFileToSupabase function exists
                if (typeof uploadFileToSupabase !== 'function') {
                    throw new Error('ุฏุงูุฉ ุฑูุน ุงููููุงุช ุบูุฑ ูุชููุฑุฉ');
                }

                if (!supabaseClient) {
                    throw new Error('ุนููู Supabase ุบูุฑ ูุชููุฑ');
                }

                const result = await uploadFileToSupabase(file, propertyKey, notes);

                if (result) {
                    uploadSuccess = true;
                    cloudUploads++;
                    console.log(`โ ุชู ุฑูุน ${file.name} ุฅูู ุงูุณุญุงุจุฉ ุจูุฌุงุญ`);
                    console.log('๐ ุชูุงุตูู ุงููุชูุฌุฉ:', result);

                    // Trigger real-time update event
                    window.dispatchEvent(new CustomEvent('attachmentAdded', {
                        detail: { propertyKey, attachment: result }
                    }));
                } else {
                    console.warn(`โ๏ธ ุฑูุน ${file.name} ุฃุฑุฌุน ูุชูุฌุฉ ูุงุฑุบุฉ`);
                    throw new Error('ูุชูุฌุฉ ุฑูุน ุงูููู ูุงุฑุบุฉ');
                }
            } catch (supabaseError) {
                console.error(`โ ูุดู ุฑูุน ${file.name} ููุณุญุงุจุฉ:`, supabaseError);
                console.error('๐ ุชูุงุตูู ุงูุฎุทุฃ:', {
                    message: supabaseError.message,
                    stack: supabaseError.stack,
                    name: supabaseError.name
                });
                // Will fallback to local storage
            }

            // Fallback to local storage if Supabase fails
            if (!uploadSuccess) {
                console.log(`๐พ ุญูุธ ${file.name} ูุญููุงู ููุณุฎุฉ ุงุญุชูุงุทูุฉ`);
                await handleFileLocal(file, propertyKey, notes);
                localUploads++;
            }

            filesProcessed++;

            // Update progress with enhanced UI
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercentage = document.getElementById('progressPercentage');

            if (progressFill && progressText) {
                const percentage = Math.round((filesProcessed / totalFiles) * 100);
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = `${filesProcessed} ูู ${totalFiles} ููู`;

                if (progressPercentage) {
                    progressPercentage.textContent = `${percentage}%`;
                }
            }

            // Show completion for current file
            if (currentFileElement) {
                const icon = uploadSuccess ?
                    `<i class="fas fa-cloud-upload-alt" style="color: #28a745;"></i>` :
                    `<i class="fas fa-save" style="color: #ffc107;"></i>`;
                const location = uploadSuccess ? 'ุงูุณุญุงุจุฉ' : 'ูุญููุงู';
                currentFileElement.innerHTML = `${icon} ุชู ุญูุธ ${file.name} ${location}`;
            }

            // Small delay to show progress
            await new Promise(resolve => setTimeout(resolve, 300));

        } catch (error) {
            console.error(`โ ูุดู ูู ุฑูุน ${file.name}:`, error);

            // Show error for current file
            const currentFileElement = document.getElementById('currentFile');
            if (currentFileElement) {
                currentFileElement.innerHTML = `<i class="fas fa-times" style="color: #dc3545;"></i> ูุดู ูู ุฑูุน: ${file.name}`;
            }

            throw error;
        }
    }

    // Final status update with sync info
    const uploadStatus = document.getElementById('uploadStatus');
    if (uploadStatus) {
        const syncInfo = cloudUploads > 0 ?
            `<i class="fas fa-sync-alt" style="color: #17a2b8;"></i> ${cloudUploads} ููู ูุชุฒุงูู ุนุจุฑ ุงูุฃุฌูุฒุฉ` :
            `<i class="fas fa-laptop" style="color: #ffc107;"></i> ${localUploads} ููู ูุญููุธ ูุญููุงู`;

        uploadStatus.innerHTML = `
            <i class="fas fa-check-circle" style="color: #28a745;"></i> ุชู ุฑูุน ุฌููุน ุงููููุงุช ุจูุฌุงุญ!
            <br><small>${syncInfo}</small>
        `;
    }

    // Trigger real-time sync notification
    if (cloudUploads > 0) {
        console.log(`๐ ุชู ุฑูุน ${cloudUploads} ููู ููุณุญุงุจุฉ - ุณูุชู ุชุญุฏูุซ ุฌููุน ุงูุฃุฌูุฒุฉ ุงููุชุตูุฉ`);
        showConnectionNotification(`ุชู ูุฒุงููุฉ ${cloudUploads} ููู ุนุจุฑ ุงูุฃุฌูุฒุฉ`, 'success');
    }
}

// Handle single file upload to local storage
async function handleFileLocal(file, propertyKey, notes = '') {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const attachment = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result,
                    date: new Date().toISOString(),
                    notes: notes
                };

                // Get existing attachments
                const existingAttachments = JSON.parse(localStorage.getItem('propertyAttachments') || '{}');

                // Initialize property attachments if not exists
                if (!existingAttachments[propertyKey]) {
                    existingAttachments[propertyKey] = [];
                }

                // Add new attachment
                existingAttachments[propertyKey].push(attachment);

                // Save to localStorage
                localStorage.setItem('propertyAttachments', JSON.stringify(existingAttachments));

                // Update global attachments variable
                if (typeof window.attachments !== 'undefined') {
                    window.attachments = existingAttachments;
                }

                resolve(attachment);

            } catch (error) {
                reject(error);
            }
        };

        reader.onerror = function() {
            reject(new Error('ูุดู ูู ูุฑุงุกุฉ ุงูููู'));
        };

        reader.readAsDataURL(file);
    });
}

// Fallback local file handling
async function handleFilesLocal(files, city, propertyName, notes = '') {
    const propertyKey = `${city}_${propertyName}`;

    // Initialize global attachments if not exists
    if (!window.attachments) {
        window.attachments = {};
    }

    if (!window.attachments[propertyKey]) {
        window.attachments[propertyKey] = [];
    }

    let filesProcessed = 0;
    const totalFiles = files.length;

    for (const file of files) {
        const reader = new FileReader();

        await new Promise((resolve) => {
            reader.onload = function(e) {
                const attachment = {
                    name: file.name,
                    type: file.type,
                    data: e.target.result,
                    date: new Date().toISOString(),
                    uploadDate: new Date().toISOString(),
                    size: file.size,
                    notes: notes
                };

                window.attachments[propertyKey].push(attachment);
                filesProcessed++;
                resolve();
            };
            reader.readAsDataURL(file);
        });
    }

    // Save to localStorage with both keys for compatibility
    localStorage.setItem('propertyAttachments', JSON.stringify(window.attachments));
    localStorage.setItem('attachments', JSON.stringify(window.attachments));

    console.log(`๐พ ุชู ุญูุธ ${filesProcessed} ููู ูุญููุงู ููุนูุงุฑ ${propertyKey}`);
}

// Legacy function for backward compatibility
function handleFileUpload(event, city, propertyName) {
    handleFileUploadEnhanced(event, city, propertyName);
}

function handleFiles(files, city, propertyName) {
    handleFilesLocal(files, city, propertyName);
}

// ุจุญุซ ูู ุงููุฑููุงุช
function filterAttachmentsList(event) {
    const term = event.target.value.toLowerCase();
    document.querySelectorAll('.attachment-item').forEach(item => {
        item.style.display = item.dataset.name.includes(term) ? '' : 'none';
    });
}

// ุฃููููุฉ ุงูููู ุญุณุจ ุงูููุน
function getFileIcon(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();

    // ุตูุฑ
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(extension)) {
        return '<i class="fas fa-image"></i>';
    }
    // PDF
    if (extension === 'pdf') {
        return '<i class="fas fa-file-pdf"></i>';
    }
    // Word
    if (['doc', 'docx'].includes(extension)) {
        return '<i class="fas fa-file-word"></i>';
    }
    // Excel
    if (['xls', 'xlsx', 'csv'].includes(extension)) {
        return '<i class="fas fa-file-excel"></i>';
    }
    // PowerPoint
    if (['ppt', 'pptx'].includes(extension)) {
        return '<i class="fas fa-file-powerpoint"></i>';
    }
    // ููุฏูู
    if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(extension)) {
        return '<i class="fas fa-file-video"></i>';
    }
    // ุตูุช
    if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(extension)) {
        return '<i class="fas fa-file-audio"></i>';
    }
    // ูุต
    if (['txt', 'rtf'].includes(extension)) {
        return '<i class="fas fa-file-alt"></i>';
    }
    // ุฃุฑุดูู
    if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) {
        return '<i class="fas fa-file-archive"></i>';
    }

    return '<i class="fas fa-file"></i>';
}

// ููู ุฃููููุฉ ุงูููู ุญุณุจ ุงูููุน
function getFileIconColor(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();

    // ุตูุฑ - ุฃุฒุฑู
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(extension)) {
        return '#007bff';
    }
    // PDF - ุฃุญูุฑ
    if (extension === 'pdf') {
        return '#dc3545';
    }
    // Word - ุฃุฒุฑู ุฏุงูู
    if (['doc', 'docx'].includes(extension)) {
        return '#2b579a';
    }
    // Excel - ุฃุฎุถุฑ
    if (['xls', 'xlsx', 'csv'].includes(extension)) {
        return '#217346';
    }
    // PowerPoint - ุจุฑุชูุงูู
    if (['ppt', 'pptx'].includes(extension)) {
        return '#d24726';
    }
    // ููุฏูู - ุจููุณุฌู
    if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(extension)) {
        return '#6f42c1';
    }
    // ุตูุช - ูุฑุฏู
    if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(extension)) {
        return '#e83e8c';
    }
    // ูุต - ุฑูุงุฏู
    if (['txt', 'rtf'].includes(extension)) {
        return '#6c757d';
    }
    // ุฃุฑุดูู - ุจูู
    if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) {
        return '#795548';
    }

    // ุงูุชุฑุงุถู - ุฑูุงุฏู
    return '#6c757d';
}

// ุชูุณูู ุญุฌู ุงูููู
function formatFileSize(bytes) {
    if (bytes === 0) return '0 ุจุงูุช';

    const k = 1024;
    const sizes = ['ุจุงูุช', 'ููููุจุงูุช', 'ููุฌุงุจุงูุช', 'ุฌูุฌุงุจุงูุช'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ุนุฑุถ ุงููุฑูู
function viewAttachment(propertyKey, fileName) {
    const att = (attachments[propertyKey] || []).find(a => a.name === fileName);
    if (!att) return;
    if (att.type.startsWith('image/')) {
        let html = `<div class="modal-overlay" style="display:flex;">
            <div class="modal-box" style="max-width:90vw;max-height:90vh;padding:10px;">
                <button class="close-modal" onclick="closeModal()">ร</button>
                <img src="${att.data}" style="max-width:100%;max-height:80vh;display:block;margin:0 auto;">
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } else if (att.type === 'application/pdf') {
        let html = `<div class="modal-overlay" style="display:flex;">
            <div class="modal-box" style="max-width:90vw;max-height:90vh;padding:10px;">
                <button class="close-modal" onclick="closeModal()">ร</button>
                <iframe src="${att.data}" style="width:100%;height:80vh;border:none;"></iframe>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } else {
        downloadAttachment(propertyKey, fileName);
    }
}

// ุชูุฒูู ุงููุฑูู
function downloadAttachment(propertyKey, fileName) {
    const att = (attachments[propertyKey] || []).find(a => a.name === fileName);
    if (!att) return;
    const link = document.createElement('a');
    link.href = att.data;
    link.download = att.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ุญุฐู ุงููุฑูู
function deleteAttachment(propertyKey, fileName, city, propertyName) {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุฑููุ')) return;
    attachments[propertyKey] = (attachments[propertyKey] || []).filter(a => a.name !== fileName);
    localStorage.setItem('propertyAttachments', JSON.stringify(attachments));
    showAttachmentsModal(city, propertyName);
}

// ===== SUPABASE ATTACHMENT FUNCTIONS =====

// View attachment from Supabase
function viewAttachmentFromSupabase(attachmentId, fileUrl, fileType) {
    if (fileType.startsWith('image/')) {
        let html = `<div class="modal-overlay" style="display:flex;">
            <div class="modal-box mobile-friendly" style="max-width:90vw;max-height:90vh;padding:10px;">
                <button class="close-modal mobile-friendly" onclick="closeModal()">ร</button>
                <img src="${fileUrl}" style="max-width:100%;max-height:80vh;display:block;margin:0 auto;" alt="ูุฑูู">
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } else if (fileType === 'application/pdf') {
        let html = `<div class="modal-overlay" style="display:flex;">
            <div class="modal-box mobile-friendly" style="max-width:90vw;max-height:90vh;padding:10px;">
                <button class="close-modal mobile-friendly" onclick="closeModal()">ร</button>
                <iframe src="${fileUrl}" style="width:100%;height:80vh;border:none;" title="ูุฑูู PDF"></iframe>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } else {
        // For other file types, download directly
        downloadAttachmentFromSupabase(fileUrl, 'attachment');
    }
}

// Download attachment from Supabase
function downloadAttachmentFromSupabase(fileUrl, fileName) {
    const link = document.createElement('a');
    link.href = fileUrl;
    link.download = fileName;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Delete attachment from Supabase
async function deleteAttachmentFromSupabase(attachmentId, propertyKey) {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุฑููุ ุณูุชู ุญุฐูู ููุงุฆูุงู ูู ุงูุณุญุงุจุฉ.')) return;

    // Show loading
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #dc3545;"></i>
            <p style="margin-top: 20px;">ุฌุงุฑู ุญุฐู ุงููุฑูู...</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        if (typeof deleteAttachmentEnhanced === 'function') {
            await deleteAttachmentEnhanced(attachmentId);

            // Remove loading modal
            loadingModal.remove();

            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box" style="text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                    <h3>ุชู ุญุฐู ุงููุฑูู ุจูุฌุงุญ</h3>
                    <button class="btn-primary" onclick="closeModal(); refreshAttachmentsList('${propertyKey}')">
                        ุชุญุฏูุซ ุงููุงุฆูุฉ
                    </button>
                </div>
            `;
            document.body.appendChild(successModal);

        } else {
            throw new Error('Delete function not available');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงููุฑูู:', error);

        // Remove loading modal
        loadingModal.remove();

        // Show error message
        const errorModal = document.createElement('div');
        errorModal.className = 'modal-overlay';
        errorModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                <h3>ุฎุทุฃ ูู ุญุฐู ุงููุฑูู</h3>
                <p>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุฑูู ูู ุงูุณุญุงุจุฉ</p>
                <button class="btn-secondary" onclick="closeModal()">ุฅุบูุงู</button>
            </div>
        `;
        document.body.appendChild(errorModal);
    }
}

// Manual sync attachments
async function syncAttachmentsManually(propertyKey) {
    const syncModal = document.createElement('div');
    syncModal.className = 'modal-overlay';
    syncModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-sync fa-spin" style="font-size: 2rem; color: #17a2b8;"></i>
            <h3>ุฌุงุฑู ุงููุฒุงููุฉ...</h3>
            <p>ูุชู ูุฒุงููุฉ ุงููุฑููุงุช ูุน ุงูุณุญุงุจุฉ</p>
        </div>
    `;
    document.body.appendChild(syncModal);

    try {
        if (typeof syncLocalAttachmentsToSupabase === 'function') {
            await syncLocalAttachmentsToSupabase();

            // Remove sync modal
            syncModal.remove();

            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box" style="text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                    <h3>ุชูุช ุงููุฒุงููุฉ ุจูุฌุงุญ</h3>
                    <p>ุชู ูุฒุงููุฉ ุฌููุน ุงููุฑููุงุช ูุน ุงูุณุญุงุจุฉ</p>
                    <button class="btn-primary" onclick="closeModal(); refreshAttachmentsList('${propertyKey}')">
                        ุชุญุฏูุซ ุงููุงุฆูุฉ
                    </button>
                </div>
            `;
            document.body.appendChild(successModal);

        } else {
            throw new Error('Sync function not available');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงููุฒุงููุฉ:', error);

        // Remove sync modal
        syncModal.remove();

        // Show error message
        const errorModal = document.createElement('div');
        errorModal.className = 'modal-overlay';
        errorModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                <h3>ุฎุทุฃ ูู ุงููุฒุงููุฉ</h3>
                <p>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฒุงููุฉ ุงููุฑููุงุช</p>
                <button class="btn-secondary" onclick="closeModal()">ุฅุบูุงู</button>
            </div>
        `;
        document.body.appendChild(errorModal);
    }
}

// Enhanced drag and drop setup with cross-device support
function setupDragAndDropEnhanced(propertyKey) {
    const uploadZone = document.querySelector('.upload-zone');
    if (!uploadZone) return;

    // Enhanced mobile-friendly drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.backgroundColor = '#f8f9fa';
        uploadZone.style.transform = 'scale(1.02)';
    });

    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.backgroundColor = '';
        uploadZone.style.transform = 'scale(1)';
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.backgroundColor = '';
        uploadZone.style.transform = 'scale(1)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // Extract city and property name from the current modal
            const modal = uploadZone.closest('.attachments-modal');
            if (modal) {
                const propertyKeyFromModal = modal.getAttribute('data-property-key');
                if (propertyKeyFromModal) {
                    const [city, propertyName] = propertyKeyFromModal.split('_');
                    handleFileUploadEnhanced({ target: { files } }, city, propertyName);
                }
            }
        }
    });

    // Touch support for mobile devices
    uploadZone.addEventListener('touchstart', () => {
        uploadZone.style.backgroundColor = '#f8f9fa';
    });

    uploadZone.addEventListener('touchend', () => {
        uploadZone.style.backgroundColor = '';
    });
}

// Setup real-time updates for modal
function setupModalRealTimeUpdates(propertyKey) {
    // Listen for custom attachment events
    window.addEventListener('attachmentAdded', (event) => {
        if (event.detail.propertyKey === propertyKey) {
            console.log('๐ ููู ุฌุฏูุฏ ุชู ุฅุถุงูุชู ูู ุฌูุงุฒ ุขุฎุฑ');
            refreshAttachmentsList(propertyKey);
        }
    });

    window.addEventListener('attachmentDeleted', (event) => {
        if (event.detail.propertyKey === propertyKey) {
            console.log('๐๏ธ ููู ุชู ุญุฐูู ูู ุฌูุงุฒ ุขุฎุฑ');
            refreshAttachmentsList(propertyKey);
        }
    });
}

// Update sync status indicator
function updateSyncStatus() {
    const syncStatus = document.getElementById('syncStatus');
    if (!syncStatus) return;

    if (typeof checkSupabaseAvailability === 'function') {
        checkSupabaseAvailability().then(isAvailable => {
            if (isAvailable) {
                syncStatus.innerHTML = '<i class="fas fa-sync-alt" style="color: #28a745;"></i> ูุชุฒุงูู';
                syncStatus.style.color = '#28a745';
            } else {
                syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> ูุญูู ููุท';
                syncStatus.style.color = '#ffc107';
            }
        });
    } else {
        syncStatus.innerHTML = '<i class="fas fa-laptop" style="color: #6c757d;"></i> ูุญูู';
        syncStatus.style.color = '#6c757d';
    }
}

// Refresh attachments list in modal
async function refreshAttachmentsList(propertyKey) {
    try {
        const modal = document.querySelector(`.attachments-modal[data-property-key="${propertyKey}"]`);
        if (!modal) return;

        const listContainer = modal.querySelector('.attachments-list');
        if (!listContainer) return;

        // Show loading state
        listContainer.style.opacity = '0.7';
        listContainer.innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #17a2b8;"></i>
                <p style="margin-top: 15px; color: #6c757d;">ุฌุงุฑู ุชุญุฏูุซ ุงููุฑููุงุช...</p>
            </div>
        `;

        // Get updated attachments - prioritize Supabase
        let attachments = [];
        let isFromCloud = false;

        // Try Supabase first
        if (typeof getPropertyAttachmentsEnhanced === 'function' && supabaseClient) {
            try {
                attachments = await getPropertyAttachmentsEnhanced(propertyKey);
                isFromCloud = true;
                console.log(`โ๏ธ ุชู ุฌูุจ ${attachments.length} ูุฑูู ูู ุงูุณุญุงุจุฉ`);
            } catch (error) {
                console.warn('โ๏ธ ูุดู ูู ุฌูุจ ุงููุฑููุงุช ูู ุงูุณุญุงุจุฉ:', error);
            }
        }

        // Fallback to local storage
        if (!isFromCloud || attachments.length === 0) {
            attachments = window.attachments?.[propertyKey] || [];
            console.log(`๐พ ุชู ุฌูุจ ${attachments.length} ูุฑูู ูุญูู`);
        }

        // Update the list with sync status indicator
        if (attachments.length === 0) {
            listContainer.innerHTML = `
                <div class="no-attachments-state" style="text-align:center;color:#888;padding:40px 20px;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                    <h4 style="margin: 10px 0; color: #6c757d;">ูุง ุชูุฌุฏ ูุฑููุงุช ุจุนุฏ</h4>
                    <p style="color: #aaa; margin: 0;">ุงุณุญุจ ุงููููุงุช ููุง ุฃู ุงุณุชุฎุฏู ุฒุฑ ุงูุฑูุน ูุฅุถุงูุฉ ูุฑููุงุช</p>
                    ${isFromCloud ?
                        '<p style="color: #17a2b8; margin-top: 10px;"><i class="fas fa-sync-alt"></i> ูุชุฒุงูู ูุน ุงูุณุญุงุจุฉ</p>' :
                        '<p style="color: #ffc107; margin-top: 10px;"><i class="fas fa-laptop"></i> ูุญูู ููุท</p>'
                    }
                </div>
            `;
        } else {
            listContainer.innerHTML = attachments.map(att => {
                const fileName = att.file_name || att.name;
                const fileType = att.file_type || att.type;
                const fileSize = att.file_size || att.size;
                const uploadDate = att.created_at || att.date;
                const notes = att.notes || '';
                const isCloudFile = !!att.id; // Has Supabase ID

                return `
                    <div class="attachment-item enhanced" data-name="${fileName.toLowerCase()}" ${att.id ? `data-id="${att.id}"` : ''}>
                        <div class="attachment-icon">
                            ${getFileIcon(fileName)}
                            ${isCloudFile ?
                                '<i class="fas fa-cloud" style="position: absolute; top: -5px; right: -5px; font-size: 0.8rem; color: #17a2b8;" title="ูุชุฒุงูู ูุน ุงูุณุญุงุจุฉ"></i>' :
                                '<i class="fas fa-laptop" style="position: absolute; top: -5px; right: -5px; font-size: 0.8rem; color: #ffc107;" title="ูุญูู ููุท"></i>'
                            }
                        </div>
                        <div class="attachment-details">
                            <div class="attachment-name" title="${fileName}">${fileName}</div>
                            <div class="attachment-meta">
                                <span class="file-size">${formatFileSize(fileSize)}</span>
                                <span class="upload-date">${formatDate(uploadDate)}</span>
                                ${notes ? `<span class="file-notes" title="${notes}"><i class="fas fa-sticky-note"></i></span>` : ''}
                                ${isCloudFile ?
                                    '<span class="sync-status" style="color: #17a2b8;" title="ูุชุฒุงูู ุนุจุฑ ุงูุฃุฌูุฒุฉ"><i class="fas fa-sync-alt"></i></span>' :
                                    '<span class="sync-status" style="color: #ffc107;" title="ูุญูู ููุท"><i class="fas fa-laptop"></i></span>'
                                }
                            </div>
                        </div>
                        <div class="attachment-actions">
                            ${isCloudFile ?
                                // Supabase attachment
                                `<button class="attachment-btn view-btn" onclick="viewAttachmentFromSupabase('${att.id}', '${att.file_url}', '${fileType}')" title="ูุนุงููุฉ">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="attachment-btn download-btn" onclick="downloadAttachmentFromSupabase('${att.file_url}', '${fileName}')" title="ุชุญููู">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="attachment-btn delete-btn" onclick="deleteAttachmentFromSupabase('${att.id}', '${propertyKey}')" title="ุญุฐู ูู ุฌููุน ุงูุฃุฌูุฒุฉ">
                                    <i class="fas fa-trash"></i>
                                </button>` :
                                // Local attachment
                                `<button class="attachment-btn view-btn" onclick="viewAttachment('${propertyKey}', '${fileName}')" title="ูุนุงููุฉ">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="attachment-btn download-btn" onclick="downloadAttachment('${propertyKey}', '${fileName}')" title="ุชุญููู">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="attachment-btn delete-btn" onclick="deleteAttachment('${propertyKey}', '${fileName}')" title="ุญุฐู ูุญูู">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="attachment-btn sync-btn" onclick="syncLocalAttachment('${propertyKey}', '${fileName}')" title="ูุฒุงููุฉ ูุน ุงูุณุญุงุจุฉ">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update attachment count
        const countElement = modal.querySelector('.attachment-count');
        if (countElement) {
            countElement.textContent = `(${attachments.length} ููู)`;
        }

        // Update footer summary with sync status
        const summaryElement = modal.querySelector('.attachments-summary');
        if (summaryElement) {
            const cloudFiles = attachments.filter(att => att.id).length;
            const localFiles = attachments.length - cloudFiles;

            let summaryText = `<i class="fas fa-info-circle"></i> ${attachments.length} ููู`;

            if (isFromCloud && cloudFiles > 0) {
                summaryText += ` โข <i class="fas fa-sync-alt" style="color: #17a2b8;"></i> ${cloudFiles} ูุชุฒุงูู ุนุจุฑ ุงูุฃุฌูุฒุฉ`;
                if (localFiles > 0) {
                    summaryText += ` โข <i class="fas fa-laptop" style="color: #ffc107;"></i> ${localFiles} ูุญูู`;
                }
            } else if (localFiles > 0) {
                summaryText += ` โข <i class="fas fa-laptop" style="color: #ffc107;"></i> ูุญููุธ ูุญููุงู ููุท`;
            }

            summaryElement.innerHTML = summaryText;
        }

        // Restore opacity
        listContainer.style.opacity = '1';

        console.log(`โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช: ${attachments.length} ููู`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช:', error);

        const listContainer = document.querySelector('.attachments-list');
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="error-state" style="text-align: center; padding: 30px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545; margin-bottom: 15px;"></i>
                    <p style="color: #dc3545;">ุฎุทุฃ ูู ุชุญููู ุงููุฑููุงุช</p>
                    <button onclick="refreshAttachmentsList('${propertyKey}')" class="btn-secondary">ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button>
                </div>
            `;
            listContainer.style.opacity = '1';
        }
    }
}

// Sync local attachment to cloud
async function syncLocalAttachment(propertyKey, fileName) {
    try {
        console.log(`๐ ูุฒุงููุฉ ููู ูุญูู: ${fileName}`);

        // Get local attachment
        const localAttachments = window.attachments?.[propertyKey] || [];
        const attachment = localAttachments.find(att => att.name === fileName);

        if (!attachment) {
            throw new Error('ุงูููู ุงููุญูู ุบูุฑ ููุฌูุฏ');
        }

        // Convert base64 to file
        const response = await fetch(attachment.data);
        const blob = await response.blob();
        const file = new File([blob], attachment.name, { type: attachment.type });

        // Upload to Supabase
        if (typeof uploadFileToSupabase === 'function') {
            const result = await uploadFileToSupabase(file, propertyKey, attachment.notes || '');

            if (result) {
                console.log(`โ ุชู ูุฒุงููุฉ ${fileName} ูุน ุงูุณุญุงุจุฉ`);
                showConnectionNotification(`ุชู ูุฒุงููุฉ ${fileName} ูุน ุงูุณุญุงุจุฉ`, 'success');

                // Remove from local storage
                const updatedLocal = localAttachments.filter(att => att.name !== fileName);
                window.attachments[propertyKey] = updatedLocal;
                localStorage.setItem('propertyAttachments', JSON.stringify(window.attachments));

                // Refresh the list
                refreshAttachmentsList(propertyKey);

                return true;
            }
        }

        throw new Error('ูุดู ูู ุฑูุน ุงูููู ููุณุญุงุจุฉ');

    } catch (error) {
        console.error(`โ ุฎุทุฃ ูู ูุฒุงููุฉ ${fileName}:`, error);
        showConnectionNotification(`ูุดู ูู ูุฒุงููุฉ ${fileName}`, 'error');
        return false;
    }
}

// Setup real-time sync for attachments
function setupAttachmentRealTimeSync() {
    if (typeof subscribeToAttachmentChanges === 'function') {
        try {
            const subscription = subscribeToAttachmentChanges();

            if (subscription) {
                console.log('๐ ุชู ุชูุนูู ุงููุฒุงููุฉ ุงูููุฑูุฉ ูููุฑููุงุช');

                // Listen for attachment changes
                window.addEventListener('attachmentAdded', (event) => {
                    const { propertyKey } = event.detail;
                    console.log(`๐ ููู ุฌุฏูุฏ ุชู ุฅุถุงูุชู: ${propertyKey}`);

                    // Refresh any open attachment modals for this property
                    const modal = document.querySelector(`.attachments-modal[data-property-key="${propertyKey}"]`);
                    if (modal) {
                        refreshAttachmentsList(propertyKey);
                    }

                    showConnectionNotification('ุชู ุฅุถุงูุฉ ููู ุฌุฏูุฏ ูู ุฌูุงุฒ ุขุฎุฑ', 'info');
                });

                window.addEventListener('attachmentDeleted', (event) => {
                    const { propertyKey } = event.detail;
                    console.log(`๐๏ธ ููู ุชู ุญุฐูู: ${propertyKey}`);

                    // Refresh any open attachment modals for this property
                    const modal = document.querySelector(`.attachments-modal[data-property-key="${propertyKey}"]`);
                    if (modal) {
                        refreshAttachmentsList(propertyKey);
                    }

                    showConnectionNotification('ุชู ุญุฐู ููู ูู ุฌูุงุฒ ุขุฎุฑ', 'info');
                });

                return subscription;
            }
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุชูุนูู ุงููุฒุงููุฉ ุงูููุฑูุฉ:', error);
        }
    }

    return null;
}

// Show local attachments modal (fallback)
function showAttachmentsModalLocal(city, propertyName) {
    const propertyKey = `${city}_${propertyName}`;
    const propertyAttachments = attachments[propertyKey] || [];

    // Use the original function logic but with local data only
    showAttachmentsModal(city, propertyName);
}

// ===== ATTACHMENTS SYSTEM INITIALIZATION =====

// Initialize the enhanced cross-device attachments system
let isSystemInitialized = false;
let initializationPromise = null;

async function initializeAttachmentsSystem() {
    // Prevent multiple initializations
    if (isSystemInitialized) {
        console.log('โ ูุธุงู ุงููุฑููุงุช ูููุฃ ุจุงููุนู');
        return;
    }

    if (initializationPromise) {
        return initializationPromise;
    }

    initializationPromise = performInitialization();
    return initializationPromise;
}

async function performInitialization() {
    try {
        if (window.debugMode) {
            console.log('๐ ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช ุงููุญุณู...');
        }

        // Check if Supabase is available
        if (!supabaseClient) {
            console.warn('โ๏ธ Supabase ุบูุฑ ูุชููุฑุ ุณูุชู ุงุณุชุฎุฏุงู ุงููุธุงู ุงููุญูู ููุท');
            if (window.debugMode) {
                showConnectionNotification('ุงููุธุงู ุงููุญูู ููุท', 'warning');
            }
            isSystemInitialized = true;
            return;
        }

        // Test Supabase connection first
        const isSupabaseAvailable = await checkSupabaseAvailability();
        if (!isSupabaseAvailable) {
            console.warn('โ๏ธ ูุง ูููู ุงูุงุชุตุงู ุจู Supabase');
            if (window.debugMode) {
                showConnectionNotification('ูุง ูููู ุงูุงุชุตุงู ุจุงูุณุญุงุจุฉ', 'warning');
            }
            isSystemInitialized = true;
            return;
        }

        // Ensure Supabase attachments table exists
        if (typeof ensureAttachmentsTableExists === 'function') {
            await ensureAttachmentsTableExists();
            if (window.debugMode) {
                console.log('โ ุฌุฏูู ุงููุฑููุงุช ุฌุงูุฒ');
            }
        }

        // Ensure storage bucket exists
        if (typeof ensureStorageBucketExists === 'function') {
            await ensureStorageBucketExists();
            if (window.debugMode) {
                console.log('โ ูุฌูุฏ ุงูุชุฎุฒูู ุฌุงูุฒ');
            }
        }

        // Subscribe to real-time attachment changes
        if (typeof subscribeToAttachmentChanges === 'function') {
            const subscription = subscribeToAttachmentChanges();
            if (subscription) {
                console.log('๐ ุชู ุชูุนูู ุงููุฒุงููุฉ ุงูููุฑูุฉ');
                showConnectionNotification('ุงููุฒุงููุฉ ุงูููุฑูุฉ ูุดุทุฉ', 'success');
            }
        }

        // Setup attachment real-time sync
        setupAttachmentRealTimeSync();

        // Test attachment functions (only in debug mode)
        if (window.debugMode) {
            await testAttachmentFunctions();
        }

        // Initialize connection indicator
        updateConnectionIndicator(true);

        // Sync local attachments to Supabase (background process)
        setTimeout(async () => {
            if (typeof syncLocalAttachmentsToSupabase === 'function') {
                try {
                    if (window.debugMode) {
                        console.log('๐ ุจุฏุก ูุฒุงููุฉ ุงููุฑููุงุช ุงููุญููุฉ...');
                    }
                    await syncLocalAttachmentsToSupabase();
                    if (window.debugMode) {
                        console.log('โ ุชู ูุฒุงููุฉ ุงููุฑููุงุช ุงููุญููุฉ');
                        showConnectionNotification('ุชู ูุฒุงููุฉ ุงููุฑููุงุช ุงููุญููุฉ', 'success');
                    }
                } catch (error) {
                    if (window.debugMode) {
                        console.warn('โ๏ธ ูุดู ูู ูุฒุงููุฉ ุงููุฑููุงุช:', error.message);
                    }
                }
            }
        }, 5000); // Wait 5 seconds after app load

        // Setup periodic connection check (less frequent)
        setInterval(async () => {
            const isConnected = await checkSupabaseAvailability();
            updateConnectionIndicator(isConnected);
        }, 60000); // Check every 60 seconds instead of 30

        console.log('๐ ุชู ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช ุจูุฌุงุญ');
        isSystemInitialized = true;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช:', error);
        if (window.debugMode) {
            showConnectionNotification('ุฎุทุฃ ูู ุงูุชููุฆุฉ', 'error');
        }
        updateConnectionIndicator(false);
        isSystemInitialized = true;
    }
}

// Test attachment functions availability
async function testAttachmentFunctions() {
    try {
        console.log('๐งช ุงุฎุชุจุงุฑ ูุธุงุฆู ุงููุฑููุงุช...');

        const functions = [
            'ensureAttachmentsTableExists',
            'uploadFileToSupabase',
            'getPropertyAttachmentsEnhanced',
            'deleteAttachmentEnhanced',
            'syncLocalAttachmentsToSupabase',
            'subscribeToAttachmentChanges'
        ];

        const availableFunctions = [];
        const missingFunctions = [];

        functions.forEach(funcName => {
            if (typeof window[funcName] === 'function') {
                availableFunctions.push(funcName);
            } else {
                missingFunctions.push(funcName);
            }
        });

        console.log('โ ูุธุงุฆู ูุชููุฑุฉ:', availableFunctions);
        if (missingFunctions.length > 0) {
            console.warn('โ๏ธ ูุธุงุฆู ููููุฏุฉ:', missingFunctions);
        }

        // Test Supabase connection for attachments
        if (supabaseClient) {
            try {
                const { data, error } = await supabaseClient
                    .from('attachments')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    console.warn('โ๏ธ ุฌุฏูู ุงููุฑููุงุช ุบูุฑ ููุฌูุฏ ุฃู ุบูุฑ ูุชุงุญ:', error.message);
                } else {
                    console.log('โ ุฌุฏูู ุงููุฑููุงุช ูุชุงุญ');
                }
            } catch (error) {
                console.warn('โ๏ธ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุฌุฏูู ุงููุฑููุงุช:', error.message);
            }
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ูุธุงุฆู ุงููุฑููุงุช:', error);
    }
}

// Format date for display
function formatDate(dateString) {
    if (!dateString) return 'ุบูุฑ ูุญุฏุฏ';

    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-SA', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (error) {
        return 'ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ';
    }
}

// Enhanced file icon function (legacy - replaced by new getFileIcon above)

// Enhanced file size formatting
function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 ุจุงูุช';

    const k = 1024;
    const sizes = ['ุจุงูุช', 'ููููุจุงูุช', 'ููุฌุงุจุงูุช', 'ุฌูุฌุงุจุงูุช', 'ุชูุฑุงุจุงูุช'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    if (i >= sizes.length) return 'ููู ูุจูุฑ ุฌุฏุงู';

    const size = parseFloat((bytes / Math.pow(k, i)).toFixed(2));
    return `${size} ${sizes[i]}`;
}

// Check if device is mobile
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
           window.innerWidth <= 768;
}

// ===== ูุธุงู ุฅุฏุงุฑุฉ ุงูุฅุดุนุงุฑุงุช =====

// ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
const notificationSettings = {
    // ุฅุนุฏุงุฏุงุช ุนุงูุฉ
    enabled: true,
    developerMode: false,

    // ุฃููุงุน ุงูุฅุดุนุงุฑุงุช ุงููุณููุญุฉ
    allowedTypes: {
        error: true,        // ุฃุฎุทุงุก ูููุฉ
        success: true,      // ูุฌุงุญ ุงูุนูููุงุช ุงููููุฉ
        warning: true,      // ุชุญุฐูุฑุงุช ูููุฉ
        info: false,        // ูุนูููุงุช ุนุงูุฉ (ูุฎููุฉ ุงูุชุฑุงุถูุงู)
        debug: false        // ุฑุณุงุฆู ุงูุชุทููุฑ (ูุฎููุฉ ุงูุชุฑุงุถูุงู)
    },

    // ุงูุนูููุงุช ุงููููุฉ ุงูุชู ุชุญุชุงุฌ ุฅุดุนุงุฑุงุช
    importantOperations: [
        'ุญูุธ', 'ุชุญุฏูุซ', 'ุญุฐู', 'ูุฒุงููุฉ', 'ุงุณุชูุฑุงุฏ', 'ุชุตุฏูุฑ',
        'ุชุณุฌูู ุงูุฏุฎูู', 'ุชุณุฌูู ุงูุฎุฑูุฌ', 'ุฅุตูุงุญ ุงูุฅุญุตุงุฆูุงุช'
    ]
};

// ุชุญููู ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช ูู localStorage
function loadNotificationSettings() {
    const saved = localStorage.getItem('notificationSettings');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            Object.assign(notificationSettings, parsed);
        } catch (error) {
            console.warn('ุฎุทุฃ ูู ุชุญููู ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช:', error);
        }
    }
}

// ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช ูู localStorage
function saveNotificationSettings() {
    localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
}

// ูุญุต ูุง ุฅุฐุง ูุงู ุงูุฅุดุนุงุฑ ููู
function isImportantNotification(message, type) {
    // ุงูุฃุฎุทุงุก ุฏุงุฆูุงู ูููุฉ
    if (type === 'error') return true;

    // ูุญุต ุงูุนูููุงุช ุงููููุฉ
    const isImportantOperation = notificationSettings.importantOperations.some(op =>
        message.includes(op)
    );

    return isImportantOperation;
}

// Show toast notification ูุน ูุธุงู ุงูููุชุฑุฉ
function showToast(message, type = 'info', duration = 3000) {
    // ุชุญููู ุงูุฅุนุฏุงุฏุงุช
    loadNotificationSettings();

    // ูุญุต ูุง ุฅุฐุง ูุงูุช ุงูุฅุดุนุงุฑุงุช ููุนูุฉ
    if (!notificationSettings.enabled) {
        console.log(`[TOAST DISABLED] ${type.toUpperCase()}: ${message}`);
        return;
    }

    // ูุญุต ููุน ุงูุฅุดุนุงุฑ
    if (!notificationSettings.allowedTypes[type]) {
        // ุฅุฐุง ูุงู ุงูุฅุดุนุงุฑ ุบูุฑ ูุณููุญุ ุชุญูู ูู ุฃูููุชู
        if (!isImportantNotification(message, type)) {
            console.log(`[TOAST FILTERED] ${type.toUpperCase()}: ${message}`);
            return;
        }
    }

    // ูู ูุถุน ุงููุทูุฑุ ุงุนุฑุถ ุฌููุน ุงูุฅุดุนุงุฑุงุช
    if (notificationSettings.developerMode) {
        console.log(`[DEVELOPER MODE] ${type.toUpperCase()}: ${message}`);
    }

    const toast = document.createElement('div');
    toast.className = `message-toast ${type}`;
    toast.textContent = message;

    document.body.appendChild(toast);

    // Auto remove after duration
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, duration);

    return toast;
}

// ===== DATA IMPORT SYSTEM =====

// Global variables for import system
let importedData = null;
let importPreview = null;
let importStats = {
    totalRecords: 0,
    newProperties: 0,
    newUnits: 0,
    updatedUnits: 0,
    errors: 0,
    warnings: 0
};

// Show data import modal
function showDataImportModal() {
    console.log('๐ ูุชุญ ูุงูุฐุฉ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช...');

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="data-import-modal">
            <div class="import-modal-header">
                <h2><i class="fas fa-file-import"></i> ุงุณุชูุฑุงุฏ ููู ุงูุจูุงูุงุช</h2>
                <p>ุงุณุชูุฑุงุฏ ูุชุญุฏูุซ ุจูุงูุงุช ุงูุนูุงุฑุงุช ูู ููู ุฎุงุฑุฌู</p>
            </div>

            <div class="import-modal-content">
                <!-- ุฎุทูุฉ 1: ุงุฎุชูุงุฑ ุงูููู -->
                <div class="import-step" id="step1">
                    <div class="step-header">
                        <span class="step-number">1</span>
                        <h3>ุงุฎุชูุงุฑ ููู ุงูุจูุงูุงุช</h3>
                    </div>

                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <p>ุงุณุญุจ ุงูููู ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
                            <small>ุงููููุงุช ุงููุฏุนููุฉ: JSON, CSV, Excel (.xlsx)</small>
                        </div>
                        <input type="file" id="importFileInput" accept=".json,.csv,.xlsx" style="display: none;">
                    </div>

                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="file-details">
                            <i class="fas fa-file"></i>
                            <span id="fileName"></span>
                            <span id="fileSize"></span>
                        </div>
                        <button class="change-file-btn" onclick="changeImportFile()">
                            <i class="fas fa-exchange-alt"></i> ุชุบููุฑ ุงูููู
                        </button>
                    </div>
                </div>

                <!-- ุฎุทูุฉ 2: ูุนุงููุฉ ุงูุจูุงูุงุช -->
                <div class="import-step" id="step2" style="display: none;">
                    <div class="step-header">
                        <span class="step-number">2</span>
                        <h3>ูุนุงููุฉ ุงูุจูุงูุงุช</h3>
                    </div>

                    <div class="preview-stats" id="previewStats"></div>
                    <div class="preview-table-container">
                        <table class="preview-table" id="previewTable"></table>
                    </div>

                    <div class="import-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="createBackup" checked>
                            <span class="checkmark"></span>
                            ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุงูุงุณุชูุฑุงุฏ
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="updateExisting" checked>
                            <span class="checkmark"></span>
                            ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="addNewUnits" checked>
                            <span class="checkmark"></span>
                            ุฅุถุงูุฉ ูุญุฏุงุช ุฌุฏูุฏุฉ
                        </label>
                    </div>
                </div>

                <!-- ุฎุทูุฉ 3: ุชูููุฐ ุงูุงุณุชูุฑุงุฏ -->
                <div class="import-step" id="step3" style="display: none;">
                    <div class="step-header">
                        <span class="step-number">3</span>
                        <h3>ุชูููุฐ ุงูุงุณุชูุฑุงุฏ</h3>
                    </div>

                    <div class="import-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">ุฌุงุฑู ุงูุชุญุถูุฑ...</div>
                    </div>

                    <div class="import-log" id="importLog"></div>
                </div>

                <!-- ุฎุทูุฉ 4: ุงููุชุงุฆุฌ -->
                <div class="import-step" id="step4" style="display: none;">
                    <div class="step-header">
                        <span class="step-number">4</span>
                        <h3>ูุชุงุฆุฌ ุงูุงุณุชูุฑุงุฏ</h3>
                    </div>

                    <div class="import-results" id="importResults"></div>
                </div>
            </div>

            <div class="import-modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeImportModal()">
                    <i class="fas fa-times"></i> ุฅุบูุงู
                </button>
                <button class="modal-action-btn next-btn" id="nextBtn" onclick="nextImportStep()" style="display: none;">
                    <i class="fas fa-arrow-left"></i> ุงูุชุงูู
                </button>
                <button class="modal-action-btn import-btn" id="importBtn" onclick="executeImport()" style="display: none;">
                    <i class="fas fa-download"></i> ุจุฏุก ุงูุงุณุชูุฑุงุฏ
                </button>
                <button class="modal-action-btn finish-btn" id="finishBtn" onclick="finishImport()" style="display: none;">
                    <i class="fas fa-check"></i> ุฅููุงุก
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setupFileUpload();
}

// Setup file upload functionality
function setupFileUpload() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('importFileInput');

    // Click to upload
    fileUploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });
}

// Handle file selection
async function handleFileSelection(file) {
    console.log('๐ ุชู ุงุฎุชูุงุฑ ุงูููู:', file.name);

    // Validate file type
    const allowedTypes = ['.json', '.csv', '.xlsx'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

    if (!allowedTypes.includes(fileExtension)) {
        showImportError('ููุน ุงูููู ุบูุฑ ูุฏุนูู. ุงููููุงุช ุงููุฏุนููุฉ: JSON, CSV, Excel (.xlsx)');
        return;
    }

    // Show file info
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileUploadArea').style.display = 'none';
    document.getElementById('fileInfo').style.display = 'flex';
    document.getElementById('nextBtn').style.display = 'inline-flex';

    // Parse file
    try {
        importedData = await parseImportFile(file);
        console.log('โ ุชู ุชุญููู ุงูููู ุจูุฌุงุญ:', importedData.length, 'ุณุฌู');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูููู:', error);
        showImportError('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: ' + error.message);
    }
}

// Parse import file based on type
async function parseImportFile(file) {
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

    switch (fileExtension) {
        case '.json':
            return await parseJSONFile(file);
        case '.csv':
            return await parseCSVFile(file);
        case '.xlsx':
            return await parseExcelFile(file);
        default:
            throw new Error('ููุน ุงูููู ุบูุฑ ูุฏุนูู');
    }
}

// Parse JSON file
async function parseJSONFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                    resolve(data);
                } else {
                    reject(new Error('ููู JSON ูุฌุจ ุฃู ูุญุชูู ุนูู ูุตูููุฉ ูู ุงูุจูุงูุงุช'));
                }
            } catch (error) {
                reject(new Error('ุฎุทุฃ ูู ุชุญููู ููู JSON: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู'));
        reader.readAsText(file);
    });
}

// Parse CSV file
async function parseCSVFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    reject(new Error('ููู CSV ูุฌุจ ุฃู ูุญุชูู ุนูู ุฑุฃุณ ูุจูุงูุงุช'));
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};

                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });

                    data.push(row);
                }

                resolve(data);
            } catch (error) {
                reject(new Error('ุฎุทุฃ ูู ุชุญููู ููู CSV: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู'));
        reader.readAsText(file);
    });
}

// Parse Excel file (requires SheetJS library)
async function parseExcelFile(file) {
    // Note: This requires the SheetJS library to be loaded
    if (typeof XLSX === 'undefined') {
        throw new Error('ููุชุจุฉ Excel ุบูุฑ ูุญููุฉ. ูุฑุฌู ุชุญููู SheetJS library');
    }

    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                resolve(jsonData);
            } catch (error) {
                reject(new Error('ุฎุทุฃ ูู ุชุญููู ููู Excel: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู'));
        reader.readAsArrayBuffer(file);
    });
}

// Next step in import process
function nextImportStep() {
    const currentStep = document.querySelector('.import-step:not([style*="display: none"])');
    const stepNumber = parseInt(currentStep.id.replace('step', ''));

    if (stepNumber === 1) {
        // Move to preview step
        showImportStep(2);
        generateImportPreview();
    }
}

// Show specific import step
function showImportStep(stepNumber) {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (step) step.style.display = 'none';
    }

    // Show target step
    const targetStep = document.getElementById(`step${stepNumber}`);
    if (targetStep) targetStep.style.display = 'block';

    // Update buttons
    updateImportButtons(stepNumber);
}

// Update import modal buttons
function updateImportButtons(stepNumber) {
    const nextBtn = document.getElementById('nextBtn');
    const importBtn = document.getElementById('importBtn');
    const finishBtn = document.getElementById('finishBtn');

    // Hide all buttons first
    nextBtn.style.display = 'none';
    importBtn.style.display = 'none';
    finishBtn.style.display = 'none';

    switch (stepNumber) {
        case 1:
            if (importedData) nextBtn.style.display = 'inline-flex';
            break;
        case 2:
            importBtn.style.display = 'inline-flex';
            break;
        case 3:
            // No buttons during import
            break;
        case 4:
            finishBtn.style.display = 'inline-flex';
            break;
    }
}

// Generate import preview
function generateImportPreview() {
    console.log('๐ ุฅูุดุงุก ูุนุงููุฉ ุงูุจูุงูุงุช...');

    if (!importedData || importedData.length === 0) {
        showImportError('ูุง ุชูุฌุฏ ุจูุงูุงุช ูููุนุงููุฉ');
        return;
    }

    // Analyze data and generate preview
    analyzeImportData();
    displayPreviewStats();
    displayPreviewTable();
}

// Analyze import data
function analyzeImportData() {
    console.log('๐ ุชุญููู ุงูุจูุงูุงุช ุงููุณุชูุฑุฏุฉ...');

    importStats = {
        totalRecords: importedData.length,
        newProperties: 0,
        newUnits: 0,
        updatedUnits: 0,
        errors: 0,
        warnings: 0
    };

    importPreview = [];

    importedData.forEach((record, index) => {
        try {
            const analysis = analyzeRecord(record, index);
            importPreview.push(analysis);

            // Update stats
            if (analysis.action === 'new_property') importStats.newProperties++;
            else if (analysis.action === 'new_unit') importStats.newUnits++;
            else if (analysis.action === 'update_unit') importStats.updatedUnits++;

            if (analysis.errors.length > 0) importStats.errors++;
            if (analysis.warnings.length > 0) importStats.warnings++;

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุชุญููู ุงูุณุฌู ${index}:`, error);
            importStats.errors++;
        }
    });

    console.log('๐ ูุชุงุฆุฌ ุงูุชุญููู:', importStats);
}

// Analyze individual record
function analyzeRecord(record, index) {
    const analysis = {
        index: index,
        record: record,
        action: 'unknown',
        existingProperty: null,
        existingUnit: null,
        errors: [],
        warnings: []
    };

    // Validate required fields
    const requiredFields = ['ุงุณู ุงูุนูุงุฑ', 'ุงููุฏููุฉ', 'ุฑูู  ุงููุญุฏุฉ '];
    requiredFields.forEach(field => {
        if (!record[field] || record[field].toString().trim() === '') {
            analysis.errors.push(`ุงูุญูู "${field}" ูุทููุจ`);
        }
    });

    if (analysis.errors.length > 0) {
        return analysis;
    }

    // Find existing property
    const propertyName = record['ุงุณู ุงูุนูุงุฑ'].toString().trim();
    const cityName = record['ุงููุฏููุฉ'].toString().trim();
    const unitNumber = record['ุฑูู  ุงููุญุฏุฉ '].toString().trim();

    analysis.existingProperty = properties.find(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName && p['ุงููุฏููุฉ'] === cityName
    );

    if (analysis.existingProperty) {
        // Property exists, check for unit
        analysis.existingUnit = properties.find(p =>
            p['ุงุณู ุงูุนูุงุฑ'] === propertyName &&
            p['ุงููุฏููุฉ'] === cityName &&
            p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber
        );

        if (analysis.existingUnit) {
            analysis.action = 'update_unit';
        } else {
            analysis.action = 'new_unit';
        }
    } else {
        analysis.action = 'new_property';
    }

    // Validate data types
    validateRecordData(record, analysis);

    return analysis;
}

// Validate record data types
function validateRecordData(record, analysis) {
    // Validate numeric fields
    const numericFields = ['ูููุฉ  ุงูุงูุฌุงุฑ ', 'ุงููุณุงุญุฉ', 'ุนุฏุฏ ุงูุงูุณุงุท'];
    numericFields.forEach(field => {
        if (record[field] && record[field] !== '') {
            const value = parseFloat(record[field]);
            if (isNaN(value)) {
                analysis.warnings.push(`ุงูุญูู "${field}" ูุฌุจ ุฃู ูููู ุฑูู`);
            }
        }
    });

    // Validate dates
    const dateFields = ['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ', 'ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ'];
    dateFields.forEach(field => {
        if (record[field] && record[field] !== '') {
            const date = new Date(record[field]);
            if (isNaN(date.getTime())) {
                analysis.warnings.push(`ุงูุญูู "${field}" ูุฌุจ ุฃู ูููู ุชุงุฑูุฎ ุตุญูุญ`);
            }
        }
    });
}

// Next step in import process
function nextImportStep() {
    const currentStep = document.querySelector('.import-step:not([style*="display: none"])');
    const stepNumber = parseInt(currentStep.id.replace('step', ''));

    if (stepNumber === 1) {
        // Move to preview step
        showImportStep(2);
        generateImportPreview();
    }
}

// Show specific import step
function showImportStep(stepNumber) {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (step) step.style.display = 'none';
    }

    // Show target step
    const targetStep = document.getElementById(`step${stepNumber}`);
    if (targetStep) targetStep.style.display = 'block';

    // Update buttons
    updateImportButtons(stepNumber);
}

// Update import modal buttons
function updateImportButtons(stepNumber) {
    const nextBtn = document.getElementById('nextBtn');
    const importBtn = document.getElementById('importBtn');
    const finishBtn = document.getElementById('finishBtn');

    // Hide all buttons first
    nextBtn.style.display = 'none';
    importBtn.style.display = 'none';
    finishBtn.style.display = 'none';

    switch (stepNumber) {
        case 1:
            if (importedData) nextBtn.style.display = 'inline-flex';
            break;
        case 2:
            importBtn.style.display = 'inline-flex';
            break;
        case 3:
            // No buttons during import
            break;
        case 4:
            finishBtn.style.display = 'inline-flex';
            break;
    }
}

// Generate import preview
function generateImportPreview() {
    console.log('๐ ุฅูุดุงุก ูุนุงููุฉ ุงูุจูุงูุงุช...');

    if (!importedData || importedData.length === 0) {
        showImportError('ูุง ุชูุฌุฏ ุจูุงูุงุช ูููุนุงููุฉ');
        return;
    }

    // Analyze data and generate preview
    analyzeImportData();
    displayPreviewStats();
    displayPreviewTable();
}

// Analyze import data
function analyzeImportData() {
    console.log('๐ ุชุญููู ุงูุจูุงูุงุช ุงููุณุชูุฑุฏุฉ...');

    importStats = {
        totalRecords: importedData.length,
        newProperties: 0,
        newUnits: 0,
        updatedUnits: 0,
        errors: 0,
        warnings: 0
    };

    importPreview = [];

    importedData.forEach((record, index) => {
        try {
            const analysis = analyzeRecord(record, index);
            importPreview.push(analysis);

            // Update stats
            if (analysis.action === 'new_property') importStats.newProperties++;
            else if (analysis.action === 'new_unit') importStats.newUnits++;
            else if (analysis.action === 'update_unit') importStats.updatedUnits++;

            if (analysis.errors.length > 0) importStats.errors++;
            if (analysis.warnings.length > 0) importStats.warnings++;

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุชุญููู ุงูุณุฌู ${index}:`, error);
            importStats.errors++;
        }
    });

    console.log('๐ ูุชุงุฆุฌ ุงูุชุญููู:', importStats);
}

// Analyze individual record
function analyzeRecord(record, index) {
    const analysis = {
        index: index,
        record: record,
        action: 'unknown',
        existingProperty: null,
        existingUnit: null,
        errors: [],
        warnings: []
    };

    // Validate required fields
    const requiredFields = ['ุงุณู ุงูุนูุงุฑ', 'ุงููุฏููุฉ', 'ุฑูู  ุงููุญุฏุฉ '];
    requiredFields.forEach(field => {
        if (!record[field] || record[field].toString().trim() === '') {
            analysis.errors.push(`ุงูุญูู "${field}" ูุทููุจ`);
        }
    });

    if (analysis.errors.length > 0) {
        return analysis;
    }

    // Find existing property
    const propertyName = record['ุงุณู ุงูุนูุงุฑ'].toString().trim();
    const cityName = record['ุงููุฏููุฉ'].toString().trim();
    const unitNumber = record['ุฑูู  ุงููุญุฏุฉ '].toString().trim();

    analysis.existingProperty = properties.find(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName && p['ุงููุฏููุฉ'] === cityName
    );

    if (analysis.existingProperty) {
        // Property exists, check for unit
        analysis.existingUnit = properties.find(p =>
            p['ุงุณู ุงูุนูุงุฑ'] === propertyName &&
            p['ุงููุฏููุฉ'] === cityName &&
            p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber
        );

        if (analysis.existingUnit) {
            analysis.action = 'update_unit';
        } else {
            analysis.action = 'new_unit';
        }
    } else {
        analysis.action = 'new_property';
    }

    // Validate data types
    validateRecordData(record, analysis);

    return analysis;
}

// Validate record data types
function validateRecordData(record, analysis) {
    // Validate numeric fields
    const numericFields = [
        'ูููุฉ  ุงูุงูุฌุงุฑ ', 'ุงููุณุงุญุฉ', 'ุนุฏุฏ ุงูุงูุณุงุท', 'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ',
        'ูุณุงุญุฉ ุงูุตู', 'ูุณุงุญุฉุงูุตู', 'ุงูุงุฌูุงูู', 'ุงููุจูุบ ุงููุฏููุน', 'ุงููุจูุบ ุงููุชุจูู'
    ];
    numericFields.forEach(field => {
        if (record[field] && record[field] !== '' && record[field] !== null) {
            const value = parseFloat(record[field]);
            if (isNaN(value)) {
                analysis.warnings.push(`ุงูุญูู "${field}" ูุฌุจ ุฃู ูููู ุฑูู`);
            }
        }
    });

    // Validate dates
    const dateFields = [
        'ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ', 'ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ', 'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ', 'ุชุงุฑูุฎ ุงูููุงูุฉ',
        'ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ', 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู', 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู', 'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท'
    ];
    dateFields.forEach(field => {
        if (record[field] && record[field] !== '' && record[field] !== null) {
            // Handle different date formats
            let dateStr = record[field].toString();

            // Remove time part if exists
            if (dateStr.includes(' 00:00:00')) {
                dateStr = dateStr.replace(' 00:00:00', '');
            }

            // Try to parse the date
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                // Try alternative formats
                const altFormats = [
                    dateStr.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, '$3-$2-$1'), // DD/MM/YYYY to YYYY-MM-DD
                    dateStr.replace(/(\d{1,2})-(\d{1,2})-(\d{4})/, '$3-$2-$1'),  // DD-MM-YYYY to YYYY-MM-DD
                    dateStr.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, '$3-$1-$2')  // MM/DD/YYYY to YYYY-MM-DD
                ];

                let validDate = false;
                for (const format of altFormats) {
                    const testDate = new Date(format);
                    if (!isNaN(testDate.getTime())) {
                        validDate = true;
                        break;
                    }
                }

                if (!validDate) {
                    analysis.warnings.push(`ุงูุญูู "${field}" ูุฌุจ ุฃู ูููู ุชุงุฑูุฎ ุตุญูุญ (${dateStr})`);
                }
            }
        }
    });

    // Validate contract status
    const validStatuses = ['ูุดุท', 'ุดุงุบุฑ', 'ูุคูุฏ', 'ููุชูู ูุฑูุจุงู', 'ููุชูู', 'ูุนูู'];
    if (record['ุญุงูุฉ ุงูุนูุฏ'] && !validStatuses.includes(record['ุญุงูุฉ ุงูุนูุฏ'])) {
        analysis.warnings.push(`ุญุงูุฉ ุงูุนูุฏ "${record['ุญุงูุฉ ุงูุนูุฏ']}" ุบูุฑ ุตุญูุญุฉ`);
    }

    // Validate contract type
    const validTypes = ['ุถุฑูุจู', 'ุบูุฑ ุถุฑูุจู', 'ุญูููู', 'ุฎุงุต'];
    if (record['ููุน ุงูุนูุฏ'] && !validTypes.includes(record['ููุน ุงูุนูุฏ'])) {
        analysis.warnings.push(`ููุน ุงูุนูุฏ "${record['ููุน ุงูุนูุฏ']}" ุบูุฑ ุตุญูุญ`);
    }

    // Validate financial consistency
    if (record['ุงูุงุฌูุงูู'] && record['ุงููุจูุบ ุงููุฏููุน'] && record['ุงููุจูุบ ุงููุชุจูู']) {
        const total = parseFloat(record['ุงูุงุฌูุงูู']);
        const paid = parseFloat(record['ุงููุจูุบ ุงููุฏููุน']);
        const remaining = parseFloat(record['ุงููุจูุบ ุงููุชุจูู']);

        if (!isNaN(total) && !isNaN(paid) && !isNaN(remaining)) {
            const calculatedRemaining = total - paid;
            if (Math.abs(calculatedRemaining - remaining) > 0.01) {
                analysis.warnings.push(`ุนุฏู ุชุทุงุจู ูู ุงููุจุงูุบ ุงููุงููุฉ: ุงูุฅุฌูุงูู ${total} - ุงููุฏููุน ${paid} โ ุงููุชุจูู ${remaining}`);
            }
        }
    }
}

// Display preview statistics
function displayPreviewStats() {
    const statsContainer = document.getElementById('previewStats');

    statsContainer.innerHTML = `
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">${importStats.totalRecords}</div>
                <div class="stat-label">ุฅุฌูุงูู ุงูุณุฌูุงุช</div>
            </div>
            <div class="stat-item new">
                <div class="stat-number">${importStats.newProperties}</div>
                <div class="stat-label">ุนูุงุฑุงุช ุฌุฏูุฏุฉ</div>
            </div>
            <div class="stat-item new">
                <div class="stat-number">${importStats.newUnits}</div>
                <div class="stat-label">ูุญุฏุงุช ุฌุฏูุฏุฉ</div>
            </div>
            <div class="stat-item update">
                <div class="stat-number">${importStats.updatedUnits}</div>
                <div class="stat-label">ูุญุฏุงุช ูุญุฏุซุฉ</div>
            </div>
            <div class="stat-item warning">
                <div class="stat-number">${importStats.warnings}</div>
                <div class="stat-label">ุชุญุฐูุฑุงุช</div>
            </div>
            <div class="stat-item error">
                <div class="stat-number">${importStats.errors}</div>
                <div class="stat-label">ุฃุฎุทุงุก</div>
            </div>
        </div>
    `;
}

// Display preview table
function displayPreviewTable() {
    const tableContainer = document.getElementById('previewTable');

    if (!importPreview || importPreview.length === 0) {
        tableContainer.innerHTML = '<p>ูุง ุชูุฌุฏ ุจูุงูุงุช ูููุนุงููุฉ</p>';
        return;
    }

    // Show first 10 records for preview
    const previewData = importPreview.slice(0, 10);

    let tableHTML = `
        <thead>
            <tr>
                <th>#</th>
                <th>ุงุณู ุงูุนูุงุฑ</th>
                <th>ุงููุฏููุฉ</th>
                <th>ุฑูู ุงููุญุฏุฉ</th>
                <th>ุงูุฅุฌุฑุงุก</th>
                <th>ุงูุญุงูุฉ</th>
            </tr>
        </thead>
        <tbody>
    `;

    previewData.forEach((item, index) => {
        const record = item.record;
        const actionText = getActionText(item.action);
        const statusClass = getStatusClass(item);
        const statusText = getStatusText(item);

        tableHTML += `
            <tr class="${statusClass}">
                <td>${index + 1}</td>
                <td>${record['ุงุณู ุงูุนูุงุฑ'] || '-'}</td>
                <td>${record['ุงููุฏููุฉ'] || '-'}</td>
                <td>${record['ุฑูู  ุงููุญุฏุฉ '] || '-'}</td>
                <td>${actionText}</td>
                <td>${statusText}</td>
            </tr>
        `;
    });

    tableHTML += '</tbody>';

    if (importPreview.length > 10) {
        tableHTML += `
            <tfoot>
                <tr>
                    <td colspan="6" class="more-records">
                        ... ู ${importPreview.length - 10} ุณุฌู ุขุฎุฑ
                    </td>
                </tr>
            </tfoot>
        `;
    }

    tableContainer.innerHTML = tableHTML;
}

// Get action text in Arabic
function getActionText(action) {
    switch (action) {
        case 'new_property': return 'ุฅูุดุงุก ุนูุงุฑ ุฌุฏูุฏ';
        case 'new_unit': return 'ุฅุถุงูุฉ ูุญุฏุฉ ุฌุฏูุฏุฉ';
        case 'update_unit': return 'ุชุญุฏูุซ ูุญุฏุฉ ููุฌูุฏุฉ';
        default: return 'ุบูุฑ ูุญุฏุฏ';
    }
}

// Get status class for styling
function getStatusClass(item) {
    if (item.errors.length > 0) return 'error';
    if (item.warnings.length > 0) return 'warning';
    return 'success';
}

// Get status text
function getStatusText(item) {
    if (item.errors.length > 0) return `ุฎุทุฃ (${item.errors.length})`;
    if (item.warnings.length > 0) return `ุชุญุฐูุฑ (${item.warnings.length})`;
    return 'ุฌุงูุฒ';
}

// Execute import process
async function executeImport() {
    console.log('๐ ุจุฏุก ุชูููุฐ ุนูููุฉ ุงูุงุณุชูุฑุงุฏ...');

    // Move to execution step
    showImportStep(3);

    // Get import options
    const createBackup = document.getElementById('createBackup').checked;
    const updateExisting = document.getElementById('updateExisting').checked;
    const addNewUnits = document.getElementById('addNewUnits').checked;

    console.log('โ๏ธ ุฎูุงุฑุงุช ุงูุงุณุชูุฑุงุฏ:', { createBackup, updateExisting, addNewUnits });

    try {
        // Step 1: Create backup if requested
        if (createBackup) {
            await createDataBackup();
            updateImportProgress(10, 'ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ...');
        }

        // Step 2: Process import data
        updateImportProgress(20, 'ุจุฏุก ูุนุงูุฌุฉ ุงูุจูุงูุงุช...');

        const results = await processImportData(updateExisting, addNewUnits);

        // Step 3: Save to localStorage
        updateImportProgress(80, 'ุญูุธ ุงูุจูุงูุงุช ูุญููุงู...');
        localStorage.setItem('properties', JSON.stringify(properties));

        // Step 4: Sync with Supabase if available
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            updateImportProgress(90, 'ูุฒุงููุฉ ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช...');
            await syncImportWithSupabase(results);
        }

        // Step 5: Complete
        updateImportProgress(100, 'ุชู ุงูุงูุชูุงุก ูู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ!');

        // Show results
        setTimeout(() => {
            showImportResults(results);
        }, 1000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุนูููุฉ ุงูุงุณุชูุฑุงุฏ:', error);
        showImportError('ุฎุทุฃ ูู ุนูููุฉ ุงูุงุณุชูุฑุงุฏ: ' + error.message);
    }
}

// Create data backup with storage management
async function createDataBackup() {
    console.log('๐พ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ...');

    try {
        // Clean up storage before creating backup
        await cleanupLocalStorage();

        const backupData = {
            timestamp: new Date().toISOString(),
            properties: [...properties],
            totalCount: properties.length
        };

        // Save backup to localStorage with error handling
        const backupKey = `backup_${Date.now()}`;

        try {
            localStorage.setItem(backupKey, JSON.stringify(backupData));
            console.log(`โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ: ${backupKey}`);
            addImportLog(`โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ (${properties.length} ุนูุงุฑ)`);
        } catch (storageError) {
            console.warn('โ๏ธ ูุดู ูู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', storageError.message);

            // Try to free up more space and retry
            await forceCleanupStorage();

            try {
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                console.log(`โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุจุนุฏ ุชูุธูู ุงูุชุฎุฒูู: ${backupKey}`);
                addImportLog(`โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ (${properties.length} ุนูุงุฑ)`);
            } catch (retryError) {
                console.error('โ ูุดู ูู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ููุงุฆูุงู:', retryError.message);
                addImportLog(`โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ (ูุณุงุญุฉ ุงูุชุฎุฒูู ููุชูุฆุฉ)`);
            }
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู:', error);
        addImportLog(`โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ`);
    }
}

// Clean up localStorage to free space
async function cleanupLocalStorage() {
    console.log('๐งน ุชูุธูู ูุณุงุญุฉ ุงูุชุฎุฒูู...');

    try {
        // Keep only last 3 backups instead of 5
        const allKeys = Object.keys(localStorage);
        const backupKeys = allKeys.filter(key => key.startsWith('backup_')).sort();

        if (backupKeys.length > 3) {
            const keysToRemove = backupKeys.slice(0, backupKeys.length - 3);
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log(`๐๏ธ ุชู ุญุฐู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงููุฏููุฉ: ${key}`);
            });
        }

        // Clean up old update logs (keep only last 50 entries)
        const updateLog = JSON.parse(localStorage.getItem('updateLog') || '[]');
        if (updateLog.length > 50) {
            const trimmedLog = updateLog.slice(-50);
            localStorage.setItem('updateLog', JSON.stringify(trimmedLog));
            console.log(`๐๏ธ ุชู ุชูุธูู ุณุฌู ุงูุชุญุฏูุซุงุช: ${updateLog.length} โ ${trimmedLog.length}`);
        }

        // Clean up any temporary data
        const tempKeys = allKeys.filter(key =>
            key.startsWith('temp_') ||
            key.startsWith('cache_') ||
            key.includes('_temp')
        );

        tempKeys.forEach(key => {
            localStorage.removeItem(key);
            console.log(`๐๏ธ ุชู ุญุฐู ุงูุจูุงูุงุช ุงููุคูุชุฉ: ${key}`);
        });

        console.log('โ ุชู ุชูุธูู ูุณุงุญุฉ ุงูุชุฎุฒูู');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชูุธูู ุงูุชุฎุฒูู:', error);
    }
}

// Force cleanup storage (more aggressive)
async function forceCleanupStorage() {
    console.log('๐งน ุชูุธูู ูุณุฑู ููุณุงุญุฉ ุงูุชุฎุฒูู...');

    try {
        // Remove all backups except the most recent one
        const allKeys = Object.keys(localStorage);
        const backupKeys = allKeys.filter(key => key.startsWith('backup_')).sort();

        if (backupKeys.length > 1) {
            const keysToRemove = backupKeys.slice(0, backupKeys.length - 1);
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log(`๐๏ธ ุชู ุญุฐู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: ${key}`);
            });
        }

        // Clear update log completely
        localStorage.removeItem('updateLog');
        console.log('๐๏ธ ุชู ุญุฐู ุณุฌู ุงูุชุญุฏูุซุงุช');

        // Clear any other non-essential data
        const nonEssentialKeys = allKeys.filter(key =>
            !key.includes('properties') &&
            !key.includes('cardAttachments') &&
            !key.startsWith('backup_')
        );

        nonEssentialKeys.forEach(key => {
            localStorage.removeItem(key);
            console.log(`๐๏ธ ุชู ุญุฐู ุงูุจูุงูุงุช ุบูุฑ ุงูุฃุณุงุณูุฉ: ${key}`);
        });

        console.log('โ ุชู ุงูุชูุธูู ุงููุณุฑู ููุณุงุญุฉ ุงูุชุฎุฒูู');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชูุธูู ุงููุณุฑู:', error);
    }
}

// Save to localStorage with retry mechanism
async function saveToLocalStorageWithRetry(key, data, maxRetries = 3) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            localStorage.setItem(key, data);
            console.log(`โ ุชู ุญูุธ ${key} ูู ุงููุญุงููุฉ ${attempt}`);
            return; // Success

        } catch (error) {
            console.warn(`โ๏ธ ูุดูุช ุงููุญุงููุฉ ${attempt} ูุญูุธ ${key}:`, error.message);

            if (error.message.includes('quota') || error.message.includes('Storage')) {
                console.log(`๐งน ุชูุธูู ุงูุชุฎุฒูู ูุจู ุงููุญุงููุฉ ${attempt + 1}...`);

                if (attempt === 1) {
                    // First attempt: light cleanup
                    await cleanupLocalStorage();
                } else if (attempt === 2) {
                    // Second attempt: aggressive cleanup
                    await forceCleanupStorage();
                } else {
                    // Final attempt: show storage info and fail
                    showStorageInfo();
                    throw new Error('ูุณุงุญุฉ ุงูุชุฎุฒูู ููุชูุฆุฉ ููุง ูููู ุชุญุฑูุฑ ูุณุงุญุฉ ูุงููุฉ');
                }
            } else {
                // Non-storage related error, don't retry
                throw error;
            }
        }
    }

    throw new Error(`ูุดู ูู ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ${maxRetries} ูุญุงููุงุช`);
}

// Show storage information
function showStorageInfo() {
    try {
        const storageInfo = getStorageInfo();
        console.log('๐ ูุนูููุงุช ุงูุชุฎุฒูู:', storageInfo);

        // Show user-friendly storage info
        const message = `
ูุนูููุงุช ูุณุงุญุฉ ุงูุชุฎุฒูู:
- ุงููุณุงุญุฉ ุงููุณุชุฎุฏูุฉ: ${storageInfo.usedMB} ููุฌุงุจุงูุช
- ุงููุณุงุญุฉ ุงููุชุงุญุฉ: ${storageInfo.availableMB} ููุฌุงุจุงูุช
- ุงููุณุจุฉ ุงููุณุชุฎุฏูุฉ: ${storageInfo.usagePercentage}%

ูุญู ูุฐู ุงููุดููุฉ:
1. ุงุญุฐู ุจุนุถ ุงูุจูุงูุงุช ุบูุฑ ุงููููุฉ ูู ุงููุชุตูุญ
2. ุงุณุชุฎุฏู ูุชุตูุญ ุขุฎุฑ
3. ุงูุณุญ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ูููุชุตูุญ
        `;

        console.log(message);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุนุฑุถ ูุนูููุงุช ุงูุชุฎุฒูู:', error);
    }
}

// Get storage information
function getStorageInfo() {
    try {
        let totalSize = 0;
        let itemCount = 0;

        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                const itemSize = localStorage.getItem(key).length;
                totalSize += itemSize;
                itemCount++;
            }
        }

        // Estimate available space (most browsers have ~5-10MB limit)
        const estimatedLimit = 5 * 1024 * 1024; // 5MB in characters
        const usedMB = (totalSize / (1024 * 1024)).toFixed(2);
        const availableMB = ((estimatedLimit - totalSize) / (1024 * 1024)).toFixed(2);
        const usagePercentage = ((totalSize / estimatedLimit) * 100).toFixed(1);

        return {
            totalSize,
            itemCount,
            usedMB,
            availableMB,
            usagePercentage
        };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุณุงุจ ูุนูููุงุช ุงูุชุฎุฒูู:', error);
        return {
            totalSize: 0,
            itemCount: 0,
            usedMB: '0',
            availableMB: 'ุบูุฑ ูุนุฑูู',
            usagePercentage: '0'
        };
    }
}

// Process import data
async function processImportData(updateExisting, addNewUnits) {
    console.log('๐ ูุนุงูุฌุฉ ุจูุงูุงุช ุงูุงุณุชูุฑุงุฏ...');

    const results = {
        processed: 0,
        newProperties: 0,
        newUnits: 0,
        updatedUnits: 0,
        skipped: 0,
        errors: []
    };

    for (let i = 0; i < importPreview.length; i++) {
        const item = importPreview[i];
        const progress = 20 + (60 * (i + 1) / importPreview.length);

        updateImportProgress(progress, `ูุนุงูุฌุฉ ุงูุณุฌู ${i + 1} ูู ${importPreview.length}...`);

        try {
            if (item.errors.length > 0) {
                results.skipped++;
                results.errors.push(`ุงูุณุฌู ${i + 1}: ${item.errors.join(', ')}`);
                addImportLog(`โ๏ธ ุชู ุชุฎุทู ุงูุณุฌู ${i + 1}: ${item.errors[0]}`);
                continue;
            }

            await processRecord(item, updateExisting, addNewUnits, results);
            results.processed++;

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุณุฌู ${i + 1}:`, error);
            results.errors.push(`ุงูุณุฌู ${i + 1}: ${error.message}`);
            addImportLog(`โ ุฎุทุฃ ูู ุงูุณุฌู ${i + 1}: ${error.message}`);
        }

        // Small delay to allow UI updates
        await new Promise(resolve => setTimeout(resolve, 10));
    }

    console.log('๐ ูุชุงุฆุฌ ุงููุนุงูุฌุฉ:', results);
    return results;
}

// Process individual record
async function processRecord(item, updateExisting, addNewUnits, results) {
    const record = item.record;

    switch (item.action) {
        case 'new_property':
            await createNewProperty(record, results);
            break;

        case 'new_unit':
            if (addNewUnits) {
                await createNewUnit(record, results);
            } else {
                results.skipped++;
                addImportLog(`โญ๏ธ ุชู ุชุฎุทู ูุญุฏุฉ ุฌุฏูุฏุฉ: ${record['ุฑูู  ุงููุญุฏุฉ ']} (ุฅุถุงูุฉ ุงููุญุฏุงุช ุงูุฌุฏูุฏุฉ ูุนุทูุฉ)`);
            }
            break;

        case 'update_unit':
            if (updateExisting) {
                await updateExistingUnit(record, item.existingUnit, results);
            } else {
                results.skipped++;
                addImportLog(`โญ๏ธ ุชู ุชุฎุทู ุชุญุฏูุซ ุงููุญุฏุฉ: ${record['ุฑูู  ุงููุญุฏุฉ ']} (ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูุนุทู)`);
            }
            break;
    }
}

// Create new property from import
async function createNewProperty(record, results) {
    const newProperty = createPropertyFromRecord(record);
    properties.push(newProperty);
    results.newProperties++;
    addImportLog(`โ ุชู ุฅูุดุงุก ุนูุงุฑ ุฌุฏูุฏ: ${record['ุงุณู ุงูุนูุงุฑ']} - ${record['ุฑูู  ุงููุญุฏุฉ ']}`);
}

// Create new unit from import
async function createNewUnit(record, results) {
    const newUnit = createPropertyFromRecord(record);
    properties.push(newUnit);
    results.newUnits++;
    addImportLog(`โ ุชู ุฅุถุงูุฉ ูุญุฏุฉ ุฌุฏูุฏุฉ: ${record['ุฑูู  ุงููุญุฏุฉ ']} ูู ${record['ุงุณู ุงูุนูุงุฑ']}`);
}

// Update existing unit from import
async function updateExistingUnit(record, existingUnit, results) {
    const unitIndex = properties.findIndex(p => p === existingUnit);
    if (unitIndex !== -1) {
        // Update all fields from import
        Object.keys(record).forEach(key => {
            if (record[key] !== null && record[key] !== undefined && record[key] !== '') {
                properties[unitIndex][key] = record[key];
            }
        });

        results.updatedUnits++;
        addImportLog(`๐ ุชู ุชุญุฏูุซ ุงููุญุฏุฉ: ${record['ุฑูู  ุงููุญุฏุฉ ']} ูู ${record['ุงุณู ุงูุนูุงุฑ']}`);
    }
}

// Create property object from record
function createPropertyFromRecord(record) {
    return {
        'ุงุณู ุงูุนูุงุฑ': record['ุงุณู ุงูุนูุงุฑ'] || '',
        'ุงููุฏููุฉ': record['ุงููุฏููุฉ'] || '',
        'ุฑูู  ุงููุญุฏุฉ ': record['ุฑูู  ุงููุญุฏุฉ '] || '',
        'ุงุณู ุงููุณุชุฃุฌุฑ': record['ุงุณู ุงููุณุชุฃุฌุฑ'] || '',
        'ุฑูู ุงูุนูุฏ': record['ุฑูู ุงูุนูุฏ'] || '',
        'ูููุฉ  ุงูุงูุฌุงุฑ ': record['ูููุฉ  ุงูุงูุฌุงุฑ '] ? parseFloat(record['ูููุฉ  ุงูุงูุฌุงุฑ ']) : '',
        'ุงููุณุงุญุฉ': record['ุงููุณุงุญุฉ'] ? parseFloat(record['ุงููุณุงุญุฉ']) : '',
        'ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ': record['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ'] || record['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ'] || '',
        'ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ': record['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ'] || record['ุชุงุฑูุฎ ุงูููุงูุฉ'] || '',
        'ุนุฏุฏ ุงูุงูุณุงุท': record['ุนุฏุฏ ุงูุงูุณุงุท'] || record['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] ? parseInt(record['ุนุฏุฏ ุงูุงูุณุงุท'] || record['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']) : '',
        'ููุน ุงูุนูุฏ': record['ููุน ุงูุนูุฏ'] || '',
        'ุฑูู ุงูุณุฌู ุงูุนูุงุฑู': record['ุฑูู ุงูุณุฌู ุงูุนูุงุฑู'] || record['ุงูุณุฌู ุงูุนููู '] || '',
        'ูุณุงุญุฉ ุงูุตู': record['ูุณุงุญุฉ ุงูุตู'] || record['ูุณุงุญุฉุงูุตู'] ? parseFloat(record['ูุณุงุญุฉ ุงูุตู'] || record['ูุณุงุญุฉุงูุตู']) : '',
        'ุฑูู ุงูุตู': record['ุฑูู ุงูุตู'] || '',
        'ุงููุงูู': record['ุงููุงูู'] || '',
        'ูููุน ุงูุนูุงุฑ': record['ูููุน ุงูุนูุงุฑ'] || '',
        'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก': record['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] || '',
        'ุงูุงุฌูุงูู': record['ุงูุงุฌูุงูู'] ? parseFloat(record['ุงูุงุฌูุงูู']) : '',
        'ุงููุจูุบ ุงููุฏููุน': record['ุงููุจูุบ ุงููุฏููุน'] ? parseFloat(record['ุงููุจูุบ ุงููุฏููุน']) : 0,
        'ุงููุจูุบ ุงููุชุจูู': record['ุงููุจูุบ ุงููุชุจูู'] ? parseFloat(record['ุงููุจูุบ ุงููุชุจูู']) : 0,
        'ุญุงูุฉ ุงูุนูุฏ': record['ุญุงูุฉ ุงูุนูุฏ'] || 'ูุดุท',
        'ููุงุญุธุงุช': record['ููุงุญุธุงุช'] || '',
        'ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ': record['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || new Date().toISOString().split('T')[0]
    };
}

// Update import progress
function updateImportProgress(percentage, message) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }

    if (progressText) {
        progressText.textContent = message;
    }

    console.log(`๐ ${percentage}%: ${message}`);
}

// Add log message to import log
function addImportLog(message) {
    const logContainer = document.getElementById('importLog');
    if (logContainer) {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-time">${new Date().toLocaleTimeString('ar-SA')}</span>
            <span class="log-message">${message}</span>
        `;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

// Sync import with Supabase
async function syncImportWithSupabase(results) {
    console.log('โ๏ธ ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน Supabase...');

    try {
        // This would sync the imported data with Supabase
        // For now, we'll just log the attempt
        addImportLog(`โ๏ธ ูุญุงููุฉ ูุฒุงููุฉ ${results.processed} ุณุฌู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช...`);

        // Simulate sync delay
        await new Promise(resolve => setTimeout(resolve, 1000));

        addImportLog(`โ ุชู ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ`);

    } catch (error) {
        console.warn('โ๏ธ ุฎุทุฃ ูู ูุฒุงููุฉ Supabase:', error);
        addImportLog(`โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช`);
    }
}

// Show import results
function showImportResults(results) {
    showImportStep(4);

    const resultsContainer = document.getElementById('importResults');

    resultsContainer.innerHTML = `
        <div class="results-summary">
            <div class="result-item success">
                <i class="fas fa-check-circle"></i>
                <div class="result-details">
                    <div class="result-number">${results.processed}</div>
                    <div class="result-label">ุณุฌู ุชู ูุนุงูุฌุชู ุจูุฌุงุญ</div>
                </div>
            </div>

            <div class="result-item new">
                <i class="fas fa-plus-circle"></i>
                <div class="result-details">
                    <div class="result-number">${results.newProperties}</div>
                    <div class="result-label">ุนูุงุฑ ุฌุฏูุฏ</div>
                </div>
            </div>

            <div class="result-item new">
                <i class="fas fa-home"></i>
                <div class="result-details">
                    <div class="result-number">${results.newUnits}</div>
                    <div class="result-label">ูุญุฏุฉ ุฌุฏูุฏุฉ</div>
                </div>
            </div>

            <div class="result-item update">
                <i class="fas fa-edit"></i>
                <div class="result-details">
                    <div class="result-number">${results.updatedUnits}</div>
                    <div class="result-label">ูุญุฏุฉ ูุญุฏุซุฉ</div>
                </div>
            </div>

            ${results.skipped > 0 ? `
                <div class="result-item warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="result-details">
                        <div class="result-number">${results.skipped}</div>
                        <div class="result-label">ุณุฌู ุชู ุชุฎุทูู</div>
                    </div>
                </div>
            ` : ''}

            ${results.errors.length > 0 ? `
                <div class="result-item error">
                    <i class="fas fa-times-circle"></i>
                    <div class="result-details">
                        <div class="result-number">${results.errors.length}</div>
                        <div class="result-label">ุฎุทุฃ</div>
                    </div>
                </div>
            ` : ''}
        </div>

        ${results.errors.length > 0 ? `
            <div class="error-details">
                <h4>ุชูุงุตูู ุงูุฃุฎุทุงุก:</h4>
                <ul>
                    ${results.errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            </div>
        ` : ''}

        <div class="import-actions">
            <button class="action-btn" onclick="refreshDataDisplay()">
                <i class="fas fa-sync"></i> ุชุญุฏูุซ ุงูุนุฑุถ
            </button>
            <button class="action-btn" onclick="exportImportLog()">
                <i class="fas fa-download"></i> ุชุตุฏูุฑ ุณุฌู ุงูุนูููุงุช
            </button>
        </div>
    `;
}

// Utility functions
function changeImportFile() {
    document.getElementById('fileUploadArea').style.display = 'block';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';
    importedData = null;
}

function closeImportModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

function finishImport() {
    // Refresh the main data display
    refreshDataDisplay();
    closeImportModal();
}

function refreshDataDisplay() {
    // Refresh the main interface
    if (typeof renderData === 'function') {
        renderData();
    }
    if (typeof updateTotalStats === 'function') {
        updateTotalStats();
    }
    if (typeof searchUnits === 'function' && isManagementMode) {
        searchUnits();
    }
}

function showImportError(message) {
    alert('ุฎุทุฃ ูู ุงูุงุณุชูุฑุงุฏ: ' + message);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function exportImportLog() {
    const logEntries = document.querySelectorAll('.log-entry');
    let logText = 'ุณุฌู ุนูููุงุช ุงูุงุณุชูุฑุงุฏ\n';
    logText += '===================\n\n';

    logEntries.forEach(entry => {
        const time = entry.querySelector('.log-time').textContent;
        const message = entry.querySelector('.log-message').textContent;
        logText += `${time}: ${message}\n`;
    });

    const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `import_log_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// Show storage cleanup modal
function showStorageCleanupModal() {
    console.log('๐งน ูุชุญ ูุงูุฐุฉ ุชูุธูู ุงูุชุฎุฒูู...');

    const storageInfo = getStorageInfo();

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="storage-cleanup-modal">
            <div class="cleanup-modal-header">
                <h2><i class="fas fa-broom"></i> ุชูุธูู ูุณุงุญุฉ ุงูุชุฎุฒูู</h2>
                <p>ุฅุฏุงุฑุฉ ูุชูุธูู ุจูุงูุงุช ุงูุชุฎุฒูู ุงููุญูู</p>
            </div>

            <div class="cleanup-modal-content">
                <div class="storage-info-section">
                    <h3>ูุนูููุงุช ุงูุชุฎุฒูู ุงูุญุงููุฉ</h3>
                    <div class="storage-stats">
                        <div class="storage-stat">
                            <div class="stat-icon"><i class="fas fa-database"></i></div>
                            <div class="stat-details">
                                <div class="stat-value">${storageInfo.usedMB} ููุฌุงุจุงูุช</div>
                                <div class="stat-label">ุงููุณุงุญุฉ ุงููุณุชุฎุฏูุฉ</div>
                            </div>
                        </div>
                        <div class="storage-stat">
                            <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                            <div class="stat-details">
                                <div class="stat-value">${storageInfo.usagePercentage}%</div>
                                <div class="stat-label">ูุณุจุฉ ุงูุงุณุชุฎุฏุงู</div>
                            </div>
                        </div>
                        <div class="storage-stat">
                            <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="stat-details">
                                <div class="stat-value">${storageInfo.itemCount}</div>
                                <div class="stat-label">ุนุฏุฏ ุงูุนูุงุตุฑ</div>
                            </div>
                        </div>
                    </div>

                    <div class="storage-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${storageInfo.usagePercentage}%"></div>
                        </div>
                        <div class="progress-text">ุงุณุชุฎุฏุงู ุงูุชุฎุฒูู: ${storageInfo.usagePercentage}%</div>
                    </div>
                </div>

                <div class="cleanup-options-section">
                    <h3>ุฎูุงุฑุงุช ุงูุชูุธูู</h3>
                    <div class="cleanup-options">
                        <div class="cleanup-option">
                            <div class="option-info">
                                <h4><i class="fas fa-archive"></i> ุชูุธูู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงููุฏููุฉ</h4>
                                <p>ุญุฐู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงููุฏููุฉ ูุงูุงุญุชูุงุธ ุจุฃุญุฏุซ 2 ูุณุฎุฉ ููุท</p>
                            </div>
                            <button class="cleanup-btn" onclick="cleanupBackups()">
                                <i class="fas fa-trash-alt"></i> ุชูุธูู
                            </button>
                        </div>

                        <div class="cleanup-option">
                            <div class="option-info">
                                <h4><i class="fas fa-history"></i> ูุณุญ ุณุฌู ุงูุชุญุฏูุซุงุช</h4>
                                <p>ุญุฐู ุณุฌู ุงูุนูููุงุช ูุงูุชุญุฏูุซุงุช ุงููุฏููุฉ</p>
                            </div>
                            <button class="cleanup-btn" onclick="clearUpdateLog()">
                                <i class="fas fa-eraser"></i> ูุณุญ
                            </button>
                        </div>

                        <div class="cleanup-option">
                            <div class="option-info">
                                <h4><i class="fas fa-temp-high"></i> ุญุฐู ุงูุจูุงูุงุช ุงููุคูุชุฉ</h4>
                                <p>ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุคูุชุฉ ูุงูุฐุงูุฑุฉ ุงูุชุฎุฒูููุฉ</p>
                            </div>
                            <button class="cleanup-btn" onclick="clearTempData()">
                                <i class="fas fa-broom"></i> ุญุฐู
                            </button>
                        </div>

                        <div class="cleanup-option danger">
                            <div class="option-info">
                                <h4><i class="fas fa-exclamation-triangle"></i> ุชูุธูู ุดุงูู</h4>
                                <p>ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุบูุฑ ุงูุฃุณุงุณูุฉ (ุงุญุชูุธ ุจุงูุนูุงุฑุงุช ูุงููุฑููุงุช ููุท)</p>
                            </div>
                            <button class="cleanup-btn danger" onclick="performFullCleanup()">
                                <i class="fas fa-fire"></i> ุชูุธูู ุดุงูู
                            </button>
                        </div>
                    </div>
                </div>

                <div class="cleanup-results" id="cleanupResults" style="display: none;">
                    <h3>ูุชุงุฆุฌ ุงูุชูุธูู</h3>
                    <div id="cleanupResultsContent"></div>
                </div>
            </div>

            <div class="cleanup-modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeCleanupModal()">
                    <i class="fas fa-times"></i> ุฅุบูุงู
                </button>
                <button class="modal-action-btn refresh-btn" onclick="refreshStorageInfo()">
                    <i class="fas fa-sync"></i> ุชุญุฏูุซ ุงููุนูููุงุช
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

// Cleanup functions
async function cleanupBackups() {
    console.log('๐งน ุชูุธูู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ...');

    try {
        const allKeys = Object.keys(localStorage);
        const backupKeys = allKeys.filter(key => key.startsWith('backup_')).sort();

        if (backupKeys.length > 2) {
            const keysToRemove = backupKeys.slice(0, backupKeys.length - 2);
            keysToRemove.forEach(key => localStorage.removeItem(key));

            showCleanupResult(`โ ุชู ุญุฐู ${keysToRemove.length} ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุฏููุฉ`);
        } else {
            showCleanupResult('โน๏ธ ูุง ุชูุฌุฏ ูุณุฎ ุงุญุชูุงุทูุฉ ูุฏููุฉ ููุญุฐู');
        }

        refreshStorageInfo();

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชูุธูู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ:', error);
        showCleanupResult('โ ูุดู ูู ุชูุธูู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ');
    }
}

async function clearUpdateLog() {
    console.log('๐งน ูุณุญ ุณุฌู ุงูุชุญุฏูุซุงุช...');

    try {
        localStorage.removeItem('updateLog');
        showCleanupResult('โ ุชู ูุณุญ ุณุฌู ุงูุชุญุฏูุซุงุช');
        refreshStorageInfo();

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุณุญ ุณุฌู ุงูุชุญุฏูุซุงุช:', error);
        showCleanupResult('โ ูุดู ูู ูุณุญ ุณุฌู ุงูุชุญุฏูุซุงุช');
    }
}

async function clearTempData() {
    console.log('๐งน ุญุฐู ุงูุจูุงูุงุช ุงููุคูุชุฉ...');

    try {
        const allKeys = Object.keys(localStorage);
        const tempKeys = allKeys.filter(key =>
            key.startsWith('temp_') ||
            key.startsWith('cache_') ||
            key.includes('_temp') ||
            key.includes('_cache')
        );

        tempKeys.forEach(key => localStorage.removeItem(key));

        showCleanupResult(`โ ุชู ุญุฐู ${tempKeys.length} ุนูุตุฑ ูุคูุช`);
        refreshStorageInfo();

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงูุจูุงูุงุช ุงููุคูุชุฉ:', error);
        showCleanupResult('โ ูุดู ูู ุญุฐู ุงูุจูุงูุงุช ุงููุคูุชุฉ');
    }
}

async function performFullCleanup() {
    const confirmed = confirm('โ๏ธ ุชุญุฐูุฑ: ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุบูุฑ ุงูุฃุณุงุณูุฉ. ูู ุฃูุช ูุชุฃูุฏุ');

    if (!confirmed) return;

    console.log('๐งน ุชูุธูู ุดุงูู...');

    try {
        await forceCleanupStorage();
        showCleanupResult('โ ุชู ุงูุชูุธูู ุงูุดุงูู ุจูุฌุงุญ');
        refreshStorageInfo();

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชูุธูู ุงูุดุงูู:', error);
        showCleanupResult('โ ูุดู ูู ุงูุชูุธูู ุงูุดุงูู');
    }
}

function showCleanupResult(message) {
    const resultsSection = document.getElementById('cleanupResults');
    const resultsContent = document.getElementById('cleanupResultsContent');

    if (resultsSection && resultsContent) {
        resultsContent.innerHTML = `<div class="cleanup-message">${message}</div>`;
        resultsSection.style.display = 'block';

        // Auto-hide after 3 seconds
        setTimeout(() => {
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
        }, 3000);
    }
}

function refreshStorageInfo() {
    // Close and reopen the modal with updated info
    closeCleanupModal();
    setTimeout(() => {
        showStorageCleanupModal();
    }, 100);
}

function closeCleanupModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// Show date update modal
function showDateUpdateModal() {
    console.log('๐ ูุชุญ ูุงูุฐุฉ ุชุญุฏูุซ ุงูุชูุงุฑูุฎ...');

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="date-update-modal">
            <div class="date-update-header">
                <h2><i class="fas fa-calendar-alt"></i> ุชุญุฏูุซ ุงูุชูุงุฑูุฎ ูู ููู</h2>
                <p>ุชุญุฏูุซ ุชูุงุฑูุฎ ุงูุนููุฏ ูุงูุฃูุณุงุท ูู ููู JSON</p>
            </div>

            <div class="date-update-content">
                <div class="upload-section">
                    <h3>ุงุฎุชูุงุฑ ููู ุงูุชุญุฏูุซ</h3>
                    <div class="file-upload-area" id="dateFileUploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-calendar-upload"></i>
                        </div>
                        <div class="upload-text">
                            <p>ุงุณุญุจ ูุฃููุช ููู JSON ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
                            <small>ูุฌุจ ุฃู ูุญุชูู ุงูููู ุนูู: ุฑูู ุงููุญุฏุฉุ ุงูุชูุงุฑูุฎ ุงูุฌุฏูุฏุฉ</small>
                        </div>
                    </div>
                    <input type="file" id="dateFileInput" accept=".json" style="display: none;">

                    <div class="file-info" id="dateFileInfo" style="display: none;">
                        <div class="file-details">
                            <i class="fas fa-file-code"></i>
                            <div>
                                <div class="file-name" id="dateFileName"></div>
                                <div class="file-size" id="dateFileSize"></div>
                            </div>
                        </div>
                        <button class="change-file-btn" onclick="changeDateFile()">ุชุบููุฑ ุงูููู</button>
                    </div>
                </div>

                <div class="preview-section" id="datePreviewSection" style="display: none;">
                    <h3>ูุนุงููุฉ ุงูุชุญุฏูุซุงุช</h3>
                    <div class="preview-stats" id="datePreviewStats"></div>
                    <div class="preview-table-container">
                        <table class="preview-table" id="datePreviewTable"></table>
                    </div>
                </div>

                <div class="update-options" id="dateUpdateOptions" style="display: none;">
                    <h3>ุฎูุงุฑุงุช ุงูุชุญุฏูุซ</h3>
                    <div class="options-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" id="updateContractDates" checked>
                            <span class="checkmark"></span>
                            ุชุญุฏูุซ ุชูุงุฑูุฎ ุงูุนููุฏ (ุจุฏุงูุฉ ูููุงูุฉ)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="updateInstallmentDates" checked>
                            <span class="checkmark"></span>
                            ุชุญุฏูุซ ุชูุงุฑูุฎ ุงูุฃูุณุงุท
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="createDateBackup" checked>
                            <span class="checkmark"></span>
                            ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุงูุชุญุฏูุซ
                        </label>
                    </div>
                </div>

                <div class="update-progress" id="dateUpdateProgress" style="display: none;">
                    <h3>ุชูุฏู ุงูุชุญุฏูุซ</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="dateProgressFill"></div>
                    </div>
                    <div class="progress-text" id="dateProgressText">ุฌุงุฑู ุงูุชุญุถูุฑ...</div>
                    <div class="update-log" id="dateUpdateLog"></div>
                </div>

                <div class="update-results" id="dateUpdateResults" style="display: none;">
                    <h3>ูุชุงุฆุฌ ุงูุชุญุฏูุซ</h3>
                    <div id="dateUpdateResultsContent"></div>
                </div>
            </div>

            <div class="date-update-actions">
                <button class="modal-action-btn close-btn" onclick="closeDateUpdateModal()">
                    <i class="fas fa-times"></i> ุฅุบูุงู
                </button>
                <button class="modal-action-btn next-btn" id="dateNextBtn" onclick="previewDateUpdates()" style="display: none;">
                    <i class="fas fa-eye"></i> ูุนุงููุฉ
                </button>
                <button class="modal-action-btn update-btn" id="dateUpdateBtn" onclick="executeDateUpdate()" style="display: none;">
                    <i class="fas fa-calendar-check"></i> ุชุญุฏูุซ ุงูุชูุงุฑูุฎ
                </button>
                <button class="modal-action-btn finish-btn" id="dateFinishBtn" onclick="finishDateUpdate()" style="display: none;">
                    <i class="fas fa-check"></i> ุฅููุงุก
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setupDateFileUpload();
}

// Alias for mobile menu compatibility
function openDateUpdateModal() {
    showDateUpdateModal();
}

// Setup date file upload functionality
function setupDateFileUpload() {
    const fileUploadArea = document.getElementById('dateFileUploadArea');
    const fileInput = document.getElementById('dateFileInput');

    // Click to upload
    fileUploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleDateFileSelection(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleDateFileSelection(e.target.files[0]);
        }
    });
}

// Handle date file selection
async function handleDateFileSelection(file) {
    console.log('๐ ุชู ุงุฎุชูุงุฑ ููู ุงูุชูุงุฑูุฎ:', file.name);

    // Validate file type
    if (!file.name.toLowerCase().endsWith('.json')) {
        showDateUpdateError('ูุฌุจ ุฃู ูููู ุงูููู ูู ููุน JSON ููุท');
        return;
    }

    // Show file info
    document.getElementById('dateFileName').textContent = file.name;
    document.getElementById('dateFileSize').textContent = formatFileSize(file.size);
    document.getElementById('dateFileUploadArea').style.display = 'none';
    document.getElementById('dateFileInfo').style.display = 'flex';
    document.getElementById('dateNextBtn').style.display = 'inline-flex';

    // Parse file
    try {
        dateUpdateData = await parseDateUpdateFile(file);
        console.log('โ ุชู ุชุญููู ููู ุงูุชูุงุฑูุฎ ุจูุฌุงุญ:', dateUpdateData.length, 'ุณุฌู');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ููู ุงูุชูุงุฑูุฎ:', error);
        showDateUpdateError('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: ' + error.message);
    }
}

// Parse date update file
async function parseDateUpdateFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                    resolve(data);
                } else {
                    reject(new Error('ููู JSON ูุฌุจ ุฃู ูุญุชูู ุนูู ูุตูููุฉ ูู ุงูุจูุงูุงุช'));
                }
            } catch (error) {
                reject(new Error('ุฎุทุฃ ูู ุชุญููู ููู JSON: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู'));
        reader.readAsText(file);
    });
}

// Preview date updates
function previewDateUpdates() {
    console.log('๐ ุฅูุดุงุก ูุนุงููุฉ ุชุญุฏูุซุงุช ุงูุชูุงุฑูุฎ...');

    if (!dateUpdateData || dateUpdateData.length === 0) {
        showDateUpdateError('ูุง ุชูุฌุฏ ุจูุงูุงุช ูููุนุงููุฉ');
        return;
    }

    // Analyze date updates
    const analysis = analyzeDateUpdates();
    displayDatePreviewStats(analysis);
    displayDatePreviewTable(analysis);

    // Show preview and options
    document.getElementById('datePreviewSection').style.display = 'block';
    document.getElementById('dateUpdateOptions').style.display = 'block';
    document.getElementById('dateNextBtn').style.display = 'none';
    document.getElementById('dateUpdateBtn').style.display = 'inline-flex';
}

// Analyze date updates
function analyzeDateUpdates() {
    console.log('๐ ุชุญููู ุชุญุฏูุซุงุช ุงูุชูุงุฑูุฎ...');

    const analysis = {
        totalRecords: dateUpdateData.length,
        validUpdates: 0,
        contractDateUpdates: 0,
        installmentDateUpdates: 0,
        notFound: 0,
        errors: [],
        updates: []
    };

    dateUpdateData.forEach((record, index) => {
        try {
            const updateInfo = analyzeRecordDateUpdate(record, index);
            analysis.updates.push(updateInfo);

            if (updateInfo.found) {
                analysis.validUpdates++;
                if (updateInfo.hasContractDates) analysis.contractDateUpdates++;
                if (updateInfo.hasInstallmentDates) analysis.installmentDateUpdates++;
            } else {
                analysis.notFound++;
            }

            if (updateInfo.errors.length > 0) {
                analysis.errors.push(...updateInfo.errors);
            }

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุชุญููู ุงูุณุฌู ${index}:`, error);
            analysis.errors.push(`ุงูุณุฌู ${index + 1}: ${error.message}`);
        }
    });

    console.log('๐ ูุชุงุฆุฌ ุชุญููู ุงูุชูุงุฑูุฎ:', analysis);
    return analysis;
}

// Analyze individual record for date update
function analyzeRecordDateUpdate(record, index) {
    const updateInfo = {
        index: index,
        record: record,
        found: false,
        existingUnit: null,
        hasContractDates: false,
        hasInstallmentDates: false,
        errors: [],
        warnings: []
    };

    // Validate required field
    if (!record['ุฑูู  ุงููุญุฏุฉ ']) {
        updateInfo.errors.push('ุฑูู ุงููุญุฏุฉ ูุทููุจ');
        return updateInfo;
    }

    // Find existing unit
    const unitNumber = record['ุฑูู  ุงููุญุฏุฉ '].toString().trim();
    updateInfo.existingUnit = properties.find(p => p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber);

    if (updateInfo.existingUnit) {
        updateInfo.found = true;

        // Check for contract dates
        if (record['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ'] || record['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ']) {
            updateInfo.hasContractDates = true;
        }

        // Check for installment dates
        for (let i = 1; i <= 10; i++) {
            const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                           i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                           `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;

            if (record[dateKey]) {
                updateInfo.hasInstallmentDates = true;
                break;
            }
        }

        // Validate date formats
        validateDateFormats(record, updateInfo);

    } else {
        updateInfo.errors.push(`ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุฑูู: ${unitNumber}`);
    }

    return updateInfo;
}

// Validate date formats in record
function validateDateFormats(record, updateInfo) {
    const dateFields = [
        'ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ', 'ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ',
        'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู', 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู'
    ];

    // Add more installment date fields
    for (let i = 3; i <= 10; i++) {
        dateFields.push(`ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`);
    }

    dateFields.forEach(field => {
        if (record[field]) {
            const dateStr = record[field].toString();
            const date = new Date(dateStr);

            if (isNaN(date.getTime())) {
                updateInfo.warnings.push(`ุชูุณูู ุงูุชุงุฑูุฎ ุบูุฑ ุตุญูุญ ูู "${field}": ${dateStr}`);
            }
        }
    });
}

// Display date preview statistics
function displayDatePreviewStats(analysis) {
    const statsContainer = document.getElementById('datePreviewStats');

    statsContainer.innerHTML = `
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">${analysis.totalRecords}</div>
                <div class="stat-label">ุฅุฌูุงูู ุงูุณุฌูุงุช</div>
            </div>
            <div class="stat-item success">
                <div class="stat-number">${analysis.validUpdates}</div>
                <div class="stat-label">ุชุญุฏูุซุงุช ุตุงูุญุฉ</div>
            </div>
            <div class="stat-item info">
                <div class="stat-number">${analysis.contractDateUpdates}</div>
                <div class="stat-label">ุชูุงุฑูุฎ ุนููุฏ</div>
            </div>
            <div class="stat-item warning">
                <div class="stat-number">${analysis.installmentDateUpdates}</div>
                <div class="stat-label">ุชูุงุฑูุฎ ุฃูุณุงุท</div>
            </div>
            <div class="stat-item error">
                <div class="stat-number">${analysis.notFound}</div>
                <div class="stat-label">ุบูุฑ ููุฌูุฏ</div>
            </div>
            <div class="stat-item error">
                <div class="stat-number">${analysis.errors.length}</div>
                <div class="stat-label">ุฃุฎุทุงุก</div>
            </div>
        </div>

        ${analysis.errors.length > 0 ? `
            <div class="errors-section">
                <h4><i class="fas fa-exclamation-triangle"></i> ุงูุฃุฎุทุงุก ุงูููุชุดูุฉ:</h4>
                <ul class="error-list">
                    ${analysis.errors.slice(0, 5).map(error => `<li>${error}</li>`).join('')}
                    ${analysis.errors.length > 5 ? `<li>... ู ${analysis.errors.length - 5} ุฎุทุฃ ุขุฎุฑ</li>` : ''}
                </ul>
            </div>
        ` : ''}
    `;
}

// Display date preview table
function displayDatePreviewTable(analysis) {
    const tableContainer = document.getElementById('datePreviewTable');

    // Show only first 10 records for preview
    const previewUpdates = analysis.updates.slice(0, 10);

    let tableHTML = `
        <thead>
            <tr>
                <th>ุฑูู ุงููุญุฏุฉ</th>
                <th>ุงูุนูุงุฑ</th>
                <th>ุชูุงุฑูุฎ ุงูุนูุฏ</th>
                <th>ุชูุงุฑูุฎ ุงูุฃูุณุงุท</th>
                <th>ุงูุญุงูุฉ</th>
            </tr>
        </thead>
        <tbody>
    `;

    previewUpdates.forEach(update => {
        const statusClass = update.found ? 'success' : 'error';
        const statusText = update.found ? 'ููุฌูุฏ' : 'ุบูุฑ ููุฌูุฏ';

        const contractDates = update.hasContractDates ?
            `<i class="fas fa-check text-success"></i> ุณูุชู ุงูุชุญุฏูุซ` :
            `<i class="fas fa-minus text-muted"></i> ูุง ููุฌุฏ`;

        const installmentDates = update.hasInstallmentDates ?
            `<i class="fas fa-check text-success"></i> ุณูุชู ุงูุชุญุฏูุซ` :
            `<i class="fas fa-minus text-muted"></i> ูุง ููุฌุฏ`;

        tableHTML += `
            <tr class="${statusClass}">
                <td>${update.record['ุฑูู  ุงููุญุฏุฉ '] || 'ุบูุฑ ูุญุฏุฏ'}</td>
                <td>${update.existingUnit ? update.existingUnit['ุงุณู ุงูุนูุงุฑ'] : 'ุบูุฑ ููุฌูุฏ'}</td>
                <td>${contractDates}</td>
                <td>${installmentDates}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            </tr>
        `;
    });

    tableHTML += '</tbody>';

    if (analysis.updates.length > 10) {
        tableHTML += `
            <tfoot>
                <tr>
                    <td colspan="5" class="text-center">
                        <small>ุนุฑุถ ุฃูู 10 ุณุฌูุงุช ูู ${analysis.updates.length} ุณุฌู</small>
                    </td>
                </tr>
            </tfoot>
        `;
    }

    tableContainer.innerHTML = tableHTML;
}

// Execute date update
async function executeDateUpdate() {
    console.log('๐ ุจุฏุก ุชูููุฐ ุชุญุฏูุซ ุงูุชูุงุฑูุฎ...');

    // Get options
    const updateContractDates = document.getElementById('updateContractDates').checked;
    const updateInstallmentDates = document.getElementById('updateInstallmentDates').checked;
    const createBackup = document.getElementById('createDateBackup').checked;

    console.log('โ๏ธ ุฎูุงุฑุงุช ุงูุชุญุฏูุซ:', { updateContractDates, updateInstallmentDates, createBackup });

    // Hide options and show progress
    document.getElementById('dateUpdateOptions').style.display = 'none';
    document.getElementById('dateUpdateBtn').style.display = 'none';
    document.getElementById('dateUpdateProgress').style.display = 'block';

    try {
        // Create backup if requested
        if (createBackup) {
            updateDateProgress(10, 'ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ...');
            await createDateBackup();
            addDateUpdateLog('โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ');
        }

        // Process updates
        updateDateProgress(20, 'ุจุฏุก ูุนุงูุฌุฉ ุงูุชุญุฏูุซุงุช...');
        const results = await processDateUpdates(updateContractDates, updateInstallmentDates);

        // Save data
        updateDateProgress(90, 'ุญูุธ ุงูุจูุงูุงุช...');
        saveDataLocally();

        // Show results
        updateDateProgress(100, 'ุชู ุงูุงูุชูุงุก!');
        displayDateUpdateResults(results);

        document.getElementById('dateUpdateProgress').style.display = 'none';
        document.getElementById('dateUpdateResults').style.display = 'block';
        document.getElementById('dateFinishBtn').style.display = 'inline-flex';

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุชูุงุฑูุฎ:', error);
        showDateUpdateError('ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุชูุงุฑูุฎ: ' + error.message);
    }
}

// Process date updates
async function processDateUpdates(updateContractDates, updateInstallmentDates) {
    const results = {
        processed: 0,
        contractDatesUpdated: 0,
        installmentDatesUpdated: 0,
        errors: 0,
        skipped: 0
    };

    const analysis = analyzeDateUpdates();
    const validUpdates = analysis.updates.filter(u => u.found);

    for (let i = 0; i < validUpdates.length; i++) {
        const update = validUpdates[i];
        const progress = 20 + (i / validUpdates.length) * 70;

        updateDateProgress(progress, `ูุนุงูุฌุฉ ุงููุญุฏุฉ ${update.record['ุฑูู  ุงููุญุฏุฉ ']}...`);

        try {
            const unitIndex = properties.findIndex(p => p['ุฑูู  ุงููุญุฏุฉ '] === update.record['ุฑูู  ุงููุญุฏุฉ ']);

            if (unitIndex !== -1) {
                let updated = false;

                // Update contract dates
                if (updateContractDates && update.hasContractDates) {
                    if (update.record['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ']) {
                        properties[unitIndex]['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ'] = formatDateForStorage(update.record['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ']);
                        updated = true;
                    }
                    if (update.record['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ']) {
                        properties[unitIndex]['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ'] = formatDateForStorage(update.record['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ']);
                        updated = true;
                    }
                    if (updated) results.contractDatesUpdated++;
                }

                // Update installment dates
                if (updateInstallmentDates && update.hasInstallmentDates) {
                    let installmentUpdated = false;

                    for (let j = 1; j <= 10; j++) {
                        const dateKey = j === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                                       j === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(j)}`;

                        if (update.record[dateKey]) {
                            properties[unitIndex][dateKey] = formatDateForStorage(update.record[dateKey]);
                            installmentUpdated = true;
                        }
                    }

                    if (installmentUpdated) {
                        results.installmentDatesUpdated++;
                        updated = true;
                    }
                }

                if (updated) {
                    results.processed++;
                    addDateUpdateLog(`โ ุชู ุชุญุฏูุซ ุงููุญุฏุฉ: ${update.record['ุฑูู  ุงููุญุฏุฉ ']}`);
                } else {
                    results.skipped++;
                    addDateUpdateLog(`โญ๏ธ ุชู ุชุฎุทู ุงููุญุฏุฉ: ${update.record['ุฑูู  ุงููุญุฏุฉ ']} (ูุง ุชูุฌุฏ ุชุญุฏูุซุงุช ูุทููุจุฉ)`);
                }
            }

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงููุญุฏุฉ ${update.record['ุฑูู  ุงููุญุฏุฉ ']}:`, error);
            results.errors++;
            addDateUpdateLog(`โ ุฎุทุฃ ูู ุงููุญุฏุฉ ${update.record['ุฑูู  ุงููุญุฏุฉ ']}: ${error.message}`);
        }
    }

    return results;
}

// Helper functions for date update
function formatDateForStorage(dateStr) {
    try {
        if (!dateStr) return dateStr;

        // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุจุงูุชูุณูู ุงูุนุฑุจู DD/MM/YYYY
        if (typeof dateStr === 'string' && dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const year = parseInt(parts[2]);

                // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
                    // ุฅูุดุงุก ุงูุชุงุฑูุฎ ุจุชูุณูู ISO ุตุญูุญ
                    const isoDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    const testDate = new Date(isoDate);

                    // ุงูุชุฃูุฏ ูู ุฃู ุงูุชุงุฑูุฎ ุตุญูุญ
                    if (!isNaN(testDate.getTime())) {
                        return isoDate; // YYYY-MM-DD format
                    }
                }
            }
        }

        // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุจุชูุณูู YYYY-MM-DDุ ุชุญูู ูู ุตุญุชู ูุฃุฑุฌุนู
        if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
            const parts = dateStr.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);

            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                const testDate = new Date(year, month - 1, day, 12, 0, 0);
                if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                }
            }
        }

        console.warn('ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ:', dateStr);
        return dateStr; // Return original if invalid
    } catch (error) {
        console.warn('ุฎุทุฃ ูู ุชูุณูู ุงูุชุงุฑูุฎ:', dateStr, error);
        return dateStr;
    }
}

function updateDateProgress(percentage, message) {
    const progressFill = document.getElementById('dateProgressFill');
    const progressText = document.getElementById('dateProgressText');

    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }
    if (progressText) {
        progressText.textContent = message;
    }
}

function addDateUpdateLog(message) {
    const logContainer = document.getElementById('dateUpdateLog');
    if (logContainer) {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `<span class="log-time">${new Date().toLocaleTimeString('ar-SA')}</span> ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

async function createDateBackup() {
    const backupData = {
        timestamp: new Date().toISOString(),
        type: 'date_update_backup',
        data: JSON.parse(JSON.stringify(properties))
    };

    const backupKey = `backup_dates_${Date.now()}`;
    localStorage.setItem(backupKey, JSON.stringify(backupData));

    console.log('๐พ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ:', backupKey);
}

function displayDateUpdateResults(results) {
    const resultsContainer = document.getElementById('dateUpdateResultsContent');

    resultsContainer.innerHTML = `
        <div class="results-summary">
            <div class="result-stats">
                <div class="stat-item success">
                    <div class="stat-number">${results.processed}</div>
                    <div class="stat-label">ูุญุฏุงุช ูุญุฏุซุฉ</div>
                </div>
                <div class="stat-item info">
                    <div class="stat-number">${results.contractDatesUpdated}</div>
                    <div class="stat-label">ุชูุงุฑูุฎ ุนููุฏ</div>
                </div>
                <div class="stat-item warning">
                    <div class="stat-number">${results.installmentDatesUpdated}</div>
                    <div class="stat-label">ุชูุงุฑูุฎ ุฃูุณุงุท</div>
                </div>
                <div class="stat-item muted">
                    <div class="stat-number">${results.skipped}</div>
                    <div class="stat-label">ูุชุฎุทุงุฉ</div>
                </div>
                <div class="stat-item error">
                    <div class="stat-number">${results.errors}</div>
                    <div class="stat-label">ุฃุฎุทุงุก</div>
                </div>
            </div>

            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <h3>ุชู ุชุญุฏูุซ ุงูุชูุงุฑูุฎ ุจูุฌุงุญ!</h3>
                <p>ุชู ูุนุงูุฌุฉ ${results.processed} ูุญุฏุฉ ูุชุญุฏูุซ ุชูุงุฑูุฎูุง</p>
            </div>
        </div>
    `;
}

function changeDateFile() {
    document.getElementById('dateFileUploadArea').style.display = 'block';
    document.getElementById('dateFileInfo').style.display = 'none';
    document.getElementById('datePreviewSection').style.display = 'none';
    document.getElementById('dateUpdateOptions').style.display = 'none';
    document.getElementById('dateNextBtn').style.display = 'none';
    document.getElementById('dateUpdateBtn').style.display = 'none';

    // Reset file input
    document.getElementById('dateFileInput').value = '';
    dateUpdateData = null;
}

function showDateUpdateError(message) {
    const errorModal = document.createElement('div');
    errorModal.className = 'modal-overlay';
    errorModal.style.display = 'flex';
    errorModal.innerHTML = `
        <div class="error-modal">
            <div class="error-content">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุชูุงุฑูุฎ</h3>
                <p>${message}</p>
                <button class="btn-primary" onclick="this.closest('.modal-overlay').remove()">
                    ุญุณูุงู
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(errorModal);
}

function closeDateUpdateModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }

    // Reset global variables
    dateUpdateData = null;
}

function finishDateUpdate() {
    // Refresh the main interface
    renderData();
    updateTotalStats();

    // Close modal
    closeDateUpdateModal();

    // Show success notification
    showSuccessMessage('ุชู ุชุญุฏูุซ ุงูุชูุงุฑูุฎ ุจูุฌุงุญ', 'ุชู ุชุญุฏูุซ ุฌููุน ุงูุชูุงุฑูุฎ ุงููุญุฏุฏุฉ ูู ุงููุธุงู');
}

// Global variable to store date update data
let dateUpdateData = null;

// ==================== ูุธุงู ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช ====================

// ุชุญุฑูุฑ ูุญุฏุฉ ูู ูุธุงู ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช
function editUnit(unitNumber, propertyName) {
    console.log(`๐ง ุชุญุฑูุฑ ุงููุญุฏุฉ: ${unitNumber} ูู ุงูุนูุงุฑ: ${propertyName}`);

    // ุงูุจุญุซ ุนู ุงููุญุฏุฉ
    const unit = properties.find(p =>
        p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );

    if (!unit) {
        alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุทููุจุฉ');
        return;
    }

    // ุฅุธูุงุฑ ูุงูุฐุฉ ุชุญุฑูุฑ ุงููุญุฏุฉ
    showUnitEditModal(unit);
}

// ุฅุธูุงุฑ ูุงูุฐุฉ ุชุญุฑูุฑ ุงููุญุฏุฉ
function showUnitEditModal(unit) {
    const modalHTML = `
        <div class="modal-overlay" style="display:flex;">
            <div class="modal-box unit-edit-modal">
                <button class="close-modal" onclick="closeModal()">ร</button>

                <div class="edit-modal-header">
                    <h2><i class="fas fa-edit"></i> ุชุญุฑูุฑ ุงููุญุฏุฉ</h2>
                    <p>ุชุญุฑูุฑ ุจูุงูุงุช ุงููุญุฏุฉ: ${unit['ุฑูู  ุงููุญุฏุฉ ']}</p>
                </div>

                <div class="edit-modal-content">
                    <form id="unitEditForm" onsubmit="saveUnitEdit(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editUnitNumber">ุฑูู ุงููุญุฏุฉ <span class="required">*</span></label>
                                <input type="text" id="editUnitNumber" name="unitNumber"
                                       value="${unit['ุฑูู  ุงููุญุฏุฉ '] || ''}"
                                       required class="form-control"
                                       placeholder="ุฃุฏุฎู ุฑูู ุงููุญุฏุฉ ุงูุฌุฏูุฏ">
                                <small class="form-text">ุฑูู ุงููุญุฏุฉ ูุฌุจ ุฃู ูููู ูุฑูุฏุงู</small>
                            </div>

                            <div class="form-group">
                                <label for="editPropertyName">ุงุณู ุงูุนูุงุฑ</label>
                                <input type="text" id="editPropertyName" name="propertyName"
                                       value="${unit['ุงุณู ุงูุนูุงุฑ'] || ''}"
                                       readonly class="form-control"
                                       style="background-color: #f8f9fa;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTenantName">ุงุณู ุงููุณุชุฃุฌุฑ</label>
                                <input type="text" id="editTenantName" name="tenantName"
                                       value="${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''}"
                                       class="form-control"
                                       placeholder="ุงุณู ุงููุณุชุฃุฌุฑ">
                            </div>

                            <div class="form-group">
                                <label for="editContractNumber">ุฑูู ุงูุนูุฏ</label>
                                <input type="text" id="editContractNumber" name="contractNumber"
                                       value="${unit['ุฑูู ุงูุนูุฏ'] || ''}"
                                       class="form-control"
                                       placeholder="ุฑูู ุงูุนูุฏ">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editRentValue">ูููุฉ ุงูุฅูุฌุงุฑ</label>
                                <input type="number" id="editRentValue" name="rentValue"
                                       value="${unit['ูููุฉ  ุงูุงูุฌุงุฑ '] || ''}"
                                       class="form-control"
                                       placeholder="ูููุฉ ุงูุฅูุฌุงุฑ ุจุงูุฑูุงู">
                            </div>

                            <div class="form-group">
                                <label for="editArea">ุงููุณุงุญุฉ</label>
                                <input type="number" id="editArea" name="area"
                                       value="${unit['ุงููุณุงุญุฉ'] || ''}"
                                       class="form-control"
                                       placeholder="ุงููุณุงุญุฉ ุจุงููุชุฑ ุงููุฑุจุน">
                            </div>
                        </div>

                        <input type="hidden" id="originalUnitNumber" value="${unit['ุฑูู  ุงููุญุฏุฉ '] || ''}">
                        <input type="hidden" id="originalPropertyName" value="${unit['ุงุณู ุงูุนูุงุฑ'] || ''}">

                        <div class="modal-actions">
                            <button type="button" class="modal-action-btn close-btn" onclick="closeModal()">
                                <i class="fas fa-times"></i> ุฅูุบุงุก
                            </button>
                            <button type="submit" class="modal-action-btn save-btn">
                                <i class="fas fa-save"></i> ุญูุธ ุงูุชุบููุฑุงุช
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // ุชุฑููุฒ ุนูู ุญูู ุฑูู ุงููุญุฏุฉ
    setTimeout(() => {
        document.getElementById('editUnitNumber').focus();
    }, 100);
}

// ุญูุธ ุชุนุฏูู ุงููุญุฏุฉ
async function saveUnitEdit(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);

    // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช
    const newUnitNumber = formData.get('unitNumber').trim();
    const originalUnitNumber = document.getElementById('originalUnitNumber').value;
    const originalPropertyName = document.getElementById('originalPropertyName').value;
    const tenantName = formData.get('tenantName').trim();
    const contractNumber = formData.get('contractNumber').trim();
    const rentValue = formData.get('rentValue');
    const area = formData.get('area');

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
    if (!newUnitNumber) {
        alert('โ ุฑูู ุงููุญุฏุฉ ูุทููุจ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุฑูู ุงููุญุฏุฉ (ุฅุฐุง ุชู ุชุบููุฑู)
    if (newUnitNumber !== originalUnitNumber) {
        const existingUnit = properties.find(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );

        if (existingUnit) {
            alert(`โ ุฑูู ุงููุญุฏุฉ "${newUnitNumber}" ููุฌูุฏ ุจุงููุนู ูู ูุฐุง ุงูุนูุงุฑ`);
            return;
        }
    }

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        const saveBtn = form.querySelector('.save-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุญูุธ...';
        saveBtn.disabled = true;

        // ุงูุจุญุซ ุนู ุงููุญุฏุฉ ูุชุญุฏูุซูุง
        const unitIndex = properties.findIndex(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === originalUnitNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );

        if (unitIndex === -1) {
            throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุทููุจ ุชุญุฏูุซูุง');
        }

        console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ูู ุงูููุฑุณ: ${unitIndex}`);
        console.log(`๐ ุงูุจูุงูุงุช ุงูุฃุตููุฉ:`, JSON.stringify(properties[unitIndex], null, 2));
        console.log(`๐ ุฅุฌูุงูู ุงููุญุฏุงุช ูุจู ุงูุชุญุฏูุซ: ${properties.length}`);

        // ุญูุธ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ููููุงุฑูุฉ
        const originalData = { ...properties[unitIndex] };

        // ุชุญุฏูุซ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ูู ููุณ ุงููุงุฆู (ุจุฏูุงู ูู ุฅูุดุงุก ูุณุฎุฉ ุฌุฏูุฏุฉ)
        console.log(`๐ ุจุฏุก ุชุญุฏูุซ ุงูุจูุงูุงุช...`);
        properties[unitIndex]['ุฑูู  ุงููุญุฏุฉ '] = newUnitNumber;
        properties[unitIndex]['ุงุณู ุงููุณุชุฃุฌุฑ'] = tenantName || properties[unitIndex]['ุงุณู ุงููุณุชุฃุฌุฑ'];
        properties[unitIndex]['ุฑูู ุงูุนูุฏ'] = contractNumber || properties[unitIndex]['ุฑูู ุงูุนูุฏ'];
        properties[unitIndex]['ูููุฉ  ุงูุงูุฌุงุฑ '] = rentValue ? parseFloat(rentValue) : properties[unitIndex]['ูููุฉ  ุงูุงูุฌุงุฑ '];
        properties[unitIndex]['ุงููุณุงุญุฉ'] = area ? parseFloat(area) : properties[unitIndex]['ุงููุณุงุญุฉ'];

        console.log(`โ ุงูุจูุงูุงุช ุจุนุฏ ุงูุชุญุฏูุซ:`, JSON.stringify(properties[unitIndex], null, 2));
        console.log(`๐ ุฑูู ุงููุญุฏุฉ ุชุบูุฑ ูู "${originalUnitNumber}" ุฅูู "${newUnitNumber}"`);
        console.log(`๐ ุฅุฌูุงูู ุงููุญุฏุงุช ุจุนุฏ ุงูุชุญุฏูุซ: ${properties.length}`);

        // ุงูุชุญูู ูู ุฃู ุงูุชุญุฏูุซ ุชู ูุนูุงู
        if (properties[unitIndex]['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber) {
            console.log(`โ ุชุฃููุฏ: ุชู ุชุญุฏูุซ ุฑูู ุงููุญุฏุฉ ุจูุฌุงุญ ูู ุงููุตูููุฉ`);
        } else {
            console.error(`โ ุฎุทุฃ: ูุดู ูู ุชุญุฏูุซ ุฑูู ุงููุญุฏุฉ ูู ุงููุตูููุฉ`);
            throw new Error('ูุดู ูู ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุงููุตูููุฉ ุงููุญููุฉ');
        }

        // ุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ูุณุฎ ููุฑุฑุฉ
        const duplicateCheck = properties.filter(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );

        if (duplicateCheck.length > 1) {
            console.warn(`โ๏ธ ุชู ุงูุชุดุงู ${duplicateCheck.length} ูุณุฎุฉ ูู ุงููุญุฏุฉ ${newUnitNumber}`);
            // ุฅุฒุงูุฉ ุงููุณุฎ ุงูููุฑุฑุฉ ูุงูุงุญุชูุงุธ ุจุงูุฃููู ููุท
            const firstIndex = properties.findIndex(p =>
                p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
                p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
            );

            // ุฅุฒุงูุฉ ุงููุณุฎ ุงูููุฑุฑุฉ
            for (let i = properties.length - 1; i >= 0; i--) {
                if (i !== firstIndex &&
                    properties[i]['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
                    properties[i]['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName) {
                    properties.splice(i, 1);
                    console.log(`๐๏ธ ุชู ุญุฐู ูุณุฎุฉ ููุฑุฑุฉ ูู ุงูููุฑุณ ${i}`);
                }
            }
        }

        // ุญูุธ ูู localStorage ูุน ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงููุณุงุญุฉ
        console.log(`๐พ ุจุฏุก ุญูุธ ุงูุจูุงูุงุช ูู localStorage...`);
        console.log(`๐ ุนุฏุฏ ุงููุญุฏุงุช ูุจู ุงูุญูุธ: ${properties.length}`);

        try {
            // ุชุญููู ุงูุจูุงูุงุช ุฅูู JSON
            const dataToSave = JSON.stringify(properties);
            console.log(`๐ ุญุฌู ุงูุจูุงูุงุช ุงููุฑุงุฏ ุญูุธูุง: ${dataToSave.length} ุญุฑู`);

            // ูุญุงููุฉ ุญูุธ ุงูุจูุงูุงุช ูุน ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงููุณุงุญุฉ
            await saveToLocalStorageWithRetry('properties', dataToSave);
            console.log(`โ ุชู ุญูุธ ุงูุจูุงูุงุช ูู localStorage ุจูุฌุงุญ`);

            // ุงูุชุญูู ุงูููุฑู ูู ุงูุญูุธ
            const savedData = localStorage.getItem('properties');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                console.log(`๐ ุนุฏุฏ ุงููุญุฏุงุช ุงููุญููุธุฉ: ${parsedData.length}`);

                // ุงูุจุญุซ ุนู ุงููุญุฏุฉ ุงููุญุฏุซุฉ
                const savedUnit = parsedData.find(p =>
                    p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
                    p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
                );

                if (savedUnit) {
                    console.log(`โ ุชุฃููุฏ: ุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุญุฏุซุฉ ูู localStorage`);
                    console.log(`   - ุฑูู ุงููุญุฏุฉ ุงููุญููุธ: "${savedUnit['ุฑูู  ุงููุญุฏุฉ ']}"`);
                    console.log(`   - ุงุณู ุงูุนูุงุฑ: "${savedUnit['ุงุณู ุงูุนูุงุฑ']}"`);
                    console.log(`   - ุงุณู ุงููุณุชุฃุฌุฑ: "${savedUnit['ุงุณู ุงููุณุชุฃุฌุฑ']}"`);
                } else {
                    console.error(`โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุญุฏุซุฉ ูู localStorage`);
                    console.log(`๐ ุงูุจุญุซ ุนู: ุฑูู ุงููุญุฏุฉ="${newUnitNumber}", ุงูุนูุงุฑ="${originalPropertyName}"`);

                    // ุนุฑุถ ุฌููุน ุงููุญุฏุงุช ููุชุดุฎูุต
                    console.log(`๐ ุฌููุน ุงููุญุฏุงุช ุงููุญููุธุฉ:`, parsedData.map(p => ({
                        unitNumber: p['ุฑูู  ุงููุญุฏุฉ '],
                        propertyName: p['ุงุณู ุงูุนูุงุฑ']
                    })));

                    throw new Error('ูุดู ูู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุญุฏุซุฉ ูู localStorage');
                }
            } else {
                console.error(`โ ูุดู ูู ูุฑุงุกุฉ ุงูุจูุงูุงุช ูู localStorage`);
                throw new Error('ูุดู ูู ูุฑุงุกุฉ ุงูุจูุงูุงุช ุงููุญููุธุฉ');
            }

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ูู localStorage:`, error);

            // ุฅุฐุง ูุงู ุงูุฎุทุฃ ูุชุนูู ุจุงููุณุงุญุฉุ ุฃุธูุฑ ุฑุณุงูุฉ ูููุฏุฉ
            if (error.message.includes('quota') || error.message.includes('Storage')) {
                throw new Error('ูุณุงุญุฉ ุงูุชุฎุฒูู ููุชูุฆุฉ. ูุฑุฌู ุชูุธูู ุงูุจูุงูุงุช ุฃู ุงุณุชุฎุฏุงู ูุชุตูุญ ุขุฎุฑ.');
            } else {
                throw new Error(`ูุดู ูู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู: ${error.message}`);
            }
        }

        // ูุญุงููุฉ ุงูุญูุธ ูู Supabase ุฅุฐุง ูุงู ูุชุงุญุงู
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            try {
                await saveUnitToSupabase(properties[unitIndex], originalUnitNumber, originalPropertyName);

                // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุณุฌูุงุช ููุฑุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                console.log(`๐ ูุญุต ุงูุณุฌูุงุช ุงูููุฑุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...`);
                const { data: duplicateCheck, error: duplicateError } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('ุฑูู  ุงููุญุฏุฉ ', newUnitNumber)
                    .eq('ุงุณู ุงูุนูุงุฑ', originalPropertyName);

                if (!duplicateError && duplicateCheck && duplicateCheck.length > 1) {
                    console.warn(`โ๏ธ ุชู ุงูุชุดุงู ${duplicateCheck.length} ุณุฌู ููุฑุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช`);

                    // ุญุฐู ุงูุณุฌูุงุช ุงูููุฑุฑุฉ ูุงูุงุญุชูุงุธ ุจุงูุฃุญุฏุซ
                    const sortedRecords = duplicateCheck.sort((a, b) =>
                        new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at)
                    );

                    for (let i = 1; i < sortedRecords.length; i++) {
                        const { error: deleteError } = await supabaseClient
                            .from('properties')
                            .delete()
                            .eq('id', sortedRecords[i].id);

                        if (!deleteError) {
                            console.log(`๐๏ธ ุชู ุญุฐู ุงูุณุฌู ุงูููุฑุฑ ID: ${sortedRecords[i].id}`);
                        }
                    }
                }

            } catch (supabaseError) {
                console.warn('โ๏ธ ุฎุทุฃ ูู Supabaseุ ููู ุงูุชุญุฏูุซ ุงููุญูู ุชู ุจูุฌุงุญ:', supabaseError.message);
                // ูุง ูุฑูู ุงูุฎุทุฃ ููุง ูุฃู ุงูุชุญุฏูุซ ุงููุญูู ูุฌุญ
            }
        }

        // ุฅุบูุงู ุงููุงูุฐุฉ
        closeModal();

        // ุชุญุฏูุซ ุงููุงุฌูุฉ ููุฑุงู
        console.log(`๐ ุชุญุฏูุซ ุงููุงุฌูุฉ - ูุถุน ุงูุฅุฏุงุฑุฉ: ${isManagementMode}`);

        if (isManagementMode) {
            // ุฅุฐุง ููุง ูู ูุถุน ุงูุฅุฏุงุฑุฉุ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุญุฏุงุช
            console.log(`๐ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุญุฏุงุช ูู ูุถุน ุงูุฅุฏุงุฑุฉ`);
            searchUnits();
        } else {
            // ุชุญุฏูุซ ุงูุนุฑุถ ุงูุนุงุฏู
            console.log(`๐ ุชุญุฏูุซ ุงูุนุฑุถ ุงูุนุงุฏู`);
            renderData();
            updateTotalStats();
        }

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู localStorage ููุชุฃูุฏ ูู ุงูุชุญุฏูุซ
        setTimeout(() => {
            console.log(`๐ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ููุชุฃูุฏ ูู ุงูุชุญุฏูุซ`);

            // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู localStorage
            const reloadedData = localStorage.getItem('properties');
            if (reloadedData) {
                try {
                    properties = JSON.parse(reloadedData);
                    console.log(`โ ุชู ุฅุนุงุฏุฉ ุชุญููู ${properties.length} ุนูุงุฑ ูู localStorage`);

                    // ุงูุชุญูู ูู ุฃู ุงูุชุญุฏูุซ ุชู ุจูุฌุงุญ
                    const updatedUnit = properties.find(p =>
                        p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
                        p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
                    );

                    if (updatedUnit) {
                        console.log(`โ ุชุฃููุฏ: ุงููุญุฏุฉ ูุญุฏุซุฉ ุจูุฌุงุญ - ุฑูู ุงููุญุฏุฉ: ${updatedUnit['ุฑูู  ุงููุญุฏุฉ ']}`);
                    } else {
                        console.error(`โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุญุฏุซุฉ`);
                    }

                } catch (e) {
                    console.error('โ ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช:', e);
                }
            }

            if (isManagementMode) {
                searchUnits();
            } else {
                renderData();
            }
        }, 100);

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        showSuccessMessage(`โ ุชู ุชุญุฏูุซ ุงููุญุฏุฉ "${newUnitNumber}" ุจูุฌุงุญ`);

        console.log(`โ ุชู ุชุญุฏูุซ ุงููุญุฏุฉ: ${originalUnitNumber} โ ${newUnitNumber}`);

        // ูุญุต ููุงุฆู ุดุงูู ููุชุฃูุฏ ูู ุงูุชุญุฏูุซ ุงูุฏุงุฆู
        console.log(`๐ ูุญุต ููุงุฆู ุดุงูู ููุชุฃูุฏ ูู ุงูุชุญุฏูุซ ุงูุฏุงุฆู...`);

        // ูุญุต 1: ุงูุชุญูู ูู ุงููุตูููุฉ ุงููุญููุฉ
        const finalCheckLocal = properties.find(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );

        if (finalCheckLocal) {
            console.log(`โ ูุญุต 1 - ุงููุตูููุฉ ุงููุญููุฉ: ุงููุญุฏุฉ ูุญุฏุซุฉ ุจูุฌุงุญ`);
            console.log(`   - ุฑูู ุงููุญุฏุฉ: ${finalCheckLocal['ุฑูู  ุงููุญุฏุฉ ']}`);
            console.log(`   - ุงุณู ุงููุณุชุฃุฌุฑ: ${finalCheckLocal['ุงุณู ุงููุณุชุฃุฌุฑ']}`);
            console.log(`   - ุฑูู ุงูุนูุฏ: ${finalCheckLocal['ุฑูู ุงูุนูุฏ']}`);
        } else {
            console.error(`โ ูุญุต 1 ูุดู - ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุญุฏุซุฉ ูู ุงููุตูููุฉ ุงููุญููุฉ`);
            throw new Error('ูุดู ูู ุชุญุฏูุซ ุงููุตูููุฉ ุงููุญููุฉ');
        }

        // ูุญุต 2: ุงูุชุญูู ูู localStorage
        const localStorageData = JSON.parse(localStorage.getItem('properties') || '[]');
        const finalCheckStorage = localStorageData.find(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );

        if (finalCheckStorage) {
            console.log(`โ ูุญุต 2 - localStorage: ุงููุญุฏุฉ ูุญููุธุฉ ุจูุฌุงุญ`);
            console.log(`   - ุฑูู ุงููุญุฏุฉ ุงููุญููุธ: ${finalCheckStorage['ุฑูู  ุงููุญุฏุฉ ']}`);
        } else {
            console.error(`โ ูุญุต 2 ูุดู - ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุญุฏุซุฉ ูู localStorage`);
            throw new Error('ูุดู ูู ุญูุธ ุงูุจูุงูุงุช ูู localStorage');
        }

        // ูุญุต 3: ุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุงููุญุฏุฉ ุงููุฏููุฉ
        const oldUnitCheck = properties.find(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === originalUnitNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );

        if (oldUnitCheck) {
            console.warn(`โ๏ธ ุชุญุฐูุฑ: ูุง ุฒุงูุช ุงููุญุฏุฉ ุงููุฏููุฉ ููุฌูุฏุฉ - ูุฏ ูููู ููุงู ุชูุฑุงุฑ`);
            console.log(`   - ุงููุญุฏุฉ ุงููุฏููุฉ: ${oldUnitCheck['ุฑูู  ุงููุญุฏุฉ ']}`);
        } else {
            console.log(`โ ูุญุต 3 - ูุง ุชูุฌุฏ ูุญุฏุฉ ูุฏููุฉ: ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ ุจุฏูู ุชูุฑุงุฑ`);
        }

        console.log(`๐ ุฌููุน ุงููุญูุตุงุช ูุฌุญุช - ุงูุชุญุฏูุซ ููุชูู ูุฏุงุฆู!`);

        // ุฅุถุงูุฉ ูุนุฑู ูุฑูุฏ ููุชุญุฏูุซ ูุชุชุจุนู
        const updateId = `update_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        console.log(`๐ ูุนุฑู ุงูุชุญุฏูุซ: ${updateId}`);

        // ุญูุธ ูุนุฑู ุงูุชุญุฏูุซ ูู localStorage ููุชุญูู ููู ูุงุญูุงู
        const updateLog = JSON.parse(localStorage.getItem('updateLog') || '[]');
        updateLog.push({
            id: updateId,
            timestamp: new Date().toISOString(),
            action: 'editUnit',
            originalUnitNumber: originalUnitNumber,
            newUnitNumber: newUnitNumber,
            propertyName: originalPropertyName
        });
        localStorage.setItem('updateLog', JSON.stringify(updateLog));
        console.log(`๐ ุชู ุชุณุฌูู ุงูุชุญุฏูุซ ูู ุณุฌู ุงูุนูููุงุช`);

        // ุชุญุฏูุซ ููุฑู ุฅุถุงูู ูููุงุฌูุฉ
        console.log(`๐ ุชุญุฏูุซ ููุฑู ุฅุถุงูู ูููุงุฌูุฉ`);
        if (typeof renderData === 'function') {
            renderData();
        }
        if (typeof updateTotalStats === 'function') {
            updateTotalStats();
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุชุนุฏูู ุงููุญุฏุฉ:', error);
        alert(`โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชุนุฏููุงุช: ${error.message}`);

        // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ
        const saveBtn = form.querySelector('.save-btn');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ุญูุธ ุงูุชุบููุฑุงุช';
        saveBtn.disabled = false;
    }
}

// ุญูุธ ุงููุญุฏุฉ ูู Supabase
async function saveUnitToSupabase(unit, originalUnitNumber, originalPropertyName) {
    try {
        console.log(`โ๏ธ ูุญุงููุฉ ุชุญุฏูุซ ุงููุญุฏุฉ ูู Supabase:`);
        console.log(`   - ุงูุจูุงูุงุช ุงูุฃุตููุฉ: ุฑูู ุงููุญุฏุฉ="${originalUnitNumber}", ุงูุนูุงุฑ="${originalPropertyName}"`);
        console.log(`   - ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ: ุฑูู ุงููุญุฏุฉ="${unit['ุฑูู  ุงููุญุฏุฉ ']}", ุงูุนูุงุฑ="${unit['ุงุณู ุงูุนูุงุฑ']}"`);

        // ุงูุจุญุซ ุนู ุงูุณุฌู ูู Supabase ุจุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงูุฃุตููุฉ ููุท
        const { data: existingRecords, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('ุฑูู  ุงููุญุฏุฉ ', originalUnitNumber)
            .eq('ุงุณู ุงูุนูุงุฑ', originalPropertyName);

        if (searchError) {
            console.error('โ ุฎุทุฃ ูู ุงูุจุญุซ ูู Supabase:', searchError);
            throw new Error(`ุฎุทุฃ ูู ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${searchError.message}`);
        }

        console.log(`๐ ูุชุงุฆุฌ ุงูุจุญุซ ูู Supabase: ${existingRecords?.length || 0} ุณุฌู`);

        if (existingRecords && existingRecords.length > 0) {
            const existingRecord = existingRecords[0];
            console.log(`๐ ุงูุณุฌู ุงูููุฌูุฏ:`, {
                id: existingRecord.id,
                unitNumber: existingRecord['ุฑูู  ุงููุญุฏุฉ '],
                propertyName: existingRecord['ุงุณู ุงูุนูุงุฑ']
            });

            // ุชุญุฏูุซ ุงูุณุฌู ุงูููุฌูุฏ ุจุงุณุชุฎุฏุงู ID ููุชุฃูุฏ ูู ุงูุชุญุฏูุซ ุงูุตุญูุญ
            const updateData = {
                'ุฑูู  ุงููุญุฏุฉ ': unit['ุฑูู  ุงููุญุฏุฉ '],
                'ุงุณู ุงููุณุชุฃุฌุฑ': unit['ุงุณู ุงููุณุชุฃุฌุฑ'],
                'ุฑูู ุงูุนูุฏ': unit['ุฑูู ุงูุนูุฏ'],
                'ูููุฉ  ุงูุงูุฌุงุฑ ': unit['ูููุฉ  ุงูุงูุฌุงุฑ '],
                'ุงููุณุงุญุฉ': unit['ุงููุณุงุญุฉ'],
                'ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ': unit['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ'],
                'ุฑูู ุฌูุงู ุฅุถุงูู': unit['ุฑูู ุฌูุงู ุฅุถุงูู'],
                tenant_phone: unit['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ'],
                tenant_phone_2: unit['ุฑูู ุฌูุงู ุฅุถุงูู'],
                updated_at: new Date().toISOString()
            };

            console.log(`๐ ุจูุงูุงุช ุงูุชุญุฏูุซ:`, updateData);

            // ุงุณุชุฎุฏุงู ID ููุชุญุฏูุซ ุจุฏูุงู ูู ุงูุจุญุซ ุจุงูุญููู
            const { data: updatedData, error: updateError } = await supabaseClient
                .from('properties')
                .update(updateData)
                .eq('id', existingRecord.id)
                .select();

            if (updateError) {
                console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ Supabase:', updateError);
                throw new Error(`ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${updateError.message}`);
            } else {
                console.log('โ ุชู ุชุญุฏูุซ ุงููุญุฏุฉ ูู Supabase ุจูุฌุงุญ');
                console.log('๐ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ:', updatedData);

                // ุงูุชุญูู ูู ุงูุชุญุฏูุซ
                if (updatedData && updatedData.length > 0) {
                    const updated = updatedData[0];
                    console.log(`โ ุชุฃููุฏ ุงูุชุญุฏูุซ: ุฑูู ุงููุญุฏุฉ ุงูุฌุฏูุฏ = "${updated['ุฑูู  ุงููุญุฏุฉ ']}"`);
                }
            }
        } else {
            console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณุฌู ูู Supabase ููุชุญุฏูุซ');
            console.log('๐ ูุญุงููุฉ ุงูุจุญุซ ุจุทุฑููุฉ ุฃุฎุฑู...');

            // ูุญุงููุฉ ุงูุจุญุซ ุจุฏูู ุชุทุงุจู ุฏููู ูููุณุงูุงุช
            const { data: alternativeSearch, error: altError } = await supabaseClient
                .from('properties')
                .select('*')
                .ilike('ุฑูู  ุงููุญุฏุฉ ', `%${originalUnitNumber.trim()}%`)
                .ilike('ุงุณู ุงูุนูุงุฑ', `%${originalPropertyName.trim()}%`);

            if (!altError && alternativeSearch && alternativeSearch.length > 0) {
                console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${alternativeSearch.length} ุณุฌู ุจุงูุจุญุซ ุงูุจุฏูู`);
                // ูููู ุฅุถุงูุฉ ููุทู ุงูุชุญุฏูุซ ููุง ุฅุฐุง ูุฒู ุงูุฃูุฑ
            } else {
                console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณุฌู ุญุชู ุจุงูุจุญุซ ุงูุจุฏูู');
            }
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุฉ ูู Supabase:', error);
        throw error; // ุฅุนุงุฏุฉ ุฑูู ุงูุฎุทุฃ ููุชู ุงูุชุนุงูู ูุนู ูู ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
    }
}

// ูุญุต ุงูุจูุงูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ ููุชุฃูุฏ ูู ุงูุญูุธ ุงูุฏุงุฆู
function verifyDataPersistence() {
    console.log(`๐ ูุญุต ุงูุจูุงูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ...`);

    try {
        // ูุญุต localStorage
        const savedData = localStorage.getItem('properties');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            console.log(`๐ ุชู ุชุญููู ${parsedData.length} ุนูุงุฑ ูู localStorage`);

            // ูุญุต ุณุฌู ุงูุชุญุฏูุซุงุช
            const updateLog = JSON.parse(localStorage.getItem('updateLog') || '[]');
            if (updateLog.length > 0) {
                console.log(`๐ ุณุฌู ุงูุชุญุฏูุซุงุช ูุญุชูู ุนูู ${updateLog.length} ุนูููุฉ`);

                // ุนุฑุถ ุขุฎุฑ 3 ุชุญุฏูุซุงุช
                const recentUpdates = updateLog.slice(-3);
                recentUpdates.forEach((update, index) => {
                    console.log(`๐ ุชุญุฏูุซ ${index + 1}: ${update.originalUnitNumber} โ ${update.newUnitNumber} ูู ${update.propertyName}`);
                });
            }

            // ูุญุต ุชุทุงุจู ุงูุจูุงูุงุช
            if (properties.length === parsedData.length) {
                console.log(`โ ุชุทุงุจู ุนุฏุฏ ุงูุนูุงุฑุงุช: ุงููุตูููุฉ ุงููุญููุฉ = localStorage`);
            } else {
                console.warn(`โ๏ธ ุนุฏู ุชุทุงุจู: ุงููุตูููุฉ ุงููุญููุฉ (${properties.length}) โ localStorage (${parsedData.length})`);
            }

        } else {
            console.warn(`โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ ูู localStorage`);
        }

    } catch (error) {
        console.error(`โ ุฎุทุฃ ูู ูุญุต ุงูุจูุงูุงุช:`, error);
    }
}

// ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
function showSuccessMessage(message) {
    // ุฅูุดุงุก ุนูุตุฑ ุงูุฑุณุงูุฉ
    const messageDiv = document.createElement('div');
    messageDiv.className = 'success-message';
    messageDiv.innerHTML = `
        <div class="success-content">
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        </div>
    `;

    // ุฅุถุงูุฉ ุงูุฃููุงุท
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        z-index: 10000;
        font-size: 1rem;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
        word-wrap: break-word;
    `;

    // ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ููุตูุญุฉ
    document.body.appendChild(messageDiv);

    // ุฅุฒุงูุฉ ุงูุฑุณุงูุฉ ุจุนุฏ 3 ุซูุงู
    setTimeout(() => {
        messageDiv.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}

// ุนุฑุถ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช
function showPropertyManager() {
    if (isManagementMode) {
        // ุงูุนูุฏุฉ ูููุถุน ุงูุนุงุฏู
        exitManagementMode();
        return;
    }

    // ุงูุฏุฎูู ูู ูุถุน ุงูุฅุฏุงุฑุฉ
    enterManagementMode();
}

// ุงูุฏุฎูู ูู ูุถุน ุงูุฅุฏุงุฑุฉ
function enterManagementMode() {
    isManagementMode = true;

    // ุชุบููุฑ ูุต ุงูุฒุฑ
    const propertyManagerBtn = document.getElementById('propertyManagerBtn');
    if (propertyManagerBtn) {
        propertyManagerBtn.innerHTML = '<i class="fas fa-arrow-left"></i> ุนูุงุฑุงุชูุง';
        propertyManagerBtn.title = 'ุงูุนูุฏุฉ ููุนุฑุถ ุงูุนุงุฏู';
    }

    // ุฅุฎูุงุก ุงููุญุชูู ุงูุญุงูู
    const mainContent = document.getElementById('content');
    const totalContainer = document.getElementById('totalContainer');
    const mobileTotals = document.getElementById('mobileTotals');
    const filterContainer = document.querySelector('.filter-container');
    const viewToggle = document.querySelector('.view-toggle');
    const header = document.querySelector('header');

    if (mainContent) mainContent.style.display = 'none';
    if (totalContainer) totalContainer.style.display = 'none';
    if (mobileTotals) mobileTotals.style.display = 'none';
    if (filterContainer) filterContainer.style.display = 'none';
    if (viewToggle) viewToggle.style.display = 'none';
    if (header) header.style.display = 'none';

    // ุฅูุดุงุก ุตูุญุฉ ุงูุฅุฏุงุฑุฉ ูุน ุงูุชุตููู ุงูุฌุฏูุฏ
    const managementPage = document.createElement('div');
    managementPage.id = 'managementPage';
    managementPage.className = 'management-page';
    managementPage.innerHTML = `
        <!-- ุงูููุฏุฑ ุงูุซุงุจุช ูุน ุฒุฑ ุงููุงุฆูุฉ ููุฌูุงู -->
        <div class="management-fixed-header">
            <div class="header-content">
                <!-- ุฒุฑ ุงููุงุฆูุฉ ููุฌูุงู ููุท -->
                <button class="mobile-menu-toggle" id="managementMobileMenuToggle" onclick="toggleManagementSidebar()">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="header-center">
                    <h1><i class="fas fa-building"></i> ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช</h1>
                    <p>ุฅุถุงูุฉ ูุชุญุฑูุฑ ุงูุนูุงุฑุงุช ูุงููุญุฏุงุช</p>
                </div>

                <!-- ุฒุฑ ุงูุฎุฑูุฌ ููุฌูุงู -->
                <button class="mobile-exit-btn" onclick="exitManagementMode()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- ุทุจูุฉ ุงูุชุบุทูุฉ ููุฌูุงู -->
        <div class="management-overlay" id="managementOverlay" onclick="closeManagementSidebar()"></div>

        <!-- ุงูุณุงูุฏ ุจุงุฑ ูุน ุฏุนู ุงูุฌูุงู -->
        <div class="management-sidebar" id="managementSidebar">
            <div class="sidebar-content">
                <!-- ุฑุฃุณ ุงูุณุงูุฏ ุจุงุฑ ูุน ุฒุฑ ุงูุฅุบูุงู ููุฌูุงู -->
                <div class="sidebar-header" style="background: linear-gradient(135deg, #007bff, #0056b3) !important; padding: 25px 20px !important; margin: 0 !important; border-bottom: none !important; position: relative !important; flex-shrink: 0 !important; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;">
                    <h3 style="font-size: 1.3rem !important; color: white !important; margin: 0 !important; text-align: center !important; font-weight: 700 !important; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important; font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important; letter-spacing: 0.4px !important;"><i class="fas fa-cogs" style="margin-left: 8px; color: white; font-size: 1.2rem;"></i> ุงูุชููู ุงูุณุฑูุน</h3>
                    <button class="mobile-sidebar-close" onclick="closeManagementSidebar()" style="display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 1.4rem; padding: 12px; cursor: pointer; border-radius: 50%; transition: all 0.3s ease; position: absolute; left: 20px; top: 20px; width: 45px; height: 45px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);">
                        <i class="fas fa-times" style="color: white; font-size: 1.4rem;"></i>
                    </button>
                </div>
                <nav class="sidebar-nav" style="flex: 1 !important; padding: 20px !important; display: flex !important; flex-direction: column !important; gap: 15px !important; overflow-y: auto !important; background: transparent !important; justify-content: flex-start !important;">

                    <!-- ุฒุฑ ุงูุนูุงุฑุงุช -->
                    <button class="nav-btn active" onclick="showPropertyTabMobile('properties');" data-tab="properties"
                            style="
                                width: 100% !important;
                                background: linear-gradient(135deg, #007bff, #0056b3) !important;
                                color: white !important;
                                border: none !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-building" style="color: white !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: white !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">ุงูุนูุงุฑุงุช</span>
                    </button>

                    <!-- ุฒุฑ ุงููุญุฏุงุช -->
                    <button class="nav-btn" onclick="showPropertyTabMobile('units');" data-tab="units"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-home" style="color: #34495e !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">ุงููุญุฏุงุช</span>
                    </button>

                    <!-- ุฒุฑ ุฏูุฌ ุงููุญุฏุงุช -->
                    <button class="nav-btn" onclick="showPropertyTabMobile('merge'); hideSidebarOnMobile();" data-tab="merge"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-layer-group" style="color: #34495e !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">ุฏูุฌ ุงููุญุฏุงุช</span>
                    </button>

                    <!-- ุฒุฑ ููู ุงููุญุฏุงุช -->
                    <button class="nav-btn" onclick="showUnitTransferModal(); hideSidebarOnMobile();"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-exchange-alt" style="color: #34495e !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">ููู ุงููุญุฏุงุช</span>
                    </button>

                    <!-- ุฒุฑ ุงุฎุชุจุงุฑ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู -->
                    <button class="nav-btn" onclick="testPhoneFieldSave(); hideSidebarOnMobile();"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-mobile-alt" style="color: #28a745 !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.1rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">ุงุฎุชุจุงุฑ ุฑูู ุงูุฌูุงู ุงูุฅุถุงูู</span>
                    </button>

                    <!-- ุฒุฑ ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน (ูููุฏูุฑ ููุท) -->
                    <button class="nav-btn admin-only-btn" onclick="showTrackingManagementModal(); hideSidebarOnMobile();" id="trackingManagementBtn"
                            style="
                                width: 100% !important;
                                background: #ffffff !important;
                                color: #2c3e50 !important;
                                border: 3px solid #e9ecef !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-clipboard-list" style="color: #6f42c1 !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: #2c3e50 !important;
                            font-size: 1.1rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน</span>
                    </button>

                    <!-- ุฒุฑ ุชุตููุฉ ุญุณุจ ุงููุฏููุฉ -->
                    <button class="nav-btn filter-btn" onclick="toggleCityFilter()" id="cityFilterBtn"
                            style="
                                width: 100% !important;
                                background: linear-gradient(135deg, #6f42c1, #5a32a3) !important;
                                color: white !important;
                                border: none !important;
                                margin: 0 0 12px 0 !important;
                                padding: 18px 25px !important;
                                border-radius: 12px !important;
                                min-height: 60px !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3) !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 20px !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                text-align: right !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-filter" style="color: white !important; font-size: 1.4rem !important; width: 30px !important; text-align: center !important; font-weight: 900 !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: white !important;
                            font-size: 1.1rem !important;
                            font-weight: 800 !important;
                            flex: 1 !important;
                            text-align: right !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            letter-spacing: 0.5px !important;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        ">ุชุตููุฉ ุญุณุจ ุงููุฏููุฉ</span>
                        <i class="fas fa-chevron-down filter-arrow" id="filterArrow" style="color: white !important; font-size: 1.1rem !important; flex-shrink: 0 !important;"></i>
                    </button>



                    <!-- ูุงุฆูุฉ ุงููุฏู ุงููุงุจูุฉ ููุทู - ุชุตููู ูุญุณู -->
                    <div class="city-filter-list" id="cityFilterList"
                         style="
                             display: none;
                             background: #f8f9fa;
                             border-radius: 12px;
                             margin: 0 20px 15px 20px;
                             padding: 15px;
                             border: 2px solid #e9ecef;
                             box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                             max-height: none;
                             overflow: visible;
                         ">

                        <!-- ุฎูุงุฑ ุฌููุน ุงููุฏู -->
                        <div class="city-option all-cities" onclick="filterByCity('all')"
                             style="
                                 background: linear-gradient(135deg, #28a745, #20c997);
                                 color: white;
                                 padding: 12px 15px;
                                 border-radius: 8px;
                                 margin-bottom: 10px;
                                 cursor: pointer;
                                 display: flex;
                                 align-items: center;
                                 gap: 12px;
                                 transition: all 0.3s ease;
                                 font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif;
                                 font-weight: 600;
                                 box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
                             ">
                            <i class="fas fa-globe" style="font-size: 1rem; color: white;"></i>
                            <span style="flex: 1; font-size: 0.9rem; color: white;">ุฌููุน ุงููุฏู</span>
                            <span class="city-count" id="allCitiesCount"
                                  style="
                                      background: rgba(255, 255, 255, 0.2);
                                      color: white;
                                      padding: 4px 8px;
                                      border-radius: 12px;
                                      font-size: 0.7rem;
                                      font-weight: 700;
                                      min-width: 25px;
                                      text-align: center;
                                  ">0</span>
                        </div>

                        <!-- ูุงุฆูุฉ ุงููุฏู ุงูููุธูุฉ -->
                        <ol class="cities-list" id="citiesContainer"
                            style="
                                list-style: none;
                                margin: 0;
                                padding: 0;
                                counter-reset: city-counter;
                            ">
                            <!-- ุณูุชู ููุก ุงููุฏู ููุง -->
                        </ol>
                    </div>
                </nav>
                <div class="sidebar-footer" style="padding: 25px 20px !important; border-top: 2px solid #e9ecef !important; background: #f8f9fa !important; margin-top: auto !important; flex-shrink: 0 !important;">
                    <!-- ุฒุฑ ุงูุฎุฑูุฌ -->
                    <button class="btn-exit" onclick="exitManagementMode()"
                            style="
                                width: 100% !important;
                                padding: 25px 30px !important;
                                margin: 0 !important;
                                background: linear-gradient(135deg, #dc3545, #c82333) !important;
                                color: white !important;
                                border: none !important;
                                border-radius: 15px !important;
                                font-size: 1.5rem !important;
                                font-weight: 800 !important;
                                cursor: pointer !important;
                                transition: all 0.3s ease !important;
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                gap: 15px !important;
                                min-height: 65px !important;
                                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3) !important;
                                font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                                letter-spacing: 0.5px !important;
                                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                                text-align: center !important;
                                direction: rtl !important;
                            ">
                        <i class="fas fa-sign-out-alt" style="font-size: 1.3rem !important; color: white !important; flex-shrink: 0 !important;"></i>
                        <span style="
                            color: white !important;
                            font-size: 1.2rem !important;
                            font-weight: 800 !important;
                            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif !important;
                            line-height: 1.2 !important;
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                        ">ุฎุฑูุฌ</span>
                    </button>
                </div>
            </div>


        </div>

        <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
        <div class="management-main-content">
            <div class="management-body">
                <div id="properties-tab" class="tab-content active">
                    ${renderPropertiesTab()}
                </div>
                <div id="units-tab" class="tab-content">
                    ${renderUnitsTab()}
                </div>
                <div id="merge-tab" class="tab-content">
                    ${renderMergeTab()}
                </div>
            </div>
        </div>
    `;

    // ุฅุถุงูุฉ ุงูุตูุญุฉ ูููุญุชูู
    document.body.appendChild(managementPage);

    // ููุน ุงูุชูุฑูุฑ ูู ุงูุฎูููุฉ
    document.body.style.overflow = 'hidden';

    // ุชููุฆุฉ ูุงุฆูุฉ ุชุตููุฉ ุงููุฏู
    setTimeout(() => {
        initializeCityFilter();
        initializeManagementMobile();
        setupSidebarProtection();

        // ุฅุนุงุฏุฉ ุชุทุจูู ุงูุญูุงูุฉ ุนูุฏ ุชุญุฏูุซ ุงููุญุชูู
        const observer = new MutationObserver(() => {
            setupSidebarProtection();
            protectSearchFields();
        });

        const sidebar = document.getElementById('managementSidebar');
        if (sidebar) {
            observer.observe(sidebar, {
                childList: true,
                subtree: true
            });
        }
    }, 100);
}

// ===== ูุธุงุฆู ุงูุณุงูุฏ ุจุงุฑ ููุฌูุงู ูู ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช =====

// ุชููุฆุฉ ูุธุงุฆู ุงูุฌูุงู ูุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช
function initializeManagementMobile() {
    console.log('๐ฑ ุชููุฆุฉ ูุธุงุฆู ุงูุฌูุงู ูุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช...');

    // ุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ ูู ุงูุฌูุงู ุจุดูู ุงูุชุฑุงุถู
    if (isMobileDevice()) {
        const sidebar = document.getElementById('managementSidebar');
        const overlay = document.getElementById('managementOverlay');

        if (sidebar) {
            sidebar.classList.remove('active');
        }
        if (overlay) {
            overlay.classList.remove('active');
        }

        console.log('โ ุชู ุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ ูู ุงูุฌูุงู');
    }
}

// ุชุจุฏูู ุนุฑุถ ุงูุณุงูุฏ ุจุงุฑ ูู ุงูุฌูุงู
function toggleManagementSidebar() {
    console.log('๐ ุชุจุฏูู ุนุฑุถ ุงูุณุงูุฏ ุจุงุฑ...');

    const sidebar = document.getElementById('managementSidebar');
    const overlay = document.getElementById('managementOverlay');
    const menuToggle = document.getElementById('managementMobileMenuToggle');

    if (!sidebar || !overlay) {
        console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุงุตุฑ ุงูุณุงูุฏ ุจุงุฑ');
        return;
    }

    const isActive = sidebar.classList.contains('active');

    if (isActive) {
        // ุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ
        closeManagementSidebar();
    } else {
        // ุฅุธูุงุฑ ุงูุณุงูุฏ ุจุงุฑ
        openManagementSidebar();
    }
}

// ูุชุญ ุงูุณุงูุฏ ุจุงุฑ
function openManagementSidebar() {
    console.log('๐ ูุชุญ ุงูุณุงูุฏ ุจุงุฑ...');

    const sidebar = document.getElementById('managementSidebar');
    const overlay = document.getElementById('managementOverlay');
    const menuToggle = document.getElementById('managementMobileMenuToggle');

    if (sidebar) {
        sidebar.classList.add('active');
    }
    if (overlay) {
        overlay.classList.add('active');
    }
    if (menuToggle) {
        menuToggle.classList.add('active');
        // ุชุบููุฑ ุงูุฃููููุฉ ุฅูู X
        const icon = menuToggle.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-times';
        }
    }

    // ููุน ุงูุชูุฑูุฑ ูู ุงูุฎูููุฉ
    document.body.style.overflow = 'hidden';

    console.log('โ ุชู ูุชุญ ุงูุณุงูุฏ ุจุงุฑ');
}

// ุฅุบูุงู ุงูุณุงูุฏ ุจุงุฑ
function closeManagementSidebar() {
    console.log('๐ ุฅุบูุงู ุงูุณุงูุฏ ุจุงุฑ...');

    const sidebar = document.getElementById('managementSidebar');
    const overlay = document.getElementById('managementOverlay');
    const menuToggle = document.getElementById('managementMobileMenuToggle');

    if (sidebar) {
        sidebar.classList.remove('active');
    }
    if (overlay) {
        overlay.classList.remove('active');
    }
    if (menuToggle) {
        menuToggle.classList.remove('active');
        // ุฅุนุงุฏุฉ ุงูุฃููููุฉ ุฅูู ุงููุงุฆูุฉ
        const icon = menuToggle.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-bars';
        }
    }

    // ุงูุณูุงุญ ุจุงูุชูุฑูุฑ ูุฑุฉ ุฃุฎุฑู
    document.body.style.overflow = '';

    console.log('โ ุชู ุฅุบูุงู ุงูุณุงูุฏ ุจุงุฑ');
}

// ุชุญุฏูุซ ูุธููุฉ showPropertyTab ูุฅุบูุงู ุงูุณุงูุฏ ุจุงุฑ ูู ุงูุฌูุงู
function showPropertyTabMobile(tabName) {
    // ุงุณุชุฏุนุงุก ุงููุธููุฉ ุงูุฃุตููุฉ
    showPropertyTab(tabName);

    // ุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ ูู ุงูุฌูุงู ููุท ุนูุฏ ุชุบููุฑ ุงูุชุจููุจ
    // ูููู ููุณ ุนูุฏ ุงูุชูุงุนู ูุน ุงูููุงุฐุฌ ุฃู ุงูุจุญุซ
    if (isMobileDevice() || window.innerWidth <= 768) {
        // ุชุฃุฎูุฑ ูุตูุฑ ููุณูุงุญ ุจุชุญุฏูุซ ุงููุญุชูู ุฃููุงู
        setTimeout(() => {
            // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูู ูููุฑ ุนูู ุญูู ูููุฐุฌ ุฃู ุจุญุซ
            const activeElement = document.activeElement;
            const isFormElement = activeElement && (
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'SELECT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.classList.contains('form-control') ||
                activeElement.type === 'search' ||
                activeElement.hasAttribute('data-prevent-sidebar-close') ||
                activeElement.placeholder?.includes('ุจุญุซ') ||
                activeElement.placeholder?.includes('ุงุณู ุงูุนูุงุฑ') ||
                activeElement.placeholder?.includes('ุฑูู ุงููุญุฏุฉ')
            );

            // ุงูุชุญูู ูู ูุฌูุฏ ุญููู ุจุญุซ ูุดุทุฉ
            const activeSearchFields = document.querySelectorAll('input[data-prevent-sidebar-close="true"]');
            const hasActiveSearch = activeSearchFields.length > 0;

            // ุงูุชุญูู ูู ุญุงูุฉ ุงูุจุญุซ ุงููุดุท ูู ุงูุณุงูุฏ ุจุงุฑ
            const sidebar = document.getElementById('managementSidebar');
            const sidebarSearchActive = sidebar && sidebar.hasAttribute('data-search-active');

            // ุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ ููุท ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ูุชูุงุนู ูุน ูููุฐุฌ ุฃู ุจุญุซ
            if (!isFormElement && !hasActiveSearch && !sidebarSearchActive) {
                closeManagementSidebar();
            }
        }, 300);
    }
}

// ุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ ูู ุงูุฌูุงู ุนูุฏ ุงูููุฑ ุนูู ุงูุฃุฒุฑุงุฑ (ููุงุณุชุฎุฏุงู ุงููุญุฏุฏ)
function hideSidebarOnMobile() {
    // ุงูุชุญูู ูู ุฃู ุงูุฌูุงุฒ ุฌูุงู
    if (isMobileDevice() || window.innerWidth <= 768) {
        setTimeout(() => {
            closeManagementSidebar();
        }, 200);
    }
}

// ุฅุนุฏุงุฏ ุญูุงูุฉ ุงูุณุงูุฏ ุจุงุฑ ูู ุงูุฅุฎูุงุก ุบูุฑ ุงููุฑุบูุจ ููู
function setupSidebarProtection() {
    const sidebar = document.getElementById('managementSidebar');
    if (!sidebar) return;

    // ููุน ุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ ุนูุฏ ุงูููุฑ ุนูู ุนูุงุตุฑ ุงูููุงุฐุฌ
    const protectedElements = [
        'input', 'select', 'textarea', 'button.city-option',
        '.city-filter-list', '.form-control', '.form-group',
        '.property-form', '.section-header', '.search-container',
        '.property-search', '.unit-search', '.merge-search'
    ];

    protectedElements.forEach(selector => {
        const elements = sidebar.querySelectorAll(selector);
        elements.forEach(element => {
            element.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            element.addEventListener('focus', function(e) {
                e.stopPropagation();
            });

            element.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            });

            element.addEventListener('touchend', function(e) {
                e.stopPropagation();
            });
        });
    });

    // ุญูุงูุฉ ุฎุงุตุฉ ูุญููู ุงูุจุญุซ ูู ุฌููุน ุงูุชุจููุจุงุช
    const searchSelectors = [
        '#propertySearch', '#unitSearch', '#mergeSearch',
        'input[type="search"]', 'input[placeholder*="ุจุญุซ"]',
        'input[placeholder*="ุงุณู ุงูุนูุงุฑ"]', 'input[placeholder*="ุฑูู ุงููุญุฏุฉ"]',
        'input[placeholder*="ุฑูู ุงูุนูุฏ"]', '.search-input',
        '#unitSearchInput', '#propertySearchInput', '#mergeSearchInput'
    ];

    searchSelectors.forEach(selector => {
        // ุงูุจุญุซ ูู ุงูุณุงูุฏ ุจุงุฑ
        const sidebarInputs = sidebar.querySelectorAll(selector);
        sidebarInputs.forEach(input => {
            addSearchProtection(input);
        });

        // ุงูุจุญุซ ูู ุงููุญุชูู ุงูุฑุฆูุณู ุฃูุถุงู
        const mainInputs = document.querySelectorAll(selector);
        mainInputs.forEach(input => {
            addSearchProtection(input);
        });
    });

    console.log('โ ุชู ุฅุนุฏุงุฏ ุญูุงูุฉ ุงูุณุงูุฏ ุจุงุฑ ูู ุงูุฅุฎูุงุก ุบูุฑ ุงููุฑุบูุจ ููู');
}

// ุฅุถุงูุฉ ุญูุงูุฉ ูุญูู ุงูุจุญุซ
function addSearchProtection(input) {
    if (!input) return;

    // ููุน ุฌููุน ุงูุฃุญุฏุงุซ ุงูุชู ูุฏ ุชุคุฏู ูุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ
    const events = ['click', 'focus', 'touchstart', 'touchend', 'input', 'keyup', 'keydown', 'mousedown', 'mouseup'];

    events.forEach(eventType => {
        input.addEventListener(eventType, function(e) {
            e.stopPropagation();
            // ูุถุน ุนูุงูุฉ ุญูุงูุฉ
            this.setAttribute('data-prevent-sidebar-close', 'true');

            // ุญูุงูุฉ ุฅุถุงููุฉ ููุฌูุงู
            if (isMobileDevice() || window.innerWidth <= 768) {
                // ููุน ุฅุฎูุงุก ุงูุณุงูุฏ ุจุงุฑ ุนูุฏ ุงูุชูุงุนู ูุน ุงูุจุญุซ
                const sidebar = document.getElementById('managementSidebar');
                if (sidebar) {
                    sidebar.setAttribute('data-search-active', 'true');
                }
            }
        });
    });

    // ุฅุฒุงูุฉ ุงูุญูุงูุฉ ุนูุฏ ููุฏุงู ุงูุชุฑููุฒ
    input.addEventListener('blur', function() {
        setTimeout(() => {
            this.removeAttribute('data-prevent-sidebar-close');

            // ุฅุฒุงูุฉ ุงูุญูุงูุฉ ูู ุงูุณุงูุฏ ุจุงุฑ
            const sidebar = document.getElementById('managementSidebar');
            if (sidebar) {
                sidebar.removeAttribute('data-search-active');
            }
        }, 200);
    });
}

// ุงูุฎุฑูุฌ ูู ูุถุน ุงูุฅุฏุงุฑุฉ
function exitManagementMode() {
    // ุฑุณุงูุฉ ุชุฃููุฏ
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉุ')) {
        return;
    }

    isManagementMode = false;

    // ุชุบููุฑ ูุต ุงูุฒุฑ
    const propertyManagerBtn = document.getElementById('propertyManagerBtn');
    if (propertyManagerBtn) {
        propertyManagerBtn.innerHTML = '<i class="fas fa-building"></i> ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช';
        propertyManagerBtn.title = 'ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช';
    }

    // ุฅุฒุงูุฉ ุตูุญุฉ ุงูุฅุฏุงุฑุฉ
    const managementPage = document.getElementById('managementPage');
    if (managementPage) {
        managementPage.remove();
    }

    // ุฅุธูุงุฑ ุงููุญุชูู ุงูุฃุตูู
    const mainContent = document.getElementById('content');
    const totalContainer = document.getElementById('totalContainer');
    const mobileTotals = document.getElementById('mobileTotals');
    const filterContainer = document.querySelector('.filter-container');
    const viewToggle = document.querySelector('.view-toggle');
    const header = document.querySelector('header');

    // ุงูุชุฃูุฏ ูู ุฅุธูุงุฑ ุฌููุน ุงูุนูุงุตุฑ
    if (mainContent) {
        mainContent.style.display = '';
        mainContent.style.visibility = 'visible';
    }
    if (totalContainer) {
        totalContainer.style.display = '';
        totalContainer.style.visibility = 'visible';
    }
    if (mobileTotals) {
        mobileTotals.style.display = '';
        mobileTotals.style.visibility = 'visible';
    }
    if (filterContainer) {
        filterContainer.style.display = '';
        filterContainer.style.visibility = 'visible';
    }
    if (viewToggle) {
        viewToggle.style.display = '';
        viewToggle.style.visibility = 'visible';
    }
    if (header) {
        header.style.display = '';
        header.style.visibility = 'visible';
    }

    // ุฅุนุงุฏุฉ ุชุนููู body ููุญุงูุฉ ุงูุทุจูุนูุฉ
    document.body.style.overflow = '';
    document.body.style.position = '';

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
    setTimeout(() => {
        renderData();
    }, 100);
}

// ุนุฑุถ ุชุจููุจ ุงูุนูุงุฑุงุช
function renderPropertiesTab() {
    const cities = getUniqueCountries().filter(city => city !== 'ุงููู');
    let existingProperties = getUniqueProperties();

    // ุชุทุจูู ุงูุชุตููุฉ ุญุณุจ ุงููุฏููุฉ
    if (selectedCityFilter !== 'all') {
        existingProperties = existingProperties.filter(propertyName => {
            const property = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
            return property && property['ุงููุฏููุฉ'] === selectedCityFilter;
        });
    }

    return `
        <div class="property-section city-management-section">
            <div class="section-header">
                <h3><i class="fas fa-city"></i> ุฅุฏุงุฑุฉ ุงููุฏู</h3>
            </div>
            <div class="property-form">
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-plus-circle"></i> ุฅุถุงูุฉ ูุฏููุฉ ุฌุฏูุฏุฉ:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="newCityName" placeholder="ุฃุฏุฎู ุงุณู ุงููุฏููุฉ ุงูุฌุฏูุฏุฉ"
                                   style="flex: 1; padding: 10px; border: 2px solid #6f42c1; border-radius: 6px;"
                                   onkeypress="if(event.key==='Enter') addNewCityToSystem()">
                            <button class="btn-primary" onclick="addNewCityToSystem()"
                                    style="white-space: nowrap; background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                                <i class="fas fa-plus-circle"></i> ุฅุถุงูุฉ ุงููุฏููุฉ
                            </button>
                        </div>
                        <div class="existing-cities-display">
                            <strong><i class="fas fa-list"></i> ุงููุฏู ุงูููุฌูุฏุฉ:</strong><br>
                            ${cities.filter(city => city !== 'ุงููู').join(' โข ')}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-plus-circle"></i> ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ</h3>
            </div>
            <div class="property-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>ุงุณู ุงูุนูุงุฑ:</label>
                        <input type="text" id="newPropertyName" placeholder="ุฃุฏุฎู ุงุณู ุงูุนูุงุฑ">
                    </div>
                    <div class="form-group">
                        <label>ุงููุฏููุฉ:</label>
                        <select id="newPropertyCity">
                            <option value="">ุงุฎุชุฑ ุงููุฏููุฉ</option>
                            ${cities.map(city => `<option value="${city}">${city}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ุฑูู ุงูุตู:</label>
                        <input type="text" id="newPropertyDeed" placeholder="ุฑูู ุงูุตู">
                    </div>
                    <div class="form-group">
                        <label>ูุณุงุญุฉ ุงูุตู:</label>
                        <input type="number" id="newPropertyArea" placeholder="ุงููุณุงุญุฉ ุจุงููุชุฑ ุงููุฑุจุน">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ุงูุณุฌู ุงูุนููู:</label>
                        <input type="text" id="newPropertyRegistry" placeholder="ุฑูู ุงูุณุฌู ุงูุนููู (ุงุฎุชูุงุฑู)">
                    </div>
                    <div class="form-group">
                        <label>ุงููุงูู:</label>
                        <input type="text" id="newPropertyOwner" placeholder="ุงุณู ุงููุงูู">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ูููุน ุงูุนูุงุฑ (ุฑุงุจุท ุงูุฎุฑูุทุฉ):</label>
                        <input type="url" id="newPropertyLocation" placeholder="https://maps.google.com/...">
                    </div>
                </div>
                <button class="btn-primary" onclick="addNewProperty()">
                    <i class="fas fa-plus"></i> ุฅุถุงูุฉ ุงูุนูุงุฑ
                </button>
            </div>
        </div>

        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> ุงูุนูุงุฑุงุช ุงูููุฌูุฏุฉ</h3>
                <div class="filter-info">
                    ${selectedCityFilter === 'all' ?
                        `<span class="filter-badge all">ุฌููุน ุงููุฏู (${existingProperties.length} ุนูุงุฑ)</span>` :
                        `<span class="filter-badge filtered">ูุฏููุฉ ${selectedCityFilter} (${existingProperties.length} ุนูุงุฑ)</span>`
                    }
                </div>
                <div class="section-actions">
                    <button onclick="testPropertyEditSystem()" class="test-btn" title="ุงุฎุชุจุงุฑ ูุธุงู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช">
                        <i class="fas fa-vial"></i> ุงุฎุชุจุงุฑ ุงููุธุงู
                    </button>
                    <button onclick="checkAllPropertiesSync()" class="sync-check-btn" title="ูุญุต ุญุงูุฉ ุงููุฒุงููุฉ">
                        <i class="fas fa-sync-alt"></i> ูุญุต ุงููุฒุงููุฉ
                    </button>
                    <button onclick="fixAllDuplicatesWithConfirmation()" class="fix-duplicates-btn" title="ุฅุตูุงุญ ุงููุญุฏุงุช ุงูููุฑุฑุฉ">
                        <i class="fas fa-broom"></i> ุฅุตูุงุญ ุงูุชูุฑุงุฑ
                    </button>
                </div>
            </div>

            <!-- ุฎุงูุฉ ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช -->
            <div class="properties-search-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               id="propertiesSearchInput"
                               placeholder="ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช ุจุงูุงุณู ุฃู ุงููุฏููุฉ..."
                               class="properties-search-input"
                               oninput="searchProperties(this.value)"
                               autocomplete="off">
                        <button class="clear-search-btn" onclick="clearPropertiesSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-results-count" id="propertiesSearchCount" style="display: none;">
                        <span id="searchResultsText"></span>
                    </div>
                </div>
            </div>
            <div class="existing-properties">
                ${existingProperties.length > 0 ?
                    existingProperties.map(property => {
                        const propertyData = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === property);
                        const cityName = propertyData ? propertyData['ุงููุฏููุฉ'] : 'ุบูุฑ ูุญุฏุฏ';
                        return `
                            <div class="property-item">
                                <div class="property-info">
                                    <h4>${property}</h4>
                                    <p><i class="fas fa-map-marker-alt"></i> ${cityName}</p>
                                    <p><i class="fas fa-building"></i> ุนุฏุฏ ุงููุญุฏุงุช: ${properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === property).length}</p>
                                </div>
                                <div class="property-actions">
                                    <button onclick="editPropertyData('${property}')" class="btn-edit">
                                        <i class="fas fa-edit"></i> ุชุนุฏูู ุงูุนูุงุฑ
                                    </button>
                                    <button onclick="viewPropertyUnits('${property}')" class="btn-view">
                                        <i class="fas fa-eye"></i> ุนุฑุถ ุงููุญุฏุงุช
                                    </button>
                                    ${isMobileDevice() ? `
                                    <button onclick="showDeedInfoForProperty('${property}', '${cityName}')" class="btn-deed" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
                                        <i class="fas fa-file-contract"></i> ูุนูููุงุช ุงูุตู
                                    </button>
                                    ` : ''}
                                    <button onclick="showPropertyStatistics('${property}')" class="btn-secondary">
                                        <i class="fas fa-chart-bar"></i> ุงูุฅุญุตุงุฆูุงุช
                                    </button>
                                    <button onclick="deleteProperty('${property}')" class="btn-delete">
                                        <i class="fas fa-trash"></i> ุญุฐู ุงูุนูุงุฑ
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') :
                    `<div class="no-properties">
                        <i class="fas fa-search"></i>
                        <h4>ูุง ุชูุฌุฏ ุนูุงุฑุงุช</h4>
                        <p>${selectedCityFilter === 'all' ? 'ูุง ุชูุฌุฏ ุนูุงุฑุงุช ูุถุงูุฉ ุจุนุฏ' : `ูุง ุชูุฌุฏ ุนูุงุฑุงุช ูู ูุฏููุฉ ${selectedCityFilter}`}</p>
                    </div>`
                }
            </div>
        </div>
    `;
}

// ุนุฑุถ ุชุจููุจ ุงููุญุฏุงุช
function renderUnitsTab() {
    const properties = getUniqueProperties();

    return `
        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-plus-circle"></i> ุฅุถุงูุฉ ูุญุฏุฉ ุฌุฏูุฏุฉ</h3>
            </div>
            <div class="property-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>ุงูุนูุงุฑ:</label>
                        <select id="unitPropertyName">
                            <option value="">ุงุฎุชุฑ ุงูุนูุงุฑ</option>
                            ${properties.map(property => `<option value="${property}">${property}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุฑูู ุงููุญุฏุฉ:</label>
                        <input type="text" id="unitNumber" placeholder="ุฑูู ุงููุญุฏุฉ">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ุงููุณุงุญุฉ:</label>
                        <input type="number" id="unitArea" placeholder="ุงููุณุงุญุฉ ุจุงููุชุฑ ุงููุฑุจุน">
                    </div>
                    <div class="form-group">
                        <label>ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก:</label>
                        <input type="text" id="unitElectricity" placeholder="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก">
                    </div>
                </div>
                <button class="btn-primary" onclick="addNewUnit()">
                    <i class="fas fa-plus"></i> ุฅุถุงูุฉ ุงููุญุฏุฉ
                </button>
            </div>
        </div>

        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-search"></i> ุงูุจุญุซ ูู ุงููุญุฏุงุช</h3>
            </div>
            <div class="units-search">
                <input type="text" id="unitsSearchInput" placeholder="ุงุจุญุซ ุนู ูุญุฏุฉ..." onkeyup="searchUnits()">
                <select id="unitsFilterProperty" onchange="filterUnitsByProperty()">
                    <option value="">ุฌููุน ุงูุนูุงุฑุงุช</option>
                    ${properties.map(property => `<option value="${property}">${property}</option>`).join('')}
                </select>
            </div>
            <div id="unitsResults" class="units-results">
                <!-- ุณูุชู ููุก ุงููุชุงุฆุฌ ููุง -->
            </div>
        </div>
    `;
}

// ุนุฑุถ ุชุจููุจ ุฏูุฌ ุงููุญุฏุงุช
function renderMergeTab() {
    const properties = getUniqueProperties();

    return `
        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-layer-group"></i> ุฏูุฌ ุงููุญุฏุงุช</h3>
                <p>ููููู ุฏูุฌ ุนุฏุฉ ูุญุฏุงุช ูู ุจุทุงูุฉ ูุงุญุฏุฉ ุจุฑูู ุนูุฏ ูุงุญุฏ</p>
            </div>
            <div class="property-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>ุงูุนูุงุฑ:</label>
                        <select id="mergePropertyName" onchange="loadUnitsForMerge()">
                            <option value="">ุงุฎุชุฑ ุงูุนูุงุฑ</option>
                            ${properties.map(property => `<option value="${property}">${property}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุฑูู ุงูุนูุฏ ุงูุฌุฏูุฏ:</label>
                        <input type="text" id="mergeContractNumber" placeholder="ุฑูู ุงูุนูุฏ ุงูููุญุฏ">
                    </div>
                </div>
                <div class="form-group">
                    <label>ุงููุญุฏุงุช ุงููุชุงุญุฉ ููุฏูุฌ:</label>
                    <div id="availableUnitsForMerge" class="units-checkbox-list">
                        <!-- ุณูุชู ููุก ุงููุญุฏุงุช ููุง -->
                    </div>
                </div>
                <button class="btn-primary" onclick="mergeSelectedUnits()">
                    <i class="fas fa-layer-group"></i> ุฏูุฌ ุงููุญุฏุงุช ุงููุญุฏุฏุฉ
                </button>
            </div>
        </div>

        <div class="property-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> ุงููุญุฏุงุช ุงููุฏููุฌุฉ</h3>
            </div>
            <div id="mergedUnitsDisplay" class="merged-units-display">
                ${renderMergedUnits()}
            </div>
        </div>
    `;
}

// ุนุฑุถ ุงููุญุฏุงุช ุงููุฏููุฌุฉ
function renderMergedUnits() {
    const mergedContracts = {};

    // ุชุฌููุน ุงููุญุฏุงุช ุญุณุจ ุฑูู ุงูุนูุฏ
    properties.forEach(property => {
        if (property['ุฑูู ุงูุนูุฏ']) {
            const contractKey = `${property['ุฑูู ุงูุนูุฏ']}_${property['ุงุณู ุงูุนูุงุฑ']}`;
            if (!mergedContracts[contractKey]) {
                mergedContracts[contractKey] = {
                    contractNumber: property['ุฑูู ุงูุนูุฏ'],
                    propertyName: property['ุงุณู ุงูุนูุงุฑ'],
                    units: [],
                    totalArea: 0
                };
            }
            mergedContracts[contractKey].units.push(property['ุฑูู  ุงููุญุฏุฉ ']);
            mergedContracts[contractKey].totalArea += parseFloat(property['ุงููุณุงุญุฉ']) || 0;
        }
    });

    // ุนุฑุถ ุงูุนููุฏ ุงูุชู ุชุญุชูู ุนูู ุฃูุซุฑ ูู ูุญุฏุฉ ูุงุญุฏุฉ
    const mergedOnly = Object.values(mergedContracts).filter(contract => contract.units.length > 1);

    if (mergedOnly.length === 0) {
        return '<p class="no-data">ูุง ุชูุฌุฏ ูุญุฏุงุช ูุฏููุฌุฉ ุญุงููุงู</p>';
    }

    return mergedOnly.map(contract => `
        <div class="merged-contract-item">
            <div class="contract-header">
                <h4>ุนูุฏ ุฑูู: ${contract.contractNumber}</h4>
                <span class="property-name">${contract.propertyName}</span>
            </div>
            <div class="contract-details">
                <p><strong>ุงููุญุฏุงุช:</strong> ${contract.units.join(', ')}</p>
                <p><strong>ุฅุฌูุงูู ุงููุณุงุญุฉ:</strong> ${contract.totalArea.toLocaleString()} ูยฒ</p>
                <p><strong>ุนุฏุฏ ุงููุญุฏุงุช:</strong> ${contract.units.length}</p>
            </div>
            <div class="contract-actions">
                <button onclick="editMergedContract('${contract.contractNumber}', '${contract.propertyName}')" class="btn-edit">
                    <i class="fas fa-edit"></i> ุชุญุฑูุฑ
                </button>
                <button onclick="splitMergedContract('${contract.contractNumber}', '${contract.propertyName}')" class="btn-danger">
                    <i class="fas fa-unlink"></i> ูุตู ุงููุญุฏุงุช
                </button>
            </div>
        </div>
    `).join('');
}

// ุชุจุฏูู ุงูุชุจููุจุงุช ูู ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช
function showPropertyTab(tabName) {
    // ุฅุฎูุงุก ุฌููุน ุงูุชุจููุจุงุช
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // ุฅุฒุงูุฉ ุงูุชูุนูู ูู ุฌููุน ุฃุฒุฑุงุฑ ุงูุชุจููุจุงุช ูุงูุณุงูุฏ ุจุงุฑ
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // ุฅุธูุงุฑ ุงูุชุจููุจ ุงููุญุฏุฏ
    const targetTab = document.getElementById(`${tabName}-tab`);
    if (targetTab) {
        targetTab.classList.add('active');
    }

    // ุชูุนูู ุงูุฒุฑ ุงููุญุฏุฏ ูู ุงูุณุงูุฏ ุจุงุฑ
    const sidebarBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (sidebarBtn) {
        sidebarBtn.classList.add('active');
    }

    // ุชุญุฏูุซ ูุญุชูู ุงูุชุจููุจ ุฅุฐุง ูุฒู ุงูุฃูุฑ
    if (tabName === 'units') {
        loadUnitsResults();
    } else if (tabName === 'merge') {
        const mergedDisplay = document.getElementById('mergedUnitsDisplay');
        if (mergedDisplay) {
            mergedDisplay.innerHTML = renderMergedUnits();
        }
    }

    // ุฅุนุงุฏุฉ ุชุทุจูู ุญูุงูุฉ ุญููู ุงูุจุญุซ ุจุนุฏ ุชุญุฏูุซ ุงููุญุชูู
    setTimeout(() => {
        protectSearchFields();
    }, 100);
}

// ุญูุงูุฉ ุฎุงุตุฉ ูุญููู ุงูุจุญุซ
function protectSearchFields() {
    const searchFields = document.querySelectorAll('#propertySearch, #unitSearch, #mergeSearch, input[type="search"], input[placeholder*="ุจุญุซ"]');

    searchFields.forEach(field => {
        if (field && !field.hasAttribute('data-protected')) {
            field.setAttribute('data-protected', 'true');
            addSearchProtection(field);

            // ุญูุงูุฉ ุฅุถุงููุฉ ููุฌูุงู
            if (isMobileDevice() || window.innerWidth <= 768) {
                field.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    this.setAttribute('data-prevent-sidebar-close', 'true');
                });

                field.addEventListener('touchend', function(e) {
                    e.stopPropagation();
                });
            }
        }
    });
}

// ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ
function addNewProperty() {
    const name = document.getElementById('newPropertyName').value.trim();
    const city = document.getElementById('newPropertyCity').value;
    const deed = document.getElementById('newPropertyDeed').value.trim();
    const area = document.getElementById('newPropertyArea').value;
    const registry = document.getElementById('newPropertyRegistry').value.trim();
    const location = document.getElementById('newPropertyLocation').value.trim();
    const owner = document.getElementById('newPropertyOwner').value.trim();

    if (!name || !city) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนูุงุฑ ูุงุฎุชูุงุฑ ุงููุฏููุฉ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุนูุงุฑ ุจููุณ ุงูุงุณู ูู ููุณ ุงููุฏููุฉ
    const existingProperty = properties.find(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === name && p['ุงููุฏููุฉ'] === city
    );

    if (existingProperty) {
        alert('ููุฌุฏ ุนูุงุฑ ุจููุณ ุงูุงุณู ูู ูุฐู ุงููุฏููุฉ ุจุงููุนู');
        return;
    }

    // โ ูุง ูุชู ุฅูุดุงุก ุฃู ูุญุฏุงุช ุงูุชุฑุงุถูุฉ ุฃู ุฃุณุงุณูุฉ
    // ุงูุนูุงุฑ ููุญูุธ ูู propertyDefinitions ููุท
    console.log(`๐ ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ ุจุฏูู ูุญุฏุงุช: "${name}" ูู ูุฏููุฉ "${city}"`);
    console.log('โ ูู ูุชู ุฅูุดุงุก ุฃู ูุญุฏุงุช ุงูุชุฑุงุถูุฉ - ุงูุนูุงุฑ ุณููุญูุธ ูู ุงูุชุนุฑููุงุช ููุท');

    // ุญูุธ ูุนูููุงุช ุงูุนูุงุฑ ูู ุชุนุฑููุงุช ุงูุนูุงุฑุงุช ุฃูุถุงู
    const propertyDefinition = {
        name: name,
        city: city,
        deed: deed || null,
        area: area || null,
        registry: registry || null,
        location: location || null,
        owner: owner || null,
        createdAt: new Date().toISOString()
    };

    propertyDefinitions.push(propertyDefinition);
    localStorage.setItem('propertyDefinitions', JSON.stringify(propertyDefinitions));

    // โ ูุง ูุชู ุญูุธ ุฃู ูุญุฏุฉ ูู Supabase ูุฃูู ูุง ุชูุฌุฏ ูุญุฏุฉ
    console.log('๐พ ุชู ุญูุธ ุชุนุฑูู ุงูุนูุงุฑ ูู propertyDefinitions ููุท');

    // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู (properties ููุทุ ุจุฏูู ูุญุฏุฉ ุฌุฏูุฏุฉ)
    localStorage.setItem('properties', JSON.stringify(properties));

    console.log(`โ ุชู ุฅุถุงูุฉ ุงูุนูุงุฑ "${name}" ูู ูุฏููุฉ "${city}" ุจูุฌุงุญ`);

    // ุฅุถุงูุฉ ุงููุฏููุฉ ุฅูู ูุงุฆูุฉ ุงููุฏู ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
    if (!cityDefinitions.includes(city)) {
        cityDefinitions.push(city);
        localStorage.setItem('cityDefinitions', JSON.stringify(cityDefinitions));
        console.log(`๐พ ุชู ุฅุถุงูุฉ ุงููุฏููุฉ "${city}" ุชููุงุฆูุงู`);
    }

    // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
    alert('ุชู ุฅุถุงูุฉ ุงูุนูุงุฑ ุจูุฌุงุญ!\n\nโ ุงูุนูุงุฑ ุฌุงูุฒ ูุฅุถุงูุฉ ุงููุญุฏุงุช.\n\nุงุฐูุจ ุฅูู ุชุจููุจ "ุงููุญุฏุงุช" ูุฅุถุงูุฉ ูุญุฏุงุช ููุนูุงุฑ.');

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู
    initializeApp();

    // ุชูุธูู ุงููููุฐุฌ
    document.getElementById('newPropertyName').value = '';
    document.getElementById('newPropertyCity').value = '';
    document.getElementById('newPropertyDeed').value = '';
    document.getElementById('newPropertyArea').value = '';
    document.getElementById('newPropertyRegistry').value = '';
    document.getElementById('newPropertyLocation').value = '';
    document.getElementById('newPropertyOwner').value = '';

    // ุชุญุฏูุซ ูุญุชูู ุงูุชุจููุจ
    updatePropertiesDisplay();
}

// ุฅุถุงูุฉ ูุญุฏุฉ ุฌุฏูุฏุฉ
function addNewUnit() {
    const propertyName = document.getElementById('unitPropertyName').value;
    const unitNumber = document.getElementById('unitNumber').value.trim();
    const unitArea = document.getElementById('unitArea').value;
    const electricity = document.getElementById('unitElectricity').value.trim();

    if (!propertyName || !unitNumber) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนูุงุฑ ูุฅุฏุฎุงู ุฑูู ุงููุญุฏุฉ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูุญุฏุฉ ุจููุณ ุงูุฑูู ูู ููุณ ุงูุนูุงุฑ
    const existingUnit = properties.find(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName && p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber
    );

    if (existingUnit) {
        alert('ููุฌุฏ ูุญุฏุฉ ุจููุณ ุงูุฑูู ูู ูุฐุง ุงูุนูุงุฑ ุจุงููุนู');
        return;
    }

    // โ ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุนูุงุฑ ุงูุฃุณุงุณูุฉ ูู ูุตุฏุฑูู
    let baseProperty = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    let isFromDefinitions = false; // ูุชุบูุฑ ูุชุชุจุน ูุตุฏุฑ ุงูุนูุงุฑ

    // ุฅุฐุง ูู ููุฌุฏ ูู propertiesุ ุงุจุญุซ ูู propertyDefinitions
    if (!baseProperty) {
        const propertyDefinition = propertyDefinitions.find(p => p.name === propertyName);
        if (propertyDefinition) {
            isFromDefinitions = true; // ุงูุนูุงุฑ ูู ุงูุชุนุฑููุงุช

            // ุชุญููู ุชุนุฑูู ุงูุนูุงุฑ ุฅูู ุชูุณูู properties
            baseProperty = {
                'ุงุณู ุงูุนูุงุฑ': propertyDefinition.name,
                'ุงููุฏููุฉ': propertyDefinition.city,
                'ุฑูู ุงูุตู': propertyDefinition.deed,
                'ูุณุงุญุฉุงูุตู': propertyDefinition.area,
                'ุงูุณุฌู ุงูุนููู ': propertyDefinition.registry,
                'ูููุน ุงูุนูุงุฑ': propertyDefinition.location,
                'ุงููุงูู': propertyDefinition.owner,
                // ููู ุงูุชุฑุงุถูุฉ ููุญููู ุงููุทููุจุฉ
                'ุงูุงุฑุชูุงุน': null,
                'ุงุณู ุงููุณุชุฃุฌุฑ': null,
                'ุฑูู ุงูุนูุฏ': null,
                'ูููุฉ  ุงูุงูุฌุงุฑ ': null,
                'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ': null,
                'ุชุงุฑูุฎ ุงูููุงูุฉ': null,
                'ุงูุงุฌูุงูู': 0.0,
                'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก': null,
                'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ': null,
                'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู': null,
                'ูุจูุบ ุงููุณุท ุงูุงูู': null,
                'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู': null,
                'ูุจูุบ ุงููุณุท ุงูุซุงูู': null,
                'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท': null,
                'ููุน ุงูุนูุฏ': 'ุณููู'
            };
            console.log(`โ ุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ "${propertyName}" ูู propertyDefinitions ูุชุญูููู`);
        }
    } else {
        console.log(`โ ุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ "${propertyName}" ูู properties`);
    }

    if (!baseProperty) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ุงููุญุฏุฏ ูู ุงููุธุงู');
        return;
    }

    // ุฅูุดุงุก ุงููุญุฏุฉ ุงูุฌุฏูุฏุฉ
    const newUnit = {
        ...baseProperty,
        'ุฑูู  ุงููุญุฏุฉ ': unitNumber,
        'ุงููุณุงุญุฉ': parseFloat(unitArea) || null,
        'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก': electricity || null,
        'ุงุณู ุงููุณุชุฃุฌุฑ': null,
        'ุฑูู ุงูุนูุฏ': null,
        'ูููุฉ  ุงูุงูุฌุงุฑ ': null,
        'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ': null,
        'ุชุงุฑูุฎ ุงูููุงูุฉ': null,
        'ุงูุงุฌูุงูู': 0.0,
        'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ': null,
        'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู': null,
        'ูุจูุบ ุงููุณุท ุงูุงูู': null,
        'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู': null,
        'ูุจูุบ ุงููุณุท ุงูุซุงูู': null,
        'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท': null
    };

    // ุฅุถุงูุฉ ุงููุญุฏุฉ ุฅูู ุงููุตูููุฉ
    properties.push(newUnit);

    // โ ุฅุฐุง ูุงู ุงูุนูุงุฑ ูู propertyDefinitionsุ ุงุญุฐูู ูู ููุงู ูุชุฌูุจ ุงูุชูุฑุงุฑ
    if (isFromDefinitions) {
        const definitionIndex = propertyDefinitions.findIndex(p => p.name === propertyName);
        if (definitionIndex !== -1) {
            propertyDefinitions.splice(definitionIndex, 1);
            localStorage.setItem('propertyDefinitions', JSON.stringify(propertyDefinitions));
            console.log(`โ ุชู ุญุฐู ุงูุนูุงุฑ "${propertyName}" ูู propertyDefinitions ูุชุฌูุจ ุงูุชูุฑุงุฑ`);
        }
    }

    // ุญูุธ ูู Supabase ุฅุฐุง ูุงู ูุชููุฑุงู
    if (typeof savePropertyToSupabase === 'function') {
        savePropertyToSupabase(newUnit);
    }

    // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
    saveDataLocally();

    alert('ุชู ุฅุถุงูุฉ ุงููุญุฏุฉ ุจูุฌุงุญ!');

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู
    initializeApp();

    // ุชูุธูู ุงููููุฐุฌ
    document.getElementById('unitPropertyName').value = '';
    document.getElementById('unitNumber').value = '';
    document.getElementById('unitArea').value = '';
    document.getElementById('unitElectricity').value = '';

    // ุชุญุฏูุซ ูุญุชูู ุงูุชุจููุจ
    document.getElementById('units-tab').innerHTML = renderUnitsTab();
}

// ===== ูุธููุฉ ุญุฐู ุงููุญุฏุฉ =====
async function deleteUnit(unitNumber, propertyName) {
    console.log('๐ ุจุฏุก ูุธููุฉ ุญุฐู ุงููุญุฏุฉ:', { unitNumber, propertyName });

    // ุงูุชุญูู ูู ูุฌูุฏ ุงููุญุฏุฉ
    const unitIndex = properties.findIndex(p =>
        p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );

    console.log('๐ ููุฑุณ ุงููุญุฏุฉ ูู ุงููุตูููุฉ:', unitIndex);
    console.log('๐ ุฅุฌูุงูู ุนุฏุฏ ุงูุนูุงุฑุงุช:', properties.length);

    if (unitIndex === -1) {
        console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ูู ุงููุตูููุฉ');
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุญุฏุฏุฉ');
        return;
    }

    const unit = properties[unitIndex];

    // ูุงูุฐุฉ ุชุฃููุฏ ุงูุญุฐู
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay';
    confirmModal.style.display = 'flex';
    confirmModal.innerHTML = `
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #dc3545; margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i> ุชุฃููุฏ ุญุฐู ุงููุญุฏุฉ
                </h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404;">
                        <i class="fas fa-info-circle"></i>
                        <strong>ุชุญุฐูุฑ:</strong> ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!
                    </p>
                </div>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">ุจูุงูุงุช ุงููุญุฏุฉ ุงููุฑุงุฏ ุญุฐููุง:</h4>
                    <p><strong>ุฑูู ุงููุญุฏุฉ:</strong> ${unitNumber}</p>
                    <p><strong>ุงุณู ุงูุนูุงุฑ:</strong> ${propertyName}</p>
                    <p><strong>ุงููุฏููุฉ:</strong> ${unit['ุงููุฏููุฉ']}</p>
                    <p><strong>ุงููุณุชุฃุฌุฑ:</strong> ${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || 'ูุงุฑุบ'}</p>
                    <p><strong>ุฑูู ุงูุนูุฏ:</strong> ${unit['ุฑูู ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</p>
                </div>
                <p style="color: #dc3545; font-weight: 600; text-align: center;">
                    ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุญุฏุฉ ูุฌููุน ูุฑููุงุชูุงุ
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeDeleteConfirmModal()">
                    <i class="fas fa-times"></i> ุฅูุบุงุก
                </button>
                <button class="modal-action-btn print-btn" onclick="confirmDeleteUnit('${unitNumber}', '${propertyName}', ${unitIndex})"
                        style="background: #dc3545; border-color: #dc3545;">
                    <i class="fas fa-trash"></i> ุชุฃููุฏ ุงูุญุฐู
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(confirmModal);
}

// ุฅุบูุงู ูุงูุฐุฉ ุชุฃููุฏ ุงูุญุฐู
function closeDeleteConfirmModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// ุชุฃููุฏ ุญุฐู ุงููุญุฏุฉ
async function confirmDeleteUnit(unitNumber, propertyName, unitIndex) {
    // ุฅุบูุงู ูุงูุฐุฉ ุงูุชุฃููุฏ
    closeDeleteConfirmModal();

    // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.style.display = 'flex';
    loadingModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #dc3545; margin-bottom: 20px;"></i>
            <h3>ุฌุงุฑู ุญุฐู ุงููุญุฏุฉ...</h3>
            <p>ูุฑุฌู ุงูุงูุชุธุงุฑุ ุฌุงุฑู ุญุฐู ุงููุญุฏุฉ ูุฌููุน ูุฑููุงุชูุง</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        const unit = properties[unitIndex];
        console.log('๐๏ธ ุจุฏุก ุนูููุฉ ุญุฐู ุงููุญุฏุฉ:', unitNumber, 'ูู ุงูุนูุงุฑ:', propertyName);

        // 1. ุงุณุชุฎุฏุงู ุงูุญุฐู ุงููุชูุฏู ุงูุฌุฏูุฏ
        console.log('๐ง ุงุณุชุฎุฏุงู ุงูุญุฐู ุงููุชูุฏู ูุน ูุนุงูุฌุฉ ุงูุฑูุงุจุท...');

        const enhancedResult = await enhancedDeleteUnit(unit);

        if (enhancedResult.success) {
            console.log('โ ุชู ุงูุญุฐู ุงููุชูุฏู ุจูุฌุงุญ');

            // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
            loadingModal.remove();

            // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
            showSuccessMessage(
                'ุชู ุญุฐู ุงููุญุฏุฉ ุจูุฌุงุญ',
                `ุชู ุญุฐู ุงููุญุฏุฉ ูุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ููุงุฆูุงู (ูุญูู: ${enhancedResult.localDeleted || 0}, ุณุญุงุจู: ${enhancedResult.cloudDeleted || 0})`
            );

            // ุชุญุฏูุซ ุงููุงุฌูุฉ
            if (document.getElementById('units-tab')) {
                document.getElementById('units-tab').innerHTML = renderUnitsTab();
            }

            const searchResults = document.getElementById('unitSearchResults');
            if (searchResults) {
                const searchInput = document.getElementById('unitSearchInput');
                if (searchInput && searchInput.value.trim()) {
                    searchUnits();
                }
            }

            return; // ุงูุชูู ุจูุฌุงุญ
        } else {
            console.warn('โ๏ธ ูุดู ุงูุญุฐู ุงููุชูุฏูุ ุณูุชู ุงููุชุงุจุนุฉ ุจุงูุทุฑููุฉ ุงูุชูููุฏูุฉ');
        }

        // 2. Delete from Supabase with advanced foreign key handling
        console.log('๐ Starting advanced Supabase deletion process...');
        console.log('๐ Property data for deletion:', {
            unitNumber: unit['ุฑูู  ุงููุญุฏุฉ '],
            propertyName: unit['ุงุณู ุงูุนูุงุฑ'],
            city: unit['ุงููุฏููุฉ'],
            tenant: unit['ุงุณู ุงููุณุชุฃุฌุฑ'],
            contract: unit['ุฑูู ุงูุนูุฏ']
        });

        let deletionResult = { success: false, reason: 'UNKNOWN' };

        if (typeof deletePropertyFromSupabase === 'function') {
            try {
                // Show deletion progress to user
                showToast('ุฌุงุฑู ุญุฐู ุงููุญุฏุฉ ูุน ุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ...', 'info');

                // Advanced deletion with foreign key handling
                deletionResult = await deletePropertyFromSupabase(unit);
                console.log('๐ Advanced deletion result:', deletionResult);

                // Handle results and provide detailed user feedback
                if (deletionResult.success) {
                    console.log('โ Property and all related data successfully deleted from Supabase');

                    // Show detailed success message
                    const successMessage = deletionResult.deletedCount > 0
                        ? `ุชู ุญุฐู ุงููุญุฏุฉ ููุงุฆูุงู ูุน ุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ (${deletionResult.deletedCount} ุณุฌู)`
                        : 'ุชู ุญุฐู ุงููุญุฏุฉ ููุงุฆูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช';

                    showToast(successMessage, 'success');

                    // Log deletion details
                    if (deletionResult.deletionResults) {
                        const successfulDeletions = deletionResult.deletionResults.filter(r => r.success);
                        console.log(`๐ Deletion summary: ${successfulDeletions.length}/${deletionResult.deletionResults.length} records deleted successfully`);
                    }

                    // Trigger UI refresh after successful deletion
                    setTimeout(() => {
                        console.log('๐ Triggering data refresh after successful advanced deletion');
                        renderData();
                    }, 1000);

                } else {
                    // Handle different failure scenarios with more context
                    let userMessage = '';
                    let logLevel = 'warn';

                    switch (deletionResult.reason) {
                        case 'NO_CLIENT':
                            userMessage = 'ุชู ุงูุญุฐู ูุญููุงู ููุท - ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูุชุตูุฉ';
                            break;
                        case 'NOT_FOUND':
                            userMessage = 'ุชู ุงูุญุฐู ูุญููุงู - ุงููุญุฏุฉ ุบูุฑ ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช';
                            break;
                        case 'LOCAL_ONLY':
                            userMessage = 'ุชู ุงูุญุฐู ุจูุฌุงุญ - ุงููุญุฏุฉ ูู ุชูู ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช';
                            break;
                        case 'SCHEMA_ERROR':
                            userMessage = 'ุฎุทุฃ ูู ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุชู ุงูุญุฐู ูุญููุงู ููุท';
                            logLevel = 'error';
                            break;
                        case 'CRITICAL_ERROR':
                            userMessage = 'ุฎุทุฃ ุฎุทูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุชู ุงูุญุฐู ูุญููุงู ููุท';
                            logLevel = 'error';
                            break;
                        default:
                            // Check if partial deletion occurred
                            if (deletionResult.deletionResults) {
                                const partialSuccess = deletionResult.deletionResults.some(r => r.success);
                                if (partialSuccess) {
                                    userMessage = 'ุชู ุญุฐู ุจุนุถ ุงูุจูุงูุงุช - ูุฏ ุชุญุชุงุฌ ูุงุณุชุฎุฏุงู "ุงูุญุฐู ุงููุชูุฏู"';
                                    logLevel = 'warning';
                                } else {
                                    userMessage = 'ูุดู ุงูุญุฐู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุชู ุงูุญุฐู ูุญููุงู ููุท';
                                }
                            } else {
                                userMessage = 'ูุดู ุงูุญุฐู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุชู ุงูุญุฐู ูุญููุงู ููุท';
                            }
                    }

                    console[logLevel]('โ๏ธ Advanced Supabase deletion failed:', deletionResult);
                    showToast(userMessage, logLevel === 'error' ? 'error' : 'warning');

                    // Provide specific guidance based on failure type
                    if (deletionResult.reason === 'NOT_FOUND') {
                        setTimeout(() => {
                            showToast('ุงุณุชุฎุฏู "ุชุดุฎูุต ูุงุนุฏุฉ ุงูุจูุงูุงุช" ููุชุญูู ูู ุงูุชุฒุงูู', 'info');
                        }, 3000);
                    } else if (deletionResult.deletionResults && deletionResult.deletionResults.some(r => r.error && r.error.includes('foreign key'))) {
                        setTimeout(() => {
                            showToast('ุงุณุชุฎุฏู ุฒุฑ "ุญุฐู ูุชูุฏู ูุน ุงูุฑูุงุจุท" ูุญุฐู ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ', 'info');
                        }, 3000);
                    }
                }

            } catch (error) {
                console.error('โ Critical error during advanced Supabase deletion:', error);
                showToast('ุฎุทุฃ ุฎุทูุฑ ูู ุญุฐู ุงููุญุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช', 'error');

                // Log comprehensive error information
                console.error('Advanced deletion error details:', {
                    message: error.message,
                    stack: error.stack,
                    propertyData: unit,
                    timestamp: new Date().toISOString()
                });
            }
        } else {
            console.warn('โ๏ธ deletePropertyFromSupabase function not available');
            showToast('ุชู ุงูุญุฐู ูุญููุงู ููุท - ูุธููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูุชููุฑุฉ', 'warning');
        }

        // 3. ุญุฐู ุงููุญุฏุฉ ูู ุงููุตูููุฉ ุงููุญููุฉ
        console.log('๐พ ุญุฐู ุงููุญุฏุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉ...');
        properties.splice(unitIndex, 1);
        console.log('โ ุชู ุญุฐู ุงููุญุฏุฉ ูู ุงููุตูููุฉ ุงููุญููุฉ');

        // 4. ุญุฐู ุงููุฑููุงุช ุงููุญููุฉ
        console.log('๐ ุญุฐู ุงููุฑููุงุช ุงููุญููุฉ...');
        const propertyKey = `${propertyName}_${unitNumber}`;
        if (attachments[propertyKey]) {
            delete attachments[propertyKey];
            localStorage.setItem('propertyAttachments', JSON.stringify(attachments));
            console.log('โ ุชู ุญุฐู ุงููุฑููุงุช ุงููุญููุฉ');
        } else {
            console.log('โน๏ธ ูุง ุชูุฌุฏ ูุฑููุงุช ูุญููุฉ ููุญุฐู');
        }

        // 5. ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        console.log('๐พ ุญูุธ ุงูุจูุงูุงุช ูุญููุงู...');
        saveDataLocally();
        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู');

        // 6. ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู
        console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู...');
        initializeApp();
        console.log('โ ุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู');

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        showSuccessMessage('ุชู ุญุฐู ุงููุญุฏุฉ ุจูุฌุงุญ', 'ุชู ุญุฐู ุงููุญุฏุฉ ูุฌููุน ูุฑููุงุชูุง ุจูุฌุงุญ ูู ุงููุธุงู');

        // ุชุญุฏูุซ ูุงุฌูุฉ ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช ุฅุฐุง ูุงูุช ููุชูุญุฉ
        if (document.getElementById('units-tab')) {
            document.getElementById('units-tab').innerHTML = renderUnitsTab();
        }

        // ุชุญุฏูุซ ูุชุงุฆุฌ ุงูุจุญุซ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
        const searchResults = document.getElementById('unitSearchResults');
        if (searchResults) {
            // ุฅุนุงุฏุฉ ุชุดุบูู ุงูุจุญุซ ุงูุญุงูู
            const searchInput = document.getElementById('unitSearchInput');
            if (searchInput && searchInput.value.trim()) {
                searchUnits();
            }
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุฉ:', error);

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        // ุญุชู ูู ูุดู ุงูุญุฐู ุงูุณุญุงุจูุ ูุญุงูู ุงูุญุฐู ุงููุญูู
        try {
            console.log('๐ ูุญุงููุฉ ุงูุญุฐู ุงููุญูู ููุท...');

            // ุญุฐู ุงููุญุฏุฉ ูู ุงููุตูููุฉ ุงููุญููุฉ
            const localUnitIndex = properties.findIndex(p =>
                p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
            );

            if (localUnitIndex !== -1) {
                properties.splice(localUnitIndex, 1);
                console.log('โ ุชู ุญุฐู ุงููุญุฏุฉ ูุญููุงู');

                // ุญุฐู ุงููุฑููุงุช ุงููุญููุฉ
                const propertyKey = `${propertyName}_${unitNumber}`;
                if (attachments[propertyKey]) {
                    delete attachments[propertyKey];
                    localStorage.setItem('propertyAttachments', JSON.stringify(attachments));
                    console.log('โ ุชู ุญุฐู ุงููุฑููุงุช ูุญููุงู');
                }

                // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
                saveDataLocally();

                // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู
                initializeApp();

                // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ูุน ุชุญุฐูุฑ
                showSuccessMessage(
                    'ุชู ุญุฐู ุงููุญุฏุฉ ูุญููุงู',
                    'ุชู ุญุฐู ุงููุญุฏุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉ. ูุฏ ุชุญุชุงุฌ ูุญุฐููุง ูุฏููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ.'
                );

                // ุชุญุฏูุซ ูุงุฌูุฉ ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช ุฅุฐุง ูุงูุช ููุชูุญุฉ
                if (document.getElementById('units-tab')) {
                    document.getElementById('units-tab').innerHTML = renderUnitsTab();
                }

                // ุชุญุฏูุซ ูุชุงุฆุฌ ุงูุจุญุซ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
                const searchResults = document.getElementById('unitSearchResults');
                if (searchResults) {
                    const searchInput = document.getElementById('unitSearchInput');
                    if (searchInput && searchInput.value.trim()) {
                        searchUnits();
                    }
                }

                return; // ูุฌุญ ุงูุญุฐู ุงููุญูู
            }
        } catch (localError) {
            console.error('โ ูุดู ุงูุญุฐู ุงููุญูู ุฃูุถุงู:', localError);
        }

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ
        showErrorMessage(
            'ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุฉ',
            'ูุดู ูู ุญุฐู ุงููุญุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงูุงุชุตุงู ุจุงูุฏุนู ุงูููู.'
        );
    }
}

// ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
function showSuccessMessage(title, message) {
    const successModal = document.createElement('div');
    successModal.className = 'modal-overlay';
    successModal.style.display = 'flex';
    successModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 450px;">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 20px;"></i>
            <h3 style="color: #28a745; margin-bottom: 15px;">${title}</h3>
            <p style="color: #6c757d; margin-bottom: 25px;">${message}</p>
            <button class="modal-action-btn print-btn" onclick="closeModal()"
                    style="background: #28a745; border-color: #28a745;">
                <i class="fas fa-check"></i> ููุงูู
            </button>
        </div>
    `;
    document.body.appendChild(successModal);
}

// ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ูุน callback (ููุชุญุฏูุซ ุจุนุฏ ุงูุถุบุท ุนูู ููุงูู)
function showSuccessMessageWithCallback(title, message, callback) {
    console.log('๐ ุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ ูุน callback:', title);

    const successModal = document.createElement('div');
    successModal.className = 'modal-overlay';
    successModal.style.display = 'flex';
    successModal.style.zIndex = '10000';

    // ุฅูุดุงุก ID ูุฑูุฏ ููุฒุฑ
    const uniqueId = 'successOkBtn_' + Date.now();

    successModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 500px;">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 20px;"></i>
            <h3 style="color: #28a745; margin-bottom: 15px;">${title}</h3>
            <div style="color: #6c757d; margin-bottom: 25px; white-space: pre-line; text-align: right;">${message}</div>
            <button class="modal-action-btn print-btn" id="${uniqueId}"
                    style="background: #28a745; border-color: #28a745; font-size: 16px; padding: 12px 30px;">
                <i class="fas fa-check"></i> ููุงูู
            </button>
        </div>
    `;

    document.body.appendChild(successModal);

    // ุฅุถุงูุฉ ุญุฏุซ ููุฒุฑ
    const okBtn = document.getElementById(uniqueId);
    if (okBtn) {
        okBtn.addEventListener('click', function() {
            console.log('โ ุชู ุงูุถุบุท ุนูู ููุงููุ ุชูููุฐ callback...');

            // ุฅุบูุงู ุงููุงูุฐุฉ
            successModal.remove();

            // ุชูููุฐ ุงูู callback ุจุนุฏ ุฅุบูุงู ุงููุงูุฐุฉ
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 100); // ุชุฃุฎูุฑ ูุตูุฑ ููุชุฃูุฏ ูู ุฅุบูุงู ุงููุงูุฐุฉ
            }
        });
    } else {
        console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฒุฑ ููุงูู');
    }

    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู (ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงููุงูุฐุฉ)
    successModal.addEventListener('click', function(e) {
        if (e.target === successModal) {
            console.log('โ ุฅุบูุงู ุงููุงูุฐุฉ ุจุงูุถุบุท ุฎุงุฑุฌูุงุ ุชูููุฐ callback...');
            successModal.remove();
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 100);
            }
        }
    });

    // ุฅุถุงูุฉ ุญุฏุซ ูููุชุงุญ Enter
    const handleEnterKey = function(e) {
        if (e.key === 'Enter' && document.body.contains(successModal)) {
            console.log('โ ุฅุบูุงู ุงููุงูุฐุฉ ุจููุชุงุญ Enterุ ุชูููุฐ callback...');
            e.preventDefault();
            successModal.remove();
            document.removeEventListener('keydown', handleEnterKey);
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 100);
            }
        }
    };

    document.addEventListener('keydown', handleEnterKey);
}

// ุฅุธูุงุฑ ุดุฑูุท ุงูุชูุฏู ูุน callback
function showProgressModal(title, progressFunction, onComplete) {
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.style.zIndex = '10000';

    progressModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 450px;">
            <i class="fas fa-save" style="font-size: 3rem; color: #007bff; margin-bottom: 20px;"></i>
            <h3 style="color: #007bff; margin-bottom: 15px;">${title}</h3>
            <div style="margin-bottom: 20px;">
                <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 10px;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="color: #6c757d; font-size: 14px;">ุฌุงุฑู ุงูุชุญุถูุฑ...</div>
                <div id="progressPercent" style="color: #007bff; font-weight: bold; margin-top: 5px;">0%</div>
            </div>
        </div>
    `;

    document.body.appendChild(progressModal);

    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');

    // ุฏุงูุฉ ุชุญุฏูุซ ุงูุชูุฏู
    const updateProgress = (percent, text) => {
        progressBar.style.width = percent + '%';
        progressText.textContent = text;
        progressPercent.textContent = percent + '%';

        // ุชุบููุฑ ุงูููู ุนูุฏ ุงูุงูุชูุงุก
        if (percent >= 100) {
            progressBar.style.background = 'linear-gradient(90deg, #28a745, #1e7e34)';
            progressPercent.style.color = '#28a745';
        }
    };

    // ุชูููุฐ ุฏุงูุฉ ุงูุชูุฏู
    progressFunction(updateProgress).then((result) => {
        // ุฅุบูุงู ุดุฑูุท ุงูุชูุฏู ุจุนุฏ ุซุงููุฉ
        setTimeout(() => {
            progressModal.remove();
            if (onComplete && typeof onComplete === 'function') {
                onComplete(result);
            }
        }, 1000);
    }).catch((error) => {
        console.error('ุฎุทุฃ ูู ุดุฑูุท ุงูุชูุฏู:', error);
        progressModal.remove();
        if (onComplete && typeof onComplete === 'function') {
            onComplete(false);
        }
    });
}

// ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ
function showErrorMessage(title, message) {
    const errorModal = document.createElement('div');
    errorModal.className = 'modal-overlay';
    errorModal.style.display = 'flex';
    errorModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 450px;">
            <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 20px;"></i>
            <h3 style="color: #dc3545; margin-bottom: 15px;">${title}</h3>
            <p style="color: #6c757d; margin-bottom: 25px;">${message}</p>
            <button class="modal-action-btn close-btn" onclick="closeModal()">
                <i class="fas fa-times"></i> ุฅุบูุงู
            </button>
        </div>
    `;
    document.body.appendChild(errorModal);
}

// ===== ูุธููุฉ ุญุฐู ุงูุนูุงุฑ ุจุงููุงูู (ูุญุณูุฉ ูููุธุงู ุงูุฌุฏูุฏ) =====
async function deleteProperty(propertyName) {
    // ุงูุจุญุซ ุนู ุฌููุน ูุญุฏุงุช ุงูุนูุงุฑ
    const propertyUnits = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);

    // ุงูุจุญุซ ูู ุชุนุฑููุงุช ุงูุนูุงุฑุงุช ุฃูุถุงู
    const propertyDefinition = propertyDefinitions.find(p => p.name === propertyName);

    if (propertyUnits.length === 0 && !propertyDefinition) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ุงููุญุฏุฏ');
        return;
    }

    console.log(`๐๏ธ ุญุฐู ุงูุนูุงุฑ "${propertyName}": ${propertyUnits.length} ูุญุฏุฉุ ุชุนุฑูู ููุฌูุฏ: ${!!propertyDefinition}`);

    // ูุงูุฐุฉ ุชุฃููุฏ ุงูุญุฐู
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay';
    confirmModal.style.display = 'flex';
    confirmModal.innerHTML = `
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3 style="color: #dc3545; margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i> ุชุฃููุฏ ุญุฐู ุงูุนูุงุฑ
                </h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404;">
                        <i class="fas fa-info-circle"></i>
                        <strong>ุชุญุฐูุฑ:</strong> ุณูุชู ุญุฐู ุงูุนูุงุฑ ูุฌููุน ูุญุฏุงุชู ููุฑููุงุชู ููุงุฆูุงู!
                    </p>
                </div>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">ุจูุงูุงุช ุงูุนูุงุฑ ุงููุฑุงุฏ ุญุฐูู:</h4>
                    <p><strong>ุงุณู ุงูุนูุงุฑ:</strong> ${propertyName}</p>
                    <p><strong>ุงููุฏููุฉ:</strong> ${propertyUnits.length > 0 ? propertyUnits[0]['ุงููุฏููุฉ'] : 'ุบูุฑ ูุญุฏุฏ'}</p>
                    <p><strong>ุนุฏุฏ ุงููุญุฏุงุช:</strong> ${propertyUnits.length} ูุญุฏุฉ</p>
                    <p><strong>ุงููุญุฏุงุช:</strong> ${propertyUnits.map(u => u['ุฑูู  ุงููุญุฏุฉ ']).join(', ')}</p>
                </div>
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #721c24; font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i>
                        ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ูุงููุฑููุงุช ุงููุฑุชุจุทุฉ ุจูุฐุง ุงูุนูุงุฑ
                    </p>
                </div>
                <p style="color: #dc3545; font-weight: 600; text-align: center;">
                    ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุนูุงุฑ ุจุงููุงููุ
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeDeleteConfirmModal()">
                    <i class="fas fa-times"></i> ุฅูุบุงุก
                </button>
                <button class="modal-action-btn print-btn" onclick="confirmDeleteProperty('${propertyName}')"
                        style="background: #dc3545; border-color: #dc3545;">
                    <i class="fas fa-trash"></i> ุชุฃููุฏ ุงูุญุฐู
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(confirmModal);
}

// ุชุฃููุฏ ุญุฐู ุงูุนูุงุฑ (ูุญุณู ูููุธุงู ุงูุฌุฏูุฏ)
async function confirmDeleteProperty(propertyName) {
    // ุฅุบูุงู ูุงูุฐุฉ ุงูุชุฃููุฏ
    closeDeleteConfirmModal();

    // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.style.display = 'flex';
    loadingModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #dc3545; margin-bottom: 20px;"></i>
            <h3>ุฌุงุฑู ุญุฐู ุงูุนูุงุฑ...</h3>
            <p>ูุฑุฌู ุงูุงูุชุธุงุฑุ ุฌุงุฑู ุญุฐู ุงูุนูุงุฑ ูุฌููุน ูุญุฏุงุชู ููุฑููุงุชู</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        // ุงูุจุญุซ ุนู ุฌููุน ูุญุฏุงุช ุงูุนูุงุฑ
        const propertyUnits = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);

        // ุงูุจุญุซ ูู ุชุนุฑููุงุช ุงูุนูุงุฑุงุช
        const propertyDefinition = propertyDefinitions.find(p => p.name === propertyName);

        console.log(`๐๏ธ ุญุฐู ุงูุนูุงุฑ "${propertyName}": ${propertyUnits.length} ูุญุฏุฉุ ุชุนุฑูู ููุฌูุฏ: ${!!propertyDefinition}`);

        // ุญุฐู ูู ูุญุฏุฉ ุจุงุณุชุฎุฏุงู ุงูุญุฐู ุงููุชูุฏู
        for (const unit of propertyUnits) {
            console.log(`๐ง ุญุฐู ูุชูุฏู ูููุญุฏุฉ: ${unit['ุฑูู  ุงููุญุฏุฉ ']}`);

            // ุงุณุชุฎุฏุงู ุงูุญุฐู ุงููุชูุฏู
            const result = await enhancedDeleteUnit(unit);

            if (result.success) {
                console.log(`โ ุชู ุญุฐู ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ุจูุฌุงุญ`);

                // ุฅุถุงูุฉ ุณุฌู ุงูุชุชุจุน ูุญุฐู ุงููุญุฏุฉ
                try {
                    await addChangeLog(
                        OPERATION_TYPES.DELETE_UNIT,
                        unit,
                        {},
                        {
                            reason: 'ุญุฐู ูุญุฏุฉ ูู ุงูุนูุงุฑ',
                            previousTenant: unit['ุงุณู ุงููุณุชุฃุฌุฑ']
                        }
                    );
                } catch (trackingError) {
                    console.error('โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ุญุฐู ุงููุญุฏุฉ:', trackingError);
                }
            } else {
                console.warn(`โ๏ธ ูุดู ุญุฐู ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช`);

                // ุญุฐู ูุญูู ูุจุฏูู
                const propertyKey = `${propertyName}_${unit['ุฑูู  ุงููุญุฏุฉ ']}`;
                if (attachments[propertyKey]) {
                    delete attachments[propertyKey];
                }
            }
        }

        // ุญุฐู ุฌููุน ูุญุฏุงุช ุงูุนูุงุฑ ูู ุงููุตูููุฉ ุงููุญููุฉ
        for (let i = properties.length - 1; i >= 0; i--) {
            if (properties[i]['ุงุณู ุงูุนูุงุฑ'] === propertyName) {
                properties.splice(i, 1);
            }
        }

        // ุญุฐู ุชุนุฑูู ุงูุนูุงุฑ ูู propertyDefinitions
        if (propertyDefinition) {
            const definitionIndex = propertyDefinitions.findIndex(p => p.name === propertyName);
            if (definitionIndex !== -1) {
                propertyDefinitions.splice(definitionIndex, 1);
                localStorage.setItem('propertyDefinitions', JSON.stringify(propertyDefinitions));
                console.log(`โ ุชู ุญุฐู ุชุนุฑูู ุงูุนูุงุฑ "${propertyName}" ูู propertyDefinitions`);
            }
        }

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        localStorage.setItem('propertyAttachments', JSON.stringify(attachments));
        saveDataLocally();

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู
        initializeApp();

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        showSuccessMessage('ุชู ุญุฐู ุงูุนูุงุฑ ุจูุฌุงุญ', `ุชู ุญุฐู ุงูุนูุงุฑ "${propertyName}" ูุฌููุน ูุญุฏุงุชู ููุฑููุงุชู ุจูุฌุงุญ ูู ุงููุธุงู`);

        // ุชุญุฏูุซ ูุงุฌูุฉ ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช ุฅุฐุง ูุงูุช ููุชูุญุฉ
        if (document.getElementById('properties-tab')) {
            document.getElementById('properties-tab').innerHTML = renderPropertiesTab();
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงูุนูุงุฑ:', error);

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ
        showErrorMessage('ุฎุทุฃ ูู ุญุฐู ุงูุนูุงุฑ', error.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน ุฃุซูุงุก ุญุฐู ุงูุนูุงุฑ');
    }
}

// ===== ูุธููุฉ ุงุฎุชุจุงุฑ ุดุงููุฉ ูุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช =====
async function testPropertyManagementFunctions() {
    console.log('๐งช ุจุฏุก ุงุฎุชุจุงุฑ ูุธุงุฆู ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช...');

    const testResults = {
        addProperty: false,
        editProperty: false,
        deleteProperty: false,
        addUnit: false,
        editUnit: false,
        deleteUnit: false,
        attachments: false,
        search: false,
        supabaseSync: false
    };

    try {
        // ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ
        console.log('๐ ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ...');
        const testProperty = {
            'ุฑูู  ุงููุญุฏุฉ ': 'TEST_001',
            'ุงููุฏููุฉ': 'ุงูุฑูุงุถ',
            'ุงุณู ุงูุนูุงุฑ': 'ุนูุงุฑ ุงุฎุชุจุงุฑ',
            'ูููุน ุงูุนูุงุฑ': 'ูููุน ุงุฎุชุจุงุฑ',
            'ุงูุงุฑุชูุงุน': null,
            'ุฑูู ุงูุตู': '12345',
            'ุงูุณุฌู ุงูุนููู ': '67890',
            'ูุณุงุญุฉุงูุตู': '500',
            'ุงููุงูู': 'ูุงูู ุงุฎุชุจุงุฑ',
            'ุงุณู ุงููุณุชุฃุฌุฑ': null,
            'ุฑูู ุงูุนูุฏ': null,
            'ูููุฉ  ุงูุงูุฌุงุฑ ': null,
            'ุงููุณุงุญุฉ': null,
            'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ': null,
            'ุชุงุฑูุฎ ุงูููุงูุฉ': null,
            'ุงูุงุฌูุงูู': 0.0,
            'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก': null,
            'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ': null,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู': null,
            'ูุจูุบ ุงููุณุท ุงูุงูู': null,
            'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู': null,
            'ูุจูุบ ุงููุณุท ุงูุซุงูู': null,
            'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท': null,
            'ููุน ุงูุนูุฏ': 'ุณููู'
        };

        properties.push(testProperty);
        if (typeof savePropertyToSupabase === 'function') {
            await savePropertyToSupabase(testProperty);
        }
        testResults.addProperty = true;
        console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุงูุนูุงุฑ');

        // ุงุฎุชุจุงุฑ ุชุนุฏูู ุงูุนูุงุฑ
        console.log('โ๏ธ ุงุฎุชุจุงุฑ ุชุนุฏูู ุงูุนูุงุฑ...');
        const propertyIndex = properties.findIndex(p => p['ุฑูู  ุงููุญุฏุฉ '] === 'TEST_001');
        if (propertyIndex !== -1) {
            properties[propertyIndex]['ุงููุงูู'] = 'ูุงูู ูุญุฏุซ';
            if (typeof savePropertyToSupabase === 'function') {
                await savePropertyToSupabase(properties[propertyIndex]);
            }
            testResults.editProperty = true;
            console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุชุนุฏูู ุงูุนูุงุฑ');
        }

        // ุงุฎุชุจุงุฑ ุงูุจุญุซ
        console.log('๐ ุงุฎุชุจุงุฑ ูุธููุฉ ุงูุจุญุซ...');
        const searchResults = properties.filter(p =>
            p['ุงุณู ุงูุนูุงุฑ'].includes('ุงุฎุชุจุงุฑ') ||
            p['ุฑูู  ุงููุญุฏุฉ '].includes('TEST')
        );
        if (searchResults.length > 0) {
            testResults.search = true;
            console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุงูุจุญุซ');
        }

        // ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจู Supabase
        console.log('โ๏ธ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจู Supabase...');
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('count', { count: 'exact', head: true });

                if (!error) {
                    testResults.supabaseSync = true;
                    console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจู Supabase');
                }
            } catch (supabaseError) {
                console.log('โ๏ธ Supabase ุบูุฑ ูุชููุฑ ุฃู ุบูุฑ ูููู');
            }
        }

        // ุงุฎุชุจุงุฑ ุญุฐู ุงูุนูุงุฑ (ุชูุธูู)
        console.log('๐๏ธ ุงุฎุชุจุงุฑ ุญุฐู ุงูุนูุงุฑ...');
        const deleteIndex = properties.findIndex(p => p['ุฑูู  ุงููุญุฏุฉ '] === 'TEST_001');
        if (deleteIndex !== -1) {
            const unitToDelete = properties[deleteIndex];
            if (typeof deletePropertyFromSupabase === 'function') {
                await deletePropertyFromSupabase(unitToDelete);
            }
            properties.splice(deleteIndex, 1);
            testResults.deleteProperty = true;
            console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุญุฐู ุงูุนูุงุฑ');
        }

        // ุญูุธ ุงูุจูุงูุงุช
        saveDataLocally();

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ:', error);
    }

    // ุนุฑุถ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ
    const passedTests = Object.values(testResults).filter(result => result).length;
    const totalTests = Object.keys(testResults).length;

    console.log('๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ:');
    console.log(`โ ูุฌุญ: ${passedTests}/${totalTests} ุงุฎุชุจุงุฑ`);
    console.log('ุชูุงุตูู ุงููุชุงุฆุฌ:', testResults);

    // ุฅุธูุงุฑ ุฑุณุงูุฉ ูููุณุชุฎุฏู
    const testModal = document.createElement('div');
    testModal.className = 'modal-overlay';
    testModal.style.display = 'flex';
    testModal.innerHTML = `
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #28a745; margin: 0;">
                    <i class="fas fa-check-circle"></i> ูุชุงุฆุฌ ุงุฎุชุจุงุฑ ุงููุธุงู
                </h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #155724; font-weight: 600; text-align: center;">
                        ูุฌุญ ${passedTests} ูู ${totalTests} ุงุฎุชุจุงุฑ
                    </p>
                </div>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <h4 style="margin: 0 0 10px 0;">ุชูุงุตูู ุงูุงุฎุชุจุงุฑุงุช:</h4>
                    <ul style="margin: 0; padding-right: 20px;">
                        <li style="color: ${testResults.addProperty ? '#28a745' : '#dc3545'}">
                            ${testResults.addProperty ? 'โ' : 'โ'} ุฅุถุงูุฉ ุงูุนูุงุฑุงุช
                        </li>
                        <li style="color: ${testResults.editProperty ? '#28a745' : '#dc3545'}">
                            ${testResults.editProperty ? 'โ' : 'โ'} ุชุนุฏูู ุงูุนูุงุฑุงุช
                        </li>
                        <li style="color: ${testResults.deleteProperty ? '#28a745' : '#dc3545'}">
                            ${testResults.deleteProperty ? 'โ' : 'โ'} ุญุฐู ุงูุนูุงุฑุงุช
                        </li>
                        <li style="color: ${testResults.search ? '#28a745' : '#dc3545'}">
                            ${testResults.search ? 'โ' : 'โ'} ุงูุจุญุซ ูุงูููุชุฑุฉ
                        </li>
                        <li style="color: ${testResults.supabaseSync ? '#28a745' : '#dc3545'}">
                            ${testResults.supabaseSync ? 'โ' : 'โ'} ุงูุชุฒุงูู ูุน Supabase
                        </li>
                    </ul>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-action-btn print-btn" onclick="closeModal()"
                        style="background: #28a745; border-color: #28a745;">
                    <i class="fas fa-check"></i> ููุงูู
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(testModal);

    return testResults;
}

// ===== ูุธููุฉ ุชุจุฏูู ุชุฑุชูุจ ุงูุนุฑุถ =====
function toggleSortOrder() {
    // ุชุจุฏูู ุญุงูุฉ ุงูุชุฑุชูุจ
    isReverseOrder = !isReverseOrder;

    // ุชุญุฏูุซ ูุต ูุฃููููุฉ ุงูุฒุฑ
    const sortBtn = document.getElementById('sort-order-btn');
    if (sortBtn) {
        if (isReverseOrder) {
            sortBtn.innerHTML = '<i class="fas fa-sort-amount-down"></i> ุงูุฃุญุฏุซ ุฃููุงู';
            sortBtn.title = 'ุชุฑุชูุจ ุนูุณู - ุงูุฃุญุฏุซ ุฃููุงู';
        } else {
            sortBtn.innerHTML = '<i class="fas fa-sort-amount-up"></i> ุงูุฃูุฏู ุฃููุงู';
            sortBtn.title = 'ุชุฑุชูุจ ุทุจูุนู - ุงูุฃูุฏู ุฃููุงู';
        }
    }

    // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุจูุงูุงุช ุจุงูุชุฑุชูุจ ุงูุฌุฏูุฏ
    renderData();

    // ุญูุธ ุงูุฅุนุฏุงุฏ ูู ุงูุชุฎุฒูู ุงููุญูู
    localStorage.setItem('sortOrder', isReverseOrder ? 'reverse' : 'normal');

    // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุฃููุฏ
    const message = isReverseOrder ? 'ุชู ุชุบููุฑ ุงูุชุฑุชูุจ ุฅูู: ุงูุฃุญุฏุซ ุฃููุงู' : 'ุชู ุชุบููุฑ ุงูุชุฑุชูุจ ุฅูู: ุงูุฃูุฏู ุฃููุงู';
    showToast(message, 'success');
}

// ุชุญููู ุฅุนุฏุงุฏ ุงูุชุฑุชูุจ ูู ุงูุชุฎุฒูู ุงููุญูู
function loadSortOrderSetting() {
    const savedOrder = localStorage.getItem('sortOrder');
    if (savedOrder) {
        isReverseOrder = savedOrder === 'reverse';

        // ุชุญุฏูุซ ุงูุฒุฑ ุญุณุจ ุงูุฅุนุฏุงุฏ ุงููุญููุธ
        const sortBtn = document.getElementById('sort-order-btn');
        if (sortBtn) {
            if (isReverseOrder) {
                sortBtn.innerHTML = '<i class="fas fa-sort-amount-down"></i> ุงูุฃุญุฏุซ ุฃููุงู';
                sortBtn.title = 'ุชุฑุชูุจ ุนูุณู - ุงูุฃุญุฏุซ ุฃููุงู';
            } else {
                sortBtn.innerHTML = '<i class="fas fa-sort-amount-up"></i> ุงูุฃูุฏู ุฃููุงู';
                sortBtn.title = 'ุชุฑุชูุจ ุทุจูุนู - ุงูุฃูุฏู ุฃููุงู';
            }
        }
    }
}

// ===== Advanced Database Diagnostics Tool =====
async function debugDatabaseSync() {
    console.log('๐ Starting comprehensive database diagnostics...');

    if (!supabaseClient) {
        console.error('โ Supabase client not available');
        showToast('Supabase ุบูุฑ ูุชุตู - ูุง ูููู ุชุดุฎูุต ูุงุนุฏุฉ ุงูุจูุงูุงุช', 'error');
        return;
    }

    try {
        // Show loading indicator
        const diagnosticsModal = document.createElement('div');
        diagnosticsModal.className = 'modal-overlay';
        diagnosticsModal.style.display = 'flex';
        diagnosticsModal.innerHTML = `
            <div class="modal-box" style="max-width: 90vw; max-height: 90vh; overflow-y: auto;">
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-cog fa-spin" style="font-size: 2rem; color: #3b82f6; margin-bottom: 20px;"></i>
                    <h3>Running Database Diagnostics...</h3>
                    <div id="diagnostics-content">
                        <p>Analyzing database structure and content...</p>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">ร</button>
            </div>
        `;
        document.body.appendChild(diagnosticsModal);

        const contentDiv = diagnosticsModal.querySelector('#diagnostics-content');

        // Step 1: Test connection
        contentDiv.innerHTML += '<p>โ Testing Supabase connection...</p>';
        const { data: connectionTest, error: connectionError } = await supabaseClient
            .from('properties')
            .select('count', { count: 'exact', head: true });

        if (connectionError) {
            throw new Error(`Connection failed: ${connectionError.message}`);
        }

        // Step 2: Get database schema
        contentDiv.innerHTML += '<p>โ Fetching database schema...</p>';
        const { data: schemaData, error: schemaError } = await supabaseClient
            .from('properties')
            .select('*')
            .limit(1);

        if (schemaError) {
            throw new Error(`Schema fetch failed: ${schemaError.message}`);
        }

        const dbFields = schemaData.length > 0 ? Object.keys(schemaData[0]) : [];
        console.log('๐ Database schema fields:', dbFields);

        // Step 3: Get all properties from database
        contentDiv.innerHTML += '<p>โ Fetching all database records...</p>';
        const { data: allDbProperties, error: fetchError } = await supabaseClient
            .from('properties')
            .select('*')
            .order('id', { ascending: false });

        if (fetchError) {
            throw new Error(`Data fetch failed: ${fetchError.message}`);
        }

        // Step 4: Analyze local vs database data
        contentDiv.innerHTML += '<p>โ Analyzing data synchronization...</p>';

        const localCount = properties.length;
        const dbCount = allDbProperties.length;

        // Find potential matches and mismatches
        const localUnits = new Set(properties.map(p => p['ุฑูู  ุงููุญุฏุฉ ']));
        const dbUnits = new Set(allDbProperties.map(p => p.unit_number));

        const onlyLocal = [...localUnits].filter(unit => !dbUnits.has(unit));
        const onlyDb = [...dbUnits].filter(unit => !localUnits.has(unit));
        const inBoth = [...localUnits].filter(unit => dbUnits.has(unit));

        // Generate comprehensive report
        const report = `
            <div style="text-align: left; font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 10px 0;">
                <h4>๐ Database Diagnostics Report</h4>

                <h5>๐ Data Counts:</h5>
                <ul>
                    <li>Local properties: ${localCount}</li>
                    <li>Database properties: ${dbCount}</li>
                    <li>Difference: ${Math.abs(localCount - dbCount)}</li>
                </ul>

                <h5>๐๏ธ Database Schema:</h5>
                <ul>
                    ${dbFields.map(field => `<li>${field}</li>`).join('')}
                </ul>

                <h5>๐ Synchronization Analysis:</h5>
                <ul>
                    <li>Units in both local and database: ${inBoth.length}</li>
                    <li>Units only in local: ${onlyLocal.length}</li>
                    <li>Units only in database: ${onlyDb.length}</li>
                </ul>

                ${onlyLocal.length > 0 ? `
                <h5>โ๏ธ Units only in local storage:</h5>
                <ul>
                    ${onlyLocal.slice(0, 10).map(unit => `<li>${unit}</li>`).join('')}
                    ${onlyLocal.length > 10 ? `<li>... and ${onlyLocal.length - 10} more</li>` : ''}
                </ul>
                ` : ''}

                ${onlyDb.length > 0 ? `
                <h5>โ๏ธ Units only in database:</h5>
                <ul>
                    ${onlyDb.slice(0, 10).map(unit => `<li>${unit}</li>`).join('')}
                    ${onlyDb.length > 10 ? `<li>... and ${onlyDb.length - 10} more</li>` : ''}
                </ul>
                ` : ''}

                <h5>๐ Sample Database Records:</h5>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <tr style="background: #ddd;">
                        <th style="border: 1px solid #ccc; padding: 5px;">ID</th>
                        <th style="border: 1px solid #ccc; padding: 5px;">Unit Number</th>
                        <th style="border: 1px solid #ccc; padding: 5px;">Property Name</th>
                        <th style="border: 1px solid #ccc; padding: 5px;">City</th>
                    </tr>
                    ${allDbProperties.slice(0, 10).map(prop => `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 5px;">${prop.id}</td>
                            <td style="border: 1px solid #ccc; padding: 5px;">${prop.unit_number || 'N/A'}</td>
                            <td style="border: 1px solid #ccc; padding: 5px;">${prop.property_name || 'N/A'}</td>
                            <td style="border: 1px solid #ccc; padding: 5px;">${prop.city || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </table>

                <h5>๐ก Recommendations:</h5>
                <ul>
                    ${localCount !== dbCount ? '<li>Consider using "Reload from Cloud" to sync data</li>' : ''}
                    ${onlyLocal.length > 0 ? '<li>Some local data may need to be uploaded to database</li>' : ''}
                    ${onlyDb.length > 0 ? '<li>Some database records are not in local storage</li>' : ''}
                    <li>Use "Cleanup Database" to remove duplicates</li>
                </ul>
            </div>
        `;

        contentDiv.innerHTML = report;

        // Log detailed information to console
        console.log('๐ Diagnostics Summary:', {
            localCount,
            dbCount,
            dbFields,
            synchronization: {
                inBoth: inBoth.length,
                onlyLocal: onlyLocal.length,
                onlyDb: onlyDb.length
            }
        });

        console.log('๐ Sample database records:');
        console.table(allDbProperties.slice(0, 10));

        console.log('๐ Sample local records:');
        console.table(properties.slice(0, 10).map(p => ({
            unit_number: p['ุฑูู  ุงููุญุฏุฉ '],
            property_name: p['ุงุณู ุงูุนูุงุฑ'],
            city: p['ุงููุฏููุฉ'],
            tenant_name: p['ุงุณู ุงููุณุชุฃุฌุฑ']
        })));

        console.log('ุชู ุฅููุงู ุชุดุฎูุต ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุฑุงุฌุน ุงููุชุงุฆุฌ');

    } catch (error) {
        console.error('โ Error during database diagnostics:', error);

        const errorModal = document.querySelector('.modal-overlay');
        if (errorModal) {
            errorModal.querySelector('#diagnostics-content').innerHTML = `
                <div style="color: red; text-align: center;">
                    <h4>โ Diagnostics Failed</h4>
                    <p>Error: ${error.message}</p>
                    <p>Check console for detailed error information</p>
                </div>
            `;
        }

        showToast('ูุดู ูู ุชุดุฎูุต ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุฑุงุฌุน ูุญุฏุฉ ุงูุชุญูู', 'error');
    }
}

// ===== ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู Supabase =====
async function reloadFromSupabase() {
    console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู Supabase...');

    if (!supabaseClient) {
        alert('Supabase ุบูุฑ ูุชุตู');
        return;
    }

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        const loadingModal = document.createElement('div');
        loadingModal.className = 'modal-overlay';
        loadingModal.style.display = 'flex';
        loadingModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3b82f6; margin-bottom: 20px;"></i>
                <h3>ุฌุงุฑู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช...</h3>
                <p>ูุฑุฌู ุงูุงูุชุธุงุฑุ ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>
            </div>
        `;
        document.body.appendChild(loadingModal);

        // ุชุญููู ุงูุจูุงูุงุช ูู Supabase
        const { data: supabaseProperties, error } = await supabaseClient
            .from('properties')
            .select('*')
            .order('id', { ascending: false });

        if (error) {
            throw new Error(`ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช: ${error.message}`);
        }

        // ุชุญููู ุงูุจูุงูุงุช ุฅูู ุงูุชูุณูู ุงููุญูู
        properties = supabaseProperties.map(convertSupabaseToLocal);

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        saveDataLocally();

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู
        initializeApp();

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        showSuccessMessage(
            'ุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจูุฌุงุญ',
            `ุชู ุชุญููู ${supabaseProperties.length} ูุญุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช`
        );

        console.log(`โ ุชู ุชุญููู ${supabaseProperties.length} ูุญุฏุฉ ูู Supabase`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช:', error);

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        const loadingModal = document.querySelector('.modal-overlay');
        if (loadingModal) {
            loadingModal.remove();
        }

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ
        showErrorMessage('ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุงูุชุญููู', error.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน');
    }
}

// ===== ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช =====
async function cleanupDatabase() {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ\nุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูููุฑุฑุฉ ูุงููุงุฑุบุฉ.')) {
        return;
    }

    console.log('๐งน ุจุฏุก ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...');

    if (!supabaseClient) {
        alert('Supabase ุบูุฑ ูุชุตู');
        return;
    }

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        const loadingModal = document.createElement('div');
        loadingModal.className = 'modal-overlay';
        loadingModal.style.display = 'flex';
        loadingModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-broom fa-spin" style="font-size: 2rem; color: #e67e22; margin-bottom: 20px;"></i>
                <h3>ุฌุงุฑู ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...</h3>
                <p>ูุฑุฌู ุงูุงูุชุธุงุฑุ ุฌุงุฑู ุญุฐู ุงูุจูุงูุงุช ุงูููุฑุฑุฉ ูุงููุงุฑุบุฉ</p>
            </div>
        `;
        document.body.appendChild(loadingModal);

        // ุฌูุจ ุฌููุน ุงูุจูุงูุงุช
        const { data: allProperties, error } = await supabaseClient
            .from('properties')
            .select('*')
            .order('id', { ascending: true });

        if (error) {
            throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช: ${error.message}`);
        }

        console.log(`๐ ุชู ุฌูุจ ${allProperties.length} ูุญุฏุฉ ููุชูุธูู`);

        // ุงูุนุซูุฑ ุนูู ุงูุจูุงูุงุช ุงูููุฑุฑุฉ
        const duplicates = [];
        const seen = new Set();

        allProperties.forEach(property => {
            const key = `${property.unit_number}_${property.property_name}_${property.city}`;
            if (seen.has(key)) {
                duplicates.push(property.id);
            } else {
                seen.add(key);
            }
        });

        console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${duplicates.length} ูุญุฏุฉ ููุฑุฑุฉ`);

        // ุญุฐู ุงูุจูุงูุงุช ุงูููุฑุฑุฉ
        let deletedCount = 0;
        for (const id of duplicates) {
            try {
                const { error: deleteError } = await supabaseClient
                    .from('properties')
                    .delete()
                    .eq('id', id);

                if (!deleteError) {
                    deletedCount++;
                    console.log(`โ ุชู ุญุฐู ุงููุญุฏุฉ ุงูููุฑุฑุฉ ID: ${id}`);
                }
            } catch (deleteError) {
                console.error(`โ ูุดู ุญุฐู ุงููุญุฏุฉ ${id}:`, deleteError);
            }
        }

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        // ุฅุธูุงุฑ ุงููุชุงุฆุฌ
        showSuccessMessage(
            'ุชู ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ',
            `ุชู ุญุฐู ${deletedCount} ูุญุฏุฉ ููุฑุฑุฉ ูู ุฃุตู ${duplicates.length}`
        );

        console.log(`โ ุชู ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุญุฐู ${deletedCount} ูุญุฏุฉ ููุฑุฑุฉ`);

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
        await reloadFromSupabase();

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', error);

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        const loadingModal = document.querySelector('.modal-overlay');
        if (loadingModal) {
            loadingModal.remove();
        }

        showErrorMessage('ุฎุทุฃ ูู ุงูุชูุธูู', error.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน');
    }
}

// ===== Database Sync Verification =====
async function verifyDatabaseSync() {
    console.log('๐ Verifying database synchronization...');

    if (!supabaseClient) {
        showToast('Supabase ุบูุฑ ูุชุตู', 'error');
        return false;
    }

    try {
        // Get current database state
        const { data: dbProperties, error } = await supabaseClient
            .from('properties')
            .select('id, unit_number, property_name, city')
            .order('id', { ascending: false });

        if (error) {
            console.error('โ Failed to fetch database properties:', error);
            return false;
        }

        // Compare with local data
        const localUnits = new Set(properties.map(p => p['ุฑูู  ุงููุญุฏุฉ ']));
        const dbUnits = new Set(dbProperties.map(p => p.unit_number));

        const syncStatus = {
            localCount: properties.length,
            dbCount: dbProperties.length,
            inSync: localUnits.size === dbUnits.size,
            onlyLocal: [...localUnits].filter(unit => !dbUnits.has(unit)),
            onlyDb: [...dbUnits].filter(unit => !localUnits.has(unit))
        };

        console.log('๐ Sync verification result:', syncStatus);

        if (syncStatus.inSync && syncStatus.onlyLocal.length === 0 && syncStatus.onlyDb.length === 0) {
            showToast('ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุฒุงููุฉ ุจุดูู ุตุญูุญ', 'success');
            return true;
        } else {
            showToast(`ุนุฏู ุชุฒุงูู ูู ุงูุจูุงูุงุช - ูุญูู: ${syncStatus.localCount}, ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${syncStatus.dbCount}`, 'warning');
            return false;
        }

    } catch (error) {
        console.error('โ Error verifying database sync:', error);
        showToast('ุฎุทุฃ ูู ุงูุชุญูู ูู ุชุฒุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช', 'error');
        return false;
    }
}

// ===== Enhanced Property Deletion with Verification =====
async function deletePropertyWithVerification(unitNumber, propertyName, city) {
    console.log('๐๏ธ Starting verified property deletion...');

    // Step 1: Verify the property exists locally
    const localProperty = properties.find(p =>
        p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber &&
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );

    if (!localProperty) {
        console.error('โ Property not found in local data');
        showToast('ุงููุญุฏุฉ ุบูุฑ ููุฌูุฏุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉ', 'error');
        return false;
    }

    // Step 2: Delete from Supabase first
    let dbDeletionSuccess = false;
    if (typeof deletePropertyFromSupabase === 'function') {
        const result = await deletePropertyFromSupabase(localProperty);
        dbDeletionSuccess = result.success;

        if (dbDeletionSuccess) {
            console.log('โ Property deleted from database successfully');
        } else {
            console.warn('โ๏ธ Database deletion failed:', result.reason);
        }
    }

    // Step 3: Delete from local data
    const originalLength = properties.length;
    properties = properties.filter(p =>
        !(p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName)
    );

    const localDeletionSuccess = properties.length < originalLength;

    // Step 4: Save updated local data
    if (localDeletionSuccess) {
        saveDataLocally();
        renderData();
    }

    // Step 5: Verify deletion
    setTimeout(async () => {
        const isInSync = await verifyDatabaseSync();
        if (!isInSync && dbDeletionSuccess) {
            console.log('โ๏ธ Sync verification failed after deletion');
            showToast('ุชู ุงูุญุฐู ูููู ูุฏ ุชุญุชุงุฌ ูุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช', 'warning');
        }
    }, 2000);

    return {
        localSuccess: localDeletionSuccess,
        dbSuccess: dbDeletionSuccess,
        overall: localDeletionSuccess && dbDeletionSuccess
    };
}

// ===== Force Delete Specific Units =====
async function forceDeleteSpecificUnits() {
    const targetUnits = ['TEST_001', 'TEST_UNIT_003', 'TEST_UNIT_001'];

    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุญุฏุงุช ุงูุชุงููุฉ ููุงุฆูุงูุ\n${targetUnits.join('\n')}\n\nุณูุชู ุงูุญุฐู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูุจูุงูุงุช ุงููุญููุฉ.`)) {
        return;
    }

    console.log('๐๏ธ ุจุฏุก ุงูุญุฐู ุงููุณุฑู ูููุญุฏุงุช ุงููุญุฏุฏุฉ:', targetUnits);

    // Show progress modal
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 600px;">
            <i class="fas fa-trash-alt fa-spin" style="font-size: 2rem; color: #e74c3c; margin-bottom: 20px;"></i>
            <h3>ุฌุงุฑู ุญุฐู ุงููุญุฏุงุช ุงููุญุฏุฏุฉ...</h3>
            <div id="deletion-progress" style="text-align: left; background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; font-family: monospace;">
                <p>๐ ุงูุจุญุซ ุนู ุงููุญุฏุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">ร</button>
        </div>
    `;
    document.body.appendChild(progressModal);

    const progressDiv = progressModal.querySelector('#deletion-progress');
    let deletionResults = [];

    try {
        if (!supabaseClient) {
            throw new Error('Supabase ุบูุฑ ูุชุตู');
        }

        // Step 1: Search for all target units in database
        progressDiv.innerHTML += '<p>๐ ุงูุจุญุซ ุนู ุงููุญุฏุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...</p>';

        const { data: allDbProperties, error: searchError } = await supabaseClient
            .from('properties')
            .select('*');

        if (searchError) {
            throw new Error(`ุฎุทุฃ ูู ุงูุจุญุซ: ${searchError.message}`);
        }

        progressDiv.innerHTML += `<p>โ ุชู ุฌูุจ ${allDbProperties.length} ุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>`;

        // Step 2: Find matching records for each target unit
        for (const targetUnit of targetUnits) {
            progressDiv.innerHTML += `<p>๐ ุงูุจุญุซ ุนู ุงููุญุฏุฉ: ${targetUnit}</p>`;

            // Search with multiple strategies
            const matchingRecords = allDbProperties.filter(record => {
                return (
                    record.unit_number === targetUnit ||
                    record.property_name === targetUnit ||
                    record.tenant_name === targetUnit ||
                    record.contract_number === targetUnit ||
                    JSON.stringify(record).includes(targetUnit)
                );
            });

            if (matchingRecords.length > 0) {
                progressDiv.innerHTML += `<p style="color: orange;">๐ ุชู ุงูุนุซูุฑ ุนูู ${matchingRecords.length} ุณุฌู ูููุญุฏุฉ ${targetUnit}</p>`;

                // Delete each matching record
                for (const record of matchingRecords) {
                    try {
                        const { error: deleteError } = await supabaseClient
                            .from('properties')
                            .delete()
                            .eq('id', record.id);

                        if (deleteError) {
                            progressDiv.innerHTML += `<p style="color: red;">โ ูุดู ุญุฐู ุงูุณุฌู ${record.id}: ${deleteError.message}</p>`;
                            deletionResults.push({ unit: targetUnit, id: record.id, success: false, error: deleteError.message });
                        } else {
                            progressDiv.innerHTML += `<p style="color: green;">โ ุชู ุญุฐู ุงูุณุฌู ${record.id} ูููุญุฏุฉ ${targetUnit}</p>`;
                            deletionResults.push({ unit: targetUnit, id: record.id, success: true });
                        }
                    } catch (deleteError) {
                        progressDiv.innerHTML += `<p style="color: red;">โ ุฎุทุฃ ูู ุญุฐู ุงูุณุฌู ${record.id}: ${deleteError.message}</p>`;
                        deletionResults.push({ unit: targetUnit, id: record.id, success: false, error: deleteError.message });
                    }
                }
            } else {
                progressDiv.innerHTML += `<p style="color: gray;">โน๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ${targetUnit} ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>`;
                deletionResults.push({ unit: targetUnit, id: null, success: false, error: 'Not found in database' });
            }
        }

        // Step 3: Delete from local data
        progressDiv.innerHTML += '<p>๐ ุญุฐู ุงููุญุฏุงุช ูู ุงูุจูุงูุงุช ุงููุญููุฉ...</p>';

        const originalLength = properties.length;
        properties = properties.filter(property => {
            const unitNumber = property['ุฑูู  ุงููุญุฏุฉ '];
            const propertyName = property['ุงุณู ุงูุนูุงุฑ'];
            const tenantName = property['ุงุณู ุงููุณุชุฃุฌุฑ'];

            // Check if this property matches any target unit
            const shouldDelete = targetUnits.some(target =>
                unitNumber === target ||
                propertyName === target ||
                tenantName === target ||
                JSON.stringify(property).includes(target)
            );

            if (shouldDelete) {
                progressDiv.innerHTML += `<p style="color: green;">โ ุชู ุญุฐู ${unitNumber || propertyName} ูู ุงูุจูุงูุงุช ุงููุญููุฉ</p>`;
            }

            return !shouldDelete;
        });

        const localDeletedCount = originalLength - properties.length;
        progressDiv.innerHTML += `<p style="color: blue;">๐ ุชู ุญุฐู ${localDeletedCount} ูุญุฏุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉ</p>`;

        // Step 4: Save and refresh
        saveDataLocally();
        renderData();

        // Step 5: Show final results
        const successfulDeletions = deletionResults.filter(r => r.success).length;
        const totalAttempts = deletionResults.length;

        progressDiv.innerHTML += `
            <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                <h4 style="color: #27ae60;">๐ ููุฎุต ุงููุชุงุฆุฌ:</h4>
                <ul style="text-align: right;">
                    <li>ุนูููุงุช ุญุฐู ูุงุฌุญุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${successfulDeletions}</li>
                    <li>ุฅุฌูุงูู ุงููุญุงููุงุช: ${totalAttempts}</li>
                    <li>ุญุฐู ูู ุงูุจูุงูุงุช ุงููุญููุฉ: ${localDeletedCount} ูุญุฏุฉ</li>
                </ul>
                <p style="color: #27ae60; font-weight: bold;">โ ุชู ุฅููุงู ุนูููุฉ ุงูุญุฐู ุงููุณุฑู</p>
            </div>
        `;

        // Auto-close modal after 10 seconds
        setTimeout(() => {
            if (progressModal.parentElement) {
                progressModal.remove();
            }
        }, 10000);

        showToast(`ุชู ุญุฐู ${successfulDeletions} ุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ู ${localDeletedCount} ูู ุงูุจูุงูุงุช ุงููุญููุฉ`, 'success');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุญุฐู ุงููุณุฑู:', error);
        progressDiv.innerHTML += `<p style="color: red;">โ ุฎุทุฃ ุฎุทูุฑ: ${error.message}</p>`;
        showToast('ูุดู ูู ุงูุญุฐู ุงููุณุฑู - ุฑุงุฌุน ุงูุชูุงุตูู', 'error');
    }
}

// ===== Nuclear Delete - Complete Cleanup =====
async function nuclearDeleteAllTestUnits() {
    if (!confirm('โ๏ธ ุชุญุฐูุฑ: ุณูุชู ุญุฐู ุฌููุน ุงููุญุฏุงุช ุงูุชู ุชุญุชูู ุนูู "TEST" ููุงุฆูุงู!\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.\n\nูู ุฃูุช ูุชุฃูุฏุ')) {
        return;
    }

    if (!confirm('ุชุฃููุฏ ููุงุฆู: ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุชู ุชุญุชูู ุนูู "TEST" ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูุจูุงูุงุช ุงููุญููุฉ.\n\nุงุถุบุท ููุงูู ูููุชุงุจุนุฉ.')) {
        return;
    }

    console.log('๐ฅ ุจุฏุก ุงูุญุฐู ุงูุดุงูู ูุฌููุน ูุญุฏุงุช TEST...');

    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 700px;">
            <i class="fas fa-bomb fa-spin" style="font-size: 2rem; color: #e74c3c; margin-bottom: 20px;"></i>
            <h3 style="color: #e74c3c;">ุงูุญุฐู ุงูุดุงูู ููุญุฏุงุช TEST</h3>
            <div id="nuclear-progress" style="text-align: left; background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; font-family: monospace; max-height: 400px; overflow-y: auto;">
                <p>๐ ุจุฏุก ุนูููุฉ ุงูุญุฐู ุงูุดุงูู...</p>
            </div>
        </div>
    `;
    document.body.appendChild(progressModal);

    const progressDiv = progressModal.querySelector('#nuclear-progress');

    try {
        // Step 1: Delete from Supabase
        if (supabaseClient) {
            progressDiv.innerHTML += '<p>โ๏ธ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช...</p>';

            // Get all records
            const { data: allRecords, error: fetchError } = await supabaseClient
                .from('properties')
                .select('*');

            if (fetchError) {
                throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช: ${fetchError.message}`);
            }

            progressDiv.innerHTML += `<p>๐ ุชู ุฌูุจ ${allRecords.length} ุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>`;

            // Find all TEST-related records
            const testRecords = allRecords.filter(record => {
                const recordString = JSON.stringify(record).toLowerCase();
                return recordString.includes('test');
            });

            progressDiv.innerHTML += `<p style="color: orange;">๐ฏ ุชู ุงูุนุซูุฑ ุนูู ${testRecords.length} ุณุฌู ูุญุชูู ุนูู "TEST"</p>`;

            // Delete each TEST record
            let deletedFromDb = 0;
            for (const record of testRecords) {
                try {
                    const { error: deleteError } = await supabaseClient
                        .from('properties')
                        .delete()
                        .eq('id', record.id);

                    if (!deleteError) {
                        deletedFromDb++;
                        progressDiv.innerHTML += `<p style="color: green;">โ ุญุฐู ุงูุณุฌู ${record.id}: ${record.unit_number || record.property_name || 'ุบูุฑ ูุญุฏุฏ'}</p>`;
                    } else {
                        progressDiv.innerHTML += `<p style="color: red;">โ ูุดู ุญุฐู ุงูุณุฌู ${record.id}: ${deleteError.message}</p>`;
                    }
                } catch (error) {
                    progressDiv.innerHTML += `<p style="color: red;">โ ุฎุทุฃ ูู ุญุฐู ุงูุณุฌู ${record.id}: ${error.message}</p>`;
                }
            }

            progressDiv.innerHTML += `<p style="color: blue;">๐ ุชู ุญุฐู ${deletedFromDb} ูู ุฃุตู ${testRecords.length} ุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>`;
        }

        // Step 2: Delete from local data
        progressDiv.innerHTML += '<p>๐ ุชูุธูู ุงูุจูุงูุงุช ุงููุญููุฉ...</p>';

        const originalLength = properties.length;
        properties = properties.filter(property => {
            const propertyString = JSON.stringify(property).toLowerCase();
            const containsTest = propertyString.includes('test');

            if (containsTest) {
                progressDiv.innerHTML += `<p style="color: green;">โ ุญุฐู ูุญูู: ${property['ุฑูู  ุงููุญุฏุฉ '] || property['ุงุณู ุงูุนูุงุฑ'] || 'ุบูุฑ ูุญุฏุฏ'}</p>`;
            }

            return !containsTest;
        });

        const localDeleted = originalLength - properties.length;
        progressDiv.innerHTML += `<p style="color: blue;">๐ ุชู ุญุฐู ${localDeleted} ูุญุฏุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉ</p>`;

        // Step 3: Clean localStorage
        progressDiv.innerHTML += '<p>๐พ ุชูุธูู ุงูุชุฎุฒูู ุงููุญูู...</p>';
        saveDataLocally();

        // Step 4: Refresh interface
        progressDiv.innerHTML += '<p>๐ ุชุญุฏูุซ ุงููุงุฌูุฉ...</p>';
        renderData();

        // Step 5: Final verification
        progressDiv.innerHTML += '<p>๐ ุงูุชุญูู ุงูููุงุฆู...</p>';

        setTimeout(async () => {
            if (supabaseClient) {
                const { data: remainingRecords } = await supabaseClient
                    .from('properties')
                    .select('*');

                const remainingTestRecords = remainingRecords?.filter(record =>
                    JSON.stringify(record).toLowerCase().includes('test')
                ) || [];

                progressDiv.innerHTML += `<p style="color: ${remainingTestRecords.length === 0 ? 'green' : 'orange'};">๐ ุณุฌูุงุช TEST ุงููุชุจููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${remainingTestRecords.length}</p>`;
            }

            const localTestRecords = properties.filter(property =>
                JSON.stringify(property).toLowerCase().includes('test')
            );

            progressDiv.innerHTML += `<p style="color: ${localTestRecords.length === 0 ? 'green' : 'orange'};">๐ ุณุฌูุงุช TEST ุงููุชุจููุฉ ูุญููุงู: ${localTestRecords.length}</p>`;

            progressDiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <h4 style="color: #27ae60;">๐ฅ ุงูุชูู ุงูุญุฐู ุงูุดุงูู!</h4>
                    <p style="color: #27ae60; font-weight: bold;">ุชู ุชูุธูู ุฌููุน ูุญุฏุงุช TEST ูู ุงููุธุงู</p>
                    <button onclick="location.reload()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                        ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ููุชุฃูุฏ
                    </button>
                </div>
            `;

            showToast('ุชู ุงูุญุฐู ุงูุดุงูู ูุฌููุน ูุญุฏุงุช TEST ุจูุฌุงุญ!', 'success');
        }, 2000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุญุฐู ุงูุดุงูู:', error);
        progressDiv.innerHTML += `<p style="color: red;">โ ุฎุทุฃ ุฎุทูุฑ: ${error.message}</p>`;
        showToast('ูุดู ูู ุงูุญุฐู ุงูุดุงูู', 'error');
    }
}

// ===== Advanced Delete with Foreign Key Handling =====
async function advancedDeleteWithForeignKeys() {
    if (!confirm('โ๏ธ ุญุฐู ูุชูุฏู: ุณูุชู ุญุฐู ุงููุญุฏุงุช ูุน ุฌููุน ุงูุณุฌูุงุช ุงููุฑุชุจุทุฉ!\n\nุณูุชู ุญุฐู:\n- ุงููุญุฏุงุช ูู ุฌุฏูู properties\n- ุงูุณุฌูุงุช ูู ุฌุฏูู activity_log\n- ุฃู ูุฑููุงุช ูุฑุชุจุทุฉ\n\nูู ุฃูุช ูุชุฃูุฏุ')) {
        return;
    }

    console.log('๐ง ุจุฏุก ุงูุญุฐู ุงููุชูุฏู ูุน ูุนุงูุฌุฉ Foreign Keys...');

    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px; max-width: 800px;">
            <i class="fas fa-cogs fa-spin" style="font-size: 2rem; color: #3498db; margin-bottom: 20px;"></i>
            <h3 style="color: #3498db;">ุงูุญุฐู ุงููุชูุฏู ูุน ูุนุงูุฌุฉ ุงูุฑูุงุจุท</h3>
            <div id="advanced-progress" style="text-align: left; background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; font-family: monospace; max-height: 500px; overflow-y: auto;">
                <p>๐ง ุจุฏุก ุงูุญุฐู ุงููุชูุฏู...</p>
            </div>
        </div>
    `;
    document.body.appendChild(progressModal);

    const progressDiv = progressModal.querySelector('#advanced-progress');

    try {
        if (!supabaseClient) {
            throw new Error('Supabase ุบูุฑ ูุชุตู');
        }

        // Step 1: Find all TEST records
        progressDiv.innerHTML += '<p>๐ ุงูุจุญุซ ุนู ุฌููุน ุณุฌูุงุช TEST...</p>';

        const { data: allRecords, error: fetchError } = await supabaseClient
            .from('properties')
            .select('*');

        if (fetchError) {
            throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช: ${fetchError.message}`);
        }

        const testRecords = allRecords.filter(record => {
            const recordString = JSON.stringify(record).toLowerCase();
            return recordString.includes('test');
        });

        progressDiv.innerHTML += `<p style="color: orange;">๐ฏ ุชู ุงูุนุซูุฑ ุนูู ${testRecords.length} ุณุฌู TEST</p>`;

        // Step 2: Delete related activity_log records first
        progressDiv.innerHTML += '<p>๐๏ธ ุญุฐู ุงูุณุฌูุงุช ุงููุฑุชุจุทุฉ ูู activity_log...</p>';

        let deletedActivityLogs = 0;
        for (const record of testRecords) {
            try {
                const { data: activityLogs, error: activityError } = await supabaseClient
                    .from('activity_log')
                    .select('id')
                    .eq('property_id', record.id);

                if (!activityError && activityLogs && activityLogs.length > 0) {
                    progressDiv.innerHTML += `<p>๐ ูุฌุฏ ${activityLogs.length} ุณุฌู ูุดุงุท ูููุญุฏุฉ ${record.id}</p>`;

                    const { error: deleteActivityError } = await supabaseClient
                        .from('activity_log')
                        .delete()
                        .eq('property_id', record.id);

                    if (!deleteActivityError) {
                        deletedActivityLogs += activityLogs.length;
                        progressDiv.innerHTML += `<p style="color: green;">โ ุชู ุญุฐู ${activityLogs.length} ุณุฌู ูุดุงุท ูููุญุฏุฉ ${record.id}</p>`;
                    } else {
                        progressDiv.innerHTML += `<p style="color: red;">โ ูุดู ุญุฐู ุณุฌูุงุช ุงููุดุงุท ูููุญุฏุฉ ${record.id}: ${deleteActivityError.message}</p>`;
                    }
                }
            } catch (error) {
                progressDiv.innerHTML += `<p style="color: red;">โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุณุฌูุงุช ุงููุดุงุท ูููุญุฏุฉ ${record.id}: ${error.message}</p>`;
            }
        }

        progressDiv.innerHTML += `<p style="color: blue;">๐ ุชู ุญุฐู ${deletedActivityLogs} ุณุฌู ูุดุงุท ุฅุฌูุงูู</p>`;

        // Step 3: Delete related attachments
        progressDiv.innerHTML += '<p>๐ ุญุฐู ุงููุฑููุงุช ุงููุฑุชุจุทุฉ...</p>';

        let deletedAttachments = 0;
        for (const record of testRecords) {
            try {
                const { data: attachments, error: attachmentError } = await supabaseClient
                    .from('attachments')
                    .select('id')
                    .eq('property_id', record.id);

                if (!attachmentError && attachments && attachments.length > 0) {
                    progressDiv.innerHTML += `<p>๐ ูุฌุฏ ${attachments.length} ูุฑูู ูููุญุฏุฉ ${record.id}</p>`;

                    const { error: deleteAttachmentError } = await supabaseClient
                        .from('attachments')
                        .delete()
                        .eq('property_id', record.id);

                    if (!deleteAttachmentError) {
                        deletedAttachments += attachments.length;
                        progressDiv.innerHTML += `<p style="color: green;">โ ุชู ุญุฐู ${attachments.length} ูุฑูู ูููุญุฏุฉ ${record.id}</p>`;
                    } else {
                        progressDiv.innerHTML += `<p style="color: red;">โ ูุดู ุญุฐู ุงููุฑููุงุช ูููุญุฏุฉ ${record.id}: ${deleteAttachmentError.message}</p>`;
                    }
                }
            } catch (error) {
                progressDiv.innerHTML += `<p style="color: orange;">โ๏ธ ุชุฎุทู ุงููุฑููุงุช ูููุญุฏุฉ ${record.id}: ${error.message}</p>`;
            }
        }

        progressDiv.innerHTML += `<p style="color: blue;">๐ ุชู ุญุฐู ${deletedAttachments} ูุฑูู ุฅุฌูุงูู</p>`;

        // Step 4: Now delete the main property records
        progressDiv.innerHTML += '<p>๐ ุญุฐู ุณุฌูุงุช ุงููุญุฏุงุช ุงูุฑุฆูุณูุฉ...</p>';

        let deletedProperties = 0;
        for (const record of testRecords) {
            try {
                const { error: deleteError } = await supabaseClient
                    .from('properties')
                    .delete()
                    .eq('id', record.id);

                if (!deleteError) {
                    deletedProperties++;
                    progressDiv.innerHTML += `<p style="color: green;">โ ุชู ุญุฐู ุงููุญุฏุฉ ${record.unit_number || record.property_name || record.id}</p>`;
                } else {
                    progressDiv.innerHTML += `<p style="color: red;">โ ูุดู ุญุฐู ุงููุญุฏุฉ ${record.id}: ${deleteError.message}</p>`;
                }
            } catch (error) {
                progressDiv.innerHTML += `<p style="color: red;">โ ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุฉ ${record.id}: ${error.message}</p>`;
            }
        }

        progressDiv.innerHTML += `<p style="color: blue;">๐ ุชู ุญุฐู ${deletedProperties} ูู ุฃุตู ${testRecords.length} ูุญุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>`;

        // Step 5: Clean local data
        progressDiv.innerHTML += '<p>๐ ุชูุธูู ุงูุจูุงูุงุช ุงููุญููุฉ...</p>';

        const originalLength = properties.length;
        properties = properties.filter(property => {
            const propertyString = JSON.stringify(property).toLowerCase();
            const containsTest = propertyString.includes('test');

            if (containsTest) {
                progressDiv.innerHTML += `<p style="color: green;">โ ุญุฐู ูุญูู: ${property['ุฑูู  ุงููุญุฏุฉ '] || property['ุงุณู ุงูุนูุงุฑ'] || 'ุบูุฑ ูุญุฏุฏ'}</p>`;
            }

            return !containsTest;
        });

        const localDeleted = originalLength - properties.length;
        progressDiv.innerHTML += `<p style="color: blue;">๐ ุชู ุญุฐู ${localDeleted} ูุญุฏุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉ</p>`;

        // Step 6: Save and refresh
        saveDataLocally();
        renderData();

        // Step 7: Final verification
        progressDiv.innerHTML += '<p>๐ ุงูุชุญูู ุงูููุงุฆู...</p>';

        setTimeout(async () => {
            const { data: remainingRecords } = await supabaseClient
                .from('properties')
                .select('*');

            const remainingTestRecords = remainingRecords?.filter(record =>
                JSON.stringify(record).toLowerCase().includes('test')
            ) || [];

            progressDiv.innerHTML += `<p style="color: ${remainingTestRecords.length === 0 ? 'green' : 'orange'};">๐ ุณุฌูุงุช TEST ุงููุชุจููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${remainingTestRecords.length}</p>`;

            const localTestRecords = properties.filter(property =>
                JSON.stringify(property).toLowerCase().includes('test')
            );

            progressDiv.innerHTML += `<p style="color: ${localTestRecords.length === 0 ? 'green' : 'orange'};">๐ ุณุฌูุงุช TEST ุงููุชุจููุฉ ูุญููุงู: ${localTestRecords.length}</p>`;

            progressDiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <h4 style="color: #27ae60;">๐ ุงูุชูู ุงูุญุฐู ุงููุชูุฏู!</h4>
                    <ul style="text-align: right; color: #27ae60;">
                        <li>ุณุฌูุงุช ุงููุดุงุท ุงููุญุฐููุฉ: ${deletedActivityLogs}</li>
                        <li>ุงููุฑููุงุช ุงููุญุฐููุฉ: ${deletedAttachments}</li>
                        <li>ุงููุญุฏุงุช ุงููุญุฐููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${deletedProperties}</li>
                        <li>ุงููุญุฏุงุช ุงููุญุฐููุฉ ูุญููุงู: ${localDeleted}</li>
                    </ul>
                    <button onclick="location.reload()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                        ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ููุชุฃูุฏ ุงูููุงุฆู
                    </button>
                </div>
            `;

            if (remainingTestRecords.length === 0) {
                showToast('ุชู ุญุฐู ุฌููุน ูุญุฏุงุช TEST ููุงุฆูุงู!', 'success');
            } else {
                showToast(`ุชู ุญุฐู ูุนุธู ุงููุญุฏุงุช - ${remainingTestRecords.length} ูุญุฏุฉ ูุชุจููุฉ`, 'warning');
            }
        }, 2000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุญุฐู ุงููุชูุฏู:', error);
        progressDiv.innerHTML += `<p style="color: red;">โ ุฎุทุฃ ุฎุทูุฑ: ${error.message}</p>`;
        showToast('ูุดู ูู ุงูุญุฐู ุงููุชูุฏู', 'error');
    }
}

// ===== Universal Advanced Delete Function =====
async function universalAdvancedDelete(propertyData, showProgress = false) {
    console.log('๐ง Starting universal advanced delete...');

    if (!supabaseClient) {
        console.warn('โ๏ธ Supabase not available for advanced delete');
        return { success: false, reason: 'NO_CLIENT' };
    }

    try {
        let progressCallback = null;

        if (showProgress) {
            progressCallback = (message, type = 'info') => {
                console.log(`๐ ${message}`);
                showToast(message, type);
            };
        }

        // Step 1: Find the property in database
        if (progressCallback) progressCallback('ุงูุจุญุซ ุนู ุงููุญุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...');

        const unitNumber = propertyData['ุฑูู  ุงููุญุฏุฉ '];
        const propertyName = propertyData['ุงุณู ุงูุนูุงุฑ'];

        console.log('๐ ุงูุจุญุซ ุนู:', { unitNumber, propertyName });

        const { data: foundProperties, error: searchError } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('unit_number', unitNumber)
            .eq('property_name', propertyName);

        if (searchError) {
            console.error('โ Search error:', searchError);
            return { success: false, reason: 'SEARCH_ERROR', error: searchError.message };
        }

        if (!foundProperties || foundProperties.length === 0) {
            console.log('โน๏ธ Property not found in database - trying alternative search...');

            // ูุญุงููุฉ ุจุญุซ ุจุฏููุฉ ุจุงุณุชุฎุฏุงู LIKE
            const { data: altFoundProperties, error: altSearchError } = await supabaseClient
                .from('properties')
                .select('*')
                .or(`unit_number.ilike.%${unitNumber}%,property_name.ilike.%${propertyName}%`);

            if (altSearchError || !altFoundProperties || altFoundProperties.length === 0) {
                console.log('โน๏ธ Property not found in database with alternative search');
                return { success: false, reason: 'NOT_FOUND' };
            }

            foundProperties = altFoundProperties;
            console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${foundProperties.length} ูุชูุฌุฉ ุจุงูุจุญุซ ุงูุจุฏูู`);
        }

        const property = foundProperties[0];
        if (progressCallback) progressCallback(`ุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ: ${property.id}`);

        // Step 2: Delete related activity logs
        if (progressCallback) progressCallback('ุญุฐู ุณุฌูุงุช ุงููุดุงุท ุงููุฑุชุจุทุฉ...');

        const { data: activityLogs, error: activityError } = await supabaseClient
            .from('activity_log')
            .select('id')
            .eq('property_id', property.id);

        if (!activityError && activityLogs && activityLogs.length > 0) {
            const { error: deleteActivityError } = await supabaseClient
                .from('activity_log')
                .delete()
                .eq('property_id', property.id);

            if (!deleteActivityError) {
                if (progressCallback) progressCallback(`ุชู ุญุฐู ${activityLogs.length} ุณุฌู ูุดุงุท`);
            } else {
                console.warn('โ๏ธ Failed to delete activity logs:', deleteActivityError);
            }
        }

        // Step 3: Delete related attachments
        if (progressCallback) progressCallback('ุญุฐู ุงููุฑููุงุช ุงููุฑุชุจุทุฉ...');

        try {
            // ุงูุจุญุซ ุนู ุงููุฑููุงุช ุจุทุฑู ูุชุนุฏุฏุฉ
            let attachments = [];

            // ุงูุจุญุซ ุจู property_id
            const { data: attachmentsByPropertyId, error: attachmentError1 } = await supabaseClient
                .from('attachments')
                .select('id, storage_path')
                .eq('property_id', property.id);

            if (!attachmentError1 && attachmentsByPropertyId) {
                attachments = [...attachments, ...attachmentsByPropertyId];
            }

            // ุงูุจุญุซ ุจู property_key
            const propertyKey = `${propertyName}_${unitNumber}`;
            const { data: attachmentsByKey, error: attachmentError2 } = await supabaseClient
                .from('attachments')
                .select('id, storage_path')
                .eq('property_key', propertyKey);

            if (!attachmentError2 && attachmentsByKey) {
                attachments = [...attachments, ...attachmentsByKey];
            }

            // ุฅุฒุงูุฉ ุงูููุฑุฑุงุช
            const uniqueAttachments = attachments.filter((attachment, index, self) =>
                index === self.findIndex(a => a.id === attachment.id)
            );

            if (uniqueAttachments.length > 0) {
                // ุญุฐู ุงููููุงุช ูู ุงูุชุฎุฒูู ุฃููุงู
                for (const attachment of uniqueAttachments) {
                    if (attachment.storage_path) {
                        try {
                            await supabaseClient.storage
                                .from('attachments')
                                .remove([attachment.storage_path]);
                        } catch (storageError) {
                            console.warn('โ๏ธ Failed to delete file from storage:', storageError);
                        }
                    }
                }

                // ุญุฐู ุงูุณุฌูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                const attachmentIds = uniqueAttachments.map(a => a.id);
                const { error: deleteAttachmentError } = await supabaseClient
                    .from('attachments')
                    .delete()
                    .in('id', attachmentIds);

                if (!deleteAttachmentError) {
                    if (progressCallback) progressCallback(`ุชู ุญุฐู ${uniqueAttachments.length} ูุฑูู`);
                } else {
                    console.warn('โ๏ธ Failed to delete attachments:', deleteAttachmentError);
                }
            }
        } catch (attachmentError) {
            console.warn('โ๏ธ Error handling attachments:', attachmentError);
        }

        // Step 4: Delete the main property record
        if (progressCallback) progressCallback('ุญุฐู ุณุฌู ุงููุญุฏุฉ ุงูุฑุฆูุณู...');

        const { error: deleteError } = await supabaseClient
            .from('properties')
            .delete()
            .eq('id', property.id);

        if (deleteError) {
            console.error('โ Failed to delete property:', deleteError);
            return {
                success: false,
                reason: 'DELETE_ERROR',
                error: deleteError.message,
                propertyId: property.id
            };
        }

        if (progressCallback) progressCallback('ุชู ุญุฐู ุงููุญุฏุฉ ููุงุฆูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช', 'success');

        return {
            success: true,
            deletedCount: 1,
            propertyId: property.id,
            message: 'Property and all related data deleted successfully'
        };

    } catch (error) {
        console.error('โ Critical error in universal advanced delete:', error);
        return {
            success: false,
            reason: 'CRITICAL_ERROR',
            error: error.message
        };
    }
}

// ===== Enhanced Delete Unit Function =====
async function enhancedDeleteUnit(unitData) {
    console.log('๐๏ธ Starting enhanced unit deletion...');

    // Show progress to user
    showToast('ุฌุงุฑู ุญุฐู ุงููุญุฏุฉ ูุน ุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ...', 'info');

    try {
        // Use universal advanced delete
        const result = await universalAdvancedDelete(unitData, true);

        if (result.success) {
            // Remove from local data
            const originalLength = properties.length;
            properties = properties.filter(p =>
                !(p['ุฑูู  ุงููุญุฏุฉ '] === unitData['ุฑูู  ุงููุญุฏุฉ '] &&
                  p['ุงุณู ุงูุนูุงุฑ'] === unitData['ุงุณู ุงูุนูุงุฑ'])
            );

            const localDeleted = originalLength - properties.length;

            if (localDeleted > 0) {
                // ุญุฐู ุงููุฑููุงุช ุงููุญููุฉ ุฃูุถุงู
                const propertyKey = `${unitData['ุงุณู ุงูุนูุงุฑ']}_${unitData['ุฑูู  ุงููุญุฏุฉ ']}`;

                // ุญุฐู ูุฑููุงุช ุงูุนูุงุฑุงุช
                const propertyAttachments = JSON.parse(localStorage.getItem('propertyAttachments') || '{}');
                if (propertyAttachments[propertyKey]) {
                    delete propertyAttachments[propertyKey];
                    localStorage.setItem('propertyAttachments', JSON.stringify(propertyAttachments));
                    console.log('โ ุชู ุญุฐู ูุฑููุงุช ุงูุนูุงุฑ ุงููุญููุฉ');
                }

                // ุญุฐู ูุฑููุงุช ุงูุจุทุงูุงุช
                const cardAttachments = JSON.parse(localStorage.getItem('cardAttachments') || '{}');
                if (cardAttachments[propertyKey]) {
                    delete cardAttachments[propertyKey];
                    localStorage.setItem('cardAttachments', JSON.stringify(cardAttachments));
                    console.log('โ ุชู ุญุฐู ูุฑููุงุช ุงูุจุทุงูุฉ ุงููุญููุฉ');
                }

                saveDataLocally();
                renderData();
                showToast('ุชู ุญุฐู ุงููุญุฏุฉ ููุงุฆูุงู ูู ุงููุธุงู', 'success');
            }

            return { success: true, localDeleted, cloudDeleted: 1 };
        } else {
            // Handle failure
            let message = 'ูุดู ูู ุญุฐู ุงููุญุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช';

            if (result.reason === 'NOT_FOUND') {
                message = 'ุงููุญุฏุฉ ุบูุฑ ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุณูุชู ุงูุญุฐู ูุญููุงู ููุท';

                // Still delete locally
                const originalLength = properties.length;
                properties = properties.filter(p =>
                    !(p['ุฑูู  ุงููุญุฏุฉ '] === unitData['ุฑูู  ุงููุญุฏุฉ '] &&
                      p['ุงุณู ุงูุนูุงุฑ'] === unitData['ุงุณู ุงูุนูุงุฑ'])
                );

                const localDeleted = originalLength - properties.length;

                if (localDeleted > 0) {
                    saveDataLocally();
                    renderData();
                }

                showToast(message, 'warning');
                return { success: true, localDeleted, cloudDeleted: 0 };
            }

            showToast(message, 'error');
            return { success: false, error: result.error };
        }

    } catch (error) {
        console.error('โ Error in enhanced delete unit:', error);
        showToast('ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุฉ', 'error');
        return { success: false, error: error.message };
    }
}

// ===== Show Deed Information for Selected Property in Mobile =====
function showDeedInfoForProperty(propertyName, city) {
    console.log(`๐ ุนุฑุถ ูุนูููุงุช ุงูุตู ููุนูุงุฑ: ${propertyName} ูู ${city}`);

    // ุงูุจุญุซ ุนู ุงูุนูุงุฑ ุงููุญุฏุฏ
    const relatedProperties = properties.filter(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName && p['ุงููุฏููุฉ'] === city
    );

    if (relatedProperties.length === 0) {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ุงููุญุฏุฏ');
        return;
    }

    // ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุตู ูู ุฃูู ูุญุฏุฉ ุชุญุชูู ุนูู ุงูุจูุงูุงุช
    const propertyWithDeed = relatedProperties.find(p =>
        p['ุฑูู ุงูุตู'] || p['ูุณุงุญุฉุงูุตู'] || p['ุงูุณุฌู ุงูุนููู ']
    );

    if (!propertyWithDeed) {
        console.log('โน๏ธ ูุง ุชูุฌุฏ ูุนูููุงุช ุตู ููุฐุง ุงูุนูุงุฑ');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ูุนูููุงุช ุงูุตู
    const deedModal = document.createElement('div');
    deedModal.className = 'modal-overlay';
    deedModal.style.display = 'flex';
    deedModal.innerHTML = `
        <div class="modal-box deed-info-modal" style="max-width: ${isMobileDevice() ? '95vw' : '600px'}; padding: 30px;">
            <div class="deed-header" style="text-align: center; margin-bottom: 25px;">
                <i class="fas fa-file-contract" style="font-size: 3rem; color: #007bff; margin-bottom: 15px;"></i>
                <h2 style="color: #2c3e50; margin: 0;">ูุนูููุงุช ุงูุตู</h2>
                <p style="color: #6c757d; margin: 10px 0 0 0;">${propertyName} - ${city}</p>
            </div>

            <div class="deed-details" style="background: #f8f9fa; border-radius: 12px; padding: 20px;">
                ${propertyWithDeed['ุฑูู ุงูุตู'] ? `
                <div class="deed-item" style="display: flex; align-items: center; margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="deed-icon" style="margin-left: 15px;">
                        <i class="fas fa-file-alt" style="font-size: 1.5rem; color: #dc3545;"></i>
                    </div>
                    <div class="deed-content" style="flex: 1;">
                        <div class="deed-label" style="font-weight: 600; color: #495057; margin-bottom: 5px;">ุฑูู ุงูุตู</div>
                        <div class="deed-value" style="font-size: 1.1rem; color: #2c3e50;">${propertyWithDeed['ุฑูู ุงูุตู']}</div>
                    </div>
                </div>
                ` : ''}

                ${propertyWithDeed['ุงูุณุฌู ุงูุนููู '] ? `
                <div class="deed-item" style="display: flex; align-items: center; margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="deed-icon" style="margin-left: 15px;">
                        <i class="fas fa-clipboard-list" style="font-size: 1.5rem; color: #28a745;"></i>
                    </div>
                    <div class="deed-content" style="flex: 1;">
                        <div class="deed-label" style="font-weight: 600; color: #495057; margin-bottom: 5px;">ุฑูู ุงูุณุฌู ุงูุนูุงุฑู</div>
                        <div class="deed-value" style="font-size: 1.1rem; color: #2c3e50;">${propertyWithDeed['ุงูุณุฌู ุงูุนููู ']}</div>
                    </div>
                </div>
                ` : ''}

                ${propertyWithDeed['ูุณุงุญุฉุงูุตู'] ? `
                <div class="deed-item" style="display: flex; align-items: center; margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="deed-icon" style="margin-left: 15px;">
                        <i class="fas fa-ruler-combined" style="font-size: 1.5rem; color: #fd7e14;"></i>
                    </div>
                    <div class="deed-content" style="flex: 1;">
                        <div class="deed-label" style="font-weight: 600; color: #495057; margin-bottom: 5px;">ูุณุงุญุฉ ุงูุตู</div>
                        <div class="deed-value" style="font-size: 1.1rem; color: #2c3e50;">${parseFloat(propertyWithDeed['ูุณุงุญุฉุงูุตู']).toLocaleString()} ูยฒ</div>
                    </div>
                </div>
                ` : ''}
            </div>

            <div class="deed-actions" style="text-align: center; margin-top: 25px;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()"
                        class="btn-primary"
                        style="padding: 12px 30px; font-size: 1.1rem; border-radius: 8px; background: linear-gradient(135deg, #007bff, #0056b3); border: none; color: white; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-times"></i> ุฅุบูุงู
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(deedModal);

    // ุฅุถุงูุฉ ุชุฃุซูุฑ ุงูุฅุบูุงู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌ ุงููุงูุฐุฉ
    deedModal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.remove();
        }
    });

    console.log('โ ุชู ุนุฑุถ ูุงูุฐุฉ ูุนูููุงุช ุงูุตู');
}

// ===== Mobile Device Detection =====
function isMobileDevice() {
    // Check multiple indicators for mobile devices
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;

    // Check for mobile user agents
    const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;
    const isMobileUA = mobileRegex.test(userAgent.toLowerCase());

    // Check screen size
    const isSmallScreen = window.innerWidth <= 768;

    // Check touch capability
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // Return true if any mobile indicator is present
    return isMobileUA || (isSmallScreen && isTouchDevice);
}

// ===== Enhanced Attachment Display for Mobile =====
function enhanceAttachmentDisplayForMobile() {
    console.log('๐ฑ ุจุฏุก ุชุญุณูู ุนุฑุถ ุงููุฑููุงุช ููุฌูุงู...');

    // Force show all attachment elements with enhanced selectors
    const attachmentElements = document.querySelectorAll(`
        .attachments-list,
        .attachments-list-container,
        .card-attachments-list,
        .attachment-item,
        .mobile-enhanced-item,
        .desktop-enhanced-item,
        [id*="cardAttachmentsList"],
        [id*="attachmentsList"],
        [class*="attachment"],
        [class*="card-modal"]
    `);

    let enhancedCount = 0;

    attachmentElements.forEach(element => {
        // Force visibility
        element.style.display = element.classList.contains('attachment-item') ||
                                element.classList.contains('mobile-enhanced-item') ||
                                element.classList.contains('desktop-enhanced-item') ? 'flex' : 'block';
        element.style.visibility = 'visible';
        element.style.opacity = '1';
        element.style.position = 'relative';
        element.style.zIndex = 'auto';

        // Add mobile-specific classes and styles
        if (isMobileDevice()) {
            element.classList.add('mobile-optimized');

            // Enhanced mobile styles for attachment items
            if (element.classList.contains('attachment-item') ||
                element.classList.contains('mobile-enhanced-item')) {
                element.style.padding = '15px 10px';
                element.style.marginBottom = '10px';
                element.style.borderRadius = '8px';
                element.style.background = '#f8f9fa';
                element.style.border = '1px solid #e9ecef';
                element.style.transition = 'all 0.3s ease';
            }

            // Enhanced mobile styles for containers
            if (element.classList.contains('attachments-list-container')) {
                element.style.minHeight = '200px';
                element.style.maxHeight = '60vh';
                element.style.overflowY = 'auto';
                element.style.padding = '10px';
            }
        }

        enhancedCount++;
    });

    // Ensure attachment items use proper flex layout
    const attachmentItems = document.querySelectorAll('.attachment-item, .mobile-enhanced-item, .desktop-enhanced-item');
    attachmentItems.forEach(item => {
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.visibility = 'visible';
        item.style.opacity = '1';
        item.style.position = 'relative';

        // Enhanced mobile layout
        if (isMobileDevice()) {
            item.style.flexDirection = 'row';
            item.style.gap = '10px';
            item.style.padding = '15px 10px';
        }
    });

    // Force show loading and error states
    const loadingElements = document.querySelectorAll('.loading-attachments, .loading-state, .error-loading-attachments');
    loadingElements.forEach(element => {
        element.style.display = 'flex';
        element.style.visibility = 'visible';
        element.style.opacity = '1';
    });

    // Enhanced mobile modal adjustments
    if (isMobileDevice()) {
        const cardModal = document.querySelector('.card-attachments-modal');
        if (cardModal) {
            cardModal.style.width = '95vw';
            cardModal.style.height = '90vh';
            cardModal.style.maxWidth = '95vw';
            cardModal.style.maxHeight = '90vh';
        }

        const modalContent = document.querySelector('.card-modal-content');
        if (modalContent) {
            modalContent.style.flexDirection = 'column';
            modalContent.style.gap = '15px';
            modalContent.style.padding = '15px';
        }
    }

    // Add enhanced CSS for mobile compatibility
    const enhancedStyle = document.createElement('style');
    enhancedStyle.id = 'mobile-attachment-enhancement';
    enhancedStyle.textContent = `
        /* Force visibility for all attachment elements */
        .attachments-list,
        .attachments-list-container,
        .card-attachments-list,
        .attachment-item,
        .mobile-enhanced-item,
        .desktop-enhanced-item,
        [id*="cardAttachmentsList"],
        [id*="attachmentsList"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
        }

        .attachment-item,
        .mobile-enhanced-item,
        .desktop-enhanced-item {
            display: flex !important;
            align-items: center !important;
        }

        /* Mobile-specific enhancements */
        @media (max-width: 768px) {
            .mobile-enhanced-item {
                padding: 15px 10px !important;
                margin-bottom: 10px !important;
                background: #f8f9fa !important;
                border: 1px solid #e9ecef !important;
                border-radius: 8px !important;
                transition: all 0.3s ease !important;
            }

            .mobile-enhanced-item:hover {
                background: #e3f2fd !important;
                border-color: #007bff !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15) !important;
            }

            .attachments-list-container {
                min-height: 200px !important;
                max-height: 60vh !important;
                overflow-y: auto !important;
                padding: 10px !important;
            }

            .card-attachments-modal {
                width: 95vw !important;
                height: 90vh !important;
                max-width: 95vw !important;
                max-height: 90vh !important;
            }

            .card-modal-content {
                flex-direction: column !important;
                gap: 15px !important;
                padding: 15px !important;
            }
        }
    `;

    // Remove existing style if present
    const existingStyle = document.getElementById('mobile-attachment-enhancement');
    if (existingStyle) {
        existingStyle.remove();
    }

    document.head.appendChild(enhancedStyle);

    console.log(`๐ฑ ุชู ุชุญุณูู ุนุฑุถ ${enhancedCount} ุนูุตุฑ ูุฑููุงุช ููุฌูุงู`);
    console.log(`๐ฑ ุชู ุชุญุณูู ${attachmentItems.length} ุนูุตุฑ ูุฑูู ูุฑุฏู`);

    // Force a repaint to ensure changes are applied
    setTimeout(() => {
        const allElements = document.querySelectorAll('[id*="cardAttachmentsList"], .attachment-item');
        allElements.forEach(el => {
            el.style.transform = 'translateZ(0)';
            setTimeout(() => {
                el.style.transform = '';
            }, 10);
        });
    }, 100);
}

// ===== Setup Attachments Scroll with Back to Top Button =====
function setupAttachmentsScroll(cardKey) {
    console.log('๐ ุฅุนุฏุงุฏ ุงุณูุฑูู ุงููุฑููุงุช ูุน ุฒุฑ ุงูุนูุฏุฉ ููุฃุนูู...');

    const attachmentsList = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    const scrollToTopBtn = document.getElementById(`scrollToTopBtn_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (!attachmentsList || !scrollToTopBtn) {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุงุตุฑ ุงูุงุณูุฑูู');
        return;
    }

    // ุฅุถุงูุฉ ุญุฏุซ ุงูุงุณูุฑูู ูุฅุธูุงุฑ/ุฅุฎูุงุก ุฒุฑ ุงูุนูุฏุฉ ููุฃุนูู
    attachmentsList.addEventListener('scroll', function() {
        const scrollTop = this.scrollTop;
        const scrollThreshold = 100; // ุฅุธูุงุฑ ุงูุฒุฑ ุจุนุฏ ุงูุชูุฑูุฑ 100px

        if (scrollTop > scrollThreshold) {
            scrollToTopBtn.classList.add('show');
        } else {
            scrollToTopBtn.classList.remove('show');
        }
    });

    // ุชุญุณูู ุงูุงุณูุฑูู ููุฌูุงู
    if (isMobileDevice()) {
        attachmentsList.style.webkitOverflowScrolling = 'touch';
        attachmentsList.style.scrollBehavior = 'smooth';
    }

    console.log('โ ุชู ุฅุนุฏุงุฏ ุงุณูุฑูู ุงููุฑููุงุช ุจูุฌุงุญ');
}

// ===== Scroll to Top Function for Attachments =====
function scrollToTopAttachments(cardKey) {
    console.log('โฌ๏ธ ุงูุนูุฏุฉ ูุฃุนูู ูุงุฆูุฉ ุงููุฑููุงุช...');

    const attachmentsList = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

    if (attachmentsList) {
        // ุงุณูุฑูู ุณูุณ ููุฃุนูู
        attachmentsList.scrollTo({
            top: 0,
            behavior: 'smooth'
        });

        // ุชุฃุซูุฑ ุจุตุฑู ููุฒุฑ
        const scrollToTopBtn = document.getElementById(`scrollToTopBtn_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (scrollToTopBtn) {
            scrollToTopBtn.style.transform = 'scale(0.9)';
            setTimeout(() => {
                scrollToTopBtn.style.transform = 'scale(1)';
            }, 150);
        }

        console.log('โ ุชู ุงูุชูุฑูุฑ ูุฃุนูู ูุงุฆูุฉ ุงููุฑููุงุช');
    } else {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุงุฆูุฉ ุงููุฑููุงุช');
    }
}

// ===== Enhanced Scroll to Attachments (for large screens) =====
function scrollToAttachments() {
    console.log('๐ ุงูุชูุฑูุฑ ููุณู ุงููุฑููุงุช...');

    // ุงูุจุญุซ ุนู ูุณู ุงููุฑููุงุช ูู ุงููุงูุฐุฉ
    const attachmentsSection = document.querySelector('.attachments-main-section');
    const attachmentsList = document.querySelector('.scrollable-attachments');

    if (attachmentsSection) {
        // ุงูุชูุฑูุฑ ููุณู ุงููุฑููุงุช
        attachmentsSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        console.log('โ ุชู ุงูุชูุฑูุฑ ููุณู ุงููุฑููุงุช');
    } else if (attachmentsList) {
        // ุงูุชูุฑูุฑ ููุงุฆูุฉ ุงููุฑููุงุช ูุจุฏูู
        attachmentsList.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        console.log('โ ุชู ุงูุชูุฑูุฑ ููุงุฆูุฉ ุงููุฑููุงุช');
    } else {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุณู ุงููุฑููุงุช');
    }
}

// ุชุญููู ุงููุญุฏุงุช ููุฏูุฌ
function loadUnitsForMerge() {
    const propertyName = document.getElementById('mergePropertyName').value;
    const container = document.getElementById('availableUnitsForMerge');

    if (!propertyName) {
        container.innerHTML = '<p>ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนูุงุฑ ุฃููุงู</p>';
        return;
    }

    // ุงูุญุตูู ุนูู ุงููุญุฏุงุช ุงููุงุฑุบุฉ ุฃู ุบูุฑ ุงููุฑุชุจุทุฉ ุจุนูุฏ
    const availableUnits = properties.filter(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName &&
        (!p['ุฑูู ุงูุนูุฏ'] || !p['ุงุณู ุงููุณุชุฃุฌุฑ'])
    );

    if (availableUnits.length === 0) {
        container.innerHTML = '<p>ูุง ุชูุฌุฏ ูุญุฏุงุช ูุชุงุญุฉ ููุฏูุฌ ูู ูุฐุง ุงูุนูุงุฑ</p>';
        return;
    }

    container.innerHTML = availableUnits.map(unit => `
        <label class="unit-checkbox">
            <input type="checkbox" value="${unit['ุฑูู  ุงููุญุฏุฉ ']}" name="mergeUnits">
            <span>${unit['ุฑูู  ุงููุญุฏุฉ ']} - ${unit['ุงููุณุงุญุฉ'] ? unit['ุงููุณุงุญุฉ'] + ' ูยฒ' : 'ุบูุฑ ูุญุฏุฏ'}</span>
        </label>
    `).join('');
}

// ุฏูุฌ ุงููุญุฏุงุช ุงููุญุฏุฏุฉ
function mergeSelectedUnits() {
    const propertyName = document.getElementById('mergePropertyName').value;
    const contractNumber = document.getElementById('mergeContractNumber').value.trim();
    const selectedUnits = Array.from(document.querySelectorAll('input[name="mergeUnits"]:checked'))
        .map(checkbox => checkbox.value);

    if (!propertyName || !contractNumber) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนูุงุฑ ูุฅุฏุฎุงู ุฑูู ุงูุนูุฏ');
        return;
    }

    if (selectedUnits.length < 2) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ูุญุฏุชูู ุนูู ุงูุฃูู ููุฏูุฌ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุนูุฏ ุจููุณ ุงูุฑูู
    const existingContract = properties.find(p => p['ุฑูู ุงูุนูุฏ'] === contractNumber);
    if (existingContract) {
        alert('ููุฌุฏ ุนูุฏ ุจููุณ ุงูุฑูู ุจุงููุนู');
        return;
    }

    console.log('๐ ุจุฏุก ุนูููุฉ ุฏูุฌ ุงููุญุฏุงุช...');
    console.log(`๐ ุงููุญุฏุงุช ุงููุญุฏุฏุฉ ููุฏูุฌ: ${selectedUnits.join(', ')}`);
    console.log(`๐ ุฑูู ุงูุนูุฏ ุงูุฌุฏูุฏ: ${contractNumber}`);

    // ุชุญุฏูุซ ุงููุญุฏุงุช ุงููุญุฏุฏุฉ ุจุฑูู ุงูุนูุฏ ุงูุฌุฏูุฏ
    let mergedCount = 0;
    selectedUnits.forEach(unitNumber => {
        const unit = properties.find(p =>
            p['ุงุณู ุงูุนูุงุฑ'] === propertyName && p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber
        );
        if (unit) {
            console.log(`๐ ุฏูุฌ ุงููุญุฏุฉ ${unitNumber} ุชุญุช ุงูุนูุฏ ${contractNumber}`);
            unit['ุฑูู ุงูุนูุฏ'] = contractNumber;
            mergedCount++;
        } else {
            console.warn(`โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ${unitNumber}`);
        }
    });

    if (mergedCount === 0) {
        alert('ูุดู ูู ุฏูุฌ ุงููุญุฏุงุช - ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ูุญุฏุฉ');
        return;
    }

    // ุญูุธ ุงูุจูุงูุงุช ูู localStorage
    console.log('๐พ ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุงูุฏูุฌ...');
    try {
        localStorage.setItem('properties', JSON.stringify(properties));
        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู ุจูุฌุงุญ');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู:', error);
        alert('ุชู ุงูุฏูุฌ ูููู ูุดู ูู ุงูุญูุธ ุงููุญูู');
    }

    // ุญูุธ ูู Supabase ุฅุฐุง ูุงู ูุชููุฑุงู
    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
        console.log('โ๏ธ ุญูุธ ุงูุจูุงูุงุช ูู Supabase...');
        try {
            selectedUnits.forEach(async (unitNumber) => {
                const unit = properties.find(p =>
                    p['ุงุณู ุงูุนูุงุฑ'] === propertyName && p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber
                );
                if (unit && typeof savePropertyToSupabase === 'function') {
                    await savePropertyToSupabase(unit);
                }
            });
            console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ูู Supabase');
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ูู Supabase:', error);
        }
    }

    alert(`ุชู ุฏูุฌ ${mergedCount} ูุญุฏุงุช ุชุญุช ุงูุนูุฏ ุฑูู ${contractNumber} ุจูุฌุงุญ!`);

    // ุชูุธูู ุงููููุฐุฌ
    document.getElementById('mergePropertyName').value = '';
    document.getElementById('mergeContractNumber').value = '';
    document.getElementById('availableUnitsForMerge').innerHTML = '';

    // ุชุญุฏูุซ ุงูุนุฑุถ
    const mergedDisplay = document.getElementById('mergedUnitsDisplay');
    if (mergedDisplay) {
        mergedDisplay.innerHTML = renderMergedUnits();
    }

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูุถูุงู ุงูุชุญุฏูุซ
    setTimeout(() => {
        renderData();
        initializeApp();
    }, 500);

    console.log('๐ ุชูุช ุนูููุฉ ุงูุฏูุฌ ุจูุฌุงุญ');
}

// ===== ูุธุงุฆู ูุตู ูุชุญุฑูุฑ ุงููุญุฏุงุช ุงููุฏููุฌุฉ =====

// ูุตู ุงููุญุฏุงุช ุงููุฏููุฌุฉ
async function splitMergedContract(contractNumber, propertyName) {
    console.log(`๐ ุจุฏุก ูุตู ุงููุญุฏุงุช ููุนูุฏ ${contractNumber} ูู ุงูุนูุงุฑ ${propertyName}`);

    // ุงูุชุฃูุฏ ูู ุฑุบุจุฉ ุงููุณุชุฎุฏู ูู ุงููุตู
    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ูุตู ุฌููุน ุงููุญุฏุงุช ูู ุงูุนูุฏ ุฑูู ${contractNumber}ุ\nุณูุชู ุฅุฒุงูุฉ ุฑูู ุงูุนูุฏ ูู ุฌููุน ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุจู.`)) {
        return;
    }

    // ุงูุจุญุซ ุนู ุฌููุน ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุจูุฐุง ุงูุนูุฏ
    const contractUnits = properties.filter(p =>
        p['ุฑูู ุงูุนูุฏ'] === contractNumber &&
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );

    if (contractUnits.length === 0) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ูุญุฏุงุช ูุฑุชุจุทุฉ ุจูุฐุง ุงูุนูุฏ');
        return;
    }

    console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${contractUnits.length} ูุญุฏุฉ ูุฑุชุจุทุฉ ุจุงูุนูุฏ`);

    // ุฅุฒุงูุฉ ุฑูู ุงูุนูุฏ ูู ุฌููุน ุงููุญุฏุงุช
    let splitCount = 0;
    contractUnits.forEach(unit => {
        console.log(`๐ ูุตู ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ูู ุงูุนูุฏ ${contractNumber}`);
        unit['ุฑูู ุงูุนูุฏ'] = ''; // ุฅุฒุงูุฉ ุฑูู ุงูุนูุฏ
        splitCount++;
    });

    // ุญูุธ ุงูุจูุงูุงุช ูู localStorage
    console.log('๐พ ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุงููุตู...');
    try {
        localStorage.setItem('properties', JSON.stringify(properties));
        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู ุจูุฌุงุญ');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู:', error);
        alert('ุชู ุงููุตู ูููู ูุดู ูู ุงูุญูุธ ุงููุญูู');
    }

    // ุญูุธ ูู Supabase ุฅุฐุง ูุงู ูุชููุฑุงู
    if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof savePropertyToSupabase === 'function') {
        console.log('โ๏ธ ุญูุธ ุงูุจูุงูุงุช ูู Supabase...');
        let supabaseErrors = 0;

        try {
            // ุงุณุชุฎุฏุงู Promise.all ููุญูุธ ุงููุชุฒุงูู
            const savePromises = contractUnits.map(async (unit) => {
                try {
                    const result = await savePropertyToSupabase(unit);
                    if (result) {
                        console.log(`โ ุชู ุญูุธ ูุตู ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ูู Supabase`);
                        return true;
                    } else {
                        console.error(`โ ูุดู ุญูุธ ูุตู ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ูู Supabase`);
                        supabaseErrors++;
                        return false;
                    }
                } catch (error) {
                    console.error(`โ ุฎุทุฃ ูู ุญูุธ ูุตู ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}:`, error);
                    supabaseErrors++;
                    return false;
                }
            });

            await Promise.all(savePromises);

            if (supabaseErrors === 0) {
                console.log('โ ุชู ุญูุธ ุฌููุน ุงูุจูุงูุงุช ูู Supabase ุจูุฌุงุญ');
            } else {
                console.warn(`โ๏ธ ูุดู ุญูุธ ${supabaseErrors} ูุญุฏุฉ ูู Supabase`);
            }
        } catch (error) {
            console.error('โ ุฎุทุฃ ุนุงู ูู ุญูุธ ุงูุจูุงูุงุช ูู Supabase:', error);
            supabaseErrors = contractUnits.length;
        }
    }

    // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฌุงุญ ูุน ุชูุงุตูู ุงูุญูุธ
    let message = `ุชู ูุตู ${splitCount} ูุญุฏุฉ ูู ุงูุนูุฏ ุฑูู ${contractNumber} ุจูุฌุงุญ!`;
    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
        if (supabaseErrors === 0) {
            message += `\nโ ุชู ุญูุธ ุฌููุน ุงูุชุบููุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ`;
        } else if (supabaseErrors > 0) {
            message += `\nโ๏ธ ุชุญุฐูุฑ: ูุดู ุญูุธ ${supabaseErrors} ูุญุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ`;
        }
    }
    alert(message);

    // ุชุญุฏูุซ ุงูุนุฑุถ
    const mergedDisplay = document.getElementById('mergedUnitsDisplay');
    if (mergedDisplay) {
        mergedDisplay.innerHTML = renderMergedUnits();
    }

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูุถูุงู ุงูุชุญุฏูุซ
    setTimeout(() => {
        renderData();
        initializeApp();
    }, 500);

    console.log('๐ ุชูุช ุนูููุฉ ุงููุตู ุจูุฌุงุญ');
}

// ุชุญุฑูุฑ ุงูุนูุฏ ุงููุฏููุฌ
function editMergedContract(contractNumber, propertyName) {
    console.log(`โ๏ธ ุชุญุฑูุฑ ุงูุนูุฏ ${contractNumber} ูู ุงูุนูุงุฑ ${propertyName}`);

    // ุงูุจุญุซ ุนู ุฌููุน ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุจูุฐุง ุงูุนูุฏ
    const contractUnits = properties.filter(p =>
        p['ุฑูู ุงูุนูุฏ'] === contractNumber &&
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );

    if (contractUnits.length === 0) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ูุญุฏุงุช ูุฑุชุจุทุฉ ุจูุฐุง ุงูุนูุฏ');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุชุญุฑูุฑ
    const editModal = document.createElement('div');
    editModal.className = 'modal-overlay';
    editModal.innerHTML = `
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> ุชุญุฑูุฑ ุงูุนูุฏ ุงููุฏููุฌ</h3>
                <button class="close-modal" onclick="this.closest('.modal-overlay').remove()">ร</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label><strong>ุฑูู ุงูุนูุฏ ุงูุญุงูู:</strong></label>
                    <input type="text" id="editContractNumber" value="${contractNumber}"
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                </div>

                <div class="form-group">
                    <label><strong>ุงูุนูุงุฑ:</strong></label>
                    <input type="text" value="${propertyName}" readonly
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 15px; background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label><strong>ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ (${contractUnits.length} ูุญุฏุฉ):</strong></label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f9f9f9;">
                        ${contractUnits.map(unit => `
                            <div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="editUnits" value="${unit['ุฑูู  ุงููุญุฏุฉ ']}" checked
                                           style="margin-left: 10px;">
                                    <span>ูุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} - ${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || 'ูุงุฑุบ'}</span>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        <i class="fas fa-info-circle"></i> ููููู ุฅูุบุงุก ุชุญุฏูุฏ ุงููุญุฏุงุช ุงูุชู ุชุฑูุฏ ูุตููุง ูู ุงูุนูุฏ
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="saveEditedContract('${contractNumber}', '${propertyName}')">
                    <i class="fas fa-save"></i> ุญูุธ ุงูุชุบููุฑุงุช
                </button>
                <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                    <i class="fas fa-times"></i> ุฅูุบุงุก
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(editModal);
}

// ุญูุธ ุชุนุฏููุงุช ุงูุนูุฏ
async function saveEditedContract(oldContractNumber, propertyName) {
    const newContractNumber = document.getElementById('editContractNumber').value.trim();
    const selectedUnits = Array.from(document.querySelectorAll('input[name="editUnits"]:checked'))
        .map(checkbox => checkbox.value);

    if (!newContractNumber) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูุนูุฏ');
        return;
    }

    console.log(`๐พ ุญูุธ ุชุนุฏููุงุช ุงูุนูุฏ ${oldContractNumber} -> ${newContractNumber}`);
    console.log(`๐ ุงููุญุฏุงุช ุงููุญุฏุฏุฉ: ${selectedUnits.join(', ')}`);

    // ุงูุจุญุซ ุนู ุฌููุน ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุจุงูุนูุฏ ุงููุฏูู
    const allContractUnits = properties.filter(p =>
        p['ุฑูู ุงูุนูุฏ'] === oldContractNumber &&
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );

    let updatedCount = 0;
    let removedCount = 0;

    // ุชุญุฏูุซ ุงููุญุฏุงุช
    allContractUnits.forEach(unit => {
        const unitNumber = unit['ุฑูู  ุงููุญุฏุฉ '];

        if (selectedUnits.includes(unitNumber)) {
            // ุงููุญุฏุฉ ูุญุฏุฏุฉ - ุชุญุฏูุซ ุฑูู ุงูุนูุฏ
            unit['ุฑูู ุงูุนูุฏ'] = newContractNumber;
            updatedCount++;
            console.log(`โ ุชุญุฏูุซ ุงููุญุฏุฉ ${unitNumber} ููุนูุฏ ${newContractNumber}`);
        } else {
            // ุงููุญุฏุฉ ุบูุฑ ูุญุฏุฏุฉ - ุฅุฒุงูุฉ ุฑูู ุงูุนูุฏ
            unit['ุฑูู ุงูุนูุฏ'] = '';
            removedCount++;
            console.log(`๐ ูุตู ุงููุญุฏุฉ ${unitNumber} ูู ุงูุนูุฏ`);
        }
    });

    // ุญูุธ ุงูุจูุงูุงุช
    try {
        localStorage.setItem('properties', JSON.stringify(properties));
        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู ุจูุฌุงุญ');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู:', error);
        alert('ูุดู ูู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู');
        return;
    }

    // ุญูุธ ูู Supabase ุฅุฐุง ูุงู ูุชููุฑุงู
    if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof savePropertyToSupabase === 'function') {
        console.log('โ๏ธ ุญูุธ ุงูุจูุงูุงุช ูู Supabase...');
        let supabaseErrors = 0;

        try {
            // ุงุณุชุฎุฏุงู Promise.all ููุญูุธ ุงููุชุฒุงูู
            const savePromises = allContractUnits.map(async (unit) => {
                try {
                    const result = await savePropertyToSupabase(unit);
                    if (result) {
                        console.log(`โ ุชู ุญูุธ ุชุญุฏูุซ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ูู Supabase`);
                        return true;
                    } else {
                        console.error(`โ ูุดู ุญูุธ ุชุญุฏูุซ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ูู Supabase`);
                        supabaseErrors++;
                        return false;
                    }
                } catch (error) {
                    console.error(`โ ุฎุทุฃ ูู ุญูุธ ุชุญุฏูุซ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}:`, error);
                    supabaseErrors++;
                    return false;
                }
            });

            await Promise.all(savePromises);

            if (supabaseErrors === 0) {
                console.log('โ ุชู ุญูุธ ุฌููุน ุงูุจูุงูุงุช ูู Supabase ุจูุฌุงุญ');
            } else {
                console.warn(`โ๏ธ ูุดู ุญูุธ ${supabaseErrors} ูุญุฏุฉ ูู Supabase`);
            }
        } catch (error) {
            console.error('โ ุฎุทุฃ ุนุงู ูู ุญูุธ ุงูุจูุงูุงุช ูู Supabase:', error);
            supabaseErrors = allContractUnits.length;
        }
    }

    // ุฅุบูุงู ุงููุงูุฐุฉ
    document.querySelector('.modal-overlay').remove();

    // ุฑุณุงูุฉ ุงููุฌุงุญ ูุน ุชูุงุตูู ุงูุญูุธ
    let message = `ุชู ุชุญุฏูุซ ุงูุนูุฏ ุจูุฌุงุญ!\n`;
    if (updatedCount > 0) {
        message += `- ุชู ุชุญุฏูุซ ${updatedCount} ูุญุฏุฉ ููุนูุฏ ุฑูู ${newContractNumber}\n`;
    }
    if (removedCount > 0) {
        message += `- ุชู ูุตู ${removedCount} ูุญุฏุฉ ูู ุงูุนูุฏ\n`;
    }

    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
        if (supabaseErrors === 0) {
            message += `โ ุชู ุญูุธ ุฌููุน ุงูุชุบููุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ`;
        } else if (supabaseErrors > 0) {
            message += `โ๏ธ ุชุญุฐูุฑ: ูุดู ุญูุธ ${supabaseErrors} ูุญุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ`;
        }
    }

    alert(message);

    // ุชุญุฏูุซ ุงูุนุฑุถ
    const mergedDisplay = document.getElementById('mergedUnitsDisplay');
    if (mergedDisplay) {
        mergedDisplay.innerHTML = renderMergedUnits();
    }

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูุถูุงู ุงูุชุญุฏูุซ
    setTimeout(() => {
        renderData();
        initializeApp();
    }, 500);

    console.log('๐ ุชูุช ุนูููุฉ ุงูุชุญุฑูุฑ ุจูุฌุงุญ');
}

// ุงูุจุญุซ ูู ุงููุญุฏุงุช
function searchUnits() {
    const searchTerm = document.getElementById('unitsSearchInput').value.toLowerCase();
    const propertyFilter = document.getElementById('unitsFilterProperty').value;

    let filteredUnits = properties;

    // ุชุทุจูู ููุชุฑ ุงูุนูุงุฑ
    if (propertyFilter) {
        filteredUnits = filteredUnits.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyFilter);
    }

    // ุชุทุจูู ุงูุจุญุซ ุงููุตู
    if (searchTerm) {
        filteredUnits = filteredUnits.filter(p =>
            (p['ุฑูู  ุงููุญุฏุฉ '] && p['ุฑูู  ุงููุญุฏุฉ '].toLowerCase().includes(searchTerm)) ||
            (p['ุงุณู ุงููุณุชุฃุฌุฑ'] && p['ุงุณู ุงููุณุชุฃุฌุฑ'].toLowerCase().includes(searchTerm)) ||
            (p['ุฑูู ุงูุนูุฏ'] && p['ุฑูู ุงูุนูุฏ'].toLowerCase().includes(searchTerm))
        );
    }

    displayUnitsResults(filteredUnits);
}

// ููุชุฑุฉ ุงููุญุฏุงุช ุญุณุจ ุงูุนูุงุฑ
function filterUnitsByProperty() {
    searchUnits(); // ุงุณุชุฎุฏุงู ููุณ ููุทู ุงูุจุญุซ
}

// ุนุฑุถ ูุชุงุฆุฌ ุงูุจุญุซ ูู ุงููุญุฏุงุช
function displayUnitsResults(units) {
    const container = document.getElementById('unitsResults');

    if (units.length === 0) {
        container.innerHTML = '<p class="no-data">ูุง ุชูุฌุฏ ูุญุฏุงุช ุชุทุงุจู ุงูุจุญุซ</p>';
        return;
    }

    container.innerHTML = units.map(unit => `
        <div class="unit-result-item">
            <div class="unit-info">
                <h4>${unit['ุฑูู  ุงููุญุฏุฉ ']}</h4>
                <p><strong>ุงูุนูุงุฑ:</strong> ${unit['ุงุณู ุงูุนูุงุฑ']}</p>
                <p><strong>ุงููุฏููุฉ:</strong> ${unit['ุงููุฏููุฉ']}</p>
                <p><strong>ุงููุณุงุญุฉ:</strong> ${unit['ุงููุณุงุญุฉ'] ? unit['ุงููุณุงุญุฉ'] + ' ูยฒ' : 'ุบูุฑ ูุญุฏุฏ'}</p>
                <p><strong>ุงููุณุชุฃุฌุฑ:</strong> ${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || 'ูุงุฑุบ'}</p>
                <p><strong>ุฑูู ุงูุนูุฏ:</strong> ${unit['ุฑูู ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</p>
            </div>
            <div class="unit-actions">
                <button onclick="editUnit('${unit['ุฑูู  ุงููุญุฏุฉ ']}', '${unit['ุงุณู ุงูุนูุงุฑ']}')" class="btn-edit">
                    <i class="fas fa-edit"></i> ุชุญุฑูุฑ
                </button>
                <button onclick="showUnitDetails('${unit['ุฑูู  ุงููุญุฏุฉ ']}', '${unit['ุงุณู ุงูุนูุงุฑ']}', '${unit['ุฑูู ุงูุนูุฏ'] || ''}')" class="btn-view">
                    <i class="fas fa-eye"></i> ุนุฑุถ
                </button>
                <button onclick="deleteUnit('${unit['ุฑูู  ุงููุญุฏุฉ ']}', '${unit['ุงุณู ุงูุนูุงุฑ']}')" class="btn-delete">
                    <i class="fas fa-trash"></i> ุญุฐู
                </button>
            </div>
        </div>
    `).join('');
}

// ุชุญููู ูุชุงุฆุฌ ุงููุญุฏุงุช ุนูุฏ ูุชุญ ุงูุชุจููุจ
function loadUnitsResults() {
    displayUnitsResults(properties);
}

// ==================== ูุธุงุฆู ุงููุฑููุงุช ูุงูุชุญุฑูุฑ ููุจุทุงูุงุช ====================

// Enhanced card attachments modal with real-time cross-device synchronization
function showCardAttachmentsModal(city, propertyName, contractNumber, unitNumber) {
    console.log('๐ฏ ูุชุญ ูุงูุฐุฉ ูุฑููุงุช ุงูุจุทุงูุฉ...', { city, propertyName, contractNumber, unitNumber });

    // ุฅุบูุงู ุฃู ููุงูุฐ ููุฌูุฏุฉ ูุณุจูุงู
    closeModal();

    // ุฅูุดุงุก ููุชุงุญ ูุฑูุฏ ููุจุทุงูุฉ
    let cardKey;
    if (contractNumber) {
        cardKey = `${city}_${propertyName}_contract_${contractNumber}`;
    } else if (unitNumber) {
        cardKey = `${city}_${propertyName}_unit_${unitNumber}`;
    } else {
        cardKey = `${city}_${propertyName}_general`;
    }

    // Try to get attachments from Supabase first, fallback to local
    async function loadCardAttachments() {
        let cardAttachments = [];
        let isFromCloud = false;

        // Try Supabase first
        if (typeof getCardAttachmentsEnhanced === 'function' && supabaseClient) {
            try {
                console.log(`โ๏ธ ุฌูุจ ูุฑููุงุช ุงูุจุทุงูุฉ ${cardKey} ูู ุงูุณุญุงุจุฉ...`);
                cardAttachments = await getCardAttachmentsEnhanced(cardKey);
                isFromCloud = true;
                console.log(`โ ุชู ุฌูุจ ${cardAttachments.length} ูุฑูู ูู ุงูุณุญุงุจุฉ`);
            } catch (error) {
                console.warn('โ๏ธ ูุดู ูู ุฌูุจ ูุฑููุงุช ุงูุจุทุงูุฉ ูู ุงูุณุญุงุจุฉ:', error);
            }
        }

        // Fallback to local attachments if no cloud data
        if (!isFromCloud || cardAttachments.length === 0) {
            cardAttachments = window.cardAttachments?.[cardKey] || [];
            console.log(`๐พ ุชู ุฌูุจ ${cardAttachments.length} ูุฑูู ูุญูู ููุจุทุงูุฉ`);
        }

        return { cardAttachments, isFromCloud };
    }

    // ุชุตููู ูุฎุชูู ููุฌูุงู ูุงูุดุงุดุงุช ุงููุจูุฑุฉ
    const isMobile = isMobileDevice();

    let html;

    if (isMobile) {
        // ุชุตููู ูุฎุตุต ููุฌูุงู - ูุจุณุท ููุถุบูุท
        html = `
        <div class="modal-overlay mobile-attachments-overlay" style="display:flex;">
            <div class="modal-box mobile-attachments-modal">
                <!-- ุฑุฃุณ ุงููุงูุฐุฉ ุงููุจุณุท ููุฌูุงู -->
                <div class="mobile-attachments-header">
                    <h2><i class="fas fa-paperclip"></i> ูุฑููุงุช ุงูุจุทุงูุฉ</h2>
                    <button class="mobile-close-btn" onclick="closeModal()" title="ุฅุบูุงู">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- ูุนูููุงุช ุงูุจุทุงูุฉ ุงููุถุบูุทุฉ -->
                <div class="mobile-card-info">
                    <span><i class="fas fa-building"></i> ${propertyName}</span>
                    <span><i class="fas fa-map-marker-alt"></i> ${city}</span>
                    ${contractNumber ? `<span><i class="fas fa-file-contract"></i> ${contractNumber}</span>` : ''}
                    ${unitNumber ? `<span><i class="fas fa-home"></i> ${unitNumber}</span>` : ''}
                </div>

                <!-- ุฒุฑ ุงูุฅุฑูุงู ุงููุถุบูุท (20% ูู ุงููุณุงุญุฉ) -->
                <div class="mobile-upload-section">
                    <button class="mobile-upload-btn" onclick="document.getElementById('cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}').click()">
                        <i class="fas fa-plus"></i> ุฅุถุงูุฉ ูุฑูู
                    </button>
                    <input type="file" id="cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" multiple style="display:none" onchange="handleCardFileUploadEnhanced(event, '${cardKey}')">
                </div>

                <!-- ูุงุฆูุฉ ุงููุฑููุงุช (80% ูู ุงููุณุงุญุฉ) -->
                <div class="mobile-attachments-section">
                    <div class="mobile-attachments-header-small">
                        <span><i class="fas fa-folder-open"></i> ุงููุฑููุงุช ุงูููุฌูุฏุฉ</span>
                        <span class="mobile-attachments-count" id="mobileAttachmentsCount_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}">ุฌุงุฑู ุงูุชุญููู...</span>
                    </div>
                    <div id="cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="mobile-attachments-list">
                        <div class="mobile-loading" style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 10px;"></i>
                            <p style="font-size: 0.9rem;">ุฌุงุฑู ุชุญููู ุงููุฑููุงุช...</p>
                        </div>
                    </div>
                </div>

                <!-- ุฒุฑ ุงูุฅุบูุงู ูู ุงูุฃุณูู -->
                <div class="mobile-footer">
                    <button class="mobile-close-footer-btn" onclick="closeModal()">
                        <i class="fas fa-times"></i> ุฅุบูุงู
                    </button>
                </div>
            </div>
        </div>`;
    } else {
        // ุงูุชุตููู ุงูุญุงูู ููุดุงุดุงุช ุงููุจูุฑุฉ (ุจุฏูู ุชุบููุฑ)
        html = `
        <div class="modal-overlay enhanced-modal-overlay" style="display:flex;">
            <div class="modal-box attachments-modal enhanced-attachments-modal">
                <!-- ุฒุฑ ุงูุฅุบูุงู ุงููุญุณู -->
                <button class="close-modal enhanced-close-btn" onclick="closeModal()" title="ุฅุบูุงู ุงููุงูุฐุฉ">
                    <i class="fas fa-times"></i>
                </button>

                <!-- ุฑุฃุณ ุงููุงูุฐุฉ ุงููุญุณู -->
                <div class="attachments-modal-header enhanced-header">
                    <div class="header-content">
                        <h2><i class="fas fa-paperclip"></i> ูุฑููุงุช ุงูุจุทุงูุฉ</h2>
                        <div class="card-info">
                            <span class="info-item"><i class="fas fa-building"></i> ${propertyName}</span>
                            <span class="info-item"><i class="fas fa-map-marker-alt"></i> ${city}</span>
                            ${contractNumber ? `<span class="info-item"><i class="fas fa-file-contract"></i> ุนูุฏ: ${contractNumber}</span>` : ''}
                            ${unitNumber ? `<span class="info-item"><i class="fas fa-home"></i> ูุญุฏุฉ: ${unitNumber}</span>` : ''}
                        </div>
                    </div>
                </div>

                <!-- ูุญุชูู ุงููุงูุฐุฉ ุจุงูุชุฎุทูุท ุงูุฌุฏูุฏ -->
                <div class="attachments-modal-content enhanced-content">
                    <div class="content-layout-new">
                        <!-- ุงูุฌุงูุจ ุงูุฃูุณุฑ: ููุทูุฉ ุงูุฑูุน ูุงูููุงุญุธุงุช -->
                        <div class="upload-notes-sidebar">
                            <!-- ููุทูุฉ ุงูุฑูุน -->
                            <div class="upload-section compact-upload">
                                <div class="upload-area enhanced-upload" id="cardUploadArea_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="upload-dropzone" onclick="document.getElementById('cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}').click()">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>ุงุณุญุจ ุงููููุงุช ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
                                        <small>ูุฏุนู ุฌููุน ุฃููุงุน ุงููููุงุช</small>
                                    </div>
                                    <input type="file" id="cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" multiple style="display:none" onchange="handleCardFileUploadEnhanced(event, '${cardKey}')">
                                </div>
                            </div>

                            <!-- ูุณู ุงูููุงุญุธุงุช -->
                            <div class="notes-section-compact">
                                <div class="notes-container-compact">
                                    <h4><i class="fas fa-sticky-note"></i> ููุงุญุธุงุช</h4>
                                    <textarea
                                        id="cardUploadNotes_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}"
                                        class="notes-textarea-compact"
                                        placeholder="ุฃุถู ููุงุญุธุงุช..."
                                        rows="3"
                                    ></textarea>
                                    <div class="notes-info-compact">
                                        <small><i class="fas fa-info-circle"></i> ุณุชูุญูุธ ูุน ุงููุฑููุงุช ุงูุฌุฏูุฏุฉ</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ุงูุฌุงูุจ ุงูุฃููู: ูุงุฆูุฉ ุงููุฑููุงุช (ุงูุนุฑุถ ุงููุงูู) -->
                        <div class="attachments-main-section">
                            <div class="attachments-header">
                                <h3><i class="fas fa-folder-open"></i> ุงููุฑููุงุช ุงูููุฌูุฏุฉ</h3>
                            </div>
                            <div id="cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" class="attachments-list compact-list scrollable-attachments">
                                <div class="loading-attachments" style="text-align: center; padding: 20px; color: #666;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <p>ุฌุงุฑู ุชุญููู ุงููุฑููุงุช...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุฒุฑ ุงูุฅุบูุงู ูู ุงูุฃุณูู -->
                <div class="modal-footer-actions">
                    <button class="close-modal-btn" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                        ุฅุบูุงู ุงููุงูุฐุฉ
                    </button>
                </div>

                <!-- ุฒุฑ ุงูุนูุฏุฉ ููุฃุนูู -->
                <button class="scroll-to-top-btn" id="scrollToTopBtn_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}" onclick="scrollToTopAttachments('${cardKey}')" title="ุงูุนูุฏุฉ ููุฃุนูู">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>`;
    }

    // ุฅุฏุฑุงุฌ ุงููุงูุฐุฉ ูู ุงูุตูุญุฉ
    document.body.insertAdjacentHTML('beforeend', html);

    // ๐ฏ ุชุญููู ุงููุฑููุงุช ุจุนุฏ ุฅูุดุงุก ุงููุงูุฐุฉ (ุงูุชุตููู ุงูุณุงุจู)
    loadCardAttachments().then(({ cardAttachments, isFromCloud }) => {
        console.log(`๐ ุชู ุชุญููู ${cardAttachments.length} ูุฑูู ููุจุทุงูุฉ ${cardKey} (${isFromCloud ? 'ูู ุงูุณุญุงุจุฉ' : 'ูุญูู'})`);

        const listContainer = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (listContainer) {
            // Force visibility with enhanced mobile support
            listContainer.style.display = 'block';
            listContainer.style.visibility = 'visible';
            listContainer.style.opacity = '1';

            // Add mobile-specific classes
            if (isMobileDevice()) {
                listContainer.classList.add('mobile-list', 'mobile-optimized');
                listContainer.style.minHeight = '300px';
                listContainer.style.maxHeight = '60vh';
                listContainer.style.overflowY = 'auto';
            }

            // Render attachments with layout specific to device type
            if (isMobileDevice()) {
                listContainer.innerHTML = renderMobileCardAttachmentsList(cardKey, cardAttachments);

                // Update mobile attachments count
                const mobileCountBadge = document.getElementById(`mobileAttachmentsCount_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (mobileCountBadge) {
                    mobileCountBadge.textContent = `${cardAttachments.length} ูุฑูู`;
                }
            } else {
                listContainer.innerHTML = renderCardAttachmentsList(cardKey, cardAttachments);

                // Enhanced mobile display optimization
                enhanceAttachmentDisplayForMobile();
            }

            // ุฅุนุฏุงุฏ ุงุณูุฑูู ุงููุฑููุงุช ุจุนุฏ ุงูุชุญููู
            setTimeout(() => {
                setupAttachmentsScroll(cardKey);
            }, 100);

            // ุฅุถุงูุฉ ุณูุฑูู ููุฃุนูู ูุฅุธูุงุฑ ุงููุฑููุงุช (ููุดุงุดุงุช ุงููุจูุฑุฉ ููุท)
            if (!isMobileDevice()) {
                setTimeout(() => {
                    scrollToAttachments();
                }, 300);
            }

            console.log('โ ุชู ุนุฑุถ ุงููุฑููุงุช ูู ุงููุงูุฐุฉ ูุน ุชุญุณููุงุช ุงูุฌูุงู');
        } else {
            console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุงููุฉ ูุงุฆูุฉ ุงููุฑููุงุช');
        }
    }).catch(error => {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ูุฑููุงุช ุงูุจุทุงูุฉ:', error);

        const listContainer = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="error-loading-attachments enhanced-error" style="text-align: center; padding: ${isMobileDevice() ? '40px 20px' : '20px'}; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="font-size: ${isMobileDevice() ? '3rem' : '2rem'}; margin-bottom: ${isMobileDevice() ? '20px' : '10px'};"></i>
                    <p style="font-size: ${isMobileDevice() ? '1.2rem' : '1rem'};">ุฎุทุฃ ูู ุชุญููู ุงููุฑููุงุช</p>
                    <button onclick="refreshCardAttachmentsList('${cardKey}')" class="btn-primary" style="margin-top: ${isMobileDevice() ? '15px' : '10px'}; padding: ${isMobileDevice() ? '12px 20px' : '8px 16px'}; font-size: ${isMobileDevice() ? '1.1rem' : '0.9rem'};">
                        <i class="fas fa-refresh"></i> ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                    </button>
                </div>
            `;
        }
    });

    // ุฅุถุงูุฉ ุฃุญุฏุงุซ ุงูุณุญุจ ูุงูุฅููุงุช
    setupCardDragAndDrop(cardKey);

    // ุฅุนุฏุงุฏ ุงุณูุฑูู ุงููุฑููุงุช ูุน ุฒุฑ ุงูุนูุฏุฉ ููุฃุนูู
    setupAttachmentsScroll(cardKey);

    // ๐ง ุฅุถุงูุฉ CSS ุฅุตูุงุญู ูุถูุงู ุฅุธูุงุฑ ุงููุฑููุงุช
    const fixStyle = document.createElement('style');
    fixStyle.textContent = `
        .attachments-list,
        .card-attachments-list,
        .attachment-item,
        [id*="cardAttachmentsList"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .attachment-item {
            display: flex !important;
        }

        .loading-attachments,
        .error-loading-attachments {
            display: block !important;
            visibility: visible !important;
        }
    `;
    document.head.appendChild(fixStyle);

    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู (ุงูุชุตููู ุงูุณุงุจู)
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

// ุฏุงูุฉ ุงูุณูุฑูู ููุฃุนูู ูุฅุธูุงุฑ ุงููุฑููุงุช
function scrollToAttachments() {
    try {
        // ุงูุจุญุซ ุนู ูุณู ุงููุฑููุงุช
        const attachmentsSection = document.querySelector('.attachments-main-section');
        const attachmentsList = document.querySelector('.compact-list');

        if (attachmentsSection) {
            // ุณูุฑูู ุงููุงูุฐุฉ ููุฃุนูู ูุฅุธูุงุฑ ุงููุฑููุงุช
            attachmentsSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });

            // ุณูุฑูู ูุงุฆูุฉ ุงููุฑููุงุช ููุฃุนูู
            if (attachmentsList) {
                attachmentsList.scrollTop = 0;
            }

            console.log('๐ ุชู ุงูุณูุฑูู ูุฅุธูุงุฑ ุงููุฑููุงุช');
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุณูุฑูู:', error);
    }
}

// ุนุฑุถ ูุงุฆูุฉ ูุฑููุงุช ุงูุจุทุงูุฉ
function renderCardAttachmentsList(cardKey, attachments = null) {
    // Use provided attachments or fallback to local storage
    const cardFiles = attachments || cardAttachments[cardKey] || [];

    if (cardFiles.length === 0) {
        return '<p class="no-attachments">ูุง ุชูุฌุฏ ูุฑููุงุช ููุฐู ุงูุจุทุงูุฉ</p>';
    }

    // Check if mobile device for responsive design
    const isMobile = isMobileDevice();

    return cardFiles.map(file => {
        // Handle both local and cloud file formats
        const fileName = file.file_name || file.name;
        const fileSize = formatFileSize(file.file_size || file.size);
        const fileType = file.file_type || file.type;
        const uploadDate = new Date(file.created_at || file.uploadDate).toLocaleDateString('ar-SA');
        const fileIcon = getFileIcon(fileName);

        // Determine if file is local or cloud-based
        const isLocal = file.isLocal || !file.id || file.id.toString().startsWith('local_');
        const storageIcon = isLocal ? '๐พ' : 'โ๏ธ';
        const storageTitle = isLocal ? 'ูุญููุธ ูุญููุงู' : 'ูุญููุธ ูู ุงูุณุญุงุจุฉ';

        // Use enhanced layout for mobile and desktop
        return `
        <div class="attachment-item ${isMobile ? 'mobile-enhanced-item' : 'desktop-enhanced-item'}" data-name="${fileName}">
            <div class="file-icon-enhanced">${fileIcon}</div>
            <div class="file-info-enhanced">
                <div class="file-name-enhanced" title="${fileName}">
                    <span class="file-name-text">${fileName}</span>
                    <span class="storage-indicator-enhanced" title="${storageTitle}">${storageIcon}</span>
                </div>
                <div class="file-meta-enhanced">
                    <span class="file-size-enhanced"><i class="fas fa-weight-hanging"></i> ${fileSize}</span>
                    <span class="file-date-enhanced"><i class="fas fa-calendar"></i> ${uploadDate}</span>
                    ${(file.notes || file.description) ? `<span class="file-notes-enhanced" title="${file.notes || file.description}"><i class="fas fa-sticky-note"></i> ููุงุญุธุฉ</span>` : ''}
                </div>
            </div>
            <div class="attachment-actions-enhanced">
                ${isLocal ?
                    `<button onclick="downloadCardAttachment('${cardKey}', '${fileName}')" class="btn-enhanced btn-download" title="ุชุญููู">
                        <i class="fas fa-download"></i>
                        ${!isMobile ? '<span>ุชุญููู</span>' : ''}
                    </button>
                    <button onclick="deleteCardAttachment('${cardKey}', '${fileName}')" class="btn-enhanced btn-delete" title="ุญุฐู">
                        <i class="fas fa-trash"></i>
                        ${!isMobile ? '<span>ุญุฐู</span>' : ''}
                    </button>` :
                    `<button onclick="window.open('${file.file_url}', '_blank')" class="btn-enhanced btn-view" title="ุนุฑุถ">
                        <i class="fas fa-eye"></i>
                        ${!isMobile ? '<span>ุนุฑุถ</span>' : ''}
                    </button>
                    <button onclick="downloadAttachmentFromSupabase('${file.file_url}', '${fileName}')" class="btn-enhanced btn-download" title="ุชุญููู">
                        <i class="fas fa-download"></i>
                        ${!isMobile ? '<span>ุชุญููู</span>' : ''}
                    </button>
                    <button onclick="deleteCardAttachmentFromSupabase('${file.id}', '${cardKey}')" class="btn-enhanced btn-delete" title="ุญุฐู">
                        <i class="fas fa-trash"></i>
                        ${!isMobile ? '<span>ุญุฐู</span>' : ''}
                    </button>`
                }
            </div>
        </div>
        `;
    }).join('');
}

// ===== Render Mobile Card Attachments List =====
function renderMobileCardAttachmentsList(cardKey, attachments) {
    console.log(`๐ฑ ุนุฑุถ ${attachments.length} ูุฑูู ููุฌูุงู - ุงูุจุทุงูุฉ: ${cardKey}`);

    if (!attachments || attachments.length === 0) {
        return `
            <div class="mobile-no-attachments" style="text-align: center; padding: 30px 20px; color: #6c757d;">
                <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p style="margin: 0; font-size: 0.9rem;">ูุง ุชูุฌุฏ ูุฑููุงุช</p>
                <small style="opacity: 0.7;">ุงุณุชุฎุฏู ุฒุฑ "ุฅุถุงูุฉ ูุฑูู" ูุฑูุน ุงููููุงุช</small>
            </div>
        `;
    }

    let html = '';

    attachments.forEach((file, index) => {
        // Handle both local and cloud file formats
        const fileName = file.file_name || file.name;
        const fileSize = formatFileSize(file.file_size || file.size);
        const uploadDate = new Date(file.created_at || file.uploadDate).toLocaleDateString('ar-SA');
        const fileIcon = getFileIcon(fileName);

        // Determine file source
        const isCloudFile = file.file_url || file.url;
        const sourceIcon = isCloudFile ? 'โ๏ธ' : '๐พ';
        const sourceText = isCloudFile ? 'ุณุญุงุจู' : 'ูุญูู';

        html += `
            <div class="mobile-attachment-item" data-file-index="${index}">
                <!-- ุฃููููุฉ ุงูููู -->
                <div class="mobile-file-icon" style="color: ${getFileIconColor(fileName)};">
                    ${fileIcon}
                </div>

                <!-- ูุนูููุงุช ุงูููู -->
                <div class="mobile-file-info">
                    <div class="mobile-file-name" title="${fileName}">
                        ${fileName}
                    </div>
                    <div class="mobile-file-meta">
                        <span><i class="fas fa-weight-hanging"></i> ${fileSize}</span>
                        <span><i class="fas fa-calendar"></i> ${uploadDate}</span>
                        <span title="${sourceText}">${sourceIcon}</span>
                    </div>
                </div>

                <!-- ุฃุฒุฑุงุฑ ุงูุนูููุงุช -->
                <div class="mobile-file-actions">
                    ${isCloudFile ?
                        `<button class="mobile-action-btn view" onclick="viewAttachmentFromSupabase('${file.id}', '${file.file_url || file.url}', '${file.file_type || file.type}')" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="mobile-action-btn download" onclick="downloadAttachmentFromSupabase('${file.file_url || file.url}', '${fileName}')" title="ุชุญููู">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="mobile-action-btn delete" onclick="deleteCardAttachmentFromSupabase('${file.id}', '${cardKey}')" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>` :
                        `<button class="mobile-action-btn view" onclick="viewCardAttachment('${cardKey}', ${index})" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="mobile-action-btn download" onclick="downloadCardAttachment('${cardKey}', ${index})" title="ุชุญููู">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="mobile-action-btn delete" onclick="deleteCardAttachment('${cardKey}', ${index})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>`
                    }
                </div>
            </div>
        `;
    });

    console.log(`โ ุชู ุฅูุดุงุก ูุงุฆูุฉ ุงููุฑููุงุช ููุฌูุงู - ${attachments.length} ุนูุตุฑ`);
    return html;
}

// ูุนุงูุฌุฉ ุฑูุน ูููุงุช ุงูุจุทุงูุฉ (Legacy - redirects to enhanced version)
function handleCardFileUpload(event, cardKey) {
    console.log('๐ ุชุญููู ูู ุงููุธููุฉ ุงููุฏููุฉ ุฅูู ุงููุญุณูุฉ...');

    // Redirect to enhanced version for consistency and real-time sync
    handleCardFileUploadEnhanced(event, cardKey);
}

// Enhanced card file upload with Supabase integration
async function handleCardFileUploadEnhanced(event, cardKey) {
    const files = event.target.files;

    // Get notes from the correct element ID
    const notesElement = document.getElementById(`cardUploadNotes_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`) ||
                        document.getElementById('cardUploadNotes');
    const notes = notesElement?.value || '';

    if (files.length === 0) return;

    // Show enhanced upload progress modal
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.innerHTML = `
        <div class="modal-box upload-progress-modal" style="text-align: center; padding: 40px; max-width: 500px;">
            <div class="upload-header">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #17a2b8; margin-bottom: 1rem;"></i>
                <h3>ุฑูุน ูุฑููุงุช ุงูุจุทุงูุฉ</h3>
            </div>
            <div class="upload-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="cardProgressFill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-text">
                        <span id="cardProgressText">0 ูู ${files.length} ููู</span>
                        <span id="cardProgressPercentage">0%</span>
                    </div>
                </div>
                <div class="upload-details">
                    <p id="cardUploadStatus">ุฌุงุฑู ุงูุชุญูู ูู ุงูุงุชุตุงู...</p>
                    <p id="cardCurrentFile" style="font-size: 0.9rem; color: #666;"></p>
                </div>
            </div>
            <div class="device-sync-info" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <i class="fas fa-sync-alt" style="color: #17a2b8;"></i>
                <small>ุณูุชู ูุฒุงููุฉ ูุฑููุงุช ุงูุจุทุงูุฉ ุชููุงุฆูุงู ูุน ุฌููุน ุงูุฃุฌูุฒุฉ</small>
            </div>
        </div>
    `;
    document.body.appendChild(progressModal);

    try {
        // Check if Supabase is available and working
        const supabaseAvailable = await checkSupabaseAvailability();

        if (supabaseAvailable) {
            document.getElementById('cardUploadStatus').textContent = 'ุฌุงุฑู ุฑูุน ูุฑููุงุช ุงูุจุทุงูุฉ ุฅูู ุงูุณุญุงุจุฉ...';

            // Upload files with progress tracking
            await handleCardFilesEnhancedWithProgress(files, cardKey, notes);

            // Remove progress modal
            progressModal.remove();

            // ๐ฏ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช ููุฑุงู ุจุนุฏ ุงูุฑูุน ุงููุงุฌุญ
            setTimeout(() => {
                refreshCardAttachmentsList(cardKey);

                // Force show any hidden elements
                const allAttachmentElements = document.querySelectorAll('[id*="cardAttachments"], [class*="attachment"]');
                allAttachmentElements.forEach(el => {
                    if (el.style.display === 'none') {
                        el.style.display = 'block';
                        console.log('๐ง ุชู ุฅุธูุงุฑ ุนูุตุฑ ูุฎูู:', el);
                    }
                    if (el.style.visibility === 'hidden') {
                        el.style.visibility = 'visible';
                        console.log('๐ง ุชู ุฅุธูุงุฑ ุนูุตุฑ ูุฎูู:', el);
                    }
                });
            }, 500);

            // ุชูุธูู ุงููููุฐุฌ
            event.target.value = '';
            const notesElement = document.getElementById(`cardUploadNotes_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (notesElement) {
                notesElement.value = '';
            }

            // Show success message with cross-device info
            const successModal = document.createElement('div');
            successModal.className = 'modal-overlay';
            successModal.innerHTML = `
                <div class="modal-box success-modal" style="text-align: center; padding: 40px;">
                    <div class="success-animation">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
                    </div>
                    <h3>ุชู ุฑูุน ูุฑููุงุช ุงูุจุทุงูุฉ ุจูุฌุงุญ!</h3>
                    <div class="success-details">
                        <p>ุชู ุฑูุน ${files.length} ููู ุฅูู ุงูุณุญุงุจุฉ</p>
                        <div class="sync-status" style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
                            <i class="fas fa-globe" style="margin-left: 8px;"></i>
                            <strong>ูุชุฒุงูู ุนุจุฑ ุฌููุน ุงูุฃุฌูุฒุฉ</strong>
                            <br>
                            <small>ูุฑููุงุช ุงูุจุทุงูุฉ ูุชุงุญุฉ ุงูุขู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ ูุงููุชุตูุญุงุช</small>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-primary" onclick="closeModal(); refreshCardAttachmentsList('${cardKey}')">
                            <i class="fas fa-eye"></i> ุนุฑุถ ุงููุฑููุงุช
                        </button>
                        <button class="btn-secondary" onclick="closeModal()">
                            <i class="fas fa-times"></i> ุฅุบูุงู
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);

            // Auto-close success modal after 5 seconds
            setTimeout(() => {
                if (document.body.contains(successModal)) {
                    successModal.remove();
                }
            }, 5000);

        } else {
            throw new Error('Supabase ุบูุฑ ูุชููุฑ');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฑูุน ูุฑููุงุช ุงูุจุทุงูุฉ:', error);

        // Update status
        document.getElementById('cardUploadStatus').textContent = 'ุฌุงุฑู ุงูุญูุธ ูุญููุงู...';

        // Fallback to local upload
        await handleCardFilesLocal(files, cardKey, notes);

        // Remove progress modal
        progressModal.remove();

        // ๐ฏ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช ุญุชู ูู ุญุงูุฉ ุงูุญูุธ ุงููุญูู
        setTimeout(() => {
            refreshCardAttachmentsList(cardKey);
        }, 500);

        // Show fallback message with sync options
        const fallbackModal = document.createElement('div');
        fallbackModal.className = 'modal-overlay';
        fallbackModal.innerHTML = `
            <div class="modal-box fallback-modal" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                <h3>ุชู ุญูุธ ูุฑููุงุช ุงูุจุทุงูุฉ ูุญููุงู</h3>
                <div class="fallback-details">
                    <p>ูู ูุชููู ูู ุงูุฑูุน ููุณุญุงุจุฉุ ุชู ุญูุธ ุงููููุงุช ูุญููุงู</p>
                    <div class="local-storage-info" style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
                        <i class="fas fa-laptop" style="margin-left: 8px;"></i>
                        <strong>ูุญููุธ ุนูู ูุฐุง ุงูุฌูุงุฒ ููุท</strong>
                        <br>
                        <small>ููููู ุงููุฒุงููุฉ ูุงุญูุงู ุนูุฏ ุชููุฑ ุงูุงุชุตุงู</small>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="closeModal(); refreshCardAttachmentsList('${cardKey}')">
                        <i class="fas fa-eye"></i> ุนุฑุถ ุงููุฑููุงุช
                    </button>
                    <button class="btn-warning" onclick="closeModal(); retryCardUploadToSupabase('${cardKey}')">
                        <i class="fas fa-sync"></i> ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> ุฅุบูุงู
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(fallbackModal);
    }
}

// Handle card files upload with progress
async function handleCardFilesEnhancedWithProgress(files, cardKey, notes) {
    let uploadedCount = 0;
    const totalFiles = files.length;

    for (let i = 0; i < files.length; i++) {
        const file = files[i];

        // Update progress
        const progressFill = document.getElementById('cardProgressFill');
        const progressText = document.getElementById('cardProgressText');
        const progressPercentage = document.getElementById('cardProgressPercentage');
        const currentFileElement = document.getElementById('cardCurrentFile');

        if (currentFileElement) {
            currentFileElement.textContent = `ุฌุงุฑู ุฑูุน: ${file.name}`;
        }

        try {
            if (typeof uploadCardFileToSupabase === 'function') {
                const result = await uploadCardFileToSupabase(file, cardKey, notes);

                if (result) {
                    uploadedCount++;

                    // Update progress
                    const progress = Math.round((uploadedCount / totalFiles) * 100);
                    if (progressFill) progressFill.style.width = progress + '%';
                    if (progressText) progressText.textContent = `${uploadedCount} ูู ${totalFiles} ููู`;
                    if (progressPercentage) progressPercentage.textContent = progress + '%';

                    console.log(`โ ุชู ุฑูุน ููู ุงูุจุทุงูุฉ: ${file.name}`);

                    // ๐ฏ ุฅุทูุงู ุญุฏุซ real-time ูููุฒุงููุฉ ุงูููุฑูุฉ
                    window.dispatchEvent(new CustomEvent('cardAttachmentAdded', {
                        detail: { cardKey, attachment: result }
                    }));

                    // ุฅุทูุงู ุญุฏุซ ุนุงู ูููุฑููุงุช
                    window.dispatchEvent(new CustomEvent('attachmentAdded', {
                        detail: {
                            type: 'card',
                            cardKey,
                            attachment: result,
                            propertyKey: cardKey // ููุชูุงูู ูุน ุงููุธุงู ุงูุนุงู
                        }
                    }));
                } else {
                    throw new Error('ูู ูุชู ุฅุฑุฌุงุน ุจูุงูุงุช ุงูููู');
                }
            } else {
                throw new Error('ูุธููุฉ uploadCardFileToSupabase ุบูุฑ ูุชููุฑุฉ');
            }
        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุฑูุน ููู ุงูุจุทุงูุฉ ${file.name}:`, error);
            throw error;
        }
    }
}

// Handle card files local storage fallback
async function handleCardFilesLocal(files, cardKey, notes) {
    const cardFiles = [];

    for (const file of files) {
        const reader = new FileReader();

        await new Promise((resolve) => {
            reader.onload = function(e) {
                const fileData = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    data: e.target.result,
                    uploadDate: new Date().toISOString(),
                    notes: notes
                };

                cardFiles.push(fileData);
                resolve();
            };
            reader.readAsDataURL(file);
        });
    }

    // Save to localStorage
    if (!window.cardAttachments) {
        window.cardAttachments = {};
    }

    if (!window.cardAttachments[cardKey]) {
        window.cardAttachments[cardKey] = [];
    }

    window.cardAttachments[cardKey].push(...cardFiles);
    localStorage.setItem('cardAttachments', JSON.stringify(window.cardAttachments));

    console.log(`๐พ ุชู ุญูุธ ${cardFiles.length} ููู ุจุทุงูุฉ ูุญููุงู`);
}

// ุฅุนุฏุงุฏ ุงูุณุญุจ ูุงูุฅููุงุช ููุฑููุงุช ุงูุจุทุงูุฉ
function setupCardDragAndDrop(cardKey) {
    const uploadArea = document.getElementById(`cardUploadArea_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (!uploadArea) return;

    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        const files = Array.from(e.dataTransfer.files);
        const fileInput = document.getElementById(`cardFileInput_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);

        if (fileInput && files.length > 0) {
            // ูุญุงูุงุฉ ุงุฎุชูุงุฑ ุงููููุงุช
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;

            // ุชุดุบูู ุญุฏุซ ุงูุชุบููุฑ
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    });
}

// ุชุญููู ูุฑูู ุงูุจุทุงูุฉ
function downloadCardAttachment(cardKey, fileName) {
    const cardFiles = cardAttachments[cardKey] || [];
    const file = cardFiles.find(f => f.name === fileName);

    if (!file) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููู');
        return;
    }

    const link = document.createElement('a');
    link.href = file.data;
    link.download = file.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ุนุฑุถ ูุฑูู ุงูุจุทุงูุฉ
function viewCardAttachment(cardKey, fileIndex) {
    const cardFiles = cardAttachments[cardKey] || [];
    const file = cardFiles[fileIndex];

    if (!file) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููู');
        return;
    }

    // ูุชุญ ุงูููู ูู ูุงูุฐุฉ ุฌุฏูุฏุฉ
    const newWindow = window.open('', '_blank');
    newWindow.document.write(`
        <html>
            <head>
                <title>${file.name}</title>
                <style>
                    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                    img { max-width: 100%; height: auto; }
                    .file-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                </style>
            </head>
            <body>
                <div class="file-info">
                    <h2>${file.name}</h2>
                    <p>ุงูุญุฌู: ${formatFileSize(file.size)}</p>
                    <p>ุชุงุฑูุฎ ุงูุฑูุน: ${new Date(file.uploadDate).toLocaleDateString('ar-SA')}</p>
                    ${file.notes ? `<p>ููุงุญุธุงุช: ${file.notes}</p>` : ''}
                </div>
                ${file.type.startsWith('image/') ?
                    `<img src="${file.data}" alt="${file.name}">` :
                    `<p>ูุง ูููู ุนุฑุถ ูุฐุง ุงูููุน ูู ุงููููุงุช. <a href="${file.data}" download="${file.name}">ุชุญููู ุงูููู</a></p>`
                }
            </body>
        </html>
    `);
}

// ุญุฐู ูุฑูู ุงูุจุทุงูุฉ
function deleteCardAttachment(cardKey, fileName) {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุฑููุ')) return;

    cardAttachments[cardKey] = (cardAttachments[cardKey] || []).filter(f => f.name !== fileName);
    localStorage.setItem('cardAttachments', JSON.stringify(cardAttachments));

    // ุชุญุฏูุซ ุงููุงุฆูุฉ
    const listContainer = document.getElementById(`cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (listContainer) {
        if (isMobileDevice()) {
            listContainer.innerHTML = renderMobileCardAttachmentsList(cardKey, cardAttachments[cardKey] || []);
        } else {
            listContainer.innerHTML = renderCardAttachmentsList(cardKey);
        }
    }
}

// Enhanced delete card attachment from Supabase
async function deleteCardAttachmentFromSupabase(attachmentId, cardKey) {
    try {
        if (typeof deleteCardAttachmentEnhanced === 'function') {
            const success = await deleteCardAttachmentEnhanced(attachmentId);

            if (success) {
                // Refresh the attachments list
                await refreshCardAttachmentsList(cardKey);

                // Show success notification
                showConnectionNotification('ุชู ุญุฐู ูุฑูู ุงูุจุทุงูุฉ ุจูุฌุงุญ', 'success');
            }
        } else {
            throw new Error('ูุธููุฉ deleteCardAttachmentEnhanced ุบูุฑ ูุชููุฑุฉ');
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ูุฑูู ุงูุจุทุงูุฉ:', error);
        alert(`ุฎุทุฃ ูู ุญุฐู ุงููุฑูู: ${error.message}`);
    }
}

// Setup enhanced drag and drop for card attachments
function setupCardDragAndDropEnhanced(cardKey) {
    const uploadZone = document.querySelector('.upload-zone.enhanced');
    if (!uploadZone) return;

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#007bff';
        uploadZone.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
    });

    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#17a2b8';
        uploadZone.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const fileInput = document.getElementById('cardFileInput');
            if (fileInput) {
                fileInput.files = files;
                handleCardFileUploadEnhanced({ target: { files } }, cardKey);
            }
        }
    });
}

// Setup real-time updates for card modal
function setupCardModalRealTimeUpdates(cardKey) {
    // Listen for card attachment changes
    window.addEventListener('cardAttachmentAdded', (event) => {
        if (event.detail.cardKey === cardKey) {
            console.log(`๐ ุชุญุฏูุซ ูุฑููุงุช ุงูุจุทุงูุฉ: ${cardKey} - ููู ุฌุฏูุฏ`);
            refreshCardAttachmentsList(cardKey);

            // Show notification if not from current user
            if (!isCurrentUserAction(event.detail.attachment)) {
                showConnectionNotification(`ุชู ุฅุถุงูุฉ ููู ุฌุฏูุฏ ููุจุทุงูุฉ: ${event.detail.attachment.file_name}`, 'info');
            }
        }
    });

    window.addEventListener('cardAttachmentDeleted', (event) => {
        if (event.detail.cardKey === cardKey) {
            console.log(`๐ ุชุญุฏูุซ ูุฑููุงุช ุงูุจุทุงูุฉ: ${cardKey} - ุญุฐู ููู`);
            refreshCardAttachmentsList(cardKey);

            // Show notification if not from current user
            if (!isCurrentUserAction(event.detail.attachment)) {
                showConnectionNotification(`ุชู ุญุฐู ููู ูู ุงูุจุทุงูุฉ: ${event.detail.attachment.file_name}`, 'warning');
            }
        }
    });

    // Listen for general attachment events (for compatibility)
    window.addEventListener('attachmentAdded', (event) => {
        if (event.detail.type === 'card' && event.detail.cardKey === cardKey) {
            console.log(`๐ ุชุญุฏูุซ ุนุงู ููุฑููุงุช ุงูุจุทุงูุฉ: ${cardKey}`);
            refreshCardAttachmentsList(cardKey);
        }
    });
}

// Update card sync status
function updateCardSyncStatus() {
    const syncStatus = document.getElementById('cardSyncStatus');
    if (!syncStatus) return;

    if (supabaseClient && typeof getCardAttachmentsEnhanced === 'function') {
        syncStatus.innerHTML = '<i class="fas fa-sync-alt" style="color: #28a745;"></i> ูุชุฒุงูู';
        syncStatus.title = 'ูุชุฒุงูู ูุน ุงูุณุญุงุจุฉ';
    } else {
        syncStatus.innerHTML = '<i class="fas fa-wifi-slash" style="color: #ffc107;"></i> ูุญูู ููุท';
        syncStatus.title = 'ุบูุฑ ูุชุตู - ุงูุจูุงูุงุช ูุญููุฉ ููุท';
    }
}

// Filter card attachments list
function filterCardAttachmentsList(event) {
    const searchTerm = event.target.value.toLowerCase();
    const attachmentItems = document.querySelectorAll('.card-attachments-list .attachment-item');

    attachmentItems.forEach(item => {
        const fileName = item.getAttribute('data-name') || '';
        const isVisible = fileName.includes(searchTerm);
        item.style.display = isVisible ? 'flex' : 'none';
    });
}

// Refresh card attachments list in modal
async function refreshCardAttachmentsList(cardKey) {
    try {
        console.log(`๐ ุชุญุฏูุซ ูุงุฆูุฉ ูุฑููุงุช ุงูุจุทุงูุฉ: ${cardKey}`);

        // Try multiple selectors to find the list container
        const possibleSelectors = [
            `cardAttachmentsList_${cardKey.replace(/[^a-zA-Z0-9]/g, '_')}`,
            'cardAttachmentsList',
            'attachmentsList'
        ];

        let listContainer = null;
        for (const selector of possibleSelectors) {
            listContainer = document.getElementById(selector);
            if (listContainer) {
                console.log(`โ ุชู ุงูุนุซูุฑ ุนูู ุงูุญุงููุฉ: #${selector}`);
                break;
            }
        }

        if (!listContainer) {
            console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุงููุฉ ูุงุฆูุฉ ุงููุฑููุงุช');
            console.log('๐ ุงูุนูุงุตุฑ ุงููุชุงุญุฉ:');
            possibleSelectors.forEach(selector => {
                console.log(`- #${selector}:`, document.getElementById(selector));
            });
            return;
        }

        // Get updated attachments
        let attachments = [];

        // Try to get from Supabase first
        if (typeof getCardAttachmentsEnhanced === 'function') {
            try {
                attachments = await getCardAttachmentsEnhanced(cardKey);
                console.log(`โ๏ธ ุชู ุฌูุจ ${attachments.length} ูุฑูู ูู ุงูุณุญุงุจุฉ`);
            } catch (error) {
                console.warn('โ๏ธ ูุดู ูู ุฌูุจ ุงููุฑููุงุช ูู ุงูุณุญุงุจุฉ:', error);
            }
        }

        // Fallback to local storage if no cloud attachments
        if (attachments.length === 0) {
            const localAttachments = window.cardAttachments?.[cardKey] || [];
            attachments = localAttachments.map(att => ({
                id: 'local_' + Date.now(),
                file_name: att.name,
                file_size: att.size,
                file_type: att.type,
                created_at: att.uploadDate,
                notes: att.notes,
                isLocal: true
            }));
            console.log(`๐พ ุชู ุฌูุจ ${attachments.length} ูุฑูู ูุญูู`);
        }

        // Force visibility before updating
        listContainer.style.display = 'block';
        listContainer.style.visibility = 'visible';
        listContainer.style.opacity = '1';

        // Update the list
        listContainer.innerHTML = renderCardAttachmentsList(cardKey, attachments);

        // Force visibility of all attachment items
        setTimeout(() => {
            const attachmentItems = listContainer.querySelectorAll('.attachment-item');
            attachmentItems.forEach(item => {
                item.style.display = 'flex';
                item.style.visibility = 'visible';
                item.style.opacity = '1';
            });

            // Force visibility of the entire container again
            listContainer.style.display = 'block';
            listContainer.style.visibility = 'visible';
            listContainer.style.opacity = '1';

            console.log(`๐ง ุชู ุฅุฌุจุงุฑ ุฅุธูุงุฑ ${attachmentItems.length} ุนูุตุฑ ูุฑูู`);
        }, 100);

        // Update attachment count badge if exists
        const countBadge = document.querySelector(`[data-card-key="${cardKey}"] .attachment-count`);
        if (countBadge) {
            countBadge.textContent = `${attachments.length} ูุฑูู`;
        }

        console.log(`โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ูุฑููุงุช ุงูุจุทุงูุฉ: ${attachments.length} ูุฑูู`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฆูุฉ ูุฑููุงุช ุงูุจุทุงูุฉ:', error);
    }
}

// Check Supabase availability for card attachments
async function checkSupabaseAvailability() {
    try {
        if (!supabaseClient || typeof getCardAttachmentsEnhanced !== 'function') {
            return false;
        }

        // Test connection with a simple query
        const { error } = await supabaseClient
            .from('card_attachments')
            .select('count', { count: 'exact', head: true });

        return !error;
    } catch (error) {
        console.warn('โ๏ธ Supabase ุบูุฑ ูุชููุฑ ููุจุทุงูุงุช:', error);
        return false;
    }
}

// Retry card upload to Supabase
async function retryCardUploadToSupabase(cardKey) {
    try {
        const localAttachments = window.cardAttachments?.[cardKey] || [];

        if (localAttachments.length === 0) {
            alert('ูุง ุชูุฌุฏ ูุฑููุงุช ูุญููุฉ ูููุฒุงููุฉ');
            return;
        }

        // Show progress modal
        const progressModal = document.createElement('div');
        progressModal.className = 'modal-overlay';
        progressModal.innerHTML = `
            <div class="modal-box" style="text-align: center; padding: 40px;">
                <i class="fas fa-sync-alt fa-spin" style="font-size: 3rem; color: #17a2b8; margin-bottom: 1rem;"></i>
                <h3>ูุฒุงููุฉ ูุฑููุงุช ุงูุจุทุงูุฉ</h3>
                <p>ุฌุงุฑู ุฑูุน ุงููุฑููุงุช ุงููุญููุฉ ุฅูู ุงูุณุญุงุจุฉ...</p>
                <div class="progress-info">
                    <span id="syncProgress">0 ูู ${localAttachments.length}</span>
                </div>
            </div>
        `;
        document.body.appendChild(progressModal);

        let syncedCount = 0;
        const progressElement = document.getElementById('syncProgress');

        for (const attachment of localAttachments) {
            try {
                // Convert data URL back to file
                const response = await fetch(attachment.data);
                const blob = await response.blob();
                const file = new File([blob], attachment.name, { type: attachment.type });

                // Upload to Supabase
                if (typeof uploadCardFileToSupabase === 'function') {
                    await uploadCardFileToSupabase(file, cardKey, attachment.notes);
                    syncedCount++;

                    if (progressElement) {
                        progressElement.textContent = `${syncedCount} ูู ${localAttachments.length}`;
                    }
                }
            } catch (error) {
                console.error(`โ ูุดู ูู ูุฒุงููุฉ ${attachment.name}:`, error);
            }
        }

        // Remove progress modal
        progressModal.remove();

        if (syncedCount > 0) {
            // Clear local attachments after successful sync
            delete window.cardAttachments[cardKey];
            localStorage.setItem('cardAttachments', JSON.stringify(window.cardAttachments));

            // Refresh the list
            await refreshCardAttachmentsList(cardKey);

            alert(`ุชู ูุฒุงููุฉ ${syncedCount} ูู ${localAttachments.length} ููู ุจูุฌุงุญ`);
        } else {
            alert('ูุดู ูู ูุฒุงููุฉ ุงููุฑููุงุช. ุชุญูู ูู ุงูุงุชุตุงู ูุญุงูู ูุฑุฉ ุฃุฎุฑู.');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุงููุญุงููุฉ:', error);
        alert(`ุฎุทุฃ ูู ุงููุฒุงููุฉ: ${error.message}`);
    }
}

// ุนุฑุถ ูุงูุฐุฉ ุชุญุฑูุฑ ุงูุจุทุงูุฉ
function showCardEditModal(contractNumber, propertyName, unitNumber) {
    console.log('๐ ุจุฏุก ุงูุจุญุซ ุนู ุงููุญุฏุฉ ููุชุนุฏูู:', { contractNumber, propertyName, unitNumber });

    // ุงูุจุญุซ ุนู ุงูุจูุงูุงุช ุงููุทููุจ ุชุญุฑูุฑูุง ูุน ุชุณุฌูู ููุตู
    let property;
    let searchMethod = '';

    if (contractNumber && propertyName) {
        // ุงูุจุญุซ ุจูุงุกู ุนูู ุฑูู ุงูุนูุฏ ูุงุณู ุงูุนูุงุฑ
        searchMethod = 'contract_and_property';
        property = properties.find(p =>
            p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
        );
        console.log(`๐ ุงูุจุญุซ ุจุงูุนูุฏ ูุงูุนูุงุฑ: ุงูุนูุฏ="${contractNumber}", ุงูุนูุงุฑ="${propertyName}" โ ${property ? 'ููุฌูุฏ' : 'ุบูุฑ ููุฌูุฏ'}`);
    }

    if (!property && unitNumber && propertyName) {
        // ุงูุจุญุซ ุจูุงุกู ุนูู ุฑูู ุงููุญุฏุฉ ูุงุณู ุงูุนูุงุฑ
        searchMethod = 'unit_and_property';
        property = properties.find(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
        );
        console.log(`๐ ุงูุจุญุซ ุจุงููุญุฏุฉ ูุงูุนูุงุฑ: ุงููุญุฏุฉ="${unitNumber}", ุงูุนูุงุฑ="${propertyName}" โ ${property ? 'ููุฌูุฏ' : 'ุบูุฑ ููุฌูุฏ'}`);
    }

    // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉุ ุฌุฑุจ ุจุญุซ ุฃูุณุน
    if (!property && unitNumber) {
        searchMethod = 'unit_only';
        property = properties.find(p => p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber);
        console.log(`๐ ุงูุจุญุซ ุจุงููุญุฏุฉ ููุท: ุงููุญุฏุฉ="${unitNumber}" โ ${property ? 'ููุฌูุฏ' : 'ุบูุฑ ููุฌูุฏ'}`);

        if (property) {
            console.log(`โ๏ธ ุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุจุงูุฑูู ููุทุ ููู ุงูุนูุงุฑ ูุฎุชูู: "${property['ุงุณู ุงูุนูุงุฑ']}" ุจุฏูุงู ูู "${propertyName}"`);
        }
    }

    if (!property) {
        console.error('โ ูุดู ูู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุจุฌููุน ุทุฑู ุงูุจุญุซ');
        console.log('๐ ุฌููุน ุงููุญุฏุงุช ุงููุชุงุญุฉ:');
        properties.forEach((p, index) => {
            console.log(`   ${index}: ูุญุฏุฉ="${p['ุฑูู  ุงููุญุฏุฉ ']}", ุนูุงุฑ="${p['ุงุณู ุงูุนูุงุฑ']}", ุนูุฏ="${p['ุฑูู ุงูุนูุฏ']}"`);
        });

        alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุจูุงูุงุช ุงููุทููุจุฉ\n\nุชูุงุตูู ุงูุจุญุซ:\n' +
              `- ุฑูู ุงูุนูุฏ: ${contractNumber || 'ุบูุฑ ูุญุฏุฏ'}\n` +
              `- ุงุณู ุงูุนูุงุฑ: ${propertyName || 'ุบูุฑ ูุญุฏุฏ'}\n` +
              `- ุฑูู ุงููุญุฏุฉ: ${unitNumber || 'ุบูุฑ ูุญุฏุฏ'}\n\n` +
              'ูุฑุฌู ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ุฃู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
        return;
    }

    console.log(`โ ุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุจุทุฑููุฉ: ${searchMethod}`);
    console.log('๐ ุจูุงูุงุช ุงููุญุฏุฉ ุงูููุฌูุฏุฉ:', {
        unitNumber: property['ุฑูู  ุงููุญุฏุฉ '],
        propertyName: property['ุงุณู ุงูุนูุงุฑ'],
        contractNumber: property['ุฑูู ุงูุนูุฏ'],
        tenant: property['ุงุณู ุงููุณุชุฃุฌุฑ']
    });

    // โ ุงูุจุญุซ ุนู ุฌููุน ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ (ููุณ ุงูุนูุฏ ุฃู ููุณ ุงููุณุชุฃุฌุฑ) ูุน ุชุฌูุจ ุงูุชูุฑุงุฑ
    let relatedUnits = [];

    if (contractNumber && contractNumber.trim() !== '') {
        // ุงูุจุญุซ ุจูุงุกู ุนูู ุฑูู ุงูุนูุฏ ูุน ุชุฌูุจ ุงูุชูุฑุงุฑ
        const uniqueUnits = new Map();
        const candidateUnits = properties.filter(p =>
            p['ุฑูู ุงูุนูุฏ'] === contractNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === propertyName
        );

        // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑ ุจูุงุกู ุนูู ุฑูู ุงููุญุฏุฉ
        candidateUnits.forEach(unit => {
            const unitKey = `${unit['ุงุณู ุงูุนูุงุฑ']}_${unit['ุฑูู  ุงููุญุฏุฉ ']}`;
            if (!uniqueUnits.has(unitKey)) {
                uniqueUnits.set(unitKey, unit);
            }
        });

        relatedUnits = Array.from(uniqueUnits.values());
        console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${relatedUnits.length} ูุญุฏุฉ ูุฑูุฏุฉ ูุฑุชุจุทุฉ ุจุงูุนูุฏ "${contractNumber}" (ูู ุฃุตู ${candidateUnits.length})`);
    } else if (property['ุงุณู ุงููุณุชุฃุฌุฑ'] && property['ุงุณู ุงููุณุชุฃุฌุฑ'].trim() !== '') {
        // ุงูุจุญุซ ุจูุงุกู ุนูู ุงุณู ุงููุณุชุฃุฌุฑ ูุน ุชุฌูุจ ุงูุชูุฑุงุฑ
        const uniqueUnits = new Map();
        const candidateUnits = properties.filter(p =>
            p['ุงุณู ุงููุณุชุฃุฌุฑ'] === property['ุงุณู ุงููุณุชุฃุฌุฑ'] &&
            p['ุงุณู ุงูุนูุงุฑ'] === propertyName
        );

        // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑ ุจูุงุกู ุนูู ุฑูู ุงููุญุฏุฉ
        candidateUnits.forEach(unit => {
            const unitKey = `${unit['ุงุณู ุงูุนูุงุฑ']}_${unit['ุฑูู  ุงููุญุฏุฉ ']}`;
            if (!uniqueUnits.has(unitKey)) {
                uniqueUnits.set(unitKey, unit);
            }
        });

        relatedUnits = Array.from(uniqueUnits.values());
        console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${relatedUnits.length} ูุญุฏุฉ ูุฑูุฏุฉ ูุฑุชุจุทุฉ ุจุงููุณุชุฃุฌุฑ "${property['ุงุณู ุงููุณุชุฃุฌุฑ']}" (ูู ุฃุตู ${candidateUnits.length})`);
    } else {
        // ูุญุฏุฉ ูุงุญุฏุฉ ููุท
        relatedUnits = [property];
        console.log(`๐ ูุญุฏุฉ ูุงุญุฏุฉ ููุท (ูุง ููุฌุฏ ุนูุฏ ุฃู ูุณุชุฃุฌุฑ)`);
    }

    // ุฅุฐุง ูุงู ููุงู ุฃูุซุฑ ูู ูุญุฏุฉุ ุงุณุชุฎุฏู ูุงูุฐุฉ ุงูุชุญุฑูุฑ ุงููุชุนุฏุฏุฉ
    if (relatedUnits.length > 1) {
        console.log(`๐ฏ ุนุฑุถ ูุงูุฐุฉ ุงูุชุญุฑูุฑ ุงููุชุนุฏุฏุฉ ูู ${relatedUnits.length} ูุญุฏุฉ`);
        showMultiUnitEditModal(relatedUnits, property);
        return;
    }

    // ุฅุฐุง ูุงูุช ูุญุฏุฉ ูุงุญุฏุฉ ููุทุ ุงุณุชุฎุฏู ุงููุงูุฐุฉ ุงูุนุงุฏูุฉ
    console.log(`๐ ุนุฑุถ ูุงูุฐุฉ ุงูุชุญุฑูุฑ ุงูุนุงุฏูุฉ ููุญุฏุฉ ูุงุญุฏุฉ`);
    showSingleUnitEditModal(property, contractNumber, propertyName, unitNumber);
}

// ุนุฑุถ ูุงูุฐุฉ ุชุญุฑูุฑ ูุญุณูุฉ ูููุญุฏุงุช ุงููุชุนุฏุฏุฉ - ูุณุฎุฉ ุทุจู ุงูุฃุตู ูู ุงููุฑุฏูุฉ
function showMultiUnitEditModal(relatedUnits, primaryUnit) {
    console.log(`๐ฏ ุฅูุดุงุก ูุงูุฐุฉ ุชุญุฑูุฑ ูุญุณูุฉ ูู ${relatedUnits.length} ูุญุฏุฉ`);

    const contractNumber = primaryUnit['ุฑูู ุงูุนูุฏ'] || '';
    const propertyName = primaryUnit['ุงุณู ุงูุนูุงุฑ'] || '';
    const tenantName = primaryUnit['ุงุณู ุงููุณุชุฃุฌุฑ'] || '';
    const unitNumber = primaryUnit['ุฑูู  ุงููุญุฏุฉ '] || '';

    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box property-edit-modal">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <div class="edit-modal-header">
                <h2><i class="fas fa-edit"></i> ุชุญุฑูุฑ ุนุฏุฉ ูุญุฏุงุช</h2>
                <p>${propertyName} - ${contractNumber ? 'ุนูุฏ ุฑูู: ' + contractNumber : 'ูุณุชุฃุฌุฑ: ' + tenantName}</p>
                <div class="units-summary">
                    <span class="units-count"><i class="fas fa-home"></i> ${relatedUnits.length} ูุญุฏุฉ</span>
                    <span class="units-list">${relatedUnits.map(u => u['ุฑูู  ุงููุญุฏุฉ '] || 'ุบูุฑ ูุญุฏุฏ').join(', ')}</span>
                </div>
            </div>
            <div class="edit-modal-content">
                <form id="multiUnitEditForm" onsubmit="saveMultiUnitEdit(event)">
                    <!-- ููุน ุงูุนูููุฉ - ุญูู ุฅุฌุจุงุฑู -->
                    <div class="operation-type-section">
                        <h3><i class="fas fa-cogs"></i> ููุน ุงูุนูููุฉ *</h3>
                        <div class="form-group">
                            <label for="operationType">ุงุฎุชุฑ ููุน ุงูุนูููุฉ:</label>
                            <select id="operationType" name="operationType" required class="operation-type-select">
                                <option value="">-- ุงุฎุชุฑ ููุน ุงูุนูููุฉ --</option>
                                <option value="${OPERATION_TYPES.EDIT_DATA}">ุชุนุฏูู ุจูุงูุงุช ููุฌูุฏุฉ</option>
                                <option value="${OPERATION_TYPES.NEW_CLIENT}">ุนููู ุฌุฏูุฏ</option>
                                <option value="${OPERATION_TYPES.RENEW_CONTRACT}">ุชุฌุฏูุฏ ุนูุฏ</option>
                                <option value="${OPERATION_TYPES.EMPTY_UNIT}">ุฅูุฑุงุบ ูุญุฏุฉ</option>
                            </select>
                            <small class="field-note">ูุฌุจ ุงุฎุชูุงุฑ ููุน ุงูุนูููุฉ ูุจู ุงูุญูุธ</small>
                        </div>
                    </div>

                    <!-- ุงูุญููู ุงููุฎููุฉ ููุจูุงูุงุช ุงูุฃุตููุฉ -->
                    <input type="hidden" name="originalContractNumber" value="${contractNumber}">
                    <input type="hidden" name="originalPropertyName" value="${propertyName}">
                    <input type="hidden" name="originalUnitNumber" value="${unitNumber}">
                    <input type="hidden" name="unitsCount" value="${relatedUnits.length}">

                    <div class="edit-form-sections">
                        <!-- ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ -->
                        <div class="edit-section">
                            <h3><i class="fas fa-info-circle"></i> ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุงุณู ุงููุณุชุฃุฌุฑ:</label>
                                    <input type="text" name="ุงุณู ุงููุณุชุฃุฌุฑ" value="${primaryUnit['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''}" placeholder="ุงุณู ุงููุณุชุฃุฌุฑ">
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ:</label>
                                    <input type="tel" name="ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ" value="${primaryUnit['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ'] || ''}" placeholder="05xxxxxxxx" pattern="[0-9]{10}" maxlength="10">
                                    <small class="field-note">ุฃุฏุฎู ุฑูู ุงูุฌูุงู ุจุฏูู ูุณุงูุงุช (10 ุฃุฑูุงู)</small>
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุฌูุงู ุฅุถุงูู:</label>
                                    <input type="tel" name="ุฑูู ุฌูุงู ุฅุถุงูู" value="${primaryUnit['ุฑูู ุฌูุงู ุฅุถุงูู'] || ''}" placeholder="05xxxxxxxx" pattern="[0-9]{10}" maxlength="10">
                                    <small class="field-note">ุฑูู ุฌูุงู ุซุงูู ูููุณุชุฃุฌุฑ (ุงุฎุชูุงุฑู)</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุงููุงูู:</label>
                                    <input type="text" name="ุงููุงูู" value="${primaryUnit['ุงููุงูู'] || ''}" placeholder="ุงุณู ุงููุงูู">
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุงูุนูุฏ:</label>
                                    <input type="text" name="ุฑูู ุงูุนูุฏ" value="${primaryUnit['ุฑูู ุงูุนูุฏ'] || ''}" placeholder="ุฑูู ุงูุนูุฏ">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ููุน ุงูุนูุฏ:</label>
                                    <select name="ููุน ุงูุนูุฏ">
                                        <option value="ุณููู" ${primaryUnit['ููุน ุงูุนูุฏ'] === 'ุณููู' ? 'selected' : ''}>ุณููู</option>
                                        <option value="ุถุฑูุจู" ${primaryUnit['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู' ? 'selected' : ''}>ุถุฑูุจู</option>
                                        <option value="ุชุฌุงุฑู" ${primaryUnit['ููุน ุงูุนูุฏ'] === 'ุชุฌุงุฑู' ? 'selected' : ''}>ุชุฌุงุฑู</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <!-- ุญูู ูุงุฑุบ ููุชูุงุฒู -->
                                </div>
                            </div>
                        </div>

                        <!-- ูุนูููุงุช ุงูุนูุงุฑ ูุงูุตู -->
                        <div class="edit-section">
                            <h3><i class="fas fa-building"></i> ูุนูููุงุช ุงูุนูุงุฑ ูุงูุตู</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุงุณู ุงูุนูุงุฑ:</label>
                                    <input type="text" name="ุงุณู ุงูุนูุงุฑ" value="${primaryUnit['ุงุณู ุงูุนูุงุฑ'] || ''}" placeholder="ุงุณู ุงูุนูุงุฑ" readonly style="background-color: #f8f9fa;">
                                    <small class="field-note">ูุชุบููุฑ ุงุณู ุงูุนูุงุฑุ ุงุณุชุฎุฏู "ุชุญุฑูุฑ ุงูุนูุงุฑ" ูู ุงูุฅุญุตุงุฆูุงุช</small>
                                </div>
                                <div class="form-group">
                                    <label>ุงููุฏููุฉ:</label>
                                    <input type="text" name="ุงููุฏููุฉ" value="${primaryUnit['ุงููุฏููุฉ'] || ''}" placeholder="ุงููุฏููุฉ" readonly style="background-color: #f8f9fa;">
                                    <small class="field-note">ูุชุบููุฑ ุงููุฏููุฉุ ุงุณุชุฎุฏู "ุชุญุฑูุฑ ุงูุนูุงุฑ" ูู ุงูุฅุญุตุงุฆูุงุช</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุฑูู ุงููุญุฏุฉ:</label>
                                    <input type="text" name="ุฑูู  ุงููุญุฏุฉ " value="${primaryUnit['ุฑูู  ุงููุญุฏุฉ '] || ''}" placeholder="ุฑูู ุงููุญุฏุฉ">
                                    <small class="field-note">ุฑูู ุงููุญุฏุฉ ูุฌุจ ุฃู ูููู ูุฑูุฏุงู</small>
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุงูุตู:</label>
                                    <input type="text" name="ุฑูู ุงูุตู" value="${primaryUnit['ุฑูู ุงูุตู'] || ''}" placeholder="ุฑูู ุงูุตู">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ูุณุงุญุฉ ุงูุตู (ูยฒ):</label>
                                    <input type="number" name="ูุณุงุญุฉุงูุตู" value="${primaryUnit['ูุณุงุญุฉุงูุตู'] || ''}" step="0.01" placeholder="ูุณุงุญุฉ ุงูุตู ุจุงููุชุฑ ุงููุฑุจุน">
                                </div>
                                <div class="form-group">
                                    <label>ุงูุณุฌู ุงูุนููู:</label>
                                    <input type="text" name="ุงูุณุฌู ุงูุนููู " value="${primaryUnit['ุงูุณุฌู ุงูุนููู '] || ''}" placeholder="ุฑูู ุงูุณุฌู ุงูุนููู">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>ูููุน ุงูุนูุงุฑ:</label>
                                    <input type="url" name="ูููุน ุงูุนูุงุฑ" value="${primaryUnit['ูููุน ุงูุนูุงุฑ'] || ''}" placeholder="ุฑุงุจุท ูููุน ุงูุนูุงุฑ ุนูู ุงูุฎุฑูุทุฉ">
                                    <small class="field-note">ููููู ุฅุฏุฎุงู ุฑุงุจุท ุฎุฑุงุฆุท ุฌูุฌู ุฃู ุฃู ุฑุงุจุท ุขุฎุฑ ูููููุน</small>
                                </div>
                            </div>
                        </div>

                        <!-- ุงูุชูุงุฑูุฎ -->
                        <div class="edit-section">
                            <h3><i class="fas fa-calendar-alt"></i> ุงูุชูุงุฑูุฎ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:</label>
                                    <input type="date" name="ุชุงุฑูุฎ ุงูุจุฏุงูุฉ" value="${formatDateForInput(primaryUnit['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ'])}">
                                </div>
                                <div class="form-group">
                                    <label>ุชุงุฑูุฎ ุงูููุงูุฉ:</label>
                                    <input type="date" name="ุชุงุฑูุฎ ุงูููุงูุฉ" value="${formatDateForInput(primaryUnit['ุชุงุฑูุฎ ุงูููุงูุฉ'])}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท:</label>
                                    <input type="date" name="ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท" value="${formatDateForInput(primaryUnit['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท'])}">
                                </div>
                                <div class="form-group">
                                    <label>ุนุฏุฏ ุงูุฃูุณุงุท ุงููุชุจููุฉ:</label>
                                    <input type="number" name="ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ" value="${primaryUnit['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] || ''}" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- ุงููุจุงูุบ ุงููุงููุฉ -->
                        <div class="edit-section">
                            <h3><i class="fas fa-money-bill-wave"></i> ุงููุจุงูุบ ุงููุงููุฉ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ูููุฉ ุงูุฅูุฌุงุฑ:</label>
                                    <input type="number" name="ูููุฉ  ุงูุงูุฌุงุฑ " value="${primaryUnit['ูููุฉ  ุงูุงูุฌุงุฑ '] || ''}" step="0.01" placeholder="ูููุฉ ุงูุฅูุฌุงุฑ">
                                </div>
                                <div class="form-group">
                                    <label>ุงูุฅุฌูุงูู:</label>
                                    <input type="number" name="ุงูุงุฌูุงูู" value="${primaryUnit['ุงูุงุฌูุงูู'] || ''}" step="0.01" placeholder="ุงููุจูุบ ุงูุฅุฌูุงูู">
                                </div>
                            </div>
                        </div>

                        <!-- ุฅุฏุงุฑุฉ ุงูุฃูุณุงุท -->
                        <div class="edit-section">
                            <h3><i class="fas fa-calendar-check"></i> ุฅุฏุงุฑุฉ ุงูุฃูุณุงุท</h3>
                            <div class="installments-management">
                                <div class="installments-header">
                                    <p class="section-description">ููููู ุฅุถุงูุฉ ูุชุนุฏูู ุฃูุณุงุท ุงูุนูุฏ ูุน ุชูุงุฑูุฎูุง ููุจุงูุบูุง</p>
                                    <div class="total-display" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 10px; border-radius: 6px; margin: 10px 0; text-align: center; font-weight: bold; color: #1976d2;">
                                        ${(() => {
                                            const yearlyData = calculateYearlyTotal(primaryUnit);
                                            return `ุงูุฅุฌูุงูู: ${yearlyData.total.toLocaleString()} ุฑูุงู (${yearlyData.count} ุฃูุณุงุท)`;
                                        })()}
                                    </div>
                                    <button type="button" onclick="addNewInstallment()" class="btn-add-installment">
                                        <i class="fas fa-plus"></i> ุฅุถุงูุฉ ูุณุท ุฌุฏูุฏ
                                    </button>
                                </div>
                                <div id="installmentsContainer" class="installments-container">
                                    ${renderInstallmentsForEdit(primaryUnit)}
                                </div>
                            </div>
                        </div>

                        <!-- ุชูุงุตูู ุงููุญุฏุฉ -->
                        <div class="edit-section">
                            <h3><i class="fas fa-home"></i> ุชูุงุตูู ุงููุญุฏุฉ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ูุณุงุญุฉ ุงููุญุฏุฉ (ูยฒ):</label>
                                    <input type="number" name="ุงููุณุงุญุฉ" value="${primaryUnit['ุงููุณุงุญุฉ'] || ''}" step="0.01" placeholder="ูุณุงุญุฉ ุงููุญุฏุฉ ุจุงููุชุฑ ุงููุฑุจุน">
                                    <small class="field-note">ูุณุงุญุฉ ุงููุญุฏุฉ ุงููุนููุฉ (ูุฏ ุชุฎุชูู ุนู ูุณุงุญุฉ ุงูุตู)</small>
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก:</label>
                                    <input type="text" name="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก" value="${primaryUnit['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] || ''}" placeholder="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุงูุงุฑุชูุงุน:</label>
                                    <input type="text" name="ุงูุงุฑุชูุงุน" value="${primaryUnit['ุงูุงุฑุชูุงุน'] || ''}" placeholder="ุงุฑุชูุงุน ุงููุญุฏุฉ">
                                </div>
                                <div class="form-group">
                                    <label>ููุงุญุธุงุช ุงููุญุฏุฉ:</label>
                                    <input type="text" name="ููุงุญุธุงุช ุงููุญุฏุฉ" value="${primaryUnit['ููุงุญุธุงุช ุงููุญุฏุฉ'] || ''}" placeholder="ุฃู ููุงุญุธุงุช ุฎุงุตุฉ ุจุงููุญุฏุฉ">
                                </div>
                            </div>
                        </div>

                        <!-- ุฑุจุท ุงููุญุฏุงุช -->
                        <div class="edit-section">
                            <h3><i class="fas fa-link"></i> ุฑุจุท ุงููุญุฏุงุช</h3>
                            <div class="units-linking-section">
                                <p class="section-description">ููููู ุฑุจุท ูุญุฏุงุช ุฅุถุงููุฉ ุจูุฐู ุงูุจุทุงูุฉ ูุชุฌููุนูุง ุชุญุช ุนูุฏ ูุงุญุฏ</p>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ุงููุญุฏุงุช ุงููุชุงุญุฉ ููุฑุจุท:</label>
                                        <div id="availableUnitsForLinking" class="units-linking-list">
                                            ${renderAvailableUnitsForLinking(propertyName, contractNumber, unitNumber)}
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุญุงููุงู:</label>
                                        <div id="linkedUnitsDisplay" class="linked-units-display">
                                            ${renderLinkedUnits(propertyName, contractNumber)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุงูุญููู ุงููุฎููุฉ ุงูุฅุถุงููุฉ -->
                    <input type="hidden" name="originalContractNumber" value="${contractNumber || ''}">
                    <input type="hidden" name="originalPropertyName" value="${propertyName}">
                    <input type="hidden" name="originalUnitNumber" value="${unitNumber || ''}">

                    <!-- ุฃุฒุฑุงุฑ ุงูุญูุธ ูุงูุฅูุบุงุก -->
                    <div class="edit-modal-actions">
                        <div class="action-group primary-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> ุญูุธ ุงูุชุบููุฑุงุช
                            </button>
                            <button type="button" onclick="emptyUnit('${contractNumber || ''}', '${propertyName}', '${unitNumber || ''}')" class="btn-danger">
                                <i class="fas fa-broom"></i> ุฅูุฑุงุบ ุงููุญุฏุฉ
                            </button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">
                                <i class="fas fa-times"></i> ุฅูุบุงุก
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // ุญูุธ ุจูุงูุงุช ุงููุญุฏุงุช ููุงุณุชุฎุฏุงู ูู ุงูุฏูุงู ุงูุฃุฎุฑู
    window.currentEditingUnits = relatedUnits;
    window.currentPrimaryUnit = primaryUnit;
}

// ุชุญุฏูุซ ูุงุฆูุฉ ุงููุญุฏุงุช ุงููุชุงุญุฉ ููุฑุจุท
function updateAvailableUnitsForLinking() {
    const availableUnitsDiv = document.getElementById('availableUnitsForLinking');
    if (!availableUnitsDiv) return;

    // ุงูุญุตูู ุนูู ุฌููุน ุงููุญุฏุงุช ูู ููุณ ุงูุนูุงุฑ
    const currentPropertyName = window.currentPrimaryUnit['ุงุณู ุงูุนูุงุฑ'];
    const currentLinkedUnits = window.currentEditingUnits.map(u => u['ุฑูู  ุงููุญุฏุฉ ']);

    const allUnitsInProperty = window.allData.filter(unit =>
        unit['ุงุณู ุงูุนูุงุฑ'] === currentPropertyName &&
        !currentLinkedUnits.includes(unit['ุฑูู  ุงููุญุฏุฉ '])
    );

    if (allUnitsInProperty.length === 0) {
        availableUnitsDiv.innerHTML = '<div class="no-units-message"><i class="fas fa-info-circle"></i> ูุง ุชูุฌุฏ ูุญุฏุงุช ูุชุงุญุฉ ููุฑุจุท</div>';
        return;
    }

    availableUnitsDiv.innerHTML = allUnitsInProperty.map(unit => `
        <div class="available-unit-item" data-unit-number="${unit['ุฑูู  ุงููุญุฏุฉ ']}">
            <div class="unit-info">
                <i class="fas fa-home"></i>
                <span class="unit-number">ูุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ '] || 'ุบูุฑ ูุญุฏุฏ'}</span>
                <span class="unit-tenant">${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] ? ` - ${unit['ุงุณู ุงููุณุชุฃุฌุฑ']}` : ' - ูุงุฑุบ'}</span>
                <span class="unit-status ${getUnitStatusClass(unit)}">${calculateStatus(unit).final || 'ุบูุฑ ูุญุฏุฏ'}</span>
            </div>
            <div class="unit-actions">
                <button type="button" onclick="linkUnitToGroup('${unit['ุฑูู  ุงููุญุฏุฉ ']}')" class="btn-link-unit" title="ุฑุจุท ูุฐู ุงููุญุฏุฉ">
                    <i class="fas fa-link"></i> ุฑุจุท
                </button>
            </div>
        </div>
    `).join('');
}

// ุชุญุฏูุซ ูุงุฆูุฉ ุงููุญุฏุงุช ุงููุชุงุญุฉ
function refreshAvailableUnits() {
    console.log('๐ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุญุฏุงุช ุงููุชุงุญุฉ');
    updateAvailableUnitsForLinking();
}

// ุฑุจุท ูุญุฏุฉ ุฌุฏูุฏุฉ ูููุฌููุนุฉ
function linkUnitToGroup(unitNumber) {
    if (!unitNumber) {
        alert('ุฑูู ุงููุญุฏุฉ ุบูุฑ ุตุญูุญ');
        return;
    }

    // ุงูุจุญุซ ุนู ุงููุญุฏุฉ ูู ุงูุจูุงูุงุช
    const unitToLink = window.allData.find(unit =>
        unit['ุฑูู  ุงููุญุฏุฉ '] === unitNumber &&
        unit['ุงุณู ุงูุนูุงุฑ'] === window.currentPrimaryUnit['ุงุณู ุงูุนูุงุฑ']
    );

    if (!unitToLink) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงููุญุฏุฉ ูุณุจูุงู
    const alreadyLinked = window.currentEditingUnits.some(unit =>
        unit['ุฑูู  ุงููุญุฏุฉ '] === unitNumber
    );

    if (alreadyLinked) {
        alert('ูุฐู ุงููุญุฏุฉ ูุฑุชุจุทุฉ ุจุงููุนู');
        return;
    }

    // ุฅุถุงูุฉ ุงููุญุฏุฉ ูููุฌููุนุฉ
    window.currentEditingUnits.push(unitToLink);

    console.log(`๐ ุชู ุฑุจุท ุงููุญุฏุฉ ${unitNumber} ุจุงููุฌููุนุฉ`);

    // ุชุญุฏูุซ ุงูุนุฑุถ
    updateLinkedUnitsDisplay();
    updateAvailableUnitsForLinking();

    // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
    showSuccessMessage('ุชู ุงูุฑุจุท ุจูุฌุงุญ', `ุชู ุฑุจุท ุงููุญุฏุฉ ${unitNumber} ุจุงููุฌููุนุฉ`);
}

// ูุตู ูุญุฏุฉ ูู ุงููุฌููุนุฉ
function unlinkUnitFromGroup(unitNumber) {
    if (!unitNumber) {
        alert('ุฑูู ุงููุญุฏุฉ ุบูุฑ ุตุญูุญ');
        return;
    }

    if (window.currentEditingUnits.length <= 1) {
        alert('ูุง ูููู ูุตู ุงููุญุฏุฉ ุงููุญูุฏุฉ ูู ุงููุฌููุนุฉ');
        return;
    }

    const confirmMessage = `ูู ุฃูุช ูุชุฃูุฏ ูู ูุตู ุงููุญุฏุฉ ${unitNumber} ูู ุงููุฌููุนุฉุ`;
    if (!confirm(confirmMessage)) {
        return;
    }

    // ุฅุฒุงูุฉ ุงููุญุฏุฉ ูู ุงููุฌููุนุฉ
    window.currentEditingUnits = window.currentEditingUnits.filter(unit =>
        unit['ุฑูู  ุงููุญุฏุฉ '] !== unitNumber
    );

    console.log(`๐ ุชู ูุตู ุงููุญุฏุฉ ${unitNumber} ูู ุงููุฌููุนุฉ`);

    // ุชุญุฏูุซ ุงูุนุฑุถ
    updateLinkedUnitsDisplay();
    updateAvailableUnitsForLinking();

    // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
    showSuccessMessage('ุชู ุงููุตู ุจูุฌุงุญ', `ุชู ูุตู ุงููุญุฏุฉ ${unitNumber} ูู ุงููุฌููุนุฉ`);
}

// ูุตู ุฌููุน ุงููุญุฏุงุช
function unlinkAllUnits() {
    if (window.currentEditingUnits.length <= 1) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุงุช ูุชุนุฏุฏุฉ ูููุตู');
        return;
    }

    const confirmMessage = `ูู ุฃูุช ูุชุฃูุฏ ูู ูุตู ุฌููุน ุงููุญุฏุงุชุ\n\nุณูุชู ุงูุงุญุชูุงุธ ุจุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ููุท.`;
    if (!confirm(confirmMessage)) {
        return;
    }

    // ุงูุงุญุชูุงุธ ุจุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ููุท
    const primaryUnit = window.currentPrimaryUnit;
    window.currentEditingUnits = [primaryUnit];

    console.log('๐ ุชู ูุตู ุฌููุน ุงููุญุฏุงุช');

    // ุชุญุฏูุซ ุงูุนุฑุถ
    updateLinkedUnitsDisplay();
    updateAvailableUnitsForLinking();

    // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
    showSuccessMessage('ุชู ุงููุตู ุจูุฌุงุญ', 'ุชู ูุตู ุฌููุน ุงููุญุฏุงุช ูุงูุงุญุชูุงุธ ุจุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ููุท');
}

// ุชุญุฏูุซ ุนุฑุถ ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ
function updateLinkedUnitsDisplay() {
    const linkedUnitsDiv = document.getElementById('linkedUnitsDisplay');
    if (!linkedUnitsDiv) return;

    const relatedUnits = window.currentEditingUnits;

    linkedUnitsDiv.innerHTML = relatedUnits.map((unit, index) => `
        <div class="linked-unit-item" data-unit-number="${unit['ุฑูู  ุงููุญุฏุฉ ']}" data-unit-index="${index}">
            <div class="unit-info">
                <i class="fas fa-home"></i>
                <span class="unit-number">ูุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ '] || 'ุบูุฑ ูุญุฏุฏ'}</span>
                <span class="unit-tenant">${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] ? ` - ${unit['ุงุณู ุงููุณุชุฃุฌุฑ']}` : ' - ูุงุฑุบ'}</span>
                <span class="unit-status ${getUnitStatusClass(unit)}">${calculateStatus(unit).final || 'ุบูุฑ ูุญุฏุฏ'}</span>
            </div>
            <div class="unit-actions">
                ${relatedUnits.length > 1 ? `
                    <button type="button" onclick="unlinkUnitFromGroup('${unit['ุฑูู  ุงููุญุฏุฉ ']}')" class="btn-unlink-unit" title="ูุตู ูุฐู ุงููุญุฏุฉ">
                        <i class="fas fa-unlink"></i> ูุตู
                    </button>
                ` : `
                    <span class="primary-unit-badge">ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ</span>
                `}
            </div>
        </div>
    `).join('');

    // ุชุญุฏูุซ ุนุฏุงุฏ ุงููุญุฏุงุช ูู ุงูุนููุงู
    const label = linkedUnitsDiv.previousElementSibling;
    if (label && label.tagName === 'LABEL') {
        label.textContent = `ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุญุงููุงู (${relatedUnits.length} ูุญุฏุฉ):`;
    }
}

// ุฅุธูุงุฑ ูุงูุฐุฉ ุฑุจุท ุงููุญุฏุงุช
function showUnitLinkingModal() {
    // ุชุญุฏูุซ ุงููุงุฆูุฉ ุฃููุงู
    updateAvailableUnitsForLinking();

    // ุงูุชูุฑูุฑ ุฅูู ูุณู ุงููุญุฏุงุช ุงููุชุงุญุฉ
    const availableUnitsDiv = document.getElementById('availableUnitsForLinking');
    if (availableUnitsDiv) {
        availableUnitsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // ุฅุถุงูุฉ ุชุฃุซูุฑ ุจุตุฑู
        availableUnitsDiv.style.border = '2px solid #007bff';
        availableUnitsDiv.style.borderRadius = '8px';
        availableUnitsDiv.style.padding = '10px';

        setTimeout(() => {
            availableUnitsDiv.style.border = '';
            availableUnitsDiv.style.borderRadius = '';
            availableUnitsDiv.style.padding = '';
        }, 3000);
    }
}

// ุญูุธ ุชุนุฏููุงุช ุงููุญุฏุงุช ุงููุชุนุฏุฏุฉ - ูุน ูุนุงูุฌุฉ ุฎุงุตุฉ ูุฑูู ุงููุญุฏุฉ
async function saveMultiUnitEdit(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const operationType = formData.get('operationType');

    if (!operationType) {
        alert('ูุฌุจ ุงุฎุชูุงุฑ ููุน ุงูุนูููุฉ ูุจู ุงูุญูุธ');
        return;
    }

    console.log(`๐พ ุจุฏุก ุญูุธ ุชุบููุฑุงุช ${window.currentEditingUnits.length} ูุญุฏุฉ`);

    // ุงูุญุตูู ุนูู ุฑูู ุงููุญุฏุฉ ุงูุฌุฏูุฏ ูู ุงููููุฐุฌ
    const newUnitNumber = formData.get('ุฑูู  ุงููุญุฏุฉ ');
    const primaryUnit = window.currentPrimaryUnit;

    try {
        // ุชุทุจูู ุงูุนูููุฉ ุนูู ูู ูุญุฏุฉ
        for (let i = 0; i < window.currentEditingUnits.length; i++) {
            const unit = window.currentEditingUnits[i];
            const isPrimaryUnit = (unit === primaryUnit);

            // ุฅูุดุงุก ูุณุฎุฉ ูู formData ูููุญุฏุฉ ุงูุญุงููุฉ
            const unitFormData = new FormData();

            // ูุณุฎ ุฌููุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ ุงูุฃุตูู
            for (let [key, value] of formData.entries()) {
                // ูุนุงูุฌุฉ ุฎุงุตุฉ ูุฑูู ุงููุญุฏุฉ
                if (key === 'ุฑูู  ุงููุญุฏุฉ ') {
                    if (isPrimaryUnit) {
                        // ูููุญุฏุฉ ุงูุฃุณุงุณูุฉ: ุงุณุชุฎุฏู ุงูุฑูู ุงูุฌุฏูุฏ ูู ุงููููุฐุฌ
                        unitFormData.append(key, newUnitNumber);
                        console.log(`๐ ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ: ุชุญุฏูุซ ุฑูู ุงููุญุฏุฉ ุฅูู "${newUnitNumber}"`);
                    } else {
                        // ูููุญุฏุงุช ุงูุฃุฎุฑู: ุงุญุชูุธ ุจุฑูู ุงููุญุฏุฉ ุงูุฃุตูู
                        unitFormData.append(key, unit['ุฑูู  ุงููุญุฏุฉ '] || '');
                        console.log(`๐ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}: ุงูุงุญุชูุงุธ ุจุฑูู ุงููุญุฏุฉ ุงูุฃุตูู`);
                    }
                } else {
                    // ุจุงูู ุงูุญููู: ููุณ ุงููููุฉ ูุฌููุน ุงููุญุฏุงุช
                    unitFormData.append(key, value);
                }
            }

            // ุญูุธ ุงููุญุฏุฉ ูุน ุงูุจูุงูุงุช ุงููุฎุตุตุฉ ููุง
            await savePropertyEditForUnit(unit, unitFormData, operationType, isPrimaryUnit);
        }

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        showSuccessMessage('ุชู ุงูุญูุธ ุจูุฌุงุญ', `ุชู ุญูุธ ุชุบููุฑุงุช ${window.currentEditingUnits.length} ูุญุฏุฉ ุจูุฌุงุญ`);

        // ุฅุบูุงู ุงููุงูุฐุฉ
        closeModal();

        // ุชุญุฏูุซ ุงูุนุฑุถ
        if (typeof displayProperties === 'function') {
            displayProperties();
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุงุช ุงููุชุนุฏุฏุฉ:', error);
        alert(`ุฎุทุฃ ูู ุงูุญูุธ: ${error.message}`);
    }
}

// ุญูุธ ูุญุฏุฉ ูุงุญุฏุฉ ุจุงุณุชุฎุฏุงู ููุทู ุงููุงูุฐุฉ ุงููุฑุฏูุฉ
async function savePropertyEditForUnit(unit, formData, operationType) {
    const originalContractNumber = unit['ุฑูู ุงูุนูุฏ'] || '';
    const originalPropertyName = unit['ุงุณู ุงูุนูุงุฑ'] || '';
    const originalUnitNumber = unit['ุฑูู  ุงููุญุฏุฉ '] || '';

    // ุงูุจุญุซ ุนู ุงููุญุฏุฉ ูู ุงููุตูููุฉ
    const propertyIndex = properties.findIndex(p =>
        p['ุฑูู ุงูุนูุฏ'] === originalContractNumber &&
        p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName &&
        p['ุฑูู  ุงููุญุฏุฉ '] === originalUnitNumber
    );

    if (propertyIndex === -1) {
        throw new Error(`ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ${originalUnitNumber}`);
    }

    // ุญูุธ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ููููุงุฑูุฉ
    const originalData = { ...properties[propertyIndex] };

    // ุชุญุฏูุซ ุงูุจูุงูุงุช
    const updatedProperty = { ...properties[propertyIndex] };

    // ุชุญุฏูุซ ุงูุญููู ูู ุงููููุฐุฌ (ููุณ ููุทู ุงููุงูุฐุฉ ุงููุฑุฏูุฉ)
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('original') || key === 'operationType' || key === 'unitsCount') continue;

        // ุชุญููู ุงูุชูุงุฑูุฎ
        if (key.includes('ุชุงุฑูุฎ') && value && !key.includes('ุงููุณุท')) {
            const dateParts = value.split('-');
            if (dateParts.length === 3 && dateParts[0].length === 4) {
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);

                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const testDate = new Date(year, month - 1, day, 12, 0, 0);
                    if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                        value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                    } else {
                        value = null;
                    }
                } else {
                    value = null;
                }
            }
        }

        // ุชุญููู ุงูุฃุฑูุงู
        if (['ุงููุณุงุญุฉ', 'ูููุฉ  ุงูุงูุฌุงุฑ ', 'ุงูุงุฌูุงูู', 'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'].includes(key) && value) {
            value = parseFloat(value) || 0;
        }

        if (key === 'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ') {
            value = parseInt(value) || 0;
        }

        // ุชุญุฏูุซ ุงููููุฉ
        updatedProperty[key] = value || '';
    }

    // ุฅุถุงูุฉ ูุนูููุงุช ุงูุชุญุฏูุซ
    updatedProperty['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
    updatedProperty['ููุน ุงูุชุญุฏูุซ'] = operationType || 'ุชุญุฑูุฑ ูุชุนุฏุฏ';
    updatedProperty['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = getCurrentUser();

    // ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุงููุตูููุฉ
    properties[propertyIndex] = updatedProperty;

    // ุญูุธ ูู ุงูุชุฎุฒูู ุงููุญูู
    localStorage.setItem('propertyData', JSON.stringify(properties));

    // ุญูุธ ูู ุงูุณุญุงุจุฉ
    if (window.supabaseEnabled && typeof saveToSupabase === 'function') {
        await saveToSupabase(updatedProperty);
    }

    console.log(`โ ุชู ุญูุธ ุงููุญุฏุฉ ${originalUnitNumber} ุจูุฌุงุญ`);

    // ุฅุธูุงุฑ ุดุฑูุท ุงูุชูุฏู
    showProgressModal(`ุฌุงุฑู ุญูุธ ${window.currentEditingUnits.length} ูุญุฏุฉ...`, async function(updateProgress) {
        try {
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < window.currentEditingUnits.length; i++) {
                const unit = window.currentEditingUnits[i];
                const progress = Math.round(((i + 1) / window.currentEditingUnits.length) * 100);

                updateProgress(progress, `ุญูุธ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ '] || (i + 1)}...`);

                try {
                    // ุชุทุจูู ููุน ุงูุนูููุฉ ุนูู ูู ูุญุฏุฉ
                    await applyOperationToUnit(unit, operationType, formData);
                    successCount++;
                } catch (error) {
                    console.error(`โ ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}:`, error);
                    errorCount++;
                }

                // ุชุฃุฎูุฑ ูุตูุฑ ุจูู ุงูุญูุธุงุช
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            return {
                success: errorCount === 0,
                message: `ุชู ุญูุธ ${successCount} ูุญุฏุฉ ุจูุฌุงุญ` +
                        (errorCount > 0 ? `\nูุดู ุญูุธ ${errorCount} ูุญุฏุฉ` : '')
            };
        } catch (error) {
            return {
                success: false,
                message: `ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุงุช: ${error.message}`
            };
        }
    }, function(result) {
        if (result.success) {
            showSuccessMessage('ุชู ุญูุธ ุฌููุน ุงููุญุฏุงุช!', result.message);
            closeModal();
            renderData();
            updateTotalStats();
        } else {
            showErrorMessage('ุฎุทุฃ ูู ุงูุญูุธ', result.message);
        }
    });
}

// ุชุทุจูู ุงูุนูููุฉ ุนูู ูุญุฏุฉ ูุงุญุฏุฉ
async function applyOperationToUnit(unit, operationType, formData) {
    const contractNumber = unit['ุฑูู ุงูุนูุฏ'] || '';
    const propertyName = unit['ุงุณู ุงูุนูุงุฑ'] || '';
    const unitNumber = unit['ุฑูู  ุงููุญุฏุฉ '] || '';

    switch (operationType) {
        case OPERATION_TYPES.EDIT_DATA:
            // ุชุนุฏูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ - ุชุทุจูู ุงูุจูุงูุงุช ูู ุงููููุฐุฌ
            console.log(`๐ ุชุนุฏูู ุจูุงูุงุช ุงููุญุฏุฉ ${unitNumber}`);
            await updateUnitWithFormData(unit, formData);
            break;

        case OPERATION_TYPES.NEW_CLIENT:
            // ุนููู ุฌุฏูุฏ - ูุณุญ ุจูุงูุงุช ุงููุณุชุฃุฌุฑ ูุงูุนูุฏ
            await setNewClient(contractNumber, propertyName, unitNumber);
            break;

        case OPERATION_TYPES.RENEW_CONTRACT:
            // ุชุฌุฏูุฏ ุงูุนูุฏ
            await renewContract(contractNumber, propertyName, unitNumber);
            break;

        case OPERATION_TYPES.EMPTY_UNIT:
            // ุฅูุฑุงุบ ุงููุญุฏุฉ
            await emptyUnit(contractNumber, propertyName, unitNumber);
            break;

        default:
            throw new Error(`ููุน ุนูููุฉ ุบูุฑ ูุนุฑูู: ${operationType}`);
    }
}

// ุชุญุฏูุซ ุจูุงูุงุช ุงููุญุฏุฉ ูู ุงููููุฐุฌ
async function updateUnitWithFormData(unit, formData) {
    const originalContractNumber = unit['ุฑูู ุงูุนูุฏ'] || '';
    const originalPropertyName = unit['ุงุณู ุงูุนูุงุฑ'] || '';
    const originalUnitNumber = unit['ุฑูู  ุงููุญุฏุฉ '] || '';

    // ุฅูุดุงุก ูุงุฆู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
    const updatedData = {
        'ุงุณู ุงููุณุชุฃุฌุฑ': formData.get('ุงุณู ุงููุณุชุฃุฌุฑ') || '',
        'ุงููุงูู': formData.get('ุงููุงูู') || '',
        'ุฑูู ุงูุนูุฏ': formData.get('ุฑูู ุงูุนูุฏ') || '',
        'ููุน ุงูุนูุฏ': formData.get('ููุน ุงูุนูุฏ') || '',
        'ุงุณู ุงูุนูุงุฑ': formData.get('ุงุณู ุงูุนูุงุฑ') || '',
        'ุงููุฏููุฉ': formData.get('ุงููุฏููุฉ') || '',
        'ุฑูู ุงูุตู': formData.get('ุฑูู ุงูุตู') || '',
        'ูุณุงุญุฉุงูุตู': formData.get('ูุณุงุญุฉุงูุตู') || '',
        'ุงูุณุฌู ุงูุนููู ': formData.get('ุงูุณุฌู ุงูุนููู ') || '',
        'ูููุน ุงูุนูุงุฑ': formData.get('ูููุน ุงูุนูุงุฑ') || '',
        'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ': formData.get('ุชุงุฑูุฎ ุงูุจุฏุงูุฉ') || '',
        'ุชุงุฑูุฎ ุงูููุงูุฉ': formData.get('ุชุงุฑูุฎ ุงูููุงูุฉ') || '',
        'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท': formData.get('ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท') || '',
        'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ': formData.get('ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ') || '',
        'ูููุฉ  ุงูุงูุฌุงุฑ ': formData.get('ูููุฉ  ุงูุงูุฌุงุฑ ') || '',
        'ุงูุงุฌูุงูู': formData.get('ุงูุงุฌูุงูู') || '',
        'ุงููุณุงุญุฉ': formData.get('ุงููุณุงุญุฉ') || '',
        'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก': formData.get('ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก') || '',
        'ุงูุงุฑุชูุงุน': formData.get('ุงูุงุฑุชูุงุน') || '',
        'ููุงุญุธุงุช ุงููุญุฏุฉ': formData.get('ููุงุญุธุงุช ุงููุญุฏุฉ') || ''
    };

    // ุงูุงุญุชูุงุธ ุจุฑูู ุงููุญุฏุฉ ุงูุฃุตูู
    updatedData['ุฑูู  ุงููุญุฏุฉ '] = originalUnitNumber;

    // ุชุญุฏูุซ ุงูุจูุงูุงุช ูุญููุงู
    const unitIndex = window.allData.findIndex(u =>
        u['ุฑูู ุงูุนูุฏ'] === originalContractNumber &&
        u['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName &&
        u['ุฑูู  ุงููุญุฏุฉ '] === originalUnitNumber
    );

    if (unitIndex !== -1) {
        // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
        Object.assign(window.allData[unitIndex], updatedData);

        // ุญูุธ ูู ุงูุชุฎุฒูู ุงููุญูู
        localStorage.setItem('propertyData', JSON.stringify(window.allData));

        // ุญูุธ ูู ุงูุณุญุงุจุฉ
        if (window.supabaseEnabled) {
            try {
                await saveToSupabase(window.allData[unitIndex]);
                console.log(`โ ุชู ุญูุธ ุงููุญุฏุฉ ${originalUnitNumber} ูู ุงูุณุญุงุจุฉ`);
            } catch (error) {
                console.error(`โ ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุฉ ${originalUnitNumber} ูู ุงูุณุญุงุจุฉ:`, error);
                throw error;
            }
        }
    }
}

// ุฅูุฑุงุบ ุฌููุน ุงููุญุฏุงุช
async function emptyAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฅูุฑุงุบ');
        return;
    }

    const confirmMessage = `ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุฑุงุบ ุฌููุน ุงููุญุฏุงุช (${window.currentEditingUnits.length} ูุญุฏุฉ)ุ\n\nุณูุชู ุญุฐู ุฌููุน ุจูุงูุงุช ุงููุณุชุฃุฌุฑูู ูุงูุนููุฏ!`;

    if (!confirm(confirmMessage)) {
        return;
    }

    console.log(`๐งน ุจุฏุก ุฅูุฑุงุบ ${window.currentEditingUnits.length} ูุญุฏุฉ`);

    // ุฅุธูุงุฑ ุดุฑูุท ุงูุชูุฏู
    showProgressModal(`ุฌุงุฑู ุฅูุฑุงุบ ${window.currentEditingUnits.length} ูุญุฏุฉ...`, async function(updateProgress) {
        try {
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < window.currentEditingUnits.length; i++) {
                const unit = window.currentEditingUnits[i];
                const progress = Math.round(((i + 1) / window.currentEditingUnits.length) * 100);

                updateProgress(progress, `ุฅูุฑุงุบ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ '] || (i + 1)}...`);

                try {
                    const contractNumber = unit['ุฑูู ุงูุนูุฏ'] || '';
                    const propertyName = unit['ุงุณู ุงูุนูุงุฑ'] || '';
                    const unitNumber = unit['ุฑูู  ุงููุญุฏุฉ '] || '';

                    await emptyUnit(contractNumber, propertyName, unitNumber);
                    successCount++;
                } catch (error) {
                    console.error(`โ ุฎุทุฃ ูู ุฅูุฑุงุบ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}:`, error);
                    errorCount++;
                }

                // ุชุฃุฎูุฑ ูุตูุฑ ุจูู ุงูุนูููุงุช
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            return {
                success: errorCount === 0,
                message: `ุชู ุฅูุฑุงุบ ${successCount} ูุญุฏุฉ ุจูุฌุงุญ` +
                        (errorCount > 0 ? `\nูุดู ุฅูุฑุงุบ ${errorCount} ูุญุฏุฉ` : '')
            };
        } catch (error) {
            return {
                success: false,
                message: `ุฎุทุฃ ูู ุฅูุฑุงุบ ุงููุญุฏุงุช: ${error.message}`
            };
        }
    }, function(result) {
        if (result.success) {
            showSuccessMessage('ุชู ุฅูุฑุงุบ ุฌููุน ุงููุญุฏุงุช!', result.message);
            closeModal();
            renderData();
            updateTotalStats();
        } else {
            showErrorMessage('ุฎุทุฃ ูู ุงูุฅูุฑุงุบ', result.message);
        }
    });
}

// ุงูุญุตูู ุนูู ูุฆุฉ ุญุงูุฉ ุงููุญุฏุฉ ููุชุจููุจ
function getUnitStatusClass(unit) {
    const status = calculateStatus(unit);
    if (status.final === 'ุฌุงุฑู') return 'status-active';
    if (status.final === 'ููุชูู') return 'status-expired';
    if (status.final === 'ุนูู ูุดู') return 'status-pending';
    if (status.final === 'ูุงุฑุบ') return 'status-empty';
    return 'status-unknown';
}

// ุชุจุฏูู ุงูุชุจููุจ ุงููุดุท
function switchUnitTab(tabIndex) {
    // ุฅุฒุงูุฉ ุงููุฆุฉ ุงููุดุทุฉ ูู ุฌููุน ุงูุชุจููุจุงุช
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // ุฅุถุงูุฉ ุงููุฆุฉ ุงููุดุทุฉ ููุชุจููุจ ุงููุญุฏุฏ
    document.querySelector(`[data-tab="${tabIndex}"]`).classList.add('active');
    document.querySelector(`[data-tab-content="${tabIndex}"]`).classList.add('active');

    console.log(`๐ ุชู ุงูุชุจุฏูู ุฅูู ุชุจููุจ ุงููุญุฏุฉ ${tabIndex}`);
}

// ุฅูุดุงุก ูููุฐุฌ ุชุญุฑูุฑ ูุงูู ููุญุฏุฉ ูุงุญุฏุฉ (ููุณ ุชูุณูู ุงููุญุฏุฉ ุงููุฑุฏูุฉ)
function generateFullUnitEditForm(unit, unitIndex) {
    const contractNumber = unit['ุฑูู ุงูุนูุฏ'] || '';
    const propertyName = unit['ุงุณู ุงูุนูุงุฑ'] || '';
    const unitNumber = unit['ุฑูู  ุงููุญุฏุฉ '] || '';

    return `
        <form id="unitEditForm_${unitIndex}" class="unit-edit-form" data-unit-index="${unitIndex}">
            <!-- ููุน ุงูุนูููุฉ - ุญูู ุฅุฌุจุงุฑู -->
            <div class="operation-type-section">
                <h3><i class="fas fa-cogs"></i> ููุน ุงูุนูููุฉ *</h3>
                <div class="form-group">
                    <label for="operationType_${unitIndex}">ุงุฎุชุฑ ููุน ุงูุนูููุฉ:</label>
                    <select id="operationType_${unitIndex}" name="operationType" required class="operation-type-select">
                        <option value="">-- ุงุฎุชุฑ ููุน ุงูุนูููุฉ --</option>
                        <option value="${OPERATION_TYPES.EDIT_DATA}">ุชุนุฏูู ุจูุงูุงุช ููุฌูุฏุฉ</option>
                        <option value="${OPERATION_TYPES.NEW_CLIENT}">ุนููู ุฌุฏูุฏ</option>
                        <option value="${OPERATION_TYPES.RENEW_CONTRACT}">ุชุฌุฏูุฏ ุนูุฏ</option>
                        <option value="${OPERATION_TYPES.EMPTY_UNIT}">ุฅูุฑุงุบ ูุญุฏุฉ</option>
                    </select>
                    <small class="field-note">ูุฌุจ ุงุฎุชูุงุฑ ููุน ุงูุนูููุฉ ูุจู ุงูุญูุธ</small>
                </div>
            </div>

            <!-- ุงูุญููู ุงููุฎููุฉ ููุจูุงูุงุช ุงูุฃุตููุฉ -->
            <input type="hidden" name="originalContractNumber" value="${contractNumber}">
            <input type="hidden" name="originalPropertyName" value="${propertyName}">
            <input type="hidden" name="originalUnitNumber" value="${unitNumber}">

            <div class="edit-form-sections">
                <div class="edit-section">
                    <h3><i class="fas fa-info-circle"></i> ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุงุณู ุงููุณุชุฃุฌุฑ:</label>
                            <input type="text" name="ุงุณู ุงููุณุชุฃุฌุฑ" value="${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''}" placeholder="ุงุณู ุงููุณุชุฃุฌุฑ">
                        </div>
                        <div class="form-group">
                            <label>ุงููุงูู:</label>
                            <input type="text" name="ุงููุงูู" value="${unit['ุงููุงูู'] || ''}" placeholder="ุงุณู ุงููุงูู">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุฑูู ุงูุนูุฏ:</label>
                            <input type="text" name="ุฑูู ุงูุนูุฏ" value="${unit['ุฑูู ุงูุนูุฏ'] || ''}" placeholder="ุฑูู ุงูุนูุฏ">
                        </div>
                        <div class="form-group">
                            <label>ููุน ุงูุนูุฏ:</label>
                            <select name="ููุน ุงูุนูุฏ">
                                <option value="ุณููู" ${unit['ููุน ุงูุนูุฏ'] === 'ุณููู' ? 'selected' : ''}>ุณููู</option>
                                <option value="ุถุฑูุจู" ${unit['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู' ? 'selected' : ''}>ุถุฑูุจู</option>
                                <option value="ุชุฌุงุฑู" ${unit['ููุน ุงูุนูุฏ'] === 'ุชุฌุงุฑู' ? 'selected' : ''}>ุชุฌุงุฑู</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3><i class="fas fa-building"></i> ูุนูููุงุช ุงูุนูุงุฑ ูุงูุตู</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุงุณู ุงูุนูุงุฑ:</label>
                            <input type="text" name="ุงุณู ุงูุนูุงุฑ" value="${unit['ุงุณู ุงูุนูุงุฑ'] || ''}" placeholder="ุงุณู ุงูุนูุงุฑ" readonly style="background-color: #f8f9fa;">
                            <small class="field-note">ูุชุบููุฑ ุงุณู ุงูุนูุงุฑุ ุงุณุชุฎุฏู "ุชุญุฑูุฑ ุงูุนูุงุฑ" ูู ุงูุฅุญุตุงุฆูุงุช</small>
                        </div>
                        <div class="form-group">
                            <label>ุงููุฏููุฉ:</label>
                            <input type="text" name="ุงููุฏููุฉ" value="${unit['ุงููุฏููุฉ'] || ''}" placeholder="ุงููุฏููุฉ" readonly style="background-color: #f8f9fa;">
                            <small class="field-note">ูุชุบููุฑ ุงููุฏููุฉุ ุงุณุชุฎุฏู "ุชุญุฑูุฑ ุงูุนูุงุฑ" ูู ุงูุฅุญุตุงุฆูุงุช</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุฑูู ุงููุญุฏุฉ:</label>
                            <input type="text" name="ุฑูู  ุงููุญุฏุฉ " value="${unit['ุฑูู  ุงููุญุฏุฉ '] || ''}" placeholder="ุฑูู ุงููุญุฏุฉ">
                            <small class="field-note">ุฑูู ุงููุญุฏุฉ ูุฌุจ ุฃู ูููู ูุฑูุฏุงู</small>
                        </div>
                        <div class="form-group">
                            <label>ุฑูู ุงูุตู:</label>
                            <input type="text" name="ุฑูู ุงูุตู" value="${unit['ุฑูู ุงูุตู'] || ''}" placeholder="ุฑูู ุงูุตู">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ูุณุงุญุฉ ุงูุตู (ูยฒ):</label>
                            <input type="number" name="ูุณุงุญุฉุงูุตู" value="${unit['ูุณุงุญุฉุงูุตู'] || ''}" step="0.01" placeholder="ูุณุงุญุฉ ุงูุตู ุจุงููุชุฑ ุงููุฑุจุน">
                        </div>
                        <div class="form-group">
                            <label>ุงูุณุฌู ุงูุนููู:</label>
                            <input type="text" name="ุงูุณุฌู ุงูุนููู " value="${unit['ุงูุณุฌู ุงูุนููู '] || ''}" placeholder="ุฑูู ุงูุณุฌู ุงูุนููู">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>ูููุน ุงูุนูุงุฑ:</label>
                            <input type="url" name="ูููุน ุงูุนูุงุฑ" value="${unit['ูููุน ุงูุนูุงุฑ'] || ''}" placeholder="ุฑุงุจุท ูููุน ุงูุนูุงุฑ ุนูู ุงูุฎุฑูุทุฉ">
                            <small class="field-note">ููููู ุฅุฏุฎุงู ุฑุงุจุท ุฎุฑุงุฆุท ุฌูุฌู ุฃู ุฃู ุฑุงุจุท ุขุฎุฑ ูููููุน</small>
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3><i class="fas fa-calendar-alt"></i> ุงูุชูุงุฑูุฎ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:</label>
                            <input type="date" name="ุชุงุฑูุฎ ุงูุจุฏุงูุฉ" value="${formatDateForInput(unit['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ'])}">
                        </div>
                        <div class="form-group">
                            <label>ุชุงุฑูุฎ ุงูููุงูุฉ:</label>
                            <input type="date" name="ุชุงุฑูุฎ ุงูููุงูุฉ" value="${formatDateForInput(unit['ุชุงุฑูุฎ ุงูููุงูุฉ'])}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท:</label>
                            <input type="date" name="ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท" value="${formatDateForInput(unit['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท'])}">
                        </div>
                        <div class="form-group">
                            <label>ุนุฏุฏ ุงูุฃูุณุงุท ุงููุชุจููุฉ:</label>
                            <input type="number" name="ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ" value="${unit['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] || ''}" min="0">
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3><i class="fas fa-money-bill-wave"></i> ุงููุจุงูุบ ุงููุงููุฉ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ูููุฉ ุงูุฅูุฌุงุฑ:</label>
                            <input type="number" name="ูููุฉ  ุงูุงูุฌุงุฑ " value="${unit['ูููุฉ  ุงูุงูุฌุงุฑ '] || ''}" step="0.01" placeholder="ูููุฉ ุงูุฅูุฌุงุฑ">
                        </div>
                        <div class="form-group">
                            <label>ุงูุฅุฌูุงูู:</label>
                            <input type="number" name="ุงูุงุฌูุงูู" value="${unit['ุงูุงุฌูุงูู'] || ''}" step="0.01" placeholder="ุงููุจูุบ ุงูุฅุฌูุงูู">
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3><i class="fas fa-home"></i> ุชูุงุตูู ุงููุญุฏุฉ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ูุณุงุญุฉ ุงููุญุฏุฉ (ูยฒ):</label>
                            <input type="number" name="ุงููุณุงุญุฉ" value="${unit['ุงููุณุงุญุฉ'] || ''}" step="0.01" placeholder="ูุณุงุญุฉ ุงููุญุฏุฉ ุจุงููุชุฑ ุงููุฑุจุน">
                            <small class="field-note">ูุณุงุญุฉ ุงููุญุฏุฉ ุงููุนููุฉ (ูุฏ ุชุฎุชูู ุนู ูุณุงุญุฉ ุงูุตู)</small>
                        </div>
                        <div class="form-group">
                            <label>ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก:</label>
                            <input type="text" name="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก" value="${unit['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] || ''}" placeholder="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุงูุงุฑุชูุงุน:</label>
                            <input type="text" name="ุงูุงุฑุชูุงุน" value="${unit['ุงูุงุฑุชูุงุน'] || ''}" placeholder="ุงุฑุชูุงุน ุงููุญุฏุฉ">
                        </div>
                        <div class="form-group">
                            <label>ููุงุญุธุงุช ุงููุญุฏุฉ:</label>
                            <input type="text" name="ููุงุญุธุงุช ุงููุญุฏุฉ" value="${unit['ููุงุญุธุงุช ุงููุญุฏุฉ'] || ''}" placeholder="ุฃู ููุงุญุธุงุช ุฎุงุตุฉ ุจุงููุญุฏุฉ">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    `;
}

// ุฅูุดุงุก ูููุฐุฌ ุชุญุฑูุฑ ูุจุณุท ููุญุฏุฉ ูุงุญุฏุฉ (ุงููุณุฎุฉ ุงููุฏููุฉ)
function generateSingleUnitEditForm(unit, unitIndex) {
    const contractNumber = unit['ุฑูู ุงูุนูุฏ'] || '';
    const propertyName = unit['ุงุณู ุงูุนูุงุฑ'] || '';
    const unitNumber = unit['ุฑูู  ุงููุญุฏุฉ '] || '';

    return `
        <form id="unitEditForm_${unitIndex}" class="unit-edit-form" data-unit-index="${unitIndex}">
            <!-- ููุน ุงูุนูููุฉ -->
            <div class="operation-type-section">
                <h4><i class="fas fa-cogs"></i> ููุน ุงูุนูููุฉ *</h4>
                <div class="form-group">
                    <select name="operationType" required class="operation-type-select">
                        <option value="">-- ุงุฎุชุฑ ููุน ุงูุนูููุฉ --</option>
                        <option value="${OPERATION_TYPES.EDIT_DATA}">ุชุนุฏูู ุจูุงูุงุช ููุฌูุฏุฉ</option>
                        <option value="${OPERATION_TYPES.NEW_CLIENT}">ุนููู ุฌุฏูุฏ</option>
                        <option value="${OPERATION_TYPES.RENEW_CONTRACT}">ุชุฌุฏูุฏ ุนูุฏ</option>
                        <option value="${OPERATION_TYPES.EMPTY_UNIT}">ุฅูุฑุงุบ ูุญุฏุฉ</option>
                    </select>
                </div>
            </div>

            <!-- ุงูุญููู ุงููุฎููุฉ -->
            <input type="hidden" name="originalContractNumber" value="${contractNumber}">
            <input type="hidden" name="originalPropertyName" value="${propertyName}">
            <input type="hidden" name="originalUnitNumber" value="${unitNumber}">

            <!-- ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ -->
            <div class="edit-section">
                <h4><i class="fas fa-info-circle"></i> ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>ุงุณู ุงููุณุชุฃุฌุฑ:</label>
                        <input type="text" name="ุงุณู ุงููุณุชุฃุฌุฑ" value="${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''}" placeholder="ุงุณู ุงููุณุชุฃุฌุฑ">
                    </div>
                    <div class="form-group">
                        <label>ุฑูู ุงูุนูุฏ:</label>
                        <input type="text" name="ุฑูู ุงูุนูุฏ" value="${unit['ุฑูู ุงูุนูุฏ'] || ''}" placeholder="ุฑูู ุงูุนูุฏ">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ุฑูู ุงููุญุฏุฉ:</label>
                        <input type="text" name="ุฑูู  ุงููุญุฏุฉ " value="${unit['ุฑูู  ุงููุญุฏุฉ '] || ''}" placeholder="ุฑูู ุงููุญุฏุฉ">
                    </div>
                    <div class="form-group">
                        <label>ููุน ุงูุนูุฏ:</label>
                        <select name="ููุน ุงูุนูุฏ">
                            <option value="ุณููู" ${unit['ููุน ุงูุนูุฏ'] === 'ุณููู' ? 'selected' : ''}>ุณููู</option>
                            <option value="ุถุฑูุจู" ${unit['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู' ? 'selected' : ''}>ุถุฑูุจู</option>
                            <option value="ุชุฌุงุฑู" ${unit['ููุน ุงูุนูุฏ'] === 'ุชุฌุงุฑู' ? 'selected' : ''}>ุชุฌุงุฑู</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ุงูุชูุงุฑูุฎ -->
            <div class="edit-section">
                <h4><i class="fas fa-calendar-alt"></i> ุงูุชูุงุฑูุฎ</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:</label>
                        <input type="date" name="ุชุงุฑูุฎ ุงูุจุฏุงูุฉ" value="${formatDateForInput(unit['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ'])}">
                    </div>
                    <div class="form-group">
                        <label>ุชุงุฑูุฎ ุงูููุงูุฉ:</label>
                        <input type="date" name="ุชุงุฑูุฎ ุงูููุงูุฉ" value="${formatDateForInput(unit['ุชุงุฑูุฎ ุงูููุงูุฉ'])}">
                    </div>
                </div>
            </div>

            <!-- ุงููุจุงูุบ ุงููุงููุฉ -->
            <div class="edit-section">
                <h4><i class="fas fa-money-bill-wave"></i> ุงููุจุงูุบ ุงููุงููุฉ</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>ูููุฉ ุงูุฅูุฌุงุฑ:</label>
                        <input type="number" name="ูููุฉ  ุงูุงูุฌุงุฑ " value="${unit['ูููุฉ  ุงูุงูุฌุงุฑ '] || ''}" step="0.01" placeholder="ูููุฉ ุงูุฅูุฌุงุฑ">
                    </div>
                    <div class="form-group">
                        <label>ุงูุฅุฌูุงูู:</label>
                        <input type="number" name="ุงูุงุฌูุงูู" value="${unit['ุงูุงุฌูุงูู'] || ''}" step="0.01" placeholder="ุงููุจูุบ ุงูุฅุฌูุงูู">
                    </div>
                </div>
            </div>

            <!-- ุชูุงุตูู ุงููุญุฏุฉ -->
            <div class="edit-section">
                <h4><i class="fas fa-home"></i> ุชูุงุตูู ุงููุญุฏุฉ</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>ูุณุงุญุฉ ุงููุญุฏุฉ (ูยฒ):</label>
                        <input type="number" name="ุงููุณุงุญุฉ" value="${unit['ุงููุณุงุญุฉ'] || ''}" step="0.01" placeholder="ูุณุงุญุฉ ุงููุญุฏุฉ">
                    </div>
                    <div class="form-group">
                        <label>ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก:</label>
                        <input type="text" name="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก" value="${unit['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] || ''}" placeholder="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก">
                    </div>
                </div>
            </div>


        </form>
    `;
}

// ุญูุธ ุชุบููุฑุงุช ุฌููุน ุงููุญุฏุงุช
async function saveAllUnitsChanges() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุงุช ููุญูุธ');
        return;
    }

    console.log(`๐พ ุจุฏุก ุญูุธ ุชุบููุฑุงุช ${window.currentEditingUnits.length} ูุญุฏุฉ`);

    let successCount = 0;
    let errorCount = 0;
    const errors = [];

    // ุฅุธูุงุฑ ุดุฑูุท ุงูุชูุฏู
    showProgressModal(`ุฌุงุฑู ุญูุธ ${window.currentEditingUnits.length} ูุญุฏุฉ...`, async function(updateProgress) {
        try {
            for (let i = 0; i < window.currentEditingUnits.length; i++) {
                const unit = window.currentEditingUnits[i];
                const progress = Math.round(((i + 1) / window.currentEditingUnits.length) * 100);

                updateProgress(progress, `ุญูุธ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ '] || (i + 1)}...`);

                try {
                    const form = document.getElementById(`unitEditForm_${i}`);
                    if (form) {
                        const formData = new FormData(form);
                        await saveIndividualUnitChanges(formData, i);
                        successCount++;
                    }
                } catch (error) {
                    console.error(`โ ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}:`, error);
                    errorCount++;
                    errors.push(`ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}: ${error.message}`);
                }

                // ุชุฃุฎูุฑ ูุตูุฑ ุจูู ุงูุญูุธุงุช
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            return {
                success: errorCount === 0,
                message: `ุชู ุญูุธ ${successCount} ูุญุฏุฉ ุจูุฌุงุญ` +
                        (errorCount > 0 ? `\nูุดู ุญูุธ ${errorCount} ูุญุฏุฉ` : '')
            };
        } catch (error) {
            return {
                success: false,
                message: `ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุงุช: ${error.message}`
            };
        }
    }, function(result) {
        if (result.success) {
            showSuccessMessage('ุชู ุญูุธ ุฌููุน ุงููุญุฏุงุช!', result.message);
            closeModal();
            renderData();
            updateTotalStats();
        } else {
            showErrorMessage('ุฎุทุฃ ูู ุงูุญูุธ', result.message);
        }
    });
}

// ุญูุธ ุชุบููุฑุงุช ุงููุญุฏุฉ ุงูุญุงููุฉ ููุท
async function saveCurrentUnitChanges() {
    const activeTab = document.querySelector('.tab-btn.active');
    if (!activeTab) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุฉ ูุดุทุฉ ููุญูุธ');
        return;
    }

    const tabIndex = parseInt(activeTab.getAttribute('data-tab'));
    const form = document.getElementById(`unitEditForm_${tabIndex}`);

    if (!form) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุฐุฌ ุงููุญุฏุฉ');
        return;
    }

    const unit = window.currentEditingUnits[tabIndex];
    console.log(`๐พ ุญูุธ ุชุบููุฑุงุช ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}`);

    try {
        const formData = new FormData(form);
        await saveIndividualUnitChanges(formData, tabIndex);

        showSuccessMessage('ุชู ุงูุญูุธ!', `ุชู ุญูุธ ุชุบููุฑุงุช ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ุจูุฌุงุญ`);

        // ุชุญุฏูุซ ุงูุชุจููุจ ูุฅุธูุงุฑ ุงูุชุบููุฑุงุช
        const updatedUnit = window.currentEditingUnits[tabIndex];
        const tabBtn = document.querySelector(`[data-tab="${tabIndex}"]`);
        if (tabBtn) {
            const statusSpan = tabBtn.querySelector('.tab-status');
            if (statusSpan) {
                const newStatus = calculateStatus(updatedUnit);
                statusSpan.textContent = newStatus.final || 'ุบูุฑ ูุญุฏุฏ';
                statusSpan.className = `tab-status ${getUnitStatusClass(updatedUnit)}`;
            }
        }

    } catch (error) {
        console.error(`โ ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุฉ:`, error);
        showErrorMessage('ุฎุทุฃ ูู ุงูุญูุธ', `ูุดู ุญูุธ ุงููุญุฏุฉ: ${error.message}`);
    }
}

// ุญูุธ ุชุบููุฑุงุช ูุญุฏุฉ ูุฑุฏูุฉ
async function saveIndividualUnitChanges(formData, unitIndex) {
    const unit = window.currentEditingUnits[unitIndex];
    const originalContractNumber = formData.get('originalContractNumber');
    const originalPropertyName = formData.get('originalPropertyName');
    const originalUnitNumber = formData.get('originalUnitNumber');

    // ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ูู ุงููุตูููุฉ ุงูุฃุณุงุณูุฉ
    const propertyIndex = properties.findIndex(p =>
        p['ุฑูู ุงูุนูุฏ'] === originalContractNumber &&
        p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName &&
        p['ุฑูู  ุงููุญุฏุฉ '] === originalUnitNumber
    );

    if (propertyIndex === -1) {
        console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ููุชุญุฏูุซ:', {
            contractNumber: originalContractNumber,
            propertyName: originalPropertyName,
            unitNumber: originalUnitNumber
        });
        throw new Error(`ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ${originalUnitNumber} ูู ุงูุจูุงูุงุช`);
    }

    console.log(`โ ุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ูู ุงูููุฑุณ: ${propertyIndex}`);

    // ุชุญุฏูุซ ุงูุจูุงูุงุช (ุชุญุฏูุซ ุงููุญุฏุฉ ุงูููุฌูุฏุฉ ุจุฏูุงู ูู ุฅูุดุงุก ุฌุฏูุฏุฉ)
    const updatedProperty = { ...properties[propertyIndex] };

    // ุชุญุฏูุซ ุงูุญููู ูู ุงููููุฐุฌ
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('original')) continue;

        // ุชุญููู ุงูุชูุงุฑูุฎ
        if (key.includes('ุชุงุฑูุฎ') && value) {
            const dateParts = value.split('-');
            if (dateParts.length === 3 && dateParts[0].length === 4) {
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);

                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                }
            }
        }

        // ุชุญููู ุงูุฃุฑูุงู
        if (['ุงููุณุงุญุฉ', 'ูููุฉ  ุงูุงูุฌุงุฑ ', 'ุงูุงุฌูุงูู'].includes(key) && value) {
            value = parseFloat(value) || 0;
        }

        updatedProperty[key] = value || '';
    }

    // ูุนุงูุฌุฉ ุฎุงุตุฉ ูุญููู ุงูุฌูุงู ูุถูุงู ุงูุญูุธ ูู Supabase
    if (updatedProperty['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ']) {
        updatedProperty['tenant_phone'] = updatedProperty['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ'];
    }
    if (updatedProperty['ุฑูู ุฌูุงู ุฅุถุงูู']) {
        updatedProperty['tenant_phone_2'] = updatedProperty['ุฑูู ุฌูุงู ุฅุถุงูู'];
    }

    // ุฅุถุงูุฉ ูุนูููุงุช ุงูุชุญุฏูุซ
    updatedProperty['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
    updatedProperty['ููุน ุงูุชุญุฏูุซ'] = formData.get('operationType') || 'ุชุญุฑูุฑ';
    updatedProperty['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = getCurrentUser();

    // ุญูุธ ุงูุชุญุฏูุซ
    properties[propertyIndex] = updatedProperty;
    window.currentEditingUnits[unitIndex] = updatedProperty;

    // ุญูุธ ูุญููุงู
    saveDataLocally();

    // ุญูุธ ูู Supabase
    if (typeof savePropertyToSupabase === 'function') {
        try {
            await savePropertyToSupabase(updatedProperty);
        } catch (error) {
            console.warn('ุชุญุฐูุฑ: ูุดู ุญูุธ ุงููุญุฏุฉ ูู Supabase:', error);
        }
    }

    console.log(`โ ุชู ุญูุธ ุงููุญุฏุฉ ${updatedProperty['ุฑูู  ุงููุญุฏุฉ ']} ุจูุฌุงุญ`);
}

// ุงูุนูููุงุช ุงููุดุชุฑูุฉ ูุฌููุน ุงููุญุฏุงุช
async function setNewClientForAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุงุช ููุชุนุฏูู');
        return;
    }

    const newTenantName = prompt('ุฃุฏุฎู ุงุณู ุงููุณุชุฃุฌุฑ ุงูุฌุฏูุฏ:');
    if (!newTenantName || newTenantName.trim() === '') {
        return;
    }

    const newContractNumber = prompt('ุฃุฏุฎู ุฑูู ุงูุนูุฏ ุงูุฌุฏูุฏ:');
    if (!newContractNumber || newContractNumber.trim() === '') {
        return;
    }

    console.log(`๐ฅ ุชุทุจูู ุนููู ุฌุฏูุฏ ุนูู ${window.currentEditingUnits.length} ูุญุฏุฉ`);

    try {
        // ุชุญุฏูุซ ุฌููุน ุงูููุงุฐุฌ
        for (let i = 0; i < window.currentEditingUnits.length; i++) {
            const form = document.getElementById(`unitEditForm_${i}`);
            if (form) {
                form.querySelector('[name="ุงุณู ุงููุณุชุฃุฌุฑ"]').value = newTenantName;
                form.querySelector('[name="ุฑูู ุงูุนูุฏ"]').value = newContractNumber;
                form.querySelector('[name="operationType"]').value = OPERATION_TYPES.NEW_CLIENT;
            }
        }

        showSuccessMessage('ุชู ุงูุชุญุฏูุซ!', `ุชู ุชุทุจูู ุงูุนููู ุงูุฌุฏูุฏ "${newTenantName}" ุนูู ุฌููุน ุงููุญุฏุงุช`);
    } catch (error) {
        showErrorMessage('ุฎุทุฃ', `ูุดู ูู ุชุทุจูู ุงูุนููู ุงูุฌุฏูุฏ: ${error.message}`);
    }
}

async function renewContractForAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุงุช ููุชุนุฏูู');
        return;
    }

    const startDate = prompt('ุฃุฏุฎู ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ ุงูุฌุฏูุฏ (dd/mm/yyyy):');
    if (!startDate) return;

    const endDate = prompt('ุฃุฏุฎู ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ ุงูุฌุฏูุฏ (dd/mm/yyyy):');
    if (!endDate) return;

    console.log(`๐ ุชุฌุฏูุฏ ุงูุนูุฏ ูู ${window.currentEditingUnits.length} ูุญุฏุฉ`);

    try {
        // ุชุญููู ุงูุชูุงุฑูุฎ ูุตูุบุฉ input
        const startDateForInput = convertDateToInputFormat(startDate);
        const endDateForInput = convertDateToInputFormat(endDate);

        // ุชุญุฏูุซ ุฌููุน ุงูููุงุฐุฌ
        for (let i = 0; i < window.currentEditingUnits.length; i++) {
            const form = document.getElementById(`unitEditForm_${i}`);
            if (form) {
                form.querySelector('[name="ุชุงุฑูุฎ ุงูุจุฏุงูุฉ"]').value = startDateForInput;
                form.querySelector('[name="ุชุงุฑูุฎ ุงูููุงูุฉ"]').value = endDateForInput;
                form.querySelector('[name="operationType"]').value = OPERATION_TYPES.RENEW_CONTRACT;
            }
        }

        showSuccessMessage('ุชู ุงูุชุญุฏูุซ!', `ุชู ุชุฌุฏูุฏ ุงูุนูุฏ ูุฌููุน ุงููุญุฏุงุช ูู ${startDate} ุฅูู ${endDate}`);
    } catch (error) {
        showErrorMessage('ุฎุทุฃ', `ูุดู ูู ุชุฌุฏูุฏ ุงูุนูุฏ: ${error.message}`);
    }
}

async function emptyAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุงุช ููุชุนุฏูู');
        return;
    }

    const confirm = window.confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุฑุงุบ ุฌููุน ุงููุญุฏุงุช (${window.currentEditingUnits.length} ูุญุฏุฉ)ุ\n\nุณูุชู ุญุฐู ูุนูููุงุช ุงููุณุชุฃุฌุฑ ูุงูุนูุฏ ูู ุฌููุน ุงููุญุฏุงุช.`);
    if (!confirm) return;

    console.log(`๐งน ุฅูุฑุงุบ ${window.currentEditingUnits.length} ูุญุฏุฉ`);

    try {
        // ุชุญุฏูุซ ุฌููุน ุงูููุงุฐุฌ
        for (let i = 0; i < window.currentEditingUnits.length; i++) {
            const form = document.getElementById(`unitEditForm_${i}`);
            if (form) {
                form.querySelector('[name="ุงุณู ุงููุณุชุฃุฌุฑ"]').value = '';
                form.querySelector('[name="ุฑูู ุงูุนูุฏ"]').value = '';
                form.querySelector('[name="ุชุงุฑูุฎ ุงูุจุฏุงูุฉ"]').value = '';
                form.querySelector('[name="ุชุงุฑูุฎ ุงูููุงูุฉ"]').value = '';
                form.querySelector('[name="ูููุฉ  ุงูุงูุฌุงุฑ "]').value = '';
                form.querySelector('[name="ุงูุงุฌูุงูู"]').value = '';
                form.querySelector('[name="operationType"]').value = OPERATION_TYPES.EMPTY_UNIT;
            }
        }

        showSuccessMessage('ุชู ุงูุฅูุฑุงุบ!', 'ุชู ุฅูุฑุงุบ ุฌููุน ุงููุญุฏุงุช ูู ูุนูููุงุช ุงููุณุชุฃุฌุฑ ูุงูุนูุฏ');
    } catch (error) {
        showErrorMessage('ุฎุทุฃ', `ูุดู ูู ุฅูุฑุงุบ ุงููุญุฏุงุช: ${error.message}`);
    }
}

async function syncDeedInfoForAllUnits() {
    if (!window.currentEditingUnits || window.currentEditingUnits.length === 0) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุงุช ููุชุนุฏูู');
        return;
    }

    // ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุตู ูู ุงููุญุฏุฉ ุงูุฃููู
    const primaryUnit = window.currentEditingUnits[0];
    const form0 = document.getElementById('unitEditForm_0');

    if (!form0) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุฐุฌ ุงููุญุฏุฉ ุงูุฃููู');
        return;
    }

    const deedInfo = {
        'ุฑูู ุงูุตู': form0.querySelector('[name="ุฑูู ุงูุตู"]')?.value || primaryUnit['ุฑูู ุงูุตู'] || '',
        'ูุณุงุญุฉุงูุตู': form0.querySelector('[name="ูุณุงุญุฉุงูุตู"]')?.value || primaryUnit['ูุณุงุญุฉุงูุตู'] || '',
        'ุงูุณุฌู ุงูุนููู ': form0.querySelector('[name="ุงูุณุฌู ุงูุนููู "]')?.value || primaryUnit['ุงูุณุฌู ุงูุนููู '] || '',
        'ูููุน ุงูุนูุงุฑ': form0.querySelector('[name="ูููุน ุงูุนูุงุฑ"]')?.value || primaryUnit['ูููุน ุงูุนูุงุฑ'] || '',
        'ุงููุงูู': form0.querySelector('[name="ุงููุงูู"]')?.value || primaryUnit['ุงููุงูู'] || ''
    };

    console.log(`๐ ูุฒุงููุฉ ูุนูููุงุช ุงูุตู ูู ${window.currentEditingUnits.length} ูุญุฏุฉ`);

    try {
        // ุชุทุจูู ูุนูููุงุช ุงูุตู ุนูู ุฌููุน ุงูููุงุฐุฌ
        for (let i = 1; i < window.currentEditingUnits.length; i++) {
            const form = document.getElementById(`unitEditForm_${i}`);
            if (form) {
                Object.keys(deedInfo).forEach(field => {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        input.value = deedInfo[field];
                    }
                });
            }
        }

        showSuccessMessage('ุชู ุงูุชุฒุงูู!', 'ุชู ูุฒุงููุฉ ูุนูููุงุช ุงูุตู ูุฌููุน ุงููุญุฏุงุช');
    } catch (error) {
        showErrorMessage('ุฎุทุฃ', `ูุดู ูู ูุฒุงููุฉ ูุนูููุงุช ุงูุตู: ${error.message}`);
    }
}

// ุงูุนูููุงุช ุงููุฑุฏูุฉ ูููุญุฏุงุช
async function setNewClientForUnit(unitIndex) {
    const unit = window.currentEditingUnits[unitIndex];
    const newTenantName = prompt(`ุฃุฏุฎู ุงุณู ุงููุณุชุฃุฌุฑ ุงูุฌุฏูุฏ ูููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}:`);
    if (!newTenantName || newTenantName.trim() === '') return;

    const newContractNumber = prompt('ุฃุฏุฎู ุฑูู ุงูุนูุฏ ุงูุฌุฏูุฏ:');
    if (!newContractNumber || newContractNumber.trim() === '') return;

    try {
        const form = document.getElementById(`unitEditForm_${unitIndex}`);
        if (form) {
            form.querySelector('[name="ุงุณู ุงููุณุชุฃุฌุฑ"]').value = newTenantName;
            form.querySelector('[name="ุฑูู ุงูุนูุฏ"]').value = newContractNumber;
            form.querySelector('[name="operationType"]').value = OPERATION_TYPES.NEW_CLIENT;
        }

        showSuccessMessage('ุชู ุงูุชุญุฏูุซ!', `ุชู ุชุทุจูู ุงูุนููู ุงูุฌุฏูุฏ ุนูู ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}`);
    } catch (error) {
        showErrorMessage('ุฎุทุฃ', `ูุดู ูู ุชุทุจูู ุงูุนููู ุงูุฌุฏูุฏ: ${error.message}`);
    }
}

async function renewContractForUnit(unitIndex) {
    const unit = window.currentEditingUnits[unitIndex];
    const startDate = prompt(`ุฃุฏุฎู ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ ุงูุฌุฏูุฏ ูููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} (dd/mm/yyyy):`);
    if (!startDate) return;

    const endDate = prompt('ุฃุฏุฎู ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ ุงูุฌุฏูุฏ (dd/mm/yyyy):');
    if (!endDate) return;

    try {
        const startDateForInput = convertDateToInputFormat(startDate);
        const endDateForInput = convertDateToInputFormat(endDate);

        const form = document.getElementById(`unitEditForm_${unitIndex}`);
        if (form) {
            form.querySelector('[name="ุชุงุฑูุฎ ุงูุจุฏุงูุฉ"]').value = startDateForInput;
            form.querySelector('[name="ุชุงุฑูุฎ ุงูููุงูุฉ"]').value = endDateForInput;
            form.querySelector('[name="operationType"]').value = OPERATION_TYPES.RENEW_CONTRACT;
        }

        showSuccessMessage('ุชู ุงูุชุญุฏูุซ!', `ุชู ุชุฌุฏูุฏ ุงูุนูุฏ ูููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}`);
    } catch (error) {
        showErrorMessage('ุฎุทุฃ', `ูุดู ูู ุชุฌุฏูุฏ ุงูุนูุฏ: ${error.message}`);
    }
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุญููู ุงูุชุงุฑูุฎ
function convertDateToInputFormat(dateStr) {
    if (!dateStr) return '';

    const parts = dateStr.split('/');
    if (parts.length !== 3) return '';

    const day = parseInt(parts[0]);
    const month = parseInt(parts[1]);
    const year = parseInt(parts[2]);

    if (isNaN(day) || isNaN(month) || isNaN(year)) return '';

    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
}

// ๐งน ุชูุธูู ุงูุจูุงูุงุช ุงูููุฑุฑุฉ
async function cleanDuplicateUnits() {
    console.log('๐งน ุจุฏุก ุชูุธูู ุงูุจูุงูุงุช ุงูููุฑุฑุฉ...');

    try {
        // 1. ุชูุธูู localStorage
        const cleanedLocalData = removeDuplicateUnitsFromArray(properties);
        const removedLocalCount = properties.length - cleanedLocalData.length;

        if (removedLocalCount > 0) {
            properties.length = 0; // ูุณุญ ุงููุตูููุฉ
            properties.push(...cleanedLocalData); // ุฅุถุงูุฉ ุงูุจูุงูุงุช ุงูููุธูุฉ
            saveDataLocally();
            console.log(`โ ุชู ุญุฐู ${removedLocalCount} ูุญุฏุฉ ููุฑุฑุฉ ูู localStorage`);
        }

        // 2. ุชูุธูู Supabase
        if (typeof cleanDuplicateUnitsFromSupabase === 'function') {
            await cleanDuplicateUnitsFromSupabase();
        }

        // 3. ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
        await loadDataFromSupabase();

        showSuccessMessage('ุชู ุงูุชูุธูู!', `ุชู ุญุฐู ${removedLocalCount} ูุญุฏุฉ ููุฑุฑุฉ ูู ุงููุธุงู`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชูุธูู ุงูุจูุงูุงุช:', error);
        showErrorMessage('ุฎุทุฃ ูู ุงูุชูุธูู', error.message);
    }
}

// ุฅุฒุงูุฉ ุงููุญุฏุงุช ุงูููุฑุฑุฉ ูู ูุตูููุฉ (ูุณุฎุฉ ูุญุณูุฉ ูุขููุฉ)
function removeDuplicateUnitsFromArray(unitsArray) {
    if (!unitsArray || unitsArray.length === 0) {
        console.log('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชูุธูู');
        return [];
    }

    const uniqueUnits = new Map();
    const duplicates = [];

    unitsArray.forEach((unit) => {
        // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        if (!unit['ุงุณู ุงูุนูุงุฑ'] || !unit['ุฑูู  ุงููุญุฏุฉ ']) {
            console.warn('โ๏ธ ูุญุฏุฉ ุจุฏูู ุงุณู ุนูุงุฑ ุฃู ุฑูู ูุญุฏุฉ:', unit);
            return; // ุชุฌุงูู ุงููุญุฏุงุช ุงููุงูุตุฉ
        }

        const unitKey = `${unit['ุงุณู ุงูุนูุงุฑ']}_${unit['ุฑูู  ุงููุญุฏุฉ ']}`;

        if (uniqueUnits.has(unitKey)) {
            // ูุญุฏุฉ ููุฑุฑุฉ - ุงุญุชูุธ ุจุงูุฃุญุฏุซ ุฃู ุงูุฃูุซุฑ ุงูุชูุงูุงู
            const existingUnit = uniqueUnits.get(unitKey);

            // ููุงุฑูุฉ ุงูุชูุงุฑูุฎ
            const existingDate = new Date(existingUnit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || existingUnit.created_at || '1900-01-01');
            const currentDate = new Date(unit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || unit.created_at || '1900-01-01');

            // ููุงุฑูุฉ ุงูุชูุงู ุงูุจูุงูุงุช
            const existingCompleteness = Object.values(existingUnit).filter(v => v && v !== '').length;
            const currentCompleteness = Object.values(unit).filter(v => v && v !== '').length;

            let shouldReplace = false;

            if (currentDate > existingDate) {
                shouldReplace = true;
            } else if (currentDate.getTime() === existingDate.getTime() && currentCompleteness > existingCompleteness) {
                shouldReplace = true;
            }

            if (shouldReplace) {
                duplicates.push(existingUnit);
                uniqueUnits.set(unitKey, unit);
                console.log(`๐ ุงุณุชุจุฏุงู ูุญุฏุฉ ููุฑุฑุฉ: ${unitKey} (ุฃุญุฏุซ ุฃู ุฃูุซุฑ ุงูุชูุงูุงู)`);
            } else {
                duplicates.push(unit);
                console.log(`๐๏ธ ุญุฐู ูุญุฏุฉ ููุฑุฑุฉ ูุฏููุฉ: ${unitKey}`);
            }
        } else {
            uniqueUnits.set(unitKey, unit);
        }
    });

    console.log(`๐ ุฅุญุตุงุฆูุงุช ุงูุชูุธูู ุงูุขูู: ${uniqueUnits.size} ูุญุฏุฉ ูุฑูุฏุฉุ ${duplicates.length} ูุญุฏุฉ ููุฑุฑุฉ`);

    // ุนุฑุถ ุชูุงุตูู ุงููุญุฏุงุช ุงูููุฑุฑุฉ ูููุฑุงุฌุนุฉ
    if (duplicates.length > 0) {
        console.group('๐ ุชูุงุตูู ุงููุญุฏุงุช ุงูููุฑุฑุฉ:');
        duplicates.forEach(dup => {
            console.log(`- ${dup['ุงุณู ุงูุนูุงุฑ']} - ${dup['ุฑูู  ุงููุญุฏุฉ ']} (${dup['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || 'ุจุฏูู ุชุงุฑูุฎ'})`);
        });
        console.groupEnd();
    }

    return Array.from(uniqueUnits.values());
}

// ุชูุธูู ุงููุญุฏุงุช ุงูููุฑุฑุฉ ูู Supabase
async function cleanDuplicateUnitsFromSupabase() {
    if (!supabaseClient) {
        console.warn('โ๏ธ Supabase ุบูุฑ ูุชุงุญ ููุชูุธูู');
        return;
    }

    try {
        console.log('๐ ุงูุจุญุซ ุนู ุงููุญุฏุงุช ุงูููุฑุฑุฉ ูู Supabase...');

        // ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ูู Supabase
        const { data: allUnits, error } = await supabaseClient
            .from('properties')
            .select('*');

        if (error) {
            throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช: ${error.message}`);
        }

        if (!allUnits || allUnits.length === 0) {
            console.log('๐ญ ูุง ุชูุฌุฏ ุจูุงูุงุช ูู Supabase ููุชูุธูู');
            return;
        }

        // ุชุญุฏูุฏ ุงููุญุฏุงุช ุงูููุฑุฑุฉ
        const uniqueUnits = new Map();
        const duplicatesToDelete = [];

        allUnits.forEach(unit => {
            const unitKey = `${unit['ุงุณู ุงูุนูุงุฑ']}_${unit['ุฑูู  ุงููุญุฏุฉ ']}`;

            if (uniqueUnits.has(unitKey)) {
                // ูุญุฏุฉ ููุฑุฑุฉ - ุงุญุชูุธ ุจุงูุฃุญุฏุซ
                const existingUnit = uniqueUnits.get(unitKey);
                const existingDate = new Date(existingUnit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || existingUnit.created_at || '1900-01-01');
                const currentDate = new Date(unit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || unit.created_at || '1900-01-01');

                if (currentDate > existingDate) {
                    duplicatesToDelete.push(existingUnit.id);
                    uniqueUnits.set(unitKey, unit);
                } else {
                    duplicatesToDelete.push(unit.id);
                }
            } else {
                uniqueUnits.set(unitKey, unit);
            }
        });

        // ุญุฐู ุงููุญุฏุงุช ุงูููุฑุฑุฉ
        if (duplicatesToDelete.length > 0) {
            console.log(`๐๏ธ ุญุฐู ${duplicatesToDelete.length} ูุญุฏุฉ ููุฑุฑุฉ ูู Supabase...`);

            const { error: deleteError } = await supabaseClient
                .from('properties')
                .delete()
                .in('id', duplicatesToDelete);

            if (deleteError) {
                throw new Error(`ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุงุช ุงูููุฑุฑุฉ: ${deleteError.message}`);
            }

            console.log(`โ ุชู ุญุฐู ${duplicatesToDelete.length} ูุญุฏุฉ ููุฑุฑุฉ ูู Supabase`);
        } else {
            console.log('โ ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฑุฑุฉ ูู Supabase');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชูุธูู Supabase:', error);
        throw error;
    }
}

// ุนุฑุถ ูุงูุฐุฉ ุชุญุฑูุฑ ูุญุฏุฉ ูุงุญุฏุฉ (ุงููุงูุฐุฉ ุงูุฃุตููุฉ)
function showSingleUnitEditModal(property, contractNumber, propertyName, unitNumber) {
    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุชุญุฑูุฑ
    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box property-edit-modal">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <div class="edit-modal-header">
                <h2><i class="fas fa-edit"></i> ุชุญุฑูุฑ ุจูุงูุงุช ุงูุนูุงุฑ</h2>
                <p>${propertyName} - ${contractNumber ? 'ุนูุฏ ุฑูู: ' + contractNumber : 'ูุญุฏุฉ ุฑูู: ' + unitNumber}</p>
            </div>
            <div class="edit-modal-content">
                <form id="propertyEditForm" onsubmit="savePropertyEdit(event)">
                    <!-- ููุน ุงูุนูููุฉ - ุญูู ุฅุฌุจุงุฑู -->
                    <div class="operation-type-section">
                        <h3><i class="fas fa-cogs"></i> ููุน ุงูุนูููุฉ *</h3>
                        <div class="form-group">
                            <label for="operationType">ุงุฎุชุฑ ููุน ุงูุนูููุฉ:</label>
                            <select id="operationType" name="operationType" required class="operation-type-select">
                                <option value="">-- ุงุฎุชุฑ ููุน ุงูุนูููุฉ --</option>
                                <option value="${OPERATION_TYPES.EDIT_DATA}">ุชุนุฏูู ุจูุงูุงุช ููุฌูุฏุฉ</option>
                                <option value="${OPERATION_TYPES.NEW_CLIENT}">ุนููู ุฌุฏูุฏ</option>
                                <option value="${OPERATION_TYPES.RENEW_CONTRACT}">ุชุฌุฏูุฏ ุนูุฏ</option>
                                <option value="${OPERATION_TYPES.EMPTY_UNIT}">ุฅูุฑุงุบ ูุญุฏุฉ</option>
                            </select>
                            <small class="field-note">ูุฌุจ ุงุฎุชูุงุฑ ููุน ุงูุนูููุฉ ูุจู ุงูุญูุธ</small>
                        </div>
                    </div>

                    <!-- ุงูุญููู ุงููุฎููุฉ ููุจูุงูุงุช ุงูุฃุตููุฉ -->
                    <input type="hidden" name="originalContractNumber" value="${contractNumber || ''}">
                    <input type="hidden" name="originalPropertyName" value="${propertyName || ''}">
                    <input type="hidden" name="originalUnitNumber" value="${unitNumber || ''}">

                    <div class="edit-form-sections">
                        <div class="edit-section">
                            <h3><i class="fas fa-info-circle"></i> ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุงุณู ุงููุณุชุฃุฌุฑ:</label>
                                    <input type="text" name="ุงุณู ุงููุณุชุฃุฌุฑ" value="${property['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''}" placeholder="ุงุณู ุงููุณุชุฃุฌุฑ">
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ:</label>
                                    <input type="tel" name="ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ" value="${property['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ'] || ''}" placeholder="05xxxxxxxx" pattern="[0-9]{10}" maxlength="10">
                                    <small class="field-note">ุฃุฏุฎู ุฑูู ุงูุฌูุงู ุจุฏูู ูุณุงูุงุช (10 ุฃุฑูุงู)</small>
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุฌูุงู ุฅุถุงูู:</label>
                                    <input type="tel" name="ุฑูู ุฌูุงู ุฅุถุงูู" value="${property['ุฑูู ุฌูุงู ุฅุถุงูู'] || ''}" placeholder="05xxxxxxxx" pattern="[0-9]{10}" maxlength="10">
                                    <small class="field-note">ุฑูู ุฌูุงู ุซุงูู ูููุณุชุฃุฌุฑ (ุงุฎุชูุงุฑู)</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุงููุงูู:</label>
                                    <input type="text" name="ุงููุงูู" value="${property['ุงููุงูู'] || ''}" placeholder="ุงุณู ุงููุงูู">
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุงูุนูุฏ:</label>
                                    <input type="text" name="ุฑูู ุงูุนูุฏ" value="${property['ุฑูู ุงูุนูุฏ'] || ''}" placeholder="ุฑูู ุงูุนูุฏ">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ููุน ุงูุนูุฏ:</label>
                                    <select name="ููุน ุงูุนูุฏ">
                                        <option value="ุณููู" ${property['ููุน ุงูุนูุฏ'] === 'ุณููู' ? 'selected' : ''}>ุณููู</option>
                                        <option value="ุถุฑูุจู" ${property['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู' ? 'selected' : ''}>ุถุฑูุจู</option>
                                        <option value="ุชุฌุงุฑู" ${property['ููุน ุงูุนูุฏ'] === 'ุชุฌุงุฑู' ? 'selected' : ''}>ุชุฌุงุฑู</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <!-- ุญูู ูุงุฑุบ ููุชูุงุฒู -->
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-building"></i> ูุนูููุงุช ุงูุนูุงุฑ ูุงูุตู</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุงุณู ุงูุนูุงุฑ:</label>
                                    <input type="text" name="ุงุณู ุงูุนูุงุฑ" value="${property['ุงุณู ุงูุนูุงุฑ'] || ''}" placeholder="ุงุณู ุงูุนูุงุฑ" readonly style="background-color: #f8f9fa;">
                                    <small class="field-note">ูุชุบููุฑ ุงุณู ุงูุนูุงุฑุ ุงุณุชุฎุฏู "ุชุญุฑูุฑ ุงูุนูุงุฑ" ูู ุงูุฅุญุตุงุฆูุงุช</small>
                                </div>
                                <div class="form-group">
                                    <label>ุงููุฏููุฉ:</label>
                                    <input type="text" name="ุงููุฏููุฉ" value="${property['ุงููุฏููุฉ'] || ''}" placeholder="ุงููุฏููุฉ" readonly style="background-color: #f8f9fa;">
                                    <small class="field-note">ูุชุบููุฑ ุงููุฏููุฉุ ุงุณุชุฎุฏู "ุชุญุฑูุฑ ุงูุนูุงุฑ" ูู ุงูุฅุญุตุงุฆูุงุช</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุฑูู ุงููุญุฏุฉ:</label>
                                    <input type="text" name="ุฑูู  ุงููุญุฏุฉ " value="${property['ุฑูู  ุงููุญุฏุฉ '] || ''}" placeholder="ุฑูู ุงููุญุฏุฉ">
                                    <small class="field-note">ุฑูู ุงููุญุฏุฉ ูุฌุจ ุฃู ูููู ูุฑูุฏุงู</small>
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุงูุตู:</label>
                                    <input type="text" name="ุฑูู ุงูุตู" value="${property['ุฑูู ุงูุตู'] || ''}" placeholder="ุฑูู ุงูุตู">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ูุณุงุญุฉ ุงูุตู (ูยฒ):</label>
                                    <input type="number" name="ูุณุงุญุฉุงูุตู" value="${property['ูุณุงุญุฉุงูุตู'] || ''}" step="0.01" placeholder="ูุณุงุญุฉ ุงูุตู ุจุงููุชุฑ ุงููุฑุจุน">
                                </div>
                                <div class="form-group">
                                    <label>ุงูุณุฌู ุงูุนููู:</label>
                                    <input type="text" name="ุงูุณุฌู ุงูุนููู " value="${property['ุงูุณุฌู ุงูุนููู '] || ''}" placeholder="ุฑูู ุงูุณุฌู ุงูุนููู">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>ูููุน ุงูุนูุงุฑ:</label>
                                    <input type="url" name="ูููุน ุงูุนูุงุฑ" value="${property['ูููุน ุงูุนูุงุฑ'] || ''}" placeholder="ุฑุงุจุท ูููุน ุงูุนูุงุฑ ุนูู ุงูุฎุฑูุทุฉ">
                                    <small class="field-note">ููููู ุฅุฏุฎุงู ุฑุงุจุท ุฎุฑุงุฆุท ุฌูุฌู ุฃู ุฃู ุฑุงุจุท ุขุฎุฑ ูููููุน</small>
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-calendar-alt"></i> ุงูุชูุงุฑูุฎ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:</label>
                                    <input type="date" name="ุชุงุฑูุฎ ุงูุจุฏุงูุฉ" value="${formatDateForInput(property['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ'])}">
                                </div>
                                <div class="form-group">
                                    <label>ุชุงุฑูุฎ ุงูููุงูุฉ:</label>
                                    <input type="date" name="ุชุงุฑูุฎ ุงูููุงูุฉ" value="${formatDateForInput(property['ุชุงุฑูุฎ ุงูููุงูุฉ'])}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท:</label>
                                    <input type="date" name="ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท" value="${formatDateForInput(property['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท'])}">
                                </div>
                                <div class="form-group">
                                    <label>ุนุฏุฏ ุงูุฃูุณุงุท ุงููุชุจููุฉ:</label>
                                    <input type="number" name="ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ" value="${property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] || ''}" min="0">
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-money-bill-wave"></i> ุงููุจุงูุบ ุงููุงููุฉ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ูููุฉ ุงูุฅูุฌุงุฑ:</label>
                                    <input type="number" name="ูููุฉ  ุงูุงูุฌุงุฑ " value="${property['ูููุฉ  ุงูุงูุฌุงุฑ '] || ''}" step="0.01" placeholder="ูููุฉ ุงูุฅูุฌุงุฑ">
                                </div>
                                <div class="form-group">
                                    <label>ุงูุฅุฌูุงูู:</label>
                                    <input type="number" name="ุงูุงุฌูุงูู" value="${property['ุงูุงุฌูุงูู'] || ''}" step="0.01" placeholder="ุงููุจูุบ ุงูุฅุฌูุงูู">
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-calendar-check"></i> ุฅุฏุงุฑุฉ ุงูุฃูุณุงุท</h3>
                            <div class="installments-management">
                                <div class="installments-header">
                                    <p class="section-description">ููููู ุฅุถุงูุฉ ูุชุนุฏูู ุฃูุณุงุท ุงูุนูุฏ ูุน ุชูุงุฑูุฎูุง ููุจุงูุบูุง</p>
                                    <div class="total-display" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 10px; border-radius: 6px; margin: 10px 0; text-align: center; font-weight: bold; color: #1976d2;">
                                        ${(() => {
                                            const yearlyData = calculateYearlyTotal(property);
                                            return `ุงูุฅุฌูุงูู: ${yearlyData.total.toLocaleString()} ุฑูุงู (${yearlyData.count} ุฃูุณุงุท)`;
                                        })()}
                                    </div>
                                    <button type="button" onclick="addNewInstallment()" class="btn-add-installment">
                                        <i class="fas fa-plus"></i> ุฅุถุงูุฉ ูุณุท ุฌุฏูุฏ
                                    </button>
                                </div>
                                <div id="installmentsContainer" class="installments-container">
                                    ${renderInstallmentsForEdit(property)}
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-home"></i> ุชูุงุตูู ุงููุญุฏุฉ</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ูุณุงุญุฉ ุงููุญุฏุฉ (ูยฒ):</label>
                                    <input type="number" name="ุงููุณุงุญุฉ" value="${property['ุงููุณุงุญุฉ'] || ''}" step="0.01" placeholder="ูุณุงุญุฉ ุงููุญุฏุฉ ุจุงููุชุฑ ุงููุฑุจุน">
                                    <small class="field-note">ูุณุงุญุฉ ุงููุญุฏุฉ ุงููุนููุฉ (ูุฏ ุชุฎุชูู ุนู ูุณุงุญุฉ ุงูุตู)</small>
                                </div>
                                <div class="form-group">
                                    <label>ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก:</label>
                                    <input type="text" name="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก" value="${property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] || ''}" placeholder="ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุงูุงุฑุชูุงุน:</label>
                                    <input type="text" name="ุงูุงุฑุชูุงุน" value="${property['ุงูุงุฑุชูุงุน'] || ''}" placeholder="ุงุฑุชูุงุน ุงููุญุฏุฉ">
                                </div>
                                <div class="form-group">
                                    <label>ููุงุญุธุงุช ุงููุญุฏุฉ:</label>
                                    <input type="text" name="ููุงุญุธุงุช ุงููุญุฏุฉ" value="${property['ููุงุญุธุงุช ุงููุญุฏุฉ'] || ''}" placeholder="ุฃู ููุงุญุธุงุช ุฎุงุตุฉ ุจุงููุญุฏุฉ">
                                </div>
                            </div>
                        </div>

                        <div class="edit-section">
                            <h3><i class="fas fa-link"></i> ุฑุจุท ุงููุญุฏุงุช</h3>
                            <div class="units-linking-section">
                                <p class="section-description">ููููู ุฑุจุท ูุญุฏุงุช ุฅุถุงููุฉ ุจูุฐู ุงูุจุทุงูุฉ ูุชุฌููุนูุง ุชุญุช ุนูุฏ ูุงุญุฏ</p>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ุงููุญุฏุงุช ุงููุชุงุญุฉ ููุฑุจุท:</label>
                                        <div id="availableUnitsForLinking" class="units-linking-list">
                                            ${renderAvailableUnitsForLinking(propertyName, contractNumber, unitNumber)}
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุญุงููุงู:</label>
                                        <div id="linkedUnitsDisplay" class="linked-units-display">
                                            ${renderLinkedUnits(propertyName, contractNumber)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="originalContractNumber" value="${contractNumber || ''}">
                    <input type="hidden" name="originalPropertyName" value="${propertyName}">
                    <input type="hidden" name="originalUnitNumber" value="${unitNumber || ''}">

                    <div class="edit-modal-actions">
                        <div class="action-group primary-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> ุญูุธ ุงูุชุบููุฑุงุช
                            </button>
                            <button type="button" onclick="emptyUnit('${contractNumber || ''}', '${propertyName}', '${unitNumber || ''}')" class="btn-danger">
                                <i class="fas fa-broom"></i> ุฅูุฑุงุบ ุงููุญุฏุฉ
                            </button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">
                                <i class="fas fa-times"></i> ุฅูุบุงุก
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

// ุชูุณูู ุงูุชุงุฑูุฎ ููุฅุฏุฎุงู ูู ุญูู ุงูุชุงุฑูุฎ - ูุญุณู ูููุน ุชุบููุฑ ุงูุชูุงุฑูุฎ
function formatDateForInput(dateStr) {
    if (!dateStr) return '';

    // ุฅุฒุงูุฉ ุฃู ูุต ุฅุถุงูู (ูุซู ุงููุต ุงูุนุฑุจู)
    let datePart = dateStr.split(' ')[0];
    if (datePart.includes('(')) {
        datePart = datePart.split('(')[0].trim();
    }

    let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');

    if (parts.length !== 3) return '';

    let day, month, year;

    // ุชุญุฏูุฏ ุตูุบุฉ ุงูุชุงุฑูุฎ
    if (parts[0].length === 4) {
        // ุตูุบุฉ yyyy-mm-dd (already in correct format for input)
        year = parseInt(parts[0]);
        month = parseInt(parts[1]);
        day = parseInt(parts[2]);
    } else {
        // ุตูุบุฉ dd/mm/yyyy ุฃู dd-mm-yyyy
        day = parseInt(parts[0]);
        month = parseInt(parts[1]);
        year = parseInt(parts[2]);
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
    if (isNaN(year) || isNaN(month) || isNaN(day) ||
        year < 1900 || year > 2100 ||
        month < 1 || month > 12 ||
        day < 1 || day > 31) {
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ ูู formatDateForInput: ${dateStr}`);
        return '';
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ ุจุงุณุชุฎุฏุงู Date object (ุชุฌูุจ timezone issues)
    const testDate = new Date(year, month - 1, day, 12, 0, 0); // ุงุณุชุฎุฏุงู ููุชุตู ุงูููุงุฑ ูุชุฌูุจ timezone issues
    if (testDate.getFullYear() !== year || testDate.getMonth() !== (month - 1) || testDate.getDate() !== day) {
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุงูุญ ูู formatDateForInput: ${dateStr}`);
        return '';
    }

    // ุฅุฑุฌุงุน ุงูุชุงุฑูุฎ ุจุตูุบุฉ yyyy-mm-dd ููู HTML input
    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
}



// ุงูุชุญูู ูู ูุฌูุฏ ุชุบููุฑุงุช ูู ุญููู ูุนูููุงุช ุงูุตู
function checkDeedFieldChanges(originalProperty, updatedProperty, deedFields) {
    console.log(`๐ ูุญุต ุงูุชุบููุฑุงุช ูู ุญููู ูุนูููุงุช ุงูุตู...`);

    const changedFields = [];
    let hasChanges = false;

    deedFields.forEach(field => {
        const originalValue = originalProperty[field] || '';
        const updatedValue = updatedProperty[field] || '';

        // ููุงุฑูุฉ ุงูููู (ุชุฌุงูู ุงููุฑุงุบุงุช ุงูุฒุงุฆุฏุฉ)
        const originalTrimmed = String(originalValue).trim();
        const updatedTrimmed = String(updatedValue).trim();

        if (originalTrimmed !== updatedTrimmed) {
            hasChanges = true;
            changedFields.push({
                field: field,
                oldValue: originalTrimmed || 'ูุงุฑุบ',
                newValue: updatedTrimmed || 'ูุงุฑุบ'
            });

            console.log(`   โ๏ธ ${field}: "${originalTrimmed}" โ "${updatedTrimmed}"`);
        } else {
            console.log(`   โ ${field}: ูู ูุชุบูุฑ ("${originalTrimmed}")`);
        }
    });

    if (hasChanges) {
        console.log(`๐ ุชู ุงูุชุดุงู ${changedFields.length} ุชุบููุฑ ูู ูุนูููุงุช ุงูุตู`);
    } else {
        console.log(`โน๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ูู ูุนูููุงุช ุงูุตู`);
    }

    return {
        hasChanges: hasChanges,
        changedFields: changedFields,
        totalChanges: changedFields.length
    };
}

// ูุฒุงููุฉ ูุนูููุงุช ุงูุตู ุนุจุฑ ุฌููุน ูุญุฏุงุช ุงูุนูุงุฑ
async function syncDeedInfoAcrossUnits(propertyName, updatedProperty, deedFields) {
    console.log(`๐ ุจุฏุก ูุฒุงููุฉ ูุนูููุงุช ุงูุตู ููุนูุงุฑ "${propertyName}" ุนุจุฑ ุฌููุน ุงููุญุฏุงุช...`);

    // ุงูุจุญุซ ุนู ุฌููุน ุงููุญุฏุงุช ูู ููุณ ุงูุนูุงุฑ
    const relatedUnits = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);

    if (relatedUnits.length <= 1) {
        console.log(`โน๏ธ ุงูุนูุงุฑ "${propertyName}" ูุญุชูู ุนูู ูุญุฏุฉ ูุงุญุฏุฉ ููุทุ ูุง ุญุงุฌุฉ ูููุฒุงููุฉ`);
        return { updatedCount: 0, message: 'ูุญุฏุฉ ูุงุญุฏุฉ ููุท' };
    }

    console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${relatedUnits.length} ูุญุฏุฉ ูู ุงูุนูุงุฑ "${propertyName}"`);

    // ุชุญุฏูุฏ ุงูุญููู ุงูุชู ุชุบูุฑุช
    const changedFields = [];
    deedFields.forEach(field => {
        const newValue = updatedProperty[field];
        changedFields.push({
            field: field,
            newValue: newValue || 'ุบูุฑ ูุญุฏุฏ'
        });
    });

    console.log(`๐ ูุนูููุงุช ุงูุตู ุงูุฌุฏูุฏุฉ:`, changedFields);

    // ุชุญุฏูุซ ุฌููุน ุงููุญุฏุงุช ุงูุฃุฎุฑู ูุญููุงู
    let updatedCount = 0;
    const errors = [];

    relatedUnits.forEach((unit) => {
        try {
            const unitIndex = properties.findIndex(p =>
                p['ุงุณู ุงูุนูุงุฑ'] === unit['ุงุณู ุงูุนูุงุฑ'] &&
                p['ุฑูู  ุงููุญุฏุฉ '] === unit['ุฑูู  ุงููุญุฏุฉ ']
            );

            if (unitIndex !== -1) {
                // ุชุญุฏูุซ ูุนูููุงุช ุงูุตู ููุท (ุนุฏู ุชุฃุซูุฑ ุนูู ูุนูููุงุช ุงููุญุฏุฉ ุงูุฎุงุตุฉ)
                deedFields.forEach(field => {
                    const oldValue = properties[unitIndex][field];
                    const newValue = updatedProperty[field];

                    if (oldValue !== newValue) {
                        properties[unitIndex][field] = newValue;
                        console.log(`   โ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}: ${field} = "${newValue}"`);
                    }
                });

                // ุชุญุฏูุซ ูุนูููุงุช ุงูุชุญุฏูุซ
                properties[unitIndex]['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
                properties[unitIndex]['ููุน ุงูุชุญุฏูุซ'] = 'ูุฒุงููุฉ ูุนูููุงุช ุงูุตู';
                properties[unitIndex]['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = getCurrentUser();

                updatedCount++;
            }
        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}:`, error);
            errors.push({
                unitNumber: unit['ุฑูู  ุงููุญุฏุฉ '],
                error: error.message
            });
        }
    });

    console.log(`โ ุชู ุชุญุฏูุซ ${updatedCount} ูุญุฏุฉ ูุญููุงู`);

    // ูุฒุงููุฉ ูุน Supabase
    let supabaseSuccess = 0;
    let supabaseErrors = [];

    if (typeof savePropertyToSupabase === 'function') {
        console.log(`โ๏ธ ุจุฏุก ูุฒุงููุฉ ${updatedCount} ูุญุฏุฉ ูุน Supabase...`);

        try {
            // ูุฒุงููุฉ ูู ูุญุฏุฉ ุจุดูู ูุฑุฏู ูุถูุงู ุงููุฌุงุญ
            for (const unit of relatedUnits) {
                const unitIndex = properties.findIndex(p =>
                    p['ุงุณู ุงูุนูุงุฑ'] === unit['ุงุณู ุงูุนูุงุฑ'] &&
                    p['ุฑูู  ุงููุญุฏุฉ '] === unit['ุฑูู  ุงููุญุฏุฉ ']
                );

                if (unitIndex !== -1) {
                    const result = await savePropertyToSupabase(properties[unitIndex]);

                    if (result) {
                        supabaseSuccess++;
                        console.log(`โ ุชู ุญูุธ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ูู Supabase`);
                    } else {
                        console.error(`โ ูุดู ุญูุธ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']} ูู Supabase`);
                        supabaseErrors.push(`ูุดู ุญูุธ ุงููุญุฏุฉ ${unit['ุฑูู  ุงููุญุฏุฉ ']}`);
                    }

                    // ุชุฃุฎูุฑ ูุตูุฑ ุจูู ุงูุญูุธุงุช ูุชุฌูุจ ุฅุฑูุงู ุงูุฎุงุฏู
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }

            console.log(`โ ุชู ุญูุธ ${supabaseSuccess} ูู ${relatedUnits.length} ูุญุฏุฉ ูู Supabase`);

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ูุฒุงููุฉ ุงููุญุฏุงุช ูุน Supabase:`, error);
            supabaseErrors.push(error.message);
        }
    } else {
        console.warn(`โ๏ธ ุฏุงูุฉ savePropertyToSupabase ุบูุฑ ูุชููุฑุฉ`);
    }

    return {
        updatedCount: updatedCount,
        supabaseSuccess: supabaseSuccess,
        errors: errors,
        supabaseErrors: supabaseErrors,
        changedFields: changedFields,
        propertyName: propertyName
    };
}

// ุญูุธ ุชุนุฏููุงุช ุงูุนูุงุฑ
async function savePropertyEdit(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);

    // ุงูุชุญูู ูู ููุน ุงูุนูููุฉ
    const operationType = formData.get('operationType');
    if (!operationType) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุนูููุฉ ูุจู ุงูุญูุธ');
        return;
    }

    // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงูุฃุตููุฉ
    const originalContractNumber = formData.get('originalContractNumber');
    const originalPropertyName = formData.get('originalPropertyName');
    const originalUnitNumber = formData.get('originalUnitNumber');

    // ุงูุจุญุซ ุนู ุงูุนูุงุฑ ุงููุทููุจ ุชุญุฏูุซู ูุน ุชุณุฌูู ููุตู
    let propertyIndex = -1;
    let searchMethod = '';

    console.log('๐ ุจุฏุก ุงูุจุญุซ ุนู ุงููุญุฏุฉ ููุชุญุฏูุซ ูู savePropertyEdit:', {
        originalContractNumber,
        originalPropertyName,
        originalUnitNumber
    });

    if (originalContractNumber && originalPropertyName) {
        searchMethod = 'contract_and_property';
        propertyIndex = properties.findIndex(p =>
            p['ุฑูู ุงูุนูุฏ'] === originalContractNumber && p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );
        console.log(`๐ ุงูุจุญุซ ุจุงูุนูุฏ ูุงูุนูุงุฑ: ููุฑุณ=${propertyIndex}`);
    }

    if (propertyIndex === -1 && originalUnitNumber && originalPropertyName) {
        searchMethod = 'unit_and_property';
        propertyIndex = properties.findIndex(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === originalUnitNumber && p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );
        console.log(`๐ ุงูุจุญุซ ุจุงููุญุฏุฉ ูุงูุนูุงุฑ: ููุฑุณ=${propertyIndex}`);
    }

    // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉุ ุฌุฑุจ ุจุญุซ ุฃูุณุน
    if (propertyIndex === -1 && originalUnitNumber) {
        searchMethod = 'unit_only';
        propertyIndex = properties.findIndex(p => p['ุฑูู  ุงููุญุฏุฉ '] === originalUnitNumber);
        console.log(`๐ ุงูุจุญุซ ุจุงููุญุฏุฉ ููุท: ููุฑุณ=${propertyIndex}`);

        if (propertyIndex !== -1) {
            const foundProperty = properties[propertyIndex];
            console.log(`โ๏ธ ุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุจุงูุฑูู ููุทุ ููู ุงูุนูุงุฑ ูุฎุชูู: "${foundProperty['ุงุณู ุงูุนูุงุฑ']}" ุจุฏูุงู ูู "${originalPropertyName}"`);
        }
    }

    if (propertyIndex === -1) {
        console.error('โ ูุดู ูู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ููุชุญุฏูุซ ุจุฌููุน ุทุฑู ุงูุจุญุซ');
        console.log('๐ ุฌููุน ุงููุญุฏุงุช ุงููุชุงุญุฉ:');
        properties.forEach((p, index) => {
            console.log(`   ${index}: ูุญุฏุฉ="${p['ุฑูู  ุงููุญุฏุฉ ']}", ุนูุงุฑ="${p['ุงุณู ุงูุนูุงุฑ']}", ุนูุฏ="${p['ุฑูู ุงูุนูุฏ']}"`);
        });

        alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ุงููุทููุจ ุชุญุฏูุซู\n\n' +
              'ูุฐุง ูุฏ ูุคุฏู ุฅูู ุฅูุดุงุก ูุญุฏุฉ ุฌุฏูุฏุฉ ุจุฏูุงู ูู ุชุนุฏูู ุงูููุฌูุฏุฉ!\n\n' +
              'ุชูุงุตูู ุงูุจุญุซ:\n' +
              `- ุฑูู ุงูุนูุฏ ุงูุฃุตูู: ${originalContractNumber || 'ุบูุฑ ูุญุฏุฏ'}\n` +
              `- ุงุณู ุงูุนูุงุฑ ุงูุฃุตูู: ${originalPropertyName || 'ุบูุฑ ูุญุฏุฏ'}\n` +
              `- ุฑูู ุงููุญุฏุฉ ุงูุฃุตูู: ${originalUnitNumber || 'ุบูุฑ ูุญุฏุฏ'}\n\n` +
              'ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
        return;
    }

    console.log(`โ ุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ููุชุญุฏูุซ ุจุทุฑููุฉ: ${searchMethod}, ููุฑุณ: ${propertyIndex}`);

    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุชูุฑุงุฑ ูุจู ุงูุชุญุฏูุซ
    const preUpdateDuplicateCheck = checkForDuplicateUnits(originalUnitNumber, originalPropertyName);
    if (preUpdateDuplicateCheck.hasDuplicates) {
        console.warn(`โ๏ธ ุชู ุงูุชุดุงู ${preUpdateDuplicateCheck.count} ูุณุฎุฉ ูู ุงููุญุฏุฉ ูุจู ุงูุชุญุฏูุซ`);
        // ุฅุตูุงุญ ุงูุชูุฑุงุฑ ูุจู ุงููุชุงุจุนุฉ
        fixDuplicateUnits(originalUnitNumber, originalPropertyName);
    }

    // ุญูุธ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ููููุงุฑูุฉ
    const originalData = { ...properties[propertyIndex] };

    // ุชุญุฏูุซ ุงูุจูุงูุงุช
    const updatedProperty = { ...properties[propertyIndex] };

    // ุชุญุฏูุซ ุงูุญููู ูู ุงููููุฐุฌ
    console.log(`๐ ุจุฏุก ูุนุงูุฌุฉ ุญููู ุงููููุฐุฌ...`);

    // ุชุนุฑูู ุญููู ูุนูููุงุช ุงูุตู
    const deedFields = ['ุฑูู ุงูุตู', 'ูุณุงุญุฉุงูุตู', 'ุงูุณุฌู ุงูุนููู ', 'ุงููุงูู', 'ูููุน ุงูุนูุงุฑ'];

    for (let [key, value] of formData.entries()) {
        if (key.startsWith('original')) continue; // ุชุฌุงูู ุงูุญููู ุงููุฎููุฉ

        // ุชุณุฌูู ุฎุงุต ูุญููู ูุนูููุงุช ุงูุตู
        if (deedFields.includes(key)) {
            console.log(`๐ ูุนุงูุฌุฉ ุญูู ูุนูููุงุช ุงูุตู: ${key}`);
            console.log(`   ุงููููุฉ ุงูุฃุตููุฉ: "${originalData[key]}"`);
            console.log(`   ุงููููุฉ ุงูุฌุฏูุฏุฉ: "${value}"`);
        }

        // ุชุญููู ุงูุชูุงุฑูุฎ ุฅูู ุงูุตูุบุฉ ุงููุทููุจุฉ - ูุนุงูุฌุฉ ูุญุณูุฉ ูููุน ุงูุชูุงุฑูุฎ ุงูุนุดูุงุฆูุฉ
        if (key.includes('ุชุงุฑูุฎ') && value && !key.includes('ุงููุณุท')) {
            // ุชุญููู ูู yyyy-mm-dd ุฅูู dd/mm/yyyy ููุชูุงุฑูุฎ ุงูุนุงุฏูุฉ ููุท
            const dateParts = value.split('-');
            if (dateParts.length === 3 && dateParts[0].length === 4) {
                // ุชุฃูุฏ ูู ุฃู ุงูุชุงุฑูุฎ ุตุญูุญ ูุจู ุงูุชุญููู
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);

                // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // ุงูุชุญูู ุงูุฅุถุงูู ุจุงุณุชุฎุฏุงู Date object ูุชุฌูุจ ุชูุงุฑูุฎ ูุซู 31 ูุจุฑุงูุฑ
                    const testDate = new Date(year, month - 1, day, 12, 0, 0);
                    if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                        value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                        console.log(`โ ุชู ุชุญููู ุงูุชุงุฑูุฎ ุจูุฌุงุญ: ${key} = ${value}`);
                    } else {
                        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุงูุญ ุชู ุชุฌุงููู: ${value} ููุญูู: ${key}`);
                        value = null;
                    }
                } else {
                    console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ ุชู ุชุฌุงููู: ${value} ููุญูู: ${key}`);
                    value = null; // ุฅุฒุงูุฉ ุงูุชุงุฑูุฎ ุบูุฑ ุงูุตุญูุญ
                }
            }
        }

        // ูุนุงูุฌุฉ ุฎุงุตุฉ ูุชูุงุฑูุฎ ุงูุฃูุณุงุท - ุงุญุชูุธ ุจุงูุตูุบุฉ ุงูุฃุตููุฉ
        if (key.includes('ุงููุณุท') && key.includes('ุชุงุฑูุฎ') && value) {
            // ุฅุฐุง ูุงูุช ุจุตูุบุฉ yyyy-mm-ddุ ุญูููุง ุฅูู dd/mm/yyyy
            const dateParts = value.split('-');
            if (dateParts.length === 3 && dateParts[0].length === 4) {
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);

                // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // ุงูุชุญูู ุงูุฅุถุงูู ุจุงุณุชุฎุฏุงู Date object
                    const testDate = new Date(year, month - 1, day, 12, 0, 0);
                    if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                        value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                        console.log(`โ ุชู ุชุญููู ุชุงุฑูุฎ ุงููุณุท ุจูุฌุงุญ: ${key} = ${value}`);
                    } else {
                        console.warn(`ุชุงุฑูุฎ ูุณุท ุบูุฑ ุตุงูุญ ุชู ุชุฌุงููู: ${value} ููุญูู: ${key}`);
                        value = null;
                    }
                } else {
                    console.warn(`ุชุงุฑูุฎ ูุณุท ุบูุฑ ุตุญูุญ ุชู ุชุฌุงููู: ${value} ููุญูู: ${key}`);
                    value = null;
                }
            }
        }

        // ุชุญููู ุงูุฃุฑูุงู
        if (['ุงููุณุงุญุฉ', 'ูููุฉ  ุงูุงูุฌุงุฑ ', 'ุงูุงุฌูุงูู', 'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'].includes(key) && value) {
            value = parseFloat(value) || 0;
        }

        // ุชุญุฏูุซ ุฎุงุต ูุนุฏุฏ ุงูุฃูุณุงุท ุงููุชุจููุฉ
        if (key === 'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ') {
            value = parseInt(value) || 0;
        }

        // ูุนุงูุฌุฉ ูุญุณูุฉ ููุญููู - ุงุณุชุจุฏุงู ุงููุฏูู ุจุงูุฌุฏูุฏ
        if (value === '' || value === null || value === undefined) {
            // ููุญููู ุงููุตูุฉุ ุงุญูุธ ุงููููุฉ ุงููุงุฑุบุฉ (ุงุณุชุจุฏุงู ุงููุฏูู ุจูุงุฑุบ)
            if (typeof updatedProperty[key] === 'string' || key.includes('ุฑูู') || key.includes('ุงุณู') || key.includes('ูููุน') || key.includes('ุงููุงูู') || key.includes('ุงูุณุฌู')) {
                updatedProperty[key] = value || '';
                if (deedFields.includes(key)) {
                    console.log(`   ๐ ุงุณุชุจุฏุงู ุงููููุฉ ุงููุฏููุฉ "${originalData[key]}" ุจุงููููุฉ ุงูุฌุฏูุฏุฉ "${value || ''}"`);
                }
            } else {
                // ููุญููู ุงูุฑูููุฉุ ุงุณุชุฎุฏู null
                updatedProperty[key] = null;
            }
        } else {
            // ุฅุฐุง ูุงูุช ููุงู ูููุฉุ ุงุญูุธูุง (ุงุณุชุจุฏุงู ุงููุฏูู ุจุงูุฌุฏูุฏ)
            updatedProperty[key] = value;
            if (deedFields.includes(key)) {
                console.log(`   โ ุงุณุชุจุฏุงู ุงููููุฉ ุงููุฏููุฉ "${originalData[key]}" ุจุงููููุฉ ุงูุฌุฏูุฏุฉ "${value}"`);
            }
        }

        // ุชุณุฌูู ุฅุถุงูู ูุญููู ูุนูููุงุช ุงูุตู
        if (deedFields.includes(key)) {
            console.log(`   ุงููููุฉ ุงูููุงุฆูุฉ ุงููุญููุธุฉ: "${updatedProperty[key]}"`);
        }
    }

    // ุชุญุฏูุซ ุนุฏุฏ ุงูุฃูุณุงุท ุจูุงุกู ุนูู ุงูุฃูุณุงุท ุงูููุฌูุฏุฉ ูุนููุงู
    let actualInstallmentCount = 0;
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        if (updatedProperty[dateKey] || updatedProperty[amountKey]) {
            actualInstallmentCount = i;
        }
    }

    // ุชุญุฏูุซ ุนุฏุฏ ุงูุฃูุณุงุท ูู ุงูุจูุงูุงุช
    updatedProperty['ุนุฏุฏ ุงูุงูุณุงุท'] = actualInstallmentCount;

    // ุฅุถุงูุฉ ูุนูููุงุช ุงูุชุญุฏูุซ
    updatedProperty['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
    updatedProperty['ููุน ุงูุชุญุฏูุซ'] = operationType || 'ุชุญุฑูุฑ';
    updatedProperty['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = getCurrentUser();

    console.log(`โ ุชู ุชุญุฏูุซ ุนุฏุฏ ุงูุฃูุณุงุท ุฅูู: ${actualInstallmentCount}`);

    // ุฅุฐุง ุชู ุชุญุฏูุซ ุฑูู ุงูุนูุฏุ ุชุญุฏูุซ ุฌููุน ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ
    const newContractNumber = formData.get('ุฑูู ุงูุนูุฏ');
    if (originalContractNumber && newContractNumber && originalContractNumber !== newContractNumber) {
        // ุชุญุฏูุซ ุฌููุน ุงููุญุฏุงุช ุงูุชู ุชุญูู ููุณ ุฑูู ุงูุนูุฏ ุงููุฏูู
        properties.forEach((property, index) => {
            if (property['ุฑูู ุงูุนูุฏ'] === originalContractNumber && property['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName) {
                properties[index] = { ...properties[index], 'ุฑูู ุงูุนูุฏ': newContractNumber };
            }
        });
    }

    // โ ูุนุงูุฌุฉ ุฎุงุตุฉ ูุชุนุฏูู ุฑูู ุงููุญุฏุฉ - ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ูุฅูุดุงุก ุฌุฏูุฏุฉ
    const newUnitNumber = formData.get('ุฑูู  ุงููุญุฏุฉ ');
    if (originalUnitNumber && newUnitNumber && originalUnitNumber !== newUnitNumber) {
        console.log(`๐ ุชู ุชุนุฏูู ุฑูู ุงููุญุฏุฉ ูู "${originalUnitNumber}" ุฅูู "${newUnitNumber}"`);

        // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูุญุฏุฉ ุฃุฎุฑู ุจููุณ ุงูุฑูู ุงูุฌุฏูุฏ
        const existingUnitWithNewNumber = properties.find(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName &&
            properties.indexOf(p) !== propertyIndex
        );

        if (existingUnitWithNewNumber) {
            alert(`โ ุฎุทุฃ: ููุฌุฏ ูุญุฏุฉ ุฃุฎุฑู ุจุฑูู "${newUnitNumber}" ูู ููุณ ุงูุนูุงุฑ!\n\nูุฑุฌู ุงุฎุชูุงุฑ ุฑูู ูุญุฏุฉ ูุฎุชูู.`);
            return;
        }

        // ููุฌ ุฌุฏูุฏ: ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ูู Supabase ุฃููุงูุ ุซู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
        console.log(`๐ ุชุนุฏูู ุฑูู ุงููุญุฏุฉ: "${originalUnitNumber}" โ "${newUnitNumber}"`);

        // 1. ุญูุธ ุจูุงูุงุช ุงููุญุฏุฉ ุงููุฏููุฉ ููุญุฐู ูู Supabase
        const oldUnitDataForSupabase = { ...properties[propertyIndex] };

        // 2. ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ูู Supabase ุฃููุงู
        if (typeof deletePropertyFromSupabase === 'function') {
            try {
                console.log(`โ๏ธ ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ุจุฑูู "${originalUnitNumber}" ูู Supabase...`);
                const deleteResult = await deletePropertyFromSupabase(oldUnitDataForSupabase);
                if (deleteResult && deleteResult.success) {
                    console.log(`โ ุชู ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ูู Supabase ุจูุฌุงุญ`);
                } else {
                    console.warn(`โ๏ธ ุชุญุฐูุฑ: ${deleteResult ? deleteResult.message : 'ูุดู ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ูู Supabase'}`);
                }
            } catch (error) {
                console.error(`โ ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ูู Supabase:`, error);
            }
        }

        // 3. ุชุญุฏูุซ ุงููุญุฏุฉ ุงููุญููุฉ ุจุฑูู ุงููุญุฏุฉ ุงูุฌุฏูุฏ
        const newUnitData = { ...updatedProperty, 'ุฑูู  ุงููุญุฏุฉ ': newUnitNumber };
        properties[propertyIndex] = newUnitData;

        console.log(`โ ุชู ุงุณุชุจุฏุงู ุงููุญุฏุฉ "${originalUnitNumber}" ุจู "${newUnitNumber}" ุจูุฌุงุญ`);

        console.log(`โ ุชู ุชุญุฏูุซ ุฑูู ุงููุญุฏุฉ ุจูุฌุงุญ: "${originalUnitNumber}" โ "${newUnitNumber}"`);

        // ุชุญุฏูุซ updatedProperty ุจุฑูู ุงููุญุฏุฉ ุงูุฌุฏูุฏ ูุถูุงู ุงูุงุชุณุงู
        updatedProperty['ุฑูู  ุงููุญุฏุฉ '] = newUnitNumber;
    } else {
        // ุญูุธ ุงูุชุญุฏูุซ ุงูุนุงุฏู (ุจุฏูู ุชุนุฏูู ุฑูู ุงููุญุฏุฉ)
        properties[propertyIndex] = updatedProperty;
    }

    // ุชุณุฌูู ุชูุตููู ูุญููู ูุนูููุงุช ุงูุตู ุจุนุฏ ุงูุญูุธ
    console.log(`๐ ุญุงูุฉ ุญููู ูุนูููุงุช ุงูุตู ุจุนุฏ ุงูุญูุธ:`);
    deedFields.forEach(field => {
        console.log(`   ${field}: "${properties[propertyIndex][field]}"`);
    });

    // ุงูุชุญูู ูู ูุฌูุฏ ุชุบููุฑุงุช ูู ูุนูููุงุช ุงูุตู ูุจู ุงููุฒุงููุฉ
    const deedChanges = checkDeedFieldChanges(originalData, updatedProperty, deedFields);

    if (deedChanges.hasChanges) {
        console.log(`๐ ุชู ุงูุชุดุงู ุชุบููุฑุงุช ูู ูุนูููุงุช ุงูุตูุ ุจุฏุก ุงููุฒุงููุฉ...`);
        console.log(`๐ ุงูุญููู ุงููุชุบูุฑุฉ:`, deedChanges.changedFields);

        // ูุฒุงููุฉ ูุนูููุงุช ุงูุตู ูุน ุฌููุน ูุญุฏุงุช ุงูุนูุงุฑ
        const syncResult = await syncDeedInfoAcrossUnits(originalPropertyName, updatedProperty, deedFields);

        // ุญูุธ ูุชูุฌุฉ ุงููุฒุงููุฉ ูุนุฑุถูุง ูู ุฑุณุงูุฉ ุงููุฌุงุญ
        window.lastSyncResult = syncResult;
    } else {
        console.log(`โน๏ธ ูู ูุชู ุชุนุฏูู ูุนูููุงุช ุงูุตูุ ุชุฎุทู ุงููุฒุงููุฉ`);
        // ูุณุญ ุฃู ูุชูุฌุฉ ูุฒุงููุฉ ุณุงุจูุฉ
        window.lastSyncResult = null;
    }

    // ุญุณุงุจ ุงูุฅุฌูุงูู ุงูุฌุฏูุฏ ุจูุงุกู ุนูู ุงูุฃูุณุงุท
    const yearlyData = calculateYearlyTotal(updatedProperty);
    if (yearlyData.count > 0) {
        updatedProperty['ุงูุงุฌูุงูู'] = yearlyData.total;
        properties[propertyIndex] = updatedProperty;
    }



    // ุฅุบูุงู ุงููุงูุฐุฉ ุฃููุงู
    closeModal();

    // ุฅุธูุงุฑ ุดุฑูุท ุงูุชูุฏู ุฃุซูุงุก ุงูุญูุธ
    showProgressModal('ุฌุงุฑู ุญูุธ ุงูุชุบููุฑุงุช...', async function(updateProgress) {
        try {
            // ุงููุฑุญูุฉ 1: ุจุฏุก ุงูุญูุธ
            updateProgress(10, 'ุจุฏุก ุนูููุฉ ุงูุญูุธ...');
            await new Promise(resolve => setTimeout(resolve, 300));

            // ุงููุฑุญูุฉ 2: ุญูุธ ูุญูู
            updateProgress(25, 'ุญูุธ ุงูุจูุงูุงุช ูุญููุงู...');
            saveDataLocally();
            await new Promise(resolve => setTimeout(resolve, 400));

            // ุงููุฑุญูุฉ 3: ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุญุงูุงุช
            updateProgress(40, 'ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุญุงูุงุช...');
            initializeApp();
            await new Promise(resolve => setTimeout(resolve, 300));

            // ุงููุฑุญูุฉ 4: ุญูุธ ุณุญุงุจู
            updateProgress(55, 'ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ...');
            await new Promise(resolve => setTimeout(resolve, 500));

            let supabaseSuccess = false;
            if (typeof savePropertyToSupabase === 'function') {
                try {
                    updateProgress(70, 'ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ...');
                    const result = await savePropertyToSupabase(updatedProperty);
                    supabaseSuccess = !!result;
                    await new Promise(resolve => setTimeout(resolve, 600));
                } catch (error) {
                    console.error('ุฎุทุฃ ูู ุญูุธ Supabase:', error);
                }
            }

            // ุงููุฑุญูุฉ 5: ูุฒุงููุฉ (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
            if (window.lastSyncResult && window.lastSyncResult.updatedCount > 0) {
                updateProgress(85, `ูุฒุงููุฉ ูุนูููุงุช ุงูุตู ูู ${window.lastSyncResult.updatedCount} ูุญุฏุฉ...`);
                await new Promise(resolve => setTimeout(resolve, 700));

                updateProgress(95, 'ุญูุธ ุงููุญุฏุงุช ุงููุฒุงููุฉ ูู ุงูุณุญุงุจุฉ...');
                await new Promise(resolve => setTimeout(resolve, 400));
            } else {
                updateProgress(90, 'ุงูุชุญูู ูู ุงููุฒุงููุฉ...');
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            updateProgress(100, 'ุชู ุงูุญูุธ ุจูุฌุงุญ!');
            await new Promise(resolve => setTimeout(resolve, 400));

            // ุจูุงุก ุฑุณุงูุฉ ุงููุฌุงุญ
            let message = 'ุชู ุญูุธ ุงูุชุบููุฑุงุช ุจูุฌุงุญ!';

            // ุฅุถุงูุฉ ูุนูููุงุช ูุฒุงููุฉ ูุนูููุงุช ุงูุตู
            if (window.lastSyncResult && window.lastSyncResult.updatedCount > 0) {
                message += `\n๐ ุชู ุชุญุฏูุซ ูุนูููุงุช ุงูุตู ูู ${window.lastSyncResult.updatedCount} ูุญุฏุฉ`;

                if (window.lastSyncResult.changedFields && window.lastSyncResult.changedFields.length > 0) {
                    message += '\n๐ ูุนูููุงุช ุงูุตู ุงููุญุฏุซุฉ:';
                    window.lastSyncResult.changedFields.forEach(change => {
                        message += `\nโข ${change.field}: ${change.newValue}`;
                    });
                }

                if (window.lastSyncResult.supabaseSuccess > 0) {
                    message += `\nโ๏ธ ุชู ุญูุธ ${window.lastSyncResult.supabaseSuccess} ูุญุฏุฉ ูู ุงูุณุญุงุจุฉ`;
                }

                if (window.lastSyncResult.errors && window.lastSyncResult.errors.length > 0) {
                    message += `\nโ๏ธ ุชุญุฐูุฑ: ูุดู ุชุญุฏูุซ ${window.lastSyncResult.errors.length} ูุญุฏุฉ`;
                }
            } else if (window.lastSyncResult === null) {
                message += '\n๐ก ุชู ุญูุธ ุชุนุฏููุงุช ุงููุญุฏุฉ ููุท (ูู ุชุชุบูุฑ ูุนูููุงุช ุงูุตู)';
            }

            // ุฅุถุงูุฉ ูุนูููุงุช ุญูุธ Supabase
            if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                if (supabaseSuccess) {
                    message += '\nโ ุชู ุญูุธ ุงูุชุบููุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ';
                } else {
                    message += '\nโ๏ธ ุชุญุฐูุฑ: ูุดู ุญูุธ ุงูุชุบููุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ';
                }
            }

            return { success: true, message: message };
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุงูุญูุธ:', error);
            return { success: false, message: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชุบููุฑุงุช' };
        }
    }, function(result) {
        // ุจุนุฏ ุงูุชูุงุก ุดุฑูุท ุงูุชูุฏูุ ุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
        if (result && result.success) {
            if (typeof showSuccessMessageWithCallback === 'function') {
                showSuccessMessageWithCallback('ุชู ุญูุธ ุงูุชุบููุฑุงุช ุจูุฌุงุญ!', result.message, function() {
                    // ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุนุฏ ุฃู ูุถุบุท ุงููุณุชุฎุฏู "ููุงูู"
                    console.log('๐ ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุนุฏ ุชุฃููุฏ ุงููุณุชุฎุฏู...');
                    renderData();
                    updateTotalStats();

                    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช ุฅุฐุง ูุฒู ุงูุฃูุฑ
                    if (typeof recalculateAllTotals === 'function') {
                        recalculateAllTotals();
                    }

                    // ูุณุญ ูุชูุฌุฉ ุงููุฒุงููุฉ
                    window.lastSyncResult = null;
                });
            } else {
                // fallback ุฅูู alert ุนุงุฏู
                alert(result.message);

                // ุชุญุฏูุซ ุงููุงุฌูุฉ
                console.log('๐ ุชุญุฏูุซ ุงููุงุฌูุฉ...');
                renderData();
                updateTotalStats();

                if (typeof recalculateAllTotals === 'function') {
                    recalculateAllTotals();
                }

                window.lastSyncResult = null;
            }
        } else {
            const errorMessage = result ? result.message : 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชุบููุฑุงุช';
            if (typeof showErrorMessage === 'function') {
                showErrorMessage('ุฎุทุฃ ูู ุงูุญูุธ', errorMessage);
            } else {
                alert(errorMessage);
            }
        }
    });

    // ุฅุถุงูุฉ ุณุฌู ุงูุชุชุจุน
    try {
        const changes = compareDataAndCreateChanges(originalData, updatedProperty);

        let additionalInfo = {
            originalData: originalData,
            newData: updatedProperty
        };

        // ูุนูููุงุช ุฅุถุงููุฉ ุญุณุจ ููุน ุงูุนูููุฉ
        if (operationType === OPERATION_TYPES.NEW_CLIENT) {
            additionalInfo.previousTenant = originalData['ุงุณู ุงููุณุชุฃุฌุฑ'];
            additionalInfo.newTenant = updatedProperty['ุงุณู ุงููุณุชุฃุฌุฑ'];
        } else if (operationType === OPERATION_TYPES.EMPTY_UNIT) {
            additionalInfo.previousTenant = originalData['ุงุณู ุงููุณุชุฃุฌุฑ'];
            additionalInfo.reason = 'ุฅูุฑุงุบ ูุญุฏุฉ';
        } else if (operationType === OPERATION_TYPES.RENEW_CONTRACT) {
            additionalInfo.previousTenant = originalData['ุงุณู ุงููุณุชุฃุฌุฑ'];
            additionalInfo.newTenant = updatedProperty['ุงุณู ุงููุณุชุฃุฌุฑ'];
        }

        await addChangeLog(operationType, updatedProperty, changes, additionalInfo);
        console.log('๐ ุชู ุฅุถุงูุฉ ุณุฌู ุงูุชุชุจุน ููุนูููุฉ:', operationType);
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุณุฌู ุงูุชุชุจุน:', error);
    }
}

// ==================== ูุธุงุฆู ูุณุงุนุฏุฉ ุฅุถุงููุฉ ====================

// ุชุญุฑูุฑ ุนูุงุฑ ูู ูุงุฆูุฉ ุงูุนูุงุฑุงุช
function editProperty(propertyName) {
    // ุงูุจุญุซ ุนู ุฃูู ุนูุงุฑ ุจูุฐุง ุงูุงุณู
    const property = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    if (!property) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ');
        return;
    }

    showCardEditModal(property['ุฑูู ุงูุนูุฏ'] || '', propertyName, property['ุฑูู  ุงููุญุฏุฉ '] || '');
}

// ุนุฑุถ ูุญุฏุงุช ุงูุนูุงุฑ
function viewPropertyUnits(propertyName) {
    const propertyUnits = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);

    if (propertyUnits.length === 0) {
        alert('ูุง ุชูุฌุฏ ูุญุฏุงุช ูู ูุฐุง ุงูุนูุงุฑ');
        return;
    }

    let html = `
    <div class="modal-overlay" style="display:flex;">
        <div class="modal-box property-units-modal">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <div class="units-modal-header">
                <h2><i class="fas fa-home"></i> ูุญุฏุงุช ุงูุนูุงุฑ: ${propertyName}</h2>
                <p>ุฅุฌูุงูู ุงููุญุฏุงุช: ${propertyUnits.length}</p>
            </div>
            <div class="units-modal-content">
                <div class="units-grid">
                    ${propertyUnits.map(unit => {
                        const status = calculateStatus(unit);
                        let statusClass = '';
                        if (status.final === 'ุฌุงุฑู') statusClass = 'unit-active';
                        else if (status.final === 'ููุชูู') statusClass = 'unit-expired';
                        else if (status.final === 'ุนูู ูุดู') statusClass = 'unit-pending';
                        else if (status.final === 'ูุงุฑุบ') statusClass = 'unit-empty';

                        return `
                        <div class="unit-card ${statusClass}">
                            <div class="unit-header">
                                <h4>${unit['ุฑูู  ุงููุญุฏุฉ '] || 'ุบูุฑ ูุญุฏุฏ'}</h4>
                                <span class="unit-status">${status.final || 'ุบูุฑ ูุญุฏุฏ'}</span>
                            </div>
                            <div class="unit-details">
                                <p><strong>ุงููุณุชุฃุฌุฑ:</strong> ${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || 'ูุงุฑุบ'}</p>
                                <p><strong>ุงููุณุงุญุฉ:</strong> ${unit['ุงููุณุงุญุฉ'] ? unit['ุงููุณุงุญุฉ'] + ' ูยฒ' : 'ุบูุฑ ูุญุฏุฏ'}</p>
                                <p><strong>ุฑูู ุงูุนูุฏ:</strong> ${unit['ุฑูู ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</p>
                                <p><strong>ุงูุฅูุฌุงุฑ:</strong> ${unit['ูููุฉ  ุงูุงูุฌุงุฑ '] ? parseFloat(unit['ูููุฉ  ุงูุงูุฌุงุฑ ']).toLocaleString() + ' ุฑูุงู' : 'ุบูุฑ ูุญุฏุฏ'}</p>
                            </div>
                            <div class="unit-actions">
                                <button onclick="showCardEditModal('${unit['ุฑูู ุงูุนูุฏ'] || ''}', '${propertyName}', '${unit['ุฑูู  ุงููุญุฏุฉ '] || ''}')" class="btn-edit">
                                    <i class="fas fa-edit"></i> ุชุญุฑูุฑ
                                </button>
                                <button onclick="showUnitDetails('${unit['ุฑูู  ุงููุญุฏุฉ ']}', '${propertyName}', '${unit['ุฑูู ุงูุนูุฏ'] || ''}')" class="btn-view">
                                    <i class="fas fa-eye"></i> ุนุฑุถ
                                </button>
                                <button onclick="deleteUnit('${unit['ุฑูู  ุงููุญุฏุฉ ']}', '${propertyName}')" class="btn-delete">
                                    <i class="fas fa-trash"></i> ุญุฐู
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    // ุฅุถุงูุฉ ุญุฏุซ ุฅุบูุงู ููููุฏุงู
    document.querySelector('.modal-overlay:last-child').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

// ==================== ูุธุงุฆู ุฑุจุท ุงููุญุฏุงุช ====================

// ุนุฑุถ ุงููุญุฏุงุช ุงููุชุงุญุฉ ููุฑุจุท
function renderAvailableUnitsForLinking(propertyName, currentContractNumber, currentUnitNumber) {
    // ุงูุญุตูู ุนูู ุงููุญุฏุงุช ุงููุงุฑุบุฉ ุฃู ุบูุฑ ุงููุฑุชุจุทุฉ ุจุนูุฏ ูู ููุณ ุงูุนูุงุฑ
    const availableUnits = properties.filter(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName &&
        p['ุฑูู  ุงููุญุฏุฉ '] !== currentUnitNumber &&
        (!p['ุฑูู ุงูุนูุฏ'] || p['ุฑูู ุงูุนูุฏ'] !== currentContractNumber) &&
        (!p['ุงุณู ุงููุณุชุฃุฌุฑ'] || p['ุงุณู ุงููุณุชุฃุฌุฑ'].trim() === '')
    );

    if (availableUnits.length === 0) {
        return '<p class="no-units">ูุง ุชูุฌุฏ ูุญุฏุงุช ูุชุงุญุฉ ููุฑุจุท</p>';
    }

    return availableUnits.map(unit => `
        <label class="unit-linking-item">
            <input type="checkbox" value="${unit['ุฑูู  ุงููุญุฏุฉ ']}" name="linkingUnits" onchange="toggleUnitLinking('${unit['ุฑูู  ุงููุญุฏุฉ ']}', '${propertyName}', '${currentContractNumber}')">
            <div class="unit-info">
                <span class="unit-number">${unit['ุฑูู  ุงููุญุฏุฉ ']}</span>
                <span class="unit-details">${unit['ุงููุณุงุญุฉ'] ? unit['ุงููุณุงุญุฉ'] + ' ูยฒ' : 'ุบูุฑ ูุญุฏุฏ'}</span>
            </div>
        </label>
    `).join('');
}

// ุนุฑุถ ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุญุงููุงู
function renderLinkedUnits(propertyName, contractNumber) {
    if (!contractNumber) {
        return '<p class="no-units">ูุง ุชูุฌุฏ ูุญุฏุงุช ูุฑุชุจุทุฉ</p>';
    }

    const linkedUnits = properties.filter(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName &&
        p['ุฑูู ุงูุนูุฏ'] === contractNumber
    );

    if (linkedUnits.length <= 1) {
        return '<p class="no-units">ูุง ุชูุฌุฏ ูุญุฏุงุช ูุฑุชุจุทุฉ ุฅุถุงููุฉ</p>';
    }

    return linkedUnits.map(unit => `
        <div class="linked-unit-item">
            <span class="unit-number">${unit['ุฑูู  ุงููุญุฏุฉ ']}</span>
            <span class="unit-details">${unit['ุงููุณุงุญุฉ'] ? unit['ุงููุณุงุญุฉ'] + ' ูยฒ' : 'ุบูุฑ ูุญุฏุฏ'}</span>
            <button type="button" onclick="unlinkUnit('${unit['ุฑูู  ุงููุญุฏุฉ ']}', '${propertyName}', '${contractNumber}')" class="btn-unlink">
                <i class="fas fa-unlink"></i> ูุตู
            </button>
        </div>
    `).join('');
}

// ุชุจุฏูู ุฑุจุท ุงููุญุฏุฉ
function toggleUnitLinking(unitNumber, propertyName, contractNumber) {
    const checkbox = document.querySelector(`input[value="${unitNumber}"][name="linkingUnits"]`);

    if (checkbox.checked) {
        // ุฑุจุท ุงููุญุฏุฉ
        linkUnitToContract(unitNumber, propertyName, contractNumber);
    } else {
        // ูุตู ุงููุญุฏุฉ
        unlinkUnit(unitNumber, propertyName, contractNumber);
    }
}

// ุฑุจุท ูุญุฏุฉ ุจุงูุนูุฏ
function linkUnitToContract(unitNumber, propertyName, contractNumber) {
    if (!contractNumber) {
        alert('ูุฌุจ ุฅุฏุฎุงู ุฑูู ุงูุนูุฏ ุฃููุงู');
        return;
    }

    const unitIndex = properties.findIndex(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName && p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber
    );

    if (unitIndex !== -1) {
        properties[unitIndex]['ุฑูู ุงูุนูุฏ'] = contractNumber;

        // ุชุญุฏูุซ ุงูุนุฑุถ
        updateLinkedUnitsDisplay(propertyName, contractNumber);
        alert(`ุชู ุฑุจุท ุงููุญุฏุฉ ${unitNumber} ุจุงูุนูุฏ ${contractNumber}`);
    }
}

// ูุตู ูุญุฏุฉ ูู ุงูุนูุฏ
async function unlinkUnit(unitNumber, propertyName, contractNumber) {
    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ูุตู ุงููุญุฏุฉ ${unitNumber} ูู ุงูุนูุฏุ`)) return;

    const unitIndex = properties.findIndex(p =>
        p['ุงุณู ุงูุนูุงุฑ'] === propertyName &&
        p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber &&
        p['ุฑูู ุงูุนูุฏ'] === contractNumber
    );

    if (unitIndex !== -1) {
        // ูุตู ุงููุญุฏุฉ ูุญููุงู
        properties[unitIndex]['ุฑูู ุงูุนูุฏ'] = '';
        properties[unitIndex]['ุงุณู ุงููุณุชุฃุฌุฑ'] = '';

        // ุญูุธ ุงูุชุบููุฑุงุช ูู Supabase
        let supabaseSuccess = false;
        if (typeof savePropertyToSupabase === 'function') {
            try {
                const result = await savePropertyToSupabase(properties[unitIndex]);
                if (result) {
                    console.log(`โ ุชู ุญูุธ ูุตู ุงููุญุฏุฉ ${unitNumber} ูู Supabase`);
                    supabaseSuccess = true;
                } else {
                    console.error(`โ ูุดู ุญูุธ ูุตู ุงููุญุฏุฉ ${unitNumber} ูู Supabase`);
                }
            } catch (error) {
                console.error(`โ ุฎุทุฃ ูู ุญูุธ ูุตู ุงููุญุฏุฉ ${unitNumber}:`, error);
            }
        }

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        saveDataLocally();

        // ุชุญุฏูุซ ุงูุนุฑุถ
        updateLinkedUnitsDisplay(propertyName, contractNumber);
        updateAvailableUnitsDisplay(propertyName, contractNumber, unitNumber);

        // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุญุงูุงุช
        initializeApp();

        // ุฑุณุงูุฉ ุงููุฌุงุญ ูุน ุชูุงุตูู ุงูุญูุธ
        let message = `ุชู ูุตู ุงููุญุฏุฉ ${unitNumber} ูู ุงูุนูุฏ`;
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            if (supabaseSuccess) {
                message += `\nโ ุชู ุญูุธ ุงูุชุบููุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ`;
            } else {
                message += `\nโ๏ธ ุชุญุฐูุฑ: ูุดู ุญูุธ ุงูุชุบููุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ`;
            }
        }
        alert(message);
    }
}

// ุชุญุฏูุซ ุนุฑุถ ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ
function updateLinkedUnitsDisplay(propertyName, contractNumber) {
    const container = document.getElementById('linkedUnitsDisplay');
    if (container) {
        container.innerHTML = renderLinkedUnits(propertyName, contractNumber);
    }
}

// ุชุญุฏูุซ ุนุฑุถ ุงููุญุฏุงุช ุงููุชุงุญุฉ
function updateAvailableUnitsDisplay(propertyName, contractNumber, currentUnitNumber) {
    const container = document.getElementById('availableUnitsForLinking');
    if (container) {
        container.innerHTML = renderAvailableUnitsForLinking(propertyName, contractNumber, currentUnitNumber);
    }
}

// ==================== ูุธุงุฆู ุฅุฏุงุฑุฉ ุงูุฃูุณุงุท ====================

// ุนุฑุถ ุงูุฃูุณุงุท ููุชุญุฑูุฑ
function renderInstallmentsForEdit(property) {
    let installments = [];

    // ุฌูุน ุงูุฃูุณุงุท ุงูููุฌูุฏุฉ
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        if (property[dateKey] || property[amountKey]) {
            installments.push({
                number: i,
                date: property[dateKey] || '',
                amount: property[amountKey] || '',
                dateKey: dateKey,
                amountKey: amountKey
            });
        }
    }

    // ุฅุถุงูุฉ ูุณุท ูุงุฑุบ ุฅุฐุง ูู ุชูุฌุฏ ุฃูุณุงุท
    if (installments.length === 0) {
        installments.push({
            number: 1,
            date: '',
            amount: '',
            dateKey: 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู',
            amountKey: 'ูุจูุบ ุงููุณุท ุงูุงูู'
        });
    }

    return installments.map(installment => `
        <div class="installment-item" data-installment="${installment.number}">
            <div class="installment-header">
                <h4><i class="fas fa-calendar-check"></i> ุงููุณุท ${getArabicNumber(installment.number)}</h4>
                <button type="button" onclick="removeInstallment(${installment.number})" class="btn-remove-installment">
                    <i class="fas fa-trash"></i> ุญุฐู
                </button>
            </div>
            <div class="installment-fields">
                <div class="form-group">
                    <label>ุชุงุฑูุฎ ุงููุณุท:</label>
                    <input type="date" name="${installment.dateKey}" value="${formatDateForInput(installment.date)}"
                           placeholder="ุชุงุฑูุฎ ุงููุณุท" onchange="setTimeout(() => autoSaveInstallmentChanges(), 1000)">
                </div>
                <div class="form-group">
                    <label>ูุจูุบ ุงููุณุท:</label>
                    <input type="number" name="${installment.amountKey}" value="${installment.amount}" step="0.01"
                           placeholder="ูุจูุบ ุงููุณุท" onchange="setTimeout(() => autoSaveInstallmentChanges(), 1000)">
                </div>
            </div>
        </div>
    `).join('');
}

// ุชุญููู ุงูุฑูู ุฅูู ุงูุนุฑุจูุฉ
function getArabicNumber(num) {
    const arabicNumbers = {
        1: 'ุงูุฃูู', 2: 'ุงูุซุงูู', 3: 'ุงูุซุงูุซ', 4: 'ุงูุฑุงุจุน', 5: 'ุงูุฎุงูุณ',
        6: 'ุงูุณุงุฏุณ', 7: 'ุงูุณุงุจุน', 8: 'ุงูุซุงูู', 9: 'ุงูุชุงุณุน', 10: 'ุงูุนุงุดุฑ'
    };
    return arabicNumbers[num] || num.toString();
}

// ุฅุถุงูุฉ ูุณุท ุฌุฏูุฏ
function addNewInstallment() {
    const container = document.getElementById('installmentsContainer');
    const existingInstallments = container.querySelectorAll('.installment-item');
    const nextNumber = existingInstallments.length + 1;

    if (nextNumber > 10) {
        alert('ูุง ูููู ุฅุถุงูุฉ ุฃูุซุฑ ูู 10 ุฃูุณุงุท');
        return;
    }

    const dateKey = nextNumber === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                   nextNumber === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                   `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(nextNumber)}`;
    const amountKey = nextNumber === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                     nextNumber === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                     `ูุจูุบ ุงููุณุท ${getArabicNumber(nextNumber)}`;

    const installmentHtml = `
        <div class="installment-item" data-installment="${nextNumber}">
            <div class="installment-header">
                <h4><i class="fas fa-calendar-check"></i> ุงููุณุท ${getArabicNumber(nextNumber)}</h4>
                <button type="button" onclick="removeInstallment(${nextNumber})" class="btn-remove-installment">
                    <i class="fas fa-trash"></i> ุญุฐู
                </button>
            </div>
            <div class="installment-fields">
                <div class="form-group">
                    <label>ุชุงุฑูุฎ ุงููุณุท:</label>
                    <input type="date" name="${dateKey}" value="" placeholder="ุชุงุฑูุฎ ุงููุณุท">
                </div>
                <div class="form-group">
                    <label>ูุจูุบ ุงููุณุท:</label>
                    <input type="number" name="${amountKey}" value="" step="0.01" placeholder="ูุจูุบ ุงููุณุท">
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', installmentHtml);

    // ุฅุถุงูุฉ ูุณุชูุน ููุชุบููุฑุงุช ุนูู ุงูุญููู ุงูุฌุฏูุฏุฉ
    const newInstallmentItem = container.lastElementChild;
    const inputs = newInstallmentItem.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            // ุญูุธ ุชููุงุฆู ุนูุฏ ุชุบููุฑ ููู ุงูุฃูุณุงุท
            setTimeout(() => {
                autoSaveInstallmentChanges();
            }, 1000);
        });
    });
}

// ุญุฐู ูุณุท
function removeInstallment(installmentNumber) {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุณุทุ')) return;

    const installmentItem = document.querySelector(`[data-installment="${installmentNumber}"]`);
    if (installmentItem) {
        installmentItem.remove();

        // ุฅุนุงุฏุฉ ุชุฑููู ุงูุฃูุณุงุท
        renumberInstallments();
    }
}

// ุฅุนุงุฏุฉ ุชุฑููู ุงูุฃูุณุงุท
function renumberInstallments() {
    const container = document.getElementById('installmentsContainer');
    const installmentItems = container.querySelectorAll('.installment-item');

    installmentItems.forEach((item, index) => {
        const newNumber = index + 1;
        const oldNumber = item.getAttribute('data-installment');

        // ุชุญุฏูุซ ุฑูู ุงููุณุท
        item.setAttribute('data-installment', newNumber);

        // ุชุญุฏูุซ ุงูุนููุงู
        const header = item.querySelector('.installment-header h4');
        header.innerHTML = `<i class="fas fa-calendar-check"></i> ุงููุณุท ${getArabicNumber(newNumber)}`;

        // ุชุญุฏูุซ ุฒุฑ ุงูุญุฐู
        const removeBtn = item.querySelector('.btn-remove-installment');
        removeBtn.setAttribute('onclick', `removeInstallment(${newNumber})`);

        // ุชุญุฏูุซ ุฃุณูุงุก ุงูุญููู
        const dateInput = item.querySelector('input[type="date"]');
        const amountInput = item.querySelector('input[type="number"]');

        const newDateKey = newNumber === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                          newNumber === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                          `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(newNumber)}`;
        const newAmountKey = newNumber === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                            newNumber === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                            `ูุจูุบ ุงููุณุท ${getArabicNumber(newNumber)}`;

        dateInput.setAttribute('name', newDateKey);
        amountInput.setAttribute('name', newAmountKey);

        // ุฅุถุงูุฉ ูุณุชูุน ููุชุบููุฑุงุช ุนูู ุงูุญููู ุงููุญุฏุซุฉ
        dateInput.addEventListener('change', function() {
            setTimeout(() => autoSaveInstallmentChanges(), 1000);
        });
        amountInput.addEventListener('change', function() {
            setTimeout(() => autoSaveInstallmentChanges(), 1000);
        });
    });
}

// ุญูุธ ุชููุงุฆู ูุชุบููุฑุงุช ุงูุฃูุณุงุท
function autoSaveInstallmentChanges() {
    // ุงูุจุญุซ ุนู ุงููููุฐุฌ ุงููุดุท
    const activeForm = document.querySelector('.modal-overlay form');
    if (!activeForm) return;

    const formData = new FormData(activeForm);
    const originalContractNumber = formData.get('originalContractNumber');
    const originalPropertyName = formData.get('originalPropertyName');
    const originalUnitNumber = formData.get('originalUnitNumber');

    // ุงูุจุญุซ ุนู ุงูุนูุงุฑ
    let propertyIndex = -1;
    if (originalContractNumber && originalPropertyName) {
        propertyIndex = properties.findIndex(p =>
            p['ุฑูู ุงูุนูุฏ'] === originalContractNumber && p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );
    } else if (originalUnitNumber && originalPropertyName) {
        propertyIndex = properties.findIndex(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === originalUnitNumber && p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName
        );
    }

    if (propertyIndex === -1) return;

    // ุชุญุฏูุซ ุจูุงูุงุช ุงูุฃูุณุงุท ููุท - ูุน ุงูุญูุงุธ ุนูู ุฌููุน ุงูุฃูุณุงุท ุงูููุฌูุฏุฉ
    const updatedProperty = { ...properties[propertyIndex] };

    // ุฃููุงู: ูุณุญ ุฌููุน ุงูุฃูุณุงุท ุงููุฏููุฉ ูุชุฌูุจ ุงูุชุฏุงุฎู
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        // ูุณุญ ุงูููู ุงููุฏููุฉ
        updatedProperty[dateKey] = null;
        updatedProperty[amountKey] = null;
    }

    // ุซุงููุงู: ุชุญุฏูุซ ุงูุฃูุณุงุท ูู ุงููููุฐุฌ
    for (let [key, value] of formData.entries()) {
        if (key.includes('ุงููุณุท')) {
            // ูุนุงูุฌุฉ ุชูุงุฑูุฎ ุงูุฃูุณุงุท
            if (key.includes('ุชุงุฑูุฎ') && value) {
                const dateParts = value.split('-');
                if (dateParts.length === 3 && dateParts[0].length === 4) {
                    // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]);
                    const day = parseInt(dateParts[2]);

                    if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                        const testDate = new Date(year, month - 1, day, 12, 0, 0);
                        if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                            value = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                        } else {
                            value = null; // ุชุงุฑูุฎ ุบูุฑ ุตุงูุญ
                        }
                    } else {
                        value = null; // ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ
                    }
                }
            }

            // ูุนุงูุฌุฉ ูุจุงูุบ ุงูุฃูุณุงุท
            if (key.includes('ูุจูุบ') && value) {
                value = parseFloat(value) || 0;
            }

            // ุญูุธ ุงููููุฉ ููุท ุฅุฐุง ูุงูุช ุตุงูุญุฉ
            if (value !== null && value !== '' && value !== 0) {
                updatedProperty[key] = value;
            }
        }
    }

    // ุชุญุฏูุซ ุนุฏุฏ ุงูุฃูุณุงุท ุจูุงุกู ุนูู ุงูุฃูุณุงุท ุงูููุฌูุฏุฉ ูุนููุงู
    let installmentCount = 0;
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        if (updatedProperty[dateKey] || updatedProperty[amountKey]) {
            installmentCount = i;
        }
    }

    updatedProperty['ุนุฏุฏ ุงูุงูุณุงุท'] = installmentCount;

    // ุญุณุงุจ ุงูุฅุฌูุงูู ุงูุฌุฏูุฏ
    const yearlyData = calculateYearlyTotal(updatedProperty);
    if (yearlyData.count > 0) {
        updatedProperty['ุงูุงุฌูุงูู'] = yearlyData.total;
    }

    // ุญูุธ ุงูุชุญุฏูุซ
    properties[propertyIndex] = updatedProperty;

    // ุญูุธ ูู Supabase
    if (typeof savePropertyToSupabase === 'function') {
        savePropertyToSupabase(updatedProperty);
    }

    // ุญูุธ ูุญููุงู
    saveDataLocally();

    // ุชุญุฏูุซ ุงูุนุฑุถ ุฅุฐุง ูุงู ุงููููุฐุฌ ููุชูุญุงู
    const totalDisplay = document.querySelector('.modal-overlay .total-display');
    if (totalDisplay) {
        const yearlyData = calculateYearlyTotal(updatedProperty);
        totalDisplay.textContent = `ุงูุฅุฌูุงูู: ${yearlyData.total.toLocaleString()} ุฑูุงู (${yearlyData.count} ุฃูุณุงุท)`;
    }

    console.log('โ ุชู ุญูุธ ุชุบููุฑุงุช ุงูุฃูุณุงุท ุชููุงุฆูุงู');
}

// ุฏุงูุฉ ุชุดุฎูุต ุงูุฃูุณุงุท - ููุชุญูู ูู ุงููุดุงูู
function diagnoseInstallments(contractNumber, propertyName) {
    console.log(`๐ ุชุดุฎูุต ุฃูุณุงุท ุงูุนูุฏ: ${contractNumber} - ${propertyName}`);

    const property = properties.find(p =>
        p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );

    if (!property) {
        console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ');
        return;
    }

    console.log('๐ ุชูุงุตูู ุงูุฃูุณุงุท:');
    let foundInstallments = 0;

    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        const date = property[dateKey];
        const amount = property[amountKey];

        if (date || amount) {
            foundInstallments++;
            console.log(`โ ุงููุณุท ${i}: ุงูุชุงุฑูุฎ = ${date || 'ุบูุฑ ูุญุฏุฏ'}, ุงููุจูุบ = ${amount || 'ุบูุฑ ูุญุฏุฏ'}`);
        }
    }

    console.log(`๐ ุฅุฌูุงูู ุงูุฃูุณุงุท ุงูููุฌูุฏุฉ: ${foundInstallments}`);
    console.log(`๐ ุนุฏุฏ ุงูุฃูุณุงุท ุงููุญููุธ: ${property['ุนุฏุฏ ุงูุงูุณุงุท'] || 'ุบูุฑ ูุญุฏุฏ'}`);

    const yearlyData = calculateYearlyTotal(property);
    console.log(`๐ฐ ุงูุฅุฌูุงูู ุงููุญุณูุจ: ${yearlyData.total.toLocaleString()} ุฑูุงู (${yearlyData.count} ุฃูุณุงุท)`);

    return {
        foundInstallments,
        savedCount: property['ุนุฏุฏ ุงูุงูุณุงุท'],
        yearlyTotal: yearlyData.total,
        yearlyCount: yearlyData.count
    };
}

// ==================== ูุธุงุฆู ุญุณุงุจ ุงูุฅุฌูุงูู ุจูุงุกู ุนูู ุงูุณูุฉ ====================

// ุญุณุงุจ ุงูุฅุฌูุงูู ุจูุงุกู ุนูู ุฃูุณุงุท ุงูุณูุฉ ุงูุญุงููุฉ
function calculateYearlyTotal(property) {
    let yearlyTotal = 0;
    let installmentsCount = 0;
    const targetYear = currentCalculationYear;

    // ูุญุต ุฌููุน ุงูุฃูุณุงุท ุงููุญููุธุฉ (ูู 1 ุฅูู 10)
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        const installmentDate = property[dateKey];
        const installmentAmount = property[amountKey];

        if (installmentDate && installmentAmount) {
            // ุงุณุชุฎุฑุงุฌ ุงูุณูุฉ ูู ุชุงุฑูุฎ ุงููุณุท
            const dateObj = parseArabicDate(installmentDate);
            if (dateObj && dateObj.getFullYear() === targetYear) {
                yearlyTotal += parseFloat(installmentAmount) || 0;
                installmentsCount++;
            }
        }
    }

    return {
        total: yearlyTotal,
        count: installmentsCount,
        year: targetYear
    };
}

// ุชุญููู ุงูุชุงุฑูุฎ ุงูุนุฑุจู
function parseArabicDate(dateStr) {
    if (!dateStr) return null;

    // ุชูุณููุงุช ุงูุชุงุฑูุฎ ุงููุฎุชููุฉ
    const formats = [
        /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // DD/MM/YYYY
        /^(\d{1,2})-(\d{1,2})-(\d{4})$/, // DD-MM-YYYY
        /^(\d{4})-(\d{1,2})-(\d{1,2})$/, // YYYY-MM-DD
    ];

    for (let format of formats) {
        const match = dateStr.match(format);
        if (match) {
            let day, month, year;
            if (format === formats[2]) { // YYYY-MM-DD
                [, year, month, day] = match;
            } else { // DD/MM/YYYY or DD-MM-YYYY
                [, day, month, year] = match;
            }
            return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        }
    }

    return null;
}

// ุฅูุดุงุก ููุงุญุธุฉ ุงูุฅุฌูุงูู
function createTotalNote(yearlyData) {
    if (yearlyData.count === 0) {
        return `ูุง ุชูุฌุฏ ุฃูุณุงุท ูุนุงู ${yearlyData.year}`;
    }

    const countText = yearlyData.count === 1 ? 'ูุณุท ูุงุญุฏ' :
                     yearlyData.count === 2 ? 'ูุณุทุงู' :
                     `${yearlyData.count} ุฃูุณุงุท`;

    return `ุฅุฌูุงูู ุฃูุณุงุท ุนุงู ${yearlyData.year} - ุนุฏุฏ ุงูุฃูุณุงุท: ${countText}`;
}

// ุชุญุฏูุซ ุนุฑุถ ุงูุฅุฌูุงูู ูุน ุงูููุงุญุธุฉ
function formatTotalWithNote(property) {
    const smartTotal = calculateSmartTotal(property);

    const formattedTotal = smartTotal.amount > 0 ?
        `${smartTotal.amount.toLocaleString()} ุฑูุงู` :
        '';

    return {
        display: formattedTotal,
        note: smartTotal.note,
        amount: smartTotal.amount,
        source: smartTotal.source
    };
}

// ==================== ูุธููุฉ ุญุณุงุจ ุงูุฅุฌูุงูู ุงูุฐูู ====================

// ุญุณุงุจ ุงูุฅุฌูุงูู ุจุทุฑููุฉ ุฐููุฉ (ุฃููููุฉ ููุญูู ุงููุญููุธุ ุซู ุงูุฃูุณุงุทุ ุซู ุงูุฅูุฌุงุฑ)
function calculateSmartTotal(property) {
    let totalAmount = 0;
    let source = 'none';
    let note = '';

    // ุฃููุงู: ูุญุงููุฉ ุงุณุชุฎุฏุงู ุญูู "ุงูุงุฌูุงูู" ุฅุฐุง ูุงู ููุฌูุฏ
    if (property['ุงูุงุฌูุงูู'] && property['ุงูุงุฌูุงูู'] !== null) {
        totalAmount = parseFloat(property['ุงูุงุฌูุงูู']);
        source = 'saved';
        note = 'ุงูุฅุฌูุงูู ุงููุญููุธ';
    } else {
        // ุซุงููุงู: ุญุณุงุจ ูู ุงูุฃูุณุงุท ุงูููุฌูุฏุฉ
        const yearlyData = calculateYearlyTotal(property);
        if (yearlyData.total > 0) {
            totalAmount = yearlyData.total;
            source = 'calculated';
            note = createTotalNote(yearlyData);
        } else if (property['ูููุฉ  ุงูุงูุฌุงุฑ ']) {
            // ุซุงูุซุงู: ุงุณุชุฎุฏุงู ูููุฉ ุงูุฅูุฌุงุฑ ูุจุฏูู
            totalAmount = parseFloat(property['ูููุฉ  ุงูุงูุฌุงุฑ ']) || 0;
            source = 'rent';
            note = 'ูููุฉ ุงูุฅูุฌุงุฑ';
        } else {
            source = 'none';
            note = 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ';
        }
    }

    return {
        amount: totalAmount,
        source: source,
        note: note
    };
}

// ==================== ูุธููุฉ ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช ====================

// ุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ููู "ุงูุงุฌูุงูู" ูู ุงูุจูุงูุงุช
function recalculateAllTotals() {
    let updatedCount = 0;

    properties.forEach(property => {
        // ุชุฌุงูู ุงููุญุฏุงุช ุงููุงุฑุบุฉ
        if (!property['ุงุณู ุงููุณุชุฃุฌุฑ'] || property['ุงุณู ุงููุณุชุฃุฌุฑ'].toString().trim() === '') {
            return;
        }

        // ุฅุฐุง ูุงู ุญูู "ุงูุงุฌูุงูู" ูุงุฑุบ ุฃู null
        if (!property['ุงูุงุฌูุงูู'] || property['ุงูุงุฌูุงูู'] === null) {
            const smartTotal = calculateSmartTotal(property);
            if (smartTotal.amount > 0) {
                property['ุงูุงุฌูุงูู'] = smartTotal.amount;
                updatedCount++;
            }
        }
    });

    if (updatedCount > 0) {
        console.log(`ุชู ุชุญุฏูุซ ${updatedCount} ูููุฉ ุฅุฌูุงูู`);
        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
        initializeApp();
        renderData();
    }

    // ุนุฑุถ ุชูุงุตูู ุงูุญุณุงุจ ูู ูุญุฏุฉ ุงูุชุทููุฑ
    console.log('=== ุชูุงุตูู ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช ===');
    let totalCommercial = 0, totalResidential = 0;
    let commercialCount = 0, residentialCount = 0;

    properties.forEach(property => {
        if (!property['ุงุณู ุงููุณุชุฃุฌุฑ'] || property['ุงุณู ุงููุณุชุฃุฌุฑ'].toString().trim() === '') {
            return;
        }

        const smartTotal = calculateSmartTotal(property);
        if (smartTotal.amount > 0) {
            if (property['ููุน ุงูุนูุฏ'] === 'ุถุฑูุจู') {
                totalCommercial += smartTotal.amount;
                commercialCount++;
                console.log(`ุชุฌุงุฑู: ${property['ุงุณู ุงููุณุชุฃุฌุฑ']} - ${smartTotal.amount.toLocaleString()} ุฑูุงู (${smartTotal.source})`);
            } else {
                totalResidential += smartTotal.amount;
                residentialCount++;
                console.log(`ุณููู: ${property['ุงุณู ุงููุณุชุฃุฌุฑ']} - ${smartTotal.amount.toLocaleString()} ุฑูุงู (${smartTotal.source})`);
            }
        }
    });

    console.log(`ุฅุฌูุงูู ุชุฌุงุฑู: ${totalCommercial.toLocaleString()} ุฑูุงู (${commercialCount} ุนูุฏ)`);
    console.log(`ุฅุฌูุงูู ุณููู: ${totalResidential.toLocaleString()} ุฑูุงู (${residentialCount} ุนูุฏ)`);
    console.log('=====================================');

    return updatedCount;
}

// ==================== ูุธุงุฆู ุชุนุฏูู ุงูุนูุงุฑุงุช ====================

// ุชุนุฏูู ุจูุงูุงุช ุงูุนูุงุฑ (ูุญุณู ููุนูู ูุน ุงููุธุงู ุงูุฌุฏูุฏ)
function editPropertyData(propertyName) {
    // ุงูุจุญุซ ูู ุงููุญุฏุงุช ุงูููุฌูุฏุฉ ุฃููุงู
    let propertyData = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);

    // ุฅุฐุง ูู ุชูุฌุฏุ ุงุจุญุซ ูู ุชุนุฑููุงุช ุงูุนูุงุฑุงุช
    if (!propertyData) {
        const propertyDefinition = propertyDefinitions.find(p => p.name === propertyName);
        if (propertyDefinition) {
            // ุชุญููู ุชุนุฑูู ุงูุนูุงุฑ ุฅูู ุชูุณูู ุงูุจูุงูุงุช ุงููุชููุน
            propertyData = {
                'ุงุณู ุงูุนูุงุฑ': propertyDefinition.name,
                'ุงููุฏููุฉ': propertyDefinition.city,
                'ุฑูู ุงูุตู': propertyDefinition.deed,
                'ูุณุงุญุฉุงูุตู': propertyDefinition.area,
                'ุงูุณุฌู ุงูุนููู ': propertyDefinition.registry,
                'ูููุน ุงูุนูุงุฑ': propertyDefinition.location,
                'ุงููุงูู': propertyDefinition.owner
            };
            console.log('๐ ุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ูู ุชุนุฑููุงุช ุงูุนูุงุฑุงุช:', propertyDefinition);
        }
    }

    if (!propertyData) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ูู ุงููุธุงู');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุชุนุฏูู
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-box edit-property-modal">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> ุชุนุฏูู ุจูุงูุงุช ุงูุนูุงุฑ</h2>
                <p>ุชุนุฏูู ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ ููุนูุงุฑ: ${propertyName}</p>
            </div>
            <div class="modal-content">
                <div class="management-section">
                    <h3><i class="fas fa-building"></i> ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุงุณู ุงูุนูุงุฑ:</label>
                            <input type="text" id="editPropertyName" value="${propertyData['ุงุณู ุงูุนูุงุฑ'] || ''}" placeholder="ุงุณู ุงูุนูุงุฑ">
                        </div>
                        <div class="form-group">
                            <label>ุงููุฏููุฉ:</label>
                            <select id="editPropertyCity">
                                ${getUniqueCountries().filter(city => city !== 'ุงููู').map(city =>
                                    `<option value="${city}" ${city === propertyData['ุงููุฏููุฉ'] ? 'selected' : ''}>${city}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุฑูู ุงูุตู:</label>
                            <input type="text" id="editPropertyDeed" value="${propertyData['ุฑูู ุงูุตู'] || ''}" placeholder="ุฑูู ุงูุตู">
                        </div>
                        <div class="form-group">
                            <label>ูุณุงุญุฉ ุงูุตู:</label>
                            <input type="number" id="editPropertyArea" value="${propertyData['ูุณุงุญุฉุงูุตู'] || ''}" placeholder="ุงููุณุงุญุฉ ุจุงููุชุฑ ุงููุฑุจุน">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ุงูุณุฌู ุงูุนููู:</label>
                            <input type="text" id="editPropertyRegistry" value="${propertyData['ุงูุณุฌู ุงูุนููู '] || ''}" placeholder="ุฑูู ุงูุณุฌู ุงูุนููู">
                        </div>
                        <div class="form-group">
                            <label>ุงููุงูู:</label>
                            <input type="text" id="editPropertyOwner" value="${propertyData['ุงููุงูู'] || ''}" placeholder="ุงุณู ุงููุงูู">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ูููุน ุงูุนูุงุฑ:</label>
                            <input type="url" id="editPropertyLocation" value="${propertyData['ูููุน ุงูุนูุงุฑ'] || ''}" placeholder="ุฑุงุจุท ุงูุฎุฑูุทุฉ">
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="handleSavePropertyChanges('${propertyName}')">
                        <i class="fas fa-save"></i> ุญูุธ ุงูุชุบููุฑุงุช
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> ุฅูุบุงุก
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // ุฅุถุงูุฉ ูุณุชูุน ูุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
    modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ูุธููุฉ wrapper ููุชุนุงูู ูุน async ูู onclick
function handleSavePropertyChanges(originalPropertyName) {
    console.log(`๐ ุจุฏุก ูุนุงูุฌุฉ ุญูุธ ุชุบููุฑุงุช ุงูุนูุงุฑ: ${originalPropertyName}`);

    // ุงูุจุญุซ ุนู ุงูุฒุฑ ุจุทุฑููุฉ ุฃูุซุฑ ุฃูุงูุงู
    const saveBtn = document.querySelector('.btn-primary');
    if (saveBtn) {
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุญูุธ...';

        // ุงุณุชุฏุนุงุก ุงููุธููุฉ async
        savePropertyChanges(originalPropertyName)
            .then(() => {
                console.log('โ ุชู ุฅููุงุก ุญูุธ ุงูุชุบููุฑุงุช ุจูุฌุงุญ');
                // ุงูุฒุฑ ุณูุชู ุฅุฎูุงุคู ุนูุฏ ุฅุบูุงู ุงููุงูุฐุฉ
            })
            .catch((error) => {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุชุบููุฑุงุช:', error);
                // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ ูู ุญุงูุฉ ุงูุฎุทุฃ
                if (saveBtn.parentNode) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            });
    } else {
        // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุฒุฑุ ุงุณุชุฏุนู ุงููุธููุฉ ูุจุงุดุฑุฉ
        savePropertyChanges(originalPropertyName);
    }
}

// ุญูุธ ุชุบููุฑุงุช ุงูุนูุงุฑ ูุน ุงููุฒุงููุฉ ุงููุญุณูุฉ
async function savePropertyChanges(originalPropertyName) {
    console.log(`๐พ ุจุฏุก ุญูุธ ุชุบููุฑุงุช ุงูุนูุงุฑ: ${originalPropertyName}`);

    const newName = document.getElementById('editPropertyName').value.trim();
    const newCity = document.getElementById('editPropertyCity').value;
    const newDeed = document.getElementById('editPropertyDeed').value.trim();
    const newArea = document.getElementById('editPropertyArea').value;
    const newRegistry = document.getElementById('editPropertyRegistry').value.trim();
    const newOwner = document.getElementById('editPropertyOwner').value.trim();
    const newLocation = document.getElementById('editPropertyLocation').value.trim();

    if (!newName || !newCity) {
        showToast('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนูุงุฑ ูุงุฎุชูุงุฑ ุงููุฏููุฉ', 'error');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุนูุงุฑ ุขุฎุฑ ุจููุณ ุงูุงุณู ุงูุฌุฏูุฏ (ุฅุฐุง ุชู ุชุบููุฑ ุงูุงุณู)
    if (newName !== originalPropertyName) {
        const existingProperty = properties.find(p =>
            p['ุงุณู ุงูุนูุงุฑ'] === newName && p['ุงููุฏููุฉ'] === newCity
        );
        if (existingProperty) {
            showToast('ููุฌุฏ ุนูุงุฑ ุขุฎุฑ ุจููุณ ุงูุงุณู ูู ูุฐู ุงููุฏููุฉ', 'error');
            return;
        }
    }

    // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.style.display = 'flex';
    loadingModal.style.zIndex = '10001';
    loadingModal.innerHTML = `
        <div class="modal-box loading-modal">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h3>ุฌุงุฑู ุญูุธ ุงูุชุบููุฑุงุช...</h3>
                <p>ูุฑุฌู ุงูุงูุชุธุงุฑ ุญุชู ูุชู ุญูุธ ุงูุจูุงูุงุช ูู ุงูุณุญุงุจุฉ</p>
            </div>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงูุฃุตููุฉ ููููุงุฑูุฉ
        const relatedProperties = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName);
        const originalData = relatedProperties[0] ? { ...relatedProperties[0] } : {};

        // ุชุนุฑูู ุงููุชุบูุฑุงุช ุงููุทููุจุฉ ููุชุชุจุน
        const originalUnitNumber = originalData['ุฑูู  ุงููุญุฏุฉ '] || '';
        const originalTenantName = originalData['ุงุณู ุงููุณุชุฃุฌุฑ'] || '';
        const originalContractNumber = originalData['ุฑูู ุงูุนูุฏ'] || '';

        // ุชุญุถูุฑ ุงูุชุบููุฑุงุช ููุชุชุจุน
        const changes = {};

        if (newName !== originalPropertyName) {
            changes['ุงุณู ุงูุนูุงุฑ'] = {
                fieldName: 'ุงุณู ุงูุนูุงุฑ',
                old: originalPropertyName,
                new: newName
            };
        }

        if (newCity !== originalData['ุงููุฏููุฉ']) {
            changes['ุงููุฏููุฉ'] = {
                fieldName: 'ุงููุฏููุฉ',
                old: originalData['ุงููุฏููุฉ'] || '',
                new: newCity
            };
        }

        if (newDeed !== (originalData['ุฑูู ุงูุตู'] || '')) {
            changes['ุฑูู ุงูุตู'] = {
                fieldName: 'ุฑูู ุงูุตู',
                old: originalData['ุฑูู ุงูุตู'] || '',
                new: newDeed
            };
        }

        if (newArea !== (originalData['ูุณุงุญุฉุงูุตู'] || '')) {
            changes['ูุณุงุญุฉุงูุตู'] = {
                fieldName: 'ูุณุงุญุฉ ุงูุตู',
                old: originalData['ูุณุงุญุฉุงูุตู'] || '',
                new: newArea
            };
        }

        if (newRegistry !== (originalData['ุงูุณุฌู ุงูุนููู '] || '')) {
            changes['ุงูุณุฌู ุงูุนููู '] = {
                fieldName: 'ุงูุณุฌู ุงูุนููู',
                old: originalData['ุงูุณุฌู ุงูุนููู '] || '',
                new: newRegistry
            };
        }

        if (newOwner !== (originalData['ุงููุงูู'] || '')) {
            changes['ุงููุงูู'] = {
                fieldName: 'ุงููุงูู',
                old: originalData['ุงููุงูู'] || '',
                new: newOwner
            };
        }

        if (newLocation !== (originalData['ูููุน ุงูุนูุงุฑ'] || '')) {
            changes['ูููุน ุงูุนูุงุฑ'] = {
                fieldName: 'ูููุน ุงูุนูุงุฑ',
                old: originalData['ูููุน ุงูุนูุงุฑ'] || '',
                new: newLocation
            };
        }

        // ุชุญุฏูุซ ุฌููุน ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ ุจูุฐุง ุงูุนูุงุฑ
        relatedProperties.forEach(property => {
            property['ุงุณู ุงูุนูุงุฑ'] = newName;
            property['ุงููุฏููุฉ'] = newCity;
            property['ุฑูู ุงูุตู'] = newDeed || null;
            property['ูุณุงุญุฉุงูุตู'] = newArea || null;
            property['ุงูุณุฌู ุงูุนููู '] = newRegistry || null;
            property['ุงููุงูู'] = newOwner || null;
            property['ูููุน ุงูุนูุงุฑ'] = newLocation || null;
            property['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
        });

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        saveDataLocally();

        // ุชุณุฌูู ุงูุชุบููุฑ ูู ุณุฌู ุงูุชุชุจุน
        if (Object.keys(changes).length > 0) {
            const changeLog = createChangeLog(
                OPERATION_TYPES.EDIT_DATA,
                {
                    'ุฑูู  ุงููุญุฏุฉ ': relatedProperties[0]['ุฑูู  ุงููุญุฏุฉ '] || 'ูุชุนุฏุฏ',
                    'ุงุณู ุงูุนูุงุฑ': newName,
                    'ุงุณู ุงููุณุชุฃุฌุฑ': relatedProperties[0]['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''
                },
                changes,
                {
                    affectedUnits: relatedProperties.length,
                    originalPropertyName: originalPropertyName
                }
            );

            changeTrackingLogs.push(changeLog);

            // ุญูุธ ุณุฌู ุงูุชุชุจุน ูุญููุงู
            try {
                localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
            } catch (error) {
                console.warn('โ๏ธ ูู ูุชู ุญูุธ ุณุฌู ุงูุชุชุจุน ูุญููุงู:', error);
            }

            // ุญูุธ ุณุฌู ุงูุชุชุจุน ูู Supabase
            await saveChangeLogToSupabase(changeLog);
        }

        // ูุฒุงููุฉ ูุน Supabase ูุน ูุนุงูุฌุฉ ุดุงููุฉ ููุญุณูุฉ ููุฃุฎุทุงุก
        console.log('๐ ุจุฏุก ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน Supabase...');

        try {
            // ูุญุงููุฉ ุญูุธ ูุจุงุดุฑ ูู Supabase (ุงูุทุฑููุฉ ุงููุญุณูุฉ)
            console.log('๐พ ุญูุธ ูุจุงุดุฑ ููุนูุงุฑุงุช ุงููุญุฏุซุฉ...');
            const directSaveResult = await savePropertiesDirectlyToSupabase(relatedProperties);

            // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
            if (loadingModal && loadingModal.parentNode) {
                loadingModal.remove();
            }

            if (directSaveResult.success) {
                // ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ ููุตูุฉ
                const successMessage = directSaveResult.message || `ุชู ุญูุธ ${directSaveResult.count} ุนูุงุฑ ุจูุฌุงุญ ูู ุงูุณุญุงุจุฉ`;
                showToast(successMessage, 'success');
                console.log('โ ุชู ุญูุธ ุชุบููุฑุงุช ุงูุนูุงุฑ ุจูุฌุงุญ ูู ุงูุณุญุงุจุฉ');

                // ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ูููุฌุงุญ
                const successLog = createChangeLog(
                    'ุชุญุฏูุซ ุนูุงุฑ',
                    originalUnitNumber,
                    originalPropertyName,
                    originalTenantName,
                    originalContractNumber,
                    changes,
                    {
                        method: directSaveResult.method,
                        cloudSync: true,
                        timestamp: new Date().toISOString()
                    }
                );

                await saveChangeLogToSupabase(successLog);

                // ุงูุชุญูู ูู ุงููุฒุงููุฉ (ุงุฎุชูุงุฑู)
                setTimeout(async () => {
                    try {
                        const verifyResult = await verifyDataSync(originalPropertyName, changes);
                        if (verifyResult.success) {
                            console.log('โ ุชู ุงูุชุญูู ูู ูุฒุงููุฉ ุงูุจูุงูุงุช');
                        } else {
                            console.warn('โ๏ธ ุจุนุถ ุงูุจูุงูุงุช ูู ุชุชู ูุฒุงููุชูุง ุจุดูู ูุงูู');
                        }
                    } catch (verifyError) {
                        console.warn('โ๏ธ ูู ูุชู ุงูุชุญูู ูู ุงููุฒุงููุฉ:', verifyError.message);
                    }
                }, 2000);

                // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
                updatePropertyDisplayAfterSave(originalPropertyName, changes);

                // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูุถูุงู ุงูุชุญุฏูุซ ุงูููุฑู
                await refreshDataAfterPropertyEdit(originalPropertyName);

            } else {
                throw new Error(directSaveResult.message || directSaveResult.error || 'ูุดู ูู ุงูุญูุธ ุงููุจุงุดุฑ');
            }

        } catch (saveError) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', saveError);

            // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
            if (loadingModal && loadingModal.parentNode) {
                loadingModal.remove();
            }

            // ูุญุงููุฉ ุงููุฒุงููุฉ ุงูุนุงูุฉ ูุจุฏูู
            try {
                console.log('๐ ูุญุงููุฉ ุงููุฒุงููุฉ ุงูุนุงูุฉ ูุจุฏูู...');
                const syncResult = await syncToSupabase(false);

                if (syncResult.success) {
                    showToast('ุชู ุญูุธ ุงูุชุบููุฑุงุช ูู ุงูุณุญุงุจุฉ (ุทุฑููุฉ ุจุฏููุฉ)', 'success');
                    console.log('โ ุชู ุงูุญูุธ ุนุจุฑ ุงููุฒุงููุฉ ุงูุนุงูุฉ');

                    // ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ูููุฌุงุญ ุงูุจุฏูู
                    const fallbackLog = createChangeLog(
                        'ุชุญุฏูุซ ุนูุงุฑ (ุทุฑููุฉ ุจุฏููุฉ)',
                        originalUnitNumber,
                        originalPropertyName,
                        originalTenantName,
                        originalContractNumber,
                        changes,
                        {
                            method: 'fallback_sync',
                            cloudSync: true,
                            originalError: saveError.message
                        }
                    );

                    await saveChangeLogToSupabase(fallbackLog);

                } else {
                    throw new Error(syncResult.message || 'ูุดู ูู ุงููุฒุงููุฉ ุงูุนุงูุฉ');
                }

            } catch (syncError) {
                console.error('โ ูุดู ูู ุฌููุน ุทุฑู ุงูุญูุธ:', syncError);

                // ุญูุธ ูุญูู ูุน ุฑุณุงูุฉ ุชุญุฐูุฑูุฉ
                showToast('ุชู ุญูุธ ุงูุชุบููุฑุงุช ูุญููุงู ููุท - ุณุชุชู ุงููุฒุงููุฉ ูุงุญูุงู', 'warning');

                // ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ูููุดู
                const failureLog = createChangeLog(
                    'ุชุญุฏูุซ ุนูุงุฑ (ูุญูู ููุท)',
                    originalUnitNumber,
                    originalPropertyName,
                    originalTenantName,
                    originalContractNumber,
                    changes,
                    {
                        method: 'local_only',
                        cloudSync: false,
                        saveError: saveError.message,
                        syncError: syncError.message,
                        needsRetry: true
                    }
                );

                await saveChangeLogToSupabase(failureLog);

                // ุฅุธูุงุฑ ุชูุงุตูู ุงูุฎุทุฃ ูููุณุชุฎุฏู ูุน ุฎูุงุฑุงุช
                setTimeout(() => {
                    const errorDetails = `
                        โ ูุดู ุงูุญูุธ ูู ุงูุณุญุงุจุฉ:

                        ุฎุทุฃ ุงูุญูุธ ุงููุจุงุดุฑ: ${saveError.message}
                        ุฎุทุฃ ุงููุฒุงููุฉ ุงูุนุงูุฉ: ${syncError.message}

                        โ ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู ุจูุฌุงุญ

                        ๐ง ุฎุทูุงุช ุงูุญู ุงูููุชุฑุญุฉ:
                        1. ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช
                        2. ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ ูุญุงูู ูุฑุฉ ุฃุฎุฑู
                        3. ุชุญูู ูู ุฅุนุฏุงุฏุงุช Supabase
                        4. ุงุชุตู ุจุงูุฏุนู ุงูููู ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

                        ๐ก ุณุชุชู ูุญุงููุฉ ุงููุฒุงููุฉ ุชููุงุฆูุงู ุนูุฏ ุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู
                    `;

                    if (confirm('ูู ุชุฑูุฏ ุฑุคูุฉ ุชูุงุตูู ุงูุฎุทุฃ ูุฎุทูุงุช ุงูุญูุ')) {
                        alert(errorDetails);
                    }
                }, 1000);
            }
        }

        // ุฅุบูุงู ุงููุงูุฐุฉ
        closeModal();

        // ุชุญุฏูุซ ุงูุนุฑุถ
        renderData();
        updateTotalStats();

        // ุชุญุฏูุซ ูุญุชูู ุชุจููุจ ุงูุนูุงุฑุงุช
        const propertiesTab = document.getElementById('properties-tab');
        if (propertiesTab) {
            propertiesTab.innerHTML = renderPropertiesTab();
        }

        // ูุณุญ ูุชุงุฆุฌ ุงูุจุญุซ ูุฅุนุงุฏุฉ ุนุฑุถ ุฌููุน ุงูุนูุงุฑุงุช
        if (typeof clearPropertiesSearch === 'function') {
            clearPropertiesSearch();
        }

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุฃููุฏ ููุงุฆูุฉ
        setTimeout(() => {
            console.log(`โ ุชู ุฅููุงุก ุชุญุฏูุซ ุงูุนูุงุฑ "${originalPropertyName}" ุจูุฌุงุญ`);

            // ุฅุถุงูุฉ ุฅุดุนุงุฑ ูู ุงููุงุฌูุฉ
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                ุชู ุชุญุฏูุซ ุงูุนูุงุฑ "${originalPropertyName}" ุจูุฌุงุญ
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                z-index: 10000;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideInRight 0.5s ease;
            `;

            document.body.appendChild(notification);

            // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑ ุจุนุฏ 5 ุซูุงู
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }
            }, 5000);
        }, 1000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุชุบููุฑุงุช ุงูุนูุงุฑ:', error);

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ ูุน ุฅููุงููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
        const errorModal = document.createElement('div');
        errorModal.className = 'modal-overlay';
        errorModal.style.display = 'flex';
        errorModal.style.zIndex = '10002';
        errorModal.innerHTML = `
            <div class="modal-box error-modal">
                <div class="error-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> ุฎุทุฃ ูู ุญูุธ ุงูุชุบููุฑุงุช</h3>
                </div>
                <div class="error-content">
                    <p><strong>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชุบููุฑุงุช:</strong></p>
                    <div class="error-details">${error.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}</div>
                    <p><i class="fas fa-info-circle"></i> ุชู ุญูุธ ุงูุชุบููุฑุงุช ูุญููุงู</p>
                </div>
                <div class="error-actions">
                    <button onclick="retrySavePropertyChanges('${originalPropertyName}')" class="retry-btn">
                        <i class="fas fa-redo"></i> ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                    </button>
                    <button onclick="closeModal()" class="close-btn">
                        <i class="fas fa-times"></i> ุฅุบูุงู
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(errorModal);
    }
}

// ุฅุนุงุฏุฉ ูุญุงููุฉ ุญูุธ ุชุบููุฑุงุช ุงูุนูุงุฑ
async function retrySavePropertyChanges(originalPropertyName) {
    closeModal(); // ุฅุบูุงู ูุงูุฐุฉ ุงูุฎุทุฃ
    await savePropertyChanges(originalPropertyName);
}

// ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูุนูุงุฑ
function showPropertyStatistics(propertyName) {
    const relatedProperties = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
    const propertyData = relatedProperties[0];

    if (!propertyData) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ');
        return;
    }

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalUnits = relatedProperties.length;
    const occupiedUnits = relatedProperties.filter(p => p['ุงุณู ุงููุณุชุฃุฌุฑ'] && p['ุงุณู ุงููุณุชุฃุฌุฑ'].trim() !== '').length;
    const emptyUnits = totalUnits - occupiedUnits;
    const totalArea = relatedProperties.reduce((sum, p) => sum + (parseFloat(p['ุงููุณุงุญุฉ']) || 0), 0);

    // ุญุณุงุจ ุงูุฅุฌูุงูู ุจุทุฑููุฉ ุฐููุฉ
    let yearlyTotal = 0;
    let totalInstallments = 0;

    relatedProperties.forEach(property => {
        if (!property['ุงุณู ุงููุณุชุฃุฌุฑ'] || property['ุงุณู ุงููุณุชุฃุฌุฑ'].toString().trim() === '') {
            return; // ุชุฌุงูู ุงููุญุฏุงุช ุงููุงุฑุบุฉ
        }

        const smartTotal = calculateSmartTotal(property);
        yearlyTotal += smartTotal.amount;

        // ุฅุถุงูุฉ ุนุฏุฏ ุงูุฃูุณุงุท ุฅุฐุง ูุงู ุงููุตุฏุฑ ูู ุงูุญุณุงุจ
        if (smartTotal.source === 'calculated') {
            const yearlyData = calculateYearlyTotal(property);
            totalInstallments += yearlyData.count;
        }
    });

    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุฅุญุตุงุฆูุงุช
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-box property-stats-modal">
            <button class="close-modal" onclick="closeModal()">ร</button>
            <div class="modal-header">
                <h2><i class="fas fa-chart-bar"></i> ุฅุญุตุงุฆูุงุช ุงูุนูุงุฑ</h2>
                <p>${propertyName}</p>
            </div>
            <div class="modal-content">
                <div class="management-section">
                    <h3><i class="fas fa-building"></i> ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
                    <div class="stats-grid">
                        ${propertyData['ุงูุณุฌู ุงูุนููู '] ? `
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-clipboard-list"></i> ุงูุณุฌู ุงูุนููู</div>
                            <div class="stat-value">${propertyData['ุงูุณุฌู ุงูุนููู ']}</div>
                        </div>` : ''}
                        ${propertyData['ุฑูู ุงูุตู'] ? `
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-file-contract"></i> ุฑูู ุงูุตู</div>
                            <div class="stat-value">${propertyData['ุฑูู ุงูุตู']}</div>
                        </div>` : ''}
                        ${propertyData['ูุณุงุญุฉุงูุตู'] ? `
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-ruler-combined"></i> ูุณุงุญุฉ ุงูุตู</div>
                            <div class="stat-value">${parseFloat(propertyData['ูุณุงุญุฉุงูุตู']).toLocaleString()} ูยฒ</div>
                        </div>` : ''}
                        ${propertyData['ุงููุงูู'] ? `
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-user"></i> ุงููุงูู</div>
                            <div class="stat-value">${propertyData['ุงููุงูู']}</div>
                        </div>` : ''}
                    </div>
                </div>

                <div class="management-section">
                    <h3><i class="fas fa-home"></i> ุฅุญุตุงุฆูุงุช ุงููุญุฏุงุช</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-building"></i> ุฅุฌูุงูู ุงููุญุฏุงุช</div>
                            <div class="stat-value">${totalUnits}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-check-circle"></i> ุงููุญุฏุงุช ุงููุดุบููุฉ</div>
                            <div class="stat-value occupied">${occupiedUnits}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-minus-circle"></i> ุงููุญุฏุงุช ุงููุงุฑุบุฉ</div>
                            <div class="stat-value empty">${emptyUnits}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-expand-arrows-alt"></i> ุฅุฌูุงูู ุงููุณุงุญุฉ</div>
                            <div class="stat-value">${totalArea.toLocaleString()} ูยฒ</div>
                        </div>
                    </div>
                </div>

                <div class="management-section">
                    <h3><i class="fas fa-money-bill-wave"></i> ุงูุฅุญุตุงุฆูุงุช ุงููุงููุฉ</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-calendar-alt"></i> ุฅุฌูุงูู ุนุงู ${currentCalculationYear}</div>
                            <div class="stat-value financial">${yearlyTotal.toLocaleString()} ุฑูุงู</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-list-ol"></i> ุนุฏุฏ ุงูุฃูุณุงุท</div>
                            <div class="stat-value">${totalInstallments}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-percentage"></i> ูุนุฏู ุงูุฅุดุบุงู</div>
                            <div class="stat-value">${totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label"><i class="fas fa-calculator"></i> ูุชูุณุท ุงููุณุท</div>
                            <div class="stat-value">${totalInstallments > 0 ? Math.round(yearlyTotal / totalInstallments).toLocaleString() : 0} ุฑูุงู</div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> ุฅุบูุงู
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // ุฅุถุงูุฉ ูุณุชูุน ูุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
    modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ==================== ูุธุงุฆู ุชุตููุฉ ุงููุฏู ูู ุตูุญุฉ ุงูุฅุฏุงุฑุฉ ====================

// ุชุจุฏูู ุนุฑุถ ูุงุฆูุฉ ุชุตููุฉ ุงููุฏู
function toggleCityFilter() {
    const filterList = document.getElementById('cityFilterList');
    const filterArrow = document.getElementById('filterArrow');
    const isVisible = filterList.classList.contains('show');

    if (isVisible) {
        closeCityFilter();
    } else {
        showCityFilter();
    }
}

// ุนุฑุถ ูุงุฆูุฉ ุชุตููุฉ ุงููุฏู
function showCityFilter() {
    const filterList = document.getElementById('cityFilterList');
    const filterArrow = document.getElementById('filterArrow');

    // ุฅุธูุงุฑ ุงููุงุฆูุฉ
    filterList.style.display = 'block';

    // ููุก ูุงุฆูุฉ ุงููุฏู ุจุงูุชุตููู ุงูุฌุฏูุฏ
    populateCitiesList();

    // ุชุญุฏูุซ ุนุฏุฏ ุฌููุน ุงููุฏู
    const allCitiesCount = document.getElementById('allCitiesCount');
    if (allCitiesCount) {
        allCitiesCount.textContent = getUniquePropertiesCount();
    }

    // ุชุญุฏูุซ ุญุงูุฉ "ุฌููุน ุงููุฏู"
    const allCitiesOption = filterList.querySelector('.all-cities');
    if (allCitiesOption) {
        if (selectedCityFilter === 'all') {
            allCitiesOption.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
        } else {
            allCitiesOption.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
        }
    }

    // ุชุญุฏูุซ ุงูุณูู
    if (filterArrow) {
        filterArrow.style.transform = 'rotate(180deg)';
        filterArrow.className = 'fas fa-chevron-up filter-arrow';
    }
}

// ุฅุบูุงู ูุงุฆูุฉ ุชุตููุฉ ุงููุฏู
function closeCityFilter() {
    const filterList = document.getElementById('cityFilterList');
    const filterArrow = document.getElementById('filterArrow');

    if (filterList) {
        filterList.style.display = 'none';
    }

    if (filterArrow) {
        filterArrow.style.transform = 'rotate(0deg)';
        filterArrow.className = 'fas fa-chevron-down filter-arrow';
    }
}



// ุงูุญุตูู ุนูู ุงููุฏู ุงููุฑูุฏุฉ ูู ุงูุนูุงุฑุงุช
function getUniqueCitiesFromProperties() {
    const cities = new Set();
    const uniqueProperties = getUniquePropertiesForManagement();

    uniqueProperties.forEach(propertyName => {
        const property = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
        if (property && property['ุงููุฏููุฉ']) {
            cities.add(property['ุงููุฏููุฉ']);
        }
    });

    return Array.from(cities).sort();
}

// ุงูุญุตูู ุนูู ุนุฏุฏ ุงูุนูุงุฑุงุช ูู ูุฏููุฉ ูุนููุฉ
function getPropertiesCountByCity(city) {
    const uniqueProperties = getUniquePropertiesForManagement();
    return uniqueProperties.filter(propertyName => {
        const property = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
        return property && property['ุงููุฏููุฉ'] === city;
    }).length;
}

// ุงูุญุตูู ุนูู ุงูุนุฏุฏ ุงูุฅุฌูุงูู ููุนูุงุฑุงุช ุงููุฑูุฏุฉ
function getUniquePropertiesCount() {
    return getUniquePropertiesForManagement().length;
}

// ุงูุญุตูู ุนูู ุงูุนูุงุฑุงุช ุงููุฑูุฏุฉ ูุตูุญุฉ ุงูุฅุฏุงุฑุฉ
function getUniquePropertiesForManagement() {
    const uniqueProperties = new Set();
    properties.forEach(property => {
        if (property['ุงุณู ุงูุนูุงุฑ'] && property['ุงุณู ุงูุนูุงุฑ'].trim() !== '') {
            uniqueProperties.add(property['ุงุณู ุงูุนูุงุฑ']);
        }
    });
    return Array.from(uniqueProperties);
}

// ุชุตููุฉ ุงูุนูุงุฑุงุช ุญุณุจ ุงููุฏููุฉ
function filterByCity(city) {
    selectedCityFilter = city;

    // ุชุญุฏูุซ ุงูุฃุฒุฑุงุฑ ุงููุดุทุฉ ูู ุงููุงุฆูุฉ
    const filterList = document.getElementById('cityFilterList');
    const cityOptions = filterList.querySelectorAll('.city-option');

    // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงููุฏู ูู ุงูููุฏุฑ ุฃูุถุงู
    updateCityButtonsActive(city);

    cityOptions.forEach(option => {
        option.classList.remove('active');
    });

    // ุชุญุฏูุฏ ุงูุฒุฑ ุงููุดุท
    if (city === 'all') {
        filterList.querySelector('.city-option').classList.add('active');
    } else {
        cityOptions.forEach(option => {
            const cityName = option.querySelector('span').textContent;
            if (cityName === city) {
                option.classList.add('active');
            }
        });
    }

    // ุฅุบูุงู ุงููุงุฆูุฉ (ุงุฎุชูุงุฑู - ูููู ุฅุจูุงุคูุง ููุชูุญุฉ)
    closeCityFilter();

    // ุชุญุฏูุซ ุนุฑุถ ุงูุนูุงุฑุงุช
    updatePropertiesDisplay();
}

// ุชุญุฏูุซ ุนุฑุถ ุงูุนูุงุฑุงุช ุจูุงุกู ุนูู ุงูุชุตููุฉ
function updatePropertiesDisplay() {
    const propertiesTab = document.getElementById('properties-tab');
    if (propertiesTab) {
        propertiesTab.innerHTML = renderPropertiesTab();
    }
}

// ุชุญุฏูุซ ุญุงูุฉ ุฃุฒุฑุงุฑ ุงููุฏู ุงููุดุทุฉ
function updateCityButtonsActive(activeCity) {
    const cityButtons = document.querySelectorAll('.city-btn');
    cityButtons.forEach(button => {
        const buttonCity = button.getAttribute('data-city');
        if (buttonCity === activeCity) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
}

// ุฅุถุงูุฉ ูุฏููุฉ ุฌุฏูุฏุฉ ุฅูู ุงููุธุงู
function addNewCityToSystem() {
    const cityNameInput = document.getElementById('newCityName');
    const cityName = cityNameInput.value.trim();

    if (!cityName) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุฏููุฉ');
        cityNameInput.focus();
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงููุฏููุฉ ูุณุจูุงู
    const existingCities = getUniqueCountries().filter(city => city !== 'ุงููู');
    if (existingCities.includes(cityName)) {
        alert('ูุฐู ุงููุฏููุฉ ููุฌูุฏุฉ ุจุงููุนู');
        cityNameInput.focus();
        return;
    }

    // ุฅุถุงูุฉ ุงููุฏููุฉ ุฅูู ูุงุฆูุฉ ุงููุฏู ุงููุชุงุญุฉ (ุจุฏูู ุฅูุดุงุก ุนูุงุฑุงุช ุฃู ูุญุฏุงุช ุงูุชุฑุงุถูุฉ)
    console.log(`โ ุชู ุฅุถุงูุฉ ุงููุฏููุฉ "${cityName}" ุฅูู ุงููุธุงู`);

    // ุฅุถุงูุฉ ุงููุฏููุฉ ุฅูู ูุตูููุฉ ุงููุฏู ุงููุนุฑูุฉ
    if (!cityDefinitions.includes(cityName)) {
        cityDefinitions.push(cityName);
        localStorage.setItem('cityDefinitions', JSON.stringify(cityDefinitions));
        console.log(`๐พ ุชู ุญูุธ ุงููุฏููุฉ "${cityName}" ูู ูุงุฆูุฉ ุงููุฏู ุงููุนุฑูุฉ`);
    }

    // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงููุฏู
    initCountryButtons();

    // ุชุญุฏูุซ ูุญุชูู ุงูุชุจููุจ
    updatePropertiesDisplay();

    // ุชูุธูู ุงูุญูู
    cityNameInput.value = '';

    // ุฑุณุงูุฉ ูุฌุงุญ
    alert(`ุชู ุฅุถุงูุฉ ูุฏููุฉ "${cityName}" ุจูุฌุงุญ!\nููููู ุงูุขู ุฅุถุงูุฉ ุนูุงุฑุงุช ูู ูุฐู ุงููุฏููุฉ.`);

    console.log(`โ ุชู ุฅุถุงูุฉ ุงููุฏููุฉ: ${cityName}`);
}

// ุฅุตูุงุญ ุงูุชูุงุฑูุฎ ุงููุญููุธุฉ ุจุดูู ุฎุงุทุฆ
function fixCorruptedDates() {
    try {
        console.log('๐ง ูุญุต ูุฅุตูุงุญ ุงูุชูุงุฑูุฎ ุงููุญููุธุฉ...');

        let fixedCount = 0;
        const dateFields = ['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ', 'ุชุงุฑูุฎ ุงูููุงูุฉ', 'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท'];

        properties.forEach((property, index) => {
            dateFields.forEach(field => {
                if (property[field]) {
                    const originalDate = property[field];
                    const fixedDate = fixSingleDate(originalDate);

                    if (fixedDate !== originalDate) {
                        console.log(`๐ง ุฅุตูุงุญ ุชุงุฑูุฎ ${field} ููุนูุงุฑ ${property['ุงุณู ุงูุนูุงุฑ'] || index}: ${originalDate} โ ${fixedDate}`);
                        property[field] = fixedDate;
                        fixedCount++;
                    }
                }
            });

            // ุฅุตูุงุญ ุชูุงุฑูุฎ ุงูุฃูุณุงุท
            for (let i = 1; i <= 20; i++) {
                const installmentDateKey = `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
                if (property[installmentDateKey]) {
                    const originalDate = property[installmentDateKey];
                    const fixedDate = fixSingleDate(originalDate);

                    if (fixedDate !== originalDate) {
                        console.log(`๐ง ุฅุตูุงุญ ${installmentDateKey} ููุนูุงุฑ ${property['ุงุณู ุงูุนูุงุฑ'] || index}: ${originalDate} โ ${fixedDate}`);
                        property[installmentDateKey] = fixedDate;
                        fixedCount++;
                    }
                }
            }
        });

        if (fixedCount > 0) {
            console.log(`โ ุชู ุฅุตูุงุญ ${fixedCount} ุชุงุฑูุฎ ูุญููุธ ุจุดูู ุฎุงุทุฆ`);

            // ุญูุธ ุงูุจูุงูุงุช ุงููุตุญุญุฉ
            saveDataLocally();

            // ุญูุธ ูู Supabase ุฅุฐุง ูุงู ูุชููุฑุงู
            if (typeof saveAllPropertiesToSupabase === 'function') {
                saveAllPropertiesToSupabase();
            }
        } else {
            console.log('โ ุฌููุน ุงูุชูุงุฑูุฎ ุตุญูุญุฉ');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุตูุงุญ ุงูุชูุงุฑูุฎ:', error);
    }
}

// ุฅุตูุงุญ ุชุงุฑูุฎ ูุงุญุฏ
function fixSingleDate(dateStr) {
    if (!dateStr) return dateStr;

    // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ูุญุชูู ุนูู ูุต ุนุฑุจูุ ุงุณุชุฎุฑุฌ ุงูุฌุฒุก ุงูุฑููู ููุท
    if (dateStr.includes('(') && dateStr.includes(')')) {
        const numericPart = dateStr.split('(')[0].trim();
        if (numericPart) {
            dateStr = numericPart;
        }
    }

    // ุชูุธูู ุงูุชุงุฑูุฎ ูู ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
    dateStr = dateStr.trim();

    // ูุญุต ุตูุบุฉ ุงูุชุงุฑูุฎ
    let datePart = dateStr.split(' ')[0];
    let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');

    if (parts.length !== 3) return dateStr;

    let day, month, year;

    // ุชุญุฏูุฏ ุตูุบุฉ ุงูุชุงุฑูุฎ
    if (parts[0].length === 4) {
        // yyyy-mm-dd ุฃู yyyy/mm/dd
        year = parseInt(parts[0]);
        month = parseInt(parts[1]);
        day = parseInt(parts[2]);
    } else {
        // dd/mm/yyyy ุฃู dd-mm-yyyy
        day = parseInt(parts[0]);
        month = parseInt(parts[1]);
        year = parseInt(parts[2]);
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
    if (isNaN(year) || isNaN(month) || isNaN(day) ||
        year < 1900 || year > 2100 ||
        month < 1 || month > 12 ||
        day < 1 || day > 31) {
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ: ${dateStr}`);
        return dateStr; // ุฅุฑุฌุงุน ุงูุชุงุฑูุฎ ุงูุฃุตูู ุฅุฐุง ูุงู ุบูุฑ ุตุญูุญ
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ ุจุงุณุชุฎุฏุงู Date object
    const testDate = new Date(year, month - 1, day);
    if (testDate.getFullYear() !== year || testDate.getMonth() !== (month - 1) || testDate.getDate() !== day) {
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุงูุญ: ${dateStr}`);
        return dateStr;
    }

    // ุฅุฑุฌุงุน ุงูุชุงุฑูุฎ ุจุตูุบุฉ dd/mm/yyyy
    return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
}

// ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู localStorage - ูุญุณู ูููุน ุชุญููู ุงูุชูุงุฑูุฎ
function restoreDataFromLocalStorage() {
    try {
        const savedData = localStorage.getItem('properties_backup');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            if (Array.isArray(parsedData) && parsedData.length > 0) {
                // ุชุฃูุฏ ูู ุฃู ุงูุชูุงุฑูุฎ ูู ุงูุตูุบุฉ ุงูุตุญูุญุฉ
                parsedData.forEach(property => {
                    // ุฅุตูุงุญ ุงูุชูุงุฑูุฎ ุงูุฃุณุงุณูุฉ
                    const dateFields = ['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ', 'ุชุงุฑูุฎ ุงูููุงูุฉ', 'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท'];
                    dateFields.forEach(field => {
                        if (property[field]) {
                            property[field] = ensureCorrectDateFormat(property[field]);
                        }
                    });

                    // ุฅุตูุงุญ ุชูุงุฑูุฎ ุงูุฃูุณุงุท
                    for (let i = 1; i <= 20; i++) {
                        const installmentDateKey = `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
                        if (property[installmentDateKey]) {
                            property[installmentDateKey] = ensureCorrectDateFormat(property[installmentDateKey]);
                        }
                    }
                });

                properties = parsedData;
                console.log(`โ ุชู ุงุณุชุนุงุฏุฉ ${parsedData.length} ุนูุงุฑ ูู localStorage ูุน ุฅุตูุงุญ ุงูุชูุงุฑูุฎ`);

                // ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ุจุนุฏ ุชุญููู ุงูุจูุงูุงุช
                setTimeout(() => {
                    if (currentUser) {
                        console.log('๐ ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ูู restoreDataFromLocalStorage');
                        addLogoutButton();
                    }
                }, 100);

                return true;
            }
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู localStorage:', error);
    }
    return false;
}

// ุถูุงู ุตูุบุฉ ุงูุชุงุฑูุฎ ุงูุตุญูุญุฉ - ูุญุณู ูููุน ุงูุชูุงุฑูุฎ ุงูุนุดูุงุฆูุฉ
function ensureCorrectDateFormat(dateStr) {
    if (!dateStr) return dateStr;

    // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ูุญุชูู ุนูู ูุต ุนุฑุจูุ ุงุณุชุฎุฑุฌ ุงูุฌุฒุก ุงูุฑููู ููุท
    if (typeof dateStr === 'string' && dateStr.includes('(') && dateStr.includes(')')) {
        const numericPart = dateStr.split('(')[0].trim();
        if (numericPart) {
            dateStr = numericPart;
        }
    }

    // ุชูุธูู ุงูุชุงุฑูุฎ ูู ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
    dateStr = dateStr.toString().trim();

    // ุฅุฐุง ูุงู ุจุตูุบุฉ dd/mm/yyyyุ ุชุญูู ูู ุตุญุชู ูุฃุจูู ููุง ูู
    if (typeof dateStr === 'string' && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
        const parts = dateStr.split('/');
        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]);
        const year = parseInt(parts[2]);

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
        if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
            // ุงูุชุญูู ุงูุฅุถุงูู ุจุงุณุชุฎุฏุงู Date object ูุชุฌูุจ ุชูุงุฑูุฎ ูุซู 31 ูุจุฑุงูุฑ
            const testDate = new Date(year, month - 1, day, 12, 0, 0);
            if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
            }
        }
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ ูู ensureCorrectDateFormat: ${dateStr}`);
        return dateStr; // ุฅุฑุฌุงุน ุงูุฃุตูู ุฅุฐุง ูุงู ุบูุฑ ุตุญูุญ
    }

    // ุฅุฐุง ูุงู ุจุตูุบุฉ yyyy-mm-ddุ ุญููู ุฅูู dd/mm/yyyy
    if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}/)) {
        const parts = dateStr.split('-');
        if (parts.length >= 3) {
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);

            // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                // ุงูุชุญูู ุงูุฅุถุงูู ุจุงุณุชุฎุฏุงู Date object
                const testDate = new Date(year, month - 1, day, 12, 0, 0);
                if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                    return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                }
            }
        }
        console.warn(`ุชุงุฑูุฎ ุบูุฑ ุตุญูุญ ูู ensureCorrectDateFormat: ${dateStr}`);
        return dateStr; // ุฅุฑุฌุงุน ุงูุฃุตูู ุฅุฐุง ูุงู ุบูุฑ ุตุญูุญ
    }

    // ุฅุฐุง ูุงู ุชุงุฑูุฎ ุบูุฑ ุตุญูุญุ ุฃุฑุฌุน ุงูุฃุตูู
    return dateStr;
}

// ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุชูุงุฑูุฎ ูุถูุงู ุนุฏู ุญุฏูุซ ุชุบููุฑ ุนุดูุงุฆู
function testDateHandling() {
    console.log('๐งช ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุชูุงุฑูุฎ...');

    const testDates = [
        '2/1/2025',    // 2nd January 2025
        '15/3/2024',   // 15th March 2024
        '31/12/2023',  // 31st December 2023
        '1/6/2025',    // 1st June 2025
        '29/2/2024',   // 29th February 2024 (leap year)
        '2025-01-02',  // ISO format
        '2024-03-15'   // ISO format
    ];

    testDates.forEach(testDate => {
        console.log(`\n๐ ุงุฎุชุจุงุฑ ุงูุชุงุฑูุฎ: ${testDate}`);

        // Test formatDateForInput
        const inputFormat = formatDateForInput(testDate);
        console.log(`  formatDateForInput: ${testDate} โ ${inputFormat}`);

        // Test ensureCorrectDateFormat
        const correctFormat = ensureCorrectDateFormat(testDate);
        console.log(`  ensureCorrectDateFormat: ${testDate} โ ${correctFormat}`);

        // Test parseDate
        const parsedDate = parseDate(testDate);
        console.log(`  parseDate: ${testDate} โ ${parsedDate ? parsedDate.toDateString() : 'null'}`);

        // Test round-trip conversion
        if (inputFormat) {
            const backToDisplay = ensureCorrectDateFormat(inputFormat);
            console.log(`  Round-trip: ${testDate} โ ${inputFormat} โ ${backToDisplay}`);

            // Check if original date is preserved
            if (testDate.includes('/') && backToDisplay === testDate) {
                console.log(`  โ ุงูุชุงุฑูุฎ ูุญููุธ ุจุดูู ุตุญูุญ`);
            } else if (testDate.includes('-') && backToDisplay) {
                console.log(`  โ ุงูุชุงุฑูุฎ ูุญูู ุจุดูู ุตุญูุญ`);
            } else {
                console.warn(`  โ๏ธ ูุฏ ูููู ููุงู ูุดููุฉ ูู ุงูุชุญููู`);
            }
        }
    });

    console.log('\nโ ุงูุชูู ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุชูุงุฑูุฎ');
}

// ุงุฎุชุจุงุฑ ุฅุตูุงุญ ูุดููุฉ ุงูุชุงุฑูุฎ
function testDateFix() {
    console.log('๐ง ุงุฎุชุจุงุฑ ุฅุตูุงุญ ูุดููุฉ ุงูุชุงุฑูุฎ...');

    // ุงูุชุงุฑูุฎ ุงูุฐู ูุงู ูุณุจุจ ุงููุดููุฉ
    const problematicDate = '15/11/2020';

    console.log(`๐ ุงูุชุงุฑูุฎ ุงูุฃุตูู: ${problematicDate}`);

    // ุงุฎุชุจุงุฑ formatDateForStorage
    const fixedFormat = formatDateForStorage(problematicDate);
    console.log(`๐ง ุจุนุฏ formatDateForStorage: ${fixedFormat}`);

    // ุงุฎุชุจุงุฑ ุตุญุฉ ุงูุชุงุฑูุฎ ูู Supabase
    try {
        const testDate = new Date(fixedFormat);
        if (!isNaN(testDate.getTime())) {
            console.log(`โ ุงูุชุงุฑูุฎ ุตุงูุญ ูู Supabase: ${testDate.toISOString()}`);
            console.log(`โ ุชู ุญู ุงููุดููุฉ ุจูุฌุงุญ!`);
        } else {
            console.log(`โ ุงูุชุงุฑูุฎ ูุง ูุฒุงู ุบูุฑ ุตุงูุญ`);
        }
    } catch (error) {
        console.log(`โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุงูุชุงุฑูุฎ: ${error.message}`);
    }

    // ุงุฎุชุจุงุฑ ุชูุงุฑูุฎ ุฃุฎุฑู
    const testDates = ['1/1/2023', '31/12/2024', '29/2/2024'];
    testDates.forEach(date => {
        const converted = formatDateForStorage(date);
        const isValid = !isNaN(new Date(converted).getTime());
        console.log(`๐ ${date} โ ${converted} ${isValid ? 'โ' : 'โ'}`);
    });
}

// ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
function saveDataLocally() {
    try {
        // ุญูุธ ูู localStorage ููุณุฎุฉ ุงุญุชูุงุทูุฉ
        localStorage.setItem('properties_backup', JSON.stringify(properties));

        // ูุญุงููุฉ ุญูุธ ูู ููู JSON (ูุนูู ููุท ูู ุจูุฆุฉ ุงูุชุทููุฑ)
        if (typeof saveToFile === 'function') {
            saveToFile();
        }

        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู:', error);
    }
}

// ูุธููุฉ ูุณุงุนุฏุฉ ูุญูุธ ุงูุจูุงูุงุช ูู ููู
function saveToFile() {
    try {
        const dataStr = JSON.stringify(properties, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        // ุฅูุดุงุก ุฑุงุจุท ุชุญููู
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'data_updated.json';

        // ุชุญููู ุงูููู ุชููุงุฆูุงู (ุงุฎุชูุงุฑู)
        // link.click();

        console.log('โ ุชู ุฅุนุฏุงุฏ ููู ุงูุจูุงูุงุช ููุชุญููู');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุนุฏุงุฏ ููู ุงูุจูุงูุงุช:', error);
    }
}

// ุชูุธูู ุงูุนูุงุฑุงุช ุงููุคูุชุฉ (ูููุฏู ููุท)
function cleanupTempCityProperties() {
    const originalLength = properties.length;
    properties = properties.filter(property => !property.temp_city_marker);
    const removedCount = originalLength - properties.length;

    if (removedCount > 0) {
        console.log(`๐งน ุชู ุญุฐู ${removedCount} ุนูุงุฑ ูุคูุช ูููุฏู`);

        // ุชุญุฏูุซ ุงูุนุฑุถ
        updatePropertiesDisplay();
        initCountryButtons();

        // ุญูุธ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
        saveDataLocally();
    }
}

// ุฌุนู ุงููุธููุฉ ูุชุงุญุฉ ุนุงูููุงู ููุงุณุชุฎุฏุงู ูู console
window.cleanupTempCityProperties = cleanupTempCityProperties;

// ุชููุฆุฉ ูุงุฆูุฉ ุชุตููุฉ ุงููุฏู
function initializeCityFilter() {
    // ุชุญุฏูุซ ุนุฏุฏ ุฌููุน ุงููุฏู
    const allCitiesCount = document.getElementById('allCitiesCount');
    if (allCitiesCount) {
        allCitiesCount.textContent = getUniquePropertiesCount();
    }

    // ุฅุนุงุฏุฉ ุชุนููู ุงูุชุตููุฉ ุฅูู "ุฌููุน ุงููุฏู"
    selectedCityFilter = 'all';

    // ุฅุบูุงู ุงููุงุฆูุฉ ุฅุฐุง ูุงูุช ููุชูุญุฉ
    closeCityFilter();

    // ููุก ูุงุฆูุฉ ุงููุฏู ุจุงูุชุตููู ุงูุฌุฏูุฏ
    populateCitiesList();
}

// ููุก ูุงุฆูุฉ ุงููุฏู ุจุชุตููู OL/LI ูุญุณู
function populateCitiesList() {
    const citiesContainer = document.getElementById('citiesContainer');
    if (!citiesContainer) return;

    const cities = getUniqueCountries().filter(city => city !== 'ุงููู');
    citiesContainer.innerHTML = '';

    cities.forEach((city, index) => {
        const cityCount = properties.filter(p => p['ุงููุฏููุฉ'] === city).length;

        // ุฅูุดุงุก ุนูุตุฑ li ูููุฏููุฉ
        const cityElement = document.createElement('li');
        cityElement.className = 'city-item';
        cityElement.onclick = () => filterByCity(city);

        // ุชุทุจูู CSS ูุจุงุดุฑ ููุนูุตุฑ
        cityElement.style.cssText = `
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Arial, sans-serif;
            font-weight: 600;
            position: relative;
            counter-increment: city-counter;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        `;

        // ุฅุถุงูุฉ ุชุฃุซูุฑุงุช hover
        cityElement.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
            this.style.color = 'white';
            this.style.transform = 'translateX(-5px)';
            this.style.boxShadow = '0 4px 15px rgba(0, 123, 255, 0.3)';

            // ุชุบููุฑ ููู ุงูุฃููููุฉ ูุงูุนุฏุงุฏ
            const icon = this.querySelector('.city-icon');
            const count = this.querySelector('.city-count');
            if (icon) icon.style.color = 'white';
            if (count) {
                count.style.background = 'rgba(255, 255, 255, 0.2)';
                count.style.color = 'white';
            }
        });

        cityElement.addEventListener('mouseleave', function() {
            this.style.background = 'white';
            this.style.color = '#2c3e50';
            this.style.transform = 'translateX(0)';
            this.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.08)';

            // ุฅุนุงุฏุฉ ููู ุงูุฃููููุฉ ูุงูุนุฏุงุฏ
            const icon = this.querySelector('.city-icon');
            const count = this.querySelector('.city-count');
            if (icon) icon.style.color = '#007bff';
            if (count) {
                count.style.background = '#e9ecef';
                count.style.color = '#495057';
            }
        });

        cityElement.innerHTML = `
            <!-- ุฑูู ุงููุฏููุฉ -->
            <span style="
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                width: 25px;
                height: 25px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.6rem;
                font-weight: 700;
                flex-shrink: 0;
            ">${index + 1}</span>

            <!-- ุฃููููุฉ ุงููุฏููุฉ -->
            <i class="fas fa-map-marker-alt city-icon" style="
                color: #007bff;
                font-size: 0.9rem;
                flex-shrink: 0;
            "></i>

            <!-- ุงุณู ุงููุฏููุฉ -->
            <span style="
                flex: 1;
                font-size: 0.9rem;
                color: #2c3e50;
                font-weight: 600;
                text-align: right;
            ">${city}</span>

            <!-- ุนุฏุงุฏ ุงูุนูุงุฑุงุช -->
            <span class="city-count" style="
                background: #e9ecef;
                color: #495057;
                padding: 3px 6px;
                border-radius: 10px;
                font-size: 0.7rem;
                font-weight: 700;
                min-width: 20px;
                text-align: center;
                flex-shrink: 0;
            ">${cityCount}</span>
        `;

        citiesContainer.appendChild(cityElement);
    });
}

// ==================== ูุธุงุฆู ุงูููุฏุฑ ุงูุฌุฏูุฏ ====================

// ุชุจุฏูู ุงูููุงุฆู ุงูููุณุฏูุฉ ูู ุงูููุฏุฑ
function toggleHeaderDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId + 'Dropdown');
    const button = dropdown.previousElementSibling;

    // ูุญุต ุญุงูุฉ ุงููุงุฆูุฉ ุงูุญุงููุฉ ูุจู ุฅุบูุงู ุงูุฃุฎุฑูุงุช
    const isCurrentlyOpen = dropdown.classList.contains('show');

    // ุฅุบูุงู ุฌููุน ุงูููุงุฆู ุงูุฃุฎุฑู
    closeAllDropdowns();

    // ุชุจุฏูู ุงููุงุฆูุฉ ุงูุญุงููุฉ ุจูุงุกู ุนูู ุญุงูุชูุง ุงูุณุงุจูุฉ
    if (!isCurrentlyOpen) {
        // ุฅุฐุง ูุงูุช ูุบููุฉุ ุงูุชุญูุง
        dropdown.classList.add('show');
        button.classList.add('active');
    }
    // ุฅุฐุง ูุงูุช ููุชูุญุฉุ ุชุจูู ูุบููุฉ (ุชู ุฅุบูุงููุง ุจูุงุณุทุฉ closeAllDropdowns)
}

// ุฅุบูุงู ุฌููุน ุงูููุงุฆู ุงูููุณุฏูุฉ
function closeAllDropdowns() {
    const dropdowns = document.querySelectorAll('.dropdown-menu');
    const buttons = document.querySelectorAll('.dropdown-toggle');

    dropdowns.forEach(dropdown => {
        dropdown.classList.remove('show');
    });

    buttons.forEach(button => {
        button.classList.remove('active');
    });
}

// ุฅุบูุงู ุงูููุงุฆู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
document.addEventListener('click', function(event) {
    if (!event.target.closest('.header-dropdown')) {
        closeAllDropdowns();
    }
});

// ุฏูุงู ุงูููุงุชุฑ ูุงูุฅุนุฏุงุฏุงุช
function showMonthFilter() {
    // ุงุณุชุฏุนุงุก ููุณ ุงููุธููุฉ ุงููุณุชุฎุฏูุฉ ูู ุงูุฒุฑ ุงููุฏูู
    if (typeof showMonthFilterModal === 'function') {
        showMonthFilterModal();
    } else {
        // ุงูุจุญุซ ุนู ุงูุฒุฑ ุงููุฏูู ูุชุดุบููู
        const oldBtn = document.getElementById('monthFilterBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function showMultiPropertyFilter() {
    // ุงุณุชุฏุนุงุก ููุณ ุงููุธููุฉ ุงููุณุชุฎุฏูุฉ ูู ุงูุฒุฑ ุงููุฏูู
    if (typeof showMultiPropertyCityFilter === 'function') {
        showMultiPropertyCityFilter();
    } else {
        const oldBtn = document.getElementById('multiPropertyFilterBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function showContractTypeFilterFromDropdown() {
    // ุงุณุชุฏุนุงุก ูุธููุฉ ููุชุฑ ููุน ุงูุนูุฏ ุงูุฃุตููุฉ
    const originalFunction = window.showContractTypeFilter;
    if (originalFunction && typeof originalFunction === 'function') {
        originalFunction();
    } else {
        // ุชุดุบูู ููุณ ููุทู ุงูุฒุฑ ุงููุฏูู
        const oldBtn = document.getElementById('contractTypeFilterBtn');
        if (oldBtn) {
            oldBtn.click();
        }
    }
}

function showStatusFilterFromDropdown() {
    // ุงุณุชุฏุนุงุก ูุธููุฉ ููุชุฑ ุงูุญุงูุฉ ุงูุฃุตููุฉ ูุจุงุดุฑุฉ
    try {
        showStatusFilter();
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุงุณุชุฏุนุงุก ููุชุฑ ุงูุญุงูุฉ:', error);
        // ุฅูุดุงุก ููุชุฑ ุงูุญุงูุฉ ูุฏููุงู ูุจุฏูู
        const filterContainer = document.getElementById('headerFilters');
        if (filterContainer) {
            filterContainer.innerHTML = `
                <div class="status-filter-container">
                    <select id="statusFilter" onchange="setStatusFilter(this.value === '' ? null : this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                        <option value="ุฌุงุฑู">ุฌุงุฑู</option>
                        <option value="ููุชูู">ููุชูู</option>
                        <option value="ุนูู ูุดู">ุนูู ูุดู</option>
                        <option value="ูุงุฑุบ">ูุงุฑุบ</option>
                    </select>
                </div>
            `;
        }
    }
}

function showAttachmentsManagerFromDropdown() {
    // ุงุณุชุฏุนุงุก ูุธููุฉ ุฅุฏุงุฑุฉ ุงููุฑููุงุช ุงูุฃุตููุฉ
    const originalFunction = window.showAttachmentsManager;
    if (originalFunction && typeof originalFunction === 'function') {
        originalFunction();
    } else {
        const oldBtn = document.getElementById('attachmentsManagerBtn');
        if (oldBtn) {
            oldBtn.click();
        }
    }
}

function switchToTableView() {
    // ุชุดุบูู ููุณ ูุธููุฉ ุงูุชุจุฏูู ููุฌุฏูู
    if (typeof toggleView === 'function') {
        toggleView('table');
    }
}

function switchToCardView() {
    // ุชุดุบูู ููุณ ูุธููุฉ ุงูุชุจุฏูู ููุจุทุงูุงุช
    if (typeof toggleView === 'function') {
        toggleView('cards');
    }
}

function showPropertyManagerFromDropdown() {
    // ุงุณุชุฏุนุงุก ูุธููุฉ ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช ุงูุฃุตููุฉ
    const originalFunction = window.showPropertyManager;
    if (originalFunction && typeof originalFunction === 'function') {
        originalFunction();
    } else {
        const oldBtn = document.getElementById('propertyManagerBtn');
        if (oldBtn) {
            oldBtn.click();
        }
    }
}

function updateDateSettings() {
    // ุชุดุบูู ููุณ ูุธููุฉ ุชุญุฏูุซ ุงูุชูุงุฑูุฎ
    if (typeof showDateUpdateModal === 'function') {
        showDateUpdateModal();
    } else {
        const oldBtn = document.getElementById('updateDatesBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function cleanStorage() {
    // ุชุดุบูู ููุณ ูุธููุฉ ุชูุธูู ุงูุชุฎุฒูู
    if (typeof showStorageCleanupModal === 'function') {
        showStorageCleanupModal();
    } else {
        const oldBtn = document.getElementById('cleanStorageBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function importData() {
    // ุชุดุบูู ููุณ ูุธููุฉ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช
    if (typeof showDataImportModal === 'function') {
        showDataImportModal();
    } else {
        const oldBtn = document.getElementById('dataImportBtn');
        if (oldBtn && oldBtn.onclick) {
            oldBtn.onclick();
        }
    }
}

function saveAllData() {
    // ุญูุธ ุฌููุน ุงูุจูุงูุงุช ูุญููุงู
    try {
        if (typeof saveDataLocally === 'function') {
            saveDataLocally();
        } else {
            // ุญูุธ ุงูุจูุงูุงุช ูู localStorage
            localStorage.setItem('properties', JSON.stringify(properties));
            localStorage.setItem('attachments', JSON.stringify(attachments));
            localStorage.setItem('cardAttachments', JSON.stringify(cardAttachments));
        }
        alert('โ ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู ุจูุฌุงุญ!');
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', error);
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุจูุงูุงุช');
    }
}

function repairAllData() {
    // ุฅุตูุงุญ ุงูุจูุงูุงุช
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุตูุงุญ ุงูุจูุงูุงุชุ ูุฏ ูุณุชุบุฑู ูุฐุง ุจุนุถ ุงูููุช.')) {
        try {
            // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช
            if (typeof recalculateAllTotals === 'function') {
                recalculateAllTotals();
            }

            // ุญูุธ ุงูุจูุงูุงุช
            saveAllData();

            // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู
            if (typeof initializeApp === 'function') {
                initializeApp();
            }

            alert('โ ุชู ุฅุตูุงุญ ุงูุจูุงูุงุช ุจูุฌุงุญ!');
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุฅุตูุงุญ ุงูุจูุงูุงุช:', error);
            alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุตูุงุญ ุงูุจูุงูุงุช');
        }
    }
}

function updateSupabaseData() {
    // ุชุญุฏูุซ ุจูุงูุงุช Supabase
    if (typeof updateAllSupabaseData === 'function') {
        updateAllSupabaseData();
    } else if (typeof syncToSupabase === 'function') {
        syncToSupabase();
    } else {
        alert('โ๏ธ ูุธููุฉ ุชุญุฏูุซ Supabase ุบูุฑ ูุชููุฑุฉ ุญุงููุงู');
    }
}

// ==================== ูุธุงุฆู ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช ====================

// ูุชุบูุฑุงุช ุนุงูุฉ ูุชุญุฏูุซ ุงูุฅุฌูุงููุงุช
let updateTotalsData = null;
let updateTotalsPreview = [];

// ุฅุธูุงุฑ ูุงูุฐุฉ ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช
function showUpdateTotalsModal() {
    const modalHtml = `
        <div class="update-totals-modal" id="updateTotalsModal">
            <div class="update-totals-content">
                <div class="update-totals-header">
                    <h2 class="update-totals-title">
                        <i class="fas fa-calculator"></i>
                        ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช
                    </h2>
                    <button class="update-totals-close" onclick="closeUpdateTotalsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="totals-upload-zone" onclick="document.getElementById('totalsFileInput').click()">
                    <div class="totals-upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="totals-upload-text">
                        ุงุณุญุจ ุงูููู ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ
                    </div>
                    <div class="totals-upload-hint">
                        ูุฏุนู: JSON, Excel (.xlsx, .xls), CSV<br>
                        <small style="color: #6c757d; font-size: 0.8rem;">
                            ูุซุงู JSON: [{"ุฑูู ุงููุญุฏุฉ": 101, "ุงูุฅุฌูุงูู": 50000}]<br>
                            ูุซุงู CSV: ุฑูู ุงููุญุฏุฉ,ุงูุฅุฌูุงูู<br>101,50000
                        </small>
                    </div>
                    <input type="file" id="totalsFileInput" class="totals-file-input"
                           accept=".json,.xlsx,.xls,.csv" onchange="handleTotalsFileUpload(this.files[0])">
                </div>

                <div class="totals-preview" id="totalsPreview">
                    <div class="totals-preview-header">
                        <h4>ูุนุงููุฉ ุงูุจูุงูุงุช</h4>
                        <span id="totalsPreviewCount"></span>
                    </div>
                    <div class="totals-preview-content">
                        <table class="totals-preview-table" id="totalsPreviewTable">
                            <thead>
                                <tr>
                                    <th>ุฑูู ุงููุญุฏุฉ</th>
                                    <th>ุงูุฅุฌูุงูู ุงูุฌุฏูุฏ</th>
                                    <th>ุงูุฅุฌูุงูู ุงูุญุงูู</th>
                                    <th>ุงูุญุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody id="totalsPreviewBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="totals-actions">
                    <div>
                        <button class="totals-btn totals-btn-secondary" onclick="closeUpdateTotalsModal()">
                            <i class="fas fa-times"></i>
                            ุฅูุบุงุก
                        </button>
                    </div>
                    <div>
                        <button class="totals-btn totals-btn-success" id="applyTotalsBtn"
                                onclick="applyTotalsUpdate()" disabled>
                            <i class="fas fa-check"></i>
                            ุชุทุจูู ุงูุชุญุฏูุซุงุช
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // ุฅุธูุงุฑ ุงููุงูุฐุฉ ูุน ุชุฃุซูุฑ
    setTimeout(() => {
        document.getElementById('updateTotalsModal').classList.add('show');
    }, 100);

    // ุฅุนุฏุงุฏ drag & drop
    setupTotalsDragAndDrop();
}

// ุฅุบูุงู ูุงูุฐุฉ ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช
function closeUpdateTotalsModal() {
    const modal = document.getElementById('updateTotalsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
            updateTotalsData = null;
            updateTotalsPreview = [];
        }, 300);
    }
}

// ุฅุนุฏุงุฏ drag & drop ูุชุญุฏูุซ ุงูุฅุฌูุงููุงุช
function setupTotalsDragAndDrop() {
    const uploadZone = document.querySelector('.totals-upload-zone');
    if (!uploadZone) return;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        uploadZone.classList.add('dragover');
    }

    function unhighlight() {
        uploadZone.classList.remove('dragover');
    }

    uploadZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            handleTotalsFileUpload(files[0]);
        }
    }
}

// ูุนุงูุฌุฉ ุฑูุน ููู ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช
async function handleTotalsFileUpload(file) {
    if (!file) return;

    console.log('๐ ุจุฏุก ูุนุงูุฌุฉ ููู ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช:', file.name);

    // ุงูุชุญูู ูู ููุน ุงูููู
    const allowedTypes = [
        'application/json',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel',
        'text/csv'
    ];

    const fileExtension = file.name.split('.').pop().toLowerCase();
    const allowedExtensions = ['json', 'xlsx', 'xls', 'csv'];

    if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
        alert('โ ููุน ุงูููู ุบูุฑ ูุฏุนูู. ูุฑุฌู ุงุฎุชูุงุฑ ููู JSON ุฃู Excel ุฃู CSV');
        return;
    }

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        const uploadZone = document.querySelector('.totals-upload-zone');
        uploadZone.innerHTML = `
            <div class="totals-upload-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="totals-upload-text">
                ุฌุงุฑู ูุนุงูุฌุฉ ุงูููู...
            </div>
        `;

        let data = null;

        if (fileExtension === 'json') {
            data = await parseJSONFile(file);
        } else if (fileExtension === 'csv') {
            data = await parseCSVFile(file);
        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
            data = await parseExcelFile(file);
        }

        if (data && data.length > 0) {
            updateTotalsData = data;
            await generateTotalsPreview(data);

            // ุฅุนุงุฏุฉ ุชุนููู ููุทูุฉ ุงูุฑูุน
            uploadZone.innerHTML = `
                <div class="totals-upload-icon">
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                </div>
                <div class="totals-upload-text" style="color: #28a745;">
                    ุชู ุชุญููู ุงูููู ุจูุฌุงุญ
                </div>
                <div class="totals-upload-hint">
                    ${data.length} ุนูุตุฑ ุชู ุงูุนุซูุฑ ุนููู
                </div>
            `;
        } else {
            throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุตุงูุญุฉ ูู ุงูููู');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูููู:', error);
        alert('โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูููู: ' + error.message);

        // ุฅุนุงุฏุฉ ุชุนููู ููุทูุฉ ุงูุฑูุน
        const uploadZone = document.querySelector('.totals-upload-zone');
        uploadZone.innerHTML = `
            <div class="totals-upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="totals-upload-text">
                ุงุณุญุจ ุงูููู ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ
            </div>
            <div class="totals-upload-hint">
                ูุฏุนู: JSON, Excel (.xlsx, .xls), CSV
            </div>
        `;
    }
}

// ุชุญููู ููู JSON
async function parseJSONFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);

                // ุงูุชุญูู ูู ุตูุบุฉ ุงูุจูุงูุงุช
                if (Array.isArray(data)) {
                    resolve(data);
                } else if (data && typeof data === 'object') {
                    // ุฅุฐุง ูุงู ูุงุฆูุ ุญุงูู ุงุณุชุฎุฑุงุฌ ุงููุตูููุฉ
                    const keys = Object.keys(data);
                    const arrayKey = keys.find(key => Array.isArray(data[key]));
                    if (arrayKey) {
                        resolve(data[arrayKey]);
                    } else {
                        resolve([data]);
                    }
                } else {
                    reject(new Error('ุตูุบุฉ ููู JSON ุบูุฑ ุตุญูุญุฉ'));
                }
            } catch (error) {
                reject(new Error('ุฎุทุฃ ูู ุชุญููู ููู JSON: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู'));
        reader.readAsText(file);
    });
}

// ุชุญููู ููู CSV
async function parseCSVFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    reject(new Error('ููู CSV ูุฌุจ ุฃู ูุญุชูู ุนูู ุฑุฃุณ ูุจูุงูุงุช'));
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};

                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });

                    data.push(row);
                }

                resolve(data);
            } catch (error) {
                reject(new Error('ุฎุทุฃ ูู ุชุญููู ููู CSV: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู'));
        reader.readAsText(file);
    });
}

// ุชุญููู ููู Excel (ูุชุทูุจ ููุชุจุฉ ุฎุงุฑุฌูุฉ ุฃู ุชุญููู ุฅูู CSV)
async function parseExcelFile(file) {
    // ููุจุณุงุทุฉุ ุณูุทูุจ ูู ุงููุณุชุฎุฏู ุชุญููู Excel ุฅูู CSV
    // ูู ุงูุชุทุจูู ุงูุญููููุ ูููู ุงุณุชุฎุฏุงู ููุชุจุฉ ูุซู SheetJS
    console.log('๐ ูุญุงููุฉ ุชุญููู ููู Excel:', file.name);
    throw new Error('ูุฑุฌู ุชุญููู ููู Excel ุฅูู CSV ุฃู JSON ุฃููุงู');
}

// ุฅูุดุงุก ูุนุงููุฉ ุงูุจูุงูุงุช
async function generateTotalsPreview(data) {
    console.log('๐ ุฅูุดุงุก ูุนุงููุฉ ุงูุจูุงูุงุช...', data.length, 'ุนูุตุฑ');

    updateTotalsPreview = [];
    const previewBody = document.getElementById('totalsPreviewBody');
    const previewCount = document.getElementById('totalsPreviewCount');
    const applyBtn = document.getElementById('applyTotalsBtn');

    if (!previewBody) return;

    previewBody.innerHTML = '';

    let validUpdates = 0;
    let newProperties = 0;
    let errors = 0;

    for (const item of data) {
        // ุงูุจุญุซ ุนู ุงูููุงุชูุญ ุงููุญุชููุฉ ูุฑูู ุงููุญุฏุฉ
        const unitNumberKeys = ['ุฑูู ุงููุญุฏุฉ', 'unit_number', 'unitNumber', 'ุฑูู_ุงููุญุฏุฉ', 'Unit Number'];
        const totalKeys = ['ุงูุฅุฌูุงูู', 'total', 'Total', 'ุฅุฌูุงูู', 'ุงููุจูุบ', 'amount', 'Amount'];

        let unitNumber = null;
        let newTotal = null;

        // ุงูุจุญุซ ุนู ุฑูู ุงููุญุฏุฉ
        for (const key of unitNumberKeys) {
            if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
                // ุงูุชุนุงูู ูุน ุงูุฃุฑูุงู ูุงููุตูุต
                if (typeof item[key] === 'number') {
                    unitNumber = item[key].toString();
                } else {
                    unitNumber = item[key].toString().trim();
                }

                // ุงูุชุญูู ูู ูุฌูุฏ ูููุฉ ุตุงูุญุฉ
                if (unitNumber && unitNumber !== 'undefined' && unitNumber !== 'null') {
                    break;
                } else {
                    unitNumber = null;
                }
            }
        }

        // ุงูุจุญุซ ุนู ุงูุฅุฌูุงูู
        for (const key of totalKeys) {
            if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
                // ุงูุชุนุงูู ูุน ุงูุฃุฑูุงู ุงููุจุงุดุฑุฉ ูู JSON ูุงููุตูุต
                if (typeof item[key] === 'number') {
                    newTotal = item[key];
                } else {
                    newTotal = parseFloat(item[key].toString().replace(/[^\d.-]/g, ''));
                }

                // ุงูุชุญูู ูู ุตุญุฉ ุงูุฑูู
                if (!isNaN(newTotal) && newTotal > 0) {
                    break;
                } else {
                    newTotal = null;
                }
            }
        }

        if (!unitNumber || isNaN(newTotal)) {
            console.warn('โ๏ธ ุชุฎุทู ุนูุตุฑ ุบูุฑ ุตุงูุญ:', {
                unitNumber,
                newTotal,
                originalItem: item
            });
            errors++;
            continue;
        }

        console.log('โ ุนูุตุฑ ุตุงูุญ:', {
            unitNumber,
            newTotal,
            type: typeof newTotal
        });

        // ุงูุจุญุซ ุนู ุงูุนูุงุฑ ูู ุงููุธุงู (ูุน ุงูุชุญูู ูู ููุง ุงูุตูุบุชูู ูุฑูู ุงููุญุฏุฉ)
        const existingProperty = properties.find(p =>
            (p['ุฑูู ุงููุญุฏุฉ'] && p['ุฑูู ุงููุญุฏุฉ'].toString().trim() === unitNumber) ||
            (p['ุฑูู  ุงููุญุฏุฉ '] && p['ุฑูู  ุงููุญุฏุฉ '].toString().trim() === unitNumber)
        );

        let currentTotal = 0;
        let status = '';
        let statusClass = '';

        if (existingProperty) {
            // ุญุณุงุจ ุงูุฅุฌูุงูู ุงูุญุงูู
            const smartTotal = calculateSmartTotal(existingProperty);
            currentTotal = smartTotal.amount;

            if (currentTotal === newTotal) {
                status = 'ูุง ุชุบููุฑ';
                statusClass = 'text-muted';
            } else {
                status = 'ุชุญุฏูุซ';
                statusClass = 'text-primary';
                validUpdates++;
            }
        } else {
            status = 'ุฌุฏูุฏ';
            statusClass = 'text-success';
            newProperties++;
        }

        updateTotalsPreview.push({
            unitNumber,
            newTotal,
            currentTotal,
            status,
            statusClass,
            existingProperty
        });

        // ุฅุถุงูุฉ ุตู ูู ุงูุฌุฏูู
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${unitNumber}</td>
            <td>${newTotal.toLocaleString('ar-SA')} ุฑูุงู</td>
            <td>${currentTotal.toLocaleString('ar-SA')} ุฑูุงู</td>
            <td class="${statusClass}">${status}</td>
        `;
        previewBody.appendChild(row);
    }

    // ุชุญุฏูุซ ุงูุนุฏุงุฏ
    previewCount.textContent = `${data.length} ุนูุตุฑ | ${validUpdates} ุชุญุฏูุซ | ${newProperties} ุฌุฏูุฏ | ${errors} ุฎุทุฃ`;

    // ุฅุธูุงุฑ ุงููุนุงููุฉ
    document.getElementById('totalsPreview').classList.add('show');

    // ุชูุนูู ุฒุฑ ุงูุชุทุจูู ุฅุฐุง ูุงู ููุงู ุชุญุฏูุซุงุช ุตุงูุญุฉ
    if (validUpdates > 0 || newProperties > 0) {
        applyBtn.disabled = false;
        applyBtn.innerHTML = `
            <i class="fas fa-check"></i>
            ุชุทุจูู ${validUpdates + newProperties} ุชุญุฏูุซ
        `;
    } else {
        applyBtn.disabled = true;
        applyBtn.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            ูุง ุชูุฌุฏ ุชุญุฏูุซุงุช ููุชุทุจูู
        `;
    }
}

// ุชุทุจูู ุชุญุฏูุซุงุช ุงูุฅุฌูุงููุงุช
async function applyTotalsUpdate() {
    if (!updateTotalsPreview || updateTotalsPreview.length === 0) {
        alert('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุทุจูู');
        return;
    }

    // ุชุฃููุฏ ูู ุงููุณุชุฎุฏู
    const validUpdates = updateTotalsPreview.filter(item =>
        item.status === 'ุชุญุฏูุซ' || item.status === 'ุฌุฏูุฏ'
    ).length;

    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุทุจูู ${validUpdates} ุชุญุฏูุซุ\n\nูุฐุง ุงูุฅุฌุฑุงุก ุณูุคุซุฑ ุนูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ.`)) {
        return;
    }

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        const applyBtn = document.getElementById('applyTotalsBtn');
        const originalText = applyBtn.innerHTML;
        applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุชุทุจูู...';
        applyBtn.disabled = true;

        let updatedCount = 0;
        let addedCount = 0;
        let errors = [];

        for (const item of updateTotalsPreview) {
            if (item.status === 'ูุง ุชุบููุฑ') continue;

            try {
                if (item.existingProperty) {
                    // ุชุญุฏูุซ ุนูุงุฑ ููุฌูุฏ
                    await updatePropertyTotal(item.existingProperty, item.newTotal);
                    updatedCount++;
                } else {
                    // ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ (ุงุฎุชูุงุฑู - ูุฏ ูุญุชุงุฌ ููุนูููุงุช ุฅุถุงููุฉ)
                    console.log('โ๏ธ ุชุฎุทู ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ - ูุชุทูุจ ูุนูููุงุช ุฅุถุงููุฉ:', item.unitNumber);
                    // addedCount++;
                }
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนูุงุฑ:', item.unitNumber, error);
                errors.push(`${item.unitNumber}: ${error.message}`);
            }
        }

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        saveDataLocally();

        // ูุฒุงููุฉ ุชููุงุฆูุฉ ูุน Supabase
        autoSyncAfterEdit('ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช');

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
        renderData();
        updateTotalStats();

        // ุฅุธูุงุฑ ูุชุงุฆุฌ ุงูุนูููุฉ
        let message = `โ ุชู ุชุทุจูู ุงูุชุญุฏูุซุงุช ุจูุฌุงุญ!\n\n`;
        message += `๐ ุงูุนูุงุฑุงุช ุงููุญุฏุซุฉ: ${updatedCount}\n`;
        if (addedCount > 0) message += `โ ุงูุนูุงุฑุงุช ุงููุถุงูุฉ: ${addedCount}\n`;
        if (errors.length > 0) {
            message += `\nโ๏ธ ุฃุฎุทุงุก (${errors.length}):\n${errors.slice(0, 3).join('\n')}`;
            if (errors.length > 3) message += `\n... ู ${errors.length - 3} ุฃุฎุทุงุก ุฃุฎุฑู`;
        }

        alert(message);

        // ุฅุบูุงู ุงููุงูุฐุฉ
        closeUpdateTotalsModal();

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุทุจูู ุงูุชุญุฏูุซุงุช:', error);
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุทุจูู ุงูุชุญุฏูุซุงุช: ' + error.message);

        // ุฅุนุงุฏุฉ ุชุนููู ุงูุฒุฑ
        const applyBtn = document.getElementById('applyTotalsBtn');
        if (applyBtn) {
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
        }
    }
}

// ุชุญุฏูุซ ุฅุฌูุงูู ุนูุงุฑ ูุญุฏุฏ
async function updatePropertyTotal(property, newTotal) {
    const unitNumber = property['ุฑูู ุงููุญุฏุฉ'] || property['ุฑูู  ุงููุญุฏุฉ '];
    console.log('๐ ุชุญุฏูุซ ุฅุฌูุงูู ุงูุนูุงุฑ:', unitNumber, 'ุฅูู', newTotal);

    // ุงูุจุญุซ ุนู ุงูุนูุงุฑ ูู ุงููุตูููุฉ (ูุน ุงูุชุญูู ูู ููุง ุงูุตูุบุชูู ูุฑูู ุงููุญุฏุฉ)
    const propertyIndex = properties.findIndex(p =>
        (p['ุฑูู ุงููุญุฏุฉ'] && p['ุฑูู ุงููุญุฏุฉ'].toString().trim() === unitNumber.toString().trim()) ||
        (p['ุฑูู  ุงููุญุฏุฉ '] && p['ุฑูู  ุงููุญุฏุฉ '].toString().trim() === unitNumber.toString().trim())
    );

    if (propertyIndex === -1) {
        throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ูู ุงููุธุงู');
    }

    // ุชุญุฏูุซ ุงูุฅุฌูุงูู ุจุทุฑููุฉ ุฐููุฉ
    // ูุญุงูู ุชุญุฏูุฏ ุฃู ุญูู ุฅุฌูุงูู ููุฌูุฏ ููุญุฏุซู
    const totalFields = [
        'ุงูุฅุฌูุงูู',
        'ุฅุฌูุงูู ุงููุจูุบ',
        'ุงููุจูุบ ุงูุฅุฌูุงูู',
        'ุฅุฌูุงูู ุงูุนูุฏ',
        'ูููุฉ ุงูุนูุฏ'
    ];

    let updated = false;

    // ุงูุจุญุซ ุนู ุญูู ุงูุฅุฌูุงูู ุงูููุฌูุฏ ูุชุญุฏูุซู
    for (const field of totalFields) {
        if (properties[propertyIndex][field] !== undefined) {
            properties[propertyIndex][field] = newTotal;
            updated = true;
            console.log(`โ ุชู ุชุญุฏูุซ ${field} ุฅูู ${newTotal}`);
            break;
        }
    }

    // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุญูู ุฅุฌูุงููุ ุฃุถู ูุงุญุฏ ุฌุฏูุฏ
    if (!updated) {
        properties[propertyIndex]['ุงูุฅุฌูุงูู'] = newTotal;
        console.log(`โ ุชู ุฅุถุงูุฉ ุญูู ุงูุฅุฌูุงูู ุงูุฌุฏูุฏ: ${newTotal}`);
    }

    // ุชุญุฏูุซ ุชุงุฑูุฎ ุขุฎุฑ ุชุนุฏูู
    properties[propertyIndex]['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');

    return true;
}

// ==================== ูุธุงู ููู ุงููุญุฏุงุช ====================

// ูุชุบูุฑุงุช ุนุงูุฉ ูููู ุงููุญุฏุงุช
let transferSourceCity = null;
let transferSourceProperty = null;
let transferSelectedUnits = [];
let transferDestinationProperty = null;

// ุฅุธูุงุฑ ูุงูุฐุฉ ููู ุงููุญุฏุงุช
function showUnitTransferModal() {
    const modalHtml = `
        <div class="unit-transfer-modal" id="unitTransferModal">
            <div class="unit-transfer-content">
                <div class="unit-transfer-header">
                    <h2 class="unit-transfer-title">
                        <i class="fas fa-exchange-alt"></i>
                        ููู ุงููุญุฏุงุช ุจูู ุงูุนูุงุฑุงุช
                    </h2>
                    <button class="unit-transfer-close" onclick="closeUnitTransferModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- ุงููุณู ุงูุฃูู: ุงุฎุชูุงุฑ ุงููุตุฏุฑ -->
                <div class="transfer-section" id="sourceSection">
                    <h3 class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        ุงุฎุชูุงุฑ ุงูุนูุงุฑ ุงููุตุฏุฑ
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ุงููุฏููุฉ:</label>
                            <select id="sourceCitySelect" onchange="loadSourceProperties(this.value)">
                                <option value="">ุงุฎุชุฑ ุงููุฏููุฉ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>ุงูุนูุงุฑ:</label>
                            <select id="sourcePropertySelect" onchange="loadSourceUnits(this.value)" disabled>
                                <option value="">ุงุฎุชุฑ ุงูุนูุงุฑ</option>
                            </select>
                        </div>
                    </div>

                    <!-- ุฌุฏูู ุงููุญุฏุงุช -->
                    <div class="units-table-container" id="sourceUnitsContainer" style="display: none;">
                        <h4>ุงููุญุฏุงุช ุงููุชุงุญุฉ:</h4>
                        <div class="units-table-wrapper">
                            <table class="units-table" id="sourceUnitsTable">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllUnits" onchange="toggleAllUnits(this.checked)">
                                        </th>
                                        <th>ุฑูู ุงููุญุฏุฉ</th>
                                        <th>ุงุณู ุงููุณุชุฃุฌุฑ</th>
                                        <th>ุฑูู ุงูุนูุฏ</th>
                                        <th>ุงูุญุงูุฉ</th>
                                    </tr>
                                </thead>
                                <tbody id="sourceUnitsBody">
                                </tbody>
                            </table>
                        </div>

                        <div class="transfer-actions">
                            <button class="transfer-btn transfer-btn-primary" onclick="showDestinationSection()" disabled id="proceedBtn">
                                <i class="fas fa-arrow-left"></i>
                                ุงููุชุงุจุนุฉ ูุงุฎุชูุงุฑ ุงููุฌูุฉ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ุงููุณู ุงูุซุงูู: ุงุฎุชูุงุฑ ุงููุฌูุฉ -->
                <div class="transfer-section" id="destinationSection" style="display: none;">
                    <h3 class="section-title">
                        <i class="fas fa-bullseye"></i>
                        ุงุฎุชูุงุฑ ุงูุนูุงุฑ ุงููุฌูุฉ
                    </h3>

                    <div class="form-group">
                        <label>ุงูุนูุงุฑ ุงููุฌูุฉ (ูู ููุณ ุงููุฏููุฉ):</label>
                        <select id="destinationPropertySelect" onchange="setDestinationProperty(this.value)">
                            <option value="">ุงุฎุชุฑ ุงูุนูุงุฑ ุงููุฌูุฉ</option>
                        </select>
                    </div>

                    <div class="transfer-summary" id="transferSummary" style="display: none;">
                        <h4>ููุฎุต ุนูููุฉ ุงูููู:</h4>
                        <div class="summary-content">
                            <p><strong>ูู:</strong> <span id="summarySource"></span></p>
                            <p><strong>ุฅูู:</strong> <span id="summaryDestination"></span></p>
                            <p><strong>ุนุฏุฏ ุงููุญุฏุงุช:</strong> <span id="summaryCount"></span></p>
                        </div>
                    </div>

                    <div class="transfer-actions">
                        <button class="transfer-btn transfer-btn-secondary" onclick="backToSourceSection()">
                            <i class="fas fa-arrow-right"></i>
                            ุงูุนูุฏุฉ
                        </button>
                        <button class="transfer-btn transfer-btn-success" onclick="confirmUnitTransfer()" disabled id="confirmTransferBtn">
                            <i class="fas fa-check"></i>
                            ุชุฃููุฏ ุงูููู
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // ุฅุธูุงุฑ ุงููุงูุฐุฉ ูุน ุชุฃุซูุฑ
    setTimeout(() => {
        document.getElementById('unitTransferModal').classList.add('show');
    }, 100);

    // ุชุญููู ุงููุฏู
    loadTransferCities();
}

// ุฅุบูุงู ูุงูุฐุฉ ููู ุงููุญุฏุงุช
function closeUnitTransferModal() {
    const modal = document.getElementById('unitTransferModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
            // ุฅุนุงุฏุฉ ุชุนููู ุงููุชุบูุฑุงุช
            transferSourceCity = null;
            transferSourceProperty = null;
            transferSelectedUnits = [];
            transferDestinationProperty = null;
        }, 300);
    }
}

// ุชุญููู ุงููุฏู ูู ูุงุฆูุฉ ุงููุตุฏุฑ
function loadTransferCities() {
    const citySelect = document.getElementById('sourceCitySelect');
    if (!citySelect) return;

    const cities = getUniqueCountries();
    citySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฏููุฉ</option>';

    cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
    });
}

// ุชุญููู ุงูุนูุงุฑุงุช ุนูุฏ ุงุฎุชูุงุฑ ุงููุฏููุฉ
function loadSourceProperties(cityName) {
    const propertySelect = document.getElementById('sourcePropertySelect');
    const unitsContainer = document.getElementById('sourceUnitsContainer');

    if (!cityName) {
        propertySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนูุงุฑ</option>';
        propertySelect.disabled = true;
        unitsContainer.style.display = 'none';
        return;
    }

    transferSourceCity = cityName;

    // ุงูุญุตูู ุนูู ุงูุนูุงุฑุงุช ูู ุงููุฏููุฉ ุงููุฎุชุงุฑุฉ
    const cityProperties = properties.filter(p => p.ุงููุฏููุฉ === cityName);
    const uniqueProperties = [...new Set(cityProperties.map(p => p['ุงุณู ุงูุนูุงุฑ']))];

    propertySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนูุงุฑ</option>';
    uniqueProperties.forEach(propertyName => {
        const option = document.createElement('option');
        option.value = propertyName;
        option.textContent = propertyName;
        propertySelect.appendChild(option);
    });

    propertySelect.disabled = false;
    unitsContainer.style.display = 'none';
}

// ุชุญููู ุงููุญุฏุงุช ุนูุฏ ุงุฎุชูุงุฑ ุงูุนูุงุฑ
function loadSourceUnits(propertyName) {
    const unitsContainer = document.getElementById('sourceUnitsContainer');
    const unitsBody = document.getElementById('sourceUnitsBody');

    if (!propertyName) {
        unitsContainer.style.display = 'none';
        return;
    }

    transferSourceProperty = propertyName;

    // ุงูุญุตูู ุนูู ูุญุฏุงุช ุงูุนูุงุฑ ุงููุฎุชุงุฑ
    const propertyUnits = properties.filter(p =>
        p.ุงููุฏููุฉ === transferSourceCity && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
    );

    unitsBody.innerHTML = '';
    transferSelectedUnits = [];

    propertyUnits.forEach(unit => {
        const status = calculateStatus(unit);
        const unitNumber = unit['ุฑูู ุงููุญุฏุฉ'] || unit['ุฑูู  ุงููุญุฏุฉ '] || 'ุบูุฑ ูุญุฏุฏ';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" value="${unitNumber}"
                       onchange="toggleUnitSelection(this, '${unitNumber}')">
            </td>
            <td>${unitNumber}</td>
            <td>${unit['ุงุณู ุงููุณุชุฃุฌุฑ'] || 'ูุงุฑุบ'}</td>
            <td>${unit['ุฑูู ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</td>
            <td>
                <span class="status-badge status-${status.final.replace(' ', '-')}">${status.final}</span>
            </td>
        `;
        unitsBody.appendChild(row);
    });

    unitsContainer.style.display = 'block';
    updateProceedButton();
}

// ุชุจุฏูู ุชุญุฏูุฏ ุงููุญุฏุฉ
function toggleUnitSelection(checkbox, unitNumber) {
    if (checkbox.checked) {
        if (!transferSelectedUnits.includes(unitNumber)) {
            transferSelectedUnits.push(unitNumber);
        }
    } else {
        transferSelectedUnits = transferSelectedUnits.filter(u => u !== unitNumber);
    }

    updateProceedButton();
    updateSelectAllCheckbox();
}

// ุชุจุฏูู ุชุญุฏูุฏ ุฌููุน ุงููุญุฏุงุช
function toggleAllUnits(checked) {
    const checkboxes = document.querySelectorAll('#sourceUnitsBody input[type="checkbox"]');
    transferSelectedUnits = [];

    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
        if (checked) {
            transferSelectedUnits.push(checkbox.value);
        }
    });

    updateProceedButton();
}

// ุชุญุฏูุซ ุญุงูุฉ checkbox "ุชุญุฏูุฏ ุงููู"
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllUnits');
    const unitCheckboxes = document.querySelectorAll('#sourceUnitsBody input[type="checkbox"]');
    const checkedBoxes = document.querySelectorAll('#sourceUnitsBody input[type="checkbox"]:checked');

    if (checkedBoxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length === unitCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// ุชุญุฏูุซ ุฒุฑ ุงููุชุงุจุนุฉ
function updateProceedButton() {
    const proceedBtn = document.getElementById('proceedBtn');
    if (proceedBtn) {
        proceedBtn.disabled = transferSelectedUnits.length === 0;
        proceedBtn.innerHTML = `
            <i class="fas fa-arrow-left"></i>
            ุงููุชุงุจุนุฉ ูุงุฎุชูุงุฑ ุงููุฌูุฉ (${transferSelectedUnits.length} ูุญุฏุฉ)
        `;
    }
}

// ุฅุธูุงุฑ ูุณู ุงุฎุชูุงุฑ ุงููุฌูุฉ
function showDestinationSection() {
    if (transferSelectedUnits.length === 0) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ูุญุฏุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู');
        return;
    }

    // ุฅุฎูุงุก ูุณู ุงููุตุฏุฑ ูุฅุธูุงุฑ ูุณู ุงููุฌูุฉ
    document.getElementById('sourceSection').style.display = 'none';
    document.getElementById('destinationSection').style.display = 'block';

    // ุชุญููู ุงูุนูุงุฑุงุช ูู ููุณ ุงููุฏููุฉ (ุจุงุณุชุซูุงุก ุงูุนูุงุฑ ุงููุตุฏุฑ)
    loadDestinationProperties();
}

// ุชุญููู ุนูุงุฑุงุช ุงููุฌูุฉ
function loadDestinationProperties() {
    const destinationSelect = document.getElementById('destinationPropertySelect');

    // ุงูุญุตูู ุนูู ุงูุนูุงุฑุงุช ูู ููุณ ุงููุฏููุฉ ุจุงุณุชุซูุงุก ุงูุนูุงุฑ ุงููุตุฏุฑ
    const cityProperties = properties.filter(p => p.ุงููุฏููุฉ === transferSourceCity);
    const uniqueProperties = [...new Set(cityProperties.map(p => p['ุงุณู ุงูุนูุงุฑ']))]
        .filter(name => name !== transferSourceProperty);

    destinationSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนูุงุฑ ุงููุฌูุฉ</option>';
    uniqueProperties.forEach(propertyName => {
        const option = document.createElement('option');
        option.value = propertyName;
        option.textContent = propertyName;
        destinationSelect.appendChild(option);
    });
}

// ุชุนููู ุงูุนูุงุฑ ุงููุฌูุฉ
function setDestinationProperty(propertyName) {
    transferDestinationProperty = propertyName;

    const summaryDiv = document.getElementById('transferSummary');
    const confirmBtn = document.getElementById('confirmTransferBtn');

    if (propertyName) {
        // ุฅุธูุงุฑ ููุฎุต ุงูุนูููุฉ
        document.getElementById('summarySource').textContent =
            `${transferSourceProperty} (${transferSourceCity})`;
        document.getElementById('summaryDestination').textContent =
            `${propertyName} (${transferSourceCity})`;
        document.getElementById('summaryCount').textContent = transferSelectedUnits.length;

        summaryDiv.style.display = 'block';
        confirmBtn.disabled = false;
    } else {
        summaryDiv.style.display = 'none';
        confirmBtn.disabled = true;
    }
}

// ุงูุนูุฏุฉ ููุณู ุงููุตุฏุฑ
function backToSourceSection() {
    document.getElementById('destinationSection').style.display = 'none';
    document.getElementById('sourceSection').style.display = 'block';
}

// ุชุฃููุฏ ููู ุงููุญุฏุงุช
async function confirmUnitTransfer() {
    if (!transferDestinationProperty || transferSelectedUnits.length === 0) {
        alert('ูุฑุฌู ุงูุชุฃูุฏ ูู ุงุฎุชูุงุฑ ุงูุนูุงุฑ ุงููุฌูุฉ ูุงููุญุฏุงุช ุงููุฑุงุฏ ููููุง');
        return;
    }

    const confirmMessage = `ูู ุฃูุช ูุชุฃูุฏ ูู ููู ${transferSelectedUnits.length} ูุญุฏุฉ ูู "${transferSourceProperty}" ุฅูู "${transferDestinationProperty}"ุ\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        // ุงูุชุญูู ูู ุญุงูุฉ ุงูุงุชุตุงู ุจู Supabase
        let supabaseAvailable = false;
        if (typeof checkSupabaseAvailability === 'function') {
            try {
                supabaseAvailable = await checkSupabaseAvailability();
                if (!supabaseAvailable) {
                    console.warn('โ๏ธ Supabase ุบูุฑ ูุชุงุญุ ุณูุชู ุงูููู ูุญููุงู ููุท');

                    // ุฅุธูุงุฑ ุชุญุฐูุฑ ูููุณุชุฎุฏู
                    const proceedWithoutCloud = confirm(
                        'โ๏ธ ุชุญุฐูุฑ: ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ ุบูุฑ ูุชุงุญุฉ ุญุงููุงู.\n\n' +
                        'ุณูุชู ููู ุงููุญุฏุงุช ูุญููุงู ููุท ููุฏ ุชููุฏ ุงูุชุบููุฑุงุช ุนูุฏ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.\n\n' +
                        'ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ'
                    );

                    if (!proceedWithoutCloud) {
                        return; // ุฅูุบุงุก ุงูุนูููุฉ
                    }
                }
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ูุญุต Supabase:', error);
            }
        }

        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        const confirmBtn = document.getElementById('confirmTransferBtn');
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูููู...';
        confirmBtn.disabled = true;

        let transferredCount = 0;
        let supabaseSuccessCount = 0;
        let errors = [];

        // ููู ูู ูุญุฏุฉ ูุญุฏุฏุฉ
        for (const unitNumber of transferSelectedUnits) {
            try {
                const result = await transferSingleUnit(unitNumber, transferSourceProperty, transferDestinationProperty);
                if (result.success) {
                    transferredCount++;
                    if (result.supabaseSuccess) {
                        supabaseSuccessCount++;
                    }
                }
            } catch (error) {
                console.error(`โ ุฎุทุฃ ูู ููู ุงููุญุฏุฉ ${unitNumber}:`, error);
                errors.push(`${unitNumber}: ${error.message}`);
            }
        }

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        saveDataLocally();

        // ูุฒุงููุฉ ุฅุถุงููุฉ ูุน Supabase ููุชุฃูุฏ ูู ุงูุญูุธ
        if (supabaseSuccessCount < transferredCount) {
            console.log('๐ ูุญุงููุฉ ูุฒุงููุฉ ุฅุถุงููุฉ ูููุญุฏุงุช ุบูุฑ ุงููุญููุธุฉ...');

            // ูุญุงููุฉ ุญูุธ ุงููุญุฏุงุช ุงูุชู ูู ูุชู ุญูุธูุง ูู Supabase
            for (const unitNumber of transferSelectedUnits) {
                const unit = properties.find(p =>
                    (p['ุฑูู ุงููุญุฏุฉ'] === unitNumber || p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber) &&
                    p['ุงุณู ุงูุนูุงุฑ'] === transferDestinationProperty
                );

                if (unit && typeof savePropertyToSupabase === 'function') {
                    try {
                        await savePropertyToSupabase(unit);
                        console.log(`โ ูุฒุงููุฉ ุฅุถุงููุฉ ูุงุฌุญุฉ ูููุญุฏุฉ ${unitNumber}`);
                    } catch (error) {
                        console.error(`โ ูุดู ูู ุงููุฒุงููุฉ ุงูุฅุถุงููุฉ ูููุญุฏุฉ ${unitNumber}:`, error);
                    }
                }
            }
        }

        // ูุฒุงููุฉ ุชููุงุฆูุฉ ูุน Supabase
        autoSyncAfterEdit('ุชุญุฏูุซ ุงูุจูุงูุงุช');

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
        renderData();
        updateTotalStats();

        // ุฅุธูุงุฑ ูุชุงุฆุฌ ุงูุนูููุฉ ูุน ุชูุงุตูู ุงูุญุฐู
        let message = `โ ุชู ููู ${transferredCount} ูุญุฏุฉ ุจูุฌุงุญ!\n\n`;
        message += `๐ค ูู: ${transferSourceProperty}\n`;
        message += `๐ฅ ุฅูู: ${transferDestinationProperty}\n\n`;

        // ุชูุงุตูู ุงูุญูุธ ูู ุงูุณุญุงุจุฉ
        message += `โ๏ธ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ:\n`;
        message += `   โข ุชู ุญูุธ ${supabaseSuccessCount} ูุญุฏุฉ ูู ุงููููุน ุงูุฌุฏูุฏ\n`;

        // ุชูุงุตูู ุงูุญุฐู ูู ุงููููุน ุงููุฏูู
        let deletedFromOldCount = 0;
        transferSelectedUnits.forEach(unitNumber => {
            const unit = properties.find(p =>
                (p['ุฑูู ุงููุญุฏุฉ'] === unitNumber || p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber) &&
                p['ุงุณู ุงูุนูุงุฑ'] === transferDestinationProperty
            );
            // ุฅุฐุง ูุงูุช ุงููุญุฏุฉ ููุฌูุฏุฉ ูู ุงูุนูุงุฑ ุงูุฌุฏูุฏุ ููุฏ ุชู ุงูููู ุจูุฌุงุญ
            if (unit) deletedFromOldCount++;
        });

        message += `   โข ุชู ุญุฐู ${deletedFromOldCount} ูุญุฏุฉ ูู ุงููููุน ุงููุฏูู ููุงุฆูุงู\n\n`;

        // ุชุฃููุฏ ุนุฏู ูุฌูุฏ ุฃุซุฑ ูู ุงูุนูุงุฑ ุงููุฏูู
        message += `๐๏ธ ุชุฃููุฏ ุงูุญุฐู ุงูููุงุฆู:\n`;
        message += `   โข ุงููุญุฏุงุช ุงููููููุฉ ูุง ุชูุฌุฏ ูู "${transferSourceProperty}" ููุงุฆูุงู\n`;
        message += `   โข ุฌููุน ุงูุจูุงูุงุช ุฃุตุจุญุช ุชุงุจุนุฉ ูู "${transferDestinationProperty}" ููุท\n`;

        if (supabaseSuccessCount < transferredCount) {
            const localOnlyCount = transferredCount - supabaseSuccessCount;
            message += `\nโ๏ธ ุชุญุฐูุฑ: ${localOnlyCount} ูุญุฏุฉ ุชู ููููุง ูุญููุงู ููุท (ูุดุงูู ูู ุงูุงุชุตุงู)\n`;
            message += `   โข ูุฏ ุชุญุชุงุฌ ููุฒุงููุฉ ูุฏููุฉ ูุงุญูุงู\n`;
        }

        if (errors.length > 0) {
            message += `\nโ ุฃุฎุทุงุก (${errors.length}):\n${errors.slice(0, 3).join('\n')}`;
            if (errors.length > 3) message += `\n... ู ${errors.length - 3} ุฃุฎุทุงุก ุฃุฎุฑู`;
        }

        alert(message);

        // ุฅุบูุงู ุงููุงูุฐุฉ
        closeUnitTransferModal();

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุนูููุฉ ุงูููู:', error);
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ููู ุงููุญุฏุงุช: ' + error.message);

        // ุฅุนุงุฏุฉ ุชุนููู ุงูุฒุฑ
        const confirmBtn = document.getElementById('confirmTransferBtn');
        if (confirmBtn) {
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        }
    }
}

// ููู ูุญุฏุฉ ูุงุญุฏุฉ
async function transferSingleUnit(unitNumber, sourceProperty, destinationProperty) {
    console.log(`๐ ููู ุงููุญุฏุฉ ${unitNumber} ูู ${sourceProperty} ุฅูู ${destinationProperty}`);

    // ุงูุจุญุซ ุนู ุงููุญุฏุฉ ูู ุงููุตูููุฉ (ูุน ุงูุชุญูู ูู ููุง ุงูุตูุบุชูู ูุฑูู ุงููุญุฏุฉ)
    const unitIndex = properties.findIndex(p =>
        (p['ุฑูู ุงููุญุฏุฉ'] === unitNumber || p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber) &&
        p['ุงุณู ุงูุนูุงุฑ'] === sourceProperty
    );

    if (unitIndex === -1) {
        console.error(`โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ${unitNumber} ูู ุงูุนูุงุฑ ${sourceProperty}`);
        console.log('๐ ุงูุจุญุซ ูู ุฌููุน ุงูุนูุงุฑุงุช ูููุญุฏุฉ:', unitNumber);

        // ุงูุจุญุซ ูู ุฌููุน ุงูุนูุงุฑุงุช ูุชุดุฎูุต ุงููุดููุฉ
        const allUnitsWithSameNumber = properties.filter(p =>
            p['ุฑูู ุงููุญุฏุฉ'] === unitNumber || p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber
        );
        console.log('๐ ุงููุญุฏุงุช ุงูููุฌูุฏุฉ ุจุฑูู', unitNumber, ':', allUnitsWithSameNumber);

        throw new Error(`ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ${unitNumber} ูู ุงูุนูุงุฑ ${sourceProperty}`);
    }

    // ูุณุฎ ุจูุงูุงุช ุงููุญุฏุฉ ูุชุญุฏูุซ ุงุณู ุงูุนูุงุฑ
    const unit = { ...properties[unitIndex] };
    unit['ุงุณู ุงูุนูุงุฑ'] = destinationProperty;
    unit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
    unit['ููุน ุงูุชุญุฏูุซ'] = 'ููู ูุญุฏุฉ';
    unit['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = getCurrentUser();

    // ุญูุธ ุงูุชุบููุฑุงุช ูู Supabase ุฃููุงู
    let supabaseSuccess = false;
    let deletionSuccess = false;

    if (typeof savePropertyToSupabase === 'function') {
        try {
            console.log(`๐พ ุญูุธ ุงููุญุฏุฉ ุงููููููุฉ ${unitNumber} ูู Supabase...`);

            // ุญูุธ ุงููุญุฏุฉ ุจุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ (ุงูุนูุงุฑ ุงูุฌุฏูุฏ)
            const result = await savePropertyToSupabase(unit);
            if (result) {
                supabaseSuccess = true;
                console.log(`โ ุชู ุญูุธ ุงููุญุฏุฉ ${unitNumber} ูู ุงูุนูุงุฑ ุงูุฌุฏูุฏ "${destinationProperty}" ูู Supabase`);

                // ุญุฐู ุงูุณุฌู ุงููุฏูู ููุงุฆูุงู ูู Supabase (ุงูุนูุงุฑ ุงููุฏูู)
                const originalUnit = properties[unitIndex];
                if (originalUnit && typeof deletePropertyFromSupabase === 'function') {
                    try {
                        console.log(`๐๏ธ ุญุฐู ุงูุณุฌู ุงููุฏูู ูููุญุฏุฉ ${unitNumber} ูู ุงูุนูุงุฑ "${sourceProperty}" ูู Supabase...`);

                        // ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ููุงุฆูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                        const deleteResult = await deletePropertyFromSupabase(originalUnit);

                        if (deleteResult && deleteResult.success) {
                            deletionSuccess = true;
                            console.log(`โ ุชู ุญุฐู ุงูุณุฌู ุงููุฏูู ูููุญุฏุฉ ${unitNumber} ููุงุฆูุงู ูู Supabase`);
                        } else {
                            console.warn(`โ๏ธ ูุดู ุญุฐู ุงูุณุฌู ุงููุฏูู ูููุญุฏุฉ ${unitNumber}:`, deleteResult?.reason || 'ุณุจุจ ุบูุฑ ูุนุฑูู');
                        }
                    } catch (deleteError) {
                        console.error(`โ ุฎุทุฃ ูู ุญุฐู ุงูุณุฌู ุงููุฏูู ูููุญุฏุฉ ${unitNumber}:`, deleteError);
                    }
                }
            } else {
                console.error(`โ ูุดู ุญูุธ ุงููุญุฏุฉ ${unitNumber} ูู Supabase`);
            }
        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุญูุธ ุงููุญุฏุฉ ${unitNumber} ูู Supabase:`, error);
        }
    }

    // ุฅุฐุง ูุดู ุญูุธ Supabaseุ ุฅุธูุงุฑ ุชุญุฐูุฑ ูููู ุงุณุชูุฑ ุจุงูุนูููุฉ ูุญููุงู
    if (!supabaseSuccess) {
        console.warn(`โ๏ธ ูู ูุชู ุญูุธ ุงููุญุฏุฉ ${unitNumber} ูู Supabaseุ ุณูุชู ุงูุญูุธ ูุญููุงู ููุท`);
    }

    // ุชุญุฏูุซ ุงูุจูุงูุงุช ูุญููุงู
    properties.splice(unitIndex, 1);
    properties.push(unit);

    // ุฅุถุงูุฉ ุณุฌู ุงูุชุชุจุน ูููู ุงููุญุฏุฉ
    try {
        await addChangeLog(
            OPERATION_TYPES.TRANSFER_UNIT,
            unit,
            {},
            {
                sourceProperty: sourceProperty,
                destinationProperty: destinationProperty,
                reason: 'ููู ูุญุฏุฉ ุจูู ุงูุนูุงุฑุงุช'
            }
        );
        console.log('๐ ุชู ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ููู ุงููุญุฏุฉ');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ููู ุงููุญุฏุฉ:', error);
    }

    console.log(`โ ุชู ููู ุงููุญุฏุฉ ${unitNumber} ุจูุฌุงุญ`);
    return {
        success: true,
        supabaseSuccess,
        deletionSuccess,
        details: {
            unitNumber,
            sourceProperty,
            destinationProperty,
            savedToNewLocation: supabaseSuccess,
            deletedFromOldLocation: deletionSuccess
        }
    };
}

// ุงูุญุตูู ุนูู ุงููุณุชุฎุฏู ุงูุญุงูู (ุณูุชู ุชุทููุฑูุง ูู ูุธุงู ุงูุตูุงุญูุงุช)
function getCurrentUser() {
    // ูุคูุชุงู ูุนูุฏ "ุงููุธุงู" ุญุชู ูุชู ุชุทุจูู ูุธุงู ุงูุตูุงุญูุงุช
    return 'ุงููุธุงู';
}

// ==================== ููุชุฑ ุขุฎุฑ ุชุญุฏูุซุงุช ุงููุญุฏุงุช ====================

// ุฅุธูุงุฑ ูุงูุฐุฉ ููุชุฑ ุขุฎุฑ ุงูุชุญุฏูุซุงุช
function showLastUpdatesFilter() {
    const modalHtml = `
        <div class="last-updates-modal" id="lastUpdatesModal">
            <div class="last-updates-content">
                <div class="last-updates-header">
                    <h2 class="last-updates-title">
                        <i class="fas fa-history"></i>
                        ุขุฎุฑ ุชุญุฏูุซุงุช ุงููุญุฏุงุช
                    </h2>
                    <button class="last-updates-close" onclick="closeLastUpdatesModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- ูููุฐุฌ ุงูููุชุฑุฉ -->
                <div class="updates-filter-form">
                    <div class="updates-form-group required">
                        <label>ุงูุณูุฉ:</label>
                        <select id="updatesYearSelect">
                            <option value="">ุงุฎุชุฑ ุงูุณูุฉ</option>
                        </select>
                    </div>

                    <div class="updates-form-group required">
                        <label>ุงูุดูุฑ:</label>
                        <select id="updatesMonthSelect" disabled>
                            <option value="">ุงุฎุชุฑ ุงูุดูุฑ</option>
                        </select>
                    </div>

                    <div class="updates-form-group">
                        <label>ุงูููู:</label>
                        <select id="updatesDaySelect" disabled>
                            <option value="">ุฌููุน ุงูุฃูุงู</option>
                        </select>
                    </div>

                    <div class="updates-form-group">
                        <label>ุงูุฃุณุจูุน:</label>
                        <select id="updatesWeekSelect" disabled>
                            <option value="">ุฌููุน ุงูุฃุณุงุจูุน</option>
                            <option value="1">ุงูุฃุณุจูุน ุงูุฃูู</option>
                            <option value="2">ุงูุฃุณุจูุน ุงูุซุงูู</option>
                            <option value="3">ุงูุฃุณุจูุน ุงูุซุงูุซ</option>
                            <option value="4">ุงูุฃุณุจูุน ุงูุฑุงุจุน</option>
                        </select>
                    </div>
                </div>

                <div class="updates-filter-actions">
                    <button class="updates-btn updates-btn-secondary" onclick="clearUpdatesFilter()">
                        <i class="fas fa-eraser"></i>
                        ูุณุญ ุงูููุชุฑ
                    </button>
                    <button class="updates-btn updates-btn-primary" onclick="applyUpdatesFilter()">
                        <i class="fas fa-search"></i>
                        ุงูุจุญุซ ุนู ุงูุชุญุฏูุซุงุช
                    </button>
                </div>

                <!-- ูุชุงุฆุฌ ุงูุจุญุซ -->
                <div class="updates-results" id="updatesResults">
                    <div class="updates-results-header">
                        <h4>ูุชุงุฆุฌ ุงูุจุญุซ</h4>
                        <span id="updatesResultsCount">0 ุชุญุฏูุซ</span>
                    </div>
                    <div class="updates-results-content" id="updatesResultsContent">
                        <!-- ุณูุชู ููุก ุงููุชุงุฆุฌ ููุง -->
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // ุฅุธูุงุฑ ุงููุงูุฐุฉ ูุน ุชุฃุซูุฑ
    setTimeout(() => {
        document.getElementById('lastUpdatesModal').classList.add('show');
    }, 100);

    // ุชููุฆุฉ ุงููููุฐุฌ
    initializeUpdatesFilter();
}

// ุฅุบูุงู ูุงูุฐุฉ ููุชุฑ ุขุฎุฑ ุงูุชุญุฏูุซุงุช
function closeLastUpdatesModal() {
    const modal = document.getElementById('lastUpdatesModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// ุชููุฆุฉ ูููุฐุฌ ููุชุฑ ุงูุชุญุฏูุซุงุช
function initializeUpdatesFilter() {
    // ุชุญููู ุงูุณููุงุช ุงููุชุงุญุฉ
    loadAvailableYears();

    // ุฑุจุท ุงูุฃุญุฏุงุซ
    document.getElementById('updatesYearSelect').addEventListener('change', function() {
        loadAvailableMonths(this.value);
    });

    document.getElementById('updatesMonthSelect').addEventListener('change', function() {
        const year = document.getElementById('updatesYearSelect').value;
        if (year && this.value) {
            loadAvailableDays(year, this.value);
        }
    });
}

// ุชุญููู ุงูุณููุงุช ุงููุชุงุญุฉ
function loadAvailableYears() {
    const yearSelect = document.getElementById('updatesYearSelect');
    const currentYear = new Date().getFullYear();
    const years = [];

    // ุฅุถุงูุฉ ุงูุณููุงุช ูู ุงูุณูุฉ ุงูุญุงููุฉ ุฅูู 5 ุณููุงุช ุณุงุจูุฉ
    for (let i = 0; i <= 5; i++) {
        years.push(currentYear - i);
    }

    yearSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุณูุฉ</option>';
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    });
}

// ุชุญููู ุงูุดููุฑ ุงููุชุงุญุฉ
function loadAvailableMonths(year) {
    const monthSelect = document.getElementById('updatesMonthSelect');
    const daySelect = document.getElementById('updatesDaySelect');
    const weekSelect = document.getElementById('updatesWeekSelect');

    if (!year) {
        monthSelect.disabled = true;
        daySelect.disabled = true;
        weekSelect.disabled = true;
        return;
    }

    const months = [
        { value: '01', name: 'ููุงูุฑ' },
        { value: '02', name: 'ูุจุฑุงูุฑ' },
        { value: '03', name: 'ูุงุฑุณ' },
        { value: '04', name: 'ุฃุจุฑูู' },
        { value: '05', name: 'ูุงูู' },
        { value: '06', name: 'ููููู' },
        { value: '07', name: 'ููููู' },
        { value: '08', name: 'ุฃุบุณุทุณ' },
        { value: '09', name: 'ุณุจุชูุจุฑ' },
        { value: '10', name: 'ุฃูุชูุจุฑ' },
        { value: '11', name: 'ููููุจุฑ' },
        { value: '12', name: 'ุฏูุณูุจุฑ' }
    ];

    monthSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุดูุฑ</option>';
    months.forEach(month => {
        const option = document.createElement('option');
        option.value = month.value;
        option.textContent = month.name;
        monthSelect.appendChild(option);
    });

    monthSelect.disabled = false;
    daySelect.disabled = true;
    weekSelect.disabled = true;
}

// ุชุญููู ุงูุฃูุงู ุงููุชุงุญุฉ
function loadAvailableDays(year, month) {
    const daySelect = document.getElementById('updatesDaySelect');
    const weekSelect = document.getElementById('updatesWeekSelect');

    // ุงูุญุตูู ุนูู ุนุฏุฏ ุฃูุงู ุงูุดูุฑ
    const daysInMonth = new Date(year, month, 0).getDate();

    daySelect.innerHTML = '<option value="">ุฌููุน ุงูุฃูุงู</option>';
    for (let day = 1; day <= daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day.toString().padStart(2, '0');
        option.textContent = day;
        daySelect.appendChild(option);
    }

    daySelect.disabled = false;
    weekSelect.disabled = false;
}

// ูุณุญ ููุชุฑ ุงูุชุญุฏูุซุงุช
function clearUpdatesFilter() {
    document.getElementById('updatesYearSelect').value = '';
    document.getElementById('updatesMonthSelect').value = '';
    document.getElementById('updatesMonthSelect').disabled = true;
    document.getElementById('updatesDaySelect').value = '';
    document.getElementById('updatesDaySelect').disabled = true;
    document.getElementById('updatesWeekSelect').value = '';
    document.getElementById('updatesWeekSelect').disabled = true;

    // ุฅุฎูุงุก ุงููุชุงุฆุฌ
    document.getElementById('updatesResults').classList.remove('show');
}

// ุชุทุจูู ููุชุฑ ุงูุชุญุฏูุซุงุช
function applyUpdatesFilter() {
    const year = document.getElementById('updatesYearSelect').value;
    const month = document.getElementById('updatesMonthSelect').value;
    const day = document.getElementById('updatesDaySelect').value;
    const week = document.getElementById('updatesWeekSelect').value;

    if (!year || !month) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุณูุฉ ูุงูุดูุฑ ุนูู ุงูุฃูู');
        return;
    }

    console.log('๐ ุงูุจุญุซ ุนู ุงูุชุญุฏูุซุงุช:', { year, month, day, week });

    // ุงูุจุญุซ ุนู ุงููุญุฏุงุช ุงููุญุฏุซุฉ
    const filteredUpdates = findUpdatedUnits(year, month, day, week);

    // ุนุฑุถ ุงููุชุงุฆุฌ
    displayUpdatesResults(filteredUpdates);
}

// ุงูุจุญุซ ุนู ุงููุญุฏุงุช ุงููุญุฏุซุฉ
function findUpdatedUnits(year, month, day, week) {
    const updates = [];

    properties.forEach(property => {
        const updateDate = property['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'];
        const updateType = property['ููุน ุงูุชุญุฏูุซ'];
        const updatedBy = property['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'];

        if (updateDate && isDateInRange(updateDate, year, month, day, week)) {
            updates.push({
                property,
                updateDate,
                updateType: updateType || 'ุชุนุฏูู',
                updatedBy: updatedBy || 'ุบูุฑ ูุญุฏุฏ',
                timestamp: parseArabicDate(updateDate)
            });
        }
    });

    // ุชุฑุชูุจ ุญุณุจ ุงูุชุงุฑูุฎ (ุงูุฃุญุฏุซ ุฃููุงู)
    updates.sort((a, b) => b.timestamp - a.timestamp);

    return updates;
}

// ุงูุชุญูู ูู ูุฌูุฏ ุงูุชุงุฑูุฎ ูู ุงููุทุงู ุงููุญุฏุฏ
function isDateInRange(dateString, year, month, day, week) {
    try {
        const date = parseArabicDate(dateString);
        if (!date) return false;

        const dateYear = date.getFullYear().toString();
        const dateMonth = (date.getMonth() + 1).toString().padStart(2, '0');
        const dateDay = date.getDate().toString().padStart(2, '0');

        // ุงูุชุญูู ูู ุงูุณูุฉ ูุงูุดูุฑ
        if (dateYear !== year || dateMonth !== month) {
            return false;
        }

        // ุงูุชุญูู ูู ุงูููู ุฅุฐุง ุชู ุชุญุฏูุฏู
        if (day && dateDay !== day) {
            return false;
        }

        // ุงูุชุญูู ูู ุงูุฃุณุจูุน ุฅุฐุง ุชู ุชุญุฏูุฏู
        if (week) {
            const dayOfMonth = date.getDate();
            const weekNumber = Math.ceil(dayOfMonth / 7);
            if (weekNumber.toString() !== week) {
                return false;
            }
        }

        return true;
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูุชุงุฑูุฎ:', dateString, error);
        return false;
    }
}

// ุชุญููู ุงูุชุงุฑูุฎ ุงูุนุฑุจู ููุชุชุจุน
function parseArabicDate(dateString) {
    if (!dateString) return null;

    try {
        // ุชุญููู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ุฅูู ุฅูุฌููุฒูุฉ
        let normalizedDate = dateString.replace(/[ู-ูฉ]/g, (d) => 'ููกูขูฃูคูฅูฆูงูจูฉ'.indexOf(d));

        // ูุนุงูุฌุฉ ุงูุชูุณููุงุช ุงููุฎุชููุฉ
        if (normalizedDate.includes('/')) {
            // ุชูุณูู DD/MM/YYYY
            const parts = normalizedDate.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // JavaScript months are 0-based
                const year = parseInt(parts[2]);
                return new Date(year, month, day);
            }
        } else if (normalizedDate.includes('-')) {
            // ุชูุณูู YYYY-MM-DD ุฃู DD-MM-YYYY
            const parts = normalizedDate.split('-');
            if (parts.length === 3) {
                if (parts[0].length === 4) {
                    // YYYY-MM-DD
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else {
                    // DD-MM-YYYY
                    return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                }
            }
        }

        // ูุญุงููุฉ ุฃุฎูุฑุฉ
        return new Date(normalizedDate);
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูุชุงุฑูุฎ:', dateString, error);
        return null;
    }
}

// ุนุฑุถ ูุชุงุฆุฌ ุงูุชุญุฏูุซุงุช
function displayUpdatesResults(updates) {
    const resultsDiv = document.getElementById('updatesResults');
    const resultsContent = document.getElementById('updatesResultsContent');
    const resultsCount = document.getElementById('updatesResultsCount');

    resultsCount.textContent = `${updates.length} ุชุญุฏูุซ`;

    if (updates.length === 0) {
        resultsContent.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6c757d;">
                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>ูู ูุชู ุงูุนุซูุฑ ุนูู ุชุญุฏูุซุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ</p>
            </div>
        `;
    } else {
        resultsContent.innerHTML = updates.map(update => `
            <div class="update-item">
                <div class="update-header">
                    <div class="update-unit-info">
                        ุงููุญุฏุฉ ${update.property['ุฑูู  ุงููุญุฏุฉ '] || update.property['ุฑูู ุงููุญุฏุฉ'] || 'ุบูุฑ ูุญุฏุฏ'} - ${update.property['ุงุณู ุงูุนูุงุฑ']}
                    </div>
                    <div class="update-timestamp">
                        ${update.updateDate}
                    </div>
                </div>
                <div class="update-details">
                    <div><strong>ุงููุณุชุฃุฌุฑ:</strong> ${update.property['ุงุณู ุงููุณุชุฃุฌุฑ'] || 'ูุงุฑุบ'}</div>
                    <div><strong>ุฑูู ุงูุนูุฏ:</strong> ${update.property['ุฑูู ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</div>
                    <div><strong>ุงููุฏููุฉ:</strong> ${update.property['ุงููุฏููุฉ'] || 'ุบูุฑ ูุญุฏุฏ'}</div>
                    <div><strong>ุงููุณุคูู:</strong> ${update.updatedBy}</div>
                </div>
                <span class="update-type ${getUpdateTypeClass(update.updateType)}">
                    ${update.updateType}
                </span>
            </div>
        `).join('');
    }

    resultsDiv.classList.add('show');
}

// ุงูุญุตูู ุนูู ููุงุณ ููุน ุงูุชุญุฏูุซ
function getUpdateTypeClass(updateType) {
    switch (updateType) {
        case 'ุชุนุฏูู':
        case 'ุชุญุฑูุฑ':
            return 'edit';
        case 'ุฅูุฑุงุบ':
            return 'empty';
        case 'ุนููู ุฌุฏูุฏ':
        case 'ุชุฌุฏูุฏ ุงูุนูุฏ':
            return 'new';
        case 'ููู ูุญุฏุฉ':
            return 'transfer';
        default:
            return 'edit';
    }
}

// ==================== ูุธุงู ุชุชุจุน ุงูุชุบููุฑุงุช ====================

// ูุชุบูุฑุงุช ูุธุงู ุงูุชุชุจุน
let changeTrackingLogs = [];
let isTrackingEnabled = true;

// ุฃููุงุน ุงูุนูููุงุช ุงููุฏุนููุฉ
const OPERATION_TYPES = {
    EDIT_DATA: 'ุชุนุฏูู ุจูุงูุงุช ููุฌูุฏุฉ',
    NEW_CLIENT: 'ุนููู ุฌุฏูุฏ',
    RENEW_CONTRACT: 'ุชุฌุฏูุฏ ุนูุฏ',
    EMPTY_UNIT: 'ุฅูุฑุงุบ ูุญุฏุฉ',
    MERGE_UNITS: 'ุฏูุฌ ูุญุฏุงุช',
    SPLIT_UNITS: 'ูุตู ูุญุฏุงุช',
    TRANSFER_UNIT: 'ููู ูุญุฏุฉ',
    DELETE_UNIT: 'ุญุฐู ูุญุฏุฉ',
    CREATE_PROPERTY: 'ุฅูุดุงุก ุนูุงุฑ',
    DELETE_PROPERTY: 'ุญุฐู ุนูุงุฑ'
};

// ูููู ุณุฌู ุงูุชุชุจุน ุงููุญุณู
function createChangeLog(operationType, unitData, changes = {}, additionalInfo = {}) {
    const now = new Date();
    const hijriDate = getHijriDate(now);
    const gregorianDate = now.toLocaleDateString('ar-SA');
    const dayName = getDayName(now);

    return {
        id: `log_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        timestamp: now.toISOString(),
        date: gregorianDate,
        hijriDate: hijriDate,
        time: now.toLocaleTimeString('ar-SA', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        }),
        dayName: dayName,
        year: now.getFullYear(),
        month: now.getMonth() + 1,
        operationType: operationType,
        user: getCurrentUser(),
        unitNumber: unitData['ุฑูู  ุงููุญุฏุฉ '] || unitData['ุฑูู ุงููุญุฏุฉ'] || 'ุบูุฑ ูุญุฏุฏ',
        propertyName: unitData['ุงุณู ุงูุนูุงุฑ'] || 'ุบูุฑ ูุญุฏุฏ',
        city: unitData['ุงููุฏููุฉ'] || 'ุบูุฑ ูุญุฏุฏ',
        contractNumber: unitData['ุฑูู ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ',
        tenantName: unitData['ุงุณู ุงููุณุชุฃุฌุฑ'] || unitData['ุงููุณุชุฃุฌุฑ'] || '',
        changes: changes,
        originalData: additionalInfo.originalData || null,
        newData: additionalInfo.newData || null,
        previousTenant: additionalInfo.previousTenant || null,
        newTenant: unitData['ุงุณู ุงููุณุชุฃุฌุฑ'] || null,
        reason: additionalInfo.reason || null,
        notes: additionalInfo.notes || null,
        affectedUnits: additionalInfo.affectedUnits || [],
        sourceProperty: additionalInfo.sourceProperty || null,
        destinationProperty: additionalInfo.destinationProperty || null
    };
}

// ุงูุญุตูู ุนูู ุงูุชุงุฑูุฎ ุงููุฌุฑู ุงููุญุณู
function getHijriDate(date) {
    try {
        // ุงุณุชุฎุฏุงู Intl.DateTimeFormat ููุญุตูู ุนูู ุงูุชุงุฑูุฎ ุงููุฌุฑู
        const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }).format(date);

        return hijri;
    } catch (error) {
        // ูู ุญุงูุฉ ุนุฏู ุฏุนู ุงูุชุงุฑูุฎ ุงููุฌุฑูุ ุงุณุชุฎุฏุงู ุชูุฑูุจ ูุญุณู
        console.warn('ูุง ูููู ุงูุญุตูู ุนูู ุงูุชุงุฑูุฎ ุงููุฌุฑูุ ุณูุชู ุงุณุชุฎุฏุงู ุชูุฑูุจ');
        return approximateHijriDate(date);
    }
}

// ุชุญุณูู ุงูุชุงุฑูุฎ ุงููุฌุฑู ุงูุชูุฑูุจู
function approximateHijriDate(date) {
    const hijriMonths = [
        'ูุญุฑู', 'ุตูุฑ', 'ุฑุจูุน ุงูุฃูู', 'ุฑุจูุน ุงูุซุงูู', 'ุฌูุงุฏู ุงูุฃููู', 'ุฌูุงุฏู ุงูุซุงููุฉ',
        'ุฑุฌุจ', 'ุดุนุจุงู', 'ุฑูุถุงู', 'ุดูุงู', 'ุฐู ุงููุนุฏุฉ', 'ุฐู ุงูุญุฌุฉ'
    ];

    // ุชุญุณูู ุงูุชูุฑูุจ: ุงุณุชุฎุฏุงู ูุนุงุฏูุฉ ุฃูุซุฑ ุฏูุฉ
    const gregorianYear = date.getFullYear();
    const gregorianMonth = date.getMonth();
    const gregorianDay = date.getDate();

    // ุชูุฑูุจ ูุญุณู ููุณูุฉ ุงููุฌุฑูุฉ
    const hijriYear = Math.floor(gregorianYear - 621.5 + (gregorianMonth * 30.44 + gregorianDay) / 354.37);

    // ุชูุฑูุจ ููุดูุฑ ุงููุฌุฑู
    const dayOfYear = Math.floor((date - new Date(gregorianYear, 0, 0)) / (1000 * 60 * 60 * 24));
    const hijriMonthIndex = Math.floor((dayOfYear % 354) / 29.5) % 12;
    const hijriDay = Math.floor((dayOfYear % 354) % 29.5) + 1;

    return `${hijriDay} ${hijriMonths[hijriMonthIndex]} ${hijriYear}ูู`;
}

// ุฅุฒุงูุฉ ุงููุธููุฉ ุงูููุฑุฑุฉ - ุชู ุฏูุฌูุง ูู ุงููุธููุฉ ุฃุนูุงู

// ุงูุญุตูู ุนูู ุงุณู ุงูููู
function getDayName(date) {
    const days = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ', 'ุงูุฌูุนุฉ', 'ุงูุณุจุช'];
    return days[date.getDay()];
}

// ุญูุธ ุณุฌู ุงูุชุชุจุน ูู Supabase
async function saveChangeLogToSupabase(changeLog) {
    if (!isTrackingEnabled) return false;

    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            // ูุญุงููุฉ ุฅูุดุงุก ุงูุฌุฏูู ุฅุฐุง ูู ููู ููุฌูุฏุงู
            await createChangeLogsTableIfNotExists();

            const { data, error } = await supabaseClient
                .from('change_logs')
                .insert([changeLog]);

            if (error) {
                console.warn('โ๏ธ ูู ูุชู ุญูุธ ุณุฌู ุงูุชุชุจุน ูู Supabase:', error.message);
                return false;
            }

            console.log('โ ุชู ุญูุธ ุณุฌู ุงูุชุชุจุน ูู Supabase:', changeLog.id);
            return true;
        }
    } catch (error) {
        console.warn('โ๏ธ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจู Supabase ูุญูุธ ุณุฌู ุงูุชุชุจุน:', error.message);
    }

    return false;
}

// ุฅูุดุงุก ุฌุฏูู ุงูุชุชุจุน ุฅุฐุง ูู ููู ููุฌูุฏุงู
async function createChangeLogsTableIfNotExists() {
    try {
        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุฌุฏูู ุฃููุงู
        const { data: tables, error: tablesError } = await supabaseClient
            .from('information_schema.tables')
            .select('table_name')
            .eq('table_name', 'change_logs')
            .eq('table_schema', 'public');

        if (tablesError) {
            console.log('๐ ูุง ูููู ุงูุชุญูู ูู ูุฌูุฏ ุฌุฏูู ุงูุชุชุจุนุ ุณูุชู ุงููุชุงุจุนุฉ ุจุฏููู');
            return false;
        }

        if (tables && tables.length > 0) {
            console.log('โ ุฌุฏูู ุงูุชุชุจุน ููุฌูุฏ ูุณุจูุงู');
            return true;
        }

        console.log('๐ ุฌุฏูู ุงูุชุชุจุน ุบูุฑ ููุฌูุฏุ ุณูุชู ุงูุงุนุชูุงุฏ ุนูู ุงูุชุฎุฒูู ุงููุญูู ููุท');
        return false;
    } catch (error) {
        console.log('๐ ุณูุชู ุงูุงุนุชูุงุฏ ุนูู ุงูุชุฎุฒูู ุงููุญูู ููุชุชุจุน');
        return false;
    }
}

// ุชุญููู ุณุฌูุงุช ุงูุชุชุจุน ูู Supabase
async function loadChangeLogsFromSupabase(limit = 100, offset = 0) {
    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { data, error } = await supabaseClient
                .from('change_logs')
                .select('*')
                .order('timestamp', { ascending: false })
                .range(offset, offset + limit - 1);

            if (error) {
                console.log('๐ ุณูุชู ุงูุงุนุชูุงุฏ ุนูู ุณุฌูุงุช ุงูุชุชุจุน ุงููุญููุฉ');
                return [];
            }

            console.log(`โ ุชู ุชุญููู ${data.length} ุณุฌู ุชุชุจุน ูู Supabase`);
            return data;
        }
    } catch (error) {
        console.log('๐ ุณูุชู ุงูุงุนุชูุงุฏ ุนูู ุณุฌูุงุช ุงูุชุชุจุน ุงููุญููุฉ');
    }

    return [];
}

// ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ุฌุฏูุฏ
async function addChangeLog(operationType, unitData, changes = {}, additionalInfo = {}) {
    if (!isTrackingEnabled) return;

    const changeLog = createChangeLog(operationType, unitData, changes, additionalInfo);

    // ุญูุธ ูุญููุงู
    changeTrackingLogs.unshift(changeLog);

    // ุญูุธ ูู localStorage
    try {
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000))); // ุญูุธ ุขุฎุฑ 1000 ุณุฌู
    } catch (error) {
        console.warn('โ๏ธ ูู ูุชู ุญูุธ ุณุฌูุงุช ุงูุชุชุจุน ูุญููุงู:', error);
    }

    // ุญูุธ ูู Supabase
    await saveChangeLogToSupabase(changeLog);

    console.log('๐ ุชู ุฅุถุงูุฉ ุณุฌู ุชุชุจุน:', operationType, '- ุงููุญุฏุฉ:', changeLog.unitNumber);
}

// ููุงุฑูุฉ ุงูุจูุงูุงุช ูุฅูุดุงุก ุณุฌู ุงูุชุบููุฑุงุช
function compareDataAndCreateChanges(originalData, newData) {
    const changes = {};
    const excludedFields = ['Column1', 'ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ', 'ููุน ุงูุชุญุฏูุซ', 'ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'];

    Object.keys(newData).forEach(key => {
        if (excludedFields.includes(key)) return;

        const oldValue = originalData[key];
        const newValue = newData[key];

        // ุชุญููู ุงูููู ููููุงุฑูุฉ
        const oldStr = (oldValue || '').toString().trim();
        const newStr = (newValue || '').toString().trim();

        if (oldStr !== newStr) {
            changes[key] = {
                old: oldValue,
                new: newValue,
                fieldName: getFieldDisplayName(key)
            };
        }
    });

    return changes;
}

// ุงูุญุตูู ุนูู ุงุณู ุงูุญูู ููุนุฑุถ
function getFieldDisplayName(fieldKey) {
    const fieldNames = {
        'ุงุณู ุงููุณุชุฃุฌุฑ': 'ุงุณู ุงููุณุชุฃุฌุฑ',
        'ุฑูู ุงูุนูุฏ': 'ุฑูู ุงูุนูุฏ',
        'ูููุฉ  ุงูุงูุฌุงุฑ ': 'ูููุฉ ุงูุฅูุฌุงุฑ',
        'ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ': 'ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ',
        'ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ': 'ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ',
        'ุนุฏุฏ ุงูุงูุณุงุท': 'ุนุฏุฏ ุงูุฃูุณุงุท',
        'ููุน ุงูุนูุฏ': 'ููุน ุงูุนูุฏ',
        'ุงููุณุงุญุฉ': 'ุงููุณุงุญุฉ',
        'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก': 'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก',
        'ุงูุงุฑุชูุงุน': 'ุงูุงุฑุชูุงุน',
        'ูููุน ุงูุนูุงุฑ': 'ูููุน ุงูุนูุงุฑ',
        'ุฑูู ุงูุตู': 'ุฑูู ุงูุตู',
        'ุงูุณุฌู ุงูุนููู ': 'ุงูุณุฌู ุงูุนููู',
        'ูุณุงุญุฉุงูุตู': 'ูุณุงุญุฉ ุงูุตู',
        'ุงููุงูู': 'ุงููุงูู'
    };

    return fieldNames[fieldKey] || fieldKey;
}

// ุชุญููู ุณุฌูุงุช ุงูุชุชุจุน ุงููุญููุฉ ุนูุฏ ุจุฏุก ุงูุชุทุจูู
function loadLocalChangeTrackingLogs() {
    try {
        const savedLogs = localStorage.getItem('changeTrackingLogs');
        if (savedLogs) {
            changeTrackingLogs = JSON.parse(savedLogs);
            console.log(`๐ ุชู ุชุญููู ${changeTrackingLogs.length} ุณุฌู ุชุชุจุน ูุญูู`);
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ุณุฌูุงุช ุงูุชุชุจุน ุงููุญููุฉ:', error);
        changeTrackingLogs = [];
    }
}

// ุฅุถุงูุฉ ุญููู ุงูุชุชุจุน ููุจูุงูุงุช ุงูููุฌูุฏุฉ
function addTrackingFieldsToExistingData() {
    let updatedCount = 0;
    const currentDate = new Date().toLocaleDateString('ar-SA');

    properties.forEach((property, index) => {
        // ุฅุถุงูุฉ ุญููู ุงูุชุชุจุน ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        if (!property['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ']) {
            property['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = currentDate;
            property['ููุน ุงูุชุญุฏูุซ'] = 'ุจูุงูุงุช ููุฌูุฏุฉ';
            property['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = getCurrentUser();
            updatedCount++;
        }
    });

    if (updatedCount > 0) {
        console.log(`๐ ุชู ุฅุถุงูุฉ ุญููู ุงูุชุชุจุน ูู ${updatedCount} ูุญุฏุฉ`);

        // ุฅุถุงูุฉ ุชูุงุฑูุฎ ูุชููุนุฉ ูุจุนุถ ุงููุญุฏุงุช ููุงุฎุชุจุงุฑ
        addVariedDatesToUnits();

        saveDataLocally();

        // ูุฒุงููุฉ ุชููุงุฆูุฉ ูุน Supabase
        autoSyncAfterEdit('ุชุญุฏูุซ ุงูุจูุงูุงุช');
    }
}

// ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุชุชุจุน (ููุงุฎุชุจุงุฑ)
function createSampleTrackingData() {
    // ูุณุญ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุงููุฏููุฉ
    changeTrackingLogs = changeTrackingLogs.filter(log => !log.id.includes('sample'));
    console.log('๐๏ธ ุชู ูุณุญ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุงููุฏููุฉ');

    console.log('๐ ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุชุชุจุน...');

    // ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูุชููุนุฉ ุจุชูุงุฑูุฎ ุงูุดูุฑ ุงูุญุงูู
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;

    const sampleLogs = [
        {
            id: 'sample_1_' + Date.now(),
            timestamp: new Date(Date.now() - 86400000).toISOString(), // ุฃูุณ
            date: `${(today.getDate() - 1).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 86400000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.EDIT_DATA,
            user: 'ุงููุฏูุฑ - ุนูุฑ',
            unitNumber: '101',
            propertyName: 'ุนูุงุฑุฉ ุงููุฎูู',
            city: 'ุงูุฑูุงุถ',
            contractNumber: 'C001',
            changes: {
                'ุงุณู ุงููุณุชุฃุฌุฑ': {
                    old: 'ุฃุญูุฏ ูุญูุฏ',
                    new: 'ูุญูุฏ ุฃุญูุฏ',
                    fieldName: 'ุงุณู ุงููุณุชุฃุฌุฑ'
                },
                'ูููุฉ  ุงูุงูุฌุงุฑ ': {
                    old: '2000',
                    new: '2200',
                    fieldName: 'ูููุฉ ุงูุฅูุฌุงุฑ'
                }
            },
            newTenant: 'ูุญูุฏ ุฃุญูุฏ',
            previousTenant: 'ุฃุญูุฏ ูุญูุฏ'
        },
        {
            id: 'sample_2_' + Date.now(),
            timestamp: new Date(Date.now() - 172800000).toISOString(), // ูุจู ููููู
            date: `${Math.max(1, today.getDate() - 2).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 172800000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.NEW_CLIENT,
            user: 'ุงููุฏูุฑ ุงููุณุงุนุฏ - ูุญูุฏ',
            unitNumber: '205',
            propertyName: 'ุจุฑุฌ ุงูุฃูู',
            city: 'ุฌุฏุฉ',
            contractNumber: 'C002',
            changes: {},
            newTenant: 'ุณุงุฑุฉ ุนูู',
            previousTenant: null,
            reason: 'ุนููู ุฌุฏูุฏ'
        },
        {
            id: 'sample_3_' + Date.now(),
            timestamp: new Date(Date.now() - 259200000).toISOString(), // ูุจู 3 ุฃูุงู
            date: `${Math.max(1, today.getDate() - 3).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 259200000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.EMPTY_UNIT,
            user: 'ุงููุฏูุฑ - ุนูุฑ',
            unitNumber: '302',
            propertyName: 'ูุฌูุน ุงููุฑูุฏ',
            city: 'ุงูุฏูุงู',
            contractNumber: 'C003',
            changes: {},
            previousTenant: 'ุฎุงูุฏ ุณุนุฏ',
            reason: 'ุฅูุฑุงุบ ูุญุฏุฉ'
        },
        {
            id: 'sample_4_' + Date.now(),
            timestamp: new Date(Date.now() - 345600000).toISOString(), // ูุจู 4 ุฃูุงู
            date: `${Math.max(1, today.getDate() - 4).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 345600000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.TRANSFER_UNIT,
            user: 'ุงููุฏูุฑ ุงููุณุงุนุฏ - ูุญูุฏ',
            unitNumber: '150',
            propertyName: 'ูููุง ุงููุงุณููู',
            city: 'ุงูุฑูุงุถ',
            contractNumber: 'C004',
            changes: {},
            sourceProperty: 'ุนูุงุฑุฉ ุงูููุฑ',
            destinationProperty: 'ูููุง ุงููุงุณููู',
            reason: 'ููู ูุญุฏุฉ ุจูู ุงูุนูุงุฑุงุช'
        },
        {
            id: 'sample_5_' + Date.now(),
            timestamp: new Date(Date.now() - 432000000).toISOString(), // ูุจู 5 ุฃูุงู
            date: `${Math.max(1, today.getDate() - 5).toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`,
            time: new Date(Date.now() - 432000000).toLocaleTimeString('ar-SA'),
            operationType: OPERATION_TYPES.RENEW_CONTRACT,
            user: 'ุงููุฏูุฑ - ุนูุฑ',
            unitNumber: '401',
            propertyName: 'ุดูู ุงููุฑุฏูุณ',
            city: 'ููุฉ ุงูููุฑูุฉ',
            contractNumber: 'C005',
            changes: {
                'ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ': {
                    old: '31/12/2024',
                    new: '31/12/2025',
                    fieldName: 'ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ'
                },
                'ูููุฉ  ุงูุงูุฌุงุฑ ': {
                    old: '1800',
                    new: '1900',
                    fieldName: 'ูููุฉ ุงูุฅูุฌุงุฑ'
                }
            },
            newTenant: 'ูุงุทูุฉ ุฃุญูุฏ',
            previousTenant: 'ูุงุทูุฉ ุฃุญูุฏ'
        }
    ];

    // ุฅุถุงูุฉ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
    changeTrackingLogs.unshift(...sampleLogs);

    // ุญูุธ ูู localStorage
    try {
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
        console.log(`๐ ุชู ุฅูุดุงุก ${sampleLogs.length} ุณุฌู ุชุชุจุน ุชุฌุฑูุจู`);
    } catch (error) {
        console.warn('โ๏ธ ูู ูุชู ุญูุธ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ูุญููุงู:', error);
    }
}

// ุฅุถุงูุฉ ุชูุงุฑูุฎ ูุชููุนุฉ ูููุญุฏุงุช ููุงุฎุชุจุงุฑ
function addVariedDatesToUnits() {
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1; // JavaScript months are 0-based

    const updateTypes = ['ุชุญุฑูุฑ', 'ุนููู ุฌุฏูุฏ', 'ุชุฌุฏูุฏ ุงูุนูุฏ', 'ุฅูุฑุงุบ ูุญุฏุฉ', 'ููู ูุญุฏุฉ'];
    const users = ['ุงููุฏูุฑ - ุนูุฑ', 'ุงููุฏูุฑ ุงููุณุงุนุฏ - ูุญูุฏ', 'ุงููุณุชุฎุฏู ุงููุญุฏูุฏ - ุฃุญูุฏ'];

    // ุชุญุฏูุซ ุฃูู 15 ูุญุฏุฉ ุจุชูุงุฑูุฎ ูู ุงูุดูุฑ ุงูุญุงูู
    for (let i = 0; i < Math.min(15, properties.length); i++) {
        // ุฅูุดุงุก ุชูุงุฑูุฎ ูุฎุชููุฉ ูู ุงูุดูุฑ ุงูุญุงูู
        const day = Math.max(1, Math.min(28, i + 1)); // ุฃูุงู ูู 1 ุฅูู 28 ูุชุฌูุจ ูุดุงูู ุงูุดููุฑ
        const updateDate = `${day.toString().padStart(2, '0')}/${currentMonth.toString().padStart(2, '0')}/${currentYear}`;

        properties[i]['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = updateDate;
        properties[i]['ููุน ุงูุชุญุฏูุซ'] = updateTypes[i % updateTypes.length];
        properties[i]['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = users[i % users.length];

        console.log(`๐ ุชุญุฏูุซ ุงููุญุฏุฉ ${i + 1}: ${updateDate} - ${updateTypes[i % updateTypes.length]}`);
    }

    console.log(`๐ ุชู ุฅุถุงูุฉ ุชูุงุฑูุฎ ูุชููุนุฉ ูู ${Math.min(15, properties.length)} ูุญุฏุฉ ูู ${currentMonth}/${currentYear}`);
}

// ูุชุบูุฑ ูุญูุธ ุงููุญุชูู ุงูุณุงุจู
let previousMainContent = null;
let isTrackingViewActive = false;

// ุนุฑุถ ุณุฌูุงุช ุงูุชุชุจุน ูู ุงููุณู ุงูุฑุฆูุณู
async function showChangeTrackingModal() {
    console.log('๐ ุจุฏุก ุนุฑุถ ุณุฌูุงุช ุงูุชุชุจุน ูู ุงููุณู ุงูุฑุฆูุณู...');
    console.log('๐ ุนุฏุฏ ุงูุณุฌูุงุช ุงููุญููุฉ:', changeTrackingLogs.length);

    // ุญุฐู ุฃู ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุฌูุฏุฉ
    cleanupSampleTrackingData();

    // ุชุญููู ุงูุณุฌูุงุช ูู Supabase
    const cloudLogs = await loadChangeLogsFromSupabase(50);
    console.log('โ๏ธ ุนุฏุฏ ุงูุณุฌูุงุช ุงูุณุญุงุจูุฉ:', cloudLogs.length);

    // ุฏูุฌ ุงูุณุฌูุงุช ุงููุญููุฉ ูุงูุณุญุงุจูุฉ
    const allLogs = [...cloudLogs, ...changeTrackingLogs];
    console.log('๐ ุฅุฌูุงูู ุงูุณุฌูุงุช ูุจู ุฅุฒุงูุฉ ุงูููุฑุฑุงุช:', allLogs.length);

    // ุฅุฒุงูุฉ ุงูููุฑุฑุงุช ูุชุฑุชูุจ ุญุณุจ ุงูุชุงุฑูุฎ
    const uniqueLogs = allLogs.filter((log, index, self) =>
        index === self.findIndex(l => l.id === log.id)
    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    console.log('โ ุฅุฌูุงูู ุงูุณุฌูุงุช ุจุนุฏ ุฅุฒุงูุฉ ุงูููุฑุฑุงุช:', uniqueLogs.length);

    // ุญูุธ ุงููุญุชูู ุงูุญุงูู
    const mainContent = document.getElementById('content');
    if (!isTrackingViewActive) {
        previousMainContent = mainContent.innerHTML;
    }

    // ุชุนููู ุญุงูุฉ ุนุฑุถ ุงูุชุชุจุน
    isTrackingViewActive = true;

    // ุฅูุดุงุก ูุญุชูู ุณุฌู ุงูุชุชุจุน ูููุณู ุงูุฑุฆูุณู
    const trackingHtml = `
        <div class="tracking-main-view">
            <div class="tracking-header">
                <div class="tracking-title-section">
                    <button onclick="closeTrackingView()" class="back-btn">
                        <i class="fas fa-arrow-right"></i> ุงูุนูุฏุฉ
                    </button>
                    <h2><i class="fas fa-history"></i> ุณุฌู ุชุชุจุน ุงูุชุบููุฑุงุช</h2>
                    <p class="tracking-stats">ุฅุฌูุงูู ุงูุณุฌูุงุช: ${uniqueLogs.length}</p>
                </div>
            </div>

            <div class="tracking-filters">
                <div class="filter-group">
                    <label>ููุชุฑ ุจุงูุชุงุฑูุฎ:</label>
                    <input type="date" id="trackingDateFilter" placeholder="ุงุฎุชุฑ ุชุงุฑูุฎ">
                </div>
                <div class="filter-group">
                    <label>ููุชุฑ ุจุงูุดูุฑ ูุงูุณูุฉ:</label>
                    <input type="month" id="trackingMonthFilter" placeholder="ุงุฎุชุฑ ุดูุฑ ูุณูุฉ">
                </div>
                <div class="filter-group">
                    <label>ููุน ุงูุนูููุฉ:</label>
                    <select id="trackingOperationType">
                        <option value="">ุฌููุน ุงูุนูููุงุช</option>
                        ${Object.values(OPERATION_TYPES).map(type =>
                            `<option value="${type}">${type}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label>ุงูุจุญุซ:</label>
                    <input type="text" id="trackingSearch" placeholder="ุจุญุซ ูู ุงููุญุฏุงุชุ ุงูุนูุงุฑุงุชุ ุฃู ุงููุณุชุฃุฌุฑูู...">
                </div>
                <button onclick="filterTrackingLogs()" class="filter-btn">
                    <i class="fas fa-filter"></i> ุชุทุจูู ุงูููุชุฑ
                </button>
                <button onclick="clearTrackingFilters()" class="clear-filter-btn">
                    <i class="fas fa-times"></i> ูุณุญ ุงูููุงุชุฑ
                </button>
            </div>

            <div class="tracking-actions">
                <button onclick="exportTrackingLogs()" class="export-btn">
                    <i class="fas fa-download"></i> ุชุตุฏูุฑ Excel
                </button>
                <button onclick="printTrackingLogs()" class="print-btn">
                    <i class="fas fa-print"></i> ุทุจุงุนุฉ
                </button>
                <button onclick="refreshTrackingLogs()" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i> ุชุญุฏูุซ
                </button>
            </div>

            <div class="tracking-logs-container" id="trackingLogsContainer">
                ${renderTrackingLogs(uniqueLogs)}
            </div>
        </div>
    `;

    // ุนุฑุถ ุงููุญุชูู ูู ุงููุณู ุงูุฑุฆูุณู
    mainContent.innerHTML = trackingHtml;

    // ุฅุฎูุงุก ุงูุดุฑูุท ุงูุฌุงูุจู ูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ ูุฅูุณุงุญ ุงููุฌุงู ุฃูุซุฑ
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.style.display = 'none';
        }
    }

    // ุฅุถุงูุฉ ูุนุงูุฌ ููุถุบุท ุนูู ููุชุงุญ Escape ููุนูุฏุฉ
    const handleEscapeKey = (event) => {
        if (event.key === 'Escape' && isTrackingViewActive) {
            closeTrackingView();
        }
    };

    // ุฅุถุงูุฉ ูุนุงูุฌ ุงูุฃุญุฏุงุซ
    document.addEventListener('keydown', handleEscapeKey);

    // ุญูุธ ูุฑุฌุน ูุฅุฒุงูุฉ ุงููุนุงูุฌ ูุงุญูุงู
    window.trackingEscapeHandler = handleEscapeKey;

    console.log('โ ุชู ุนุฑุถ ุณุฌูุงุช ุงูุชุชุจุน ูู ุงููุณู ุงูุฑุฆูุณู');
}

// ุชูุธูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
function cleanupSampleTrackingData() {
    console.log('๐งน ุชูุธูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ...');

    const originalLength = changeTrackingLogs.length;

    // ุญุฐู ุงูุณุฌูุงุช ุงูุชู ุชุญุชูู ุนูู 'sample' ูู ุงููุนุฑู
    changeTrackingLogs = changeTrackingLogs.filter(log =>
        !log.id.includes('sample') &&
        !log.id.includes('test') &&
        !log.unitNumber.includes('TEST') &&
        !log.propertyName.includes('ุชุฌุฑูุจู')
    );

    const deletedCount = originalLength - changeTrackingLogs.length;

    if (deletedCount > 0) {
        // ุญูุธ ุงูุชุบููุฑุงุช ูู ุงูุชุฎุฒูู ุงููุญูู
        try {
            localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
            console.log(`โ ุชู ุญุฐู ${deletedCount} ุณุฌู ุชุฌุฑูุจู ูู ุงูุชุฎุฒูู ุงููุญูู`);
        } catch (error) {
            console.warn('โ๏ธ ูู ูุชู ุญูุธ ุงูุชุบููุฑุงุช ูุญููุงู:', error);
        }

        // ุญุฐู ูู Supabase ุฃูุถุงู
        cleanupSampleDataFromSupabase();
    } else {
        console.log('โน๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุญุฐู');
    }
}

// ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ูู Supabase
async function cleanupSampleDataFromSupabase() {
    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { data: sampleLogs, error: fetchError } = await supabaseClient
                .from('change_logs')
                .select('id')
                .or('id.ilike.%sample%,id.ilike.%test%,unit_number.ilike.%TEST%,property_name.ilike.%ุชุฌุฑูุจู%');

            if (!fetchError && sampleLogs && sampleLogs.length > 0) {
                const { error: deleteError } = await supabaseClient
                    .from('change_logs')
                    .delete()
                    .in('id', sampleLogs.map(log => log.id));

                if (!deleteError) {
                    console.log(`โ ุชู ุญุฐู ${sampleLogs.length} ุณุฌู ุชุฌุฑูุจู ูู Supabase`);
                } else {
                    console.warn('โ๏ธ ุฎุทุฃ ูู ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ูู Supabase:', deleteError);
                }
            }
        }
    } catch (error) {
        console.warn('โ๏ธ ุฎุทุฃ ูู ุชูุธูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ูู Supabase:', error);
    }
}

// ุฅุบูุงู ุนุฑุถ ุงูุชุชุจุน ูุงูุนูุฏุฉ ูููุญุชูู ุงูุณุงุจู
function closeTrackingView() {
    console.log('๐ ุฅุบูุงู ุนุฑุถ ุณุฌูุงุช ุงูุชุชุจุน...');

    const mainContent = document.getElementById('content');

    if (previousMainContent) {
        // ุงุณุชุนุงุฏุฉ ุงููุญุชูู ุงูุณุงุจู
        mainContent.innerHTML = previousMainContent;
        console.log('โ ุชู ุงุณุชุนุงุฏุฉ ุงููุญุชูู ุงูุณุงุจู');
    } else {
        // ุฅุฐุง ูู ููู ููุงู ูุญุชูู ุณุงุจูุ ุนุฑุถ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ
        renderData();
        console.log('โ ุชู ุนุฑุถ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ');
    }

    // ุฅุธูุงุฑ ุงูุดุฑูุท ุงูุฌุงูุจู ูุฑุฉ ุฃุฎุฑู ูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.style.display = '';
        }
    }

    // ุฅุฒุงูุฉ ูุนุงูุฌ ููุชุงุญ Escape
    if (window.trackingEscapeHandler) {
        document.removeEventListener('keydown', window.trackingEscapeHandler);
        window.trackingEscapeHandler = null;
    }

    // ุฅุนุงุฏุฉ ุชุนููู ุงูุญุงูุฉ
    isTrackingViewActive = false;
    previousMainContent = null;

    console.log('โ ุชู ุฅุบูุงู ุนุฑุถ ุงูุชุชุจุน ุจูุฌุงุญ');
}

// ุชุญุฏูุซ ุณุฌูุงุช ุงูุชุชุจุน
async function refreshTrackingLogs() {
    console.log('๐ ุชุญุฏูุซ ุณุฌูุงุช ุงูุชุชุจุน...');

    if (isTrackingViewActive) {
        // ุฅุนุงุฏุฉ ุชุญููู ุนุฑุถ ุงูุชุชุจุน
        await showChangeTrackingModal();
        console.log('โ ุชู ุชุญุฏูุซ ุณุฌูุงุช ุงูุชุชุจุน');
    }
}

// ===== ูุธุงู ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน (ูููุฏูุฑ ููุท) =====

// ุนุฑุถ ูุงูุฐุฉ ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน
async function showTrackingManagementModal() {
    console.log('๐ง ุนุฑุถ ูุงูุฐุฉ ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน...');

    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!checkPermission('manageProperties')) {
        showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน', 'error');
        return;
    }

    // ุชูุธูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุฃููุงู
    cleanupSampleTrackingData();

    // ุชุญููู ุฌููุน ุงูุณุฌูุงุช
    const cloudLogs = await loadChangeLogsFromSupabase(1000);
    const allLogs = [...cloudLogs, ...changeTrackingLogs];

    // ุฅุฒุงูุฉ ุงูููุฑุฑุงุช
    const uniqueLogs = allLogs.filter((log, index, self) =>
        index === self.findIndex(l => l.id === log.id)
    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    console.log(`๐ ุฅุฌูุงูู ุงูุณุฌูุงุช ููุฅุฏุงุฑุฉ: ${uniqueLogs.length}`);

    const modalHtml = `
        <div class="modal-overlay" style="display:flex; z-index: 10000;">
            <div class="modal-box tracking-management-modal" style="max-width: 1400px; max-height: 95vh; width: 95%;">
                <button class="close-modal" onclick="closeModal()">ร</button>

                <div class="modal-header">
                    <h2><i class="fas fa-cogs"></i> ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน</h2>
                    <p class="management-warning">โ๏ธ ุชุญุฐูุฑ: ูุฐู ุงูุตูุญุฉ ูููุฏูุฑ ููุท - ูููู ุญุฐู ุงูุณุฌูุงุช ููุงุฆูุงู</p>
                    <div class="logs-stats">
                        <span class="stat-item">ุฅุฌูุงูู ุงูุณุฌูุงุช: <strong id="totalLogsCount">${uniqueLogs.length}</strong></span>
                        <span class="stat-item">ุงููุญุฏุฏุฉ: <strong id="selectedLogsCount">0</strong></span>
                    </div>
                </div>

                <div class="management-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>ููุชุฑ ุจุงูุชุงุฑูุฎ:</label>
                            <input type="date" id="mgmtDateFilter" placeholder="ุงุฎุชุฑ ุชุงุฑูุฎ">
                        </div>
                        <div class="filter-group">
                            <label>ููุชุฑ ุจุงูุดูุฑ ูุงูุณูุฉ:</label>
                            <input type="month" id="mgmtMonthFilter" placeholder="ุงุฎุชุฑ ุดูุฑ ูุณูุฉ">
                        </div>
                        <div class="filter-group">
                            <label>ููุน ุงูุนูููุฉ:</label>
                            <select id="mgmtOperationType">
                                <option value="">ุฌููุน ุงูุนูููุงุช</option>
                                ${Object.values(OPERATION_TYPES).map(type =>
                                    `<option value="${type}">${type}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>ุงููุณุชุฎุฏู:</label>
                            <select id="mgmtUserFilter">
                                <option value="">ุฌููุน ุงููุณุชุฎุฏููู</option>
                                ${getUniqueUsers(uniqueLogs).map(user =>
                                    `<option value="${user}">${user}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="filter-row">
                        <div class="filter-group">
                            <label>ุงูุจุญุซ:</label>
                            <input type="text" id="mgmtSearch" placeholder="ุจุญุซ ูู ุงููุญุฏุงุช ุฃู ุงูุนูุงุฑุงุช...">
                        </div>
                        <div class="filter-actions">
                            <button onclick="applyManagementFilters()" class="filter-btn">
                                <i class="fas fa-filter"></i> ุชุทุจูู ุงูููุชุฑ
                            </button>
                            <button onclick="clearManagementFilters()" class="clear-btn">
                                <i class="fas fa-times"></i> ูุณุญ ุงูููุงุชุฑ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="management-actions">
                    <div class="selection-actions">
                        <button onclick="selectAllLogs()" class="select-btn">
                            <i class="fas fa-check-square"></i> ุชุญุฏูุฏ ุงููู
                        </button>
                        <button onclick="deselectAllLogs()" class="deselect-btn">
                            <i class="fas fa-square"></i> ุฅูุบุงุก ุงูุชุญุฏูุฏ
                        </button>
                        <button onclick="selectByType()" class="select-type-btn">
                            <i class="fas fa-filter"></i> ุชุญุฏูุฏ ุญุณุจ ุงูููุน
                        </button>
                    </div>

                    <div class="delete-actions">
                        <button onclick="deleteSelectedLogs()" class="delete-selected-btn" disabled>
                            <i class="fas fa-trash"></i> ุญุฐู ุงููุญุฏุฏุฉ
                        </button>
                        <button onclick="deleteByDate()" class="delete-date-btn">
                            <i class="fas fa-calendar-times"></i> ุญุฐู ููู ูุงูู
                        </button>
                        <button onclick="deleteByType()" class="delete-type-btn">
                            <i class="fas fa-layer-group"></i> ุญุฐู ุญุณุจ ุงูููุน
                        </button>
                        <button onclick="deleteByUser()" class="delete-user-btn">
                            <i class="fas fa-user-times"></i> ุญุฐู ุญุณุจ ุงููุณุชุฎุฏู
                        </button>
                        <button onclick="deleteAllLogs()" class="delete-all-btn">
                            <i class="fas fa-exclamation-triangle"></i> ุญุฐู ุงููู
                        </button>
                    </div>
                </div>

                <div class="management-logs-container" id="managementLogsContainer">
                    ${renderManagementLogs(uniqueLogs)}
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // ุญูุธ ุงูุณุฌูุงุช ูู ูุชุบูุฑ ุนุงู ููุงุณุชุฎุฏุงู
    window.currentManagementLogs = uniqueLogs;

    console.log('โ ุชู ุนุฑุถ ูุงูุฐุฉ ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน');
}

// ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุฑูุฏุฉ
function getUniqueUsers(logs) {
    const users = [...new Set(logs.map(log => log.user || 'ุบูุฑ ูุญุฏุฏ'))];
    return users.sort();
}

// ุนุฑุถ ุงูุณุฌูุงุช ูู ูุงุฌูุฉ ุงูุฅุฏุงุฑุฉ
function renderManagementLogs(logs) {
    if (!logs || logs.length === 0) {
        return `
            <div class="no-logs">
                <i class="fas fa-clipboard-list"></i>
                <h3>ูุง ุชูุฌุฏ ุณุฌูุงุช ููุนุฑุถ</h3>
                <p>ูุง ุชูุฌุฏ ุณุฌูุงุช ุชุชุจุน ูุชุงุญุฉ ููุฅุฏุงุฑุฉ</p>
            </div>
        `;
    }

    return `
        <div class="management-logs-list">
            ${logs.map((log, index) => `
                <div class="management-log-entry" data-log-id="${log.id}">
                    <div class="log-checkbox">
                        <input type="checkbox" id="log_${index}" class="log-selector"
                               onchange="updateSelectedCount()" data-log-id="${log.id}">
                        <label for="log_${index}"></label>
                    </div>

                    <div class="log-content">
                        <div class="log-header">
                            <div class="log-operation">
                                <i class="fas fa-cog"></i>
                                ${log.operationType}
                            </div>
                            <div class="log-meta">
                                <span class="log-date">${log.date}</span>
                                <span class="log-time">${log.time}</span>
                                <span class="log-user">${log.user || 'ุบูุฑ ูุญุฏุฏ'}</span>
                            </div>
                        </div>

                        <div class="log-details">
                            <div class="log-property">
                                <strong>ุงูุนูุงุฑ:</strong> ${log.propertyName}
                            </div>
                            <div class="log-unit">
                                <strong>ุงููุญุฏุฉ:</strong> ${log.unitNumber}
                            </div>
                            ${log.changes && Object.keys(log.changes).length > 0 ? `
                                <div class="log-changes">
                                    <strong>ุงูุชุบููุฑุงุช:</strong>
                                    ${Object.entries(log.changes).map(([field, change]) =>
                                        `<span class="change-item">${change.fieldName}: ${change.old} โ ${change.new}</span>`
                                    ).join(', ')}
                                </div>
                            ` : ''}
                        </div>

                        <div class="log-actions">
                            <button onclick="deleteIndividualLog('${log.id}')" class="delete-single-btn">
                                <i class="fas fa-trash"></i> ุญุฐู
                            </button>
                            <button onclick="viewLogDetails('${log.id}')" class="view-details-btn">
                                <i class="fas fa-eye"></i> ุงูุชูุงุตูู
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// ุชุญุฏูุซ ุนุฏุงุฏ ุงูุณุฌูุงุช ุงููุญุฏุฏุฉ
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.log-selector:checked');
    const count = checkboxes.length;

    document.getElementById('selectedLogsCount').textContent = count;

    // ุชูุนูู/ุชุนุทูู ุฒุฑ ุงูุญุฐู
    const deleteBtn = document.querySelector('.delete-selected-btn');
    if (deleteBtn) {
        deleteBtn.disabled = count === 0;
    }
}

// ุชุญุฏูุฏ ุฌููุน ุงูุณุฌูุงุช
function selectAllLogs() {
    const checkboxes = document.querySelectorAll('.log-selector');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

// ุฅูุบุงุก ุชุญุฏูุฏ ุฌููุน ุงูุณุฌูุงุช
function deselectAllLogs() {
    const checkboxes = document.querySelectorAll('.log-selector');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

// ุชุญุฏูุฏ ุงูุณุฌูุงุช ุญุณุจ ุงูููุน
function selectByType() {
    const operationType = document.getElementById('mgmtOperationType').value;
    if (!operationType) {
        showToast('ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุนูููุฉ ุฃููุงู', 'warning');
        return;
    }

    const checkboxes = document.querySelectorAll('.log-selector');
    checkboxes.forEach(checkbox => {
        const logEntry = checkbox.closest('.management-log-entry');
        const logOperation = logEntry.querySelector('.log-operation').textContent.trim();
        checkbox.checked = logOperation === operationType;
    });
    updateSelectedCount();
}

// ุญุฐู ุณุฌู ูุงุญุฏ
async function deleteIndividualLog(logId) {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุฌูุ\nูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
        return;
    }

    console.log(`๐๏ธ ุญุฐู ุงูุณุฌู: ${logId}`);

    try {
        // ุญุฐู ูู ุงููุตูููุฉ ุงููุญููุฉ
        const localIndex = changeTrackingLogs.findIndex(log => log.id === logId);
        if (localIndex !== -1) {
            changeTrackingLogs.splice(localIndex, 1);
            localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
        }

        // ุญุฐู ูู Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .eq('id', logId);

            if (error) {
                console.warn('โ๏ธ ูู ูุชู ุญุฐู ุงูุณุฌู ูู Supabase:', error);
            }
        }

        // ุฅุฒุงูุฉ ูู ุงููุงุฌูุฉ
        const logElement = document.querySelector(`[data-log-id="${logId}"]`);
        if (logElement) {
            logElement.remove();
        }

        // ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช
        updateLogsCount();
        updateSelectedCount();

        showToast('ุชู ุญุฐู ุงูุณุฌู ุจูุฌุงุญ', 'success');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงูุณุฌู:', error);
        showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุณุฌู', 'error');
    }
}

// ุญุฐู ุงูุณุฌูุงุช ุงููุญุฏุฏุฉ
async function deleteSelectedLogs() {
    const checkboxes = document.querySelectorAll('.log-selector:checked');
    const count = checkboxes.length;

    if (count === 0) {
        showToast('ูุฑุฌู ุชุญุฏูุฏ ุณุฌูุงุช ููุญุฐู', 'warning');
        return;
    }

    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ${count} ุณุฌูุ\nูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.`)) {
        return;
    }

    console.log(`๐๏ธ ุญุฐู ${count} ุณุฌู ูุญุฏุฏ...`);

    const logIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-log-id'));

    try {
        // ุญุฐู ูู ุงููุตูููุฉ ุงููุญููุฉ
        logIds.forEach(logId => {
            const index = changeTrackingLogs.findIndex(log => log.id === logId);
            if (index !== -1) {
                changeTrackingLogs.splice(index, 1);
            }
        });

        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));

        // ุญุฐู ูู Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .in('id', logIds);

            if (error) {
                console.warn('โ๏ธ ูู ูุชู ุญุฐู ุจุนุถ ุงูุณุฌูุงุช ูู Supabase:', error);
            }
        }

        // ุฅุฒุงูุฉ ูู ุงููุงุฌูุฉ
        logIds.forEach(logId => {
            const logElement = document.querySelector(`[data-log-id="${logId}"]`);
            if (logElement) {
                logElement.remove();
            }
        });

        // ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช
        updateLogsCount();
        updateSelectedCount();

        showToast(`ุชู ุญุฐู ${count} ุณุฌู ุจูุฌุงุญ`, 'success');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงูุณุฌูุงุช:', error);
        showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุณุฌูุงุช', 'error');
    }
}

// ุญุฐู ุนูููุงุช ููู ูุงูู
async function deleteByDate() {
    const date = prompt('ุฃุฏุฎู ุงูุชุงุฑูุฎ ูุญุฐู ุฌููุน ุงูุนูููุงุช (YYYY-MM-DD):');
    if (!date) return;

    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุนูููุงุช ููู ${date}ุ\nูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.`)) {
        return;
    }

    console.log(`๐๏ธ ุญุฐู ุนูููุงุช ููู ${date}...`);

    try {
        const targetDate = new Date(date).toLocaleDateString('ar-SA');

        // ุงูุนุซูุฑ ุนูู ุงูุณุฌูุงุช ุงููุทุงุจูุฉ
        const logsToDelete = changeTrackingLogs.filter(log => log.date === targetDate);
        const logIds = logsToDelete.map(log => log.id);

        if (logIds.length === 0) {
            showToast('ูุง ุชูุฌุฏ ุณุฌูุงุช ูู ูุฐุง ุงูุชุงุฑูุฎ', 'info');
            return;
        }

        // ุญุฐู ูู ุงููุตูููุฉ ุงููุญููุฉ
        changeTrackingLogs = changeTrackingLogs.filter(log => log.date !== targetDate);
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));

        // ุญุฐู ูู Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .in('id', logIds);

            if (error) {
                console.warn('โ๏ธ ูู ูุชู ุญุฐู ุจุนุถ ุงูุณุฌูุงุช ูู Supabase:', error);
            }
        }

        // ุชุญุฏูุซ ุงููุงุฌูุฉ
        await refreshManagementView();

        showToast(`ุชู ุญุฐู ${logIds.length} ุณุฌู ูู ุชุงุฑูุฎ ${date}`, 'success');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุนูููุงุช ุงูููู:', error);
        showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุนูููุงุช ุงูููู', 'error');
    }
}

// ุญุฐู ุนูููุงุช ุญุณุจ ุงูููุน
async function deleteByType() {
    const operationType = prompt(`ุฃุฏุฎู ููุน ุงูุนูููุฉ ููุญุฐู:\n${Object.values(OPERATION_TYPES).join('\n')}`);
    if (!operationType) return;

    if (!Object.values(OPERATION_TYPES).includes(operationType)) {
        showToast('ููุน ุงูุนูููุฉ ุบูุฑ ุตุญูุญ', 'error');
        return;
    }

    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุนูููุงุช "${operationType}"ุ\nูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.`)) {
        return;
    }

    console.log(`๐๏ธ ุญุฐู ุนูููุงุช ููุน ${operationType}...`);

    try {
        // ุงูุนุซูุฑ ุนูู ุงูุณุฌูุงุช ุงููุทุงุจูุฉ
        const logsToDelete = changeTrackingLogs.filter(log => log.operationType === operationType);
        const logIds = logsToDelete.map(log => log.id);

        if (logIds.length === 0) {
            showToast('ูุง ุชูุฌุฏ ุณุฌูุงุช ูู ูุฐุง ุงูููุน', 'info');
            return;
        }

        // ุญุฐู ูู ุงููุตูููุฉ ุงููุญููุฉ
        changeTrackingLogs = changeTrackingLogs.filter(log => log.operationType !== operationType);
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));

        // ุญุฐู ูู Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .in('id', logIds);

            if (error) {
                console.warn('โ๏ธ ูู ูุชู ุญุฐู ุจุนุถ ุงูุณุฌูุงุช ูู Supabase:', error);
            }
        }

        // ุชุญุฏูุซ ุงููุงุฌูุฉ
        await refreshManagementView();

        showToast(`ุชู ุญุฐู ${logIds.length} ุณุฌู ูู ููุน "${operationType}"`, 'success');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุนูููุงุช ุงูููุน:', error);
        showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุนูููุงุช ุงูููุน', 'error');
    }
}

// ุญุฐู ุนูููุงุช ุญุณุจ ุงููุณุชุฎุฏู
async function deleteByUser() {
    const user = prompt('ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู ูุญุฐู ุฌููุน ุนูููุงุชู:');
    if (!user) return;

    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุนูููุงุช ุงููุณุชุฎุฏู "${user}"ุ\nูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.`)) {
        return;
    }

    console.log(`๐๏ธ ุญุฐู ุนูููุงุช ุงููุณุชุฎุฏู ${user}...`);

    try {
        // ุงูุนุซูุฑ ุนูู ุงูุณุฌูุงุช ุงููุทุงุจูุฉ
        const logsToDelete = changeTrackingLogs.filter(log => (log.user || 'ุบูุฑ ูุญุฏุฏ') === user);
        const logIds = logsToDelete.map(log => log.id);

        if (logIds.length === 0) {
            showToast('ูุง ุชูุฌุฏ ุณุฌูุงุช ููุฐุง ุงููุณุชุฎุฏู', 'info');
            return;
        }

        // ุญุฐู ูู ุงููุตูููุฉ ุงููุญููุฉ
        changeTrackingLogs = changeTrackingLogs.filter(log => (log.user || 'ุบูุฑ ูุญุฏุฏ') !== user);
        localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));

        // ุญุฐู ูู Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .in('id', logIds);

            if (error) {
                console.warn('โ๏ธ ูู ูุชู ุญุฐู ุจุนุถ ุงูุณุฌูุงุช ูู Supabase:', error);
            }
        }

        // ุชุญุฏูุซ ุงููุงุฌูุฉ
        await refreshManagementView();

        showToast(`ุชู ุญุฐู ${logIds.length} ุณุฌู ูููุณุชุฎุฏู "${user}"`, 'success');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุนูููุงุช ุงููุณุชุฎุฏู:', error);
        showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุนูููุงุช ุงููุณุชุฎุฏู', 'error');
    }
}

// ุญุฐู ุฌููุน ุงูุณุฌูุงุช
async function deleteAllLogs() {
    if (!confirm('โ๏ธ ุชุญุฐูุฑ ุฎุทูุฑ!\n\nูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุณุฌูุงุช ุงูุชุชุจุนุ\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู ููุงุฆูุงู!')) {
        return;
    }

    if (!confirm('ุชุฃููุฏ ููุงุฆู: ุณูุชู ุญุฐู ุฌููุน ุงูุณุฌูุงุช ูู ุงููุธุงู ูุงูุณุญุงุจุฉ.\nุงูุชุจ "ูุนู" ูููุชุงุจุนุฉ:') ||
        prompt('ุงูุชุจ "ุญุฐู ุงููู" ููุชุฃููุฏ:') !== 'ุญุฐู ุงููู') {
        showToast('ุชู ุฅูุบุงุก ุงูุนูููุฉ', 'info');
        return;
    }

    console.log('๐๏ธ ุญุฐู ุฌููุน ุณุฌูุงุช ุงูุชุชุจุน...');

    try {
        const totalCount = changeTrackingLogs.length;

        // ุญุฐู ูู ุงููุตูููุฉ ุงููุญููุฉ
        changeTrackingLogs = [];
        localStorage.removeItem('changeTrackingLogs');

        // ุญุฐู ูู Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            const { error } = await supabaseClient
                .from('change_logs')
                .delete()
                .neq('id', ''); // ุญุฐู ุฌููุน ุงูุณุฌูุงุช

            if (error) {
                console.warn('โ๏ธ ูู ูุชู ุญุฐู ุงูุณุฌูุงุช ูู Supabase:', error);
            }
        }

        // ุฅุบูุงู ุงููุงูุฐุฉ ูุชุญุฏูุซ ุงููุงุฌูุฉ
        closeModal();

        showToast(`ุชู ุญุฐู ุฌููุน ุงูุณุฌูุงุช (${totalCount} ุณุฌู) ุจูุฌุงุญ`, 'success');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุฌููุน ุงูุณุฌูุงุช:', error);
        showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุฌููุน ุงูุณุฌูุงุช', 'error');
    }
}

// ุชุทุจูู ููุงุชุฑ ุงูุฅุฏุงุฑุฉ ุงููุญุณูุฉ
function applyManagementFilters() {
    const dateFilter = document.getElementById('mgmtDateFilter').value;
    const monthFilter = document.getElementById('mgmtMonthFilter').value;
    const operationType = document.getElementById('mgmtOperationType').value;
    const userFilter = document.getElementById('mgmtUserFilter').value;
    const searchTerm = document.getElementById('mgmtSearch').value.toLowerCase();

    let filteredLogs = window.currentManagementLogs || [];

    // ููุชุฑุฉ ุจุงูุชุงุฑูุฎ ุงููุญุฏุฏ
    if (dateFilter) {
        const filterDate = new Date(dateFilter);
        filteredLogs = filteredLogs.filter(log => {
            const logDate = new Date(log.timestamp);
            return logDate.toDateString() === filterDate.toDateString();
        });
    }

    // ููุชุฑุฉ ุจุงูุดูุฑ ูุงูุณูุฉ
    if (monthFilter) {
        const [filterYear, filterMonth] = monthFilter.split('-');
        filteredLogs = filteredLogs.filter(log => {
            const logDate = new Date(log.timestamp);
            return logDate.getFullYear() === parseInt(filterYear) &&
                   (logDate.getMonth() + 1) === parseInt(filterMonth);
        });
    }

    // ููุชุฑุฉ ุจููุน ุงูุนูููุฉ
    if (operationType) {
        filteredLogs = filteredLogs.filter(log => log.operationType === operationType);
    }

    // ููุชุฑุฉ ุจุงููุณุชุฎุฏู
    if (userFilter) {
        filteredLogs = filteredLogs.filter(log => (log.user || 'ุบูุฑ ูุญุฏุฏ') === userFilter);
    }

    // ููุชุฑุฉ ุจุงูุจุญุซ
    if (searchTerm) {
        filteredLogs = filteredLogs.filter(log =>
            log.propertyName.toLowerCase().includes(searchTerm) ||
            log.unitNumber.toLowerCase().includes(searchTerm) ||
            log.operationType.toLowerCase().includes(searchTerm)
        );
    }

    // ุชุญุฏูุซ ุงูุนุฑุถ
    const container = document.getElementById('managementLogsContainer');
    if (container) {
        container.innerHTML = renderManagementLogs(filteredLogs);
    }

    // ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช
    document.getElementById('totalLogsCount').textContent = filteredLogs.length;
    updateSelectedCount();

    console.log(`๐ ุชู ุชุทุจูู ุงูููุงุชุฑ: ${filteredLogs.length} ุณุฌู`);
}

// ูุณุญ ููุงุชุฑ ุงูุฅุฏุงุฑุฉ
function clearManagementFilters() {
    document.getElementById('mgmtDateFilter').value = '';
    document.getElementById('mgmtMonthFilter').value = '';
    document.getElementById('mgmtOperationType').value = '';
    document.getElementById('mgmtUserFilter').value = '';
    document.getElementById('mgmtSearch').value = '';

    // ุฅุนุงุฏุฉ ุนุฑุถ ุฌููุน ุงูุณุฌูุงุช
    const container = document.getElementById('managementLogsContainer');
    if (container && window.currentManagementLogs) {
        container.innerHTML = renderManagementLogs(window.currentManagementLogs);
        document.getElementById('totalLogsCount').textContent = window.currentManagementLogs.length;
    }

    updateSelectedCount();
    console.log('๐งน ุชู ูุณุญ ุฌููุน ุงูููุงุชุฑ');
}

// ุชุญุฏูุซ ุนุฑุถ ุงูุฅุฏุงุฑุฉ
async function refreshManagementView() {
    // ุฅุนุงุฏุฉ ุชุญููู ุงูุณุฌูุงุช
    const cloudLogs = await loadChangeLogsFromSupabase(1000);
    const allLogs = [...cloudLogs, ...changeTrackingLogs];

    const uniqueLogs = allLogs.filter((log, index, self) =>
        index === self.findIndex(l => l.id === log.id)
    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    window.currentManagementLogs = uniqueLogs;

    // ุชุญุฏูุซ ุงูุนุฑุถ
    const container = document.getElementById('managementLogsContainer');
    if (container) {
        container.innerHTML = renderManagementLogs(uniqueLogs);
    }

    updateLogsCount();
    updateSelectedCount();
}

// ุชุญุฏูุซ ุนุฏุงุฏุงุช ุงูุณุฌูุงุช
function updateLogsCount() {
    const totalElement = document.getElementById('totalLogsCount');
    if (totalElement && window.currentManagementLogs) {
        totalElement.textContent = window.currentManagementLogs.length;
    }
}

// ุนุฑุถ ุชูุงุตูู ุงูุณุฌู
function viewLogDetails(logId) {
    const log = window.currentManagementLogs?.find(l => l.id === logId);
    if (!log) {
        showToast('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณุฌู', 'error');
        return;
    }

    const detailsHtml = `
        <div class="modal-overlay" style="display:flex; z-index: 10001;">
            <div class="modal-box" style="max-width: 800px;">
                <button class="close-modal" onclick="closeModal()">ร</button>

                <div class="modal-header">
                    <h3><i class="fas fa-info-circle"></i> ุชูุงุตูู ุงูุณุฌู</h3>
                </div>

                <div class="log-details-content">
                    <div class="detail-section">
                        <h4>ูุนูููุงุช ุฃุณุงุณูุฉ</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>ููุน ุงูุนูููุฉ:</label>
                                <span>${log.operationType}</span>
                            </div>
                            <div class="detail-item">
                                <label>ุงูุชุงุฑูุฎ:</label>
                                <span>${log.date}</span>
                            </div>
                            <div class="detail-item">
                                <label>ุงูููุช:</label>
                                <span>${log.time}</span>
                            </div>
                            <div class="detail-item">
                                <label>ุงููุณุชุฎุฏู:</label>
                                <span>${log.user || 'ุบูุฑ ูุญุฏุฏ'}</span>
                            </div>
                            <div class="detail-item">
                                <label>ุงูุนูุงุฑ:</label>
                                <span>${log.propertyName}</span>
                            </div>
                            <div class="detail-item">
                                <label>ุงููุญุฏุฉ:</label>
                                <span>${log.unitNumber}</span>
                            </div>
                        </div>
                    </div>

                    ${log.changes && Object.keys(log.changes).length > 0 ? `
                        <div class="detail-section">
                            <h4>ุงูุชุบููุฑุงุช</h4>
                            <div class="changes-list">
                                ${Object.entries(log.changes).map(([field, change]) => `
                                    <div class="change-item">
                                        <strong>${change.fieldName}:</strong>
                                        <div class="change-values">
                                            <span class="old-value">ุงููุฏูู: ${change.old}</span>
                                            <span class="arrow">โ</span>
                                            <span class="new-value">ุงูุฌุฏูุฏ: ${change.new}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="detail-section">
                        <h4>ูุนูููุงุช ุชูููุฉ</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>ูุนุฑู ุงูุณุฌู:</label>
                                <span style="font-family: monospace; font-size: 0.9em;">${log.id}</span>
                            </div>
                            <div class="detail-item">
                                <label>ุงูุทุงุจุน ุงูุฒููู:</label>
                                <span style="font-family: monospace; font-size: 0.9em;">${log.timestamp}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button onclick="deleteIndividualLog('${log.id}'); closeModal();" class="delete-btn">
                        <i class="fas fa-trash"></i> ุญุฐู ูุฐุง ุงูุณุฌู
                    </button>
                    <button onclick="closeModal()" class="cancel-btn">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', detailsHtml);
}

// ===== ููุงูุฉ ูุธุงู ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน =====

// ===== ูุธุงู ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช =====

// ูุชุบูุฑ ูุญูุธ ูุชุงุฆุฌ ุงูุจุญุซ
let currentPropertiesSearchResults = [];
let originalPropertiesList = [];

// ุงูุจุญุซ ุงููุจุงุดุฑ ูู ุงูุนูุงุฑุงุช
function searchProperties(searchTerm) {
    console.log('๐ ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช:', searchTerm);

    const searchInput = document.getElementById('propertiesSearchInput');
    const clearBtn = document.querySelector('.clear-search-btn');
    const searchCount = document.getElementById('propertiesSearchCount');
    const searchResultsText = document.getElementById('searchResultsText');

    // ุฅุธูุงุฑ/ุฅุฎูุงุก ุฒุฑ ุงููุณุญ
    if (searchTerm.length > 0) {
        clearBtn.style.display = 'flex';
    } else {
        clearBtn.style.display = 'none';
    }

    // ุงูุญุตูู ุนูู ุฌููุน ุงูุนูุงุฑุงุช
    let allProperties = getUniqueProperties();

    // ุชุทุจูู ููุชุฑ ุงููุฏููุฉ ุฅุฐุง ูุงู ูุญุฏุฏุงู
    if (selectedCityFilter !== 'all') {
        allProperties = allProperties.filter(propertyName => {
            const property = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
            return property && property['ุงููุฏููุฉ'] === selectedCityFilter;
        });
    }

    // ุญูุธ ุงููุงุฆูุฉ ุงูุฃุตููุฉ ุฅุฐุง ูู ุชูู ูุญููุธุฉ
    if (originalPropertiesList.length === 0) {
        originalPropertiesList = [...allProperties];
    }

    // ุชุทุจูู ุงูุจุญุซ
    if (searchTerm.trim() === '') {
        // ุฅุฐุง ูุงู ุงูุจุญุซ ูุงุฑุบุงูุ ุนุฑุถ ุฌููุน ุงูุนูุงุฑุงุช
        currentPropertiesSearchResults = [...allProperties];
        searchCount.style.display = 'none';
    } else {
        // ุงูุจุญุซ ูู ุงุณู ุงูุนูุงุฑ ูุงููุฏููุฉ
        const searchTermLower = searchTerm.toLowerCase();
        currentPropertiesSearchResults = allProperties.filter(propertyName => {
            const property = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
            if (!property) return false;

            const propertyNameMatch = propertyName.toLowerCase().includes(searchTermLower);
            const cityMatch = (property['ุงููุฏููุฉ'] || '').toLowerCase().includes(searchTermLower);

            return propertyNameMatch || cityMatch;
        });

        // ุฅุธูุงุฑ ุนุฏุฏ ุงููุชุงุฆุฌ
        searchCount.style.display = 'block';
        searchResultsText.textContent = `ุชู ุงูุนุซูุฑ ุนูู ${currentPropertiesSearchResults.length} ุนูุงุฑ ูู ุฃุตู ${allProperties.length}`;
    }

    // ุชุญุฏูุซ ุนุฑุถ ุงูุนูุงุฑุงุช
    updatePropertiesDisplay();

    console.log(`โ ูุชุงุฆุฌ ุงูุจุญุซ: ${currentPropertiesSearchResults.length} ุนูุงุฑ`);
}

// ูุณุญ ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช
function clearPropertiesSearch() {
    console.log('๐งน ูุณุญ ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช');

    const searchInput = document.getElementById('propertiesSearchInput');
    const clearBtn = document.querySelector('.clear-search-btn');
    const searchCount = document.getElementById('propertiesSearchCount');

    // ูุณุญ ุงููุต
    if (searchInput) {
        searchInput.value = '';
    }

    // ุฅุฎูุงุก ุฒุฑ ุงููุณุญ ูุนุฏุงุฏ ุงููุชุงุฆุฌ
    if (clearBtn) {
        clearBtn.style.display = 'none';
    }
    if (searchCount) {
        searchCount.style.display = 'none';
    }

    // ุฅุนุงุฏุฉ ุชุนููู ุงููุชุงุฆุฌ
    currentPropertiesSearchResults = [];

    // ุชุญุฏูุซ ุงูุนุฑุถ
    updatePropertiesDisplay();

    console.log('โ ุชู ูุณุญ ุงูุจุญุซ ูุฅุนุงุฏุฉ ุนุฑุถ ุฌููุน ุงูุนูุงุฑุงุช');
}

// ุชุญุฏูุซ ุนุฑุถ ุงูุนูุงุฑุงุช ูุน ูุฑุงุนุงุฉ ูุชุงุฆุฌ ุงูุจุญุซ
function updatePropertiesDisplay() {
    const propertiesContainer = document.querySelector('.existing-properties');
    if (!propertiesContainer) return;

    // ุชุญุฏูุฏ ุงูุนูุงุฑุงุช ุงููุฑุงุฏ ุนุฑุถูุง
    let propertiesToShow;
    if (currentPropertiesSearchResults.length > 0 || document.getElementById('propertiesSearchInput')?.value) {
        propertiesToShow = currentPropertiesSearchResults;
    } else {
        // ุนุฑุถ ุงูุนูุงุฑุงุช ุญุณุจ ููุชุฑ ุงููุฏููุฉ
        propertiesToShow = getUniqueProperties();
        if (selectedCityFilter !== 'all') {
            propertiesToShow = propertiesToShow.filter(propertyName => {
                const property = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);
                return property && property['ุงููุฏููุฉ'] === selectedCityFilter;
            });
        }
    }

    // ุชุญุฏูุซ ุงููุญุชูู
    if (propertiesToShow.length > 0) {
        propertiesContainer.innerHTML = propertiesToShow.map(property => {
            const propertyData = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === property);
            const cityName = propertyData ? propertyData['ุงููุฏููุฉ'] : 'ุบูุฑ ูุญุฏุฏ';
            return `
                <div class="property-item">
                    <div class="property-info">
                        <div class="property-name">${property}</div>
                        <div class="property-city">ุงููุฏููุฉ: ${cityName}</div>
                    </div>
                    <div class="property-actions">
                        <button onclick="showPropertyStatistics('${property}')" class="stats-btn">
                            <i class="fas fa-chart-bar"></i> ุฅุญุตุงุฆูุงุช
                        </button>
                        <button onclick="deleteProperty('${property}')" class="delete-btn">
                            <i class="fas fa-trash"></i> ุญุฐู
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        const searchTerm = document.getElementById('propertiesSearchInput')?.value || '';
        if (searchTerm) {
            propertiesContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h4>ูุง ุชูุฌุฏ ูุชุงุฆุฌ</h4>
                    <p>ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุงุฑุงุช ุชุทุงุจู "${searchTerm}"</p>
                    <button onclick="clearPropertiesSearch()" class="clear-search-btn-large">
                        <i class="fas fa-times"></i> ูุณุญ ุงูุจุญุซ
                    </button>
                </div>
            `;
        } else {
            propertiesContainer.innerHTML = `
                <div class="no-properties">
                    <i class="fas fa-building"></i>
                    <p>ูุง ุชูุฌุฏ ุนูุงุฑุงุช ูู ูุฐู ุงููุฏููุฉ</p>
                </div>
            `;
        }
    }

    // ุชุญุฏูุซ ูุนูููุงุช ุงูููุชุฑ
    updateFilterInfo(propertiesToShow.length);
}

// ุชุญุฏูุซ ูุนูููุงุช ุงูููุชุฑ
function updateFilterInfo(count) {
    const filterInfo = document.querySelector('.filter-info');
    if (!filterInfo) return;

    const searchTerm = document.getElementById('propertiesSearchInput')?.value || '';

    if (searchTerm) {
        filterInfo.innerHTML = `<span class="filter-badge search">ูุชุงุฆุฌ ุงูุจุญุซ: ${count} ุนูุงุฑ</span>`;
    } else if (selectedCityFilter === 'all') {
        filterInfo.innerHTML = `<span class="filter-badge all">ุฌููุน ุงููุฏู (${count} ุนูุงุฑ)</span>`;
    } else {
        filterInfo.innerHTML = `<span class="filter-badge filtered">ูุฏููุฉ ${selectedCityFilter} (${count} ุนูุงุฑ)</span>`;
    }
}

// ===== ููุงูุฉ ูุธุงู ุงูุจุญุซ ูู ุงูุนูุงุฑุงุช =====

// ===== ูุธุงู ูุฒุงููุฉ ูุญุณู ูุน Supabase =====

// ูุชุบูุฑุงุช ุญุงูุฉ ุงููุฒุงููุฉ
let isSyncing = false;
let lastSyncTime = null;
let syncRetryCount = 0;
const MAX_SYNC_RETRIES = 3;

// ูุธููุฉ ุงููุฒุงููุฉ ุงูุฑุฆูุณูุฉ ูุน Supabase
async function syncToSupabase(showProgress = true) {
    if (isSyncing) {
        console.log('โณ ุนูููุฉ ูุฒุงููุฉ ุฌุงุฑูุฉ ุจุงููุนู...');
        return { success: false, message: 'ุนูููุฉ ูุฒุงููุฉ ุฌุงุฑูุฉ ุจุงููุนู' };
    }

    console.log('๐ ุจุฏุก ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน Supabase...');
    isSyncing = true;

    let progressModal = null;

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชูุฏู
        if (showProgress) {
            progressModal = showSyncProgress();
        }

        // ุงูุชุญูู ูู ุงุชุตุงู Supabase
        if (!supabaseClient) {
            throw new Error('ุนููู Supabase ุบูุฑ ูุชุงุญ');
        }

        // ุชุญุฏูุซ ูุคุดุฑ ุงูุชูุฏู
        updateSyncProgress(progressModal, 'ุฌุงุฑู ุชุญุถูุฑ ุงูุจูุงูุงุช...', 10);

        // ุชุญุถูุฑ ุงูุจูุงูุงุช ูููุฒุงููุฉ
        const dataToSync = prepareDataForSync();

        // ูุฒุงููุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        updateSyncProgress(progressModal, 'ุฌุงุฑู ูุฒุงููุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ...', 30);
        const mainDataResult = await syncMainData(dataToSync.properties);

        // ูุฒุงููุฉ ุณุฌูุงุช ุงูุชุชุจุน
        updateSyncProgress(progressModal, 'ุฌุงุฑู ูุฒุงููุฉ ุณุฌูุงุช ุงูุชุชุจุน...', 60);
        const logsResult = await syncTrackingLogs(dataToSync.trackingLogs);

        // ูุฒุงููุฉ ุงููุฑููุงุช
        updateSyncProgress(progressModal, 'ุฌุงุฑู ูุฒุงููุฉ ุงููุฑููุงุช...', 80);
        const attachmentsResult = await syncAttachments(dataToSync.attachments);

        // ุฅููุงุก ุงููุฒุงููุฉ
        updateSyncProgress(progressModal, 'ุชู ุฅููุงุก ุงููุฒุงููุฉ ุจูุฌุงุญ', 100);

        // ุชุญุฏูุซ ููุช ุขุฎุฑ ูุฒุงููุฉ
        lastSyncTime = new Date();
        syncRetryCount = 0;

        // ุฅุบูุงู ูุคุดุฑ ุงูุชูุฏู ุจุนุฏ ุซุงููุชูู
        if (progressModal) {
            setTimeout(() => {
                progressModal.remove();
            }, 2000);
        }

        console.log('โ ุชู ุฅููุงุก ูุฒุงููุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ');

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        showToast('ุชู ุญูุธ ุงูุจูุงูุงุช ูู ุงูุณุญุงุจุฉ ุจูุฌุงุญ', 'success');

        return {
            success: true,
            message: 'ุชู ุฅููุงุก ุงููุฒุงููุฉ ุจูุฌุงุญ',
            results: {
                mainData: mainDataResult,
                logs: logsResult,
                attachments: attachmentsResult
            }
        };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุฒุงููุฉ Supabase:', error);

        // ุฅุบูุงู ูุคุดุฑ ุงูุชูุฏู
        if (progressModal) {
            progressModal.remove();
        }

        // ุฒูุงุฏุฉ ุนุฏุงุฏ ุงููุญุงููุงุช
        syncRetryCount++;

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ ูุน ุฅููุงููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
        showSyncError(error, syncRetryCount < MAX_SYNC_RETRIES);

        return {
            success: false,
            message: error.message || 'ุญุฏุซ ุฎุทุฃ ูู ุงููุฒุงููุฉ',
            error: error
        };

    } finally {
        isSyncing = false;
    }
}

// ุชุญุถูุฑ ุงูุจูุงูุงุช ูููุฒุงููุฉ
function prepareDataForSync() {
    return {
        properties: properties || [],
        trackingLogs: changeTrackingLogs || [],
        attachments: {
            property: JSON.parse(localStorage.getItem('propertyAttachments') || '{}'),
            card: JSON.parse(localStorage.getItem('cardAttachments') || '{}')
        }
    };
}

// ูุฒุงููุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูุน ุฅูุดุงุก ุงูุฌุฏูู ุชููุงุฆูุงู
async function syncMainData(propertiesData) {
    console.log('๐ ูุฒุงููุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ...');

    if (!propertiesData || propertiesData.length === 0) {
        console.log('โน๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุณุงุณูุฉ ูููุฒุงููุฉ');
        return { success: true, count: 0 };
    }

    try {
        // ูุญุงููุฉ ุฅูุดุงุก ุงูุฌุฏูู ุฅุฐุง ูู ููู ููุฌูุฏุงู
        await createPropertiesTableIfNotExists();

        // ุชุญุถูุฑ ุงูุจูุงูุงุช ููุฅุฏุฑุงุฌ
        const dataToInsert = propertiesData.map((property, index) => {
            // ุฅูุดุงุก ูุงุฆู ูุณุทุญ ูู ุงูุจูุงูุงุช
            const flattenedProperty = {
                id: property.id || generateUUID(),
                property_name: property['ุงุณู ุงูุนูุงุฑ'] || '',
                city: property['ุงููุฏููุฉ'] || '',
                unit_number: property['ุฑูู  ุงููุญุฏุฉ '] || '',
                tenant_name: property['ุงุณู ุงููุณุชุฃุฌุฑ'] || '',
                contract_number: property['ุฑูู ุงูุนูุฏ'] || '',
                rent_value: property['ูููุฉ  ุงูุงูุฌุงุฑ '] || 0,
                start_date: property['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ'] || null,
                end_date: property['ุชุงุฑูุฎ ุงูููุงูุฉ'] || null,
                total_amount: property['ุงูุงุฌูุงูู'] || 0,
                area: property['ุงููุณุงุญุฉ'] || null,
                deed_number: property['ุฑูู ุงูุตู'] || null,
                deed_area: property['ูุณุงุญุฉุงูุตู'] || null,
                registry_number: property['ุงูุณุฌู ุงูุนููู '] || null,
                real_estate_registry: property['ุงูุณุฌู ุงูุนููู '] || null, // ุฅุถุงูุฉ ููุชูุงูู ูุน ุงูุนููุฏ ุงูููุฌูุฏ
                owner_name: property['ุงููุงูู'] || null,
                owner: property['ุงููุงูู'] || null, // ุฅุถุงูุฉ ููุชูุงูู ูุน ุงูุนููุฏ ุงูููุฌูุฏ
                property_location: property['ูููุน ุงูุนูุงุฑ'] || null,
                contract_type: property['ููุน ุงูุนูุฏ'] || 'ุณููู',
                remaining_installments: property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] || null,
                last_update: property['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || new Date().toLocaleDateString('ar-SA'),
                raw_data: JSON.stringify(property), // ุญูุธ ุงูุจูุงูุงุช ุงููุงููุฉ ูู JSON
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            return flattenedProperty;
        });

        // ุญุฐู ุงูุจูุงูุงุช ุงููุฏููุฉ (ุงุฎุชูุงุฑู)
        try {
            const { error: deleteError } = await supabaseClient
                .from('properties')
                .delete()
                .neq('id', '');

            if (deleteError && !deleteError.message.includes('does not exist')) {
                console.warn('โ๏ธ ุชุญุฐูุฑ ูู ุญุฐู ุงูุจูุงูุงุช ุงููุฏููุฉ:', deleteError);
            }
        } catch (deleteErr) {
            console.warn('โ๏ธ ูู ูุชู ุญุฐู ุงูุจูุงูุงุช ุงููุฏููุฉ:', deleteErr.message);
        }

        // ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
        const { data, error } = await supabaseClient
            .from('properties')
            .insert(dataToInsert);

        if (error) {
            throw error;
        }

        console.log(`โ ุชู ูุฒุงููุฉ ${propertiesData.length} ุนูุงุฑ`);
        return { success: true, count: propertiesData.length };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุฒุงููุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ:', error);

        // ุฅุฐุง ูุดู ุงูุฅุฏุฑุงุฌุ ุฌุฑุจ ุทุฑููุฉ ุจุฏููุฉ
        if (error.message.includes('does not exist') || error.message.includes('column')) {
            console.log('๐ ูุญุงููุฉ ุฅูุดุงุก ุงูุฌุฏูู ูุฅุนุงุฏุฉ ุงููุญุงููุฉ...');
            try {
                await createPropertiesTableAlternative();
                return await syncMainDataAlternative(propertiesData);
            } catch (altError) {
                console.error('โ ูุดู ูู ุงูุทุฑููุฉ ุงูุจุฏููุฉ:', altError);
                throw altError;
            }
        }

        throw error;
    }
}

// ูุฒุงููุฉ ุณุฌูุงุช ุงูุชุชุจุน
async function syncTrackingLogs(logsData) {
    console.log('๐ ูุฒุงููุฉ ุณุฌูุงุช ุงูุชุชุจุน...');

    if (!logsData || logsData.length === 0) {
        console.log('โน๏ธ ูุง ุชูุฌุฏ ุณุฌูุงุช ุชุชุจุน ูููุฒุงููุฉ');
        return { success: true, count: 0 };
    }

    try {
        // ุงูุญุตูู ุนูู ุงูุณุฌูุงุช ุงูููุฌูุฏุฉ
        const { data: existingLogs } = await supabaseClient
            .from('change_logs')
            .select('id');

        const existingIds = new Set(existingLogs?.map(log => log.id) || []);

        // ููุชุฑุฉ ุงูุณุฌูุงุช ุงูุฌุฏูุฏุฉ ููุท
        const newLogs = logsData.filter(log => !existingIds.has(log.id));

        if (newLogs.length > 0) {
            const { error } = await supabaseClient
                .from('change_logs')
                .insert(newLogs);

            if (error) {
                throw error;
            }

            console.log(`โ ุชู ูุฒุงููุฉ ${newLogs.length} ุณุฌู ุชุชุจุน ุฌุฏูุฏ`);
        } else {
            console.log('โน๏ธ ุฌููุน ุณุฌูุงุช ุงูุชุชุจุน ูุญุฏุซุฉ');
        }

        return { success: true, count: newLogs.length };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุฒุงููุฉ ุณุฌูุงุช ุงูุชุชุจุน:', error);
        throw error;
    }
}

// ูุฒุงููุฉ ุงููุฑููุงุช
async function syncAttachments(attachmentsData) {
    console.log('๐ ูุฒุงููุฉ ุงููุฑููุงุช...');

    try {
        let syncCount = 0;

        // ูุฒุงููุฉ ูุฑููุงุช ุงูุนูุงุฑุงุช
        if (attachmentsData.property && Object.keys(attachmentsData.property).length > 0) {
            const { error: propError } = await supabaseClient
                .from('attachments')
                .upsert({
                    id: 'property_attachments',
                    type: 'property',
                    data: attachmentsData.property,
                    updated_at: new Date().toISOString()
                });

            if (propError) {
                console.warn('โ๏ธ ุฎุทุฃ ูู ูุฒุงููุฉ ูุฑููุงุช ุงูุนูุงุฑุงุช:', propError);
            } else {
                syncCount++;
            }
        }

        // ูุฒุงููุฉ ูุฑููุงุช ุงูุจุทุงูุงุช
        if (attachmentsData.card && Object.keys(attachmentsData.card).length > 0) {
            const { error: cardError } = await supabaseClient
                .from('attachments')
                .upsert({
                    id: 'card_attachments',
                    type: 'card',
                    data: attachmentsData.card,
                    updated_at: new Date().toISOString()
                });

            if (cardError) {
                console.warn('โ๏ธ ุฎุทุฃ ูู ูุฒุงููุฉ ูุฑููุงุช ุงูุจุทุงูุงุช:', cardError);
            } else {
                syncCount++;
            }
        }

        console.log(`โ ุชู ูุฒุงููุฉ ${syncCount} ููุน ูู ุงููุฑููุงุช`);
        return { success: true, count: syncCount };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุฒุงููุฉ ุงููุฑููุงุช:', error);
        throw error;
    }
}

// ุฅุธูุงุฑ ูุคุดุฑ ุชูุฏู ุงููุฒุงููุฉ
function showSyncProgress() {
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.style.display = 'flex';
    progressModal.style.zIndex = '10001';

    progressModal.innerHTML = `
        <div class="modal-box sync-progress-modal">
            <div class="sync-progress-header">
                <h3><i class="fas fa-cloud-upload-alt"></i> ูุฒุงููุฉ ุงูุจูุงูุงุช</h3>
            </div>

            <div class="sync-progress-content">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="syncProgressFill"></div>
                    </div>
                    <div class="progress-percentage" id="syncProgressPercentage">0%</div>
                </div>

                <div class="progress-status" id="syncProgressStatus">
                    ุฌุงุฑู ุชุญุถูุฑ ุงูุจูุงูุงุช...
                </div>

                <div class="sync-details">
                    <div class="sync-step">
                        <i class="fas fa-database"></i>
                        <span>ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</span>
                        <i class="fas fa-clock sync-step-status" id="mainDataStatus"></i>
                    </div>
                    <div class="sync-step">
                        <i class="fas fa-history"></i>
                        <span>ุณุฌูุงุช ุงูุชุชุจุน</span>
                        <i class="fas fa-clock sync-step-status" id="logsStatus"></i>
                    </div>
                    <div class="sync-step">
                        <i class="fas fa-paperclip"></i>
                        <span>ุงููุฑููุงุช</span>
                        <i class="fas fa-clock sync-step-status" id="attachmentsStatus"></i>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(progressModal);
    return progressModal;
}

// ุชุญุฏูุซ ูุคุดุฑ ุชูุฏู ุงููุฒุงููุฉ
function updateSyncProgress(progressModal, status, percentage) {
    if (!progressModal) return;

    const progressFill = progressModal.querySelector('#syncProgressFill');
    const progressPercentage = progressModal.querySelector('#syncProgressPercentage');
    const progressStatus = progressModal.querySelector('#syncProgressStatus');

    if (progressFill) {
        progressFill.style.width = `${percentage}%`;
    }

    if (progressPercentage) {
        progressPercentage.textContent = `${percentage}%`;
    }

    if (progressStatus) {
        progressStatus.textContent = status;
    }

    // ุชุญุฏูุซ ุญุงูุฉ ุงูุฎุทูุงุช
    if (percentage >= 30) {
        const mainDataStatus = progressModal.querySelector('#mainDataStatus');
        if (mainDataStatus) {
            mainDataStatus.className = 'fas fa-check sync-step-status completed';
        }
    }

    if (percentage >= 60) {
        const logsStatus = progressModal.querySelector('#logsStatus');
        if (logsStatus) {
            logsStatus.className = 'fas fa-check sync-step-status completed';
        }
    }

    if (percentage >= 80) {
        const attachmentsStatus = progressModal.querySelector('#attachmentsStatus');
        if (attachmentsStatus) {
            attachmentsStatus.className = 'fas fa-check sync-step-status completed';
        }
    }
}

// ุฅุธูุงุฑ ุฎุทุฃ ุงููุฒุงููุฉ ูุน ุฅููุงููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
function showSyncError(error, canRetry = true) {
    const errorModal = document.createElement('div');
    errorModal.className = 'modal-overlay';
    errorModal.style.display = 'flex';
    errorModal.style.zIndex = '10002';

    errorModal.innerHTML = `
        <div class="modal-box sync-error-modal">
            <div class="sync-error-header">
                <h3><i class="fas fa-exclamation-triangle"></i> ุฎุทุฃ ูู ุงููุฒุงููุฉ</h3>
            </div>

            <div class="sync-error-content">
                <div class="error-message">
                    <p><strong>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน ุงูุณุญุงุจุฉ:</strong></p>
                    <div class="error-details">
                        ${error.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}
                    </div>
                </div>

                <div class="error-info">
                    <p><i class="fas fa-info-circle"></i> ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู ูุณุชุชู ุงููุฒุงููุฉ ุนูุฏ ุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู</p>
                </div>

                <div class="sync-error-actions">
                    ${canRetry ? `
                        <button onclick="retrySyncToSupabase()" class="retry-btn">
                            <i class="fas fa-redo"></i> ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                        </button>
                    ` : ''}
                    <button onclick="closeSyncError()" class="close-error-btn">
                        <i class="fas fa-times"></i> ุฅุบูุงู
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(errorModal);

    // ุญูุธ ูุฑุฌุน ูููุงูุฐุฉ
    window.currentSyncErrorModal = errorModal;
}

// ุฅุนุงุฏุฉ ูุญุงููุฉ ุงููุฒุงููุฉ
async function retrySyncToSupabase() {
    // ุฅุบูุงู ูุงูุฐุฉ ุงูุฎุทุฃ
    closeSyncError();

    // ุฅุนุงุฏุฉ ูุญุงููุฉ ุงููุฒุงููุฉ
    await syncToSupabase(true);
}

// ุฅุบูุงู ูุงูุฐุฉ ุฎุทุฃ ุงููุฒุงููุฉ
function closeSyncError() {
    if (window.currentSyncErrorModal) {
        window.currentSyncErrorModal.remove();
        window.currentSyncErrorModal = null;
    }
}

// ูุฒุงููุฉ ุชููุงุฆูุฉ ุนูุฏ ุชุนุฏูู ุงูุจูุงูุงุช
function autoSyncAfterEdit(operation = 'ุชุนุฏูู ุงูุจูุงูุงุช') {
    console.log(`๐ ุจุฏุก ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ุจุนุฏ ${operation}...`);

    // ุชุฃุฎูุฑ ูุตูุฑ ููุณูุงุญ ุจุญูุธ ุงูุจูุงูุงุช ูุญููุงู ุฃููุงู
    setTimeout(async () => {
        try {
            const result = await syncToSupabase(false); // ุจุฏูู ุฅุธูุงุฑ ูุคุดุฑ ุงูุชูุฏู

            if (result.success) {
                console.log('โ ุชู ุฅููุงุก ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ุจูุฌุงุญ');
                showToast('ุชู ุญูุธ ุงูุชุนุฏููุงุช ูู ุงูุณุญุงุจุฉ', 'success');
            } else {
                console.warn('โ๏ธ ูุดูุช ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ:', result.message);
                showToast('ุชู ุญูุธ ุงูุชุนุฏููุงุช ูุญููุงูุ ุณุชุชู ุงููุฒุงููุฉ ูุงุญูุงู', 'warning');
            }
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ:', error);
            showToast('ุชู ุญูุธ ุงูุชุนุฏููุงุช ูุญููุงู ููุท', 'warning');
        }
    }, 1000);
}

// ูุญุต ุญุงูุฉ ุงูุงุชุตุงู ูุน Supabase
async function checkSupabaseConnection() {
    try {
        if (!supabaseClient) {
            return { connected: false, error: 'ุนููู Supabase ุบูุฑ ูุชุงุญ' };
        }

        // ุงุฎุชุจุงุฑ ุจุณูุท ููุงุชุตุงู
        const { data, error } = await supabaseClient
            .from('properties')
            .select('count')
            .limit(1);

        if (error) {
            return { connected: false, error: error.message };
        }

        return { connected: true };

    } catch (error) {
        return { connected: false, error: error.message };
    }
}

// ===== ููุงูุฉ ูุธุงู ูุฒุงููุฉ ูุญุณู ูุน Supabase =====

// ===== ูุธููุฉ ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช =====

// ุงุฎุชุจุงุฑ ุดุงูู ููุธููุฉ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช
async function testPropertyEditFunction() {
    console.log('๐งช ุจุฏุก ุงุฎุชุจุงุฑ ูุธููุฉ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช...');

    try {
        // ุงูุจุญุซ ุนู ุนูุงุฑ ููุงุฎุชุจุงุฑ
        const testProperty = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] && p['ุงุณู ุงูุนูุงุฑ'].trim() !== '');

        if (!testProperty) {
            console.log('โ ูุง ุชูุฌุฏ ุนูุงุฑุงุช ููุงุฎุชุจุงุฑ');
            showToast('ูุง ุชูุฌุฏ ุนูุงุฑุงุช ููุงุฎุชุจุงุฑ', 'error');
            return;
        }

        const originalPropertyName = testProperty['ุงุณู ุงูุนูุงุฑ'];
        console.log(`๐ข ุงุฎุชุจุงุฑ ุงูุนูุงุฑ: ${originalPropertyName}`);

        // ุฅูุดุงุก ุจูุงูุงุช ุงุฎุชุจุงุฑ
        const testData = {
            name: originalPropertyName + ' - ูุญุฏุซ',
            city: testProperty['ุงููุฏููุฉ'] || 'ุงูุฑูุงุถ',
            deed: 'TEST_DEED_' + Date.now(),
            area: '500',
            registry: 'TEST_REG_' + Date.now(),
            owner: 'ูุงูู ุงุฎุชุจุงุฑ',
            location: 'https://maps.google.com/test'
        };

        console.log('๐ ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ:', testData);

        // ูุญุงูุงุฉ ุชุญุฑูุฑ ุงูุนูุงุฑ
        const originalData = { ...testProperty };

        // ุชุญุฏูุซ ุงูุจูุงูุงุช
        const relatedProperties = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName);
        relatedProperties.forEach(property => {
            property['ุงุณู ุงูุนูุงุฑ'] = testData.name;
            property['ุงููุฏููุฉ'] = testData.city;
            property['ุฑูู ุงูุตู'] = testData.deed;
            property['ูุณุงุญุฉุงูุตู'] = testData.area;
            property['ุงูุณุฌู ุงูุนููู '] = testData.registry;
            property['ุงููุงูู'] = testData.owner;
            property['ูููุน ุงูุนูุงุฑ'] = testData.location;
            property['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
        });

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        saveDataLocally();

        // ุชุณุฌูู ุงูุชุบููุฑ ูู ุณุฌู ุงูุชุชุจุน
        const changes = {
            'ุงุณู ุงูุนูุงุฑ': {
                fieldName: 'ุงุณู ุงูุนูุงุฑ',
                old: originalPropertyName,
                new: testData.name
            },
            'ุฑูู ุงูุตู': {
                fieldName: 'ุฑูู ุงูุตู',
                old: originalData['ุฑูู ุงูุตู'] || '',
                new: testData.deed
            },
            'ูุณุงุญุฉุงูุตู': {
                fieldName: 'ูุณุงุญุฉ ุงูุตู',
                old: originalData['ูุณุงุญุฉุงูุตู'] || '',
                new: testData.area
            }
        };

        const changeLog = createChangeLog(
            OPERATION_TYPES.EDIT_DATA,
            {
                'ุฑูู  ุงููุญุฏุฉ ': testProperty['ุฑูู  ุงููุญุฏุฉ '] || 'ุงุฎุชุจุงุฑ',
                'ุงุณู ุงูุนูุงุฑ': testData.name,
                'ุงุณู ุงููุณุชุฃุฌุฑ': testProperty['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''
            },
            changes,
            {
                affectedUnits: relatedProperties.length,
                originalPropertyName: originalPropertyName,
                testMode: true
            }
        );

        changeTrackingLogs.push(changeLog);

        // ุญูุธ ุณุฌู ุงูุชุชุจุน ูุญููุงู
        try {
            localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
            console.log('โ ุชู ุญูุธ ุณุฌู ุงูุชุชุจุน ูุญููุงู');
        } catch (error) {
            console.warn('โ๏ธ ูู ูุชู ุญูุธ ุณุฌู ุงูุชุชุจุน ูุญููุงู:', error);
        }

        // ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ ูุน Supabase
        console.log('๐ ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ ูุน Supabase...');
        const syncResult = await syncToSupabase(true);

        if (syncResult.success) {
            console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ ูุน Supabase');
            showToast('ูุฌุญ ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑ ูุงููุฒุงููุฉ', 'success');
        } else {
            console.warn('โ๏ธ ูุดู ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ:', syncResult.message);
            showToast('ูุฌุญ ุงูุชุญุฑูุฑ ูุญููุงูุ ูุดูุช ุงููุฒุงููุฉ', 'warning');
        }

        // ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ุงูุฃุตููุฉ
        setTimeout(() => {
            console.log('๐ ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ุงูุฃุตููุฉ...');
            relatedProperties.forEach(property => {
                property['ุงุณู ุงูุนูุงุฑ'] = originalPropertyName;
                property['ุงููุฏููุฉ'] = originalData['ุงููุฏููุฉ'];
                property['ุฑูู ุงูุตู'] = originalData['ุฑูู ุงูุตู'];
                property['ูุณุงุญุฉุงูุตู'] = originalData['ูุณุงุญุฉุงูุตู'];
                property['ุงูุณุฌู ุงูุนููู '] = originalData['ุงูุณุฌู ุงูุนููู '];
                property['ุงููุงูู'] = originalData['ุงููุงูู'];
                property['ูููุน ุงูุนูุงุฑ'] = originalData['ูููุน ุงูุนูุงุฑ'];
            });

            saveDataLocally();
            renderData();
            console.log('โ ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ุงูุฃุตููุฉ');
        }, 5000);

        // ุชุญุฏูุซ ุงูุนุฑุถ
        renderData();
        updateTotalStats();

        console.log('๐ ุงูุชูู ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช ุจูุฌุงุญ');

        return {
            success: true,
            message: 'ูุฌุญ ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช',
            syncResult: syncResult
        };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช:', error);
        showToast('ูุดู ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช: ' + error.message, 'error');

        return {
            success: false,
            message: error.message,
            error: error
        };
    }
}

// ุฅุถุงูุฉ ุฒุฑ ุงุฎุชุจุงุฑ ูู ูุญุฏุฉ ุงูุชุญูู
window.testPropertyEdit = testPropertyEditFunction;

// ===== ููุงูุฉ ูุธููุฉ ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช =====

// ===== ูุธููุฉ ุชุดุฎูุต ูุดุงูู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช =====

// ุชุดุฎูุต ุดุงูู ููุดุงูู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช
function diagnosePropertyEditIssues() {
    console.log('๐ ุจุฏุก ุชุดุฎูุต ูุดุงูู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช...');

    const diagnostics = {
        timestamp: new Date().toISOString(),
        functions: {},
        data: {},
        supabase: {},
        localStorage: {}
    };

    // ูุญุต ุงููุธุงุฆู ุงููุทููุจุฉ
    diagnostics.functions.savePropertyChanges = typeof savePropertyChanges === 'function';
    diagnostics.functions.handleSavePropertyChanges = typeof handleSavePropertyChanges === 'function';
    diagnostics.functions.editPropertyData = typeof editPropertyData === 'function';
    diagnostics.functions.showToast = typeof showToast === 'function';
    diagnostics.functions.syncToSupabase = typeof syncToSupabase === 'function';
    diagnostics.functions.createChangeLog = typeof createChangeLog === 'function';
    diagnostics.functions.saveDataLocally = typeof saveDataLocally === 'function';

    // ูุญุต ุงูุจูุงูุงุช
    diagnostics.data.propertiesArray = Array.isArray(properties);
    diagnostics.data.propertiesCount = properties ? properties.length : 0;
    diagnostics.data.changeTrackingLogs = Array.isArray(changeTrackingLogs);
    diagnostics.data.operationTypes = typeof OPERATION_TYPES === 'object';

    // ูุญุต Supabase
    diagnostics.supabase.client = typeof supabaseClient !== 'undefined' && supabaseClient !== null;
    diagnostics.supabase.url = typeof supabaseUrl !== 'undefined';
    diagnostics.supabase.key = typeof supabaseKey !== 'undefined';

    // ูุญุต localStorage
    try {
        diagnostics.localStorage.available = typeof localStorage !== 'undefined';
        diagnostics.localStorage.propertiesData = localStorage.getItem('propertiesData') !== null;
        diagnostics.localStorage.changeTrackingLogs = localStorage.getItem('changeTrackingLogs') !== null;
    } catch (error) {
        diagnostics.localStorage.error = error.message;
    }

    // ุทุจุงุนุฉ ุงููุชุงุฆุฌ
    console.log('๐ ูุชุงุฆุฌ ุงูุชุดุฎูุต:', diagnostics);

    // ูุญุต ุงูุนูุงุฑุงุช ุงูููุฌูุฏุฉ
    if (properties && properties.length > 0) {
        const sampleProperty = properties[0];
        console.log('๐ ุนููุฉ ูู ุงูุจูุงูุงุช:', {
            propertyName: sampleProperty['ุงุณู ุงูุนูุงุฑ'],
            city: sampleProperty['ุงููุฏููุฉ'],
            unitNumber: sampleProperty['ุฑูู  ุงููุญุฏุฉ '],
            keys: Object.keys(sampleProperty).slice(0, 10)
        });
    }

    // ุงุฎุชุจุงุฑ ูุธููุฉ showToast
    if (diagnostics.functions.showToast) {
        showToast('ุงุฎุชุจุงุฑ ุงูุชุดุฎูุต - ุชุนูู ุงูุฑุณุงุฆู ุจุดูู ุตุญูุญ', 'info');
    }

    // ุชุญุฏูุฏ ุงููุดุงูู ุงููุญุชููุฉ
    const issues = [];

    if (!diagnostics.functions.savePropertyChanges) {
        issues.push('ูุธููุฉ savePropertyChanges ุบูุฑ ููุฌูุฏุฉ');
    }

    if (!diagnostics.functions.showToast) {
        issues.push('ูุธููุฉ showToast ุบูุฑ ููุฌูุฏุฉ');
    }

    if (!diagnostics.data.propertiesArray) {
        issues.push('ูุตูููุฉ properties ุบูุฑ ุตุญูุญุฉ');
    }

    if (!diagnostics.supabase.client) {
        issues.push('ุนููู Supabase ุบูุฑ ูุชุงุญ');
    }

    if (!diagnostics.localStorage.available) {
        issues.push('localStorage ุบูุฑ ูุชุงุญ');
    }

    if (issues.length > 0) {
        console.error('โ ูุดุงูู ุชู ุงูุชุดุงููุง:', issues);
        console.error(`ุชู ุงูุชุดุงู ${issues.length} ูุดููุฉ ูู ุงููุธุงู`);
    } else {
        console.log('โ ุฌููุน ุงูููููุงุช ุชุนูู ุจุดูู ุตุญูุญ');
        console.log('ุฌููุน ููููุงุช ุงููุธุงู ุชุนูู ุจุดูู ุตุญูุญ');
    }

    return diagnostics;
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.diagnosePropertyEdit = diagnosePropertyEditIssues;

// ุชุดุบูู ุงูุชุดุฎูุต ุชููุงุฆูุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        console.log('๐ ุชุดุบูู ุงูุชุดุฎูุต ุงูุชููุงุฆู...');
        diagnosePropertyEditIssues();
    }, 2000);
});

// ===== ููุงูุฉ ูุธููุฉ ุชุดุฎูุต ูุดุงูู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช =====

// ===== ุงุฎุชุจุงุฑ ูุจุณุท ูุชุญุฑูุฑ ุงูุนูุงุฑุงุช =====

// ุงุฎุชุจุงุฑ ูุจุณุท ููุธููุฉ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช
function simplePropertyEditTest() {
    console.log('๐งช ุจุฏุก ุงูุงุฎุชุจุงุฑ ุงููุจุณุท ูุชุญุฑูุฑ ุงูุนูุงุฑุงุช...');

    try {
        // ุงูุจุญุซ ุนู ุนูุงุฑ ููุงุฎุชุจุงุฑ
        if (!properties || properties.length === 0) {
            console.error('โ ูุง ุชูุฌุฏ ุนูุงุฑุงุช ููุงุฎุชุจุงุฑ');
            showToast('ูุง ุชูุฌุฏ ุนูุงุฑุงุช ููุงุฎุชุจุงุฑ', 'error');
            return false;
        }

        const testProperty = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] && p['ุงุณู ุงูุนูุงุฑ'].trim() !== '');
        if (!testProperty) {
            console.error('โ ูุง ุชูุฌุฏ ุนูุงุฑุงุช ุตุงูุญุฉ ููุงุฎุชุจุงุฑ');
            showToast('ูุง ุชูุฌุฏ ุนูุงุฑุงุช ุตุงูุญุฉ ููุงุฎุชุจุงุฑ', 'error');
            return false;
        }

        const originalPropertyName = testProperty['ุงุณู ุงูุนูุงุฑ'];
        console.log(`๐ข ุงุฎุชุจุงุฑ ุงูุนูุงุฑ: ${originalPropertyName}`);

        // ูุญุงูุงุฉ ุชุญุฏูุซ ุงูุจูุงูุงุช
        const originalData = { ...testProperty };
        const testUpdates = {
            'ุฑูู ุงูุตู': 'TEST_DEED_' + Date.now(),
            'ูุณุงุญุฉุงูุตู': '500',
            'ุงููุงูู': 'ูุงูู ุงุฎุชุจุงุฑ - ' + new Date().toLocaleString('ar-SA')
        };

        console.log('๐ ุงูุชุญุฏูุซุงุช ุงููุทููุจุฉ:', testUpdates);

        // ุชุทุจูู ุงูุชุญุฏูุซุงุช
        const relatedProperties = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName);
        console.log(`๐ ุชุญุฏูุซ ${relatedProperties.length} ูุญุฏุฉ...`);

        relatedProperties.forEach(property => {
            Object.keys(testUpdates).forEach(key => {
                property[key] = testUpdates[key];
            });
            property['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
        });

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        console.log('๐พ ุญูุธ ุงูุจูุงูุงุช ูุญููุงู...');
        saveDataLocally();

        // ุชุณุฌูู ุงูุชุบููุฑ ูู ุณุฌู ุงูุชุชุจุน
        console.log('๐ ุชุณุฌูู ุงูุชุบููุฑ ูู ุณุฌู ุงูุชุชุจุน...');
        const changes = {};
        Object.keys(testUpdates).forEach(key => {
            changes[key] = {
                fieldName: key,
                old: originalData[key] || '',
                new: testUpdates[key]
            };
        });

        const changeLog = createChangeLog(
            OPERATION_TYPES.EDIT_DATA,
            {
                'ุฑูู  ุงููุญุฏุฉ ': testProperty['ุฑูู  ุงููุญุฏุฉ '] || 'ุงุฎุชุจุงุฑ',
                'ุงุณู ุงูุนูุงุฑ': originalPropertyName,
                'ุงุณู ุงููุณุชุฃุฌุฑ': testProperty['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''
            },
            changes,
            {
                affectedUnits: relatedProperties.length,
                testMode: true
            }
        );

        changeTrackingLogs.push(changeLog);

        // ุญูุธ ุณุฌู ุงูุชุชุจุน ูุญููุงู
        try {
            localStorage.setItem('changeTrackingLogs', JSON.stringify(changeTrackingLogs.slice(0, 1000)));
            console.log('โ ุชู ุญูุธ ุณุฌู ุงูุชุชุจุน ูุญููุงู');
        } catch (error) {
            console.warn('โ๏ธ ูู ูุชู ุญูุธ ุณุฌู ุงูุชุชุจุน ูุญููุงู:', error);
        }

        // ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ ูุน Supabase
        console.log('๐ ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ ูุน Supabase...');
        syncToSupabase(false)
            .then((result) => {
                if (result.success) {
                    console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ ูุน Supabase');
                    showToast('ูุฌุญ ุงูุงุฎุชุจุงุฑ ุงููุจุณุท ูุชุญุฑูุฑ ุงูุนูุงุฑ', 'success');
                } else {
                    console.warn('โ๏ธ ูุดู ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ:', result.message);
                    showToast('ูุฌุญ ุงูุชุญุฑูุฑ ูุญููุงูุ ูุดูุช ุงููุฒุงููุฉ', 'warning');
                }
            })
            .catch((error) => {
                console.error('โ ุฎุทุฃ ูู ุงููุฒุงููุฉ:', error);
                showToast('ูุฌุญ ุงูุชุญุฑูุฑ ูุญููุงูุ ุฎุทุฃ ูู ุงููุฒุงููุฉ', 'warning');
            });

        // ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ุงูุฃุตููุฉ ุจุนุฏ 5 ุซูุงู
        setTimeout(() => {
            console.log('๐ ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ุงูุฃุตููุฉ...');
            relatedProperties.forEach(property => {
                Object.keys(testUpdates).forEach(key => {
                    property[key] = originalData[key];
                });
            });
            saveDataLocally();
            renderData();
            console.log('โ ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ุงูุฃุตููุฉ');
        }, 5000);

        // ุชุญุฏูุซ ุงูุนุฑุถ
        renderData();
        updateTotalStats();

        console.log('๐ ุงูุชูู ุงูุงุฎุชุจุงุฑ ุงููุจุณุท ุจูุฌุงุญ');
        return true;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ ุงููุจุณุท:', error);
        showToast('ูุดู ุงูุงุฎุชุจุงุฑ ุงููุจุณุท: ' + error.message, 'error');
        return false;
    }
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.simplePropertyEditTest = simplePropertyEditTest;

// ===== ููุงูุฉ ุงูุงุฎุชุจุงุฑ ุงููุจุณุท ูุชุญุฑูุฑ ุงูุนูุงุฑุงุช =====

// ===== ูุธุงุฆู ูุณุงุนุฏุฉ ูุญูุธ ุงูุนูุงุฑุงุช =====

// ุญูุธ ุงูุนูุงุฑุงุช ูุจุงุดุฑุฉ ูู Supabase (ุฅุตุฏุงุฑ ูุญุณู ูููุตูุญ)
async function savePropertiesDirectlyToSupabase(propertiesToSave) {
    console.log(`๐พ ุญูุธ ูุจุงุดุฑ ูู ${propertiesToSave.length} ุนูุงุฑ ูู Supabase...`);

    if (!supabaseClient) {
        throw new Error('ุนููู Supabase ุบูุฑ ูุชุงุญ');
    }

    if (!propertiesToSave || propertiesToSave.length === 0) {
        console.warn('โ๏ธ ูุง ุชูุฌุฏ ุนูุงุฑุงุช ููุญูุธ');
        return { success: true, count: 0, message: 'ูุง ุชูุฌุฏ ุจูุงูุงุช ููุญูุธ' };
    }

    try {
        console.log('๐ง ุงูุชุญูู ูู ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช...');

        // ุชูุธูู ุงูุจูุงูุงุช ูุจู ุงููุนุงูุฌุฉ
        const cleanedProperties = sanitizeDataForSave(propertiesToSave);
        console.log(`๐งน ุชู ุชูุธูู ${cleanedProperties.length} ุนูุงุฑ`);

        // ุชุญุถูุฑ ุงูุจูุงูุงุช ููุญูุธ ูุน ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก
        const dataToSave = [];
        const errors = [];

        for (let i = 0; i < cleanedProperties.length; i++) {
            const property = cleanedProperties[i];

            try {
                // ุชุญููู ุงูุชูุงุฑูุฎ ุฅูู ุชูุณูู ุตุญูุญ ูู Supabase (YYYY-MM-DD)
                const parseDate = (dateStr) => {
                    if (!dateStr || dateStr === '') return null;
                    try {
                        // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุจุงูุชูุณูู ุงูุนุฑุจูุ ุญููู
                        if (typeof dateStr === 'string' && dateStr.includes('/')) {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                // ุชูุณูู DD/MM/YYYY
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]);
                                const year = parseInt(parts[2]);

                                // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
                                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
                                    // ุงูุชุญูู ุงูุฅุถุงูู ุจุงุณุชุฎุฏุงู Date object ูุชุฌูุจ ุชูุงุฑูุฎ ูุซู 31 ูุจุฑุงูุฑ
                                    const testDate = new Date(year, month - 1, day, 12, 0, 0);
                                    if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                                        // ุฅุฑุฌุงุน ุงูุชุงุฑูุฎ ุจุตูุบุฉ YYYY-MM-DD ูู Supabase
                                        return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                                    }
                                }
                            }
                        }

                        // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุจุชูุณูู YYYY-MM-DDุ ุชุญูู ูู ุตุญุชู ูุฃุฑุฌุนู
                        if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                            const parts = dateStr.split('-');
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]);
                            const day = parseInt(parts[2]);

                            if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                                const testDate = new Date(year, month - 1, day, 12, 0, 0);
                                if (testDate.getFullYear() === year && testDate.getMonth() === (month - 1) && testDate.getDate() === day) {
                                    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                                }
                            }
                        }

                        return null;
                    } catch (error) {
                        console.warn('ุฎุทุฃ ูู ุชุญููู ุงูุชุงุฑูุฎ:', dateStr, error);
                        return null;
                    }
                };

                // ุฅูุดุงุก ูุนุฑู ูุฑูุฏ ููุนูุงุฑ (ูุชูุงูู ูุน UUID)
                const uniqueId = property.id || generateUUID();

                const propertyData = {
                    id: uniqueId,
                    property_name: String(property['ุงุณู ุงูุนูุงุฑ'] || ''),
                    city: String(property['ุงููุฏููุฉ'] || ''),
                    unit_number: String(property['ุฑูู  ุงููุญุฏุฉ '] || ''),
                    tenant_name: String(property['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''),
                    contract_number: String(property['ุฑูู ุงูุนูุฏ'] || ''),
                    rent_value: Number(property['ูููุฉ  ุงูุงูุฌุงุฑ '] || 0),
                    start_date: parseDate(property['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']),
                    end_date: String(property['ุชุงุฑูุฎ ุงูููุงูุฉ'] || ''),
                    total_amount: Number(property['ุงูุงุฌูุงูู'] || 0),
                    area: Number(property['ุงููุณุงุญุฉ'] || 0),
                    deed_number: String(property['ุฑูู ุงูุตู'] || ''),
                    deed_area: String(property['ูุณุงุญุฉุงูุตู'] || ''),
                    real_estate_registry: String(property['ุงูุณุฌู ุงูุนููู '] || ''),
                    owner: String(property['ุงููุงูู'] || ''),
                    property_location: String(property['ูููุน ุงูุนูุงุฑ'] || ''),
                    contract_type: String(property['ููุน ุงูุนูุฏ'] || 'ุณููู'),
                    remaining_installments: Number(property['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ'] || 0),
                    electricity_account: String(property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] || ''),
                    height: String(property['ุงูุงุฑุชูุงุน'] || ''),
                    last_update: new Date().toLocaleDateString('ar-SA'),

                    // ูุนูููุงุช ุงูุฃูุณุงุท
                    installment_count: Number(property['ุนุฏุฏ ุงูุงูุณุงุท'] || 0),
                    first_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุงูู']),
                    first_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุงูู'] || 0),
                    second_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู']),
                    second_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุซุงูู'] || 0),
                    third_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูุซ']),
                    third_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุซุงูุซ'] || 0),
                    fourth_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุฑุงุจุน']),
                    fourth_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุฑุงุจุน'] || 0),
                    fifth_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุฎุงูุณ']),
                    fifth_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุฎุงูุณ'] || 0),
                    sixth_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุณุงุฏุณ']),
                    sixth_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุณุงุฏุณ'] || 0),
                    seventh_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุณุงุจุน']),
                    seventh_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุณุงุจุน'] || 0),
                    eighth_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู']),
                    eighth_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุซุงูู'] || 0),
                    ninth_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุชุงุณุน']),
                    ninth_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุชุงุณุน'] || 0),
                    tenth_installment_date: parseDate(property['ุชุงุฑูุฎ ุงููุณุท ุงูุนุงุดุฑ']),
                    tenth_installment_amount: Number(property['ูููุฉ ุงููุณุท ุงูุนุงุดุฑ'] || 0),
                    installment_end_date: parseDate(property['ุชุงุฑูุฎ ุงูุชูุงุก ุงูุงูุณุงุท']),

                    // ุญูุธ ุงูุจูุงูุงุช ุงููุงููุฉ
                    raw_data: property,

                    // ุชูุงุฑูุฎ ุงููุธุงู
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                dataToSave.push(propertyData);

            } catch (propertyError) {
                console.error(`โ ุฎุทุฃ ูู ุชุญุถูุฑ ุงูุนูุงุฑ ${i}:`, propertyError);
                errors.push(`ุงูุนูุงุฑ ${i}: ${propertyError.message}`);
            }
        }

        if (dataToSave.length === 0) {
            throw new Error(`ูุดู ูู ุชุญุถูุฑ ุงูุจูุงูุงุช. ุงูุฃุฎุทุงุก: ${errors.join(', ')}`);
        }

        console.log(`๐ ุชู ุชุญุถูุฑ ${dataToSave.length} ุนูุงุฑ ููุญูุธ`);

        // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ุจุฏูุงู ูู ุงูุญุฐู ูุงูุฅุฏุฑุงุฌ ูููุน ุงูุชูุฑุงุฑ
        console.log(`๐ ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูููุน ุงูุชูุฑุงุฑ...`);

        let updatedCount = 0;
        let insertedCount = 0;
        const updateErrors = [];

        for (const propertyData of dataToSave) {
            try {
                // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุฑ ุจูุงุกู ุนูู unit_number
                const { data: existingProperty, error: checkError } = await supabaseClient
                    .from('properties')
                    .select('id')
                    .eq('unit_number', propertyData.unit_number)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    console.warn(`โ๏ธ ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุนูุงุฑ ${propertyData.unit_number}:`, checkError);
                }

                if (existingProperty) {
                    // ุชุญุฏูุซ ุงูุนูุงุฑ ุงูููุฌูุฏ
                    const { error: updateError } = await supabaseClient
                        .from('properties')
                        .update({
                            ...propertyData,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingProperty.id);

                    if (updateError) {
                        console.error(`โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนูุงุฑ ${propertyData.unit_number}:`, updateError);
                        updateErrors.push(`ุชุญุฏูุซ ${propertyData.unit_number}: ${updateError.message}`);
                    } else {
                        updatedCount++;
                        console.log(`โ ุชู ุชุญุฏูุซ ุงูุนูุงุฑ: ${propertyData.unit_number}`);
                    }
                } else {
                    // ุฅุฏุฑุงุฌ ุนูุงุฑ ุฌุฏูุฏ
                    const { error: insertError } = await supabaseClient
                        .from('properties')
                        .insert([propertyData]);

                    if (insertError) {
                        console.error(`โ ุฎุทุฃ ูู ุฅุฏุฑุงุฌ ุงูุนูุงุฑ ${propertyData.unit_number}:`, insertError);
                        updateErrors.push(`ุฅุฏุฑุงุฌ ${propertyData.unit_number}: ${insertError.message}`);
                    } else {
                        insertedCount++;
                        console.log(`โ ุชู ุฅุฏุฑุงุฌ ุงูุนูุงุฑ ุงูุฌุฏูุฏ: ${propertyData.unit_number}`);
                    }
                }
            } catch (propertyError) {
                console.error(`โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุนูุงุฑ ${propertyData.unit_number}:`, propertyError);
                updateErrors.push(`ูุนุงูุฌุฉ ${propertyData.unit_number}: ${propertyError.message}`);
            }
        }

        console.log(`โ ุชู ุชุญุฏูุซ ${updatedCount} ุนูุงุฑ ูุฅุฏุฑุงุฌ ${insertedCount} ุนูุงุฑ ุฌุฏูุฏ`);

        if (updateErrors.length > 0) {
            console.warn(`โ๏ธ ุญุฏุซุช ${updateErrors.length} ุฃุฎุทุงุก:`, updateErrors);
        }

        return {
            success: true,
            count: updatedCount + insertedCount,
            updated: updatedCount,
            inserted: insertedCount,
            method: 'individual_update',
            message: `ุชู ุชุญุฏูุซ ${updatedCount} ุนูุงุฑ ูุฅุฏุฑุงุฌ ${insertedCount} ุนูุงุฑ ุฌุฏูุฏ`,
            errors: updateErrors.length > 0 ? updateErrors : null
        };



    } catch (error) {
        console.error('โ ุฎุทุฃ ุนุงู ูู ุงูุญูุธ ุงููุจุงุดุฑ:', error);

        // ุฅุฑุฌุงุน ุชูุงุตูู ุงูุฎุทุฃ ูููุณุชุฎุฏู
        return {
            success: false,
            error: error.message,
            count: 0,
            message: `ูุดู ูู ุญูุธ ุงูุจูุงูุงุช: ${error.message}`
        };
    }
}

// ูุนุงูุฌุฉ ุฎุทุฃ ุงูููุชุงุญ ุงูููุฑุฑ
async function handleDuplicateKeyError(dataToSave, originalProperties) {
    console.log('๐ง ูุนุงูุฌุฉ ุฎุทุฃ ุงูููุชุงุญ ุงูููุฑุฑ...');

    try {
        let successCount = 0;
        const errors = [];

        // ุญูุธ ูู ุนูุงุฑ ุจุดูู ูููุตู ูุน ุงูุชุญุฏูุซ
        for (let i = 0; i < dataToSave.length; i++) {
            const propertyData = dataToSave[i];

            try {
                // ูุญุงููุฉ ุงูุชุญุฏูุซ ุฃููุงู
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('properties')
                    .update(propertyData)
                    .eq('property_name', propertyData.property_name)
                    .eq('unit_number', propertyData.unit_number);

                if (updateError) {
                    // ุฅุฐุง ูุดู ุงูุชุญุฏูุซุ ุฌุฑุจ ุงูุฅุฏุฑุงุฌ ูุน ูุนุฑู ุฌุฏูุฏ
                    propertyData.id = generateUUID();

                    const { data: insertData, error: insertError } = await supabaseClient
                        .from('properties')
                        .insert([propertyData]);

                    if (insertError) {
                        throw insertError;
                    }
                }

                successCount++;

            } catch (itemError) {
                console.error(`โ ุฎุทุฃ ูู ุญูุธ ุงูุนูุงุฑ ${i}:`, itemError);
                errors.push(`ุงูุนูุงุฑ ${i}: ${itemError.message}`);
            }
        }

        if (successCount > 0) {
            console.log(`โ ุชู ุญูุธ ${successCount} ุนูุงุฑ ูู ุฃุตู ${dataToSave.length}`);
            return {
                success: true,
                count: successCount,
                method: 'duplicate_handled',
                message: `ุชู ุญูุธ ${successCount} ุนูุงุฑ ุจูุฌุงุญ (ูุน ูุนุงูุฌุฉ ุงูุชูุฑุงุฑ)`,
                errors: errors.length > 0 ? errors : null
            };
        } else {
            throw new Error(`ูุดู ูู ุญูุธ ุฌููุน ุงูุนูุงุฑุงุช: ${errors.join(', ')}`);
        }

    } catch (error) {
        console.error('โ ูุดู ูู ูุนุงูุฌุฉ ุฎุทุฃ ุงูููุชุงุญ ุงูููุฑุฑ:', error);
        throw error;
    }
}

// ุญูุธ ุจุชูุณูู ูุจุณุท
async function saveWithSimplifiedFormat(propertiesToSave) {
    console.log('๐ ุญูุธ ุจุชูุณูู ูุจุณุท...');

    try {
        const simplifiedData = propertiesToSave.map((property, index) => ({
            id: generateUUID(),
            property_name: String(property['ุงุณู ุงูุนูุงุฑ'] || ''),
            city: String(property['ุงููุฏููุฉ'] || ''),
            unit_number: String(property['ุฑูู  ุงููุญุฏุฉ '] || ''),
            tenant_name: String(property['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''),
            contract_number: String(property['ุฑูู ุงูุนูุฏ'] || ''),
            rent_value: Number(property['ูููุฉ  ุงูุงูุฌุงุฑ '] || 0),
            total_amount: Number(property['ุงูุงุฌูุงูู'] || 0),
            contract_type: String(property['ููุน ุงูุนูุฏ'] || 'ุณููู'),
            last_update: new Date().toLocaleDateString('ar-SA'),
            raw_data: property,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        }));

        const { data, error } = await supabaseClient
            .from('properties')
            .insert(simplifiedData);

        if (error) {
            throw error;
        }

        console.log(`โ ุชู ุญูุธ ${propertiesToSave.length} ุนูุงุฑ ุจุงูุชูุณูู ุงููุจุณุท`);
        return {
            success: true,
            count: propertiesToSave.length,
            method: 'simplified',
            message: `ุชู ุญูุธ ${propertiesToSave.length} ุนูุงุฑ ุจูุฌุงุญ (ุชูุณูู ูุจุณุท)`
        };

    } catch (error) {
        console.error('โ ูุดู ุงูุญูุธ ุจุงูุชูุณูู ุงููุจุณุท:', error);
        throw error;
    }
}

// ุทุฑููุฉ ุงุญุชูุงุทูุฉ ููุญูุธ
async function fallbackSaveMethod(propertiesToSave) {
    console.log('๐ ุงุณุชุฎุฏุงู ุงูุทุฑููุฉ ุงูุงุญุชูุงุทูุฉ ููุญูุธ...');

    try {
        // ุญูุธ ุงูุจูุงูุงุช ูู localStorage ููุณุฎุฉ ุงุญุชูุงุทูุฉ
        const backupData = {
            timestamp: new Date().toISOString(),
            properties: propertiesToSave,
            saved: false
        };

        localStorage.setItem('properties_backup_' + Date.now(), JSON.stringify(backupData));

        // ูุญุงููุฉ ุฃุฎูุฑุฉ ุจุฃุจุณุท ุชูุณูู ูููู
        const minimalData = propertiesToSave.map((property, index) => ({
            id: generateUUID(),
            property_name: String(property['ุงุณู ุงูุนูุงุฑ'] || 'ุนูุงุฑ ุบูุฑ ูุญุฏุฏ'),
            city: String(property['ุงููุฏููุฉ'] || 'ุบูุฑ ูุญุฏุฏ'),
            unit_number: String(property['ุฑูู  ุงููุญุฏุฉ '] || 'ุบูุฑ ูุญุฏุฏ'),
            raw_data: property
        }));

        const { data, error } = await supabaseClient
            .from('properties')
            .insert(minimalData);

        if (error) {
            throw error;
        }

        console.log(`โ ุชู ุญูุธ ${propertiesToSave.length} ุนูุงุฑ ุจุงูุทุฑููุฉ ุงูุงุญุชูุงุทูุฉ`);
        return {
            success: true,
            count: propertiesToSave.length,
            method: 'fallback',
            message: `ุชู ุญูุธ ${propertiesToSave.length} ุนูุงุฑ ุจูุฌุงุญ (ุทุฑููุฉ ุงุญุชูุงุทูุฉ)`
        };

    } catch (error) {
        console.error('โ ูุดู ูู ุงูุทุฑููุฉ ุงูุงุญุชูุงุทูุฉ:', error);

        return {
            success: false,
            error: error.message,
            count: 0,
            message: `ูุดู ูู ุฌููุน ุทุฑู ุงูุญูุธ: ${error.message}. ุชู ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุญููุงู.`
        };
    }
}

// ุงูุชุญูู ูู ูุฒุงููุฉ ุงูุจูุงูุงุช (ูุญุณู)
async function verifyDataSync(propertyName, changes) {
    console.log(`๐ ุงูุชุญูู ูู ูุฒุงููุฉ ุงูุจูุงูุงุช ููุนูุงุฑ: ${propertyName}`);

    if (!supabaseClient) {
        throw new Error('ุนููู Supabase ุบูุฑ ูุชุงุญ ููุชุญูู');
    }

    try {
        // ุงูุจุญุซ ุนู ุงูุนูุงุฑ ูู Supabase ุจุทุฑู ูุชุนุฏุฏุฉ
        let data, error;

        // ุงูุทุฑููุฉ ุงูุฃููู: ุงูุจุญุซ ุจู property_name
        ({ data, error } = await supabaseClient
            .from('properties')
            .select('*')
            .eq('property_name', propertyName)
            .limit(1));

        // ุฅุฐุง ูุดูุช ุงูุทุฑููุฉ ุงูุฃูููุ ุฌุฑุจ ุงูุจุญุซ ูู raw_data
        if (error || !data || data.length === 0) {
            ({ data, error } = await supabaseClient
                .from('properties')
                .select('*')
                .contains('raw_data', { 'ุงุณู ุงูุนูุงุฑ': propertyName })
                .limit(1));
        }

        if (error) {
            throw error;
        }

        if (!data || data.length === 0) {
            console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ูู Supabase');
            return {
                success: false,
                message: 'ุงูุนูุงุฑ ุบูุฑ ููุฌูุฏ ูู Supabase'
            };
        }

        const supabaseRecord = data[0];
        const supabaseProperty = supabaseRecord.raw_data || supabaseRecord;

        // ุงูุชุญูู ูู ุงูุชุบููุฑุงุช
        let verificationPassed = true;
        const verificationResults = {};

        Object.keys(changes).forEach(fieldKey => {
            const expectedValue = changes[fieldKey].new;
            let actualValue;

            // ุงูุจุญุซ ุนู ุงููููุฉ ูู ุงูุจูุงูุงุช ุงููุฎุชููุฉ
            if (supabaseProperty[fieldKey] !== undefined) {
                actualValue = supabaseProperty[fieldKey];
            } else if (supabaseRecord[fieldKey] !== undefined) {
                actualValue = supabaseRecord[fieldKey];
            } else {
                // ูุญุงููุฉ ุงูุจุญุซ ุจุงูุฃุณูุงุก ุงููุชุฑุฌูุฉ
                const fieldMapping = {
                    'ุงุณู ุงูุนูุงุฑ': 'property_name',
                    'ุงููุฏููุฉ': 'city',
                    'ุฑูู ุงูุตู': 'deed_number',
                    'ูุณุงุญุฉุงูุตู': 'deed_area',
                    'ุงูุณุฌู ุงูุนููู ': 'registry_number',
                    'ุงูุณุฌู ุงูุนููู ': 'real_estate_registry', // ุฅุถุงูุฉ ููุชูุงูู ูุน ุงูุนููุฏ ุงูููุฌูุฏ
                    'ุงููุงูู': 'owner_name',
                    'ุงููุงูู': 'owner', // ุฅุถุงูุฉ ููุชูุงูู ูุน ุงูุนููุฏ ุงูููุฌูุฏ
                    'ูููุน ุงูุนูุงุฑ': 'property_location'
                };

                const mappedField = fieldMapping[fieldKey];
                if (mappedField && supabaseRecord[mappedField] !== undefined) {
                    actualValue = supabaseRecord[mappedField];
                }
            }

            verificationResults[fieldKey] = {
                expected: expectedValue,
                actual: actualValue,
                match: String(expectedValue) === String(actualValue)
            };

            if (!verificationResults[fieldKey].match) {
                verificationPassed = false;
            }
        });

        if (verificationPassed) {
            console.log('โ ุชู ุงูุชุญูู ูู ูุฒุงููุฉ ุฌููุน ุงูุชุบููุฑุงุช');
        } else {
            console.warn('โ๏ธ ุจุนุถ ุงูุชุบููุฑุงุช ูู ุชุชู ูุฒุงููุชูุง:', verificationResults);
        }

        return {
            success: verificationPassed,
            results: verificationResults,
            supabaseData: supabaseRecord
        };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุงููุฒุงููุฉ:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// ุฅุนุงุฏุฉ ูุญุงููุฉ ุงููุฒุงููุฉ ููุนูุงุฑุงุช ุงููุญุฏุฏุฉ
async function retryPropertySync(propertyName) {
    console.log(`๐ ุฅุนุงุฏุฉ ูุญุงููุฉ ูุฒุงููุฉ ุงูุนูุงุฑ: ${propertyName}`);

    try {
        // ุงูุจุญุซ ุนู ุงูุนูุงุฑ ูุญููุงู
        const relatedProperties = properties.filter(p => p['ุงุณู ุงูุนูุงุฑ'] === propertyName);

        if (relatedProperties.length === 0) {
            throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงุฑ ูุญููุงู');
        }

        // ูุญุงููุฉ ุงูุญูุธ ุงููุจุงุดุฑ
        await savePropertiesDirectlyToSupabase(relatedProperties);

        showToast(`ุชู ูุฒุงููุฉ ุงูุนูุงุฑ "${propertyName}" ุจูุฌุงุญ`, 'success');
        console.log(`โ ุชู ูุฒุงููุฉ ุงูุนูุงุฑ "${propertyName}" ุจูุฌุงุญ`);

        return { success: true };

    } catch (error) {
        console.error(`โ ูุดู ูู ุฅุนุงุฏุฉ ูุฒุงููุฉ ุงูุนูุงุฑ "${propertyName}":`, error);
        showToast(`ูุดู ูู ูุฒุงููุฉ ุงูุนูุงุฑ "${propertyName}": ${error.message}`, 'error');

        return { success: false, error: error.message };
    }
}

// ูุญุต ุญุงูุฉ ุงููุฒุงููุฉ ูุฌููุน ุงูุนูุงุฑุงุช
async function checkAllPropertiesSync() {
    console.log('๐ ูุญุต ุญุงูุฉ ูุฒุงููุฉ ุฌููุน ุงูุนูุงุฑุงุช...');

    if (!supabaseClient) {
        console.warn('โ๏ธ ุนููู Supabase ุบูุฑ ูุชุงุญ ูููุญุต');
        return { success: false, error: 'ุนููู Supabase ุบูุฑ ูุชุงุญ' };
    }

    try {
        // ุงูุญุตูู ุนูู ุฌููุน ุงูุนูุงุฑุงุช ูู Supabase
        const { data: supabaseData, error } = await supabaseClient
            .from('properties')
            .select('data');

        if (error) {
            throw error;
        }

        const localProperties = getUniqueProperties();
        const supabaseProperties = supabaseData.map(item => item.data['ุงุณู ุงูุนูุงุฑ']).filter(name => name);

        const syncStatus = {
            localCount: localProperties.length,
            supabaseCount: supabaseProperties.length,
            missingInSupabase: localProperties.filter(name => !supabaseProperties.includes(name)),
            extraInSupabase: supabaseProperties.filter(name => !localProperties.includes(name))
        };

        console.log('๐ ุญุงูุฉ ุงููุฒุงููุฉ:', syncStatus);

        if (syncStatus.missingInSupabase.length > 0) {
            console.warn(`โ๏ธ ${syncStatus.missingInSupabase.length} ุนูุงุฑ ููููุฏ ูู Supabase:`, syncStatus.missingInSupabase);
        }

        return { success: true, status: syncStatus };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุญุต ุงููุฒุงููุฉ:', error);
        return { success: false, error: error.message };
    }
}

// ุฅุถุงูุฉ ุงููุธุงุฆู ูููุญุฉ ุงูุชุญูู
window.retryPropertySync = retryPropertySync;
window.checkAllPropertiesSync = checkAllPropertiesSync;
window.savePropertiesDirectlyToSupabase = savePropertiesDirectlyToSupabase;

// ===== ููุงูุฉ ูุธุงุฆู ูุณุงุนุฏุฉ ูุญูุธ ุงูุนูุงุฑุงุช =====

// ===== ูุธููุฉ ุงุฎุชุจุงุฑ ุดุงููุฉ ููุธุงู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช =====

// ุงุฎุชุจุงุฑ ุดุงูู ููุธุงู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช
async function testPropertyEditSystem() {
    console.log('๐งช ุจุฏุก ุงูุงุฎุชุจุงุฑ ุงูุดุงูู ููุธุงู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช...');

    // ุฅุธูุงุฑ ูุงูุฐุฉ ุงูุงุฎุชุจุงุฑ
    const testModal = document.createElement('div');
    testModal.className = 'modal-overlay';
    testModal.style.display = 'flex';
    testModal.style.zIndex = '10003';
    testModal.innerHTML = `
        <div class="modal-box test-modal">
            <div class="test-header">
                <h3><i class="fas fa-vial"></i> ุงุฎุชุจุงุฑ ูุธุงู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช</h3>
                <button class="close-modal" onclick="closeModal()">ร</button>
            </div>
            <div class="test-content">
                <div class="test-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="testProgressFill"></div>
                    </div>
                    <div class="progress-text" id="testProgressText">ุฌุงุฑู ุงูุชุญุถูุฑ...</div>
                </div>

                <div class="test-steps" id="testSteps">
                    <div class="test-step" id="step1">
                        <i class="fas fa-clock step-icon"></i>
                        <span>ูุญุต ุงูููููุงุช ุงูุฃุณุงุณูุฉ</span>
                        <div class="step-status" id="status1"></div>
                    </div>
                    <div class="test-step" id="step2">
                        <i class="fas fa-clock step-icon"></i>
                        <span>ุงุฎุชุจุงุฑ ุงุชุตุงู Supabase</span>
                        <div class="step-status" id="status2"></div>
                    </div>
                    <div class="test-step" id="step3">
                        <i class="fas fa-clock step-icon"></i>
                        <span>ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑ</span>
                        <div class="step-status" id="status3"></div>
                    </div>
                    <div class="test-step" id="step4">
                        <i class="fas fa-clock step-icon"></i>
                        <span>ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ</span>
                        <div class="step-status" id="status4"></div>
                    </div>
                    <div class="test-step" id="step5">
                        <i class="fas fa-clock step-icon"></i>
                        <span>ุงูุชุญูู ูู ุงููุชุงุฆุฌ</span>
                        <div class="step-status" id="status5"></div>
                    </div>
                </div>

                <div class="test-results" id="testResults" style="display: none;">
                    <h4>ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ:</h4>
                    <div id="testResultsContent"></div>
                </div>

                <div class="test-actions">
                    <button id="startTestBtn" onclick="runFullPropertyEditTest()" class="test-action-btn">
                        <i class="fas fa-play"></i> ุจุฏุก ุงูุงุฎุชุจุงุฑ
                    </button>
                    <button onclick="closeModal()" class="test-action-btn secondary">
                        <i class="fas fa-times"></i> ุฅุบูุงู
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(testModal);

    // ุฅุถุงูุฉ ูุณุชูุน ูุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
    testModal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
}

// ุชุดุบูู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู
async function runFullPropertyEditTest() {
    console.log('๐ ุจุฏุก ุชุดุบูู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู...');

    const startBtn = document.getElementById('startTestBtn');
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุงุฎุชุจุงุฑ...';

    const results = {
        step1: false,
        step2: false,
        step3: false,
        step4: false,
        step5: false,
        details: {}
    };

    try {
        // ุงูุฎุทูุฉ 1: ูุญุต ุงูููููุงุช ุงูุฃุณุงุณูุฉ
        updateTestStep(1, 'running', 'ูุญุต ุงูููููุงุช...');
        updateTestProgress(20, 'ูุญุต ุงูููููุงุช ุงูุฃุณุงุณูุฉ...');

        const componentsCheck = await checkSystemComponents();
        results.step1 = componentsCheck.success;
        results.details.components = componentsCheck;

        updateTestStep(1, results.step1 ? 'success' : 'error',
            results.step1 ? 'ุชู ุจูุฌุงุญ' : 'ูุดู');

        if (!results.step1) {
            throw new Error('ูุดู ูู ูุญุต ุงูููููุงุช ุงูุฃุณุงุณูุฉ');
        }

        // ุงูุฎุทูุฉ 2: ุงุฎุชุจุงุฑ ุงุชุตุงู Supabase
        updateTestStep(2, 'running', 'ุงุฎุชุจุงุฑ ุงูุงุชุตุงู...');
        updateTestProgress(40, 'ุงุฎุชุจุงุฑ ุงุชุตุงู Supabase...');

        const connectionCheck = await checkSupabaseConnection();
        results.step2 = connectionCheck.connected;
        results.details.connection = connectionCheck;

        updateTestStep(2, results.step2 ? 'success' : 'error',
            results.step2 ? 'ูุชุตู' : 'ุบูุฑ ูุชุตู');

        // ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑ
        updateTestStep(3, 'running', 'ุงุฎุชุจุงุฑ ุงูุชุญุฑูุฑ...');
        updateTestProgress(60, 'ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑ...');

        const editTest = await testPropertyEdit();
        results.step3 = editTest.success;
        results.details.edit = editTest;

        updateTestStep(3, results.step3 ? 'success' : 'error',
            results.step3 ? 'ูุฌุญ' : 'ูุดู');

        // ุงูุฎุทูุฉ 4: ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ
        updateTestStep(4, 'running', 'ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ...');
        updateTestProgress(80, 'ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ...');

        if (results.step2) {
            const syncTest = await syncToSupabase(false);
            results.step4 = syncTest.success;
            results.details.sync = syncTest;
        } else {
            results.step4 = false;
            results.details.sync = { success: false, message: 'ูุง ููุฌุฏ ุงุชุตุงู ุจู Supabase' };
        }

        updateTestStep(4, results.step4 ? 'success' : 'warning',
            results.step4 ? 'ูุฌุญุช' : 'ูุดูุช');

        // ุงูุฎุทูุฉ 5: ุงูุชุญูู ูู ุงููุชุงุฆุฌ
        updateTestStep(5, 'running', 'ุงูุชุญูู...');
        updateTestProgress(100, 'ุงูุชูู ุงูุงุฎุชุจุงุฑ');

        const overallSuccess = results.step1 && results.step3;
        results.step5 = overallSuccess;

        updateTestStep(5, overallSuccess ? 'success' : 'warning', 'ุงูุชูู');

        // ุนุฑุถ ุงููุชุงุฆุฌ
        showTestResults(results);

        console.log('โ ุงูุชูู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู:', results);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู:', error);
        updateTestProgress(100, 'ูุดู ุงูุงุฎุชุจุงุฑ');
        showTestResults(results, error);
    } finally {
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-redo"></i> ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ';
    }
}

// ุชุญุฏูุซ ุฎุทูุฉ ุงูุงุฎุชุจุงุฑ
function updateTestStep(stepNumber, status, message) {
    const step = document.getElementById(`step${stepNumber}`);
    const icon = step.querySelector('.step-icon');
    const statusDiv = step.querySelector('.step-status');

    // ุชุญุฏูุซ ุงูุฃููููุฉ
    icon.className = status === 'running' ? 'fas fa-spinner fa-spin step-icon' :
                    status === 'success' ? 'fas fa-check step-icon success' :
                    status === 'error' ? 'fas fa-times step-icon error' :
                    'fas fa-exclamation-triangle step-icon warning';

    // ุชุญุฏูุซ ุงูุญุงูุฉ
    statusDiv.textContent = message;
    statusDiv.className = `step-status ${status}`;
}

// ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
function updateTestProgress(percentage, message) {
    const progressFill = document.getElementById('testProgressFill');
    const progressText = document.getElementById('testProgressText');

    if (progressFill) {
        progressFill.style.width = `${percentage}%`;
    }

    if (progressText) {
        progressText.textContent = message;
    }
}

// ุนุฑุถ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ
function showTestResults(results, error = null) {
    const resultsDiv = document.getElementById('testResults');
    const contentDiv = document.getElementById('testResultsContent');

    let html = '';

    if (error) {
        html += `<div class="result-error">โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ: ${error.message}</div>`;
    }

    const overallSuccess = results.step1 && results.step3;
    html += `<div class="result-summary ${overallSuccess ? 'success' : 'warning'}">`;
    html += `<h5>${overallSuccess ? 'โ ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ' : 'โ๏ธ ูุญุชุงุฌ ุงููุธุงู ุฅูู ุฅุตูุงุญุงุช'}</h5>`;
    html += `</div>`;

    html += '<div class="result-details">';
    html += `<p><strong>ุงูููููุงุช ุงูุฃุณุงุณูุฉ:</strong> ${results.step1 ? 'โ ุณูููุฉ' : 'โ ูุดููุฉ'}</p>`;
    html += `<p><strong>ุงุชุตุงู Supabase:</strong> ${results.step2 ? 'โ ูุชุตู' : 'โ ุบูุฑ ูุชุตู'}</p>`;
    html += `<p><strong>ุชุญุฑูุฑ ุงูุนูุงุฑุงุช:</strong> ${results.step3 ? 'โ ูุนูู' : 'โ ูุง ูุนูู'}</p>`;
    html += `<p><strong>ุงููุฒุงููุฉ:</strong> ${results.step4 ? 'โ ุชุนูู' : 'โ๏ธ ูุง ุชุนูู'}</p>`;
    html += '</div>';

    if (!overallSuccess) {
        html += '<div class="result-recommendations">';
        html += '<h5>ุงูุชูุตูุงุช:</h5>';
        html += '<ul>';
        if (!results.step1) html += '<li>ุชุญูู ูู ุชุญููู ุฌููุน ูููุงุช JavaScript</li>';
        if (!results.step2) html += '<li>ุชุญูู ูู ุฅุนุฏุงุฏุงุช Supabase</li>';
        if (!results.step3) html += '<li>ุชุญูู ูู ูุธุงุฆู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช</li>';
        if (!results.step4) html += '<li>ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช</li>';
        html += '</ul>';
        html += '</div>';
    }

    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

// ูุญุต ุงูููููุงุช ุงูุฃุณุงุณูุฉ
async function checkSystemComponents() {
    const components = {
        properties: Array.isArray(properties),
        savePropertyChanges: typeof savePropertyChanges === 'function',
        editPropertyData: typeof editPropertyData === 'function',
        showToast: typeof showToast === 'function',
        syncToSupabase: typeof syncToSupabase === 'function',
        localStorage: typeof localStorage !== 'undefined'
    };

    const allGood = Object.values(components).every(Boolean);

    return {
        success: allGood,
        components: components,
        message: allGood ? 'ุฌููุน ุงูููููุงุช ุณูููุฉ' : 'ุจุนุถ ุงูููููุงุช ููููุฏุฉ'
    };
}

// ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑ
async function testPropertyEdit() {
    try {
        if (!properties || properties.length === 0) {
            return { success: false, message: 'ูุง ุชูุฌุฏ ุนูุงุฑุงุช ููุงุฎุชุจุงุฑ' };
        }

        const testProperty = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] && p['ุงุณู ุงูุนูุงุฑ'].trim() !== '');
        if (!testProperty) {
            return { success: false, message: 'ูุง ุชูุฌุฏ ุนูุงุฑุงุช ุตุงูุญุฉ ููุงุฎุชุจุงุฑ' };
        }

        // ูุญุงูุงุฉ ุชุญุฑูุฑ ุจุณูุท
        const originalValue = testProperty['ุงููุงูู'];
        const testValue = 'ุงุฎุชุจุงุฑ - ' + Date.now();

        testProperty['ุงููุงูู'] = testValue;
        saveDataLocally();

        // ุงูุชุญูู ูู ุงูุญูุธ
        const savedProperty = properties.find(p => p['ุงุณู ุงูุนูุงุฑ'] === testProperty['ุงุณู ุงูุนูุงุฑ']);
        const success = savedProperty && savedProperty['ุงููุงูู'] === testValue;

        // ุฅุนุงุฏุฉ ุงููููุฉ ุงูุฃุตููุฉ
        testProperty['ุงููุงูู'] = originalValue;
        saveDataLocally();

        return {
            success: success,
            message: success ? 'ุชู ุงุฎุชุจุงุฑ ุงูุชุญุฑูุฑ ุจูุฌุงุญ' : 'ูุดู ูู ุงุฎุชุจุงุฑ ุงูุชุญุฑูุฑ'
        };

    } catch (error) {
        return { success: false, message: error.message };
    }
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.testPropertyEditSystem = testPropertyEditSystem;

// ===== ููุงูุฉ ูุธููุฉ ุงุฎุชุจุงุฑ ุดุงููุฉ ููุธุงู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช =====

// ===== ูุธุงุฆู ุฅูุดุงุก ุฌุฏุงูู Supabase =====

// ุฅูุดุงุก ุฌุฏูู properties ุฅุฐุง ูู ููู ููุฌูุฏุงู
async function createPropertiesTableIfNotExists() {
    console.log('๐ง ุงูุชุญูู ูู ูุฌูุฏ ุฌุฏูู properties...');

    if (!supabaseClient) {
        throw new Error('ุนููู Supabase ุบูุฑ ูุชุงุญ');
    }

    try {
        // ูุญุงููุฉ ุงูุงุณุชุนูุงู ุนู ุงูุฌุฏูู ููุชุญูู ูู ูุฌูุฏู
        const { data, error } = await supabaseClient
            .from('properties')
            .select('id')
            .limit(1);

        if (!error) {
            console.log('โ ุฌุฏูู properties ููุฌูุฏ ุจุงููุนู');
            return { success: true, exists: true };
        }

        // ุฅุฐุง ูุงู ุงูุฎุทุฃ ูุดูุฑ ุฅูู ุนุฏู ูุฌูุฏ ุงูุฌุฏููุ ุฃูุดุฆู
        if (error.message.includes('does not exist') || error.message.includes('relation')) {
            console.log('๐ง ุฅูุดุงุก ุฌุฏูู properties...');

            // ุงุณุชุฎุฏุงู SQL ูุฅูุดุงุก ุงูุฌุฏูู
            const createTableSQL = `
                CREATE TABLE IF NOT EXISTS properties (
                    id TEXT PRIMARY KEY,
                    property_name TEXT,
                    city TEXT,
                    unit_number TEXT,
                    tenant_name TEXT,
                    contract_number TEXT,
                    rent_value NUMERIC DEFAULT 0
                    start_date TEXT,
                    end_date TEXT,
                    total_amount NUMERIC DEFAULT 0,
                    area NUMERIC,
                    deed_number TEXT,
                    deed_area NUMERIC,
                    registry_number TEXT,
                    real_estate_registry TEXT, -- ุฅุถุงูุฉ ููุชูุงูู ูุน ุงูุนููุฏ ุงูููุฌูุฏ
                    owner_name TEXT,
                    owner TEXT, -- ุฅุถุงูุฉ ููุชูุงูู ูุน ุงูุนููุฏ ุงูููุฌูุฏ
                    property_location TEXT,
                    contract_type TEXT DEFAULT 'ุณููู',
                    remaining_installments INTEGER,
                    last_update TEXT,
                    raw_data JSONB,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );

                -- ุฅูุดุงุก ููุงุฑุณ ููุจุญุซ ุงูุณุฑูุน
                CREATE INDEX IF NOT EXISTS idx_properties_name ON properties(property_name);
                CREATE INDEX IF NOT EXISTS idx_properties_city ON properties(city);
                CREATE INDEX IF NOT EXISTS idx_properties_unit ON properties(unit_number);
                CREATE INDEX IF NOT EXISTS idx_properties_tenant ON properties(tenant_name);
            `;

            // ุชูููุฐ SQL (ูุฐุง ูุฏ ูุง ูุนูู ูุน REST APIุ ูุฐุง ุณูุณุชุฎุฏู ุทุฑููุฉ ุจุฏููุฉ)
            console.log('๐ SQL ููุฅูุดุงุก ุฌุงูุฒุ ุณูุชู ุงุณุชุฎุฏุงู ุทุฑููุฉ ุจุฏููุฉ...');

            return { success: true, created: true, sql: createTableSQL };
        }

        // ุฎุทุฃ ุขุฎุฑ ุบูุฑ ูุชููุน
        throw error;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุฌุฏูู properties:', error);
        return { success: false, error: error.message };
    }
}

// ุทุฑููุฉ ุจุฏููุฉ ูุฅูุดุงุก ุงูุฌุฏูู
async function createPropertiesTableAlternative() {
    console.log('๐ง ุฅูุดุงุก ุฌุฏูู properties ุจุงูุทุฑููุฉ ุงูุจุฏููุฉ...');

    try {
        // ูุญุงููุฉ ุฅุฏุฑุงุฌ ุณุฌู ุชุฌุฑูุจู ูุฅูุดุงุก ุงูุฌุฏูู ุชููุงุฆูุงู
        const testRecord = {
            id: 'test_record_' + Date.now(),
            property_name: 'ุนูุงุฑ ุชุฌุฑูุจู',
            city: 'ุงูุฑูุงุถ',
            unit_number: 'TEST_001',
            tenant_name: '',
            contract_number: '',
            rent_value: 0,
            start_date: null,
            end_date: null,
            total_amount: 0,
            area: null,
            deed_number: null,
            deed_area: null,
            registry_number: null,
            real_estate_registry: null, // ุฅุถุงูุฉ ููุชูุงูู ูุน ุงูุนููุฏ ุงูููุฌูุฏ
            owner_name: null,
            owner: null, // ุฅุถุงูุฉ ููุชูุงูู ูุน ุงูุนููุฏ ุงูููุฌูุฏ
            property_location: null,
            contract_type: 'ุณููู',
            remaining_installments: null,
            last_update: new Date().toLocaleDateString('ar-SA'),
            raw_data: JSON.stringify({ test: true }),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        const { data, error } = await supabaseClient
            .from('properties')
            .insert([testRecord]);

        if (error) {
            throw error;
        }

        // ุญุฐู ุงูุณุฌู ุงูุชุฌุฑูุจู
        await supabaseClient
            .from('properties')
            .delete()
            .eq('id', testRecord.id);

        console.log('โ ุชู ุฅูุดุงุก ุฌุฏูู properties ุจูุฌุงุญ');
        return { success: true };

    } catch (error) {
        console.error('โ ูุดู ูู ุฅูุดุงุก ุงูุฌุฏูู ุจุงูุทุฑููุฉ ุงูุจุฏููุฉ:', error);
        throw error;
    }
}

// ูุฒุงููุฉ ุจุฏููุฉ ููุจูุงูุงุช
async function syncMainDataAlternative(propertiesData) {
    console.log('๐ ูุฒุงููุฉ ุงูุจูุงูุงุช ุจุงูุทุฑููุฉ ุงูุจุฏููุฉ...');

    try {
        // ุชุญุถูุฑ ุงูุจูุงูุงุช ุจุชูุณูู ูุจุณุท
        const simplifiedData = propertiesData.map((property, index) => ({
            id: generateUUID(),
            property_name: String(property['ุงุณู ุงูุนูุงุฑ'] || ''),
            city: String(property['ุงููุฏููุฉ'] || ''),
            unit_number: String(property['ุฑูู  ุงููุญุฏุฉ '] || ''),
            tenant_name: String(property['ุงุณู ุงููุณุชุฃุฌุฑ'] || ''),
            contract_number: String(property['ุฑูู ุงูุนูุฏ'] || ''),
            rent_value: Number(property['ูููุฉ  ุงูุงูุฌุงุฑ '] || 0),
            total_amount: Number(property['ุงูุงุฌูุงูู'] || 0),
            raw_data: property, // ุญูุธ ุงูุจูุงูุงุช ุงููุงููุฉ
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        }));

        // ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช
        const { data, error } = await supabaseClient
            .from('properties')
            .insert(simplifiedData);

        if (error) {
            throw error;
        }

        console.log(`โ ุชู ูุฒุงููุฉ ${propertiesData.length} ุนูุงุฑ ุจุงูุทุฑููุฉ ุงูุจุฏููุฉ`);
        return { success: true, count: propertiesData.length };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงููุฒุงููุฉ ุงูุจุฏููุฉ:', error);
        throw error;
    }
}

// ===== ููุงูุฉ ูุธุงุฆู ุฅูุดุงุก ุฌุฏุงูู Supabase =====

// ===== ูุธุงุฆู ูุณุงุนุฏุฉ ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู =====

// ุฅูุดุงุก UUID ูุชูุงูู ูุน ุฌููุน ุงููุชุตูุญุงุช
function generateUUID() {
    // ูุญุงููุฉ ุงุณุชุฎุฏุงู crypto.randomUUID() ุฅุฐุง ูุงู ูุชููุฑุงู
    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        try {
            return crypto.randomUUID();
        } catch (error) {
            console.warn('ูุดู ูู ุงุณุชุฎุฏุงู crypto.randomUUID():', error);
        }
    }

    // ุทุฑููุฉ ุจุฏููุฉ ูุฅูุดุงุก UUID
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// ุฅูุดุงุก ูุนุฑู ุจุณูุท ููุงุณุชุฎุฏุงู ุงูุงุญุชูุงุทู
function generateSimpleId(prefix = 'item') {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    return `${prefix}_${timestamp}_${random}`;
}

// ุฅุตูุงุญ ุงููุนุฑูุงุช ุงูุฎุงุทุฆุฉ ูู ุงูุจูุงูุงุช
function fixInvalidIds(data) {
    if (!data || !Array.isArray(data)) return data;

    return data.map(item => {
        if (!item.id || typeof item.id !== 'string' || item.id.includes('fallback_')) {
            // ุฅูุดุงุก ูุนุฑู ุฌุฏูุฏ ุตุญูุญ
            item.id = generateUUID();
        }
        return item;
    });
}

// ุชูุธูู ุงูุจูุงูุงุช ูุจู ุงูุญูุธ
function sanitizeDataForSave(propertiesToSave) {
    if (!propertiesToSave || !Array.isArray(propertiesToSave)) {
        return [];
    }

    return propertiesToSave.map((property, index) => {
        // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        const sanitized = {
            ...property,
            'ุงุณู ุงูุนูุงุฑ': property['ุงุณู ุงูุนูุงุฑ'] || `ุนูุงุฑ ${index + 1}`,
            'ุงููุฏููุฉ': property['ุงููุฏููุฉ'] || 'ุบูุฑ ูุญุฏุฏ',
            'ุฑูู  ุงููุญุฏุฉ ': property['ุฑูู  ุงููุญุฏุฉ '] || `ูุญุฏุฉ_${index + 1}`,
            'ุงุณู ุงููุณุชุฃุฌุฑ': property['ุงุณู ุงููุณุชุฃุฌุฑ'] || '',
            'ุฑูู ุงูุนูุฏ': property['ุฑูู ุงูุนูุฏ'] || '',
            'ูููุฉ  ุงูุงูุฌุงุฑ ': Number(property['ูููุฉ  ุงูุงูุฌุงุฑ '] || 0),
            'ุงูุงุฌูุงูู': Number(property['ุงูุงุฌูุงูู'] || 0),
            'ููุน ุงูุนูุฏ': property['ููุน ุงูุนูุฏ'] || 'ุณููู'
        };

        return sanitized;
    });
}

// ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุชุญุฑูุฑ ุงูุนูุงุฑ ูุถูุงู ุงูุชุญุฏูุซ ุงูููุฑู
async function refreshDataAfterPropertyEdit(propertyName) {
    console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุชุญุฑูุฑ ุงูุนูุงุฑ:', propertyName);

    try {
        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู localStorage
        const savedData = localStorage.getItem('properties');
        if (savedData) {
            const localProperties = JSON.parse(savedData);

            // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูุนุงูุฉ
            properties = localProperties;
            console.log(`๐ ุชู ุชุญููู ${properties.length} ุณุฌู ูู localStorage`);
        }

        // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุจูุงูุงุช ูู ุฌููุน ุงููุงุฌูุงุช
        if (typeof renderData === 'function') {
            renderData();
            console.log('โ ุชู ุชุญุฏูุซ ุนุฑุถ ุงูุจูุงูุงุช ุงูุฑุฆูุณู');
        }

        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        if (typeof updateTotalStats === 'function') {
            updateTotalStats();
            console.log('โ ุชู ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช');
        }

        // ุชุญุฏูุซ ุชุจููุจ ุงูุนูุงุฑุงุช
        const propertiesTab = document.getElementById('properties-tab');
        if (propertiesTab && typeof renderPropertiesTab === 'function') {
            propertiesTab.innerHTML = renderPropertiesTab();
            console.log('โ ุชู ุชุญุฏูุซ ุชุจููุจ ุงูุนูุงุฑุงุช');
        }

        // ุชุญุฏูุซ ุฃู ููุงูุฐ ููุชูุญุฉ ูุชูุงุตูู ุงููุญุฏุงุช
        const openModals = document.querySelectorAll('.modal-overlay');
        openModals.forEach(modal => {
            const modalContent = modal.querySelector('.unit-details-modal');
            if (modalContent) {
                // ุฅุบูุงู ุงููุงูุฐุฉ ูุฅุนุงุฏุฉ ูุชุญูุง ุจุงูุจูุงูุงุช ุงููุญุฏุซุฉ
                const unitNumber = modalContent.querySelector('h3')?.textContent?.match(/\d+/)?.[0];
                if (unitNumber) {
                    closeModal();
                    setTimeout(() => {
                        showUnitDetails(unitNumber, propertyName);
                    }, 100);
                }
            }
        });

        console.log('โ ุชู ุฅุนุงุฏุฉ ุชุญููู ุฌููุน ุงูุจูุงูุงุช ุจูุฌุงุญ');

    } catch (error) {
        console.warn('โ๏ธ ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช:', error);
    }
}

// ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุจุนุฏ ุญูุธ ูุงุฌุญ
function updatePropertyDisplayAfterSave(propertyName, changes) {
    console.log('๐จ ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุจุนุฏ ุงูุญูุธ...');

    try {
        // ุชุญุฏูุซ ุนุฑุถ ุงูุจุทุงูุงุช
        const cards = document.querySelectorAll('.property-card');
        cards.forEach(card => {
            const cardPropertyName = card.querySelector('.property-name')?.textContent;
            if (cardPropertyName === propertyName) {
                // ุฅุถุงูุฉ ูุคุดุฑ ุจุตุฑู ูููุฌุงุญ
                card.style.border = '2px solid #28a745';
                card.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.3)';

                // ุฅุฒุงูุฉ ุงููุคุดุฑ ุจุนุฏ 3 ุซูุงู
                setTimeout(() => {
                    card.style.border = '';
                    card.style.boxShadow = '';
                }, 3000);

                // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ
                Object.keys(changes).forEach(fieldKey => {
                    const fieldElement = card.querySelector(`[data-field="${fieldKey}"]`);
                    if (fieldElement) {
                        fieldElement.textContent = changes[fieldKey].new;

                        // ุฅุถุงูุฉ ุชุฃุซูุฑ ุจุตุฑู ููุชุบููุฑ
                        fieldElement.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            fieldElement.style.backgroundColor = '';
                        }, 2000);
                    }
                });
            }
        });

        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
        updateStatisticsAfterSave();

        // ุชุญุฏูุซ ููุงุฆู ุงูุชุตููุฉ
        updateFiltersAfterSave();

        console.log('โ ุชู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุจูุฌุงุญ');

    } catch (error) {
        console.warn('โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู:', error);
    }
}

// ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุจุนุฏ ุงูุญูุธ
function updateStatisticsAfterSave() {
    try {
        // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช ุจุงูุทุฑููุฉ ุงูุตุญูุญุฉ
        console.log('๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุจุนุฏ ุงูุญูุธ...');

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู localStorage
        const savedData = localStorage.getItem('properties');
        if (savedData) {
            properties = JSON.parse(savedData);
            console.log(`๐ ุชู ุชุญููู ${properties.length} ุณุฌู ูู localStorage`);
        }

        // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
        if (typeof renderTotals === 'function' && properties) {
            renderTotals(properties);
            console.log('โ ุชู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุดุงุดุฉ ุงููุจูุฑุฉ');
        }

        if (typeof renderMobileTotals === 'function' && properties) {
            renderMobileTotals(properties);
            console.log('โ ุชู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูููุจุงูู');
        }

        // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุจูุงูุงุช
        if (typeof renderTable === 'function' && properties) {
            renderTable(properties);
            console.log('โ ุชู ุชุญุฏูุซ ุนุฑุถ ุงูุฌุฏูู');
        }

        // ุชุญุฏูุซ ุงูููุงุชุฑ
        if (typeof updateFilters === 'function') {
            updateFilters();
            console.log('โ ุชู ุชุญุฏูุซ ุงูููุงุชุฑ');
        }

        // ุชุญุฏูุซ ุนุฏุงุฏุงุช ุงููุฏู
        if (typeof updateCityFilter === 'function') {
            updateCityFilter();
        }

    } catch (error) {
        console.warn('โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช:', error);
    }
}

// ุชุญุฏูุซ ููุงุฆู ุงูุชุตููุฉ ุจุนุฏ ุงูุญูุธ
function updateFiltersAfterSave() {
    try {
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฏู
        const cityFilter = document.getElementById('cityFilter');
        if (cityFilter && typeof populateCityFilter === 'function') {
            populateCityFilter();
        }

        // ุชุญุฏูุซ ููุงุฆู ุงูุจุญุซ
        const searchInputs = document.querySelectorAll('input[type="search"]');
        searchInputs.forEach(input => {
            if (input.value) {
                // ุฅุนุงุฏุฉ ุชุทุจูู ุงูุจุญุซ
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            }
        });

    } catch (error) {
        console.warn('โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ููุงุฆู ุงูุชุตููุฉ:', error);
    }
}

// ุฅุถุงูุฉ ูุคุดุฑุงุช ุจุตุฑูุฉ ููุญูุธ
function addSaveIndicators(element, status = 'saving') {
    if (!element) return;

    const indicators = {
        saving: {
            icon: 'fas fa-spinner fa-spin',
            color: '#007bff',
            text: 'ุฌุงุฑู ุงูุญูุธ...'
        },
        success: {
            icon: 'fas fa-check-circle',
            color: '#28a745',
            text: 'ุชู ุงูุญูุธ'
        },
        error: {
            icon: 'fas fa-exclamation-triangle',
            color: '#dc3545',
            text: 'ุฎุทุฃ ูู ุงูุญูุธ'
        }
    };

    const indicator = indicators[status];
    if (!indicator) return;

    // ุฅุถุงูุฉ ุฃู ุชุญุฏูุซ ูุคุดุฑ ุงูุญูุธ
    let saveIndicator = element.querySelector('.save-indicator');
    if (!saveIndicator) {
        saveIndicator = document.createElement('div');
        saveIndicator.className = 'save-indicator';
        saveIndicator.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: white;
            z-index: 1000;
        `;
        element.style.position = 'relative';
        element.appendChild(saveIndicator);
    }

    saveIndicator.innerHTML = `<i class="${indicator.icon}"></i> ${indicator.text}`;
    saveIndicator.style.backgroundColor = indicator.color;

    // ุฅุฒุงูุฉ ุงููุคุดุฑ ุจุนุฏ ูุชุฑุฉ (ูููุฌุงุญ ูุงูุฎุทุฃ)
    if (status !== 'saving') {
        setTimeout(() => {
            if (saveIndicator && saveIndicator.parentNode) {
                saveIndicator.remove();
            }
        }, 3000);
    }
}

// ===== ููุงูุฉ ูุธุงุฆู ูุณุงุนุฏุฉ ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู =====

// ===== ุงุฎุชุจุงุฑ ุดุงูู ููุญู ุงูููุงุฆู =====

// ุงุฎุชุจุงุฑ ุดุงูู ูุญู ูุดููุฉ ุญูุธ ุงูุนูุงุฑุงุช
async function testPropertySavingSolution() {
    console.log('๐งช ุจุฏุก ุงูุงุฎุชุจุงุฑ ุงูุดุงูู ูุญู ูุดููุฉ ุญูุธ ุงูุนูุงุฑุงุช...');

    const testResults = {
        databaseConnection: false,
        tableStructure: false,
        propertyInsert: false,
        propertyUpdate: false,
        propertyDelete: false,
        saveFunction: false,
        errorHandling: false,
        userInterface: false,
        overallSuccess: false,
        errors: []
    };

    try {
        // 1. ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
        console.log('๐ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช...');
        try {
            const connectionTest = await checkSupabaseConnection();
            testResults.databaseConnection = connectionTest.connected;

            if (!testResults.databaseConnection) {
                testResults.errors.push('ูุดู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช');
                throw new Error(connectionTest.error);
            }

            console.log('โ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนูู');
        } catch (connError) {
            testResults.errors.push(`ุฎุทุฃ ุงูุงุชุตุงู: ${connError.message}`);
            console.error('โ ูุดู ุงุฎุชุจุงุฑ ุงูุงุชุตุงู:', connError);
        }

        // 2. ุงุฎุชุจุงุฑ ูููู ุงูุฌุฏูู
        console.log('๐๏ธ ุงุฎุชุจุงุฑ ูููู ุฌุฏูู properties...');
        try {
            const { data, error } = await supabaseClient
                .from('properties')
                .select('id, property_name, city, unit_number, tenant_name, last_update')
                .limit(1);

            testResults.tableStructure = !error;

            if (error) {
                testResults.errors.push(`ุฎุทุฃ ูููู ุงูุฌุฏูู: ${error.message}`);
                throw error;
            }

            console.log('โ ูููู ุงูุฌุฏูู ุตุญูุญ');
        } catch (structError) {
            testResults.errors.push(`ุฎุทุฃ ูู ูููู ุงูุฌุฏูู: ${structError.message}`);
            console.error('โ ูุดู ุงุฎุชุจุงุฑ ูููู ุงูุฌุฏูู:', structError);
        }

        // 3. ุงุฎุชุจุงุฑ ุฅุฏุฑุงุฌ ุนูุงุฑ ุฌุฏูุฏ
        console.log('โ ุงุฎุชุจุงุฑ ุฅุฏุฑุงุฌ ุนูุงุฑ ุฌุฏูุฏ...');
        const testPropertyId = generateUUID();
        const testProperty = {
            id: testPropertyId,
            property_name: 'ุนูุงุฑ ุงุฎุชุจุงุฑ ุงูุญู',
            city: 'ุงูุฑูุงุถ',
            unit_number: 'TEST_SOLUTION_001',
            tenant_name: 'ูุณุชุฃุฌุฑ ุงุฎุชุจุงุฑ',
            contract_number: 'TEST_C001',
            rent_value: 3000,
            total_amount: 36000,
            contract_type: 'ุณููู',
            last_update: new Date().toLocaleDateString('ar-SA'),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        try {
            const { data: insertData, error: insertError } = await supabaseClient
                .from('properties')
                .insert([testProperty]);

            testResults.propertyInsert = !insertError;

            if (insertError) {
                testResults.errors.push(`ุฎุทุฃ ุงูุฅุฏุฑุงุฌ: ${insertError.message}`);
                throw insertError;
            }

            console.log('โ ุฅุฏุฑุงุฌ ุงูุนูุงุฑ ูุฌุญ');
        } catch (insertErr) {
            testResults.errors.push(`ูุดู ุงูุฅุฏุฑุงุฌ: ${insertErr.message}`);
            console.error('โ ูุดู ุงุฎุชุจุงุฑ ุงูุฅุฏุฑุงุฌ:', insertErr);
        }

        // 4. ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุงูุนูุงุฑ
        console.log('โ๏ธ ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุงูุนูุงุฑ...');
        try {
            const { data: updateData, error: updateError } = await supabaseClient
                .from('properties')
                .update({
                    tenant_name: 'ูุณุชุฃุฌุฑ ูุญุฏุซ',
                    rent_value: 3500,
                    last_update: new Date().toLocaleDateString('ar-SA'),
                    updated_at: new Date().toISOString()
                })
                .eq('id', testPropertyId);

            testResults.propertyUpdate = !updateError;

            if (updateError) {
                testResults.errors.push(`ุฎุทุฃ ุงูุชุญุฏูุซ: ${updateError.message}`);
                throw updateError;
            }

            console.log('โ ุชุญุฏูุซ ุงูุนูุงุฑ ูุฌุญ');
        } catch (updateErr) {
            testResults.errors.push(`ูุดู ุงูุชุญุฏูุซ: ${updateErr.message}`);
            console.error('โ ูุดู ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ:', updateErr);
        }

        // 5. ุงุฎุชุจุงุฑ ูุธููุฉ ุงูุญูุธ ุงููุจุงุดุฑ
        console.log('๐พ ุงุฎุชุจุงุฑ ูุธููุฉ ุงูุญูุธ ุงููุจุงุดุฑ...');
        try {
            const testPropertyForSave = {
                'ุงุณู ุงูุนูุงุฑ': 'ุนูุงุฑ ุงุฎุชุจุงุฑ ุงูุญูุธ',
                'ุงููุฏููุฉ': '',
                'ุฑูู  ุงููุญุฏุฉ ': 'SAVE_TEST_001',
                'ุงุณู ุงููุณุชุฃุฌุฑ': 'ูุณุชุฃุฌุฑ ุญูุธ',
                'ุฑูู ุงูุนูุฏ': 'SAVE_C001',
                'ูููุฉ  ุงูุงูุฌุงุฑ ': 4000,
                'ุงูุงุฌูุงูู': 48000,
                'ููุน ุงูุนูุฏ': 'ุชุฌุงุฑู'
            };

            const saveResult = await savePropertiesDirectlyToSupabase([testPropertyForSave]);
            testResults.saveFunction = saveResult.success;

            if (!saveResult.success) {
                testResults.errors.push(`ุฎุทุฃ ูุธููุฉ ุงูุญูุธ: ${saveResult.error || saveResult.message}`);
                throw new Error(saveResult.error || saveResult.message);
            }

            console.log('โ ูุธููุฉ ุงูุญูุธ ุงููุจุงุดุฑ ุชุนูู');
        } catch (saveErr) {
            testResults.errors.push(`ูุดู ูุธููุฉ ุงูุญูุธ: ${saveErr.message}`);
            console.error('โ ูุดู ุงุฎุชุจุงุฑ ูุธููุฉ ุงูุญูุธ:', saveErr);
        }

        // 6. ุงุฎุชุจุงุฑ ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
        console.log('๐๏ธ ุชูุธูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ...');
        try {
            const { data: deleteData, error: deleteError } = await supabaseClient
                .from('properties')
                .delete()
                .in('unit_number', ['TEST_SOLUTION_001', 'SAVE_TEST_001']);

            testResults.propertyDelete = !deleteError;

            if (deleteError) {
                console.warn('โ๏ธ ุชุญุฐูุฑ ูู ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ:', deleteError);
            } else {
                console.log('โ ุชู ุชูุธูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ');
            }
        } catch (deleteErr) {
            console.warn('โ๏ธ ูู ูุชู ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ:', deleteErr);
        }

        // 7. ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
        console.log('๐ก๏ธ ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก...');
        try {
            // ูุญุงููุฉ ุฅุฏุฑุงุฌ ุจูุงูุงุช ุฎุงุทุฆุฉ ูุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
            const invalidProperty = {
                id: null, // ูุนุฑู ุฎุงุทุฆ
                property_name: null, // ุงุณู ุฎุงุทุฆ
                city: '',
                unit_number: ''
            };

            const errorTestResult = await savePropertiesDirectlyToSupabase([invalidProperty]);

            // ุฅุฐุง ูุฌุญ ุงูุญูุธ ุฑุบู ุงูุจูุงูุงุช ุงูุฎุงุทุฆุฉุ ููุฐุง ูุนูู ุฃู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุชุนูู
            testResults.errorHandling = true;
            console.log('โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุชุนูู ุจุดูู ุตุญูุญ');

        } catch (errorTestErr) {
            // ุฅุฐุง ูุดู ุจุดูู ุตุญูุญุ ููุฐุง ุฌูุฏ ุฃูุถุงู
            testResults.errorHandling = true;
            console.log('โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุชุนูู (ูุดู ูุชููุน)');
        }

        // 8. ุงุฎุชุจุงุฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู
        console.log('๐จ ุงุฎุชุจุงุฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู...');
        try {
            // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ ุงููุทููุจุฉ
            const saveButtons = document.querySelectorAll('[onclick*="savePropertyChanges"]');
            const editButtons = document.querySelectorAll('[onclick*="editProperty"]');

            testResults.userInterface = saveButtons.length > 0 && editButtons.length > 0;

            if (testResults.userInterface) {
                console.log('โ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุชุญุชูู ุนูู ุงูุฃุฒุฑุงุฑ ุงููุทููุจุฉ');
            } else {
                testResults.errors.push('ูุงุฌูุฉ ุงููุณุชุฎุฏู ูุง ุชุญุชูู ุนูู ุงูุฃุฒุฑุงุฑ ุงููุทููุจุฉ');
                console.warn('โ๏ธ ูุงุฌูุฉ ุงููุณุชุฎุฏู ูุฏ ุชุญุชุงุฌ ุฅูู ุชุญุฏูุซ');
            }
        } catch (uiErr) {
            testResults.errors.push(`ุฎุทุฃ ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู: ${uiErr.message}`);
            console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู:', uiErr);
        }

    } catch (generalError) {
        testResults.errors.push(`ุฎุทุฃ ุนุงู: ${generalError.message}`);
        console.error('โ ุฎุทุฃ ุนุงู ูู ุงูุงุฎุชุจุงุฑ:', generalError);
    }

    // ุชูููู ุงููุชุงุฆุฌ ุงูุฅุฌูุงููุฉ
    const criticalTests = [
        testResults.databaseConnection,
        testResults.tableStructure,
        testResults.propertyInsert,
        testResults.propertyUpdate,
        testResults.saveFunction
    ];

    testResults.overallSuccess = criticalTests.every(test => test === true);

    // ุนุฑุถ ุงููุชุงุฆุฌ
    console.log('๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงูุดุงูู:', testResults);

    if (testResults.overallSuccess) {
        console.log('๐ ุชู ุญู ุฌููุน ูุดุงูู ุญูุธ ุงูุนูุงุฑุงุช ุจูุฌุงุญ!');
        console.log('๐ ุงูุญู ุงูููุงุฆู ูุนูู ุจุดูู ูุซุงูู!');

        // ุนุฑุถ ููุฎุต ุงููุฌุงุญ ูู ุงููููุณูู ููุท
        setTimeout(() => {
            console.log(`
                โ ุชู ุญู ุฌููุน ุงููุดุงูู ุจูุฌุงุญ!

                ๐ง ุงููุดุงูู ุงูุชู ุชู ุญููุง:
                โข ุฅุตูุงุญ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                โข ุญู ูุดููุฉ ุงูููุชุงุญ ุงูููุฑุฑ
                โข ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ ุงูููููุฏุฉ
                โข ุชุญุณูู ูุธุงุฆู ุงูุญูุธ
                โข ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก
                โข ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

                ๐ฏ ุงููุชุงุฆุฌ:
                โข ุญูุธ ุงูุนูุงุฑุงุช: ูุนูู โ
                โข ุชุญุฏูุซ ุงูุนูุงุฑุงุช: ูุนูู โ
                โข ูุฒุงููุฉ ุงูุณุญุงุจุฉ: ุชุนูู โ
                โข ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก: ุชุนูู โ

                ๐ก ููููู ุงูุขู ุชุญุฑูุฑ ุงูุนูุงุฑุงุช ุจุซูุฉ!
            `);
        }, 2000);

    } else {
        const failedTests = [];
        if (!testResults.databaseConnection) failedTests.push('ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช');
        if (!testResults.tableStructure) failedTests.push('ูููู ุงูุฌุฏูู');
        if (!testResults.propertyInsert) failedTests.push('ุฅุฏุฑุงุฌ ุงูุนูุงุฑุงุช');
        if (!testResults.propertyUpdate) failedTests.push('ุชุญุฏูุซ ุงูุนูุงุฑุงุช');
        if (!testResults.saveFunction) failedTests.push('ูุธููุฉ ุงูุญูุธ');

        showToast(`โ ูุดู ูู: ${failedTests.join(', ')}`, 'error');
        console.error('โ ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุดูุช:', failedTests);

        // ุนุฑุถ ุชูุงุตูู ุงูุฃุฎุทุงุก ูู ุงููููุณูู ููุท
        if (testResults.errors.length > 0) {
            setTimeout(() => {
                console.error(`
                    โ ุชูุงุตูู ุงูุฃุฎุทุงุก:

                    ${testResults.errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}

                    ๐ง ูุฑุฌู ูุฑุงุฌุนุฉ ูุฐู ุงููุดุงูู ูุฅุนุงุฏุฉ ุงููุญุงููุฉ.
                `);
            }, 1000);
        }
    }

    return testResults;
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.testPropertySavingSolution = testPropertySavingSolution;

// ุชุดุบูู ุงูุงุฎุชุจุงุฑ ูุฏููุงู ููุท
// ูููู ุงุณุชุฏุนุงุคู ูู ุงููููุณูู: testPropertySavingSolution()

// ===== ููุงูุฉ ุงุฎุชุจุงุฑ ุดุงูู ููุญู ุงูููุงุฆู =====

// ===== ุงุฎุชุจุงุฑ ุณุฑูุน ูุฅุตูุงุญ ูุดููุฉ UUID =====

// ุงุฎุชุจุงุฑ ุณุฑูุน ููุชุฃูุฏ ูู ุฅุตูุงุญ ูุดููุฉ UUID
function testUUIDFix() {
    console.log('๐ง ุงุฎุชุจุงุฑ ุฅุตูุงุญ ูุดููุฉ UUID...');

    try {
        // ุงุฎุชุจุงุฑ ุฅูุดุงุก UUID
        const uuid1 = generateUUID();
        const uuid2 = generateUUID();
        const simpleId1 = generateSimpleId('test');
        const simpleId2 = generateSimpleId('test');

        console.log('UUID 1:', uuid1);
        console.log('UUID 2:', uuid2);
        console.log('Simple ID 1:', simpleId1);
        console.log('Simple ID 2:', simpleId2);

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุชูุณูู
        const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        const isUuid1Valid = uuidPattern.test(uuid1);
        const isUuid2Valid = uuidPattern.test(uuid2);

        console.log('UUID 1 ุตุญูุญ:', isUuid1Valid);
        console.log('UUID 2 ุตุญูุญ:', isUuid2Valid);
        console.log('UUID ูุฎุชููุงู:', uuid1 !== uuid2);
        console.log('Simple ID ูุฎุชููุงู:', simpleId1 !== simpleId2);

        // ุงุฎุชุจุงุฑ ุชูุธูู ุงูุจูุงูุงุช
        const testData = [
            {
                'ุงุณู ุงูุนูุงุฑ': 'ุนูุงุฑ ุงุฎุชุจุงุฑ',
                'ุงููุฏููุฉ': 'ุงูุฑูุงุถ',
                'ุฑูู  ุงููุญุฏุฉ ': '001'
            },
            {
                'ุงุณู ุงูุนูุงุฑ': '',
                'ุงููุฏููุฉ': '',
                'ุฑูู  ุงููุญุฏุฉ ': ''
            }
        ];

        const cleanedData = sanitizeDataForSave(testData);
        console.log('ุงูุจูุงูุงุช ุงูุฃุตููุฉ:', testData);
        console.log('ุงูุจูุงูุงุช ุงูููุธูุฉ:', cleanedData);

        const success = isUuid1Valid && isUuid2Valid && uuid1 !== uuid2 && cleanedData.length === 2;

        if (success) {
            console.log('โ ุชู ุฅุตูุงุญ ูุดููุฉ UUID ุจูุฌุงุญ!');
            console.log('โ ุฌููุน ุงุฎุชุจุงุฑุงุช UUID ูุฌุญุช');
        } else {
            console.error('โ ูุงุฒุงูุช ููุงู ูุดููุฉ ูู UUID');
            console.error('โ ุจุนุถ ุงุฎุชุจุงุฑุงุช UUID ูุดูุช');
        }

        return success;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ UUID:', error);
        showToast(`โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ UUID: ${error.message}`, 'error');
        return false;
    }
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.testUUIDFix = testUUIDFix;

// ุชุดุบูู ุงูุงุฎุชุจุงุฑ ูุฏููุงู ููุท
// ูููู ุงุณุชุฏุนุงุคู ูู ุงููููุณูู: testUUIDFix()

// ===== ููุงูุฉ ุงุฎุชุจุงุฑ ุณุฑูุน ูุฅุตูุงุญ ูุดููุฉ UUID =====

// ===== ุฅุตูุงุญ ุญุณุงุจ ุนุฏุฏ ุงููุญุฏุงุช =====

// ูุธููุฉ ูุญุณุงุจ ุนุฏุฏ ุงููุญุฏุงุช ุงูุตุญูุญ
function calculateCorrectUnitsCount(data) {
    if (!data || !Array.isArray(data)) {
        return 0;
    }

    // ุฅูุดุงุก ูุฌููุนุฉ ูููุญุฏุงุช ุงููุฑูุฏุฉ
    const uniqueUnits = new Set();

    data.forEach(property => {
        // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงุณู ุงูุนูุงุฑ ูุฑูู ุงููุญุฏุฉ
        const propertyName = property['ุงุณู ุงูุนูุงุฑ'];
        const unitNumber = property['ุฑูู  ุงููุญุฏุฉ '];

        if (propertyName && unitNumber &&
            propertyName.toString().trim() !== '' &&
            unitNumber.toString().trim() !== '') {

            // ุฅูุดุงุก ููุชุงุญ ูุฑูุฏ ูููุญุฏุฉ
            const unitKey = `${propertyName.trim()}_${unitNumber.toString().trim()}`;
            uniqueUnits.add(unitKey);
        }
    });

    return uniqueUnits.size;
}

// ูุธููุฉ ูุญุณุงุจ ุนุฏุฏ ุงููุณุชุฃุฌุฑูู ุงูุตุญูุญ
function calculateCorrectTenantsCount(data) {
    if (!data || !Array.isArray(data)) {
        return 0;
    }

    // ุชุฌููุน ุงูุนููุฏ ุงููุฑูุฏุฉ
    const uniqueContracts = new Set();

    data.forEach(property => {
        const tenantName = property['ุงุณู ุงููุณุชุฃุฌุฑ'];
        const contractNumber = property['ุฑูู ุงูุนูุฏ'];

        // ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุณุชุฃุฌุฑ ูุนูุฏ
        if (tenantName && contractNumber &&
            tenantName.toString().trim() !== '' &&
            contractNumber.toString().trim() !== '') {

            // ุงุณุชุฎุฏุงู ุฑูู ุงูุนูุฏ ูููุชุงุญ ูุฑูุฏ
            uniqueContracts.add(contractNumber.toString().trim());
        }
    });

    return uniqueContracts.size;
}

// ูุธููุฉ ูุญุณุงุจ ุงููุญุฏุงุช ุงููุงุฑุบุฉ ุงูุตุญูุญ
function calculateCorrectEmptyUnitsCount(data) {
    if (!data || !Array.isArray(data)) {
        return 0;
    }

    const uniqueEmptyUnits = new Set();

    data.forEach(property => {
        const propertyName = property['ุงุณู ุงูุนูุงุฑ'];
        const unitNumber = property['ุฑูู  ุงููุญุฏุฉ '];
        const tenantName = property['ุงุณู ุงููุณุชุฃุฌุฑ'];

        // ุงูุชุฃูุฏ ูู ุฃู ุงููุญุฏุฉ ููุฌูุฏุฉ ูููู ูุงุฑุบุฉ
        if (propertyName && unitNumber &&
            propertyName.toString().trim() !== '' &&
            unitNumber.toString().trim() !== '' &&
            (!tenantName || tenantName.toString().trim() === '')) {

            const unitKey = `${propertyName.trim()}_${unitNumber.toString().trim()}`;
            uniqueEmptyUnits.add(unitKey);
        }
    });

    return uniqueEmptyUnits.size;
}

// ูุธููุฉ ูุงุฎุชุจุงุฑ ุฏูุฉ ุญุณุงุจ ุงููุญุฏุงุช
function testUnitsCountAccuracy() {
    console.log('๐งฎ ุงุฎุชุจุงุฑ ุฏูุฉ ุญุณุงุจ ุนุฏุฏ ุงููุญุฏุงุช...');

    if (!properties || !Array.isArray(properties)) {
        console.error('โ ุงูุจูุงูุงุช ุบูุฑ ูุชููุฑุฉ ููุงุฎุชุจุงุฑ');
        return false;
    }

    const totalUnitsOld = properties.length;
    const totalUnitsNew = calculateCorrectUnitsCount(properties);
    const tenantsCountNew = calculateCorrectTenantsCount(properties);
    const emptyUnitsNew = calculateCorrectEmptyUnitsCount(properties);

    console.log('๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ:');
    console.log(`   ุงูุนุฏุฏ ุงููุฏูู (data.length): ${totalUnitsOld}`);
    console.log(`   ุงูุนุฏุฏ ุงูุฌุฏูุฏ (ูุฑูุฏ): ${totalUnitsNew}`);
    console.log(`   ุนุฏุฏ ุงููุณุชุฃุฌุฑูู: ${tenantsCountNew}`);
    console.log(`   ุงููุญุฏุงุช ุงููุงุฑุบุฉ: ${emptyUnitsNew}`);
    console.log(`   ุงููุญุฏุงุช ุงููุคุฌุฑุฉ: ${totalUnitsNew - emptyUnitsNew}`);

    // ุงูุชุญูู ูู ุงูููุทู
    const isLogical = (tenantsCountNew + emptyUnitsNew) <= totalUnitsNew;

    if (isLogical) {
        console.log('โ ุงูุญุณุงุจุงุช ููุทููุฉ ูุฏูููุฉ');
        console.log(`โ ุชู ุฅุตูุงุญ ุญุณุงุจ ุงููุญุฏุงุช: ${totalUnitsNew} ูุญุฏุฉ ูุฑูุฏุฉ`);
    } else {
        console.warn('โ๏ธ ููุงู ุฎุทุฃ ูู ุงูููุทู');
        console.warn('โ๏ธ ููุงู ุฎุทุฃ ูู ุญุณุงุจ ุงููุญุฏุงุช');
    }

    return isLogical;
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.testUnitsCountAccuracy = testUnitsCountAccuracy;
window.calculateCorrectUnitsCount = calculateCorrectUnitsCount;

// ุชุดุบูู ุงูุงุฎุชุจุงุฑ ูุฏููุงู ููุท
// ูููู ุงุณุชุฏุนุงุคู ูู ุงููููุณูู: testUnitsCountAccuracy()

// ูุธููุฉ ูุฅุตูุงุญ ุงูุฅุญุตุงุฆูุงุช ููุฑุงู
function fixStatisticsNow() {
    console.log('๐ง ุฅุตูุงุญ ุงูุฅุญุตุงุฆูุงุช ููุฑุงู...');

    try {
        // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุจูุงูุงุช
        if (!properties || !Array.isArray(properties)) {
            console.warn('โ๏ธ ุงูุจูุงูุงุช ุบูุฑ ูุชููุฑุฉ');
            showToast('โ๏ธ ุงูุจูุงูุงุช ุบูุฑ ูุชููุฑุฉ', 'warning');
            return false;
        }

        // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
        const correctUnitsCount = calculateCorrectUnitsCount(properties);
        const correctTenantsCount = calculateCorrectTenantsCount(properties);
        const correctEmptyUnitsCount = calculateCorrectEmptyUnitsCount(properties);

        console.log('๐ ุงูุฅุญุตุงุฆูุงุช ุงููุตุญุญุฉ:');
        console.log(`   ุฅุฌูุงูู ุงููุญุฏุงุช: ${correctUnitsCount}`);
        console.log(`   ุนุฏุฏ ุงููุณุชุฃุฌุฑูู: ${correctTenantsCount}`);
        console.log(`   ุงููุญุฏุงุช ุงููุงุฑุบุฉ: ${correctEmptyUnitsCount}`);
        console.log(`   ุงููุญุฏุงุช ุงููุคุฌุฑุฉ: ${correctUnitsCount - correctEmptyUnitsCount}`);

        // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
        updateStatisticsAfterSave();

        console.log(`โ ุชู ุฅุตูุงุญ ุงูุฅุญุตุงุฆูุงุช: ${correctUnitsCount} ูุญุฏุฉ`);

        return true;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุตูุงุญ ุงูุฅุญุตุงุฆูุงุช:', error);
        showToast(`โ ุฎุทุฃ ูู ุฅุตูุงุญ ุงูุฅุญุตุงุฆูุงุช: ${error.message}`, 'error');
        return false;
    }
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.fixStatisticsNow = fixStatisticsNow;

// ===== ููุงูุฉ ุฅุตูุงุญ ุญุณุงุจ ุนุฏุฏ ุงููุญุฏุงุช =====

// ===== ุงุฎุชุจุงุฑ ุณุฑูุน ููุงุฆู ูุฅุตูุงุญ ุงููุดููุฉ =====

// ุงุฎุชุจุงุฑ ุณุฑูุน ููุชุฃูุฏ ูู ุฅุตูุงุญ ูุดููุฉ Supabase
async function finalSupabaseFixTest() {
    console.log('๐งช ุงุฎุชุจุงุฑ ููุงุฆู ูุฅุตูุงุญ ูุดููุฉ Supabase...');

    const results = {
        connection: false,
        tableStructure: false,
        canInsert: false,
        canUpdate: false,
        canDelete: false,
        propertyEditWorks: false,
        error: null
    };

    try {
        // 1. ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
        console.log('๐ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู...');
        const connectionTest = await checkSupabaseConnection();
        results.connection = connectionTest.connected;

        if (!results.connection) {
            results.error = connectionTest.error;
            return results;
        }

        // 2. ุงุฎุชุจุงุฑ ูููู ุงูุฌุฏูู
        console.log('๐๏ธ ุงุฎุชุจุงุฑ ูููู ุงูุฌุฏูู...');
        try {
            const { data, error } = await supabaseClient
                .from('properties')
                .select('id, property_name, city, unit_number')
                .limit(1);

            results.tableStructure = !error;

            if (error) {
                console.error('โ ุฎุทุฃ ูู ูููู ุงูุฌุฏูู:', error);
                results.error = error.message;
                return results;
            }
        } catch (structureError) {
            console.error('โ ุฎุทุฃ ูู ูุญุต ูููู ุงูุฌุฏูู:', structureError);
            results.error = structureError.message;
            return results;
        }

        // 3. ุงุฎุชุจุงุฑ ุงูุฅุฏุฑุงุฌ
        console.log('โ ุงุฎุชุจุงุฑ ุงูุฅุฏุฑุงุฌ...');
        const testId = crypto.randomUUID();
        const testData = {
            id: testId,
            property_name: 'ุงุฎุชุจุงุฑ ุฅุตูุงุญ',
            city: 'ุงูุฑูุงุถ',
            unit_number: 'FIX_TEST_001',
            tenant_name: 'ูุณุชุฃุฌุฑ ุงุฎุชุจุงุฑ',
            contract_number: 'FIX_C001',
            rent_value: 1000,
            total_amount: 12000,
            contract_type: 'ุณููู',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        try {
            const { data: insertData, error: insertError } = await supabaseClient
                .from('properties')
                .insert([testData]);

            results.canInsert = !insertError;

            if (insertError) {
                console.error('โ ุฎุทุฃ ูู ุงูุฅุฏุฑุงุฌ:', insertError);
                results.error = insertError.message;
                return results;
            }

            console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุงูุฅุฏุฑุงุฌ');

        } catch (insertErr) {
            console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุงูุฅุฏุฑุงุฌ:', insertErr);
            results.error = insertErr.message;
            return results;
        }

        // 4. ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ
        console.log('โ๏ธ ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ...');
        try {
            const { data: updateData, error: updateError } = await supabaseClient
                .from('properties')
                .update({
                    tenant_name: 'ูุณุชุฃุฌุฑ ูุญุฏุซ',
                    rent_value: 1500,
                    updated_at: new Date().toISOString()
                })
                .eq('id', testId);

            results.canUpdate = !updateError;

            if (updateError) {
                console.error('โ ุฎุทุฃ ูู ุงูุชุญุฏูุซ:', updateError);
                results.error = updateError.message;
            } else {
                console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ');
            }

        } catch (updateErr) {
            console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ:', updateErr);
            results.error = updateErr.message;
        }

        // 5. ุงุฎุชุจุงุฑ ุงูุญุฐู
        console.log('๐๏ธ ุงุฎุชุจุงุฑ ุงูุญุฐู...');
        try {
            const { data: deleteData, error: deleteError } = await supabaseClient
                .from('properties')
                .delete()
                .eq('id', testId);

            results.canDelete = !deleteError;

            if (deleteError) {
                console.error('โ ุฎุทุฃ ูู ุงูุญุฐู:', deleteError);
                results.error = deleteError.message;
            } else {
                console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุงูุญุฐู');
            }

        } catch (deleteErr) {
            console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุงูุญุฐู:', deleteErr);
            results.error = deleteErr.message;
        }

        // 6. ุงุฎุชุจุงุฑ ูุธููุฉ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช
        console.log('๐ ุงุฎุชุจุงุฑ ูุธููุฉ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช...');
        try {
            if (properties && properties.length > 0) {
                const testProperty = properties[0];
                const originalValue = testProperty['ุงููุงูู'];
                const testValue = 'ูุงูู ุงุฎุชุจุงุฑ - ' + Date.now();

                // ุชุญุฏูุซ ูุญูู
                testProperty['ุงููุงูู'] = testValue;

                // ุงุฎุชุจุงุฑ ุงูุญูุธ ูู Supabase
                const saveResult = await savePropertiesDirectlyToSupabase([testProperty]);
                results.propertyEditWorks = saveResult.success;

                // ุฅุนุงุฏุฉ ุงููููุฉ ุงูุฃุตููุฉ
                testProperty['ุงููุงูู'] = originalValue;

                if (results.propertyEditWorks) {
                    console.log('โ ูุฌุญ ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช');
                } else {
                    console.error('โ ูุดู ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช');
                }
            } else {
                console.warn('โ๏ธ ูุง ุชูุฌุฏ ุนูุงุฑุงุช ูุงุฎุชุจุงุฑ ุงูุชุญุฑูุฑ');
                results.propertyEditWorks = true; // ููุชุฑุถ ุฃูู ูุนูู
            }

        } catch (editErr) {
            console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุชุญุฑูุฑ ุงูุนูุงุฑุงุช:', editErr);
            results.error = editErr.message;
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ุนุงู ูู ุงูุงุฎุชุจุงุฑ:', error);
        results.error = error.message;
    }

    // ุนุฑุถ ุงููุชุงุฆุฌ
    console.log('๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู:', results);

    const allTestsPassed = results.connection &&
                          results.tableStructure &&
                          results.canInsert &&
                          results.canUpdate &&
                          results.canDelete &&
                          results.propertyEditWorks;

    if (allTestsPassed) {
        console.log('๐ ุชู ุฅุตูุงุญ ุฌููุน ูุดุงูู Supabase ุจูุฌุงุญ!');
        console.log('๐ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช - ุงููุดููุฉ ุชู ุญููุง!');
    } else {
        const failedTests = [];
        if (!results.connection) failedTests.push('ุงูุงุชุตุงู');
        if (!results.tableStructure) failedTests.push('ูููู ุงูุฌุฏูู');
        if (!results.canInsert) failedTests.push('ุงูุฅุฏุฑุงุฌ');
        if (!results.canUpdate) failedTests.push('ุงูุชุญุฏูุซ');
        if (!results.canDelete) failedTests.push('ุงูุญุฐู');
        if (!results.propertyEditWorks) failedTests.push('ุชุญุฑูุฑ ุงูุนูุงุฑุงุช');

        showToast(`โ ูุดู ูู: ${failedTests.join(', ')}`, 'error');
        console.error('โ ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุดูุช:', failedTests);
    }

    return results;
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.finalSupabaseFixTest = finalSupabaseFixTest;

// ุชุดุบูู ุงูุงุฎุชุจุงุฑ ูุฏููุงู ููุท
// ูููู ุงุณุชุฏุนุงุคู ูู ุงููููุณูู: finalSupabaseFixTest()

// ===== ููุงูุฉ ุงุฎุชุจุงุฑ ุณุฑูุน ููุงุฆู ูุฅุตูุงุญ ุงููุดููุฉ =====

// ===== ุงุฎุชุจุงุฑ ุณุฑูุน ูุฅุตูุงุญ ูุดููุฉ Supabase =====

// ุงุฎุชุจุงุฑ ุณุฑูุน ููุชุญูู ูู ุฅุตูุงุญ ูุดููุฉ ุงูุฌุฏูู
async function quickSupabaseTest() {
    console.log('๐งช ุงุฎุชุจุงุฑ ุณุฑูุน ูู Supabase...');

    const results = {
        connection: false,
        tableExists: false,
        canInsert: false,
        canQuery: false,
        error: null
    };

    try {
        // ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
        const connectionTest = await checkSupabaseConnection();
        results.connection = connectionTest.connected;

        if (!results.connection) {
            results.error = connectionTest.error;
            return results;
        }

        console.log('โ ุงูุงุชุตุงู ุจู Supabase ูุนูู');

        // ุงุฎุชุจุงุฑ ูุฌูุฏ ุงูุฌุฏูู
        try {
            const { data, error } = await supabaseClient
                .from('properties')
                .select('id')
                .limit(1);

            results.tableExists = !error;
            results.canQuery = !error;

            if (error && error.message.includes('does not exist')) {
                console.log('โ๏ธ ุฌุฏูู properties ุบูุฑ ููุฌูุฏุ ุณูุชู ุฅูุดุงุคู...');

                // ูุญุงููุฉ ุฅูุดุงุก ุงูุฌุฏูู
                await createPropertiesTableIfNotExists();

                // ุงุฎุชุจุงุฑ ุงูุฅุฏุฑุงุฌ
                const testData = {
                    id: 'test_' + Date.now(),
                    property_name: 'ุงุฎุชุจุงุฑ',
                    city: 'ุงูุฑูุงุถ',
                    unit_number: 'TEST_001',
                    raw_data: { test: true },
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                const { data: insertData, error: insertError } = await supabaseClient
                    .from('properties')
                    .insert([testData]);

                if (!insertError) {
                    results.canInsert = true;
                    results.tableExists = true;

                    // ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
                    await supabaseClient
                        .from('properties')
                        .delete()
                        .eq('id', testData.id);

                    console.log('โ ุชู ุฅูุดุงุก ุงูุฌุฏูู ูุงุฎุชุจุงุฑ ุงูุฅุฏุฑุงุฌ ุจูุฌุงุญ');
                } else {
                    console.error('โ ูุดู ูู ุงุฎุชุจุงุฑ ุงูุฅุฏุฑุงุฌ:', insertError);
                    results.error = insertError.message;
                }
            } else if (error) {
                console.error('โ ุฎุทุฃ ูู ุงูุงุณุชุนูุงู:', error);
                results.error = error.message;
            } else {
                console.log('โ ุฌุฏูู properties ููุฌูุฏ ููุนูู');
                results.tableExists = true;
                results.canQuery = true;
                results.canInsert = true; // ููุชุฑุถ ุฃูู ูุนูู ุฅุฐุง ูุงู ุงูุงุณุชุนูุงู ูุนูู
            }

        } catch (tableError) {
            console.error('โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ ุงูุฌุฏูู:', tableError);
            results.error = tableError.message;
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน:', error);
        results.error = error.message;
    }

    // ุนุฑุถ ุงููุชุงุฆุฌ
    console.log('๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน:', results);

    const success = results.connection && results.tableExists && results.canInsert;

    if (success) {
        showToast('โ Supabase ูุนูู ุจุดูู ุตุญูุญ ุงูุขู!', 'success');
    } else {
        showToast(`โ ูุดููุฉ ูู Supabase: ${results.error}`, 'error');
    }

    return results;
}

// ุฅุถุงูุฉ ุงููุธููุฉ ูููุญุฉ ุงูุชุญูู
window.quickSupabaseTest = quickSupabaseTest;

// ุชุดุบูู ุงูุงุฎุชุจุงุฑ ุชููุงุฆูุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        console.log('๐ ุชุดุบูู ุงุฎุชุจุงุฑ Supabase ุงูุชููุงุฆู...');
        quickSupabaseTest();
    }, 3000);
});

// ===== ููุงูุฉ ุงุฎุชุจุงุฑ ุณุฑูุน ูุฅุตูุงุญ ูุดููุฉ Supabase =====

// ุนุฑุถ ุณุฌูุงุช ุงูุชุชุจุน
function renderTrackingLogs(logs) {
    if (logs.length === 0) {
        return '<div class="no-logs">ูุง ุชูุฌุฏ ุณุฌูุงุช ุชุชุจุน</div>';
    }

    return logs.map(log => `
        <div class="change-log-entry">
            <div class="change-log-header">
                <div class="change-log-operation">${log.operationType}</div>
                <div class="change-log-timestamp">
                    <div class="timestamp-main">
                        <strong>${log.dayName || getDayName(new Date(log.timestamp))}</strong>
                    </div>
                    <div class="timestamp-dates">
                        <div class="gregorian-date">
                            <i class="fas fa-calendar"></i>
                            ${log.date} - ${log.time}
                        </div>
                        <div class="hijri-date">
                            <i class="fas fa-moon"></i>
                            ${log.hijriDate || getHijriDate(new Date(log.timestamp))}
                        </div>
                    </div>
                    <div class="timestamp-user">
                        <i class="fas fa-user"></i>
                        ${log.user}
                    </div>
                </div>
            </div>

            <div class="change-log-details">
                <div class="change-detail-item">
                    <div class="change-detail-label">ุฑูู ุงููุญุฏุฉ:</div>
                    <div class="change-detail-value">${log.unitNumber}</div>
                </div>
                <div class="change-detail-item">
                    <div class="change-detail-label">ุงุณู ุงูุนูุงุฑ:</div>
                    <div class="change-detail-value">${log.propertyName}</div>
                </div>
                <div class="change-detail-item">
                    <div class="change-detail-label">ุงููุฏููุฉ:</div>
                    <div class="change-detail-value">${log.city}</div>
                </div>
                ${log.tenantName ? `
                <div class="change-detail-item">
                    <div class="change-detail-label">ุงููุณุชุฃุฌุฑ:</div>
                    <div class="change-detail-value">${log.tenantName}</div>
                </div>` : ''}
                ${log.contractNumber ? `
                <div class="change-detail-item">
                    <div class="change-detail-label">ุฑูู ุงูุนูุฏ:</div>
                    <div class="change-detail-value">${log.contractNumber}</div>
                </div>` : ''}

                ${renderChangeDetails(log)}

                ${log.sourceProperty && log.destinationProperty ? `
                <div class="change-detail-item">
                    <div class="change-detail-label">ููู ูู:</div>
                    <div class="change-detail-value">${log.sourceProperty} โ ${log.destinationProperty}</div>
                </div>` : ''}

                ${log.reason ? `
                <div class="change-detail-item">
                    <div class="change-detail-label">ุงูุณุจุจ:</div>
                    <div class="change-detail-value">${log.reason}</div>
                </div>` : ''}
            </div>
        </div>
    `).join('');
}

// ุนุฑุถ ุชูุงุตูู ุงูุชุบููุฑุงุช
function renderChangeDetails(log) {
    if (!log.changes || Object.keys(log.changes).length === 0) {
        return '';
    }

    return Object.entries(log.changes).map(([field, change]) => `
        <div class="change-detail-item">
            <div class="change-detail-label">${change.fieldName}:</div>
            <div class="change-detail-value">
                <span class="change-detail-old">${change.old || 'ูุงุฑุบ'}</span>
                โ
                <span class="change-detail-new">${change.new || 'ูุงุฑุบ'}</span>
            </div>
        </div>
    `).join('');
}

// ููุชุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน ุงููุญุณูุฉ ูุงููุตุญุญุฉ
async function filterTrackingLogs() {
    console.log('๐ ุจุฏุก ููุชุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน...');

    const dateFilter = document.getElementById('trackingDateFilter')?.value;
    const monthFilter = document.getElementById('trackingMonthFilter')?.value;
    const operationType = document.getElementById('trackingOperationType')?.value;
    const searchTerm = document.getElementById('trackingSearch')?.value?.toLowerCase() || '';

    console.log('๐ ูุนุงููุฑ ุงูููุชุฑุฉ:', { dateFilter, monthFilter, operationType, searchTerm });

    // ุชุญููู ุฌููุน ุงูุณุฌูุงุช
    const cloudLogs = await loadChangeLogsFromSupabase(1000);
    const allLogs = [...cloudLogs, ...changeTrackingLogs];

    // ุฅุฒุงูุฉ ุงูููุฑุฑุงุช
    const uniqueLogs = allLogs.filter((log, index, self) =>
        index === self.findIndex(l => l.id === log.id)
    );

    console.log(`๐ ุฅุฌูุงูู ุงูุณุฌูุงุช ูุจู ุงูููุชุฑุฉ: ${uniqueLogs.length}`);

    // ุชุทุจูู ุงูููุงุชุฑ
    let filteredLogs = uniqueLogs.filter(log => {
        // ุงูุชุฃูุฏ ูู ูุฌูุฏ timestamp ุตุญูุญ
        if (!log.timestamp) {
            console.warn('โ๏ธ ุณุฌู ุจุฏูู timestamp:', log.id);
            return false;
        }

        const logDate = new Date(log.timestamp);

        // ููุชุฑ ุงูุชุงุฑูุฎ ุงููุญุฏุฏ
        if (dateFilter) {
            const filterDate = new Date(dateFilter);
            const logDateString = logDate.toISOString().split('T')[0];
            const filterDateString = filterDate.toISOString().split('T')[0];

            if (logDateString !== filterDateString) {
                return false;
            }
        }

        // ููุชุฑ ุงูุดูุฑ ูุงูุณูุฉ
        if (monthFilter) {
            const [filterYear, filterMonth] = monthFilter.split('-');
            const logYear = logDate.getFullYear();
            const logMonth = logDate.getMonth() + 1;

            if (logYear !== parseInt(filterYear) || logMonth !== parseInt(filterMonth)) {
                return false;
            }
        }

        // ููุชุฑ ููุน ุงูุนูููุฉ
        if (operationType && log.operationType !== operationType) {
            return false;
        }

        // ููุชุฑ ุงูุจุญุซ ุงููุญุณู
        if (searchTerm) {
            const searchFields = [
                log.unitNumber || '',
                log.propertyName || '',
                log.city || '',
                log.contractNumber || '',
                log.tenantName || '',
                log.newTenant || '',
                log.previousTenant || '',
                log.user || ''
            ];

            const matchFound = searchFields.some(field =>
                field.toString().toLowerCase().includes(searchTerm)
            );

            if (!matchFound) {
                return false;
            }
        }

        return true;
    });

    // ุชุฑุชูุจ ุญุณุจ ุงูุชุงุฑูุฎ (ุงูุฃุญุฏุซ ุฃููุงู)
    filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    console.log(`โ ุชู ุงูุนุซูุฑ ุนูู ${filteredLogs.length} ุณุฌู ุจุนุฏ ุงูููุชุฑุฉ`);

    // ุชุญุฏูุซ ุงูุนุฑุถ
    const container = document.getElementById('trackingLogsContainer');
    if (container) {
        container.innerHTML = renderTrackingLogs(filteredLogs);
    }

    // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูููุชุฑุฉ
    const resultsCount = filteredLogs.length;
    const totalCount = uniqueLogs.length;

    const statsElement = document.querySelector('.tracking-stats');
    if (statsElement) {
        if (resultsCount === totalCount) {
            statsElement.textContent = `ุฅุฌูุงูู ุงูุณุฌูุงุช: ${totalCount}`;
        } else {
            statsElement.textContent = `ุนุฑุถ ${resultsCount} ูู ุฃุตู ${totalCount} ุณุฌู`;
        }
    }

    // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฅุฐุง ูู ุชูุฌุฏ ูุชุงุฆุฌ
    if (resultsCount === 0 && (dateFilter || monthFilter || operationType || searchTerm)) {
        const container = document.getElementById('trackingLogsContainer');
        if (container) {
            container.innerHTML = `
                <div class="no-logs">
                    <i class="fas fa-search"></i>
                    <h3>ูุง ุชูุฌุฏ ูุชุงุฆุฌ</h3>
                    <p>ูู ูุชู ุงูุนุซูุฑ ุนูู ุณุฌูุงุช ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ ุงููุญุฏุฏุฉ</p>
                    <button onclick="clearTrackingFilters()" class="clear-filters-btn">
                        <i class="fas fa-times"></i> ูุณุญ ุงูููุงุชุฑ
                    </button>
                </div>
            `;
        }
    }

    console.log(`๐ ุงูุชูุช ุนูููุฉ ุงูููุชุฑุฉ: ${resultsCount}/${totalCount} ุณุฌู`);
}

// ูุณุญ ููุงุชุฑ ุงูุชุชุจุน ุงููุญุณู
function clearTrackingFilters() {
    console.log('๐งน ูุณุญ ุฌููุน ููุงุชุฑ ุงูุชุชุจุน...');

    // ูุณุญ ุฌููุน ุญููู ุงูููุชุฑุฉ
    const dateFilter = document.getElementById('trackingDateFilter');
    const monthFilter = document.getElementById('trackingMonthFilter');
    const operationType = document.getElementById('trackingOperationType');
    const searchInput = document.getElementById('trackingSearch');

    if (dateFilter) dateFilter.value = '';
    if (monthFilter) monthFilter.value = '';
    if (operationType) operationType.value = '';
    if (searchInput) searchInput.value = '';

    // ุฅุนุงุฏุฉ ุชุทุจูู ุงูููุชุฑ ูุนุฑุถ ุฌููุน ุงูุณุฌูุงุช
    filterTrackingLogs();

    // ุฅุนุงุฏุฉ ุชุนููู ุฅุญุตุงุฆูุงุช ุงูุนุฑุถ
    const statsElement = document.querySelector('.tracking-stats');
    if (statsElement) {
        // ุณูุชู ุชุญุฏูุซูุง ูู filterTrackingLogs()
    }

    console.log('โ ุชู ูุณุญ ุฌููุน ููุงุชุฑ ุงูุชุชุจุน ูุฅุนุงุฏุฉ ุนุฑุถ ุฌููุน ุงูุณุฌูุงุช');
}

// ุชุตุฏูุฑ ุณุฌูุงุช ุงูุชุชุจุน ุฅูู Excel
async function exportTrackingLogs() {
    const cloudLogs = await loadChangeLogsFromSupabase(1000);
    const allLogs = [...cloudLogs, ...changeTrackingLogs];

    // ุฅุฒุงูุฉ ุงูููุฑุฑุงุช ูุชุฑุชูุจ
    const uniqueLogs = allLogs.filter((log, index, self) =>
        index === self.findIndex(l => l.id === log.id)
    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    // ุชุญููู ุงูุจูุงูุงุช ููุชุตุฏูุฑ
    const exportData = uniqueLogs.map(log => ({
        'ุงูุชุงุฑูุฎ': log.date,
        'ุงูููุช': log.time,
        'ููุน ุงูุนูููุฉ': log.operationType,
        'ุงููุณุชุฎุฏู': log.user,
        'ุฑูู ุงููุญุฏุฉ': log.unitNumber,
        'ุงุณู ุงูุนูุงุฑ': log.propertyName,
        'ุงููุฏููุฉ': log.city,
        'ุฑูู ุงูุนูุฏ': log.contractNumber || '',
        'ุงููุณุชุฃุฌุฑ ุงูุฌุฏูุฏ': log.newTenant || '',
        'ุงููุณุชุฃุฌุฑ ุงูุณุงุจู': log.previousTenant || '',
        'ุงูุนูุงุฑ ุงููุตุฏุฑ': log.sourceProperty || '',
        'ุงูุนูุงุฑ ุงููุฌูุฉ': log.destinationProperty || '',
        'ุงูุณุจุจ': log.reason || '',
        'ุงูุชุบููุฑุงุช': Object.keys(log.changes || {}).length > 0 ?
            Object.entries(log.changes).map(([field, change]) =>
                `${change.fieldName}: ${change.old} โ ${change.new}`
            ).join('; ') : ''
    }));

    // ุฅูุดุงุก ููู Excel
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ุณุฌู ุงูุชุชุจุน');

    // ุชุญุฏูุฏ ุนุฑุถ ุงูุฃุนูุฏุฉ
    const colWidths = [
        { wch: 12 }, // ุงูุชุงุฑูุฎ
        { wch: 10 }, // ุงูููุช
        { wch: 20 }, // ููุน ุงูุนูููุฉ
        { wch: 15 }, // ุงููุณุชุฎุฏู
        { wch: 15 }, // ุฑูู ุงููุญุฏุฉ
        { wch: 25 }, // ุงุณู ุงูุนูุงุฑ
        { wch: 12 }, // ุงููุฏููุฉ
        { wch: 15 }, // ุฑูู ุงูุนูุฏ
        { wch: 25 }, // ุงููุณุชุฃุฌุฑ ุงูุฌุฏูุฏ
        { wch: 25 }, // ุงููุณุชุฃุฌุฑ ุงูุณุงุจู
        { wch: 25 }, // ุงูุนูุงุฑ ุงููุตุฏุฑ
        { wch: 25 }, // ุงูุนูุงุฑ ุงููุฌูุฉ
        { wch: 20 }, // ุงูุณุจุจ
        { wch: 50 }  // ุงูุชุบููุฑุงุช
    ];
    ws['!cols'] = colWidths;

    // ุชุญููู ุงูููู
    const fileName = `ุณุฌู_ุงูุชุชุจุน_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
    XLSX.writeFile(wb, fileName);
}

// ุทุจุงุนุฉ ุณุฌูุงุช ุงูุชุชุจุน
function printTrackingLogs() {
    const container = document.getElementById('trackingLogsContainer');
    const printWindow = window.open('', '_blank');

    printWindow.document.write(`
        <html dir="rtl">
        <head>
            <title>ุณุฌู ุชุชุจุน ุงูุชุบููุฑุงุช</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .change-log-entry {
                    border: 1px solid #ddd;
                    margin-bottom: 20px;
                    padding: 15px;
                    page-break-inside: avoid;
                }
                .change-log-header {
                    background: #f5f5f5;
                    padding: 10px;
                    margin: -15px -15px 15px -15px;
                    font-weight: bold;
                }
                .change-log-details {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 10px;
                }
                .change-detail-item {
                    background: #f9f9f9;
                    padding: 8px;
                    border-right: 3px solid #007bff;
                }
                .change-detail-label { font-weight: bold; margin-bottom: 5px; }
                .change-detail-old { color: #dc3545; text-decoration: line-through; }
                .change-detail-new { color: #28a745; font-weight: bold; }
                @media print {
                    .change-log-entry { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ุณุฌู ุชุชุจุน ุงูุชุบููุฑุงุช</h1>
                <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${new Date().toLocaleDateString('ar-SA')}</p>
            </div>
            ${container.innerHTML}
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

// ==================== ูุธุงู ุงูุตูุงุญูุงุช ====================

// ูุชุบูุฑุงุช ูุธุงู ุงูุตูุงุญูุงุช
let currentUser = null;
let userPermissions = null;

// ุจูุงูุงุช ุงููุณุชุฎุฏููู
const users = {
    'ุนูุฑ': {
        password: '159',
        role: 'admin',
        fullName: 'ุงููุฏูุฑ - ุนูุฑ',
        permissions: {
            viewData: true,
            editData: true,
            deleteData: true,
            manageProperties: true,
            manageAttachments: true,
            exportData: true,
            importData: true,
            manageSettings: true
        }
    },
    'ูุญูุฏ': {
        password: 'm12345',
        role: 'assistant_admin',
        fullName: 'ุงููุฏูุฑ ุงููุณุงุนุฏ - ูุญูุฏ',
        permissions: {
            viewData: true,
            editData: true,
            deleteData: true,
            manageProperties: true,
            manageAttachments: true,
            exportData: true,
            importData: true,
            manageSettings: true
        }
    },
    'sa12345': {
        password: 'sa12345',
        role: 'limited',
        fullName: 'ูุณุชุฎุฏู ูุญุฏูุฏ ุงูุตูุงุญูุงุช',
        permissions: {
            viewData: true,
            editData: false,
            deleteData: false,
            manageProperties: false,
            manageAttachments: true,
            exportData: false,
            importData: false,
            manageSettings: false
        }
    }
};

// ุชููุฆุฉ ูุธุงู ุงูุตูุงุญูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
function initializePermissionSystem() {
    // ุงูุชุญูู ูู ูุฌูุฏ ุฌูุณุฉ ูุณุชุฎุฏู ูุญููุธุฉ
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            if (users[userData.username] && userData.loginTime) {
                // ุงูุชุญูู ูู ุงูุชูุงุก ุตูุงุญูุฉ ุงูุฌูุณุฉ (24 /10 ุฏูุงูู ุณุงุนุฉ)
                const loginTime = new Date(userData.loginTime);
                const now = new Date();
                const hoursDiff = (now - loginTime) / (1000 * 60 * 60);

                if (hoursDiff < .10) {
                    // ุงูุฌูุณุฉ ุตุงูุญุฉ
                    setCurrentUser(userData.username);
                    return;
                }
            }
        } catch (error) {
            console.error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงููุญููุธุฉ:', error);
        }
    }

    // ุฅุธูุงุฑ ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู
    showLoginModal();
}

// ุฅุธูุงุฑ ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู
function showLoginModal() {
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.classList.add('show');

        // ููุน ุงูุชูุงุนู ูุน ุจุงูู ุงูุตูุญุฉ
        document.body.style.overflow = 'hidden';

        // ุงูุชุฑููุฒ ุนูู ุญูู ุงุณู ุงููุณุชุฎุฏู
        setTimeout(() => {
            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.focus();
            }
        }, 300);
    }
}

// ุฅุฎูุงุก ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู
function hideLoginModal() {
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// ูุนุงูุฌุฉ ุชุณุฌูู ุงูุฏุฎูู
function handleLogin(event) {
    event.preventDefault();

    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    if (!username || !password) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑ');
        return;
    }

    // ุงูุชุญูู ูู ุจูุงูุงุช ุงููุณุชุฎุฏู
    if (users[username] && users[username].password === password) {
        // ุชุณุฌูู ุฏุฎูู ูุงุฌุญ
        setCurrentUser(username);

        // ุญูุธ ุงูุฌูุณุฉ
        const userData = {
            username: username,
            loginTime: new Date().toISOString()
        };
        localStorage.setItem('currentUser', JSON.stringify(userData));

        // ุฅุฎูุงุก ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู
        hideLoginModal();

        // ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู ุงูุจููุฑูุฉ ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู
        console.log('๐ฎ ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู ุงููุงุฌุญ');
        showCrystalLoading();

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุฑุญูุจ
        showWelcomeMessage(users[username].fullName);

        // ุชุญุฏูุซ ูุณู ุงููุณุชุฎุฏู ูู ุงููุงุชู
        setTimeout(() => {
            updateMobileUserSection();
        }, 100);

        // ูุณุญ ุงููููุฐุฌ
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';

    } else {
        // ุชุณุฌูู ุฏุฎูู ูุงุดู
        alert('ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ');

        // ุงูุชุฑููุฒ ุนูู ุญูู ูููุฉ ุงููุฑูุฑ
        document.getElementById('password').focus();
        document.getElementById('password').select();
    }
}

// ุชุนููู ุงููุณุชุฎุฏู ุงูุญุงูู
function setCurrentUser(username) {
    if (users[username]) {
        currentUser = username;
        userPermissions = users[username].permissions;

        // ุชุทุจูู ุงูุตูุงุญูุงุช ุนูู ุงููุงุฌูุฉ
        applyUserPermissions();

        // ุชูุนูู ูุฑุงูุจ ุงููุฑููุงุช ูููุณุชุฎุฏู ูุญุฏูุฏ ุงูุตูุงุญูุงุช
        if (users[username].role === 'limited') {
            setTimeout(() => {
                setupAttachmentsPermissionObserver();
            }, 500);
        }

        console.log(`โ ุชู ุชุณุฌูู ุฏุฎูู ุงููุณุชุฎุฏู: ${users[username].fullName}`);
    }
}

// ุชุทุจูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ุนูู ุงููุงุฌูุฉ
function applyUserPermissions() {
    if (!userPermissions) return;

    const body = document.body;

    // ุฅุฒุงูุฉ ุฌููุน ููุงุณุงุช ุงูุตูุงุญูุงุช ุงูุณุงุจูุฉ
    body.classList.remove('limited-user', 'admin-user', 'assistant-admin-user');

    // ุฅุถุงูุฉ ููุงุณ ุญุณุจ ููุน ุงููุณุชุฎุฏู
    if (users[currentUser].role === 'limited') {
        body.classList.add('limited-user');
        hideLimitedUserElements();
    } else {
        body.classList.add('admin-user');
    }

    // ุชุญุฏูุซ ูุธููุฉ getCurrentUser
    window.getCurrentUser = function() {
        return users[currentUser]?.fullName || currentUser || 'ุงููุธุงู';
    };
}

// ุฅุฎูุงุก ุงูุนูุงุตุฑ ูููุณุชุฎุฏู ูุญุฏูุฏ ุงูุตูุงุญูุงุช
function hideLimitedUserElements() {
    // ุฅุฎูุงุก ุฒุฑ ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช
    const propertyManagerBtns = document.querySelectorAll('#propertyManagerBtn, .property-manager-btn');
    propertyManagerBtns.forEach(btn => {
        if (btn) btn.style.display = 'none';
    });

    // ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูุชุญุฑูุฑ ูุงูุญุฐู ูู ุงูุจุทุงูุงุช
    const editBtns = document.querySelectorAll('.edit-btn, .delete-btn, .add-btn');
    editBtns.forEach(btn => {
        if (btn) btn.style.display = 'none';
    });

    // ุฅุฎูุงุก ุนูุงุตุฑ ุงูุฅุฏุงุฑุฉ ูู ุงูููุงุฆู ุงูููุณุฏูุฉ
    const managementItems = document.querySelectorAll('[onclick*="showPropertyManager"], [onclick*="showDataImport"], [onclick*="cleanStorage"]');
    managementItems.forEach(item => {
        if (item) item.style.display = 'none';
    });

    // ุฅุฎูุงุก ุฒุฑ ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุชุชุจุน
    const trackingManagementBtn = document.getElementById('trackingManagementBtn');
    if (trackingManagementBtn) {
        trackingManagementBtn.style.display = 'none';
    }

    // ุชุทุจูู ูููุฏ ุงููุฑููุงุช
    applyAttachmentsRestrictions();

    console.log('๐ ุชู ุชุทุจูู ูููุฏ ุงููุณุชุฎุฏู ูุญุฏูุฏ ุงูุตูุงุญูุงุช');
}

// ุชุทุจูู ูููุฏ ุงููุฑููุงุช ูููุณุชุฎุฏู ูุญุฏูุฏ ุงูุตูุงุญูุงุช
function applyAttachmentsRestrictions() {
    console.log('๐ ุชุทุจูู ูููุฏ ุงููุฑููุงุช ูููุณุชุฎุฏู ูุญุฏูุฏ ุงูุตูุงุญูุงุช...');

    // ุฅุฎูุงุก ููุงุทู ุงูุฑูุน
    const uploadElements = document.querySelectorAll(`
        .upload-area, .upload-section, .upload-dropzone, .upload-zone,
        .file-upload-area, .totals-upload-zone, .enhanced-upload,
        .upload-notes-sidebar, .mobile-upload-section
    `);
    uploadElements.forEach(element => {
        if (element) element.style.display = 'none';
    });

    // ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูุญุฐู ูุงููุฒุงููุฉ
    const deleteElements = document.querySelectorAll(`
        .btn-delete, .delete-btn, .mobile-action-btn.delete,
        .attachment-btn.delete-btn, .btn-enhanced.btn-delete,
        .sync-btn, .attachment-btn.sync-btn
    `);
    deleteElements.forEach(element => {
        if (element) element.style.display = 'none';
    });

    // ุฅุนุงุฏุฉ ุชุฎุทูุท ุงููุญุชูู
    const contentLayouts = document.querySelectorAll('.content-layout-new');
    contentLayouts.forEach(layout => {
        if (layout) {
            layout.style.gridTemplateColumns = '1fr';
        }
    });

    const attachmentLists = document.querySelectorAll('.attachments-list');
    attachmentLists.forEach(list => {
        if (list) {
            list.style.width = '100%';
            list.style.maxWidth = '100%';
        }
    });

    // ุฅุถุงูุฉ ูุนุงูุฌุงุช ุฃุญุฏุงุซ ูููุน ุงูุฑูุน
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        if (input.id && (input.id.includes('Upload') || input.id.includes('File'))) {
            input.disabled = true;
            input.style.display = 'none';
        }
    });

    // ููุน ุฃุญุฏุงุซ ุงูุณุญุจ ูุงูุฅููุงุช
    const dragElements = document.querySelectorAll('.upload-area, .upload-dropzone, .enhanced-upload');
    dragElements.forEach(element => {
        if (element) {
            element.style.pointerEvents = 'none';
            element.style.cursor = 'not-allowed';
            element.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                showNoPermissionMessage();
                return false;
            };
        }
    });

    console.log('โ ุชู ุชุทุจูู ูููุฏ ุงููุฑููุงุช');
}

// ุฅุถุงูุฉ ุฑุณุงูุฉ ุฅุนูุงููุฉ ูููุณุชุฎุฏู ูุญุฏูุฏ ุงูุตูุงุญูุงุช ูู ููุงูุฐ ุงููุฑููุงุช
function addLimitedUserNoticeToAttachments() {
    if (!userPermissions || userPermissions.manageAttachments) return;

    // ุงูุจุญุซ ุนู ููุงูุฐ ุงููุฑููุงุช ุงูููุชูุญุฉ
    const attachmentModals = document.querySelectorAll('.attachments-modal, .card-attachments-modal, .mobile-attachments-modal');

    attachmentModals.forEach(modal => {
        // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงูุฑุณุงูุฉ ูุณุจูุงู
        if (modal.querySelector('.limited-user-attachments-notice')) return;

        // ุฅูุดุงุก ุงูุฑุณุงูุฉ ุงูุฅุนูุงููุฉ
        const notice = document.createElement('div');
        notice.className = 'limited-user-attachments-notice';
        notice.innerHTML = `
            <i class="fas fa-info-circle"></i>
            ูุถุน ุงูุนุฑุถ ููุท - ููููู ูุดุงูุฏุฉ ูุชุญููู ุงููุฑููุงุช ูููู ูุง ููููู ุฑูุน ุฃู ุญุฐู ูููุงุช
        `;

        // ุฅุฏุฑุงุฌ ุงูุฑุณุงูุฉ ูู ุจุฏุงูุฉ ูุญุชูู ุงููุงูุฐุฉ
        const modalContent = modal.querySelector('.attachments-modal-content, .card-modal-content, .mobile-attachments-content');
        if (modalContent) {
            modalContent.insertBefore(notice, modalContent.firstChild);
        }
    });
}

// ุชุญุฏูุซ ูุธุงุฆู ุฅุธูุงุฑ ููุงูุฐ ุงููุฑููุงุช ูุชุทุจูู ุงููููุฏ
const originalShowAttachmentsModal = window.showAttachmentsModal;
window.showAttachmentsModal = function(city, propertyName) {
    if (originalShowAttachmentsModal) {
        originalShowAttachmentsModal(city, propertyName);

        // ุชุทุจูู ุงููููุฏ ุจุนุฏ ุฅุธูุงุฑ ุงููุงูุฐุฉ
        setTimeout(() => {
            if (users[currentUser]?.role === 'limited') {
                applyAttachmentsRestrictions();
                addLimitedUserNoticeToAttachments();
            }
        }, 100);
    }
};

const originalShowCardAttachmentsModal = window.showCardAttachmentsModal;
window.showCardAttachmentsModal = function(city, propertyName, contractNumber, unitNumber) {
    if (originalShowCardAttachmentsModal) {
        originalShowCardAttachmentsModal(city, propertyName, contractNumber, unitNumber);

        // ุชุทุจูู ุงููููุฏ ุจุนุฏ ุฅุธูุงุฑ ุงููุงูุฐุฉ
        setTimeout(() => {
            if (users[currentUser]?.role === 'limited') {
                applyAttachmentsRestrictions();
                addLimitedUserNoticeToAttachments();
            }
        }, 100);
    }
};

// ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู ูุนูููุฉ ูุนููุฉ
function checkPermission(action) {
    if (!userPermissions) {
        showNoPermissionMessage();
        return false;
    }

    const hasPermission = userPermissions[action] === true;

    if (!hasPermission) {
        showNoPermissionMessage();
    }

    return hasPermission;
}

// ุฅุธูุงุฑ ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ุตูุงุญูุงุช
function showNoPermissionMessage() {
    // ุฅุฒุงูุฉ ุฃู ุฑุณุงูุฉ ุณุงุจูุฉ
    const existingMessage = document.querySelector('.no-permission-message');
    if (existingMessage) {
        existingMessage.remove();
    }

    // ุฅูุดุงุก ุฑุณุงูุฉ ุฌุฏูุฏุฉ
    const message = document.createElement('div');
    message.className = 'no-permission-message';
    message.innerHTML = `
        <i class="fas fa-lock" style="margin-left: 8px;"></i>
        ููุณ ูุฏูู ุตูุงุญูุฉ ููููุงู ุจูุฐุง ุงูุฅุฌุฑุงุก
    `;

    document.body.appendChild(message);

    // ุฅุฒุงูุฉ ุงูุฑุณุงูุฉ ุจุนุฏ 3 ุซูุงู
    setTimeout(() => {
        if (message.parentNode) {
            message.remove();
        }
    }, 3000);
}

// ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุฑุญูุจ
function showWelcomeMessage(fullName) {
    const message = document.createElement('div');
    message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        z-index: 2500;
        font-weight: 600;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;

    message.innerHTML = `
        <i class="fas fa-check-circle" style="margin-left: 8px;"></i>
        ูุฑุญุจุงู ${fullName}
    `;

    document.body.appendChild(message);

    // ุฅุธูุงุฑ ุงูุฑุณุงูุฉ
    setTimeout(() => {
        message.style.transform = 'translateX(0)';
    }, 100);

    // ุฅุฎูุงุก ุงูุฑุณุงูุฉ ุจุนุฏ 4 ุซูุงู
    setTimeout(() => {
        message.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (message.parentNode) {
                message.remove();
            }
        }, 300);
    }, 4000);
}

// ุชุณุฌูู ุงูุฎุฑูุฌ
function logout() {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
        // ุฅุฎูุงุก ูุณู ุงููุณุชุฎุฏู ูู ุงููุงุชู
        hideMobileUserSection();

        // ูุณุญ ุจูุงูุงุช ุงูุฌูุณุฉ
        localStorage.removeItem('currentUser');

        // ุฅุนุงุฏุฉ ุชุนููู ุงููุชุบูุฑุงุช
        currentUser = null;
        userPermissions = null;

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
        location.reload();
    }
}

// ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ูููุณุชุฎุฏููู ุงููุณุฌููู
function addLogoutButton() {
    if (!currentUser) {
        console.log('โ๏ธ ูุง ููุฌุฏ ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู - ุชุฎุทู ุฅุถุงูุฉ ุฒุฑ ุงูุฎุฑูุฌ');
        return;
    }

    console.log('๐ ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ูููุณุชุฎุฏู:', currentUser);

    // ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุงูุดุงุดุงุช ุงููุจูุฑุฉ
    const header = document.querySelector('.header-section.header-actions');
    if (header && !document.getElementById('logoutBtn')) {
        const logoutBtn = document.createElement('button');
        logoutBtn.id = 'logoutBtn';
        logoutBtn.className = 'header-btn logout-btn';
        logoutBtn.innerHTML = `
            <i class="fas fa-sign-out-alt"></i>
            ุฎุฑูุฌ (${users[currentUser].fullName})
        `;
        logoutBtn.onclick = logout;
        logoutBtn.style.cssText = `
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 1rem;
        `;

        header.appendChild(logoutBtn);
        console.log('โ ุชู ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ');
    } else if (!header) {
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู header ููุฃุฒุฑุงุฑ');
    } else {
        console.log('โน๏ธ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ููุฌูุฏ ุจุงููุนู');
    }

    // ุฅุถุงูุฉ ูุนูููุงุช ุงููุณุชุฎุฏู ูู ุงููุงุฆูุฉ ุงููุญูููุฉ
    updateMobileUserSection();
}

// ุชุญุฏูุซ ูุณู ุงููุณุชุฎุฏู ูู ุงููุงุชู
function updateMobileUserSection() {
    const mobileUserSection = document.getElementById('mobileUserSection');
    const mobileUserName = document.getElementById('mobileUserName');
    const mobileUserRole = document.getElementById('mobileUserRole');

    if (!mobileUserSection || !mobileUserName || !mobileUserRole) return;

    if (currentUser && users[currentUser]) {
        // ุฅุธูุงุฑ ูุณู ุงููุณุชุฎุฏู
        mobileUserSection.style.display = 'block';
        mobileUserSection.classList.remove('hidden');

        // ุชุญุฏูุซ ูุนูููุงุช ุงููุณุชุฎุฏู
        mobileUserName.textContent = users[currentUser].fullName;

        // ุชุญุฏูุฏ ุฏูุฑ ุงููุณุชุฎุฏู
        let roleText = '';
        let roleColor = '';

        switch (users[currentUser].role) {
            case 'admin':
                roleText = 'ูุฏูุฑ ุงููุธุงู';
                roleColor = '#28a745';
                break;
            case 'assistant_admin':
                roleText = 'ูุฏูุฑ ูุณุงุนุฏ';
                roleColor = '#17a2b8';
                break;
            case 'limited':
                roleText = 'ูุณุชุฎุฏู ูุญุฏูุฏ';
                roleColor = '#ffc107';
                break;
            default:
                roleText = 'ูุณุชุฎุฏู';
                roleColor = '#6c757d';
        }

        mobileUserRole.textContent = roleText;
        mobileUserRole.style.color = roleColor;

        console.log('๐ฑ ุชู ุชุญุฏูุซ ูุณู ุงููุณุชุฎุฏู ูู ุงููุงุชู');
    } else {
        // ุฅุฎูุงุก ูุณู ุงููุณุชุฎุฏู
        mobileUserSection.style.display = 'none';
        mobileUserSection.classList.add('hidden');
    }
}

// ุฅุฎูุงุก ูุณู ุงููุณุชุฎุฏู ุนูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
function hideMobileUserSection() {
    const mobileUserSection = document.getElementById('mobileUserSection');
    if (mobileUserSection) {
        mobileUserSection.style.display = 'none';
        mobileUserSection.classList.add('hidden');
    }
}

// ุชุญุฏูุซ ูุธุงุฆู ุงูุชุญุฑูุฑ ูุงูุญุฐู ููุชุญูู ูู ุงูุตูุงุญูุงุช
const originalEditCard = window.editCard;
window.editCard = function(index) {
    if (!checkPermission('editData')) return;
    if (originalEditCard) originalEditCard(index);
};

const originalDeleteCard = window.deleteCard;
window.deleteCard = function(index) {
    if (!checkPermission('deleteData')) return;
    if (originalDeleteCard) originalDeleteCard(index);
};

const originalShowPropertyManager = window.showPropertyManager;
window.showPropertyManager = function() {
    if (!checkPermission('manageProperties')) return;
    if (originalShowPropertyManager) originalShowPropertyManager();
};

// ุญูุงูุฉ ูุธุงุฆู ุงููุฑููุงุช
const originalDeletePropertyAttachment = window.deletePropertyAttachment;
window.deletePropertyAttachment = function(propertyKey, fileIndex) {
    if (!checkPermission('manageAttachments')) return;
    if (originalDeletePropertyAttachment) originalDeletePropertyAttachment(propertyKey, fileIndex);
};

const originalDeletePropertyAttachmentFromSupabase = window.deletePropertyAttachmentFromSupabase;
window.deletePropertyAttachmentFromSupabase = function(attachmentId, propertyKey) {
    if (!checkPermission('manageAttachments')) return;
    if (originalDeletePropertyAttachmentFromSupabase) originalDeletePropertyAttachmentFromSupabase(attachmentId, propertyKey);
};

const originalDeleteCardAttachment = window.deleteCardAttachment;
window.deleteCardAttachment = function(cardKey, fileName) {
    if (!checkPermission('manageAttachments')) return;
    if (originalDeleteCardAttachment) originalDeleteCardAttachment(cardKey, fileName);
};

const originalDeleteCardAttachmentFromSupabase = window.deleteCardAttachmentFromSupabase;
window.deleteCardAttachmentFromSupabase = function(attachmentId, cardKey) {
    if (!checkPermission('manageAttachments')) return;
    if (originalDeleteCardAttachmentFromSupabase) originalDeleteCardAttachmentFromSupabase(attachmentId, cardKey);
};

const originalDeleteAttachment = window.deleteAttachment;
window.deleteAttachment = function(propertyKey, fileName, city, propertyName) {
    if (!checkPermission('manageAttachments')) return;
    if (originalDeleteAttachment) originalDeleteAttachment(propertyKey, fileName, city, propertyName);
};

const originalDeleteAttachmentFromSupabase = window.deleteAttachmentFromSupabase;
window.deleteAttachmentFromSupabase = function(attachmentId, propertyKey) {
    if (!checkPermission('manageAttachments')) return;
    if (originalDeleteAttachmentFromSupabase) originalDeleteAttachmentFromSupabase(attachmentId, propertyKey);
};

// ุญูุงูุฉ ูุธุงุฆู ุฑูุน ุงููููุงุช
const originalHandleFileUploadEnhanced = window.handleFileUploadEnhanced;
window.handleFileUploadEnhanced = function(event, city, propertyName) {
    if (!checkPermission('manageAttachments')) return;
    if (originalHandleFileUploadEnhanced) originalHandleFileUploadEnhanced(event, city, propertyName);
};

const originalHandleCardFileUpload = window.handleCardFileUpload;
window.handleCardFileUpload = function(event, cardKey) {
    if (!checkPermission('manageAttachments')) return;
    if (originalHandleCardFileUpload) originalHandleCardFileUpload(event, cardKey);
};

// ุญูุงูุฉ ูุธุงุฆู ุงููุฒุงููุฉ
const originalSyncLocalAttachment = window.syncLocalAttachment;
window.syncLocalAttachment = function(propertyKey, fileName) {
    if (!checkPermission('manageAttachments')) return;
    if (originalSyncLocalAttachment) originalSyncLocalAttachment(propertyKey, fileName);
};

// ุญูุงูุฉ ูุธุงุฆู ุฅุฏุงุฑุฉ ุงููุฑููุงุช ุงูุนุงูุฉ
const originalShowAttachmentsManagerFromDropdown = window.showAttachmentsManagerFromDropdown;
window.showAttachmentsManagerFromDropdown = function() {
    if (!checkPermission('manageAttachments')) return;
    if (originalShowAttachmentsManagerFromDropdown) originalShowAttachmentsManagerFromDropdown();
};

// ุญูุงูุฉ ูุธุงุฆู ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช (ุชุญุชูู ุนูู ุฑูุน ูููุงุช)
const originalShowUpdateTotalsModal = window.showUpdateTotalsModal;
window.showUpdateTotalsModal = function() {
    if (!checkPermission('manageAttachments')) return;
    if (originalShowUpdateTotalsModal) originalShowUpdateTotalsModal();
};

const originalShowDataImportModal = window.showDataImportModal;
window.showDataImportModal = function() {
    if (!checkPermission('importData')) return;
    if (originalShowDataImportModal) originalShowDataImportModal();
};

// ุชููุฆุฉ ูุธุงู ุงูุตูุงุญูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', function() {
    // ุชุฃุฎูุฑ ูุตูุฑ ููุชุฃูุฏ ูู ุชุญููู ุฌููุน ุงูุนูุงุตุฑ
    setTimeout(() => {
        initializePermissionSystem();

        // ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
        if (currentUser) {
            addLogoutButton();
            updateMobileUserSection();
        }

        // ุชุญููู ุณุฌูุงุช ุงูุชุชุจุน
        loadLocalChangeTrackingLogs();

        // ุฅุถุงูุฉ ุญููู ุงูุชุชุจุน ููุจูุงูุงุช ุงูููุฌูุฏุฉ
        addTrackingFieldsToExistingData();

        // ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุชุชุจุน (ููุงุฎุชุจุงุฑ)
        createSampleTrackingData();
    }, 1000);
});

// ==================== ูุธุงุฆู ุฅุฎูุงุก/ุฅุธูุงุฑ ุฃุฒุฑุงุฑ ุงูููุฏุฑ ====================

// ุชุจุฏูู ุฅุธูุงุฑ/ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูููุฏุฑ
function toggleHeaderButtons() {
    areHeaderButtonsVisible = !areHeaderButtonsVisible;

    // ุญูุธ ุงูุญุงูุฉ ูู localStorage
    localStorage.setItem('headerButtonsVisible', areHeaderButtonsVisible);

    updateHeaderButtonsDisplay();
}

// ุชุญุฏูุซ ุนุฑุถ ุงูุฃุฒุฑุงุฑ
function updateHeaderButtonsDisplay() {
    const hideableButtons = document.querySelectorAll('.hideable-header-btn');
    const toggleIcon = document.getElementById('toggleHeaderIcon');
    const toggleText = document.getElementById('toggleHeaderText');

    hideableButtons.forEach(button => {
        if (areHeaderButtonsVisible) {
            // ุฅุธูุงุฑ ุงูุฃุฒุฑุงุฑ
            button.style.opacity = '1';
            button.style.transform = 'scale(1)';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
        } else {
            // ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ
            button.style.opacity = '0';
            button.style.transform = 'scale(0.8)';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
        }
    });

    // ุชุญุฏูุซ ุฃููููุฉ ููุต ุงูุฒุฑ
    if (toggleIcon && toggleText) {
        if (areHeaderButtonsVisible) {
            toggleIcon.className = 'fas fa-eye';
            toggleText.textContent = 'ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ';
            document.getElementById('toggleHeaderBtn').title = 'ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ';
        } else {
            toggleIcon.className = 'fas fa-eye-slash';
            toggleText.textContent = 'ุฅุธูุงุฑ ุงูุฃุฒุฑุงุฑ';
            document.getElementById('toggleHeaderBtn').title = 'ุฅุธูุงุฑ ุงูุฃุฒุฑุงุฑ';
        }
    }
}

// ุชููุฆุฉ ุญุงูุฉ ุงูุฃุฒุฑุงุฑ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
function initializeHeaderButtons() {
    // ุงุณุชุนุงุฏุฉ ุงูุญุงูุฉ ุงููุญููุธุฉ ูู localStorage
    const savedState = localStorage.getItem('headerButtonsVisible');
    if (savedState !== null) {
        areHeaderButtonsVisible = savedState === 'true';
    }

    const hideableButtons = document.querySelectorAll('.hideable-header-btn');

    hideableButtons.forEach(button => {
        // ุฅุถุงูุฉ ุชุฃุซูุฑุงุช ุงูุงูุชูุงู
        button.style.transition = 'all 0.3s ease';
    });

    // ุชุทุจูู ุงูุญุงูุฉ ุงููุญููุธุฉ
    updateHeaderButtonsDisplay();
}

// ==================== ูุธููุฉ ุฅูุฑุงุบ ุงููุญุฏุฉ ====================

// ุฅูุฑุงุบ ุงููุญุฏุฉ ูู ุฌููุน ุจูุงูุงุช ุงููุณุชุฃุฌุฑ
async function emptyUnit(contractNumber, propertyName, unitNumber) {
    // ุฑุณุงูุฉ ุชุฃููุฏ
    const confirmMessage = `ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุฑุงุบ ูุฐู ุงููุญุฏุฉุ\n\nุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุชุงููุฉ:\n- ุงุณู ุงููุณุชุฃุฌุฑ\n- ุฑูู ุงูุนูุฏ\n- ุชูุงุฑูุฎ ุงูุนูุฏ\n- ุงููุจุงูุบ ุงููุงููุฉ\n- ุฌููุน ุงูุฃูุณุงุท\n\nุณูุชู ุงูุงุญุชูุงุธ ุจุงููุนูููุงุช ุงูุฃุณุงุณูุฉ ูููุญุฏุฉ ููุท.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    // ุงูุจุญุซ ุนู ุงููุญุฏุฉ
    let propertyIndex = -1;

    if (contractNumber && propertyName) {
        propertyIndex = properties.findIndex(p =>
            p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
        );
    } else if (unitNumber && propertyName) {
        propertyIndex = properties.findIndex(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName
        );
    }

    if (propertyIndex === -1) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุทููุจุฉ');
        return;
    }

    const property = properties[propertyIndex];

    // ุงูุงุญุชูุงุธ ุจุงููุนูููุงุช ุงูุฃุณุงุณูุฉ ูููุญุฏุฉ ููุท
    const basicInfo = {
        'Column1': property['Column1'],
        'ุงุณู ุงูุนูุงุฑ': property['ุงุณู ุงูุนูุงุฑ'],
        'ุงููุฏููุฉ': property['ุงููุฏููุฉ'],
        'ุฑูู  ุงููุญุฏุฉ ': property['ุฑูู  ุงููุญุฏุฉ '],
        'ุงููุณุงุญุฉ': property['ุงููุณุงุญุฉ'],
        'ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก': property['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'],
        'ุงูุงุฑุชูุงุน': property['ุงูุงุฑุชูุงุน'],
        'ูููุน ุงูุนูุงุฑ': property['ูููุน ุงูุนูุงุฑ'],
        'ุฑูู ุงูุตู': property['ุฑูู ุงูุตู'],
        'ุงูุณุฌู ุงูุนููู ': property['ุงูุณุฌู ุงูุนููู '],
        'ูุณุงุญุฉุงูุตู': property['ูุณุงุญุฉุงูุตู'],
        'ุงููุงูู': property['ุงููุงูู']
    };

    // ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุฃุฎุฑู
    const fieldsToEmpty = [
        'ุงุณู ุงููุณุชุฃุฌุฑ',
        'ุฑูู ุงูุนูุฏ',
        'ููุน ุงูุนูุฏ',
        'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ',
        'ุชุงุฑูุฎ ุงูููุงูุฉ',
        'ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท',
        'ูููุฉ  ุงูุงูุฌุงุฑ ',
        'ุงูุงุฌูุงูู',
        'ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ',
        'ุงูุญุงูุฉ ุงูููุงุฆูุฉ',
        'ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ'
    ];

    // ุญุฐู ุฌููุน ุงูุฃูุณุงุท (ูู 1 ุฅูู 10)
    for (let i = 1; i <= 10; i++) {
        const dateKey = i === 1 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุงูู' :
                       i === 2 ? 'ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู' :
                       `ุชุงุฑูุฎ ุงููุณุท ${getArabicNumber(i)}`;
        const amountKey = i === 1 ? 'ูุจูุบ ุงููุณุท ุงูุงูู' :
                         i === 2 ? 'ูุจูุบ ุงููุณุท ุงูุซุงูู' :
                         `ูุจูุบ ุงููุณุท ${getArabicNumber(i)}`;

        fieldsToEmpty.push(dateKey, amountKey);
    }

    // ุชุทุจูู ุงูุฅูุฑุงุบ
    fieldsToEmpty.forEach(field => {
        basicInfo[field] = null;
    });

    // ุฅุถุงูุฉ ุณุฌู ุงูุชุชุจุน ูุฅูุฑุงุบ ุงููุญุฏุฉ
    try {
        await addChangeLog(
            OPERATION_TYPES.EMPTY_UNIT,
            basicInfo,
            {},
            {
                previousTenant: originalTenant,
                reason: 'ุฅูุฑุงุบ ูุญุฏุฉ ูู ุงููุณุชุฃุฌุฑ'
            }
        );
        console.log('๐ ุชู ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ุฅูุฑุงุบ ุงููุญุฏุฉ');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุณุฌู ุชุชุจุน ุฅูุฑุงุบ ุงููุญุฏุฉ:', error);
    }

    // ุชุญุฏูุซ ุงูุนูุงุฑ
    properties[propertyIndex] = basicInfo;

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุญุงูุงุช
    initializeApp();

    // ุฅุบูุงู ุงููุงูุฐุฉ ูุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
    closeModal();
    alert('ุชู ุฅูุฑุงุบ ุงููุญุฏุฉ ุจูุฌุงุญ!\nุชู ุญุฐู ุฌููุน ุจูุงูุงุช ุงููุณุชุฃุฌุฑ ูุงูุนูุฏ ูุงูุฃูุณุงุท.');

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
    renderData();
}

// ==================== ูุนุงูุฌุงุช ุงูุฃุฎุทุงุก ุงูุนุงูุฉ ====================

// ูุนุงูุฌ ุฃุฎุทุงุก ุนุงู ูููุน ุงูุฅุบูุงู ุงูููุงุฌุฆ ููููุงูุฐ
window.addEventListener('error', function(event) {
    console.error('โ ุฎุทุฃ ุนุงู ูู ุงูุชุทุจูู:', event.error);
    // ููุน ุฅุบูุงู ุงูููุงูุฐ ุจุณุจุจ ุงูุฃุฎุทุงุก
    event.preventDefault();
    return false;
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('โ ุฎุทุฃ ูู Promise ุบูุฑ ูุนุงูุฌ:', event.reason);
    // ููุน ุฅุบูุงู ุงูููุงูุฐ ุจุณุจุจ ุฃุฎุทุงุก Promise
    event.preventDefault();
});

// ุชููุฆุฉ ุงูุชุทุจูู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', function() {
    console.log('๐ ุจุฏุก ุชุญููู ุงูุชุทุจูู...');
    try {
        initializeApp();
    } catch (initError) {
        console.error('โ ุฎุทุฃ ูู ุชููุฆุฉ ุงูุชุทุจูู:', initError);
        // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุนุฏ ุซุงููุฉ ูุงุญุฏุฉ
        setTimeout(() => {
            try {
                initializeApp();
            } catch (retryError) {
                console.error('โ ูุดู ูู ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุชุทุจูู:', retryError);
            }
        }, 1000);
    }
});

// ูุฑุงูุจ DOM ูุชุทุจูู ูููุฏ ุงููุฑููุงุช ุชููุงุฆูุงู
function setupAttachmentsPermissionObserver() {
    if (!currentUser || users[currentUser]?.role !== 'limited') return;

    // ุฅูุดุงุก ูุฑุงูุจ ููุชุบููุฑุงุช ูู DOM
    const observer = new MutationObserver(function(mutations) {
        let shouldApplyRestrictions = false;

        mutations.forEach(function(mutation) {
            // ุงูุชุญูู ูู ุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏุฉ
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // ุงูุชุญูู ูู ูุฌูุฏ ุนูุงุตุฑ ูุฑููุงุช ุฌุฏูุฏุฉ
                        if (node.classList && (
                            node.classList.contains('attachments-modal') ||
                            node.classList.contains('card-attachments-modal') ||
                            node.classList.contains('mobile-attachments-modal') ||
                            node.querySelector && (
                                node.querySelector('.upload-area') ||
                                node.querySelector('.delete-btn') ||
                                node.querySelector('.btn-delete')
                            )
                        )) {
                            shouldApplyRestrictions = true;
                        }
                    }
                });
            }
        });

        if (shouldApplyRestrictions) {
            setTimeout(() => {
                applyAttachmentsRestrictions();
                addLimitedUserNoticeToAttachments();
            }, 100);
        }
    });

    // ุจุฏุก ูุฑุงูุจุฉ ุงูุชุบููุฑุงุช
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    console.log('๐๏ธ ุชู ุชูุนูู ูุฑุงูุจ ูููุฏ ุงููุฑููุงุช');
}

// ุชุญุฏูุซ ูุธููุฉ setCurrentUser ูุชุดูู ูุฑุงูุจ ุงููุฑููุงุช
// (ุชู ุฏูุฌูุง ูุน ุงููุธููุฉ ุงูุฃุตููุฉ ุจุฏูุงู ูู ุฅุนุงุฏุฉ ุชุนุฑูููุง)

// ==================== ูุธุงุฆู ููุงูุญุฉ ุงูุชูุฑุงุฑ ====================

// ุงูุชุญูู ูู ูุฌูุฏ ูุญุฏุงุช ููุฑุฑุฉ
function checkForDuplicateUnits(unitNumber, propertyName) {
    if (!unitNumber || !propertyName) {
        return { hasDuplicates: false, count: 0, indices: [] };
    }

    const duplicateIndices = [];
    properties.forEach((p, index) => {
        if (p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName) {
            duplicateIndices.push(index);
        }
    });

    const hasDuplicates = duplicateIndices.length > 1;

    if (hasDuplicates) {
        console.warn(`โ๏ธ ุชู ุงูุชุดุงู ${duplicateIndices.length} ูุณุฎุฉ ูู ุงููุญุฏุฉ "${unitNumber}" ูู ุงูุนูุงุฑ "${propertyName}"`);
        console.log('๐ ููุงุฑุณ ุงููุณุฎ ุงูููุฑุฑุฉ:', duplicateIndices);
    }

    return {
        hasDuplicates: hasDuplicates,
        count: duplicateIndices.length,
        indices: duplicateIndices
    };
}

// ุฅุตูุงุญ ุงููุญุฏุงุช ุงูููุฑุฑุฉ ุจุงูุงุญุชูุงุธ ุจุงูุฃุญุฏุซ
function fixDuplicateUnits(unitNumber, propertyName) {
    const duplicateCheck = checkForDuplicateUnits(unitNumber, propertyName);

    if (!duplicateCheck.hasDuplicates) {
        return { fixed: false, message: 'ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฑุฑุฉ' };
    }

    console.log(`๐ง ุจุฏุก ุฅุตูุงุญ ${duplicateCheck.count} ูุณุฎุฉ ููุฑุฑุฉ ูู ุงููุญุฏุฉ "${unitNumber}"`);

    // ุงูุนุซูุฑ ุนูู ุฃุญุฏุซ ูุณุฎุฉ (ุจูุงุกู ุนูู ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ)
    let latestIndex = duplicateCheck.indices[0];
    let latestDate = new Date(0); // ุชุงุฑูุฎ ูุฏูู ุฌุฏุงู

    duplicateCheck.indices.forEach(index => {
        const unit = properties[index];
        const updateDate = unit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] ? new Date(unit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ']) : new Date(0);

        if (updateDate > latestDate) {
            latestDate = updateDate;
            latestIndex = index;
        }
    });

    console.log(`๐ ุฃุญุฏุซ ูุณุฎุฉ ูู ุงูููุฑุณ: ${latestIndex} (ุชุงุฑูุฎ: ${properties[latestIndex]['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || 'ุบูุฑ ูุญุฏุฏ'})`);

    // ุญุฐู ุงููุณุฎ ุงูููุฑุฑุฉ (ูู ุงูุฃุนูู ููุฃุณูู ูุชุฌูุจ ุชุบููุฑ ุงูููุงุฑุณ)
    let deletedCount = 0;
    for (let i = duplicateCheck.indices.length - 1; i >= 0; i--) {
        const index = duplicateCheck.indices[i];
        if (index !== latestIndex) {
            console.log(`๐๏ธ ุญุฐู ุงููุณุฎุฉ ุงูููุฑุฑุฉ ูู ุงูููุฑุณ: ${index}`);
            properties.splice(index, 1);
            deletedCount++;
        }
    }

    // ุญูุธ ุงูุจูุงูุงุช
    localStorage.setItem('properties', JSON.stringify(properties));

    console.log(`โ ุชู ุฅุตูุงุญ ุงูุชูุฑุงุฑ: ุญูุฐูุช ${deletedCount} ูุณุฎุฉุ ุชุจูุช ูุณุฎุฉ ูุงุญุฏุฉ`);

    return {
        fixed: true,
        deletedCount: deletedCount,
        keptIndex: latestIndex,
        message: `ุชู ุญุฐู ${deletedCount} ูุณุฎุฉ ููุฑุฑุฉ ูุงูุงุญุชูุงุธ ุจุงูุฃุญุฏุซ`
    };
}

// ูุญุต ุดุงูู ููุชูุฑุงุฑ ูู ุฌููุน ุงููุญุฏุงุช
function performGlobalDuplicateCheck() {
    console.log('๐ ุจุฏุก ูุญุต ุดุงูู ููุชูุฑุงุฑ ูู ุฌููุน ุงููุญุฏุงุช...');

    const unitMap = new Map();
    const duplicates = [];

    // ุชุฌููุน ุงููุญุฏุงุช ุญุณุจ ุงูููุชุงุญ ุงููุฑูุฏ
    properties.forEach((unit, index) => {
        const unitKey = `${unit['ุงุณู ุงูุนูุงุฑ']}_${unit['ุฑูู  ุงููุญุฏุฉ ']}`;

        if (!unitMap.has(unitKey)) {
            unitMap.set(unitKey, []);
        }

        unitMap.get(unitKey).push({ unit, index });
    });

    // ุงูุนุซูุฑ ุนูู ุงูููุฑุฑุงุช
    unitMap.forEach((units, unitKey) => {
        if (units.length > 1) {
            duplicates.push({
                key: unitKey,
                count: units.length,
                units: units
            });
        }
    });

    if (duplicates.length > 0) {
        console.warn(`โ๏ธ ุชู ุงูุชุดุงู ${duplicates.length} ูุฌููุนุฉ ูู ุงููุญุฏุงุช ุงูููุฑุฑุฉ:`);
        duplicates.forEach(dup => {
            console.log(`   - ${dup.key}: ${dup.count} ูุณุฎุฉ`);
        });
    } else {
        console.log('โ ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฑุฑุฉ');
    }

    return {
        hasDuplicates: duplicates.length > 0,
        duplicateGroups: duplicates,
        totalDuplicates: duplicates.reduce((sum, dup) => sum + dup.count - 1, 0)
    };
}

// ุฅุตูุงุญ ุฌููุน ุงููุญุฏุงุช ุงูููุฑุฑุฉ
function fixAllDuplicates() {
    const globalCheck = performGlobalDuplicateCheck();

    if (!globalCheck.hasDuplicates) {
        return { fixed: false, message: 'ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฑุฑุฉ ููุฅุตูุงุญ' };
    }

    console.log(`๐ง ุจุฏุก ุฅุตูุงุญ ${globalCheck.duplicateGroups.length} ูุฌููุนุฉ ูู ุงููุญุฏุงุช ุงูููุฑุฑุฉ...`);

    let totalFixed = 0;
    globalCheck.duplicateGroups.forEach(group => {
        const [propertyName, unitNumber] = group.key.split('_');
        const result = fixDuplicateUnits(unitNumber, propertyName);
        if (result.fixed) {
            totalFixed += result.deletedCount;
        }
    });

    console.log(`โ ุชู ุฅุตูุงุญ ุฌููุน ุงูุชูุฑุงุฑุงุช: ุญูุฐูุช ${totalFixed} ูุญุฏุฉ ููุฑุฑุฉ`);

    return {
        fixed: true,
        totalFixed: totalFixed,
        message: `ุชู ุฅุตูุงุญ ุฌููุน ุงูุชูุฑุงุฑุงุช ูุญุฐู ${totalFixed} ูุญุฏุฉ ููุฑุฑุฉ`
    };
}

// ุฅุตูุงุญ ุงูุชูุฑุงุฑ ูุน ูุงูุฐุฉ ุชุฃููุฏ
function fixAllDuplicatesWithConfirmation() {
    console.log('๐ ูุญุต ุงููุญุฏุงุช ุงูููุฑุฑุฉ...');

    const globalCheck = performGlobalDuplicateCheck();

    if (!globalCheck.hasDuplicates) {
        alert('โ ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฑุฑุฉ!\n\nุฌููุน ุงููุญุฏุงุช ูุฑูุฏุฉ ููุง ุชุญุชุงุฌ ุฅูู ุฅุตูุงุญ.');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุชุฃููุฏ ูุน ุชูุงุตูู ุงูุชูุฑุงุฑ
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay';
    confirmModal.style.display = 'flex';
    confirmModal.innerHTML = `
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3 style="color: #dc3545; margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i> ุชู ุงูุชุดุงู ูุญุฏุงุช ููุฑุฑุฉ
                </h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404;">
                        <i class="fas fa-info-circle"></i>
                        <strong>ุชู ุงูุนุซูุฑ ุนูู ${globalCheck.duplicateGroups.length} ูุฌููุนุฉ ูู ุงููุญุฏุงุช ุงูููุฑุฑุฉ</strong>
                    </p>
                    <p style="margin: 10px 0 0 0; color: #856404;">
                        ุฅุฌูุงูู ุงููุญุฏุงุช ุงูููุฑุฑุฉ: ${globalCheck.totalDuplicates}
                    </p>
                </div>

                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">ุชูุงุตูู ุงููุญุฏุงุช ุงูููุฑุฑุฉ:</h4>
                    ${globalCheck.duplicateGroups.map(group => {
                        const [propertyName, unitNumber] = group.key.split('_');
                        return `<p style="margin: 5px 0;">โข ุงููุญุฏุฉ "${unitNumber}" ูู "${propertyName}" (${group.count} ูุณุฎุฉ)</p>`;
                    }).join('')}
                </div>

                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #0c5460;">
                        <i class="fas fa-lightbulb"></i>
                        <strong>ูุง ุณูุญุฏุซ ุนูุฏ ุงูุฅุตูุงุญ:</strong>
                    </p>
                    <ul style="margin: 10px 0 0 20px; color: #0c5460;">
                        <li>ุณูุชู ุงูุงุญุชูุงุธ ุจุฃุญุฏุซ ูุณุฎุฉ ูู ูู ูุญุฏุฉ</li>
                        <li>ุณูุชู ุญุฐู ุงููุณุฎ ุงูููุฑุฑุฉ ุงูุฃูุฏู</li>
                        <li>ุณูุชู ุญูุธ ุงูุจูุงูุงุช ุชููุงุฆูุงู</li>
                        <li>ูู ุชููุฏ ุฃู ุจูุงูุงุช ูููุฉ</li>
                    </ul>
                </div>

                <p style="color: #dc3545; font-weight: 600; text-align: center;">
                    ูู ุชุฑูุฏ ุงููุชุงุจุนุฉ ูุฅุตูุงุญ ุฌููุน ุงููุญุฏุงุช ุงูููุฑุฑุฉุ
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-action-btn close-btn" onclick="closeDuplicateFixModal()">
                    <i class="fas fa-times"></i> ุฅูุบุงุก
                </button>
                <button class="modal-action-btn print-btn" onclick="confirmFixAllDuplicates()"
                        style="background: #28a745; border-color: #28a745;">
                    <i class="fas fa-broom"></i> ุฅุตูุงุญ ุงูุชูุฑุงุฑ
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(confirmModal);
}

// ุฅุบูุงู ูุงูุฐุฉ ุฅุตูุงุญ ุงูุชูุฑุงุฑ
function closeDuplicateFixModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// ุชุฃููุฏ ุฅุตูุงุญ ุงูุชูุฑุงุฑ
function confirmFixAllDuplicates() {
    closeDuplicateFixModal();

    // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.style.display = 'flex';
    loadingModal.innerHTML = `
        <div class="modal-box" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #28a745; margin-bottom: 20px;"></i>
            <h3>ุฌุงุฑู ุฅุตูุงุญ ุงูุชูุฑุงุฑ...</h3>
            <p>ูุฑุฌู ุงูุงูุชุธุงุฑุ ุฌุงุฑู ุฅุตูุงุญ ุฌููุน ุงููุญุฏุงุช ุงูููุฑุฑุฉ</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    try {
        const result = fixAllDuplicates();

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        loadingModal.remove();

        if (result.fixed) {
            // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
            renderData();
            updateTotalStats();

            // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
            showSuccessMessage(
                'ุชู ุฅุตูุงุญ ุงูุชูุฑุงุฑ ุจูุฌุงุญ! ๐',
                `ุชู ุญุฐู ${result.totalFixed} ูุญุฏุฉ ููุฑุฑุฉ ูุงูุงุญุชูุงุธ ุจุฃุญุฏุซ ูุณุฎุฉ ูู ูู ูุญุฏุฉ.\n\nุงูุขู ุฌููุน ุงููุญุฏุงุช ูุฑูุฏุฉ ููู ุชุธูุฑ ููุฑุฑุฉ ุนูุฏ ุงูุชุนุฏูู.`
            );
        } else {
            alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ูุญุฏุงุช ููุฑุฑุฉ ููุฅุตูุงุญ.');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุตูุงุญ ุงูุชูุฑุงุฑ:', error);
        loadingModal.remove();
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุตูุงุญ ุงูุชูุฑุงุฑ: ' + error.message);
    }
}

// ==================== ูุธุงุฆู ุนููู ุฌุฏูุฏ ูุชุฌุฏูุฏ ุงูุนูุฏ ====================

// ุชุนููู ุนููู ุฌุฏูุฏ
function setNewClient(contractNumber, propertyName, unitNumber) {
    if (!checkPermission('editData')) return;

    const confirmMessage = 'ูู ุฃูุช ูุชุฃูุฏ ูู ุชุนููู ุนููู ุฌุฏูุฏ ููุฐู ุงููุญุฏุฉุ\n\nุณูุชู ูุณุญ ุจูุงูุงุช ุงูุนููู ุงูุญุงูู ูุฅุนุฏุงุฏ ุงููุญุฏุฉ ูุนููู ุฌุฏูุฏ.';

    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        // ุงูุจุญุซ ุนู ุงููุญุฏุฉ
        const propertyIndex = properties.findIndex(p => {
            if (contractNumber && propertyName) {
                return p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName;
            } else if (unitNumber && propertyName) {
                return p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName;
            }
            return false;
        });

        if (propertyIndex === -1) {
            alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุทููุจุฉ');
            return;
        }

        // ูุณุญ ุจูุงูุงุช ุงูุนููู ุงูุญุงูู
        const property = properties[propertyIndex];
        const fieldsToKeep = [
            'ุงููุฏููุฉ', 'ุงุณู ุงูุนูุงุฑ', 'ุฑูู  ุงููุญุฏุฉ ', 'ููุน ุงููุญุฏุฉ',
            'ุงููุณุงุญุฉ', 'ุนุฏุฏ ุงูุบุฑู', 'ุนุฏุฏ ุฏูุฑุงุช ุงูููุงู', 'ุงูุทุงุจู',
            'ูููุน ุงููุญุฏุฉ', 'ุญุงูุฉ ุงููุญุฏุฉ', 'ููุงุญุธุงุช ุงููุญุฏุฉ'
        ];

        // ุฅูุดุงุก ูุงุฆู ุฌุฏูุฏ ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ููุท
        const newProperty = {};
        fieldsToKeep.forEach(field => {
            if (property[field] !== undefined) {
                newProperty[field] = property[field];
            }
        });

        // ุฅุถุงูุฉ ูุนูููุงุช ุงูุชุญุฏูุซ
        newProperty['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
        newProperty['ููุน ุงูุชุญุฏูุซ'] = 'ุนููู ุฌุฏูุฏ';
        newProperty['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = getCurrentUser();
        newProperty['ุญุงูุฉ ุงููุญุฏุฉ'] = 'ูุงุฑุบ';

        // ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงููุฏููุฉ
        properties[propertyIndex] = newProperty;

        // ุญูุธ ุงูุจูุงูุงุช
        saveDataLocally();

        // ูุฒุงููุฉ ูุน Supabase ุฅุฐุง ูุชุงุญ
        if (typeof syncToSupabase === 'function') {
            syncToSupabase().catch(error => {
                console.error('โ๏ธ ุฎุทุฃ ูู ูุฒุงููุฉ Supabase:', error);
            });
        }

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
        renderData();
        updateTotalStats();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        closeModal();

        alert('โ ุชู ุชุนููู ุงููุญุฏุฉ ูุนููู ุฌุฏูุฏ ุจูุฌุงุญ!\n\nุชู ูุณุญ ุจูุงูุงุช ุงูุนููู ุงูุณุงุจู ูุงูุงุญุชูุงุธ ุจุงููุนูููุงุช ุงูุฃุณุงุณูุฉ ูููุญุฏุฉ ููุท.');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุนููู ุนููู ุฌุฏูุฏ:', error);
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุนููู ุนููู ุฌุฏูุฏ: ' + error.message);
    }
}

// ุชุฌุฏูุฏ ุงูุนูุฏ
function renewContract(contractNumber, propertyName, unitNumber) {
    if (!checkPermission('editData')) return;

    // ุงูุจุญุซ ุนู ุงููุญุฏุฉ
    const property = properties.find(p => {
        if (contractNumber && propertyName) {
            return p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName;
        } else if (unitNumber && propertyName) {
            return p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName;
        }
        return false;
    });

    if (!property) {
        alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุทููุจุฉ');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุชุฌุฏูุฏ ุงูุนูุฏ
    const renewalModalHtml = `
        <div class="modal-overlay" style="display:flex;">
            <div class="modal-box renewal-modal">
                <button class="close-modal" onclick="closeModal()">ร</button>
                <div class="modal-header">
                    <h2><i class="fas fa-sync-alt"></i> ุชุฌุฏูุฏ ุงูุนูุฏ</h2>
                    <p>ุชุฌุฏูุฏ ุนูุฏ ุงููุญุฏุฉ: ${property['ุฑูู  ุงููุญุฏุฉ ']} - ${propertyName}</p>
                </div>
                <div class="modal-content">
                    <div class="current-contract-info">
                        <h3>ูุนูููุงุช ุงูุนูุฏ ุงูุญุงูู:</h3>
                        <div class="info-grid">
                            <div><strong>ุงููุณุชุฃุฌุฑ:</strong> ${property['ุงุณู ุงููุณุชุฃุฌุฑ'] || 'ุบูุฑ ูุญุฏุฏ'}</div>
                            <div><strong>ุฑูู ุงูุนูุฏ:</strong> ${property['ุฑูู ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</div>
                            <div><strong>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:</strong> ${property['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</div>
                            <div><strong>ุชุงุฑูุฎ ุงูููุงูุฉ:</strong> ${property['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ'] || 'ุบูุฑ ูุญุฏุฏ'}</div>
                            <div><strong>ูููุฉ ุงูุฅูุฌุงุฑ:</strong> ${property['ูููุฉ  ุงูุงูุฌุงุฑ '] ? parseFloat(property['ูููุฉ  ุงูุงูุฌุงุฑ ']).toLocaleString() + ' ุฑูุงู' : 'ุบูุฑ ูุญุฏุฏ'}</div>
                        </div>
                    </div>

                    <form id="renewalForm" onsubmit="processContractRenewal(event, '${contractNumber}', '${propertyName}', '${unitNumber}')">
                        <div class="renewal-section">
                            <h3>ุจูุงูุงุช ุงูุชุฌุฏูุฏ:</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุฑูู ุงูุนูุฏ ุงูุฌุฏูุฏ:</label>
                                    <input type="text" name="newContractNumber" value="${property['ุฑูู ุงูุนูุฏ'] || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ ุงูุฌุฏูุฏ:</label>
                                    <input type="date" name="newStartDate" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ ุงูุฌุฏูุฏ:</label>
                                    <input type="date" name="newEndDate" required>
                                </div>
                                <div class="form-group">
                                    <label>ูููุฉ ุงูุฅูุฌุงุฑ ุงูุฌุฏูุฏุฉ:</label>
                                    <input type="number" name="newRentAmount" value="${property['ูููุฉ  ุงูุงูุฌุงุฑ '] || ''}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ููุงุญุธุงุช ุงูุชุฌุฏูุฏ:</label>
                                <textarea name="renewalNotes" rows="3" placeholder="ุฃู ููุงุญุธุงุช ุฎุงุตุฉ ุจุงูุชุฌุฏูุฏ..."></textarea>
                            </div>
                        </div>

                        <div class="modal-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-check"></i> ุชุฃููุฏ ุงูุชุฌุฏูุฏ
                            </button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">
                                <i class="fas fa-times"></i> ุฅูุบุงุก
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', renewalModalHtml);
}

// ูุนุงูุฌุฉ ุชุฌุฏูุฏ ุงูุนูุฏ
function processContractRenewal(event, contractNumber, propertyName, unitNumber) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const renewalData = {
        newContractNumber: formData.get('newContractNumber'),
        newStartDate: formData.get('newStartDate'),
        newEndDate: formData.get('newEndDate'),
        newRentAmount: formData.get('newRentAmount'),
        renewalNotes: formData.get('renewalNotes')
    };

    if (!renewalData.newContractNumber || !renewalData.newStartDate || !renewalData.newEndDate) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
        return;
    }

    try {
        // ุงูุจุญุซ ุนู ุงููุญุฏุฉ ูุชุญุฏูุซูุง
        const propertyIndex = properties.findIndex(p => {
            if (contractNumber && propertyName) {
                return p['ุฑูู ุงูุนูุฏ'] === contractNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName;
            } else if (unitNumber && propertyName) {
                return p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber && p['ุงุณู ุงูุนูุงุฑ'] === propertyName;
            }
            return false;
        });

        if (propertyIndex === -1) {
            alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ุงููุทููุจุฉ');
            return;
        }

        // ุชุญุฏูุซ ุจูุงูุงุช ุงูุนูุฏ
        const property = properties[propertyIndex];
        property['ุฑูู ุงูุนูุฏ'] = renewalData.newContractNumber;
        property['ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุนูุฏ'] = renewalData.newStartDate;
        property['ุชุงุฑูุฎ ููุงูุฉ ุงูุนูุฏ'] = renewalData.newEndDate;

        if (renewalData.newRentAmount) {
            property['ูููุฉ  ุงูุงูุฌุงุฑ '] = parseFloat(renewalData.newRentAmount);
        }

        if (renewalData.renewalNotes) {
            property['ููุงุญุธุงุช ุงูุชุฌุฏูุฏ'] = renewalData.renewalNotes;
        }

        // ุฅุถุงูุฉ ูุนูููุงุช ุงูุชุญุฏูุซ
        property['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] = new Date().toLocaleDateString('ar-SA');
        property['ููุน ุงูุชุญุฏูุซ'] = 'ุชุฌุฏูุฏ ุงูุนูุฏ';
        property['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] = getCurrentUser();
        property['ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ'] = new Date().toLocaleDateString('ar-SA');

        // ุญูุธ ุงูุจูุงูุงุช
        saveDataLocally();

        // ูุฒุงููุฉ ูุน Supabase ุฅุฐุง ูุชุงุญ
        if (typeof syncToSupabase === 'function') {
            syncToSupabase().catch(error => {
                console.error('โ๏ธ ุฎุทุฃ ูู ูุฒุงููุฉ Supabase:', error);
            });
        }

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
        renderData();
        updateTotalStats();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        closeModal();

        alert('โ ุชู ุชุฌุฏูุฏ ุงูุนูุฏ ุจูุฌุงุญ!\n\nุชู ุชุญุฏูุซ ุฌููุน ุจูุงูุงุช ุงูุนูุฏ ุงูุฌุฏูุฏ.');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุฌุฏูุฏ ุงูุนูุฏ:', error);
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุฌุฏูุฏ ุงูุนูุฏ: ' + error.message);
    }
}

// ุชุดุบูู ุงุฎุชุจุงุฑ ุฅุตูุงุญ ุงูุชุงุฑูุฎ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
setTimeout(() => {
    testDateFix();
}, 2000);

// ุชู ุฅููุงู ุงูุชูุธูู ุงูุชููุงุฆู ูููุน ุญุฐู ุงูุจูุงูุงุช ุงููููุฉ
// ูููู ุงุณุชุฎุฏุงู ุฒุฑ ุงูุชูุธูู ุงููุฏูู ูู ูุงูุฐุฉ ุงูุชุญุฑูุฑ ุงููุชุนุฏุฏุฉ ุนูุฏ ุงูุญุงุฌุฉ

// ๐ ุฏุงูุฉ ุงูุชูุธูู ูุงูุฅุตูุงุญ ุงูุดุงููุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช
async function comprehensiveDatabaseCleanup() {
    console.log('๐ ุจุฏุก ุงูุชูุธูู ูุงูุฅุตูุงุญ ุงูุดุงูู ููุงุนุฏุฉ ุงูุจูุงูุงุช...');

    if (!supabaseClient) {
        alert('โ Supabase ุบูุฑ ูุชุงุญ! ุชุฃูุฏ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช.');
        return;
    }

    const confirmCleanup = confirm(
        `๐งน ุงูุชูุธูู ูุงูุฅุตูุงุญ ุงูุดุงูู ููุงุนุฏุฉ ุงูุจูุงูุงุช\n\n` +
        `ูุฐู ุงูุนูููุฉ ุณุชููู ุจู:\n` +
        `โ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงูุจูุงูุงุช ุงูุญุงููุฉ\n` +
        `โ ุชุญุฏูุฏ ูุญุฐู ุงููุญุฏุงุช ุงูููุฑุฑุฉ ูู Supabase\n` +
        `โ ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ุงูููุธูุฉ\n` +
        `โ ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ\n` +
        `โ ุนุฑุถ ุชูุฑูุฑ ุดุงูู ุจุงููุชุงุฆุฌ\n\n` +
        `ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ`
    );

    if (!confirmCleanup) return;

    // ุฅูุดุงุก ูุงูุฐุฉ ุชูุฏู ูุชูุฏูุฉ
    const progressModal = createAdvancedProgressModal();
    document.body.appendChild(progressModal);

    const statusEl = document.getElementById('cleanupStatus');
    const progressEl = document.getElementById('cleanupProgress');
    const detailsEl = document.getElementById('cleanupDetails');
    const logEl = document.getElementById('cleanupLog');

    let cleanupResults = {
        originalCount: properties.length,
        duplicatesFound: 0,
        duplicatesDeleted: 0,
        finalCount: 0,
        cities: new Set(),
        properties: new Set(),
        errors: []
    };

    try {
        // 1. ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
        await executeStep1_CreateBackup(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 2. ุงูุงุชุตุงู ุจู Supabase ูุงูุชุญูู
        await executeStep2_ConnectSupabase(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 3. ุชุญุฏูุฏ ุงููุญุฏุงุช ุงูููุฑุฑุฉ
        await executeStep3_IdentifyDuplicates(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 4. ุญุฐู ุงููุญุฏุงุช ุงูููุฑุฑุฉ
        await executeStep4_DeleteDuplicates(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 5. ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ุงูููุธูุฉ
        await executeStep5_FetchCleanData(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 6. ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
        await executeStep6_UpdateLocalData(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 7. ุชุญุฏูุซ ุงูุนุฑุถ
        await executeStep7_UpdateDisplay(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // 8. ุนุฑุถ ุงูุชูุฑูุฑ ุงูููุงุฆู
        await executeStep8_ShowFinalReport(statusEl, progressEl, detailsEl, logEl, cleanupResults);

        // ุฅุฒุงูุฉ ูุงูุฐุฉ ุงูุชูุฏู
        setTimeout(() => {
            document.body.removeChild(progressModal);
        }, 3000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชูุธูู ุงูุดุงูู:', error);
        cleanupResults.errors.push(error.message);

        statusEl.textContent = 'โ ูุดู ูู ุงูุชูุธูู';
        detailsEl.textContent = error.message;
        logEl.innerHTML += `<div style="color: #dc3545;">โ ุฎุทุฃ: ${error.message}</div>`;

        setTimeout(() => {
            document.body.removeChild(progressModal);
            alert(`โ ูุดู ูู ุงูุชูุธูู ุงูุดุงูู:\n${error.message}`);
        }, 2000);
    }
}

// ุฅูุดุงุก ูุงูุฐุฉ ุชูุฏู ูุชูุฏูุฉ
function createAdvancedProgressModal() {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.9); z-index: 10000; display: flex;
                    align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 15px;
                       box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
                       min-width: 600px; max-width: 80%; max-height: 80%; overflow-y: auto;">
                <h2 style="margin: 0 0 20px 0; color: #007bff;">๐งน ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</h2>

                <div id="cleanupStatus" style="font-size: 18px; margin-bottom: 15px; color: #333; font-weight: bold;">
                    ุฌุงุฑู ุงูุชุญุถูุฑ...
                </div>

                <div style="width: 100%; height: 10px; background: #f0f0f0; border-radius: 5px; overflow: hidden; margin-bottom: 15px;">
                    <div id="cleanupProgress" style="width: 0%; height: 100%;
                                                   background: linear-gradient(90deg, #007bff, #28a745);
                                                   transition: width 0.5s ease;"></div>
                </div>

                <div id="cleanupDetails" style="font-size: 14px; color: #666; margin-bottom: 20px;">
                    ุฌุงุฑู ุงูุชุญุถูุฑ ููุชูุธูู...
                </div>

                <div style="text-align: left; max-height: 200px; overflow-y: auto;
                           background: #f8f9fa; padding: 15px; border-radius: 8px;
                           font-family: monospace; font-size: 12px;">
                    <div id="cleanupLog" style="color: #333;">
                        ๐ ุณุฌู ุงูุนูููุงุช:<br>
                    </div>
                </div>
            </div>
        </div>
    `;
    return modal;
}

// ุงูุฎุทูุฉ 1: ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
async function executeStep1_CreateBackup(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = '๐พ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ...';
    progressEl.style.width = '5%';
    detailsEl.textContent = 'ุญูุธ ุงูุจูุงูุงุช ุงูุญุงููุฉ ููุณุฎุฉ ุงุญุชูุงุทูุฉ';

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const backupKey = `properties_backup_${timestamp}`;

    try {
        localStorage.setItem(backupKey, JSON.stringify(properties));
        localStorage.setItem('latest_backup_key', backupKey);

        logEl.innerHTML += `<div style="color: #28a745;">โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ: ${backupKey}</div>`;
        console.log(`โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ: ${properties.length} ูุญุฏุฉ`);

        await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
        throw new Error(`ูุดู ูู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: ${error.message}`);
    }
}

// ุงูุฎุทูุฉ 2: ุงูุงุชุตุงู ุจู Supabase ูุงูุชุญูู
async function executeStep2_ConnectSupabase(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = '๐ ุงูุงุชุตุงู ุจู Supabase...';
    progressEl.style.width = '10%';
    detailsEl.textContent = 'ุงูุชุญูู ูู ุงูุงุชุตุงู ูุฌูุจ ุฅุญุตุงุฆูุงุช ุฃูููุฉ';

    try {
        // ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
        const { data: testData, error: testError } = await supabaseClient
            .from('properties')
            .select('id')
            .limit(1);

        if (testError) {
            throw new Error(`ูุดู ุงูุงุชุตุงู ุจู Supabase: ${testError.message}`);
        }

        // ุฌูุจ ุงูุนุฏุฏ ุงูุฅุฌูุงูู
        const { data: countData, error: countError } = await supabaseClient
            .from('properties')
            .select('id', { count: 'exact', head: true });

        if (countError) {
            throw new Error(`ูุดู ูู ุฌูุจ ุงูุนุฏุฏ ุงูุฅุฌูุงูู: ${countError.message}`);
        }

        const totalCount = countData?.length || 0;

        logEl.innerHTML += `<div style="color: #007bff;">๐ ุชู ุงูุงุชุตุงู ุจู Supabase ุจูุฌุงุญ</div>`;
        logEl.innerHTML += `<div style="color: #6c757d;">๐ ุงูุนุฏุฏ ุงูุฅุฌูุงูู ูู Supabase: ${totalCount} ูุญุฏุฉ</div>`;

        console.log(`โ ุงูุงุชุตุงู ุจู Supabase ูุงุฌุญ - ุงูุนุฏุฏ ุงูุฅุฌูุงูู: ${totalCount}`);

        await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
        throw new Error(`ุฎุทุฃ ูู ุงูุงุชุตุงู ุจู Supabase: ${error.message}`);
    }
}

// ุงูุฎุทูุฉ 3: ุชุญุฏูุฏ ุงููุญุฏุงุช ุงูููุฑุฑุฉ
async function executeStep3_IdentifyDuplicates(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = '๐ ุชุญุฏูุฏ ุงููุญุฏุงุช ุงูููุฑุฑุฉ...';
    progressEl.style.width = '25%';
    detailsEl.textContent = 'ุงูุจุญุซ ุนู ุงููุญุฏุงุช ุงูููุฑุฑุฉ ูู Supabase';

    try {
        logEl.innerHTML += `<div style="color: #ffc107;">๐ ุฌุงุฑู ุงูุจุญุซ ุนู ุงููุญุฏุงุช ุงูููุฑุฑุฉ...</div>`;

        // ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ูุชุญููู ุงูุชูุฑุงุฑ
        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;

        while (hasMore) {
            const { data: batchData, error } = await supabaseClient
                .from('properties')
                .select('id, "ุงุณู ุงูุนูุงุฑ", "ุฑูู  ุงููุญุฏุฉ ", "ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ", created_at')
                .range(from, from + batchSize - 1)
                .order('id', { ascending: true });

            if (error) {
                throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ููุชุญููู: ${error.message}`);
            }

            if (batchData && batchData.length > 0) {
                allData.push(...batchData);
                from += batchSize;
                hasMore = batchData.length === batchSize;

                detailsEl.textContent = `ุชู ุชุญููู ${allData.length} ูุญุฏุฉ...`;
            } else {
                hasMore = false;
            }
        }

        // ุชุญููู ุงูุชูุฑุงุฑ
        const unitMap = new Map();
        const duplicates = [];

        allData.forEach(unit => {
            if (!unit['ุงุณู ุงูุนูุงุฑ'] || !unit['ุฑูู  ุงููุญุฏุฉ ']) {
                return; // ุชุฌุงูู ุงููุญุฏุงุช ุงููุงูุตุฉ
            }

            const unitKey = `${unit['ุงุณู ุงูุนูุงุฑ']}_${unit['ุฑูู  ุงููุญุฏุฉ ']}`;

            if (unitMap.has(unitKey)) {
                const existing = unitMap.get(unitKey);
                const existingDate = new Date(existing['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || existing.created_at || '1900-01-01');
                const currentDate = new Date(unit['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || unit.created_at || '1900-01-01');

                if (currentDate > existingDate) {
                    // ุงููุญุฏุฉ ุงูุญุงููุฉ ุฃุญุฏุซ - ุงุญุฐู ุงููุฏููุฉ
                    duplicates.push(existing.id);
                    unitMap.set(unitKey, unit);
                } else {
                    // ุงููุญุฏุฉ ุงูููุฌูุฏุฉ ุฃุญุฏุซ - ุงุญุฐู ุงูุญุงููุฉ
                    duplicates.push(unit.id);
                }
            } else {
                unitMap.set(unitKey, unit);
            }
        });

        results.duplicatesFound = duplicates.length;
        results.duplicateIds = duplicates;

        logEl.innerHTML += `<div style="color: #dc3545;">๐ ุชู ุงูุนุซูุฑ ุนูู ${duplicates.length} ูุญุฏุฉ ููุฑุฑุฉ</div>`;
        logEl.innerHTML += `<div style="color: #28a745;">โ ุณูุชู ุงูุงุญุชูุงุธ ุจู ${unitMap.size} ูุญุฏุฉ ูุฑูุฏุฉ</div>`;

        console.log(`๐ ุชุญููู ุงูุชูุฑุงุฑ: ${duplicates.length} ููุฑุฑุฉ ูู ุฃุตู ${allData.length}`);

        await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
        throw new Error(`ุฎุทุฃ ูู ุชุญุฏูุฏ ุงููุญุฏุงุช ุงูููุฑุฑุฉ: ${error.message}`);
    }
}

// ุงูุฎุทูุฉ 4: ุญุฐู ุงููุญุฏุงุช ุงูููุฑุฑุฉ
async function executeStep4_DeleteDuplicates(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = '๐๏ธ ุญุฐู ุงููุญุฏุงุช ุงูููุฑุฑุฉ...';
    progressEl.style.width = '50%';

    if (!results.duplicateIds || results.duplicateIds.length === 0) {
        detailsEl.textContent = 'ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฑุฑุฉ ููุญุฐู';
        logEl.innerHTML += `<div style="color: #28a745;">โ ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฑุฑุฉ ููุญุฐู</div>`;
        await new Promise(resolve => setTimeout(resolve, 500));
        return;
    }

    try {
        detailsEl.textContent = `ุญุฐู ${results.duplicateIds.length} ูุญุฏุฉ ููุฑุฑุฉ...`;
        logEl.innerHTML += `<div style="color: #ffc107;">๐๏ธ ุฌุงุฑู ุญุฐู ${results.duplicateIds.length} ูุญุฏุฉ ููุฑุฑุฉ...</div>`;

        // ุญุฐู ุงููุญุฏุงุช ุงูููุฑุฑุฉ ุนูู ุฏูุนุงุช
        const batchSize = 100;
        let deletedCount = 0;

        for (let i = 0; i < results.duplicateIds.length; i += batchSize) {
            const batch = results.duplicateIds.slice(i, i + batchSize);

            const { error } = await supabaseClient
                .from('properties')
                .delete()
                .in('id', batch);

            if (error) {
                throw new Error(`ุฎุทุฃ ูู ุญุฐู ุงูุฏูุนุฉ ${Math.floor(i/batchSize) + 1}: ${error.message}`);
            }

            deletedCount += batch.length;
            detailsEl.textContent = `ุชู ุญุฐู ${deletedCount} ูู ${results.duplicateIds.length} ูุญุฏุฉ ููุฑุฑุฉ...`;

            // ุชุฃุฎูุฑ ูุตูุฑ ุจูู ุงูุฏูุนุงุช
            await new Promise(resolve => setTimeout(resolve, 200));
        }

        results.duplicatesDeleted = deletedCount;

        logEl.innerHTML += `<div style="color: #28a745;">โ ุชู ุญุฐู ${deletedCount} ูุญุฏุฉ ููุฑุฑุฉ ุจูุฌุงุญ</div>`;
        console.log(`โ ุชู ุญุฐู ${deletedCount} ูุญุฏุฉ ููุฑุฑุฉ ูู Supabase`);

        await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
        throw new Error(`ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุงุช ุงูููุฑุฑุฉ: ${error.message}`);
    }
}

// ุงูุฎุทูุฉ 5: ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ุงูููุธูุฉ
async function executeStep5_FetchCleanData(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = '๐ฅ ุฌูุจ ุงูุจูุงูุงุช ุงูููุธูุฉ...';
    progressEl.style.width = '70%';
    detailsEl.textContent = 'ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ุงูููุธูุฉ ูู Supabase';

    try {
        logEl.innerHTML += `<div style="color: #007bff;">๐ฅ ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช ุงูููุธูุฉ...</div>`;

        let allCleanData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;

        while (hasMore) {
            const { data: batchData, error } = await supabaseClient
                .from('properties')
                .select('*')
                .range(from, from + batchSize - 1)
                .order('id', { ascending: true });

            if (error) {
                throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ุงูููุธูุฉ: ${error.message}`);
            }

            if (batchData && batchData.length > 0) {
                allCleanData.push(...batchData);
                from += batchSize;
                hasMore = batchData.length === batchSize;

                detailsEl.textContent = `ุชู ุฌูุจ ${allCleanData.length} ูุญุฏุฉ ููุธูุฉ...`;

                // ุฌูุน ุฅุญุตุงุฆูุงุช ุงููุฏู ูุงูุนูุงุฑุงุช
                batchData.forEach(unit => {
                    if (unit['ุงููุฏููุฉ']) results.cities.add(unit['ุงููุฏููุฉ']);
                    if (unit['ุงุณู ุงูุนูุงุฑ']) results.properties.add(unit['ุงุณู ุงูุนูุงุฑ']);
                });
            } else {
                hasMore = false;
            }
        }

        results.cleanData = allCleanData;
        results.finalCount = allCleanData.length;

        logEl.innerHTML += `<div style="color: #28a745;">โ ุชู ุฌูุจ ${allCleanData.length} ูุญุฏุฉ ููุธูุฉ</div>`;
        logEl.innerHTML += `<div style="color: #6c757d;">๐ ${results.cities.size} ูุฏููุฉุ ${results.properties.size} ุนูุงุฑ</div>`;

        console.log(`โ ุชู ุฌูุจ ${allCleanData.length} ูุญุฏุฉ ููุธูุฉ`);

        await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
        throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ุงูููุธูุฉ: ${error.message}`);
    }
}

// ุงูุฎุทูุฉ 6: ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
async function executeStep6_UpdateLocalData(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = '๐พ ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ...';
    progressEl.style.width = '85%';
    detailsEl.textContent = 'ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ุจุงูุจูุงูุงุช ุงูููุธูุฉ';

    try {
        logEl.innerHTML += `<div style="color: #007bff;">๐พ ุฌุงุฑู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ...</div>`;

        // ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ
        properties.length = 0;
        properties.push(...results.cleanData);

        // ุญูุธ ูู localStorage
        saveDataLocally();

        logEl.innerHTML += `<div style="color: #28a745;">โ ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ (${properties.length} ูุญุฏุฉ)</div>`;
        console.log(`โ ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ: ${properties.length} ูุญุฏุฉ`);

        await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
        throw new Error(`ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ: ${error.message}`);
    }
}

// ุงูุฎุทูุฉ 7: ุชุญุฏูุซ ุงูุนุฑุถ
async function executeStep7_UpdateDisplay(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = '๐ฅ๏ธ ุชุญุฏูุซ ุงูุนุฑุถ...';
    progressEl.style.width = '95%';
    detailsEl.textContent = 'ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู';

    try {
        logEl.innerHTML += `<div style="color: #007bff;">๐ฅ๏ธ ุฌุงุฑู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู...</div>`;

        // ุชุญุฏูุซ ุงูุนุฑุถ
        renderData();
        updateTotalStats();

        logEl.innerHTML += `<div style="color: #28a745;">โ ุชู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู</div>`;
        console.log(`โ ุชู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู`);

        await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
        throw new Error(`ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนุฑุถ: ${error.message}`);
    }
}

// ุงูุฎุทูุฉ 8: ุนุฑุถ ุงูุชูุฑูุฑ ุงูููุงุฆู
async function executeStep8_ShowFinalReport(statusEl, progressEl, detailsEl, logEl, results) {
    statusEl.textContent = 'โ ุงูุชูู ุงูุชูุธูู ุจูุฌุงุญ!';
    progressEl.style.width = '100%';
    detailsEl.textContent = 'ุชู ุฅูุฌุงุฒ ุฌููุน ุงูุนูููุงุช ุจูุฌุงุญ';

    // ุฅูุดุงุก ุงูุชูุฑูุฑ ุงูููุงุฆู
    const citiesList = Array.from(results.cities).sort();
    const propertiesList = Array.from(results.properties).sort();

    const report = `
๐ ุชูุฑูุฑ ุงูุชูุธูู ูุงูุฅุตูุงุญ ุงูุดุงูู

๐ ุงูุฅุญุตุงุฆูุงุช:
โข ุงูุจูุงูุงุช ุงูุฃุตููุฉ: ${results.originalCount} ูุญุฏุฉ
โข ุงููุญุฏุงุช ุงูููุฑุฑุฉ ุงููุญุฐููุฉ: ${results.duplicatesDeleted} ูุญุฏุฉ
โข ุงูุจูุงูุงุช ุงูููุงุฆูุฉ: ${results.finalCount} ูุญุฏุฉ
โข ุงููุฑู: ${results.finalCount - results.originalCount > 0 ? '+' : ''}${results.finalCount - results.originalCount} ูุญุฏุฉ

๐๏ธ ุงููุฏู ุงููุชุงุญุฉ (${citiesList.length}):
${citiesList.slice(0, 10).join(', ')}${citiesList.length > 10 ? '...' : ''}

๐ข ุงูุนูุงุฑุงุช ุงููุชุงุญุฉ (${propertiesList.length}):
${propertiesList.slice(0, 10).join(', ')}${propertiesList.length > 10 ? '...' : ''}

โ ุชู ุฅูุฌุงุฒ ุฌููุน ุงูุนูููุงุช ุจูุฌุงุญ!
    `.trim();

    logEl.innerHTML += `<div style="color: #28a745; font-weight: bold;">โ ุงูุชูู ุงูุชูุธูู ุงูุดุงูู ุจูุฌุงุญ!</div>`;

    console.log('โ ุชูุฑูุฑ ุงูุชูุธูู ุงูุดุงูู:', results);

    // ุนุฑุถ ุงูุชูุฑูุฑ ูููุณุชุฎุฏู
    setTimeout(() => {
        alert(report);
    }, 1000);

    await new Promise(resolve => setTimeout(resolve, 2000));
}

// ๐ ุฏุงูุฉ ุณุฑูุนุฉ ูุชุดุบูู ุงูุชูุธูู ุงูุดุงูู ูู ูุญุฏุฉ ุงูุชุญูู
window.runDatabaseCleanup = comprehensiveDatabaseCleanup;

// ๐ ุฏุงูุฉ ุชุญุฏูุซ ุงูุจูุงูุงุช ุจุนุฏ ุงูุชูุธูู ุงูุดุงูู
async function updateAfterCleanup() {
    console.log('๐ ุชุญุฏูุซ ุงูุจูุงูุงุช ุจุนุฏ ุงูุชูุธูู ุงูุดุงูู...');

    if (!supabaseClient) {
        alert('โ Supabase ุบูุฑ ูุชุงุญ!');
        return;
    }

    try {
        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุญููู
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; padding: 30px; border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000; text-align: center;">
                <h3 style="color: #28a745; margin-bottom: 15px;">๐ ุชุญุฏูุซ ุงูุจูุงูุงุช ุจุนุฏ ุงูุชูุธูู</h3>
                <div style="margin-bottom: 15px;">ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช ุงูููุธูุฉ ูู Supabase...</div>
                <div style="width: 300px; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                    <div id="updateProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997);
                                                  transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
        document.body.appendChild(loadingDiv);

        const progressBar = document.getElementById('updateProgress');

        // ุฌูุจ ุงูุจูุงูุงุช ุงูููุธูุฉ
        progressBar.style.width = '30%';

        const { data: cleanData, error } = await supabaseClient
            .from('properties')
            .select('*')
            .order('id', { ascending: true });

        if (error) {
            throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช: ${error.message}`);
        }

        progressBar.style.width = '60%';

        // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
        const oldCount = properties.length;
        properties.length = 0;
        properties.push(...cleanData);

        progressBar.style.width = '80%';

        // ุญูุธ ูุญููุงู
        saveDataLocally();

        progressBar.style.width = '90%';

        // ุชุญุฏูุซ ุงูุนุฑุถ
        renderData();
        updateTotalStats();

        progressBar.style.width = '100%';

        // ุฅุฒุงูุฉ ุฑุณุงูุฉ ุงูุชุญููู
        setTimeout(() => {
            document.body.removeChild(loadingDiv);

            // ุนุฑุถ ุชูุฑูุฑ ุงููุฌุงุญ
            alert(`๐ ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ!\n\n` +
                  `๐ ุงููุชุงุฆุฌ:\n` +
                  `โข ุงูุจูุงูุงุช ุงูุณุงุจูุฉ: ${oldCount} ูุญุฏุฉ\n` +
                  `โข ุงูุจูุงูุงุช ุงูููุธูุฉ: ${properties.length} ูุญุฏุฉ\n` +
                  `โข ุชู ุญุฐู: ${3832 - properties.length} ูุญุฏุฉ ููุฑุฑุฉ\n` +
                  `โข ูุง ุชูุฌุฏ ูุญุฏุงุช ููุฑุฑุฉ ุงูุขู\n\n` +
                  `โ ุชู ุญู ูุดููุฉ ุงุฎุชูุงุก ุงููุญุฏุงุช ููุงุฆูุงู!`);
        }, 1000);

        console.log(`โ ุชู ุงูุชุญุฏูุซ: ${properties.length} ูุญุฏุฉ ููุธูุฉ`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชุญุฏูุซ:', error);
        alert(`โ ุฎุทุฃ ูู ุงูุชุญุฏูุซ: ${error.message}`);
    }
}

// ุชุดุบูู ุงูุชุญุฏูุซ ุชููุงุฆูุงู
window.updateAfterCleanup = updateAfterCleanup;

// ๐๏ธ ุฏุงูุฉ ุญุฐู ูุญุฏุฉ ูุญุฏุฏุฉ ูุชุญุฏูุซ ุงูุจูุงูุงุช
async function deleteSpecificUnit(unitNumber) {
    console.log(`๐๏ธ ุญุฐู ุงููุญุฏุฉ: ${unitNumber}`);

    if (!supabaseClient) {
        alert('โ Supabase ุบูุฑ ูุชุงุญ!');
        return;
    }

    try {
        // ุงูุจุญุซ ุนู ุงููุญุฏุฉ ูุญููุงู
        const localIndex = properties.findIndex(p => p['ุฑูู  ุงููุญุฏุฉ '] === unitNumber);
        const localUnit = localIndex !== -1 ? properties[localIndex] : null;

        if (localUnit) {
            // ุญุฐู ูู ุงูุจูุงูุงุช ุงููุญููุฉ
            properties.splice(localIndex, 1);
            saveDataLocally();

            // ุชุญุฏูุซ ุงูุนุฑุถ
            renderData();
            updateTotalStats();

            console.log(`โ ุชู ุญุฐู ุงููุญุฏุฉ ${unitNumber} ูู ุงูุจูุงูุงุช ุงููุญููุฉ`);

            // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
            showSuccessMessage(
                'ุชู ุงูุญุฐู!',
                `ุชู ุญุฐู ุงููุญุฏุฉ ${unitNumber} ุจูุฌุงุญ\n` +
                `ุงูุนูุงุฑ: ${localUnit['ุงุณู ุงูุนูุงุฑ'] || 'ุบูุฑ ูุญุฏุฏ'}\n` +
                `ุงูุนุฏุฏ ุงูุญุงูู: ${properties.length} ูุญุฏุฉ`
            );
        } else {
            console.log(`โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ ${unitNumber} ูู ุงูุจูุงูุงุช ุงููุญููุฉ`);

            // ุชุญุฏูุซ ุงูุจูุงูุงุช ูู Supabase ููุชุฃูุฏ
            await updateAfterCleanup();
        }

    } catch (error) {
        console.error(`โ ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุฉ ${unitNumber}:`, error);
        showErrorMessage('ุฎุทุฃ ูู ุงูุญุฐู', error.message);
    }
}

// ุฏุงูุฉ ุณุฑูุนุฉ ูุญุฐู STRU04000
window.deleteSTRU04000 = () => deleteSpecificUnit('STRU04000');

// ๐งช ุฏุงูุฉ ุงุฎุชุจุงุฑ ุชุนุฏูู ุฑูู ุงููุญุฏุฉ
async function testUnitNumberEdit() {
    console.log('๐งช ุงุฎุชุจุงุฑ ุชุนุฏูู ุฑูู ุงููุญุฏุฉ...');

    // ุงูุจุญุซ ุนู ูุญุฏุฉ ููุงุฎุชุจุงุฑ
    const testUnit = properties.find(p => p['ุฑูู  ุงููุญุฏุฉ '] === '8888');
    if (!testUnit) {
        console.log('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุญุฏุฉ 8888 ููุงุฎุชุจุงุฑ');
        return;
    }

    console.log('๐ ุงููุญุฏุฉ ูุจู ุงูุชุนุฏูู:', {
        unitNumber: testUnit['ุฑูู  ุงููุญุฏุฉ '],
        propertyName: testUnit['ุงุณู ุงูุนูุงุฑ'],
        tenant: testUnit['ุงุณู ุงููุณุชุฃุฌุฑ']
    });

    // ุนุฏ ุงููุญุฏุงุช ูุจู ุงูุชุนุฏูู
    const countBefore = properties.length;
    const unitsWithOldNumber = properties.filter(p => p['ุฑูู  ุงููุญุฏุฉ '] === '8888').length;
    const unitsWithNewNumber = properties.filter(p => p['ุฑูู  ุงููุญุฏุฉ '] === '7').length;

    console.log(`๐ ูุจู ุงูุชุนุฏูู: ุงูุนุฏุฏ ุงูููู=${countBefore}, ูุญุฏุงุช ุจุฑูู 8888=${unitsWithOldNumber}, ูุญุฏุงุช ุจุฑูู 7=${unitsWithNewNumber}`);

    // ูุญุงูุงุฉ ุชุนุฏูู ุฑูู ุงููุญุฏุฉ
    const unitIndex = properties.findIndex(p => p['ุฑูู  ุงููุญุฏุฉ '] === '8888');
    if (unitIndex !== -1) {
        // ุชุทุจูู ููุณ ููุทู savePropertyEdit
        const originalUnitNumber = '8888';
        const newUnitNumber = '7';
        const originalPropertyName = testUnit['ุงุณู ุงูุนูุงุฑ'];

        // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูุญุฏุฉ ุฃุฎุฑู ุจููุณ ุงูุฑูู ุงูุฌุฏูุฏ
        const existingUnitWithNewNumber = properties.find(p =>
            p['ุฑูู  ุงููุญุฏุฉ '] === newUnitNumber &&
            p['ุงุณู ุงูุนูุงุฑ'] === originalPropertyName &&
            properties.indexOf(p) !== unitIndex
        );

        if (existingUnitWithNewNumber) {
            console.log(`โ ููุฌุฏ ูุญุฏุฉ ุฃุฎุฑู ุจุฑูู "${newUnitNumber}" ูู ููุณ ุงูุนูุงุฑ!`);
            return;
        }

        // ุญูุธ ุจูุงูุงุช ุงููุญุฏุฉ ุงููุฏููุฉ ููุญุฐู ูู Supabase
        const oldUnitDataForSupabase = { ...properties[unitIndex] };

        // ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ูู Supabase
        if (typeof deletePropertyFromSupabase === 'function') {
            try {
                console.log(`โ๏ธ ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ุจุฑูู "${originalUnitNumber}" ูู Supabase...`);
                const deleteResult = await deletePropertyFromSupabase(oldUnitDataForSupabase);
                console.log('๐ ูุชูุฌุฉ ุงูุญุฐู:', deleteResult);
            } catch (error) {
                console.error(`โ ุฎุทุฃ ูู ุญุฐู ุงููุญุฏุฉ ุงููุฏููุฉ ูู Supabase:`, error);
            }
        }

        // ุชุญุฏูุซ ุงููุญุฏุฉ ุงููุญููุฉ ุจุฑูู ุงููุญุฏุฉ ุงูุฌุฏูุฏ
        const newUnitData = { ...properties[unitIndex], 'ุฑูู  ุงููุญุฏุฉ ': newUnitNumber };
        properties[unitIndex] = newUnitData;

        // ุนุฏ ุงููุญุฏุงุช ุจุนุฏ ุงูุชุนุฏูู
        const countAfter = properties.length;
        const unitsWithOldNumberAfter = properties.filter(p => p['ุฑูู  ุงููุญุฏุฉ '] === '8888').length;
        const unitsWithNewNumberAfter = properties.filter(p => p['ุฑูู  ุงููุญุฏุฉ '] === '7').length;

        console.log(`๐ ุจุนุฏ ุงูุชุนุฏูู: ุงูุนุฏุฏ ุงูููู=${countAfter}, ูุญุฏุงุช ุจุฑูู 8888=${unitsWithOldNumberAfter}, ูุญุฏุงุช ุจุฑูู 7=${unitsWithNewNumberAfter}`);

        // ุญูุธ ุงูุจูุงูุงุช ูุญููุงู
        saveDataLocally();

        // ุชุญุฏูุซ ุงูุนุฑุถ
        renderData();
        updateTotalStats();

        console.log('โ ุชู ุงุฎุชุจุงุฑ ุชุนุฏูู ุฑูู ุงููุญุฏุฉ ุจูุฌุงุญ!');

        // ุนุฑุถ ุงููุชุงุฆุฌ
        alert(`๐งช ูุชุงุฆุฌ ุงุฎุชุจุงุฑ ุชุนุฏูู ุฑูู ุงููุญุฏุฉ:\n\n` +
              `ูุจู ุงูุชุนุฏูู:\n` +
              `โข ุงูุนุฏุฏ ุงูููู: ${countBefore}\n` +
              `โข ูุญุฏุงุช ุจุฑูู 8888: ${unitsWithOldNumber}\n` +
              `โข ูุญุฏุงุช ุจุฑูู 7: ${unitsWithNewNumber}\n\n` +
              `ุจุนุฏ ุงูุชุนุฏูู:\n` +
              `โข ุงูุนุฏุฏ ุงูููู: ${countAfter}\n` +
              `โข ูุญุฏุงุช ุจุฑูู 8888: ${unitsWithOldNumberAfter}\n` +
              `โข ูุญุฏุงุช ุจุฑูู 7: ${unitsWithNewNumberAfter}\n\n` +
              `${countAfter === countBefore && unitsWithOldNumberAfter === 0 && unitsWithNewNumberAfter === 1 ? 'โ ูุฌุญ ุงูุงุฎุชุจุงุฑ!' : 'โ ูุดู ุงูุงุฎุชุจุงุฑ!'}`);
    }
}

// ุชุดุบูู ุงูุงุฎุชุจุงุฑ
window.testUnitNumberEdit = testUnitNumberEdit;

// ๐ ุฏุงูุฉ ุงุณุชุฑุฏุงุฏ ูุงููุฉ ูููุฑูุฉ ูุฌููุน ุงูุจูุงูุงุช
async function fullDataRecovery() {
    console.log('๐ ุจุฏุก ุงูุงุณุชุฑุฏุงุฏ ุงููุงูู ูู Supabase...');

    if (!supabaseClient) {
        alert('โ Supabase ุบูุฑ ูุชุงุญ!');
        return;
    }

    const confirmRestore = confirm(
        `๐ ุงูุงุณุชุฑุฏุงุฏ ุงููุงูู ููุจูุงูุงุช\n\n` +
        `ุงูุจูุงูุงุช ุงูุญุงููุฉ: ${properties.length} ูุญุฏุฉ\n` +
        `ุณูุชู ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ูู Supabase (ุญูุงูู 3800+ ูุญุฏุฉ)\n\n` +
        `ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ`
    );

    if (!confirmRestore) return;

    try {
        // ุฅูุดุงุก ูุงูุฐุฉ ุชูุฏู ูุญุณูุฉ
        const progressModal = document.createElement('div');
        progressModal.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                        align-items: center; justify-content: center;">
                <div style="background: white; padding: 40px; border-radius: 15px;
                           box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
                           min-width: 400px;">
                    <h2 style="margin: 0 0 20px 0; color: #007bff;">๐ ุงุณุชุฑุฏุงุฏ ุงูุจูุงูุงุช</h2>
                    <div id="recoveryStatus" style="font-size: 16px; margin-bottom: 20px; color: #333;">
                        ุฌุงุฑู ุงูุงุชุตุงู ุจู Supabase...
                    </div>
                    <div style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                        <div id="recoveryProgress" style="width: 0%; height: 100%;
                                                          background: linear-gradient(90deg, #28a745, #20c997);
                                                          transition: width 0.3s ease;"></div>
                    </div>
                    <div id="recoveryDetails" style="font-size: 14px; color: #666;">
                        ุฌุงุฑู ุงูุชุญุถูุฑ...
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(progressModal);

        const statusEl = document.getElementById('recoveryStatus');
        const progressEl = document.getElementById('recoveryProgress');
        const detailsEl = document.getElementById('recoveryDetails');

        // ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ุนูู ุฏูุนุงุช
        statusEl.textContent = 'ุฌูุจ ุงูุจูุงูุงุช ูู Supabase...';
        progressEl.style.width = '10%';

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchCount = 0;

        while (hasMore) {
            batchCount++;
            detailsEl.textContent = `ุงูุฏูุนุฉ ${batchCount} - ุชู ุฌูุจ ${allData.length} ูุญุฏุฉ`;

            const { data: batchData, error } = await supabaseClient
                .from('properties')
                .select('*')
                .range(from, from + batchSize - 1)
                .order('id', { ascending: true });

            if (error) {
                throw new Error(`ุฎุทุฃ ูู ุงูุฏูุนุฉ ${batchCount}: ${error.message}`);
            }

            if (batchData && batchData.length > 0) {
                allData.push(...batchData);
                from += batchSize;
                hasMore = batchData.length === batchSize;

                // ุชุญุฏูุซ ุงูุชูุฏู
                const progress = Math.min(10 + (allData.length / 4000) * 70, 80);
                progressEl.style.width = `${progress}%`;

                console.log(`๐ฆ ุฏูุนุฉ ${batchCount}: ${batchData.length} ูุญุฏุฉ (ุงูุฅุฌูุงูู: ${allData.length})`);
            } else {
                hasMore = false;
            }

            // ุชุฃุฎูุฑ ูุตูุฑ ูุชุฌูุจ ุฅุฑูุงู ุงูุฎุงุฏู
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        statusEl.textContent = 'ูุนุงูุฌุฉ ุงูุจูุงูุงุช...';
        progressEl.style.width = '85%';
        detailsEl.textContent = `ุชู ุฌูุจ ${allData.length} ูุญุฏุฉ - ุฌุงุฑู ุงููุนุงูุฌุฉ...`;

        // ุญูุธ ุงูุจูุงูุงุช ุงููุฏููุฉ ููุณุฎุฉ ุงุญุชูุงุทูุฉ
        const oldData = [...properties];
        localStorage.setItem('properties_backup_before_recovery', JSON.stringify(oldData));

        // ุงุณุชุจุฏุงู ุงูุจูุงูุงุช
        properties.length = 0;
        properties.push(...allData);

        statusEl.textContent = 'ุญูุธ ุงูุจูุงูุงุช...';
        progressEl.style.width = '95%';

        // ุญูุธ ูุญููุงู
        saveDataLocally();

        statusEl.textContent = 'ุชุญุฏูุซ ุงูุนุฑุถ...';
        progressEl.style.width = '100%';

        // ุชุญุฏูุซ ุงูุนุฑุถ
        renderData();
        updateTotalStats();

        // ุฅุฒุงูุฉ ูุงูุฐุฉ ุงูุชูุฏู
        document.body.removeChild(progressModal);

        // ุฑุณุงูุฉ ุงููุฌุงุญ
        alert(`โ ุชู ุงูุงุณุชุฑุฏุงุฏ ุงููุงูู ุจูุฌุงุญ!\n\n` +
              `ุงูุจูุงูุงุช ุงูุณุงุจูุฉ: ${oldData.length} ูุญุฏุฉ\n` +
              `ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ: ${properties.length} ูุญุฏุฉ\n` +
              `ุชู ุงุณุชุฑุฏุงุฏ: ${properties.length - oldData.length} ูุญุฏุฉ ุฅุถุงููุฉ\n\n` +
              `ุชู ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงูุจูุงูุงุช ุงูุณุงุจูุฉ`);

        console.log(`โ ุงูุชูู ุงูุงุณุชุฑุฏุงุฏ: ${properties.length} ูุญุฏุฉ`);

    } catch (error) {
        // ุฅุฒุงูุฉ ูุงูุฐุฉ ุงูุชูุฏู ูู ุญุงูุฉ ุงูุฎุทุฃ
        const modal = document.querySelector('[style*="position: fixed"]');
        if (modal) {
            document.body.removeChild(modal);
        }

        console.error('โ ุฎุทุฃ ูู ุงูุงุณุชุฑุฏุงุฏ ุงููุงูู:', error);
        alert(`โ ูุดู ูู ุงูุงุณุชุฑุฏุงุฏ ุงููุงูู:\n${error.message}`);
    }
}

// ๐จ ุงุณุชุฑุฏุงุฏ ููุฑู ููุงูู ูู Supabase
async function recoverDeletedData() {
    console.log('๐ ุจุฏุก ุงูุงุณุชุฑุฏุงุฏ ุงูููุฑู ูู Supabase...');

    if (!supabaseClient) {
        alert('โ Supabase ุบูุฑ ูุชุงุญ!');
        return;
    }

    const confirmRestore = confirm(
        '๐จ ูุฐุง ุณูุณุชุจุฏู ุฌููุน ุงูุจูุงูุงุช ุงููุญููุฉ ุจุงูุจูุงูุงุช ูู Supabase\n\n' +
        'ูู ุฃูุช ูุชุฃูุฏ ูู ุงููุชุงุจุนุฉุ'
    );

    if (!confirmRestore) return;

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        const loadingMessage = document.createElement('div');
        loadingMessage.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        z-index: 10000; text-align: center;">
                <div style="font-size: 18px; margin-bottom: 15px;">๐ ุฌุงุฑู ุงูุงุณุชุฑุฏุงุฏ ูู Supabase...</div>
                <div style="width: 300px; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #007bff, #0056b3);
                                                  transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="margin-top: 10px; color: #666;">ุฌุงุฑู ุงูุชุญููู...</div>
            </div>
        `;
        document.body.appendChild(loadingMessage);

        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        // ุชุญุฏูุซ ุงูุชูุฏู
        progressBar.style.width = '20%';
        progressText.textContent = 'ุงูุงุชุตุงู ุจู Supabase...';

        console.log('๐ก ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ูู Supabase...');

        // ุฌูุจ ุงูุจูุงูุงุช ุนูู ุฏูุนุงุช ูุถูุงู ุงูุญุตูู ุนูู ุฌููุน ุงูุจูุงูุงุช
        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;

        while (hasMore) {
            progressText.textContent = `ุฌูุจ ุงูุจูุงูุงุช... (${allData.length} ูุญุฏุฉ)`;

            const { data: batchData, error } = await supabaseClient
                .from('properties')
                .select('*')
                .range(from, from + batchSize - 1)
                .order('created_at', { ascending: false });

            if (error) {
                throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช: ${error.message}`);
            }

            if (batchData && batchData.length > 0) {
                allData.push(...batchData);
                from += batchSize;
                hasMore = batchData.length === batchSize;

                // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
                const progress = Math.min(60 + (allData.length / 4000) * 20, 80);
                progressBar.style.width = `${progress}%`;
            } else {
                hasMore = false;
            }
        }

        const supabaseData = allData;

        progressBar.style.width = '60%';
        progressText.textContent = 'ูุนุงูุฌุฉ ุงูุจูุงูุงุช...';

        if (error) {
            throw new Error(`ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ูู Supabase: ${error.message}`);
        }

        if (!supabaseData || supabaseData.length === 0) {
            throw new Error('ูุง ุชูุฌุฏ ุจูุงูุงุช ูู Supabase ููุงุณุชุฑุฏุงุฏ');
        }

        console.log(`๐ ุชู ุฌูุจ ${supabaseData.length} ูุญุฏุฉ ูู Supabase`);

        progressBar.style.width = '80%';
        progressText.textContent = 'ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ...';

        // ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ุจุงููุงูู
        const oldCount = properties.length;
        properties.length = 0; // ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ
        properties.push(...supabaseData); // ุฅุถุงูุฉ ุจูุงูุงุช Supabase

        // ุญูุธ ูุญููุงู
        saveDataLocally();

        progressBar.style.width = '100%';
        progressText.textContent = 'ุชุญุฏูุซ ุงูุนุฑุถ...';

        // ุชุญุฏูุซ ุงูุนุฑุถ
        renderData();
        updateTotalStats();

        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู
        document.body.removeChild(loadingMessage);

        // ุฑุณุงูุฉ ุงููุฌุงุญ
        alert(`โ ุชู ุงูุงุณุชุฑุฏุงุฏ ุจูุฌุงุญ!\n\n` +
              `ุงูุจูุงูุงุช ุงููุฏููุฉ: ${oldCount} ูุญุฏุฉ\n` +
              `ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ: ${properties.length} ูุญุฏุฉ\n` +
              `ุงููุฑู: ${properties.length - oldCount > 0 ? '+' : ''}${properties.length - oldCount} ูุญุฏุฉ`);

        console.log(`โ ุชู ุงุณุชุฑุฏุงุฏ ${properties.length} ูุญุฏุฉ ูู Supabase ุจูุฌุงุญ`);

    } catch (error) {
        // ุฅุฒุงูุฉ ูุคุดุฑ ุงูุชุญููู ูู ุญุงูุฉ ุงูุฎุทุฃ
        const loadingElement = document.querySelector('[style*="position: fixed"]');
        if (loadingElement) {
            document.body.removeChild(loadingElement.parentElement || loadingElement);
        }

        console.error('โ ุฎุทุฃ ูู ุงูุงุณุชุฑุฏุงุฏ:', error);
        alert(`โ ูุดู ูู ุงูุงุณุชุฑุฏุงุฏ:\n${error.message}`);
    }
}

// ุฅุถุงูุฉ ุงูุฏูุงู ุงูููููุฏุฉ ูููุงูุฐุฉ ุงูุนุงูุฉ
window.fullDataRecovery = fullDataRecovery;
window.recoverDeletedData = recoverDeletedData;

// ===== SUPABASE HELPER FUNCTIONS =====

// Convert JSON property data to Supabase format
function convertPropertyToSupabaseFormat(jsonProperty) {
    return {
        unit_number: jsonProperty['ุฑูู  ุงููุญุฏุฉ '] || '',
        city: jsonProperty['ุงููุฏููุฉ'] || '',
        property_name: jsonProperty['ุงุณู ุงูุนูุงุฑ'] || '',
        property_location: jsonProperty['ูููุน ุงูุนูุงุฑ'] || '',
        height: jsonProperty['ุงูุงุฑุชูุงุน'] || null,
        deed_number: jsonProperty['ุฑูู ุงูุตู'] || '',
        real_estate_registry: jsonProperty['ุงูุณุฌู ุงูุนููู '] || null,
        deed_area: jsonProperty['ูุณุงุญุฉุงูุตู'] || '',
        owner: jsonProperty['ุงููุงูู'] || '',
        tenant_name: jsonProperty['ุงุณู ุงููุณุชุฃุฌุฑ'] || null,
        tenant_phone: jsonProperty['ุฑูู ุฌูุงู ุงููุณุชุฃุฌุฑ'] || null,
        tenant_phone_2: jsonProperty['ุฑูู ุฌูุงู ุฅุถุงูู'] || null,
        contract_number: jsonProperty['ุฑูู ุงูุนูุฏ'] || null,
        rent_value: parseFloat(jsonProperty['ูููุฉ  ุงูุงูุฌุงุฑ ']) || null,
        area: parseFloat(jsonProperty['ุงููุณุงุญุฉ']) || null,
        start_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงูุจุฏุงูุฉ']) || null,
        end_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงูููุงูุฉ']) || null,
        total_amount: parseFloat(jsonProperty['ุงูุงุฌูุงูู']) || null,
        electricity_account: jsonProperty['ุฑูู ุญุณุงุจ ุงูููุฑุจุงุก'] || null,
        remaining_installments: parseInt(jsonProperty['ุนุฏุฏ ุงูุงูุณุงุท ุงููุชุจููุฉ']) || null,
        installment_count: parseInt(jsonProperty['ุนุฏุฏ ุงูุงูุณุงุท']) || null,

        // ุญูุธ ุฌููุน ุงูุฃูุณุงุท (ุญุชู 10 ุฃูุณุงุท)
        first_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุงูู']) || null,
        first_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุงูู']) || null,
        second_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู']) || null,
        second_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุซุงูู']) || null,
        third_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูุซ']) || null,
        third_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุซุงูุซ']) || null,
        fourth_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุฑุงุจุน']) || null,
        fourth_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุฑุงุจุน']) || null,
        fifth_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุฎุงูุณ']) || null,
        fifth_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุฎุงูุณ']) || null,
        sixth_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุณุงุฏุณ']) || null,
        sixth_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุณุงุฏุณ']) || null,
        seventh_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุณุงุจุน']) || null,
        seventh_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุณุงุจุน']) || null,
        eighth_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุซุงูู']) || null,
        eighth_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุซุงูู']) || null,
        ninth_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุชุงุณุน']) || null,
        ninth_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุชุงุณุน']) || null,
        tenth_installment_date: parseDate(jsonProperty['ุชุงุฑูุฎ ุงููุณุท ุงูุนุงุดุฑ']) || null,
        tenth_installment_amount: parseFloat(jsonProperty['ูุจูุบ ุงููุณุท ุงูุนุงุดุฑ']) || null,

        contract_type: jsonProperty['ููุน ุงูุนูุฏ'] || 'ุณููู',
        last_update_date: jsonProperty['ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ'] || null,
        update_type: jsonProperty['ููุน ุงูุชุญุฏูุซ'] || null,
        update_responsible: jsonProperty['ุงููุณุคูู ุนู ุงูุชุญุฏูุซ'] || null,
        installment_end_date: parseDate(jsonProperty['ุชุงุฑูุฎ ููุงูุฉ ุงููุณุท']) || null
    };
}

// Parse date from Arabic format to ISO format
function parseDate(dateStr) {
    if (!dateStr || dateStr === '' || dateStr === null) {
        return null;
    }

    try {
        // Handle dd/mm/yyyy format
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const year = parseInt(parts[2]);

                if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const date = new Date(year, month - 1, day);
                    return date.toISOString().split('T')[0]; // Return YYYY-MM-DD format
                }
            }
        }

        // Handle ISO format (YYYY-MM-DD)
        if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return dateStr;
        }

        console.warn(`Could not parse date: ${dateStr}`);
        return null;
    } catch (error) {
        console.warn(`Error parsing date ${dateStr}:`, error);
        return null;
    }
}

// Add new property to Supabase
async function addProperty(propertyData) {
    try {
        console.log('โ ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...');

        const { data, error } = await supabaseClient
            .from('properties')
            .insert([propertyData])
            .select();

        if (error) {
            console.error('โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุนูุงุฑ:', error);
            throw new Error(`ูุดู ูู ุฅุถุงูุฉ ุงูุนูุงุฑ: ${error.message}`);
        }

        console.log('โ ุชู ุฅุถุงูุฉ ุงูุนูุงุฑ ุจูุฌุงุญ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
        return data[0];
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู addProperty:', error);
        throw error;
    }
}

// Update property in Supabase
async function updateProperty(id, updates) {
    try {
        const { data, error } = await supabaseClient
            .from('properties')
            .update({ ...updates, updated_at: new Date().toISOString() })
            .eq('id', id)
            .select();

        if (error) {
            console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนูุงุฑ:', error);
            throw new Error(`ูุดู ูู ุชุญุฏูุซ ุงูุนูุงุฑ: ${error.message}`);
        }

        console.log('โ ุชู ุชุญุฏูุซ ุงูุนูุงุฑ ุจูุฌุงุญ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
        return data[0];
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู updateProperty:', error);
        throw error;
    }
}

// ===== SUPABASE SAVE PROPERTY FUNCTION =====

// Save property changes to Supabase when data is modified
async function savePropertyToSupabase(property) {
    try {
        if (!supabaseClient) {
            console.warn('โ๏ธ Supabase ุบูุฑ ูุชุตูุ ุชุฎุทู ุงูุญูุธ ุงูุณุญุงุจู');
            return false;
        }

        console.log('๐ ุจุฏุก ุญูุธ ุงูุนูุงุฑ ูู Supabase...');
        console.log('๐ ุจูุงูุงุช ุงูุนูุงุฑ:', {
            unitNumber: property['ุฑูู  ุงููุญุฏุฉ '],
            propertyName: property['ุงุณู ุงูุนูุงุฑ'],
            tenant: property['ุงุณู ุงููุณุชุฃุฌุฑ']
        });

        // Convert original format to Supabase format
        const supabaseProperty = convertPropertyToSupabaseFormat(property);

        // Check if property exists (by unit_number AND property_name for uniqueness)
        console.log('๐ ุงูุจุญุซ ุนู ุงูุนูุงุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...');
        const { data: existingProperty, error: searchError } = await supabaseClient
            .from('properties')
            .select('id')
            .eq('unit_number', supabaseProperty.unit_number)
            .eq('property_name', supabaseProperty.property_name)
            .single();

        if (searchError && searchError.code !== 'PGRST116') {
            console.error('โ ุฎุทุฃ ูู ุงูุจุญุซ ุนู ุงูุนูุงุฑ:', searchError);
            throw new Error(`ูุดู ูู ุงูุจุญุซ ุนู ุงูุนูุงุฑ: ${searchError.message}`);
        }

        if (existingProperty) {
            // Update existing property
            console.log('๐ ุชุญุฏูุซ ุนูุงุฑ ููุฌูุฏุ ID:', existingProperty.id);
            const result = await updateProperty(existingProperty.id, supabaseProperty);
            console.log('โ ุชู ุชุญุฏูุซ ุงูุนูุงุฑ ูู Supabase:', supabaseProperty.unit_number);
            return result;
        } else {
            // Add new property
            console.log('โ ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ...');
            const result = await addProperty(supabaseProperty);
            console.log('โ ุชู ุฅุถุงูุฉ ุงูุนูุงุฑ ุฅูู Supabase:', supabaseProperty.unit_number);
            return result;
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุนูุงุฑ ูู Supabase:', error);
        console.error('๐ ุชูุงุตูู ุงูุฎุทุฃ:', {
            message: error.message,
            code: error.code,
            details: error.details,
            hint: error.hint
        });

        // ุฅุฑุฌุงุน false ุจุฏูุงู ูู ุฑูู ุงูุฎุทุฃ ูููุน ูุดู ุงูุนูููุฉ ุจุงููุงูู
        return false;
    }
}

// ุฅุถุงูุฉ ูุณุชูุน ูุชุญููู ุงูุตูุญุฉ ูุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู
document.addEventListener('DOMContentLoaded', function() {
    console.log('๐ ุจุฏุก ุชุญููู ุงูุชุทุจูู...');

    // ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู ุงูุจููุฑูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        console.log('๐ฎ ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู ุนูุฏ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ');
        showCrystalLoading();
    }

    // ุงูุชุญูู ูู ุงููุตุงุฏูุฉ ุฃููุงู
    checkAuthentication();

    // ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ุจุนุฏ ุชุฃุฎูุฑ
    setTimeout(() => {
        addLogoutButton();
    }, 1000);
});