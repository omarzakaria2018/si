<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 اختبار إضافة وحدة للعقار</title>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            border-radius: 10px;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .result.success { border-left-color: #28a745; background: #d4edda; }
        .result.error { border-left-color: #dc3545; background: #f8d7da; }
        .result.warning { border-left-color: #ffc107; background: #fff3cd; }
        .result.info { border-left-color: #17a2b8; background: #d1ecf1; }
        
        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #e0a800); }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); }
        
        .solution-demo {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .property-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-home"></i> اختبار إضافة وحدة للعقار</h1>
            <p>التأكد من أن العقارات بدون وحدات تظهر في قائمة إضافة الوحدات</p>
        </div>

        <div class="solution-demo">
            <h3><i class="fas fa-lightbulb"></i> الحل المطبق:</h3>
            <ul>
                <li>✅ <strong>دالة getUniqueProperties محسنة:</strong> تبحث في properties و propertyDefinitions</li>
                <li>✅ <strong>دالة addNewUnit محسنة:</strong> تبحث في المصدرين للعثور على العقار</li>
                <li>✅ <strong>القائمة المنسدلة شاملة:</strong> تعرض جميع العقارات حتى بدون وحدات</li>
                <li>✅ <strong>إضافة وحدة نظيفة:</strong> بدون مشاكل أو أخطاء</li>
            </ul>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-plus"></i> اختبار 1: إضافة عقار بدون وحدات</h2>
            <p>إضافة عقار جديد في propertyDefinitions فقط</p>
            <button onclick="testAddProperty()" class="btn-success">
                <i class="fas fa-plus"></i> إضافة عقار تجريبي
            </button>
            <div id="addPropertyResults"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-list"></i> اختبار 2: فحص قائمة العقارات</h2>
            <p>التأكد من ظهور العقار في قائمة إضافة الوحدات</p>
            <button onclick="testPropertyList()" class="btn-warning">
                <i class="fas fa-list"></i> فحص القائمة
            </button>
            <div id="propertyListResults"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-search"></i> اختبار 3: محاكاة البحث عن العقار</h2>
            <p>اختبار دالة addNewUnit المحسنة للبحث في المصدرين</p>
            <button onclick="testFindProperty()" class="btn-warning">
                <i class="fas fa-search"></i> اختبار البحث
            </button>
            <div id="findPropertyResults"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-home"></i> اختبار 4: إضافة وحدة للعقار</h2>
            <p>محاكاة إضافة وحدة للعقار الذي بدون وحدات</p>
            <button onclick="testAddUnit()" class="btn-warning">
                <i class="fas fa-home"></i> إضافة وحدة
            </button>
            <div id="addUnitResults"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-copy"></i> اختبار 4.5: فحص التكرار</h2>
            <p>التحقق من عدم تكرار العقار في المصدرين بعد إضافة الوحدة</p>
            <button onclick="testDuplication()" class="btn-warning">
                <i class="fas fa-copy"></i> فحص التكرار
            </button>
            <div id="duplicationResults"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-trash"></i> اختبار 5: تنظيف البيانات التجريبية</h2>
            <p>حذف البيانات التجريبية المضافة</p>
            <button onclick="cleanupTestData()" class="btn-danger">
                <i class="fas fa-trash"></i> تنظيف البيانات
            </button>
            <div id="cleanupResults"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-file-alt"></i> تقرير الاختبار النهائي</h2>
            <button onclick="generateFinalReport()" class="btn-success">
                <i class="fas fa-file-alt"></i> إنشاء تقرير شامل
            </button>
            <div id="finalReport"></div>
        </div>
    </div>

    <!-- تحميل الملفات المطلوبة -->
    <script src="script.js"></script>
    
    <script>
        // متغيرات الاختبار
        let testResults = {
            addProperty: null,
            propertyList: null,
            findProperty: null,
            addUnit: null,
            duplication: null,
            cleanup: null
        };
        
        let testPropertyName = 'عقار اختبار الوحدة ' + Date.now();
        let testCityName = 'الرياض';
        let testUnitNumber = 'A101';

        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <strong><i class="fas fa-${getIcon(type)}"></i> ${title}</strong><br>
                ${content}
            `;
            container.appendChild(resultDiv);
            container.scrollTop = container.scrollHeight;
        }

        function getIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'times-circle';
                case 'warning': return 'exclamation-triangle';
                case 'info': return 'info-circle';
                default: return 'circle';
            }
        }

        // اختبار 1: إضافة عقار بدون وحدات
        function testAddProperty() {
            addResult('addPropertyResults', 'info', 'بدء إضافة العقار', 'جاري إضافة عقار تجريبي بدون وحدات...');
            
            try {
                // التأكد من وجود المصفوفات المطلوبة
                if (typeof window.properties === 'undefined') {
                    window.properties = [];
                }
                if (typeof window.propertyDefinitions === 'undefined') {
                    window.propertyDefinitions = [];
                }
                
                const propertiesCountBefore = window.properties.length;
                const definitionsCountBefore = window.propertyDefinitions.length;
                
                addResult('addPropertyResults', 'info', 'حالة البيانات قبل الإضافة', 
                    `الوحدات: ${propertiesCountBefore}, التعريفات: ${definitionsCountBefore}`);
                
                // إضافة العقار للتعريفات فقط (محاكاة دالة addNewProperty الجديدة)
                const propertyDefinition = {
                    name: testPropertyName,
                    city: testCityName,
                    deed: '12345',
                    area: '500',
                    registry: '67890',
                    location: 'موقع اختبار',
                    owner: 'مالك اختبار',
                    createdAt: new Date().toISOString()
                };
                
                // إضافة للتعريفات فقط (بدون إضافة وحدة)
                window.propertyDefinitions.push(propertyDefinition);
                localStorage.setItem('propertyDefinitions', JSON.stringify(window.propertyDefinitions));
                
                const propertiesCountAfter = window.properties.length;
                const definitionsCountAfter = window.propertyDefinitions.length;
                
                addResult('addPropertyResults', 'info', 'حالة البيانات بعد الإضافة', 
                    `الوحدات: ${propertiesCountAfter}, التعريفات: ${definitionsCountAfter}`);
                
                // التحقق من النتائج
                const noUnitsAdded = propertiesCountAfter === propertiesCountBefore;
                const definitionAdded = definitionsCountAfter > definitionsCountBefore;
                
                if (noUnitsAdded && definitionAdded) {
                    addResult('addPropertyResults', 'success', 'نجح الاختبار! ✅', 
                        `تم إضافة العقار "${testPropertyName}" في التعريفات فقط بدون وحدات`);
                    testResults.addProperty = true;
                } else {
                    addResult('addPropertyResults', 'error', 'فشل الاختبار! ❌', 
                        `وحدات مضافة: ${!noUnitsAdded}, تعريف مضاف: ${definitionAdded}`);
                    testResults.addProperty = false;
                }
                
            } catch (error) {
                addResult('addPropertyResults', 'error', 'خطأ في إضافة العقار',
                    `خطأ: ${error.message}`);
                testResults.addProperty = false;
            }
        }

        // اختبار 2: فحص قائمة العقارات
        function testPropertyList() {
            addResult('propertyListResults', 'info', 'بدء فحص القائمة', 'جاري فحص قائمة العقارات المتاحة...');

            try {
                // اختبار دالة getUniqueProperties
                let uniqueProperties = [];
                if (typeof getUniqueProperties === 'function') {
                    uniqueProperties = getUniqueProperties();
                    addResult('propertyListResults', 'info', 'نتيجة getUniqueProperties',
                        `تم العثور على ${uniqueProperties.length} عقار`);
                } else {
                    addResult('propertyListResults', 'warning', 'دالة getUniqueProperties غير موجودة',
                        'الدالة غير معرفة في النظام');
                }

                // التحقق من وجود العقار التجريبي
                const testPropertyFound = uniqueProperties.includes(testPropertyName);

                // عرض قائمة العقارات
                let html = '<div class="data-display"><h4>العقارات المتاحة:</h4>';
                uniqueProperties.forEach((propertyName, index) => {
                    const isTestProperty = propertyName === testPropertyName;
                    html += `
                        <div class="property-item" style="${isTestProperty ? 'background: #d4edda; border-color: #28a745;' : ''}">
                            <span>${index + 1}. ${propertyName}</span>
                            ${isTestProperty ? '<span style="color: #28a745; font-weight: bold;">عقار الاختبار</span>' : '<i class="fas fa-building" style="color: #007bff;"></i>'}
                        </div>
                    `;
                });
                html += '</div>';

                if (testPropertyFound) {
                    addResult('propertyListResults', 'success', 'نجح فحص القائمة! ✅',
                        `العقار التجريبي "${testPropertyName}" يظهر في قائمة العقارات`);
                    testResults.propertyList = true;
                } else {
                    addResult('propertyListResults', 'error', 'فشل فحص القائمة! ❌',
                        'العقار التجريبي لا يظهر في القائمة');
                    testResults.propertyList = false;
                }

                addResult('propertyListResults', 'info', 'قائمة العقارات', html);

            } catch (error) {
                addResult('propertyListResults', 'error', 'خطأ في فحص القائمة',
                    `خطأ: ${error.message}`);
                testResults.propertyList = false;
            }
        }

        // اختبار 3: محاكاة البحث عن العقار
        function testFindProperty() {
            addResult('findPropertyResults', 'info', 'بدء اختبار البحث', 'جاري محاكاة البحث عن العقار في addNewUnit...');

            try {
                const propertyName = testPropertyName;

                // محاكاة دالة addNewUnit المحسنة
                // 1. البحث في properties أولاً
                let baseProperty = window.properties ?
                    window.properties.find(p => p['اسم العقار'] === propertyName) : null;

                addResult('findPropertyResults', 'info', 'البحث في properties',
                    `النتيجة: ${baseProperty ? 'موجود' : 'غير موجود'}`);

                // 2. إذا لم يوجد، البحث في propertyDefinitions
                if (!baseProperty) {
                    const propertyDefinition = window.propertyDefinitions ?
                        window.propertyDefinitions.find(p => p.name === propertyName) : null;

                    addResult('findPropertyResults', 'info', 'البحث في propertyDefinitions',
                        `النتيجة: ${propertyDefinition ? 'موجود' : 'غير موجود'}`);

                    if (propertyDefinition) {
                        // تحويل تعريف العقار إلى تنسيق properties
                        baseProperty = {
                            'اسم العقار': propertyDefinition.name,
                            'المدينة': propertyDefinition.city,
                            'رقم الصك': propertyDefinition.deed,
                            'مساحةالصك': propertyDefinition.area,
                            'السجل العيني ': propertyDefinition.registry,
                            'موقع العقار': propertyDefinition.location,
                            'المالك': propertyDefinition.owner,
                            // قيم افتراضية للحقول المطلوبة
                            'الارتفاع': null,
                            'اسم المستأجر': null,
                            'رقم العقد': null,
                            'قيمة  الايجار ': null,
                            'تاريخ البداية': null,
                            'تاريخ النهاية': null,
                            'الاجمالى': 0.0,
                            'رقم حساب الكهرباء': null,
                            'عدد الاقساط المتبقية': null,
                            'تاريخ القسط الاول': null,
                            'مبلغ القسط الاول': null,
                            'تاريخ القسط الثاني': null,
                            'مبلغ القسط الثاني': null,
                            'تاريخ نهاية القسط': null,
                            'نوع العقد': 'سكني'
                        };

                        addResult('findPropertyResults', 'success', 'تم تحويل التعريف! ✅',
                            'تم تحويل تعريف العقار إلى تنسيق properties بنجاح');
                    }
                }

                // النتيجة النهائية
                if (baseProperty) {
                    addResult('findPropertyResults', 'success', 'نجح اختبار البحث! ✅',
                        `تم العثور على العقار "${propertyName}" وتحويله للتنسيق المطلوب`);
                    testResults.findProperty = true;

                    // عرض تفاصيل العقار
                    let html = '<div class="data-display"><h4>تفاصيل العقار الموجود:</h4>';
                    html += `<p><strong>اسم العقار:</strong> ${baseProperty['اسم العقار']}</p>`;
                    html += `<p><strong>المدينة:</strong> ${baseProperty['المدينة']}</p>`;
                    html += `<p><strong>المالك:</strong> ${baseProperty['المالك']}</p>`;
                    html += `<p><strong>رقم الصك:</strong> ${baseProperty['رقم الصك']}</p>`;
                    html += '</div>';

                    addResult('findPropertyResults', 'info', 'تفاصيل العقار', html);
                } else {
                    addResult('findPropertyResults', 'error', 'فشل اختبار البحث! ❌',
                        'لم يتم العثور على العقار في أي من المصدرين');
                    testResults.findProperty = false;
                }

            } catch (error) {
                addResult('findPropertyResults', 'error', 'خطأ في اختبار البحث',
                    `خطأ: ${error.message}`);
                testResults.findProperty = false;
            }
        }

        // اختبار 4.5: فحص التكرار
        function testDuplication() {
            addResult('duplicationResults', 'info', 'بدء فحص التكرار', 'جاري فحص تكرار العقار في المصدرين...');

            try {
                const propertyName = testPropertyName;

                // فحص وجود العقار في properties
                const inProperties = window.properties ?
                    window.properties.filter(p => p['اسم العقار'] === propertyName) : [];

                // فحص وجود العقار في propertyDefinitions
                const inDefinitions = window.propertyDefinitions ?
                    window.propertyDefinitions.filter(p => p.name === propertyName) : [];

                addResult('duplicationResults', 'info', 'نتائج البحث',
                    `في properties: ${inProperties.length} عنصر<br>في propertyDefinitions: ${inDefinitions.length} عنصر`);

                // التحقق من التكرار
                const totalCount = inProperties.length + inDefinitions.length;
                const hasUnits = inProperties.length > 0;
                const hasDefinition = inDefinitions.length > 0;

                if (hasUnits && hasDefinition) {
                    addResult('duplicationResults', 'error', 'تم اكتشاف تكرار! ❌',
                        `العقار موجود في المصدرين:<br>- properties: ${inProperties.length} وحدة<br>- propertyDefinitions: ${inDefinitions.length} تعريف`);
                    testResults.duplication = false;
                } else if (hasUnits && !hasDefinition) {
                    addResult('duplicationResults', 'success', 'لا يوجد تكرار! ✅',
                        `العقار موجود في properties فقط (${inProperties.length} وحدة) وتم حذفه من propertyDefinitions`);
                    testResults.duplication = true;
                } else if (!hasUnits && hasDefinition) {
                    addResult('duplicationResults', 'info', 'العقار في التعريفات فقط',
                        `العقار موجود في propertyDefinitions فقط (${inDefinitions.length} تعريف) - لم تتم إضافة وحدات بعد`);
                    testResults.duplication = true;
                } else {
                    addResult('duplicationResults', 'warning', 'العقار غير موجود',
                        'العقار غير موجود في أي من المصدرين');
                    testResults.duplication = false;
                }

                // عرض تفاصيل إضافية
                if (inProperties.length > 0) {
                    let html = '<div class="data-display"><h4>الوحدات في properties:</h4>';
                    inProperties.forEach((unit, index) => {
                        html += `<p>${index + 1}. وحدة ${unit['رقم  الوحدة '] || 'غير محدد'}</p>`;
                    });
                    html += '</div>';
                    addResult('duplicationResults', 'info', 'تفاصيل الوحدات', html);
                }

                if (inDefinitions.length > 0) {
                    let html = '<div class="data-display"><h4>التعريفات في propertyDefinitions:</h4>';
                    inDefinitions.forEach((def, index) => {
                        html += `<p>${index + 1}. تعريف: ${def.name}</p>`;
                    });
                    html += '</div>';
                    addResult('duplicationResults', 'info', 'تفاصيل التعريفات', html);
                }

            } catch (error) {
                addResult('duplicationResults', 'error', 'خطأ في فحص التكرار',
                    `خطأ: ${error.message}`);
                testResults.duplication = false;
            }
        }

        // اختبار 4: إضافة وحدة للعقار
        function testAddUnit() {
            addResult('addUnitResults', 'info', 'بدء اختبار إضافة الوحدة', 'جاري محاكاة إضافة وحدة للعقار...');

            try {
                const propertyName = testPropertyName;
                const unitNumber = testUnitNumber;
                const unitArea = '120';
                const electricity = 'ELE123';

                // التحقق من عدم وجود وحدة بنفس الرقم
                const existingUnit = window.properties ?
                    window.properties.find(p => p['اسم العقار'] === propertyName && p['رقم  الوحدة '] === unitNumber) : null;

                if (existingUnit) {
                    addResult('addUnitResults', 'warning', 'الوحدة موجودة بالفعل',
                        'يوجد وحدة بنفس الرقم في هذا العقار');
                    testResults.addUnit = false;
                    return;
                }

                // البحث عن العقار (محاكاة الكود المحسن)
                let baseProperty = window.properties ?
                    window.properties.find(p => p['اسم العقار'] === propertyName) : null;

                if (!baseProperty) {
                    const propertyDefinition = window.propertyDefinitions ?
                        window.propertyDefinitions.find(p => p.name === propertyName) : null;

                    if (propertyDefinition) {
                        baseProperty = {
                            'اسم العقار': propertyDefinition.name,
                            'المدينة': propertyDefinition.city,
                            'رقم الصك': propertyDefinition.deed,
                            'مساحةالصك': propertyDefinition.area,
                            'السجل العيني ': propertyDefinition.registry,
                            'موقع العقار': propertyDefinition.location,
                            'المالك': propertyDefinition.owner,
                            'الارتفاع': null,
                            'اسم المستأجر': null,
                            'رقم العقد': null,
                            'قيمة  الايجار ': null,
                            'تاريخ البداية': null,
                            'تاريخ النهاية': null,
                            'الاجمالى': 0.0,
                            'رقم حساب الكهرباء': null,
                            'عدد الاقساط المتبقية': null,
                            'تاريخ القسط الاول': null,
                            'مبلغ القسط الاول': null,
                            'تاريخ القسط الثاني': null,
                            'مبلغ القسط الثاني': null,
                            'تاريخ نهاية القسط': null,
                            'نوع العقد': 'سكني'
                        };
                    }
                }

                if (!baseProperty) {
                    addResult('addUnitResults', 'error', 'لم يتم العثور على العقار',
                        'العقار غير موجود في النظام');
                    testResults.addUnit = false;
                    return;
                }

                // إنشاء الوحدة الجديدة
                const newUnit = {
                    ...baseProperty,
                    'رقم  الوحدة ': unitNumber,
                    'المساحة': parseFloat(unitArea) || null,
                    'رقم حساب الكهرباء': electricity || null,
                    'اسم المستأجر': null,
                    'رقم العقد': null,
                    'قيمة  الايجار ': null,
                    'تاريخ البداية': null,
                    'تاريخ النهاية': null,
                    'الاجمالى': 0.0,
                    'عدد الاقساط المتبقية': null,
                    'تاريخ القسط الاول': null,
                    'مبلغ القسط الاول': null,
                    'تاريخ القسط الثاني': null,
                    'مبلغ القسط الثاني': null,
                    'تاريخ نهاية القسط': null
                };

                // إضافة الوحدة إلى المصفوفة
                window.properties.push(newUnit);
                localStorage.setItem('properties', JSON.stringify(window.properties));

                addResult('addUnitResults', 'success', 'نجح اختبار إضافة الوحدة! ✅',
                    `تم إضافة الوحدة "${unitNumber}" للعقار "${propertyName}" بنجاح`);
                testResults.addUnit = true;

                // عرض تفاصيل الوحدة المضافة
                let html = '<div class="data-display"><h4>تفاصيل الوحدة المضافة:</h4>';
                html += `<p><strong>رقم الوحدة:</strong> ${newUnit['رقم  الوحدة ']}</p>`;
                html += `<p><strong>اسم العقار:</strong> ${newUnit['اسم العقار']}</p>`;
                html += `<p><strong>المدينة:</strong> ${newUnit['المدينة']}</p>`;
                html += `<p><strong>المساحة:</strong> ${newUnit['المساحة']} م²</p>`;
                html += `<p><strong>رقم حساب الكهرباء:</strong> ${newUnit['رقم حساب الكهرباء']}</p>`;
                html += '</div>';

                addResult('addUnitResults', 'info', 'تفاصيل الوحدة', html);

            } catch (error) {
                addResult('addUnitResults', 'error', 'خطأ في إضافة الوحدة',
                    `خطأ: ${error.message}`);
                testResults.addUnit = false;
            }
        }

        // اختبار 5: تنظيف البيانات التجريبية
        function cleanupTestData() {
            addResult('cleanupResults', 'info', 'بدء تنظيف البيانات', 'جاري حذف البيانات التجريبية...');

            try {
                let deletedCount = 0;

                // حذف العقار التجريبي من propertyDefinitions
                if (window.propertyDefinitions) {
                    const definitionIndex = window.propertyDefinitions.findIndex(p => p.name === testPropertyName);
                    if (definitionIndex !== -1) {
                        window.propertyDefinitions.splice(definitionIndex, 1);
                        localStorage.setItem('propertyDefinitions', JSON.stringify(window.propertyDefinitions));
                        deletedCount++;
                    }
                }

                // حذف الوحدة التجريبية من properties
                if (window.properties) {
                    for (let i = window.properties.length - 1; i >= 0; i--) {
                        if (window.properties[i]['اسم العقار'] === testPropertyName) {
                            window.properties.splice(i, 1);
                            deletedCount++;
                        }
                    }
                    localStorage.setItem('properties', JSON.stringify(window.properties));
                }

                if (deletedCount > 0) {
                    addResult('cleanupResults', 'success', 'تم تنظيف البيانات! ✅',
                        `تم حذف ${deletedCount} عنصر من البيانات التجريبية`);
                    testResults.cleanup = true;
                } else {
                    addResult('cleanupResults', 'warning', 'لا توجد بيانات للحذف',
                        'البيانات التجريبية غير موجودة أو تم حذفها مسبقاً');
                    testResults.cleanup = true; // نعتبره نجاح
                }

            } catch (error) {
                addResult('cleanupResults', 'error', 'خطأ في تنظيف البيانات',
                    `خطأ: ${error.message}`);
                testResults.cleanup = false;
            }
        }

        // إنشاء تقرير نهائي
        function generateFinalReport() {
            addResult('finalReport', 'info', 'إنشاء التقرير النهائي', 'جاري تجميع نتائج جميع الاختبارات...');

            let reportHtml = '<div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin: 15px 0;">';
            reportHtml += '<h4><i class="fas fa-chart-bar"></i> تقرير اختبار إضافة وحدة للعقار</h4>';

            // ملخص النتائج
            const tests = [
                { name: 'إضافة العقار بدون وحدات', result: testResults.addProperty },
                { name: 'فحص قائمة العقارات', result: testResults.propertyList },
                { name: 'محاكاة البحث عن العقار', result: testResults.findProperty },
                { name: 'إضافة وحدة للعقار', result: testResults.addUnit },
                { name: 'فحص التكرار', result: testResults.duplication },
                { name: 'تنظيف البيانات التجريبية', result: testResults.cleanup }
            ];

            let passedTests = 0;
            let totalTests = 0;

            reportHtml += '<h5>نتائج الاختبارات:</h5><ul>';
            tests.forEach(test => {
                if (test.result !== null) {
                    totalTests++;
                    if (test.result === true) {
                        passedTests++;
                        reportHtml += `<li style="color: #28a745;">✅ ${test.name}: نجح</li>`;
                    } else {
                        reportHtml += `<li style="color: #dc3545;">❌ ${test.name}: فشل</li>`;
                    }
                } else {
                    reportHtml += `<li style="color: #6c757d;">➖ ${test.name}: لم يتم تشغيله</li>`;
                }
            });
            reportHtml += '</ul>';

            // التوصيات
            reportHtml += '<h5>التوصيات:</h5>';
            if (passedTests === totalTests) {
                reportHtml += '<p style="color: #28a745;">🎉 جميع الاختبارات نجحت! المشكلة محلولة بالكامل.</p>';
                reportHtml += '<p><strong>✅ النتائج المحققة:</strong></p>';
                reportHtml += '<ul>';
                reportHtml += '<li>✅ العقارات بدون وحدات تظهر في قائمة إضافة الوحدات</li>';
                reportHtml += '<li>✅ دالة addNewUnit تبحث في المصدرين بنجاح</li>';
                reportHtml += '<li>✅ يمكن إضافة وحدات للعقارات بدون مشاكل</li>';
                reportHtml += '<li>✅ النظام يحول تعريفات العقارات للتنسيق المطلوب</li>';
                reportHtml += '<li>✅ لا توجد رسالة "لم يتم العثور على العقار المحدد"</li>';
                reportHtml += '</ul>';
            } else {
                reportHtml += '<p style="color: #ffc107;">⚠️ بعض الاختبارات تحتاج تحسين</p>';
            }

            reportHtml += '</div>';

            const reportType = passedTests === totalTests ? 'success' : 'warning';
            addResult('finalReport', reportType, `اكتمل التقرير (${passedTests}/${totalTests})`, reportHtml);
        }

        // تشغيل تلقائي عند تحميل الصفحة
        window.addEventListener('load', () => {
            addResult('addPropertyResults', 'info', '🚀 مرحباً بك في اختبار إضافة الوحدات',
                'اضغط على الأزرار أعلاه لتشغيل الاختبارات المختلفة');
        });
    </script>
</body>
</html>
