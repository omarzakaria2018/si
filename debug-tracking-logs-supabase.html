<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            direction: rtl;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 5px;
            display: inline-block;
        }

        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-bug"></i> ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹</h1>
            <p>ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Supabase</p>
        </div>

        <div class="content">
            <!-- ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ -->
            <div class="test-section">
                <h3><i class="fas fa-wifi"></i> ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase</h3>
                <button class="btn btn-primary" onclick="testSupabaseConnection()">
                    <i class="fas fa-plug"></i> ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
                </button>
                <div id="connectionResults" class="results"></div>
            </div>

            <!-- ÙØ­Øµ Ø¬Ø¯ÙˆÙ„ tracking_logs -->
            <div class="test-section">
                <h3><i class="fas fa-table"></i> ÙØ­Øµ Ø¬Ø¯ÙˆÙ„ tracking_logs</h3>
                <button class="btn btn-warning" onclick="checkTrackingLogsTable()">
                    <i class="fas fa-search"></i> ÙØ­Øµ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                </button>
                <button class="btn btn-success" onclick="createTrackingLogsTable()">
                    <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                </button>
                <div id="tableResults" class="results"></div>
            </div>

            <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ -->
            <div class="test-section">
                <h3><i class="fas fa-plus-circle"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹</h3>
                <button class="btn btn-success" onclick="testCreateTrackingLog()">
                    <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ
                </button>
                <button class="btn btn-primary" onclick="testMultipleUnitsLog()">
                    <i class="fas fa-layer-group"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
                </button>
                <div id="createResults" class="results"></div>
            </div>

            <!-- ÙØ­Øµ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© -->
            <div class="test-section">
                <h3><i class="fas fa-list"></i> ÙØ­Øµ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h3>
                <button class="btn btn-primary" onclick="loadExistingLogs()">
                    <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                </button>
                <button class="btn btn-warning" onclick="searchSpecificUnit()">
                    <i class="fas fa-search"></i> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©
                </button>
                <div id="loadResults" class="results"></div>
            </div>

            <!-- Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ -->
            <div class="test-section">
                <h3><i class="fas fa-wrench"></i> Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„</h3>
                <button class="btn btn-danger" onclick="fixTrackingLogsIssues()">
                    <i class="fas fa-tools"></i> Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ
                </button>
                <button class="btn btn-warning" onclick="clearAllTestLogs()">
                    <i class="fas fa-broom"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                </button>
                <div id="fixResults" class="results"></div>
            </div>
        </div>
    </div>

    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="tracking-logs-manager.js"></script>

    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ
        let diagnosticResults = {
            connection: false,
            table: false,
            manager: false,
            create: false
        };

        // ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
        async function testSupabaseConnection() {
            const results = document.getElementById('connectionResults');
            results.textContent = 'ğŸ”„ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...\n';

            try {
                // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ supabaseClient
                if (typeof supabaseClient === 'undefined' || !supabaseClient) {
                    results.textContent += 'âŒ supabaseClient ØºÙŠØ± Ù…ØªÙˆÙØ±\n';
                    results.textContent += 'ğŸ”§ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ‡ÙŠØ¦Ø© Supabase...\n';
                    
                    if (typeof initSupabase === 'function') {
                        const initialized = initSupabase();
                        if (initialized) {
                            results.textContent += 'âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Supabase Ø¨Ù†Ø¬Ø§Ø­\n';
                        } else {
                            results.textContent += 'âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Supabase\n';
                            return;
                        }
                    } else {
                        results.textContent += 'âŒ Ø¯Ø§Ù„Ø© initSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©\n';
                        return;
                    }
                }

                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    results.textContent += `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}\n`;
                    diagnosticResults.connection = false;
                } else {
                    results.textContent += 'âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­\n';
                    results.textContent += `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª: ${data || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                    diagnosticResults.connection = true;
                }

            } catch (error) {
                results.textContent += `âŒ Ø®Ø·Ø£ Ø®Ø·ÙŠØ±: ${error.message}\n`;
                diagnosticResults.connection = false;
            }
        }

        // ÙØ­Øµ Ø¬Ø¯ÙˆÙ„ tracking_logs
        async function checkTrackingLogsTable() {
            const results = document.getElementById('tableResults');
            results.textContent = 'ğŸ” ÙØ­Øµ Ø¬Ø¯ÙˆÙ„ tracking_logs...\n';

            try {
                if (!supabaseClient) {
                    results.textContent += 'âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„\n';
                    return;
                }

                // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                const { data, error } = await supabaseClient
                    .from('tracking_logs')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    if (error.message.includes('relation "public.tracking_logs" does not exist')) {
                        results.textContent += 'âŒ Ø¬Ø¯ÙˆÙ„ tracking_logs ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯\n';
                        results.textContent += 'ğŸ’¡ ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹\n';
                        diagnosticResults.table = false;
                    } else {
                        results.textContent += `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¬Ø¯ÙˆÙ„: ${error.message}\n`;
                        diagnosticResults.table = false;
                    }
                } else {
                    results.textContent += 'âœ… Ø¬Ø¯ÙˆÙ„ tracking_logs Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ¹Ù…Ù„\n';
                    results.textContent += `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${data || 0}\n`;
                    diagnosticResults.table = true;

                    // ÙØ­Øµ Ø¨Ù†ÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    const { data: sampleData } = await supabaseClient
                        .from('tracking_logs')
                        .select('*')
                        .limit(1);

                    if (sampleData && sampleData.length > 0) {
                        results.textContent += 'ğŸ“‹ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„:\n';
                        Object.keys(sampleData[0]).forEach(column => {
                            results.textContent += `  - ${column}\n`;
                        });
                    }
                }

            } catch (error) {
                results.textContent += `âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ${error.message}\n`;
                diagnosticResults.table = false;
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ tracking_logs
        async function createTrackingLogsTable() {
            const results = document.getElementById('tableResults');
            results.textContent += '\nğŸ”§ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ tracking_logs...\n';

            try {
                // Ø¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
                const sqlInstructions = `
-- Ù†Ø³Ø® ÙˆØ§Ù„ØµÙ‚ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Supabase SQL Editor:

CREATE TABLE IF NOT EXISTS tracking_logs (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    operation_type TEXT NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    unit_number TEXT,
    property_name TEXT,
    contract_number TEXT,
    city TEXT,
    tenant_name TEXT,
    tenant_phone TEXT,
    tenant_phone_2 TEXT,
    rent_value DECIMAL(15,2),
    start_date DATE,
    end_date DATE,
    contract_type TEXT,
    changes JSONB,
    additional_info JSONB,
    user_name TEXT DEFAULT 'Ø§Ù„Ù†Ø¸Ø§Ù…',
    user_id TEXT DEFAULT 'system',
    ip_address TEXT,
    user_agent TEXT,
    description TEXT,
    status TEXT DEFAULT 'completed',
    source TEXT DEFAULT 'web_app',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø§Ø±Ø³
CREATE INDEX IF NOT EXISTS idx_tracking_logs_timestamp ON tracking_logs(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_tracking_logs_unit_property ON tracking_logs(unit_number, property_name);

-- ØªÙØ¹ÙŠÙ„ RLS
ALTER TABLE tracking_logs ENABLE ROW LEVEL SECURITY;

-- Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
CREATE POLICY "Allow all access to tracking_logs" ON tracking_logs FOR ALL USING (true);
                `;

                results.textContent += sqlInstructions;
                results.textContent += '\nğŸ“‹ ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ ÙˆØªÙ†ÙÙŠØ°Ù‡ ÙÙŠ Supabase SQL Editor\n';

            } catch (error) {
                results.textContent += `âŒ Ø®Ø·Ø£: ${error.message}\n`;
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹
        async function testCreateTrackingLog() {
            const results = document.getElementById('createResults');
            results.textContent = 'ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØªØ¨Ø¹...\n';

            try {
                // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
                if (typeof window.trackingLogsManager === 'undefined') {
                    results.textContent += 'âŒ Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±\n';
                    diagnosticResults.manager = false;
                    return;
                } else {
                    results.textContent += 'âœ… Ù…Ø¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù…ØªÙˆÙØ±\n';
                    diagnosticResults.manager = true;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ
                const testLogData = {
                    operation_type: 'Ø§Ø®ØªØ¨Ø§Ø± ØªØ´Ø®ÙŠØµÙŠ',
                    timestamp: new Date().toISOString(),
                    unit_number: 'TEST-' + Date.now(),
                    property_name: 'Ø¹Ù‚Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ',
                    contract_number: 'CONTRACT-TEST-' + Date.now(),
                    city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                    tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ',
                    tenant_phone: '0501234567',
                    rent_value: 5000,
                    start_date: '2025-01-01',
                    end_date: '2025-12-31',
                    contract_type: 'Ø³ÙƒÙ†ÙŠ',
                    changes: { test: 'ØªØ¬Ø±ÙŠØ¨ÙŠ' },
                    additional_info: { source: 'diagnostic_test' },
                    user_name: 'Ù…Ø´Ø®Øµ Ø§Ù„Ù†Ø¸Ø§Ù…',
                    description: 'Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…',
                    status: 'completed',
                    source: 'diagnostic_tool'
                };

                results.textContent += 'ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ...\n';
                const result = await window.trackingLogsManager.saveTrackingLogToSupabase(testLogData);

                if (result) {
                    results.textContent += 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­\n';
                    results.textContent += `ğŸ“‹ Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„: ${result.id}\n`;
                    diagnosticResults.create = true;
                } else {
                    results.textContent += 'âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ\n';
                    diagnosticResults.create = false;
                }

            } catch (error) {
                results.textContent += `âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„: ${error.message}\n`;
                diagnosticResults.create = false;
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
        async function testMultipleUnitsLog() {
            const results = document.getElementById('createResults');
            results.textContent += '\nğŸ¢ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©...\n';

            try {
                const contractNumber = 'MULTI-TEST-' + Date.now();
                const propertyName = 'Ø¨Ø±Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';

                // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ù„ÙˆØ­Ø¯Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
                const units = ['101', '102', '103'];
                
                for (let i = 0; i < units.length; i++) {
                    const unitNumber = units[i];
                    
                    const logData = {
                        operation_type: i === 0 ? 'Ø±Ø¨Ø· ÙˆØ­Ø¯Ø©' : 'Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                        timestamp: new Date().toISOString(),
                        unit_number: unitNumber,
                        property_name: propertyName,
                        contract_number: contractNumber,
                        city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                        tenant_name: 'Ù…Ø³ØªØ£Ø¬Ø± Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª',
                        tenant_phone: '0501234567',
                        rent_value: 5000 + (i * 500),
                        changes: { 
                            operation: i === 0 ? 'Ø±Ø¨Ø·_ÙˆØ­Ø¯Ø©_Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Ø±Ø¨Ø·_ÙˆØ­Ø¯Ø©_Ø¥Ø¶Ø§ÙÙŠØ©',
                            related_units: units 
                        },
                        additional_info: { 
                            test_type: 'multiple_units',
                            unit_index: i,
                            total_units: units.length
                        },
                        description: `${i === 0 ? 'Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ©'} - ${unitNumber}`,
                        source: 'multiple_units_test'
                    };

                    const result = await window.trackingLogsManager.saveTrackingLogToSupabase(logData);
                    
                    if (result) {
                        results.textContent += `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}\n`;
                    } else {
                        results.textContent += `âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}\n`;
                    }
                }

                results.textContent += `ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${units.length} Ø³Ø¬Ù„ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©\n`;
                results.textContent += `ğŸ“‹ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ${contractNumber}\n`;

            } catch (error) {
                results.textContent += `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©: ${error.message}\n`;
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        async function loadExistingLogs() {
            const results = document.getElementById('loadResults');
            results.textContent = 'ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©...\n';

            try {
                if (!supabaseClient) {
                    results.textContent += 'âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„\n';
                    return;
                }

                const { data, error } = await supabaseClient
                    .from('tracking_logs')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(10);

                if (error) {
                    results.textContent += `âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${error.message}\n`;
                } else {
                    results.textContent += `ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.length} Ø³Ø¬Ù„\n\n`;
                    
                    if (data.length > 0) {
                        results.textContent += 'Ø¢Ø®Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª:\n';
                        data.forEach((log, index) => {
                            results.textContent += `${index + 1}. ${log.operation_type} - ${log.unit_number} (${log.timestamp})\n`;
                        });
                    } else {
                        results.textContent += 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„\n';
                    }
                }

            } catch (error) {
                results.textContent += `âŒ Ø®Ø·Ø£: ${error.message}\n`;
            }
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©
        async function searchSpecificUnit() {
            const results = document.getElementById('loadResults');
            const unitNumber = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§:');
            
            if (!unitNumber) return;

            results.textContent += `\nğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}\n`;

            try {
                const { data, error } = await supabaseClient
                    .from('tracking_logs')
                    .select('*')
                    .eq('unit_number', unitNumber)
                    .order('timestamp', { ascending: false });

                if (error) {
                    results.textContent += `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${error.message}\n`;
                } else {
                    results.textContent += `ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.length} Ø³Ø¬Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© ${unitNumber}\n\n`;
                    
                    if (data.length > 0) {
                        data.forEach((log, index) => {
                            results.textContent += `${index + 1}. ${log.operation_type} - ${log.timestamp}\n`;
                            results.textContent += `   Ø§Ù„Ø¹Ù‚Ø§Ø±: ${log.property_name}\n`;
                            results.textContent += `   Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${log.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                            results.textContent += `   Ø§Ù„ÙˆØµÙ: ${log.description || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n\n`;
                        });
                    }
                }

            } catch (error) {
                results.textContent += `âŒ Ø®Ø·Ø£: ${error.message}\n`;
            }
        }

        // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
        async function fixTrackingLogsIssues() {
            const results = document.getElementById('fixResults');
            results.textContent = 'ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...\n';

            // ÙØ­Øµ Ø´Ø§Ù…Ù„
            await testSupabaseConnection();
            await checkTrackingLogsTable();

            if (!diagnosticResults.connection) {
                results.textContent += 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„\n';
                return;
            }

            if (!diagnosticResults.table) {
                results.textContent += 'âš ï¸ Ø¬Ø¯ÙˆÙ„ tracking_logs ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯\n';
                results.textContent += 'ğŸ“‹ ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø²Ø± Ø£Ø¹Ù„Ø§Ù‡\n';
                return;
            }

            results.textContent += 'âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­\n';
            results.textContent += 'ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ØªØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­\n';
        }

        // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        async function clearAllTestLogs() {
            const results = document.getElementById('fixResults');
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©ØŸ')) {
                return;
            }

            results.textContent += '\nğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©...\n';

            try {
                const { data, error } = await supabaseClient
                    .from('tracking_logs')
                    .delete()
                    .or('source.eq.diagnostic_tool,source.eq.multiple_units_test,operation_type.eq.Ø§Ø®ØªØ¨Ø§Ø± ØªØ´Ø®ÙŠØµÙŠ');

                if (error) {
                    results.textContent += `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ${error.message}\n`;
                } else {
                    results.textContent += 'âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­\n';
                }

            } catch (error) {
                results.textContent += `âŒ Ø®Ø·Ø£: ${error.message}\n`;
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ Ø£Ø¯Ø§Ø© ØªØ´Ø®ÙŠØµ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¬Ø§Ù‡Ø²Ø©');
            
            // ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø§ØªØµØ§Ù„
            setTimeout(() => {
                testSupabaseConnection();
            }, 1000);
        });
    </script>
</body>
</html>
