<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        
        .test-section h3 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .connection-status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #27ae60;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h1>
        
        <div id="connectionStatus" class="connection-status disconnected">
            ğŸ”„ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„...
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¨Ø·</h3>
            <button onclick="testBasicLinking()" class="success">Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø£Ø³Ø§Ø³ÙŠ</button>
            <button onclick="testLinkingWithVerification()" class="success">Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚</button>
            <button onclick="testMultipleUnitsLinking()" class="warning">Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ù…ØªØ¹Ø¯Ø¯</button>
            <button onclick="testUnlinking()" class="danger">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <button onclick="checkSupabaseConnection()">ÙØ­Øµ Ø§ØªØµØ§Ù„ Supabase</button>
            <button onclick="listRecentUnits()">Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</button>
            <button onclick="verifyLinkingFunction()">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h3>
            <button onclick="fixLinkingIssues()" class="warning">Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø±Ø¨Ø·</button>
            <button onclick="cleanupTestData()" class="danger">ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
        </div>
        
        <div id="results"></div>
        <div id="log" class="log"></div>
    </div>

    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>

    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let testResults = [];
        
        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const logElement = document.getElementById('log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`${prefix} ${message}`);
        }
        
        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        function addResult(type, title, description) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.innerHTML = `<strong>${title}</strong><br>${description}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateConnectionStatus(connected, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            statusDiv.textContent = `${connected ? 'ğŸŸ¢' : 'ğŸ”´'} ${message}`;
        }
        
        // ÙØ­Øµ Ø§ØªØµØ§Ù„ Supabase
        async function checkSupabaseConnection() {
            log('ğŸ”„ ÙØ­Øµ Ø§ØªØµØ§Ù„ Supabase...');
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client ØºÙŠØ± Ù…ØªÙˆÙØ±');
                }
                
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`);
                }
                
                updateConnectionStatus(true, 'Ù…ØªØµÙ„ Ø¨Ù€ Supabase');
                addResult('success', 'âœ… Ø§ØªØµØ§Ù„ Supabase', 'Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ');
                log('âœ… Ø§ØªØµØ§Ù„ Supabase ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ', 'success');
                
                return true;
            } catch (error) {
                updateConnectionStatus(false, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                addResult('error', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Supabase', error.message);
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Supabase: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ø£Ø³Ø§Ø³ÙŠ
        async function testBasicLinking() {
            log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ...');
            
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯Ø§Ù„Ø©
                if (typeof saveUnitLinkingToSupabase !== 'function') {
                    throw new Error('Ø¯Ø§Ù„Ø© saveUnitLinkingToSupabase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø±
                const testData = {
                    'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'TEST-BASIC-' + Date.now(),
                    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø³Ø§Ø³ÙŠ',
                    'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø®ØªØ¨Ø§Ø±',
                    'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'CONTRACT-BASIC-' + Date.now(),
                    'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 1500,
                    'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 100,
                    'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
                };
                
                log(`ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${testData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
                
                // ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¨Ø·
                const result = await saveUnitLinkingToSupabase(testData, 'link');
                
                if (result && result.id) {
                    addResult('success', 'âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', `ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù…Ø¹Ø±Ù: ${result.id}`);
                    log(`âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ - Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„: ${result.id}`, 'success');
                    return { success: true, id: result.id };
                } else {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¹Ø±Ù ØµØ­ÙŠØ­');
                }
                
            } catch (error) {
                addResult('error', 'âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', error.message);
                log(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
        async function testLinkingWithVerification() {
            log('ğŸ” Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚...');
            
            try {
                const linkResult = await testBasicLinking();
                
                if (!linkResult.success) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ');
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸
                log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase...');
                const { data: verifyData, error: verifyError } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('id', linkResult.id)
                    .single();
                
                if (verifyError) {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚: ${verifyError.message}`);
                }
                
                if (verifyData.tenant_name && verifyData.contract_number) {
                    addResult('success', 'âœ… Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ù‚Ù‚', 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙÙŠ Supabase');
                    log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    return { success: true, verified: true };
                } else {
                    throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Supabase');
                }
                
            } catch (error) {
                addResult('error', 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚', error.message);
                log(`âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ù…ØªØ¹Ø¯Ø¯
        async function testMultipleUnitsLinking() {
            log('ğŸ”— Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø¨Ø· Ù…ØªØ¹Ø¯Ø¯...');

            try {
                const contractNumber = 'MULTI-CONTRACT-' + Date.now();
                const propertyName = 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ¹Ø¯Ø¯';
                const results = [];

                // Ø¥Ù†Ø´Ø§Ø¡ 3 ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
                for (let i = 1; i <= 3; i++) {
                    const testData = {
                        'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': `MULTI-${i}-${Date.now()}`,
                        'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': propertyName,
                        'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': `Ù…Ø³ØªØ£Ø¬Ø± Ù…ØªØ¹Ø¯Ø¯ ${i}`,
                        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': contractNumber,
                        'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 1000 + (i * 100),
                        'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 80 + (i * 10),
                        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
                    };

                    log(`ğŸ“ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${i}: ${testData['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}`);
                    const result = await saveUnitLinkingToSupabase(testData, 'link');

                    if (result && result.id) {
                        results.push(result);
                        log(`âœ… Ù†Ø¬Ø­ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${i}`, 'success');
                    } else {
                        throw new Error(`ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø© ${i}`);
                    }
                }

                addResult('success', 'âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯', `ØªÙ… Ø±Ø¨Ø· ${results.length} ÙˆØ­Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­`);
                log(`âœ… ØªÙ… Ø±Ø¨Ø· ${results.length} ÙˆØ­Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                return { success: true, count: results.length };

            } catch (error) {
                addResult('error', 'âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯', error.message);
                log(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„
        async function testUnlinking() {
            log('ğŸ”“ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„...');

            try {
                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ø£ÙˆÙ„Ø§Ù‹
                const testData = {
                    'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'UNLINK-TEST-' + Date.now(),
                    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ø¹Ù‚Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„',
                    'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±': 'Ù…Ø³ØªØ£Ø¬Ø± Ù„Ù„ÙØµÙ„',
                    'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': 'CONTRACT-UNLINK-' + Date.now(),
                    'Ù‚ÙŠÙ…Ø©  Ø§Ù„Ø§ÙŠØ¬Ø§Ø± ': 1200,
                    'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': 90,
                    'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯': 'Ø³ÙƒÙ†ÙŠ'
                };

                log('ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­Ø¯Ø© Ù„Ù„ÙØµÙ„...');
                const linkResult = await saveUnitLinkingToSupabase(testData, 'link');

                if (!linkResult || !linkResult.id) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„ÙØµÙ„');
                }

                log('ğŸ”“ ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©...');
                const unlinkResult = await saveUnitLinkingToSupabase(testData, 'unlink');

                if (unlinkResult && unlinkResult.id) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„
                    const { data: verifyData, error: verifyError } = await supabaseClient
                        .from('properties')
                        .select('tenant_name, contract_number')
                        .eq('id', unlinkResult.id)
                        .single();

                    if (verifyError) {
                        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØµÙ„: ${verifyError.message}`);
                    }

                    if (verifyData.tenant_name === '' && verifyData.contract_number === '') {
                        addResult('success', 'âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„', 'ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
                        log('âœ… ØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        return { success: true };
                    } else {
                        throw new Error('Ù„Ù… ÙŠØªÙ… ÙØµÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                    }
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØµÙ„');
                }

            } catch (error) {
                addResult('error', 'âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„', error.message);
                log(`âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
        async function listRecentUnits() {
            log('ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©...');

            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('id, unit_number, property_name, tenant_name, contract_number, created_at')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
                }

                if (data && data.length > 0) {
                    let listHtml = '<h4>Ø¢Ø®Ø± 10 ÙˆØ­Ø¯Ø§Øª:</h4><ul>';
                    data.forEach(unit => {
                        const isLinked = unit.tenant_name && unit.contract_number;
                        listHtml += `<li>${unit.unit_number} - ${unit.property_name} ${isLinked ? 'ğŸ”—' : 'ğŸ”“'}</li>`;
                    });
                    listHtml += '</ul>';

                    addResult('info', 'ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©', listHtml);
                    log(`ğŸ“‹ ØªÙ… Ø¹Ø±Ø¶ ${data.length} ÙˆØ­Ø¯Ø©`, 'success');
                } else {
                    addResult('info', 'â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }

            } catch (error) {
                addResult('error', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª', error.message);
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${error.message}`, 'error');
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·
        function verifyLinkingFunction() {
            log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·...');

            const checks = [
                { name: 'saveUnitLinkingToSupabase', exists: typeof saveUnitLinkingToSupabase === 'function' },
                { name: 'linkUnitToContract', exists: typeof linkUnitToContract === 'function' },
                { name: 'unlinkUnit', exists: typeof unlinkUnit === 'function' },
                { name: 'supabaseClient', exists: !!supabaseClient }
            ];

            let allGood = true;
            checks.forEach(check => {
                if (check.exists) {
                    log(`âœ… ${check.name} Ù…ØªÙˆÙØ±Ø©`, 'success');
                } else {
                    log(`âŒ ${check.name} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©`, 'error');
                    allGood = false;
                }
            });

            if (allGood) {
                addResult('success', 'âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªÙˆÙØ±Ø©', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„');
            } else {
                addResult('error', 'âŒ Ø¨Ø¹Ø¶ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ÙÙ‚ÙˆØ¯Ø©', 'ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            }
        }

        // Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø±Ø¨Ø·
        async function fixLinkingIssues() {
            log('ğŸ› ï¸ Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø±Ø¨Ø·...');

            try {
                // ÙØ­Øµ Ø´Ø§Ù…Ù„
                await checkSupabaseConnection();
                verifyLinkingFunction();

                // Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
                const testResult = await testBasicLinking();

                if (testResult.success) {
                    addResult('success', 'âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„', 'Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ');
                    log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ', 'success');
                } else {
                    addResult('warning', 'âš ï¸ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„', 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø£Ø¹Ù„Ø§Ù‡');
                    log('âš ï¸ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'warning');
                }

            } catch (error) {
                addResult('error', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', error.message);
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${error.message}`, 'error');
            }
        }

        // ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        async function cleanupTestData() {
            log('ğŸ§¹ Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .delete()
                    .like('unit_number', 'TEST-%')
                    .or('unit_number.like.MULTI-%,unit_number.like.UNLINK-%,unit_number.like.QUICK-%');

                if (error) {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ: ${error.message}`);
                }

                addResult('success', 'âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ', 'ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
                log('âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'success');

            } catch (error) {
                addResult('error', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ', error.message);
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ: ${error.message}`, 'error');
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', async () => {
            log('ğŸš€ Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…...');

            // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
            await new Promise(resolve => setTimeout(resolve, 1000));

            // ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
            await checkSupabaseConnection();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ§Ù„
            verifyLinkingFunction();

            log('âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        });
    </script>
</body>
</html>
