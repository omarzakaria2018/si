# 🔄 دليل أداة دمج سجلات التتبع والمراجعة

## 📋 نظرة عامة

تم تطوير هذه الأداة لمعالجة وتوحيد سجلات التتبع والمراجعة (Tracking/Audit Logs) التي تحتوي على سجلات متعددة لنفس العقد ونوع العملية والتاريخ، ولكن بوحدات أو تغييرات مختلفة.

## 🎯 الهدف من الأداة

### المشكلة:
- وجود سجلات متكررة لنفس العقد ونوع العملية والتاريخ
- صعوبة في تتبع جميع التغييرات المرتبطة بعملية واحدة
- تشتت أرقام الوحدات في سجلات منفصلة

### الحل:
- دمج السجلات المتشابهة في سجل واحد موحد
- تجميع أرقام الوحدات بفواصل (-)
- إنشاء عمود "التغيرات" يحتوي على جميع التغييرات بتنسيق منظم

## 📁 الملفات المتضمنة

1. **`tracking-logs-consolidator.js`** - الكود الأساسي للأداة
2. **`tracking-logs-consolidation-demo.html`** - واجهة المستخدم التفاعلية
3. **`sample-tracking-logs.json`** - بيانات تجريبية للاختبار
4. **`TRACKING_LOGS_CONSOLIDATION_GUIDE.md`** - هذا الدليل

## 🚀 كيفية الاستخدام

### الطريقة الأولى: استخدام الواجهة التفاعلية

1. افتح ملف `tracking-logs-consolidation-demo.html` في المتصفح
2. أدخل البيانات بإحدى الطرق التالية:
   - نسخ ولصق JSON في المربع النصي
   - رفع ملف JSON أو CSV
   - استخدام البيانات التجريبية
3. اضغط على "معالجة ودمج البيانات"
4. اعرض النتائج وصدرها بالتنسيق المطلوب

### الطريقة الثانية: استخدام الكود مباشرة

```javascript
// إنشاء مثيل من الأداة
const consolidator = new TrackingLogsConsolidator();

// تحميل البيانات
await consolidator.loadData(trackingLogsData);

// دمج السجلات
const consolidated = consolidator.consolidateRecords();

// تصدير النتائج
const jsonOutput = consolidator.exportResults('json');
const csvOutput = consolidator.exportResults('csv');

// طباعة تقرير مفصل
consolidator.printSummaryReport();
```

## 📊 تنسيق البيانات المطلوب

### الحقول الأساسية:
- **`contract_number`** أو **`رقم العقد`** - رقم العقد
- **`operation_type`** أو **`نوع العملية`** - نوع العملية
- **`timestamp`** أو **`date`** أو **`تاريخ اليوم`** - التاريخ
- **`unit_number`** أو **`رقم الوحدة`** - رقم الوحدة

### الحقول الاختيارية:
- **`changes`** - التغييرات (JSON أو نص)
- **`description`** أو **`الوصف`** - وصف العملية
- **`tenant_name`** أو **`اسم المستأجر`** - اسم المستأجر
- **`property_name`** أو **`اسم العقار`** - اسم العقار

### مثال على البيانات:

```json
[
  {
    "contract_number": "20987227961",
    "operation_type": "تحرير بيانات",
    "timestamp": "2025-01-15",
    "unit_number": "STR0020106",
    "changes": {
      "tenant_name": {
        "old": "",
        "new": "شركة السنيدي للمقاولات"
      }
    }
  },
  {
    "contract_number": "20987227961",
    "operation_type": "تحرير بيانات",
    "timestamp": "2025-01-15",
    "unit_number": "STR0020107",
    "changes": {
      "end_date": {
        "old": "2024-12-31",
        "new": "2025-12-31"
      }
    }
  }
]
```

## 📤 النتائج المتوقعة

### قبل الدمج:
```
رقم العقد: 20987227961 | نوع العملية: تحرير بيانات | التاريخ: 2025-01-15 | الوحدة: STR0020106
رقم العقد: 20987227961 | نوع العملية: تحرير بيانات | التاريخ: 2025-01-15 | الوحدة: STR0020107
رقم العقد: 20987227961 | نوع العملية: تحرير بيانات | التاريخ: 2025-01-15 | الوحدة: STR0020108
```

### بعد الدمج:
```
رقم العقد: 20987227961
نوع العملية: تحرير بيانات
تاريخ اليوم: 2025-01-15
رقم الوحدة: STR0020106-STR0020107-STR0020108
التغيرات: 
✔ تم تغيير المستأجر من (فارغ) إلى شركة السنيدي للمقاولات
✔ تم تغيير التاريخ من 2024-12-31 إلى 2025-12-31
✔ تم تعديل بيانات الوحدة STR0020108
```

## 🔧 الميزات المتقدمة

### 1. دعم تنسيقات متعددة للتواريخ
- ISO 8601: `2025-01-15T10:30:00Z`
- تاريخ عربي: `15/1/2025`
- تاريخ مختلط: `2025-01-15`

### 2. معالجة التغييرات المعقدة
- JSON objects مع old/new values
- نصوص بسيطة
- تحليل تلقائي لأنواع العمليات

### 3. تصدير متعدد التنسيقات
- JSON للمعالجة البرمجية
- CSV للجداول الحسابية
- تقارير مطبوعة

### 4. إحصائيات شاملة
- عدد السجلات الأصلية والمدموجة
- نسبة الضغط
- توزيع أنواع العمليات

## 🛠️ التخصيص والتطوير

### إضافة حقول جديدة:
```javascript
// في دالة extractChanges
if (record.custom_field) {
    changes.push(`تم تحديث الحقل المخصص: ${record.custom_field}`);
}
```

### تخصيص تنسيق التاريخ:
```javascript
// في دالة normalizeDate
const customFormat = moment(dateString, 'DD/MM/YYYY').format('YYYY-MM-DD');
```

### إضافة تنسيقات تصدير جديدة:
```javascript
exportToXML() {
    // تنفيذ تصدير XML
}
```

## 🔍 استكشاف الأخطاء

### مشاكل شائعة وحلولها:

1. **خطأ في تحليل JSON**
   - تأكد من صحة تنسيق JSON
   - استخدم أدوات التحقق من JSON

2. **تواريخ غير صحيحة**
   - تحقق من تنسيق التواريخ
   - استخدم تنسيق ISO 8601 للأمان

3. **حقول مفقودة**
   - تأكد من وجود الحقول الأساسية
   - استخدم أسماء الحقول المدعومة

4. **ذاكرة غير كافية للملفات الكبيرة**
   - قسم الملفات الكبيرة إلى أجزاء أصغر
   - استخدم معالجة تدفقية للبيانات الضخمة

## 📈 الأداء والحدود

### الحدود الموصى بها:
- **حجم الملف**: حتى 50 MB
- **عدد السجلات**: حتى 100,000 سجل
- **المتصفحات المدعومة**: Chrome, Firefox, Safari, Edge

### تحسين الأداء:
- استخدم البيانات المضغوطة
- قم بالمعالجة على دفعات للملفات الكبيرة
- استخدم Web Workers للمعالجة الثقيلة

## 🔒 الأمان والخصوصية

- جميع المعالجات تتم محلياً في المتصفح
- لا يتم إرسال البيانات إلى خوادم خارجية
- يمكن استخدام الأداة دون اتصال بالإنترنت

## 📞 الدعم والمساعدة

للحصول على المساعدة أو الإبلاغ عن مشاكل:
1. راجع هذا الدليل أولاً
2. تحقق من رسائل الخطأ في وحدة التحكم
3. استخدم البيانات التجريبية للاختبار
4. تواصل مع فريق التطوير

## 🔄 التحديثات المستقبلية

### الميزات المخططة:
- دعم قواعد البيانات المباشرة
- واجهة مستخدم محسنة للجوال
- تصدير إلى Excel مع التنسيق
- معالجة البيانات الضخمة
- تقارير تحليلية متقدمة

---

**تم تطوير هذه الأداة لتسهيل إدارة سجلات التتبع في نظام إدارة العقارات**
