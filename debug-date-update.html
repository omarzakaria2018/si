<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</title>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .code { font-family: monospace; background: #f1f1f1; padding: 2px 5px; border-radius: 3px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h1>
        <p>Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ­Ø§ÙƒÙŠ Ø¹Ù…Ù„ÙŠØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</p>
        
        <button onclick="simulateUpdate()">ğŸš€ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        
        <div id="results"></div>
    </div>

    <script>
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        window.properties = [
            {
                'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'STRU070005',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±': 'Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ø³Ø¹ÙŠØ¯',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '01/02/2025',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '31/01/2026'
            }
        ];

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¯Ø§Ù„Ø© formatDateForSystem
        function formatDateForSystem(dateStr) {
            if (!dateStr || dateStr === null || dateStr === 'null') return null;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© ISO (2025-02-01 00:00:00)
            if (dateStr.includes('-') && dateStr.includes(':')) {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            }

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© yyyy-mm-dd
            if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                const parts = dateStr.split('-');
                const year = parts[0];
                const month = String(parseInt(parts[1])).padStart(2, '0');
                const day = String(parseInt(parts[2])).padStart(2, '0');
                return `${day}/${month}/${year}`;
            }

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© dd-mm-yyyy
            if (dateStr.match(/^\d{1,2}-\d{1,2}-\d{4}$/)) {
                const parts = dateStr.split('-');
                const day = String(parseInt(parts[0])).padStart(2, '0');
                const month = String(parseInt(parts[1])).padStart(2, '0');
                const year = parts[2];
                return `${day}/${month}/${year}`;
            }

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© dd/mm/yyyy (Ù…Ø«Ø§Ù„ÙŠ)
            if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                const parts = dateStr.split('/');
                const day = String(parseInt(parts[0])).padStart(2, '0');
                const month = String(parseInt(parts[1])).padStart(2, '0');
                const year = parts[2];

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
                const testDate = new Date(year, month - 1, day);
                if (testDate.getFullYear() == year &&
                    testDate.getMonth() == (month - 1) &&
                    testDate.getDate() == day) {
                    return `${day}/${month}/${year}`;
                }
            }

            return null; // ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­
        }

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¯Ø§Ù„Ø© savePropertyToSupabase
        async function savePropertyToSupabase(property) {
            console.log('ğŸ”„ Ù…Ø­Ø§ÙƒØ§Ø© Ø­ÙØ¸ ÙÙŠ Supabase:', property);
            
            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙŠØºØ© Supabase
            const supabaseProperty = {
                unit_number: property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '],
                city: property['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'],
                property_name: property['Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±'],
                start_date: convertDateToSupabaseFormat(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']),
                end_date: convertDateToSupabaseFormat(property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'])
            };
            
            console.log('ğŸ“¤ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„Ù€ Supabase:', supabaseProperty);
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            return true;
        }

        function convertDateToSupabaseFormat(dateStr) {
            if (!dateStr) return null;
            
            // ØªØ­ÙˆÙŠÙ„ Ù…Ù† dd/mm/yyyy Ø¥Ù„Ù‰ yyyy-mm-dd
            if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                const parts = dateStr.split('/');
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            
            return dateStr;
        }

        function addResult(type, title, content) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `
                <strong>${title}</strong><br>
                ${content}
            `;
            resultsDiv.appendChild(resultDiv);
        }

        async function simulateUpdate() {
            clearResults();
            addResult('warning', 'ğŸš€ Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«...', 'Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† info.json
            const updateData = [
                {
                    'Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ': 'STRU070005',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': '2025-02-01 00:00:00',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': '31/1/2026'
                }
            ];

            for (const item of updateData) {
                const unitNumber = item['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '];
                
                addResult('warning', `ğŸ” Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}`, `
                    <strong>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©:</strong><br>
                    <div class="code">
                        Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${unitNumber}<br>
                        ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${item['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']}<br>
                        ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${item['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']}
                    </div>
                `);

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±
                const property = properties.find(p => p['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© '] === unitNumber);
                
                if (!property) {
                    addResult('error', `âŒ Ø§Ù„Ø¹Ù‚Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${unitNumber}`, 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                    continue;
                }

                addResult('success', `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${unitNumber}`, `
                    <strong>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong><br>
                    <div class="code">
                        ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠ: ${property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']}<br>
                        ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠ: ${property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']}
                    </div>
                `);

                let updated = false;

                // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                const startDate = item['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'];
                if (startDate && startDate !== null) {
                    const formattedStartDate = formatDateForSystem(startDate);
                    
                    addResult('warning', `ğŸ“… Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©`, `
                        <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ØµÙ„ÙŠ:</strong> <span class="code">${startDate}</span><br>
                        <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø³Ù‚:</strong> <span class="code">${formattedStartDate}</span>
                    `);
                    
                    if (formattedStartDate) {
                        const oldStartDate = property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'];
                        property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'] = formattedStartDate;
                        updated = true;
                        
                        addResult('success', `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©`, `
                            <strong>Ù…Ù†:</strong> <span class="code">${oldStartDate}</span><br>
                            <strong>Ø¥Ù„Ù‰:</strong> <span class="code">${formattedStartDate}</span>
                        `);
                    } else {
                        addResult('error', `âŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­`, `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${startDate}`);
                    }
                }

                // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                const endDate = item['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'];
                if (endDate && endDate !== null) {
                    const formattedEndDate = formatDateForSystem(endDate);
                    
                    addResult('warning', `ğŸ“… Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©`, `
                        <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ØµÙ„ÙŠ:</strong> <span class="code">${endDate}</span><br>
                        <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø³Ù‚:</strong> <span class="code">${formattedEndDate}</span>
                    `);
                    
                    if (formattedEndDate) {
                        const oldEndDate = property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'];
                        property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'] = formattedEndDate;
                        updated = true;
                        
                        addResult('success', `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©`, `
                            <strong>Ù…Ù†:</strong> <span class="code">${oldEndDate}</span><br>
                            <strong>Ø¥Ù„Ù‰:</strong> <span class="code">${formattedEndDate}</span>
                        `);
                    } else {
                        addResult('error', `âŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­`, `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${endDate}`);
                    }
                }

                if (updated) {
                    // Ù…Ø­Ø§ÙƒØ§Ø© Ø­ÙØ¸ ÙÙŠ Supabase
                    addResult('warning', `â˜ï¸ Ø­ÙØ¸ ÙÙŠ Supabase...`, 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                    
                    try {
                        const saveResult = await savePropertyToSupabase(property);
                        
                        if (saveResult) {
                            addResult('success', `âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Supabase`, `
                                <strong>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</strong><br>
                                <div class="code">
                                    Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©: ${property['Ø±Ù‚Ù…  Ø§Ù„ÙˆØ­Ø¯Ø© ']}<br>
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©']}<br>
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${property['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©']}
                                </div>
                            `);
                        } else {
                            addResult('error', `âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase`, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
                        }
                    } catch (error) {
                        addResult('error', `âŒ Ø®Ø·Ø£ ÙÙŠ Supabase`, `Ø®Ø·Ø£: ${error.message}`);
                    }
                } else {
                    addResult('warning', `âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø£ÙŠ ØªÙˆØ§Ø±ÙŠØ®`, 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙˆØ§Ø±ÙŠØ® ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«');
                }
            }

            addResult('success', 'ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', 'ØªÙ… ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('success', 'ğŸš€ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ´ØºÙŠÙ„ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„ÙÙ‡Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©');
            }, 500);
        });
    </script>
</body>
</html>
