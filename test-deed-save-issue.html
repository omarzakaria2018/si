<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار مشكلة حفظ معلومات الصك</title>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .property-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .property-card h4 {
            margin: 0 0 15px 0;
            color: #007bff;
        }
        .property-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .info-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        .info-group h5 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .info-item {
            margin: 5px 0;
            font-size: 14px;
        }
        .info-item strong {
            color: #007bff;
        }
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 8px;
        }
        .before {
            background: #fff3cd;
            border: 1px solid #ffc107;
        }
        .after {
            background: #d4edda;
            border: 1px solid #28a745;
        }
        .steps {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .step-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-weight: bold;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        .console-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 اختبار مشكلة حفظ معلومات الصك</h1>
        <p>هذا الاختبار يشخص مشكلة عدم حفظ تغييرات معلومات الصك للعقارات التي تحتوي على بيانات افتراضية</p>
        
        <div class="test-section">
            <h3>📋 وصف المشكلة</h3>
            <div class="property-info">
                <div class="info-group">
                    <h5>🚫 العقارات المتأثرة</h5>
                    <div class="info-item">• العقارات التي تحتوي على بيانات افتراضية مسبقة</div>
                    <div class="info-item">• مثال: "مستودعات السعيد"</div>
                    <div class="info-item">• الحقول: رقم الصك، مساحة الصك، المالك، إلخ</div>
                </div>
                <div class="info-group">
                    <h5>✅ العقارات التي تعمل</h5>
                    <div class="info-item">• العقارات بدون بيانات افتراضية</div>
                    <div class="info-item">• الحقول فارغة أو null</div>
                    <div class="info-item">• يمكن تحرير وحفظ معلومات الصك بسهولة</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 اختبار تشخيصي</h3>
            <button onclick="createTestProperties()" style="background: #28a745; font-size: 16px; padding: 15px 30px;">
                <i class="fas fa-plus"></i> إنشاء عقارات اختبار
            </button>
            <button onclick="testDeedSaveIssue()" style="background: #dc3545; font-size: 16px; padding: 15px 30px;">
                <i class="fas fa-bug"></i> اختبار مشكلة الحفظ
            </button>
            <button onclick="testReplacementLogic()" style="background: #007bff; font-size: 16px; padding: 15px 30px;">
                <i class="fas fa-sync-alt"></i> اختبار منطق الاستبدال
            </button>
            <button onclick="clearConsole()" style="background: #6c757d;">
                <i class="fas fa-trash"></i> مسح السجل
            </button>
        </div>

        <div class="test-section">
            <h3>🎯 خطوات الاختبار اليدوي</h3>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div>اضغط <span class="highlight">"إنشاء عقارات اختبار"</span> لإنشاء عقارين للمقارنة</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div>اذهب إلى "عرض البيانات" وابحث عن <span class="highlight">"مستودعات السعيد"</span></div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div>اضغط زر <span class="highlight">"تحرير"</span> (الأصفر) لأي وحدة</div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div>في قسم "معلومات العقار والصك"، غيّر <span class="highlight">مساحة الصك</span> من 2000 إلى 2500</div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div>احفظ التغييرات وافتح <span class="highlight">Console</span> (F12) لمراقبة السجلات</div>
                </div>
                <div class="step">
                    <div class="step-number">6</div>
                    <div>تحقق من حفظ التغييرات بإعادة فتح نافذة التحرير</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 مقارنة العقارات</h3>
            <div id="propertiesComparison"></div>
        </div>

        <div class="test-section">
            <h3>🖥️ سجل وحدة التحكم</h3>
            <p>راقب هذا السجل أثناء تحرير معلومات الصك:</p>
            <div id="consoleOutput" class="console-output">
                انتظار بدء الاختبار...
            </div>
        </div>

        <div id="results"></div>
    </div>

    <!-- تحميل المكتبات المطلوبة -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    
    <script>
        // تخزين console.log الأصلي
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        // إعادة توجيه console.log إلى العرض
        function interceptConsole() {
            const consoleOutput = document.getElementById('consoleOutput');
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                if (message.includes('معالجة حقل معلومات الصك') || 
                    message.includes('القيمة الأصلية') || 
                    message.includes('القيمة الجديدة') || 
                    message.includes('القيمة النهائية المحفوظة') ||
                    message.includes('حالة حقول معلومات الصك')) {
                    
                    const timestamp = new Date().toLocaleTimeString();
                    consoleOutput.innerHTML += `<div style="color: #68d391;">[${timestamp}] ${message}</div>`;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                const message = args.join(' ');
                const timestamp = new Date().toLocaleTimeString();
                consoleOutput.innerHTML += `<div style="color: #fc8181;">[${timestamp}] ERROR: ${message}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            };
            
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                const message = args.join(' ');
                const timestamp = new Date().toLocaleTimeString();
                consoleOutput.innerHTML += `<div style="color: #f6e05e;">[${timestamp}] WARN: ${message}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            };
        }

        function addResult(type, title, content) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <strong>${title}</strong><br>
                ${content}
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = 'تم مسح السجل...';
        }

        function createTestProperties() {
            addResult('info', '📝 إنشاء عقارات اختبار...', 'جاري إنشاء عقارين للمقارنة');
            
            if (!window.properties) window.properties = [];
            
            // عقار بدون بيانات افتراضية (يعمل بشكل طبيعي)
            const emptyProperty = {
                'رقم  الوحدة ': 'TEST-EMPTY-001',
                'اسم العقار': 'عقار اختبار فارغ',
                'المدينة': 'الرياض',
                'اسم المستأجر': 'مستأجر تجريبي',
                'رقم العقد': 'CONTRACT-EMPTY-001',
                'قيمة  الايجار ': 3000,
                'المساحة': 100,
                'رقم الصك': '',
                'مساحةالصك': '',
                'السجل العيني ': '',
                'المالك': '',
                'موقع العقار': ''
            };
            
            // عقار ببيانات افتراضية (المشكلة)
            const prefilledProperty = {
                'رقم  الوحدة ': 'TEST-PREFILLED-001',
                'اسم العقار': 'مستودعات السعيد',
                'المدينة': 'الرياض',
                'اسم المستأجر': 'شركة تجريبية',
                'رقم العقد': 'CONTRACT-PREFILLED-001',
                'قيمة  الايجار ': 5000,
                'المساحة': 200,
                'رقم الصك': 'DEED123456789',
                'مساحةالصك': '2000',
                'السجل العيني ': 'REG987654321',
                'المالك': 'شركة السعيد العقارية',
                'موقع العقار': 'https://maps.google.com/test-location'
            };
            
            // إضافة أو تحديث العقارات
            [emptyProperty, prefilledProperty].forEach(property => {
                const existingIndex = window.properties.findIndex(p => 
                    p['رقم  الوحدة '] === property['رقم  الوحدة ']
                );
                
                if (existingIndex === -1) {
                    window.properties.push(property);
                } else {
                    window.properties[existingIndex] = property;
                }
            });
            
            // حفظ محلياً
            if (typeof saveDataLocally === 'function') {
                saveDataLocally();
            }
            
            // عرض المقارنة
            displayPropertiesComparison();
            
            addResult('success', '✅ تم إنشاء العقارات', `
                تم إنشاء عقارين للاختبار:<br>
                • <strong>عقار اختبار فارغ:</strong> بدون بيانات افتراضية (يجب أن يعمل)<br>
                • <strong>مستودعات السعيد:</strong> ببيانات افتراضية (المشكلة المبلغ عنها)<br><br>
                يمكنك الآن اختبار تحرير معلومات الصك لكلا العقارين
            `);
        }

        function displayPropertiesComparison() {
            const container = document.getElementById('propertiesComparison');
            
            const emptyProperty = window.properties?.find(p => p['اسم العقار'] === 'عقار اختبار فارغ');
            const prefilledProperty = window.properties?.find(p => p['اسم العقار'] === 'مستودعات السعيد');
            
            if (!emptyProperty || !prefilledProperty) {
                container.innerHTML = '<p>اضغط "إنشاء عقارات اختبار" أولاً</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="before-after">
                    <div class="before">
                        <h5>🟡 عقار اختبار فارغ (يجب أن يعمل)</h5>
                        <div class="info-item"><strong>رقم الصك:</strong> "${emptyProperty['رقم الصك']}"</div>
                        <div class="info-item"><strong>مساحة الصك:</strong> "${emptyProperty['مساحةالصك']}"</div>
                        <div class="info-item"><strong>السجل العيني:</strong> "${emptyProperty['السجل العيني ']}"</div>
                        <div class="info-item"><strong>المالك:</strong> "${emptyProperty['المالك']}"</div>
                        <div class="info-item"><strong>موقع العقار:</strong> "${emptyProperty['موقع العقار']}"</div>
                        <button onclick="testEditProperty('عقار اختبار فارغ')" style="margin-top: 10px; background: #28a745;">
                            تحرير هذا العقار
                        </button>
                    </div>
                    <div class="after">
                        <h5>🔴 مستودعات السعيد (المشكلة)</h5>
                        <div class="info-item"><strong>رقم الصك:</strong> "${prefilledProperty['رقم الصك']}"</div>
                        <div class="info-item"><strong>مساحة الصك:</strong> "${prefilledProperty['مساحةالصك']}"</div>
                        <div class="info-item"><strong>السجل العيني:</strong> "${prefilledProperty['السجل العيني ']}"</div>
                        <div class="info-item"><strong>المالك:</strong> "${prefilledProperty['المالك']}"</div>
                        <div class="info-item"><strong>موقع العقار:</strong> "${prefilledProperty['موقع العقار']}"</div>
                        <button onclick="testEditProperty('مستودعات السعيد')" style="margin-top: 10px; background: #dc3545;">
                            تحرير هذا العقار
                        </button>
                    </div>
                </div>
            `;
        }

        function testEditProperty(propertyName) {
            addResult('info', '🔄 فتح نافذة التحرير...', `
                جاري فتح نافذة تحرير العقار: ${propertyName}<br>
                راقب سجل وحدة التحكم أدناه لمتابعة عملية الحفظ
            `);
            
            try {
                const property = window.properties?.find(p => p['اسم العقار'] === propertyName);
                
                if (property && typeof showCardEditModal === 'function') {
                    showCardEditModal(property['رقم العقد'] || '', propertyName, property['رقم  الوحدة '] || '');
                    
                    addResult('success', '✅ تم فتح نافذة التحرير', `
                        تحقق من النافذة المفتوحة:<br>
                        • ابحث عن قسم "معلومات العقار والصك"<br>
                        • جرب تغيير مساحة الصك<br>
                        • احفظ وراقب السجل أدناه<br>
                        • تحقق من حفظ التغييرات بإعادة فتح النافذة
                    `);
                } else {
                    addResult('error', '❌ خطأ', 'لم يتم العثور على العقار أو دالة التحرير');
                }
            } catch (error) {
                addResult('error', '❌ خطأ في فتح نافذة التحرير', `خطأ: ${error.message}`);
            }
        }

        function testDeedSaveIssue() {
            addResult('warning', '🔍 اختبار تشخيصي...', 'جاري فحص مشكلة حفظ معلومات الصك');

            if (!window.properties || window.properties.length === 0) {
                addResult('error', '❌ لا توجد بيانات', 'اضغط "إنشاء عقارات اختبار" أولاً');
                return;
            }

            const prefilledProperty = window.properties.find(p => p['اسم العقار'] === 'مستودعات السعيد');

            if (!prefilledProperty) {
                addResult('error', '❌ لم يتم العثور على العقار', 'اضغط "إنشاء عقارات اختبار" أولاً');
                return;
            }

            addResult('info', '📊 تحليل العقار المتأثر', `
                <strong>اسم العقار:</strong> ${prefilledProperty['اسم العقار']}<br>
                <strong>رقم الصك الحالي:</strong> "${prefilledProperty['رقم الصك']}"<br>
                <strong>مساحة الصك الحالية:</strong> "${prefilledProperty['مساحةالصك']}"<br>
                <strong>المالك الحالي:</strong> "${prefilledProperty['المالك']}"<br><br>
                <strong>التشخيص:</strong> هذا العقار يحتوي على بيانات افتراضية مسبقة<br>
                <strong>المشكلة المتوقعة:</strong> عدم حفظ التغييرات عند التحرير
            `);

            addResult('warning', '🧪 خطوات الاختبار', `
                1. اضغط "تحرير هذا العقار" للعقار الأحمر أعلاه<br>
                2. غيّر مساحة الصك من 2000 إلى 2500<br>
                3. احفظ التغييرات<br>
                4. راقب السجل أدناه للتحقق من المعالجة<br>
                5. أعد فتح نافذة التحرير للتحقق من الحفظ
            `);
        }

        function testReplacementLogic() {
            addResult('info', '🔄 اختبار منطق الاستبدال...', 'جاري اختبار أن القيم الجديدة تستبدل القديمة');

            if (!window.properties || window.properties.length === 0) {
                addResult('error', '❌ لا توجد بيانات', 'اضغط "إنشاء عقارات اختبار" أولاً');
                return;
            }

            const testProperty = window.properties.find(p => p['اسم العقار'] === 'مستودعات السعيد');

            if (!testProperty) {
                addResult('error', '❌ لم يتم العثور على العقار', 'اضغط "إنشاء عقارات اختبار" أولاً');
                return;
            }

            addResult('success', '✅ تم العثور على العقار للاختبار', `
                <strong>الحالة الحالية:</strong><br>
                • رقم الصك: "${testProperty['رقم الصك']}"<br>
                • مساحة الصك: "${testProperty['مساحةالصك']}"<br>
                • المالك: "${testProperty['المالك']}"<br><br>
                <strong>السلوك المطلوب:</strong><br>
                عند تحرير أي من هذه القيم، يجب أن تُستبدل القيمة القديمة بالقيمة الجديدة<br>
                حتى لو كانت القيمة الجديدة فارغة
            `);

            addResult('info', '🎯 تعليمات الاختبار', `
                <strong>لاختبار منطق الاستبدال:</strong><br>
                1. اضغط "تحرير هذا العقار" أعلاه<br>
                2. جرب تغيير مساحة الصك إلى قيمة جديدة (مثل 1800)<br>
                3. أو جرب مسح رقم الصك (ترك الحقل فارغاً)<br>
                4. احفظ التغييرات<br>
                5. أعد فتح النافذة للتحقق من أن القيمة الجديدة حُفظت<br><br>
                <strong>النتيجة المتوقعة:</strong><br>
                • إذا غيّرت القيمة → يجب حفظ القيمة الجديدة<br>
                • إذا مسحت القيمة → يجب حفظ القيمة الفارغة (استبدال القديم بفارغ)
            `);
        }

        // تشغيل تلقائي عند تحميل الصفحة
        window.addEventListener('load', () => {
            interceptConsole();
            
            addResult('success', '🚀 جاهز للاختبار', `
                تم تحميل جميع الملفات المطلوبة<br>
                تم تفعيل مراقبة سجل وحدة التحكم<br>
                اضغط "إنشاء عقارات اختبار" للبدء
            `);
            
            // إنشاء عقارات تجريبية تلقائياً
            setTimeout(() => {
                if (!window.properties || window.properties.length === 0) {
                    createTestProperties();
                } else {
                    displayPropertiesComparison();
                }
            }, 1000);
        });
    </script>
</body>
</html>
